![](media/image1.jpeg){width="7.086111111111111in"
height="1.136111111111111in"}

Contents {#contents .TT}
========

[4](#foreword)

[5](#scope)

[5](#normative-references)

[6](#definitions-and-abbreviations)

[6](#definitions)

[6](#abbreviations)

[6](#c-code-structure)

[6](#contents-of-the-c-source-code)

[7](#program-execution)

[7](#coding-style)

[7](#code-hierarchy)

[10](#variables-constants-and-tables)

[11](#description-of-constants-used-in-the-c-code)

[11](#description-of-fixed-tables-used-in-the-c-code)

[13](#static-variables-used-in-the-c-code)

[16](#homing-procedure)

[22](#file-formats)

[22](#speech-file-encoder-input-decoder-output)

[22](#mode-control-file-encoder-input)

[22](#parameter-bitstream-file-encoder-output-decoder-input)

[23](#annex-a-informative-change-history)Foreword 1 Scope 2 Normative
references 3 Definitions and abbreviations 3.1 Definitions 3.2
Abbreviations 4 C code structure 4.1 Contents of the C source code 4.2
Program execution 4.3 Coding style 4.4 Code hierarchy 4.5 Variables,
constants and tables 4.5.1 Description of constants used in the C code
4.5.2 Description of fixed tables used in the C code 4.5.3 Static
variables used in the C code 5 Homing procedure 6 File formats 6.1
Speech file (encoder input / decoder output) 6.2 Mode control file
(encoder input) 6.3 Parameter bitstream file (encoder output / decoder
input) Annex A (informative): Change History

Foreword
========

This Technical Specification (TS) has been produced by the 3^rd^
Generation Partnership Project (3GPP).

The contents of the present document are subject to continuing work
within the TSG and may change following formal TSG approval. Should the
TSG modify the contents of the present document, it will be re-released
by the TSG with an identifying change of release date and an increase in
version number as follows:

Version x.y.z

where:

x the first digit:

1 presented to TSG for information;

2 presented to TSG for approval;

3 or greater indicates TSG approved document under change control.

y the second digit is incremented for all changes of substance, i.e.
technical enhancements, corrections, updates, etc.

z the third digit is incremented when editorial only changes have been
incorporated in the document.

1 Scope
=======

This Technical Standard (TS) contains an electronic copy of the ANSI-C
code for a floating-point implementation of the Adaptive Multi-Rate
codec. This floating-point codec specification is mainly targeted to be
used in multimedia applications such as the 3G-324M terminal specified
in 3GPP TS 26.110, or in packet-based (e.g., H.323) applications. The
bit-exact fixed-point ANSI-C code in 3GPP TS 26.073 remains the
preferred implementation for all applications, but the floating-point
codec may be used instead of the fixed-point codec when the
implementation platform is better suited for a floating-point
implementation. It has been verified that the fixed-point and
floating-point codecs interoperate with each other without any
artefacts.

The floating-point ANSI‑C code in this specification is the only
standard conforming non-bit-exact implementation of the Adaptive Multi
Rate speech transcoder (3GPP TS 26.090 \[2\]), Voice Activity Detection
(3GPP TS 26.094 \[6\]), comfort noise generation (3GPP TS 26.092 \[4\]),
and source controlled rate operation (3GPP TS 26.093 \[5\]). The
floating-point code also contains example solutions for substituting and
muting of lost frames (3GPP TS 26.091 \[3\]).

**The fixed-point specification in 26.073 shall remain the only allowed
implementation for the 3G mandatory speech service and the use of the
floating-point codec is strictly limited to other services.**

The floating-point encoder in this specification is a non-bit-exact
implementation of the fixed-point encoder producing quality
indistinguishable from that of the fixed-point encoder. The decoder in
this specification is functionally a bit‑exact implementation of the
fixed-point decoder, but the code has been optimized for speed and the
standard fixed-point libraries are not used as such.

2 Normative references
======================

The following documents contain provisions which, through reference in
this text, constitute provisions of the present document.

\- References are either specific (identified by date of publication,
edition number, version number, etc.) or non‑specific.

\- For a specific reference, subsequent revisions do not apply.

\- For a non-specific reference, the latest version applies. In the case
of a reference to a 3GPP document (including a GSM document), a
non-specific reference implicitly refers to the latest version of that
document *in the same Release as the present document*.

\[1\] 3GPP TS 26.074: \"AMR Speech Codec; Test sequences\".

\[2\] 3GPP TS 26.090: \"AMR Speech Codec; Speech transcoding\".

\[3\] 3GPP TS 26.091: \"AMR Speech Codec; Substitution and muting of
lost frames\".

\[4\] 3GPP TS 26.092: \"AMR Speech Codec; Comfort noise aspects\".

\[5\] 3GPP TS 26.093: \"AMR Speech Codec; Source controlled rate
operation\".

\[6\] 3GPP TS 26.094: \"AMR Speech Codec; Voice Activity Detection\".

\[7\] 3GPP TS 26.073: \"ANSI‑C code for the Adaptive Multi Rate speech
codec\".

\[8\] 3GPP TS 26.101: \"AMR Speech Codec Frame Structure\".

\[9\] RFC 3267: \"A Real-Time Transport Protocol (RTP) Payload Format
and File Storage Format for Adaptive Multi-Rate (AMR) and Adaptive
Multi-Rate Wideband (AMR-WB) Audio Codecs\", June 2002.

3 Definitions and abbreviations
===============================

3.1 Definitions
---------------

Definition of terms used in the present document, can be found in 3GPP
TS 26.090  \[2\], 3GPP TS 26.091  \[3\], 3GPP TS 26.092  \[4\], 3GPP
TS 26.093  \[5\], and 3GPP TS 26.094  \[6\].

3.2 Abbreviations
-----------------

For the purpose of the present document, the following abbreviations
apply:

ANSI American National Standards Institute

ETS European Telecommunication Standard

GSM Global System for Mobile communications

I/O Input/Output

RAM Random Access Memory

ROM Read Only Memory

4 C code structure
==================

This clause gives an overview of the structure of the floating-point C
code and provides an overview of the contents and organization of the C
code attached to this document. The basic structure of the
floating-point C code follows that of the bit-exact fixed-point code
\[7\].

The C code has been verified on the following systems:

\- IBM PC/AT compatible computers with Windows NT40 and Microsoft Visual
C++ v.5.0 compiler;

\- HP workstations and GNU gcc compiler;

\- IBM PC/AT compatible computers with Linux operating system and GNU
gcc compiler;

ANSI‑C 9899 was selected as the programming language because portability
was desirable

4.1 Contents of the C source code
---------------------------------

The C code distribution has all files in the root level.

The files with suffix \"c\" contain the source code and the files with
suffix \"h\" are the header files. The ROM data is contained in \"rom\"
files with suffix \"h\".

The C code does not contain any speech coder installation verification
data files. Verification for the bit-exact decoder is defined in
specification 3GPP TS 26.073 \[7\].

Makefiles are provided for the platforms in which the C code has been
verified (listed above). Once the software is installed, this directory
will have a compiled version of encoder and decoder and all the object
files.

4.2 Program execution
---------------------

The Adaptive Multi-Rate codec is implemented in two programs:

\- (*encoder*) speech encoder;

\- (*decoder*) speech decoder.

The programs should be called like:

encoder \[-dtx\] mode speech\_file bitstream\_file

or

encoder \[-dtx\] -modefile=mode\_file speech\_file bitstream\_file

decoder \<parameter file\> \<speech output file\>

The speech files contain 16-bit linear encoded PCM speech samples and
the parameter files contain encoded speech data and some additional
flags.

See the file readme.txt for more information on how to run the *encoder*
and *decoder* programs.

4.3 Coding style
----------------

The C code has been written according to structuring conventions used in
3GPP TS 26.073 \[7\]. Encoder and decoder state structures are allocated
and initialized with special initializing functions. There are no
separate functions for each module, as opposed to the fixed-point
implementation in 3GPP TS 26.073 \[7\].

4.4 Code hierarchy
------------------

The code hierarchy follows the one specified in 3GPP TS 26.073 \[7\].

Figures 1 to 4 are call graphs that show the functions used in the
speech codec, including the functions of VAD, DTX, and comfort noise
generation.

Each column represents a call level and each cell a function. The
functions contain calls to the functions in rightwards neighbouring
cells. The time order in the call graphs is from the top downwards as
the processing of a frame advances. All standard C functions, such as
printf(), fwrite(), etc., have been omitted.

The encoder call graph is broken down into three separate call graphs,
shown in Tables 1 to 3.

Table 1: Speech encoder call structure

  ----------------------- -------------- ----------------------- --------------------- ------------------------------ ------------------------------
  Speech\_Encode\_Frame   Pre\_Process                                                                                
                          cod\_amr       vad                     filter\_bank          first\_filter\_stage           
                                                                                       filter5                        
                                                                                       filter3                        
                                                                                       level\_calculation             
                                                                 vad\_decision         complex\_estimate\_adapt       
                                                                                       complex\_vad                   
                                                                                       noise\_estimate\_update        update\_cntrl
                                                                                       hangover\_addition             
                                         tx\_dtx\_handler                                                             
                                         lpc                     Autocorr                                             
                                                                 Levinson                                             
                                         lsp                     Az\_lsp               Chebps                         
                                                                 Q\_plsf\_5            Lsp\_lsf                       
                                                                                       Lsf\_wt                        
                                                                                       Vq\_subvec                     
                                                                                       Vq\_subvec\_s                  
                                                                                       Reorder\_lsf                   
                                                                                       Lsf\_lsp                       
                                                                 Int\_lpc\_1and3\_2    Lsp\_az                        Get\_lsp\_pol
                                                                 Int\_lpc\_1and3       Lsp\_az                        Get\_lsp\_pol
                                                                 Q\_plsf\_3            Lsp\_lsf                       
                                                                                       Lsf\_wt                        
                                                                                       Vq\_subvec3                    
                                                                                       Vq\_subvec4                    
                                                                                       Reorder\_lsf                   
                                                                                       Lsf\_lsp                       
                                                                 Int\_lpc\_1to3\_2     Lsp\_az                        Get\_lsp\_pol
                                                                 Int\_lpc\_1to3        Lsp\_az                        Get\_lsp\_pol
                                         dtx\_buffer             Dotproduct40                                         
                                         dtx\_enc                Lsp\_lsf                                             
                                                                 Reorder\_lsf                                         
                                                                 Lsf\_lsp                                             
                                                                 Q\_plsf\_3            Lsp\_lsf                       
                                                                                       Lsf\_wt                        
                                                                                       Vq\_subvec3                    
                                                                                       Vq\_subvec4                    
                                                                                       Reorder\_lsf                   
                                                                                       Lsf\_lsp                       
                                         check\_lsp                                                                   
                                         pre\_big                Weight\_Ai                                           
                                                                 Residu                                               
                                                                 Syn\_filt                                            
                                         ol\_ltp                 Pitch\_ol             vad\_tone\_detection\_update   
                                                                                       Lag\_max                       vad\_tone\_detection
                                                                                       comp\_corr                     
                                                                                       hp\_max                        
                                                                 Pitch\_ol\_wgh        comp\_corr                     
                                                                                       Lag\_max\_wght                 vad\_tone\_detection\_update
                                                                                                                      vad\_tone\_detection
                                                                                       gmed\_n                        
                                                                                       hp\_max**2**                   
                                         vad\_pitch\_detection                                                        
                                         subframePreProc         Weight\_Ai                                           
                                                                 Syn\_filt                                            
                                                                 Residu                                               
                                         cl\_ltp                 Pitch\_fr             getRange                       
                                                                                       Norm\_Corr                     Dotproduct40
                                                                                       searchFrac                     Interpol\_3or6
                                                                                       Enc\_lag3                      
                                                                                       Enc\_lag6                      
                                                                 Pred\_lt\_3or6                                       
                                                                 G\_pitch              Dotproduct40                   
                                                                 check\_gp\_clipping                                  
                                                                 q\_gain\_pitch                                       
                                         cbsearch                see Table 2                                          
                                         gainQuant               see Table 3                                          
                                         update\_gp\_clipping    Copy                                                 
                                         subframePostProc        Syn\_filt                                            
                                         Pred\_lt\_3or6                                                               
                                         Convolve                                                                     
  ----------------------- -------------- ----------------------- --------------------- ------------------------------ ------------------------------

Table 2: cbsearch call structure

  ---------- --------------------- ---------------------------- -------------- -- --
  cbsearch   code\_2i40\_9bits     cor\_h\_x                    Dotproduct40      
                                   set\_sign                                      
                                   cor\_h                       Dotproduct40      
                                   search\_2i40\_9bits                            
                                   build\_code\_2i40\_9bits                       
             code\_2i40\_11bits    cor\_h\_x                    Dotproduct40      
                                   set\_sign                                      
                                   cor\_h                       Dotproduct40      
                                   search\_2i40\_11bits                           
                                   build\_code\_2i40\_11bits                      
             code\_3i40\_14bits    cor\_h\_x                    Dotproduct40      
                                   set\_sign                                      
                                   cor\_h                       Dotproduct40      
                                   search\_3i40                                   
                                   build\_code\_3i40\_14bits                      
             code\_4i40\_17bits    cor\_h\_x                    Dotproduct40      
                                   set\_sign                                      
                                   cor\_h                       Dotproduct40      
                                   search\_4i40                                   
                                   build\_code\_4i40                              
             code\_8i40\_31bits    cor\_h\_x                    Dotproduct40      
                                   set\_sign12k2                Dotproduct40      
                                   cor\_h                       Dotproduct40      
                                   search\_8i40                                   
                                   build\_code\_8i40\_31bits                      
                                   compress\_code               compress10        
             code\_10i40\_35bits   cor\_h\_x                    Dotproduct40      
                                   set\_sign12k2                Dotproduct40      
                                   cor\_h                       Dotproduct40      
                                   search\_10i40                                  
                                   build\_code\_10i40\_35bits                     
                                   q\_p                                           
  ---------- --------------------- ---------------------------- -------------- -- --

Table 3: gainQuant call structure

  ----------- -------------------------- ------------------------------- -------------- --
  gainQuant   gc\_pred                   Dotproduct40                                   
              calc\_filt\_energies       Dotproduct40                                   
              Dotproduct40                                                              
              MR475\_update\_unq\_pred                                                  
              MR475\_gain\_quant         gc\_pred                        Dotproduct40   
              q\_gain\_code                                                             
              MR795\_gain\_quant         q\_gain\_pitch                                 
                                         MR795\_gain\_code\_quant3                      
                                         calc\_unfilt\_energies          Dotproduct40   
                                         gain\_adapt                     Gmed\_n\_f     
                                         MR795\_gain\_code\_quant\_mod                  
              Qua\_gain                                                                 
  ----------- -------------------------- ------------------------------- -------------- --

Table 4: Speech decoder call structure

  ----------------------- --------------- ---------------------------- ---------------------------- --------------- ------------
  Speech\_Decode\_Frame   Decoder\_amr    rx\_dtx\_handler                                                          
                                          Decoder\_amr\_reset                                                       
                                          dtx\_dec                     Copy                                         
                                                                       Lsf\_lsp                                     
                                                                       D\_plsf\_3                   Lsf\_lsp        
                                                                       pseudonoise                                  
                                                                       Lsp\_lsf                                     
                                                                       Reorder\_lsf                                 
                                                                       Lsp\_Az                      Get\_lsp\_pol   
                                                                       A\_Refl                                      
                                                                       Log2                         Log2\_norm      
                                                                       Pow2                                         
                                                                       Build\_CN\_code              pseudonoise     
                                                                       Syn\_filt                                    
                                          Lsf\_lsp                                                                  
                                          lsp\_avg                                                                  
                                          Build\_CN\_param                                                          
                                          D\_plsf\_3                   Lsf\_lsp                                     
                                          Int\_lpc\_1to3               Lsp\_Az                      Get\_lsp\_pol   
                                          D\_plsf\_5                   Reorder\_lsf                                 
                                                                       Lsf\_lsp                                     
                                          Int\_lpc\_1and3              Lsp\_Az                      Get\_lsp\_pol   
                                          Dec\_lag3                                                                 
                                          Pred\_lt\_3or6\_40                                                        
                                          Dec\_lag6                                                                 
                                          decode\_2i40\_9bits                                                       
                                          decode\_2i40\_11bits                                                      
                                          decode\_3i40\_14bits                                                      
                                          decode\_4i40\_17bits                                                      
                                          decode\_8i40\_31bits         decompress\_codewords        decompress10    
                                          ec\_gain\_pitch              gmed\_n                                      
                                          d\_gain\_pitch                                                            
                                          ec\_gain\_pitch\_update                                                   
                                          decode\_10i40\_35bits                                                     
                                          Dec\_gain                    Log2                         Log2\_norm      
                                                                       gc\_pred                     Log2            Log2\_norm
                                                                                                    Log2\_norm      
                                                                       Pow2                                         
                                                                       gc\_pred\_update                             
                                          ec\_gain\_code               gmed\_n                                      
                                                                       gc\_pred\_average\_limited                   
                                                                       gc\_pred\_update                             
                                          ec\_gain\_code\_update                                                    
                                          d\_gain\_code                gc\_pred                     Log2            Log2\_norm
                                                                                                    Log2\_norm      
                                                                       Pow2                                         
                                                                       gc\_pred\_update                             
                                          Int\_lsf                                                                  
                                          Cb\_gain\_average                                                         
                                          ph\_disp                                                                  
                                          sqrt\_l\_exp                                                              
                                          Ex\_ctrl                     gmed\_n                                      
                                          agc2                         Inv\_sqrt                                    
                                          Syn\_filt                                                                 
                                          Bgn\_scd                     gmed\_n                                      
                                          dtx\_dec\_activity\_update   Copy                                         
                                                                       Log2                         Log2\_norm      
                                          lsp\_avg                                                                  
                          Post\_Filter    Residu40                                                                  
                                          Syn\_filt                                                                 
                                          agc                          energy\_new                  energy\_old     
                                                                       Inv\_sqrt                                    
                          Post\_Process                                                                             
  ----------------------- --------------- ---------------------------- ---------------------------- --------------- ------------

4.5 Variables, constants and tables
-----------------------------------

The data types of variables and tables used in the floating-point
implementation are signed integers in 2\'s complement representation,
defined by:

**Word8** 8 bit variable**\
UWord8** 8 bit unsigned variable

**Word16** 16 bit variable\
**Word32** 32 bit variable

Floating-point numbers use the IEEE (Institute of Electrical and
Electronics Engineers) format:

**Float32** 8 bit exponent, 23 bit mantissa, 1 bit sign

**Float64** 11 bit exponent, 52 bit mantissa, 1 bit sign

Furthermore some **enum** types are used, all possible to represent with
one byte, and a Boolean **Flag**.

### 4.5.1 Description of constants used in the C code

Constants for the codec are defined in rom (h) files.

### 4.5.2 Description of fixed tables used in the C code

This section contains a listing of all fixed tables sorted by source
file name and table name.

Table 5: Speech encoder fixed tables

  ------------ ------------------------- -------------------- -----------------------------------------------------------------------
  File         Table name                **Type\[Length\]**   Description
  rom\_enc.h   trackTable                Word8\[4\*5\]        track table for algebraic code book search (MR475, MR515)
  rom\_enc.h   gamma1                    Float32\[10\]        spectral expansion factors
  rom\_enc.h   gamma1\_12k2              Float32\[10\]        spectral expansion factors
  rom\_enc.h   gamma2                    Float32\[10\]        spectral expansion factors
  rom\_enc.h   b60                       Float32\]61\]        interpolation filter coefficients
  rom\_enc.h   startPos1                 Word16\[2\]          track start search position for first pulse
  rom\_enc.h   startPos2                 Word16\[4\]          track start search position for second pulse
  rom\_enc.h   startPos                  Word16\[16\]         track start search position
  rom\_enc.h   corrweight                Float32\[251\]       weighting of the correlation function in open loop LTP search (MR102)
  rom\_enc.h   qua\_gain\_pitch          Float32\[16\]        adaptive codebook gain quantization table (MR795)
  rom\_enc.h   qua\_gain\_pitch\_MR122   Float32\[16\]        adaptive codebook gain quantization table (MR122)
  rom\_enc.h   qua\_gain\_code           Float32\[64\]        fixed codebook gain quantization table (MR122, MR795)
  rom\_enc.h   gray                      Word8\[8\]           gray coding table
  rom\_enc.h   grid                      Float32\[61\]        grid points at which Chebyshev polynomials are evaluated
  rom\_enc.h   b24                       Float32\[25\]        interpolation filter coefficients
  rom\_enc.h   lag\_wind                 Float32\[10\]        lag window table
  rom\_enc.h   lsp\_init\_data           Float32\[10\]        initialization table for lsp history in DTX
  rom\_enc.h   past\_rq\_init            Float32\[80\]        initialization table for the MA predictor in DTX
  rom\_enc.h   mean\_lsf\_3              Float32\[10\]        LSF means (not in MR122)
  rom\_enc.h   mean\_lsf\_5              Float32\[10\]        LSF means (MR122)
  rom\_enc.h   pred\_fac                 Float32\[10\]        LSF prediction factors (not in MR122)
  rom\_enc.h   dico1\_lsf\_3             Float32\[3\*256\]    1^st^ LSF quantizer (not in MR122 and MR795)
  rom\_enc.h   dico2\_lsf\_3             Float32\[3\*512\]    2^nd^ LSF quantizer (not in MR122)
  rom\_enc.h   dico3\_lsf\_3             Float32\[4\*512\]    3^rd^ LSF quantizer (not in MR122, MR515 and MR475)
  rom\_enc.h   mr515\_3\_lsf             Float32\[4\*128\]    3^rd^ LSF quantizer (MR515 and MR475)
  rom\_enc.h   mr795\_1\_lsf             Float32\[3\*512\]    1^st^ LSF quantizer (MR795)
  rom\_enc.h   dico1\_lsf\_5             Float32\[4\*128\]    1^st^ LSF quantizer (MR122)
  rom\_enc.h   dico2\_lsf\_5             Float32\[4\*256\]    2^nd^ LSF quantizer (MR122)
  rom\_enc.h   dico3\_lsf\_5             Float32\[4\*256\]    3^rd^ LSF quantizer (MR122)
  rom\_enc.h   dico4\_lsf\_5             Float32\[4\*256\]    4^th^ LSF quantizer (MR122)
  rom\_enc.h   dico5\_lsf\_5             Float32\[4\*64\]     5^th^ LSF quantizer (MR122)
  rom\_enc.h   table\_gain\_MR475        Float32\[4\*256\]    gain quantization table (MR475)
  rom\_enc.h   table\_gain\_highrates    Float32\[128\*3\]    gain quantization table (MR67, MR74 and MR102)
  rom\_enc.h   table\_gain\_lowrates     Float32\[64\*3\]     gain quantization table (MR515 and MR59)
  rom\_enc.h   window\_200\_40           Float32\[240\]       LP analysis window (not in MR122)
  rom\_enc.h   window\_160\_80           Float32\[240\]       1^st^ LP analysis window (MR122)
  rom\_enc.h   window\_232\_8            Float32\[240\]       2^nd^ LP analysis window (MR122)
  rom\_enc.h   corrweight                Float32\[251\]       correlation weights
  rom\_enc.h   mode\_dep\_parm           Word8\[8\*9\]        parameters defining the adaptive codebook search per mode
  ------------ ------------------------- -------------------- -----------------------------------------------------------------------

Table 6: Speech decoder fixed tables

  ------------ ------------------------ -------------------- ------------------------------------------------------------
  File         Table name               **Type\[Length\]**   Description
  rom\_dec.h   dtx\_log\_en\_adjust     Word16\[9\]          level adjustments for ech mode
  rom\_dec.h   cdown                    Word32\[7\]          attenuation factors for codebook gain
  rom\_dec.h   pdown                    Word32\[7\]          attenuation factors for adaptive codebook gain
  rom\_dec.h   pred                     Word32\[4\]          algebraic code book gain MA predictor coefficients
  rom\_dec.h   pred\_MR122              Word32\[4\]          algebraic code book gain MA predictor coefficients (MR122)
  rom\_dec.h   gamma3\_MR122            Word32\[10\]         spectral expansion factors
  rom\_dec.h   gamma3                   Word32\[10\]         spectral expansion factors
  rom\_dec.h   gamma4\_MR122            Word32\[10\]         spectral expansion factors
  rom\_dec.h   gamma4                   Word32\[10\]         spectral expansion factors
  rom\_dec.h   bitno\_MR475             Word16\[17\]         number of bits per parameter to transmit (MR475)
  rom\_dec.h   bitno\_MR515             Word16\[19\]         number of bits per parameter to transmit (MR515)
  rom\_dec.h   bitno\_MR59              Word16\[19\]         number of bits per parameter to transmit (MR59)
  rom\_dec.h   bitno\_MR67              Word16\[19\]         number of bits per parameter to transmit (MR67)
  rom\_dec.h   bitno\_MR74              Word16\[19\]         number of bits per parameter to transmit (MR74)
  rom\_dec.h   bitno\_MR795             Word16\[23\]         number of bits per parameter to transmit (MR795)
  rom\_dec.h   bitno\_MR102             Word16\[39\]         number of bits per parameter to transmit (MR102)
  rom\_dec.h   bitno\_MR122             Word16\[57\]         number of bits per parameter to transmit (MR122)
  rom\_dec.h   bitno\_MRDTX             Word16\[5\]          number of bits per parameter to transmit (MRDTX)
  rom\_dec.h   qua\_gain\_pitch         Word32\[16\]         adaptive codebook gain quantization table (MR122, MR795)
  rom\_dec.h   qua\_gain\_code          Word32\[96\]         fixed codebook gain quantization table (MR122, MR795)
  rom\_dec.h   gray                     Word8\[8\]           gray coding table
  rom\_dec.h   dgray                    Word8\[8\]           gray decoding table
  rom\_dec.h   sqrt\_table              Word32\[49\]         table to compute sqrt(x)
  rom\_dec.h   inv\_sqrt\_table         Word32\[49\]         table used in inverse square root computation
  rom\_dec.h   log2\_table              Word32\[33\]         table used in base 2 logarithm computation
  rom\_dec.h   pow2\_table              Word32\[33\]         table used in 2 to the power computation
  rom\_dec.h   cos\_table               Word32\[65\]         table to compute cos(x) in Lsf\_lsp()
  rom\_dec.h   acos\_slope              Word32\[64\]         table to compute acos(x) in Lsp\_lsf()
  rom\_dec.h   ph\_imp\_low\_MR795      Word32\[40\]         phase dispersion impulse response (MR795)
  rom\_dec.h   ph\_imp\_mid\_MR795      Word32\[40\]         phase dispersion impulse response (MR795)
  rom\_dec.h   ph\_imp\_low             Word32\[40\]         phase dispersion impulse response (MR475 - MR67)
  rom\_dec.h   ph\_imp\_mid             Word32\[40\]         phase dispersion impulse response (MR475 - MR67)
  rom\_dec.h   past\_rq\_init           Word32\[80\]         initialization table for the MA predictor in DTX
  rom\_dec.h   mean\_lsf\_3             Word32\[10\]         LSF means (not in MR122)
  rom\_dec.h   mean\_lsf\_5             Word32\[10\]         LSF means (MR122)
  rom\_dec.h   pred\_fac                Word32\[10\]         LSF prediction factors (not in MR122)
  rom\_dec.h   dico1\_lsf\_3            Word32\[3\*256\]\]   1^st^ LSF quantizer (not in MR122 and MR795)
  rom\_dec.h   dico2\_lsf\_3            Word32\[3\*512\]     2^nd^ LSF quantizer (not in MR122)
  rom\_dec.h   dico3\_lsf\_3            Word32\[4\*512\]     3^rd^ LSF quantizer (not in MR122, MR515 and MR475)
  rom\_dec.h   mr515\_3\_lsf            Word32\[4\*128\]     3^rd^ LSF quantizer (MR515 and MR475)
  rom\_dec.h   mr795\_1\_lsf            Word32\[3\*512\]     1^st^ LSF quantizer (MR795)
  rom\_dec.h   dico1\_lsf\_5            Word32\[4\*128\]     1^st^ LSF quantizer (MR122)
  rom\_dec.h   dico2\_lsf\_5            Word32\[4\*256\]     2^nd^ LSF quantizer (MR122)
  rom\_dec.h   dico3\_lsf\_5            Word32\[4\*256\]     3^rd^ LSF quantizer (MR122)
  rom\_dec.h   dico4\_lsf\_5            Word32\[4\*256\]     4^th^ LSF quantizer (MR122)
  rom\_dec.h   dico5\_lsf\_5            Word32\[4\*64\]      5^th^ LSF quantizer (MR122)
  rom\_dec.h   table\_gain\_MR475       Word32\[4\*256\]     gain quantization table (MR475)
  rom\_dec.h   table\_gain\_highrates   Word32\[128\*4\]     gain quantization table (MR67, MR74 and MR102)
  rom\_dec.h   table\_gain\_lowrates    Word32\[64\*4\]      gain quantization table (MR515 and MR59)
  rom\_dec.h   inter\_6                 Word32\[61\]         interpolation filter coefficients
  rom\_dec.h   window\_200\_40          Word32\[240\]        LP analysis window (not in MR122)
  rom\_dec.h   table\_speech\_bad       UWord8\[9\]          comparison optimisation table in DTX
  rom\_dec.h   table\_SID               Uword8\[9\]          comparison optimisation table in DTX
  rom\_dec.h   table\_DTX               Uword8\[9\]          comparison optimisation table in DTX
  rom\_dec.h   table\_mute              Uword8\[9\]          comparison optimisation table in DTX
  ------------ ------------------------ -------------------- ------------------------------------------------------------

### 4.5.3 Static variables used in the C code

In this section, two tables that specify the static variables for the
speech encoder and decoder, respectively, are shown. All static
variables are declared within a C **struct.**

Table 7: Speech encoder static variables

  ------------------- ----------------------- -------------------- -------------------------------------------------------------------------
  **Struct name**     **Variable**            **Type\[Length\]**   **Description**

  Speech\_Encode\_\   cod\_amr\_state         cod\_amrState        see below in this table
  FrameState                                                       

                      pre\_state              Pre\_ProcessState    see below in this table

                      dtx                     Word32               Is set if DTX functionality is used

                                                                   

  Pre\_ProcessState   y2                      Float32              filter state

                                                                   

                      y1                      Word16 Float32       filter state

                                                                   

                      x0                      Float32              filter state

                      x1                      Float32              filter state

  cod\_amrState       old\_speech             Float32 \[320\]      speech buffer

                      speech                  Float32\*            pointer to current frame in old\_speech

                      p\_window               Float32\*            pointer to LPC analysis window in old\_speech

                      p\_window\_12k2         Float32\*            pointer to LPC analysis window with no lookahead in old\_speech (MR122)

                      new\_speech             Float32\*            pointer to the last 160 speech samples in old\_speech

                      old\_wsp                Float32 \[303\]      buffer holding spectral weighted speech

                      wsp                     Float32\*            pointer to the current frame in old\_wsp

                      old\_lags               Word32\[5\]          open loop LTP states

                      ol\_gain\_flg           Float32 \[2\]        enables open loop pitch lag weighting (MR102)

                      old\_exc                Float32 \[314\]      excitation vector

                      exc                     Float32\*            current excitation

                      ai\_zero                Float32 \[51\]       history of weighted synth. filter followed by zero vector

                      zero                    Float32\*            zero vector

                      h1                      Float32\*            impulse response of weighted synthesis filter

                      hvec                    Float32 \[80\]       zero vector followed by impulse response

                      lpcSt                   lpcState             see below in this table

                      lspSt                   lspState             see below in this table

                      clLtpSt                 clLtpState           see below in this table

                      gainQuantSt             gainQuantState       see below in this table

                      pitchOLWghtSt           pitchOLWghtState     see below in this table

                      tonStabSt               tonStabState         see below in this table

                      vadSt                   vadState             see below in this table

                      vadSt2                  vadState2            see below in this table

                      dtx                     Word32               is set if DTX functionality is used

                      dtx\_encSt              dtx\_encState        see below in this table

                      mem\_syn                Float32 \[10\]       synthesis filter memory

                      mem\_w0                 Float32 \[10\]       weighting filter memory (applied to error signal)

                      mem\_w                  Float32 \[10\]       weighting filter memory (applied to input signal)

                      mem\_err                Float32 \[50\]       filter memory for production of error vector

                      error                   Float32\*            error signal (input minus synthesized speech)

                      sharp                   Float32              pitch sharpening gain

  vadState            bckr\_est               Float32 \[9\]        background noise estimate

                      ave\_level              Float32 \[9\]        averaged input components for stationary estimation

                      old\_level              Float32 \[9\]        input levels of the previous frame

                      sub\_level              Float32 \[9\]        input levels calculated at the end of a frame (lookahead)

                      a\_data5                Float32 \[6\]        memory for the filter bank

                      a\_data3                Float32 \[5\]        memory for the filter bank

                      burst\_count            Word16               counts length of a speech burst

                      hang\_count             Word16               hangover counter

                      stat\_count             Word16               stationary counter

                      vadreg                  Word32               15 flags for intermediate VAD decisions

                      pitch                   Word32               15 flags for pitch detection

                      tone                    Word16               15 flags for tone detection

                      complex\_high           Word16               flags for complex detection

                      complex\_low            Word16               flags for complex detection

                      oldlag\_count           Word32               variables for pitch detection

                      oldlag                  Word32               variables for pitch detection

                      complex\_hang\_count    Word16               complex hangover counter, used by VAD

                      complex\_hang\_timer    Word16               hangover initiator, used by CAD

                                                                   

                      best\_corr\_hp          Float32              filtered value

                      speech\_vad\_decision   Word16               final decision

                      complex\_warning        Word16               complex background warning

                      sp\_burst\_count        Word16               counts length of a speech burst incl HO addition

                      corr\_hp\_fast          Word16               filtered value

  dtx\_encState       lsp\_hist               Float32\[80\]        LSP history (8 frames)

                      log\_en\_hist           Float32 \[8\]        logarithmic frame energy history (8 frames)

                      hist\_ptr               Word16               pointer to the cyclic history vectors

                      log\_en\_index          Word16               Index for logarithmic energy

                                                                   

                      init\_lsf\_vq\_index    Word32               initial index for lsf predictor

                      lsp\_index              Word16\[3\]          lsp indecies to the three code books

                      dtxHangoverCount        Word16               is decreased in DTX hangover period

                      decAnaElapsedCount      Word16               counter for elapsed speech frames in DTX

  lpcState            LevinsonSt              LevinsonState        see below

  LevinsonState       old\_A                  Float32\[11\]        last frames direct form coefficients

  lspState            lsp\_old                Float32 \[10\]       old LSP vector

                      lsp\_old\_q             Float32 \[10\]       old quantized LSP vector

                      qSt                     Q\_plsfState         see below in this table

  Q\_plsfState        past\_rq                Float32\[10\]        past quantized LSF prediction error

  clLtpState          pitchSt                 Pitch\_frState       see below in this table

  tonStabState        count                   Word16               count consecutive (potential) resonance frames

                      gp                      Float32\[7\]         pitch gain history

  Pitch\_frState      T0\_prev\_subframe      Word32               integer. pitch lag of previous subframe

  gainQuantState      sf0\_ gcode0            Float32              subframe 0/2 codebook gain

                                                                   

                      sf0\_ target\_en        Float32              subframe 0/2 target energy

                                                                   

                      sf0\_ coeff             Float32 \[5\]        subframe 0/2 energy coefficient

                                                                   

                      gain\_idx\_ptr          Word16\*             pointer to gain index value in parameter frame

                      gc\_predSt              gc\_predState        see below in this table

                      gc\_predUncSt           gc\_predState        see below in this table

                      adaptSt                 GainAdaptState       see below in this table

  gc\_predState       past\_qua\_en           Float32\[4\]         MA predictor memory (20\*log10(pred. error))

  GainAdaptState      onset                   Word16               onset counter

                      prev\_alpha             Float32              previous adaptor output

                      prev\_gc                Float32              previous codebook gain

                      ltpg\_mem               Float32 \[5\]        pitch gain history

  pitchOLWghtState    old\_T0\_med            Word32               weighted open loop pitch lag

                      ada\_w                  Float32              weigthing level depeding on open loop pitch gain

                      wght\_flg               Word16               switches lag weighting on and off
  ------------------- ----------------------- -------------------- -------------------------------------------------------------------------

Table 8: Speech decoder static variables

  ---------------------------- ------------------------ ------------------------ -------------------------------------------------
  **Struct name**              **Variable**             **Type\[Length\]**       **Description**
  Speech\_Decode\_FrameState   decoder\_amrState        Decoder\_amrState        see below in this table
                               post\_state              Post\_FilterState        see below in this table
                               postHP\_state            Post\_ProcessState       see below in this table
  Decoder\_amrState            old\_exc                 Word32\[194\]            excitation vector
                               exc                      Word32\*                 current excitation
                               lsp\_old                 Word32\[10\]             LSP vector of previous frame
                               mem\_syn                 Word32\[10\]             synthesis filter memory
                               sharp                    Word32                   pitch sharpening gain
                               old\_T0                  Word32                   pitch sharpening lag
                               prev\_bf                 Word16                   previous value of \"bad frame\" flag
                               prev\_pdf                Word16                   previous value of \"pot. dangerous frame\" flag
                               state                    Word16                   ECU state (0..6)
                               excEnergyHist            Word32\[9\]              excitation energy history
                               T0\_lagBuff              Word32                   received pitch lag for ECU
                               inBackgroundNoise        Word32                   background noise flag
                               voicedHangover           Word32                   hangover flag
                               ltpGainHistory           Word32\[9\]              pitch gain history
                               background\_state        Bgn\_scdState            see below in this table
                               Cb\_gain\_averState      Cb\_gain\_averageState   see below in this table
                               lsp\_avg\_st             lsp\_avgState            see below in this table
                               lsfState                 D\_plsfState             see below in this table
                               ec\_gain\_p\_st          ec\_gain\_pitchState     see below in this table
                               ec\_gain\_c\_st          ec\_gain\_codeState      see below in this table
                               pred\_state              gc\_predState            see table 7
                               nodataSeed               Word16                   seed for CN generator
                               ph\_disp\_st             ph\_dispState            see below in this table
                               dtxDecoderState          dtx\_decState            see below in this table
  dtx\_decState                since\_last\_sid         Word16                   number of frames since last SID frame
                               true\_sid\_period\_inv   Word16                   inverse of true SID update rate
                               log\_en                  Word32                   logarithmic frame energy
                               old\_log\_en             Word32                   previous value of log\_en
                               pn\_seed\_rx             Word32                   random number generator seed
                               lsp                      Word32\[10\]             LSP vector
                               lsp\_old                 Word32\[10\]             previous LSP vector
                               lsf\_hist                Word32\[80\]             LSF vector history (8 frames)
                               lsf\_hist\_ptr           Word16                   index to beginning of LSF history
                               lsf\_hist\_mean          Word32\[80\]             mean-removed LSF history (8 frames)
                               log\_pg\_mean            Word16                   mean-removed logarithmic prediction gain
                               log\_en\_hist            Word32\[8\]              logarithmic frame energy history
                               log\_en\_hist\_ptr       Word16                   index to beginning of log, frame energy history
                               log\_en\_adjust          Word16                   mode-dependent frame energy adjustment
                               dtxHangoverCount         Word16                   counts down in hangover period
                               decAnaElapsedCount       Word16                   counts elapsed speech frames after DTX
                               sid\_frame               Word16                   flags SID frames
                               valid\_data              Word16                   flags SID frames containing valid data
                               dtxHangoverAdded         Word16                   flags hangover period at end of speech
                               dtxGlobalState           enum DTXStateType        DTX state flags
                               data\_updated            Word16                   flags CNI updates
  Bgn\_scdState                frameEnergyHist          Word32\[60\]             history of synthesis frame energy
                               bgHangover               Word16                   number of frames since last speech frame
  Cb\_gain\_averageState       cbGainHistory            Word32\[7\]              codebook gain history
                               hangVar                  Word16                   counts length of talkspurt in subframes
                               hangCount                Word16                   number of subframes since last talkspurt
  lsp\_avgState                lsp\_meanSave            Word32\[10\]             averaged LSP vector
  D\_plsfState                 past\_r\_q               Word32\[10\]             past quantized LSF prediction vector
                               past\_lsf\_q             Word32\[10\]             past dequantized LSF vector
  ec\_gain\_pitchState         pbuf                     Word32\[5\]              pitch gain history
                               past\_gain\_pit          Word32                   previous pitch gain (limited to 1.0)
                               prev\_gp                 Word32                   previous good pitch gain
  ec\_gain\_codeState          gbuf                     Word32\[5\]              codebook gain history
                               past\_gain\_code         Word32                   previous codebook gain
                               prev\_gc                 Word32                   previous good codebook gain
  ph\_dispState                gainMem                  Word32\[5\]              pitch gain history
                               prevState                Word32                   previously used impulse response
                               prevCbGain               Word32                   previous codebook gain
                               lockFull                 Word16                   force maximum phase dispersion
                               onset                    Word16                   onset counter
  Post\_FilterState            res2                     Word32\[40\]             LP residual
                               mem\_syn\_pst            Word32\[10\]             synthesis filter memory
                               synth\_buf               Word16\[170\]            synthesis filter work area
                               agc\_state               agcState                 see below in this table
                               preemph\_state           preemphasisState         see below in this table
  agcState                     past\_gain               Word16                   past agc gain
  preemphasisState             mem\_pre                 Word16                   filter state
  Post\_ProcessState           y2\_hi                   Word32                   filter state, upper word
                               y2\_lo                   Word32                   filter state, lower word
                               y1\_hi                   Word32                   filter state, upper word
                               y1\_lo                   Word32                   filter state, lower word
                               x0                       Word32                   filter state
                               x1                       Word32                   filter state
  ---------------------------- ------------------------ ------------------------ -------------------------------------------------

5 Homing procedure
==================

The principles of the homing procedures are described in 3GPP TS 06.090
\[2\]. This specification only includes a detailed description of the 8
decoder homing frames. For each AMR codec mode, the corresponding
decoder homing frame has a fixed set of speech parameters shown in table
9a-9h. The bit allocation within these parameters is identical to the
corresponding bit allocation of the source encoder output parameters
given in 3GPP TS 06.090 \[2\].

In the following tables, the following naming convention is used for the
individual parameters. Letters in *italics* indicate numbers.

\- LPC\_*n* index of *n*th LSF submatrix

\- LTP-LAG *m* adaptive codebook index for subframe *m*

\- LTP-GAIN *m* adaptive codebook gain index in subframe *m*

\- FCB-GAIN *m* fixed codebook gain index in subframe *m*

\- GAIN\_VQ *m* codebook gain VQ index in subframe *m* (subframe *m* and
*m+1* for MR475)

\- POS *m*\_*n* position index of *n*th pulse in subframe m

\- POS *m*\_*n*\_*k* position index of *n*th and *k*th pulse in subframe
*m*

\- POS *m*\_*n\_k\_l\_j* position index of *n*th, *k*th, *l*th, and
*j*th pulse in subframe *m*

\- SIGN *m*\_*n*\_*k* sign information for *n*th and *k*th pulse in
subframe *m*

\- SIGN *m*\_ *n\_k\_l\_j* sign information for *n*th, *k*th, *l*th, and
*j*th pulse in subframe *m*

\- SIGN\_*m\_n\_k*\_POS\_*m\_n* sign information for *n*th and *k*th
pulse and position index for *n*th pulse in subframe *m*

Table 9a: Parameter values for the decoder homing frame (MR475)

  --------------- --------------------
  **Parameter**   **Value (LSB=b0)**
  LPC 1           0x00F8
  LPC 2           0x009D
  LPC 3           0x001C
  LTP-LAG 1       0x0066
  POS 1\_1\_2     0x0000
  SIGN\_1\_1\_2   0x0003
  GAIN-VQ 1       0x0028
  LTP-LAG 2       0x000F
  POS 2\_1\_2     0x0038
  SIGN\_2\_1\_2   0x0001
  LTP-LAG 3       0x000F
  POS 3\_1\_2     0x0031
  SIGN\_3\_1\_2   0x0002
  GAIN-VQ 3       0x0008
  LTP-LAG 4       0x000F
  POS 4\_1\_2     0x0026
  SIGN\_4\_1\_2   0x0003
  --------------- --------------------

Table 9b: Parameter values for the decoder homing frame (MR515)

  --------------- --------------------
  **Parameter**   **Value (LSB=b0)**
  LPC 1           0x00F8
  LPC 2           0x009D
  LPC 3           0x001C
  LTP-LAG 1       0x0066
  POS 1\_1\_2     0x0000
  SIGN\_1\_1\_2   0x0003
  GAIN-VQ 1       0x0037
  LTP-LAG 2       0x000F
  POS 2\_1\_2     0x0000
  SIGN\_2\_1\_2   0x0003
  GAIN-VQ 2       0x0005
  LTP-LAG 3       0x000F
  POS 3\_1\_2     0x0037
  SIGN\_3\_1\_2   0x0003
  GAIN-VQ 3       0x0037
  LTP-LAG 4       0x000F
  POS 4\_1\_2     0x0023
  SIGN\_4\_1\_2   0x0003
  GAIN-VQ 4       0x001F
  --------------- --------------------

Table 9c: Parameter values for the decoder homing frame (MR59)

  --------------- --------------------
  **Parameter**   **Value (LSB=b0)**
  LPC 1           0x00F8
  LPC 2           0x00E3
  LPC 3           0x002F
  LTP-LAG 1       0x00BD
  POS 1\_1\_2     0x0000
  SIGN\_1\_1\_2   0x0003
  GAIN-VQ 1       0x0037
  LTP-LAG 2       0x000F
  POS 2\_1\_2     0x0001
  SIGN\_2\_1\_2   0x0003
  GAIN-VQ 2       0x000F
  LTP-LAG 3       0x0060
  POS 3\_1\_2     0x00F9
  SIGN\_3\_1\_2   0x0003
  GAIN-VQ 3       0x0037
  LTP-LAG 4       0x000F
  POS 4\_1\_2     0x0000
  SIGN\_4\_1\_2   0x0003
  GAIN-VQ 4       0x0037
  --------------- --------------------

Table 9d: Parameter values for the decoder homing frame (MR67)

  ------------------ --------------------
  **Parameter**      **Value (LSB=b0)**
  LPC 1              0x00F8
  LPC 2              0x00E3
  LPC 3              0x002F
  LTP-LAG 1          0x00BD
  POS 1\_1\_2\_3     0x0002
  SIGN\_1\_1\_2\_3   0x0007
  GAIN-VQ 1          0x0000
  LTP-LAG 2          0x000F
  POS 2\_1\_2\_3     0x0098
  SIGN\_2\_1\_2\_3   0x0007
  GAIN-VQ 2          0x0061
  LTP-LAG 3          0x0060
  POS 3\_1\_2\_3     0x05C5
  SIGN\_3\_1\_2\_3   0x0007
  GAIN-VQ 3          0x0000
  LTP-LAG 4          0x000F
  POS 4\_1\_2\_3     0x0318
  SIGN\_4\_1\_2\_3   0x0007
  GAIN-VQ 4          0x0000
  ------------------ --------------------

Table 9e: Parameter values for the decoder homing frame (MR74)

  --------------------- --------------------
  **Parameter**         **Value (LSB=b0)**
  LPC 1                 0x00F8
  LPC 2                 0x00E3
  LPC 3                 0x002F
  LTP-LAG 1             0x00BD
  POS 1\_1\_2\_3\_4     0x0006
  SIGN\_1\_1\_2\_3\_4   0x000F
  GAIN-VQ 1             0x0000
  LTP-LAG 2             0x001B
  POS 2\_1\_2\_3\_4     0x0208
  SIGN\_2\_1\_2\_3\_4   0x000F
  GAIN-VQ 2             0x0062
  LTP-LAG 3             0x0060
  POS 3\_1\_2\_3\_4     0x1BA6
  SIGN\_3\_1\_2\_3\_4   0x000F
  GAIN-VQ 3             0x0000
  LTP-LAG 4             0x001B
  POS 4\_1\_2\_3\_4     0x0006
  SIGN\_4\_1\_2\_3\_4   0x000F
  GAIN-VQ 4             0x0000
  --------------------- --------------------

Table 9f: Parameter values for the decoder homing frame (MR795)

  --------------------- --------------------
  **Parameter**         **Value (LSB=b0)**
  LPC 1                 0x00C2
  LPC 2                 0x00E3
  LPC 3                 0x002F
  LTP-LAG 1             0x00BD
  POS\_1\_1\_2\_3\_4    0x0006
  SIGN\_1\_1\_2\_3\_4   0x000F
  LTP-GAIN 1            0x000A
  FCB-GAIN 1            0x0000
  LTP-LAG 2             0x0039
  POS\_2\_1\_2\_3\_4    0x1C08
  SIGN\_2\_1\_2\_3\_4   0x0007
  LTP-GAIN 2            0x000A
  FCB-GAIN 2            0x000B
  LTP-LAG 3             0x0063
  POS\_3\_1\_2\_3\_4    0x11A6
  SIGN\_3\_1\_2\_3\_4   0x000F
  LTP-GAIN 3            0x0001
  FCB-GAIN 3            0x0000
  LTP-LAG 4             0x0039
  POS\_4\_1\_2\_3\_4    0x09A0
  SIGN\_4\_1\_2\_3\_4   0x000F
  LTP-GAIN 4            0x0002
  FCB-GAIN 4            0x0001
  --------------------- --------------------

Table 9g: Parameter values for the decoder homing frame (MR102)

  ----------------- --------------------
  **Parameter**     **Value (LSB=b0)**
  LPC 1             0x00F8
  LPC 2             0x00E3
  LPC 3             0x002F
  LTP-LAG 1         0x0045
  SIGN\_1\_1\_5     0x0000
  SIGN\_1\_2\_6     0x0000
  SIGN\_1\_3\_7     0x0000
  SIGN\_1\_4\_8     0x0000
  POS\_1\_1\_2\_5   0x0000
  POS\_1\_3\_6\_7   0x0000
  POS\_1\_4\_8      0x0000
  GAIN-VQ\_1        0x0000
  LTP-LAG 2         0x001B
  SIGN\_2\_1\_5     0x0000
  SIGN\_2\_2\_6     0x0001
  SIGN\_2\_3\_7     0x0000
  SIGN\_2\_4\_8     0x0001
  POS\_2\_1\_2\_5   0x0326
  POS\_2\_3\_6\_7   0x00CE
  POS\_2\_4\_8      0x007E
  GAIN-VQ\_2        0x0051
  LTP-LAG 3         0x0062
  SIGN\_3\_1\_5     0x0000
  SIGN\_3\_2\_6     0x0000
  SIGN\_3\_3\_7     0x0000
  SIGN\_3\_4\_8     0x0000
  POS\_3\_1\_2\_5   0x015A
  POS\_3\_3\_6\_7   0x0359
  POS\_3\_4\_8      0x0076
  GAIN-VQ\_3        0x0000
  LTP-LAG 4         0x001B
  SIGN\_4\_1\_5     0x0000
  SIGN\_4\_2\_6     0x0000
  SIGN\_4\_3\_7     0x0000
  SIGN\_4\_4\_8     0x0000
  POS\_4\_1\_2\_5   0x017C
  POS\_4\_3\_6\_7   0x0215
  POS\_4\_4\_8      0x0038
  GAIN-VQ\_4        0x0030
  ----------------- --------------------

Table 9h: Parameter values for the decoder homing frame (MR122)

  --------------------------- --------------------
  **Parameter**               **Value (LSB=b0)**
  LPC1                        0x0004
  LPC2                        0x002A
  LPC3                        0x00DB
  LPC4                        0x0096
  LPC5                        0x002A
  LTP-LAG 1                   0x0156
  LTP-GAIN 1                  0x000B
  SIGN\_1\_1\_6\_POS\_1\_1    0x0000
  SIGN\_1\_2\_7\_POS\_1\_2    0x0000
  SIGN\_1\_3\_8\_POS\_1\_3    0x0000
  SIGN\_1\_4\_9\_POS\_1\_4    0x0000
  SIGN\_1\_5\_10\_POS\_1\_5   0x0000
  POS 1\_6                    0x0000
  POS 1\_7                    0x0000
  POS 1\_8                    0x0000
  POS 1\_9                    0x0000
  POS 1\_10                   0x0000
  FCB-GAIN 1                  0x0000
  LTP-LAG 2                   0x0036
  LTP-GAIN 2                  0x000B
  SIGN\_2\_1\_6\_POS\_2\_1    0x0000
  SIGN\_2\_2\_7\_POS\_2\_2    0x000F
  SIGN\_2\_3\_8\_POS\_2\_3    0x000E
  SIGN\_2\_4\_9\_POS\_2\_4    0x000C
  SIGN\_2\_5\_10\_POS\_2\_5   0x000D
  POS 2\_6                    0x0000
  POS 2\_7                    0x0001
  POS 2\_8                    0x0005
  POS 2\_9                    0x0007
  POS 2\_10                   0x0001
  FCB-GAIN 2                  0x0008
  LTP-LAG 3                   0x0024
  LTP-GAIN 3                  0x0000
  SIGN\_3\_1\_6\_POS\_3\_1    0x0001
  SIGN\_3\_2\_7\_POS\_3\_2    0x0000
  SIGN\_3\_3\_8\_POS\_3\_3    0x0005
  SIGN\_3\_4\_9\_POS\_3\_4    0x0006
  SIGN\_3\_5\_10\_POS\_3\_5   0x0001
  POS 3\_6                    0x0002
  POS 3\_7                    0x0004
  POS 3\_8                    0x0007
  POS 3\_9                    0x0004
  POS 3\_10                   0x0002
  FCB-GAIN 3                  0x0003
  LTP-LAG 4                   0x0036
  LTP-GAIN 4                  0x000B
  SIGN\_4\_1\_6\_POS\_4\_1    0x0000
  SIGN\_4\_2\_7\_POS\_4\_2    0x0002
  SIGN\_4\_3\_8\_POS\_4\_3    0x0004
  SIGN\_4\_4\_9\_POS\_4\_4    0x0000
  SIGN\_4\_5\_10\_POS\_4\_5   0x0003
  POS 4\_6                    0x0006
  POS 4\_7                    0x0001
  POS 4\_8                    0x0007
  POS 4\_9                    0x0006
  POS 4\_10                   0x0005
  FCB-GAIN 4                  0x0000
  --------------------------- --------------------

6 File formats
==============

This section describes the file formats used by the encoder and decoder
programs. The test sequences defined in \[2\] also use the file formats
described here.

6.1 Speech file (encoder input / decoder output)
------------------------------------------------

Speech files read by the encoder and written by the decoder consist of
16-bit words where each word contains a 13-bit, left aligned speech
sample. The byte order depends on the host architecture (e.g. MSByte
first on SUN workstations, LSByte first on PCs etc.). Both the encoder
and the decoder program process complete frames (of 160 samples) only.

This means that the encoder will only process *n* frames if the length
of the input file is *n\*160 + k* words, while the files produced by the
decoder will always have a length of *n\*160* words.

6.2 Mode control file (encoder input)
-------------------------------------

The encoder program can optionally read in a mode control file which
specifies the encoding mode for each frame of speech processed. The file
is a text file containing one line per speech frame. Each line contains
one of the mode names from the list {MR475, MR515, MR59, MR67, MR74,
MR795, MR102, MR122}.

6.3 Parameter bitstream file (encoder output / decoder input)
-------------------------------------------------------------

The files produced by the speech encoder/expected by the speech decoder
contain an arbitrary number of frames in the format described in RFC
3267 \[9\], sections 5.1 and 5.3.

By using preprocessor definition encoder/decoder can optionally use AMR
Interface Format 2. The format is described in TS 26.101 \[8\] Annex A.

By using another preprocessor definition encoder/decoder can optionally
use format compatible with the existing AMR fixed-point C-code. Frame
format is following.

  ------------- ---- ---- ----- ------ ------------ ----------- ----- -----------
  FRAME\_TYPE   B1   B2   ...   B244   MODE\_INFO   *unused1*   ...   *unused4*
  ------------- ---- ---- ----- ------ ------------ ----------- ----- -----------

Each box corresponds to one Word16 value in the bitstream file, for a
total of 250 words or 500 bytes per frame. The fields have the following
meaning:

**FRAME\_TYPE transmit frame type, which is one of\
TX\_SPEECH (0x0000)\
TX\_SID\_FIRST (0x0001)\
TX\_SID\_UPDATE (0x0002)\
TX\_NO\_DATA (0x0003)**

**B0...B244 speech encoder parameter bits (i.e. the bitstream itself).
Each B*x* either has the value 0x0000 or 0x0001. Only mode MR122 really
uses all 244 bits; for the other modes, only the first *n* bits are used
(35 ≤ n ≤ 204). The remaining bits are unused (written as 0x0000)**

**MODE\_INFO encoding mode information, which is one of\
MR475 (0x0000)\
MR515 (0x0001)\
MR59 (0x0002)\
MR67 (0x0003)\
MR74 (0x0004)\
MR795 (0x0005)\
MR102 (0x0006)\
MR122 (0x0007)**

***unused1...4* unused, written as 0x0000**

As indicated in section 6.1 above, the byte order depends on the host
architecture.

######## Annex A (informative): Change History

  ---------- ----------- ------ ----- ----- -------- ------- -------- ------------------------------------------------------------------------
  TSG SA\#   Tdoc        CR     Rev   Cat   PH       Vers    New\     Subject
                                                             Vers     

  10         SP-000577   002          A     Rel-4    3.0.0   4.0.0    AMR Core Frame bit ordering (AMR speech Codec; Floating point C-Code

  12         SP-010306   004    1     A     Rel-4    4.0.0   4.1.0    Limiting predicted codebook gain computing in encoder

  12         SP-010306   006    1     A     Rel-4    4.0.0   4.1.0    Correction of decoder operation in error concealment of lost frames

  12         SP-010306   008    1     A     Rel-4    4.0.0   4.1.0    Correction of mode state bug in AMR decoder

  12         SP-010306   012    1     A     Rel-4    4.0.0   4.1.0    Correction of decoder Reset

  12         SP-010306   014    1     A     Rel-4    4.0.0   4.1.0    Correction of comfort noise parameter interpolation bug of AMR decoder

  12         SP-010306   016    1     A     Rel-4    4.0.0   4.1.0    Correction of the TX\_TYPE and RX\_TYPE identifiers

             MCC                            Rel-4    4.1.0   4.1.1    Correction of bugs in code

  13         SP-010452   010    1     A     Rel-4    4.1.1   4.2.0    Correction to make encoder and decoder memories independent

  13         SP-010452   018          A     Rel-4    4.1.1   4.2.0    Correction of decoder operation in error concealment of lost frames

  15         SP-020079   019          A     Rel-4    4.2.0   4.3.0    Maintaining bit-exactness with TS 26.073

  16                                                         5.0.0    Version for Release 5

  19         SP-030088   21     1     F     Rel-5    5.0.0   5.1.0    **MMS compatible i/o format option**

  19         SP-030088   24           A     Rel-5    5.0.0   5.1.0    **Correction to floating-point implementation of sp\_dec.c**

  20         SP-030214   26           A     Rel-5    5.1.0   5.2.0    **Correction on codec mode handling during DTX**

  22         SP-030681   29     1     F     Rel-5    5.2.0   5.3.0    Correction on the implementation of the interface of decoder.c

  22         SP-030682   30     1     D     Rel-6    5.3.0   6.0.0    Correction on the default behaviour of the unix makefile

  23         SP-040198   32           A     Rel-6    6.0.0   6.1.0    Correction of floating point AMR DTX functionality

  36         SP-070321   0033   1     F     Rel-7    6.1.0   7.0.0    Bit order of Mode Indication in AMR comfort noise frames

  42                                        Rel-8            8.0.0    Version for Release 8

  46                                        Rel-9            9.0.0    Version for Release 9

  51                                        Rel-10           10.0.0   Version for Release 10

  57                                        Rel-11           11.0.0   Version for Release 11

  65                                        Rel-12           12.0.0   Version for Release 12

  70                                        Rel-13           13.0.0   Version for Release 13
  ---------- ----------- ------ ----- ----- -------- ------- -------- ------------------------------------------------------------------------

  -------------------- ------------- ----------- -------- --------- --------- ---------------------------------------- -----------------
  **Change history**                                                                                                   
  **Date**             **Meeting**   **TDoc**    **CR**   **Rev**   **Cat**   **Subject/Comment**                      **New version**
  2017-03              75                                                     Version for Release 14                   14.0.0
  2018-06              80                                                     Version for Release 15                   15.0.0
  2018-09              81            SP-180657   0035     2         F         Corrections to AMR Floating-Point Code   16.0.0
  -------------------- ------------- ----------- -------- --------- --------- ---------------------------------------- -----------------
