6 Functional description of the Decoder
=======================================

6.1 LP-based Decoding
---------------------

### 6.1.1 General LP-based decoding

The LSF parameters are decoded from the received bitstream and converted
to LSP coefficients and subsequently to LP coefficients. The
interpolation principle, described in subclause 5.1.9.6, is used to
obtain interpolated LSP vectors for all subframes, i.e. 4 subframes in
case of 12.8 kHz internal sampling rate and 5 subframes in case of 16
kHz sampling rate. Then, the excitation signal is reconstructed and
post-processed before performing LP synthesis (filtering with the LP
synthesis filter) to obtain the reconstructed signal. The reconstructed
signal is then de-emphasized (an inverse of the pre-emphasis applied at
the encoder). Finally, a post-processing is applied for enhancing the
format and harmonic structure of signal as well as the periodicity in
the low frequency region of the signal. The signal is then up-sampled to
the output sample rate. Finally, the high-band signal is generated and
added to the up-sampled synthesized signal to obtain a full-band
reconstructed signal (output signal).

#### 6.1.1.1 LSF decoding

##### 6.1.1.1.1 General LSF decoding

Depending on the predictor allocation per mode, like specified at
encoder side in subclause 5.2.2.1.3 one first bit is read to select
between safety net or predictive mode for the switched safety
net/predictive cases. The bit value of one corresponds to safety net and
value zero corresponds to predictive mode. The following bits are read
in groups of a number equal to the stage sizes corresponding to each
coding mode as specified in subclause 5.2.2.1.4 and the codevectors are
retrieved from the corresponding codebooks. The last bits correspond to
the lattice codevector, having the index $I$. The LSF residual after the
first non-structured, optimized VQ was quantized by splitting the vector
into two subvectors. The index $I$ was obtained as a combined index of
the two indexes corresponding to the first and the second subvector. The
two indexes are retrieved as follows:

$I_{1} = \left\lbrack \frac{I}{N_{2}} \right\rbrack$ (1409)

$I_{2} = I - \left\lbrack \frac{I}{N_{2}} \right\rbrack$ (1410)

These indexes correspond each to a scale index, leader class index and
leader vector permutation index. For each of the two indexes
corresponding to the 8-dimensional subvectors the following operations
are applied. The scale offset is determined by finding out the largest
scale offset that is smallest than the index $I_{i},i = 1,2$. The
corresponding scale offset is removed from each of $I_{i},i = 1,2$.
Similarly the leader offset is calculated and removed for each of the
two indexes. The index of the scale offset gives the index of the scale,
$j_{i}$, and the index of the leader offset gives the index of the
leader class, $k_{i}$. The remaining index values are $I'_{i},i = 1,2$.
The sign index, $I_{\text{si}},i = 1,2$ and the leader index
$I_{\text{li}},i = 1,2$ are obtained

$I_{\text{si}} = \left\lbrack I\frac{'_{i}}{\pi_{0}}(k_{i}) \right\rbrack\ i = 1,2$
(1411)

$I_{\text{li}} = I'_{i} - \left\lbrack I\frac{'_{i}}{\pi_{0}}(k_{i}) \right\rbrack\ i = 1,2$
(1412)

where $\pi_{0}(k_{i})$is the cardinality of unsigned permutations for
the leader class $k_{i}$, given in subclause 5.2.2.1.4. The indexes
$I_{\text{li}},i = 1,2$ and $I_{\text{si}},i = 1,2$ are decoded using
the position decoding based on counting the binomial coefficients and
the sign decoding described in \[26\].

Decoding of the index corresponding to the unsigned permutation of the
leader vector goes as follows. Knowing the leader class index, the
number of distinct non zero values and the amount of each of these
values which are tabulated (see subclause 5.2.2.1.4) can be determined.
The used leader classes defined in subclause 5.2.2.1.4 have at most 4
distinct values. If there is a single value, $v_{0}$, in the leader
class corresponding to the decoded leader class index, all decoded
vector components have the same value

$x(j) = v_{0},j = 0,\text{.}\text{.}\text{.},S - 1$ (1413)

where $S = 8$is the subvector dimension.

If there are two distinct values $v_{0},v_{1}$*,* in the decoded leader
vector, each appearing $k_{0}$ and $k_{1}$ times respectively, the
decoded vector is initialized with

$x(j) = v_{1},j = 0,\text{.}\text{.}\text{.},k_{1} - 1$. (1414)

The leader vector permutation index is interpreted using binomial
coefficients decoding. The positions of the $k_{0}$ values $v_{0}$ are
determined within a vector of length $S$. The position of the first
$v_{0}$, $p\left\lbrack 0 \right\rbrack$ is determined such that

$\begin{pmatrix}
S - 1 \\
k_{0} - 1 \\
\end{pmatrix} + \begin{pmatrix}
S - 2 \\
k_{0} - 1 \\
\end{pmatrix} + \text{.}\text{.}\text{.} + \begin{pmatrix}
S - p\left\lbrack 0 \right\rbrack \\
k_{0} - 1 \\
\end{pmatrix} \leq I_{\text{li}} < \begin{pmatrix}
S - 1 \\
k_{0} - 1 \\
\end{pmatrix} + \begin{pmatrix}
S - 2 \\
k_{0} - 1 \\
\end{pmatrix} + \text{.}\text{.}\text{.} + \begin{pmatrix}
S - 1 - p\left\lbrack 0 \right\rbrack \\
k_{0} - 1 \\
\end{pmatrix}$. (1415)

If $I_{\text{li}} < \begin{pmatrix}
S - 1 \\
k_{0} - 1 \\
\end{pmatrix}$then $p\left\lbrack 0 \right\rbrack = 0$. The position of
the second $v_{0}$ value, $p\left\lbrack 1 \right\rbrack$, is determined
similarly for an updated index

$I_{\text{li}1} = I_{\text{li}} - \begin{pmatrix}
S - 1 \\
k_{0} - 1 \\
\end{pmatrix} - \begin{pmatrix}
S - 2 \\
k_{0} - 1 \\
\end{pmatrix} - \text{.}\text{.}\text{.} - \begin{pmatrix}
S - p\left\lbrack 0 \right\rbrack \\
k_{0} - 1 \\
\end{pmatrix}$ (1416)

an updated number vector length, $S - p\left\lbrack 0 \right\rbrack - 1$
instead of $S$, and an updated number of values, $k_{0} - 1$ instead of
$k_{0}$.

The procedure follows until the positions of all *v*~0~ values are
determined. Once these positions are known the values $v_{0}$ are
inserted in the vector $x$ at the corresponding positions.

If there are 3 distinct values $v_{0},v_{1},v_{2}$ having
$k_{0},k_{1},k_{2}$ number of occurrences respectively, the decoded
vector is initialized with:

$x(j) = v_{2},j = 0,\text{.}\text{.}\text{.},k_{2} - 1$. (1417)

Out of $I_{\text{li}},i = 1,2$, two subindexes are obtained:

$L_{i1} = \left\lbrack \frac{I_{\text{li}}}{\begin{pmatrix}
k_{2} + k_{1} \\
k_{1} \\
\end{pmatrix}} \right\rbrack,i = 1,2$. (1418)

$L_{i2} = I_{\text{li}} - \left\lbrack \frac{I_{\text{li}}}{\begin{pmatrix}
k_{2} + k_{1} \\
k_{1} \\
\end{pmatrix}} \right\rbrack\begin{pmatrix}
k_{2} + k_{1} \\
k_{1} \\
\end{pmatrix},i = 1,2$. (1419)

The positions of the values $v_{1}$ are determined by binomial decoding
of the index $L_{i2}$ considering $k_{1}$ positions out of
$k_{1} + k_{2}$and the values $v_{1}$ are inserted in the vector $x$.
The decoding is performed according to equations (1208) and (1209). The
positions for values *v*~0~ are obtained by binomial decoding of the
index *L~i1~*, considering *k*~0~ positions out of *S.*

If there are 4 distinct values the vector is initialized with

$x(j) = v_{3},j = 0,\text{.}\text{.}\text{.},k_{3} - 1$. (1420)

The index $I_{\text{li}},i = 1,2$ is divided into:

$L_{i1} = \left\lbrack \frac{I_{\text{li}}}{\begin{pmatrix}
k_{2} + k_{3} \\
k_{2} \\
\end{pmatrix}} \right\rbrack,i = 1,2$. (1421)

$L_{i2} = I_{\text{li}} - \left\lbrack \frac{I_{\text{li}}}{\begin{pmatrix}
k_{2} + k_{3} \\
k_{2} \\
\end{pmatrix}} \right\rbrack\begin{pmatrix}
k_{2} + k_{3} \\
k_{2} \\
\end{pmatrix},i = 1,2$. (1422)

$L_{i3} = \left\lbrack \frac{L_{i1}}{\begin{pmatrix}
k_{3} + k_{2} + k_{1} \\
k_{1} \\
\end{pmatrix}} \right\rbrack,i = 1,2$. (1423)

$L_{i4} = L_{i1} - \left\lbrack \frac{L_{i1}}{\begin{pmatrix}
k_{3} + k_{2} + k_{1} \\
k_{1} \\
\end{pmatrix}} \right\rbrack\begin{pmatrix}
k_{3} + k_{2} + k_{1} \\
k_{1} \\
\end{pmatrix},i = 1,2$. (1424)

The positions for values $v_{2}$ are obtained by binomial decoding the
index $L_{i2}$ for $k_{2}$ position out of $k_{2} + k_{3}$. The
positions for values $v_{1}$ are obtained by binomial decoding of the
index $L_{i3}$ for $k_{1}$ positions out of $k_{1} + k_{2} + k_{3}$. The
positions for values $v_{0}$ are obtained by binomial decoding of the
index $L_{i4}$ for $k_{0}$ positions out of $S$.

The obtained subvectors are multiplied with the corresponding scales and
component wise multiplied with the off-line computed standard
deviations. The standard deviations are individually estimated for each
coding mode and bandwidth. The result corresponds to the codevector from
the last stage of the LSF quantizer. The codevectors from all stages are
added together.

If the coding mode corresponds to a safety net only mode, or if it
corresponds to a switched safety net/AR predictive mode and the safety
net mode has been selected at the encoding stage, a vector representing
the component wise mean for the current coding mode is added to the sum
of codevectors and the result represents the decoded LSF vector. The
decoded LSF vector is thus given by:

${\hat{f}}_{t}(i) = \sum_{k = 0}^{N}{l_{k}(i)} + m(i)$, for $i$=0,...,
$M$-1 (1425)

where ${\hat{f}}_{t}(i),i = 0,M - 1$is the LSF vector for current frame
$t$, $l_{k}(i),i = 0,\text{.}\text{.}\text{.},M - 1$*l~k~*(*i*), *i*=0,
*M*-1 is the codevector obtained at stage $k$ out of the $N$
quantization stages and $m(i),i = 0,\text{.}\text{.}\text{.},M - 1$ is
the mean LSF vector for the current coding mode.

If AR predictive mode was selected at the encoding stage, the decoded
LSF vector is given by:

${\hat{f}}_{t}(i) = {\hat{f}}_{t - 1}(i) + \sum_{k = 0}^{N}{l_{k}(i)} + m(i)$,
for $i$=0,..., $M$-1. (1426)

If MA predictive mode was selected at the encoding stage, based on the
coding mode, the decoded LSF vector is given by:

${\hat{f}}_{t}(i) = {\hat{e}}_{t - 1}(i) + \sum_{k = 0}^{N}{l_{k}(i)} + m(i)$,
for $i$=0,..., $M$-1. (1427)

where ${\hat{e}}_{t - 1}$ is the quantization error at the previous
frame $t - 1$.

##### 6.1.1.1.2 LSF decoding for voiced coding mode at 16 kHz internal sampling frequency

The VC mode at the 16 kHz internal sampling frequency has two decoding
rates: 31 bits per frame and 40 bits per frame. The VC mode is decoded
by a 16-state and 8-stage BC-TCVQ. figure 88 shows the decoder of the
predictive BC-TCVQ with safety-net using an encoding rate of 31 bits.
The 31bit LSF decoding performed by the predictive BC-TCVQ with
safety-net proceeds as follows. First, one bit is decoded at the *Scheme
selection* block. This bit defines whether the predictive scheme or the
safety-net scheme is used.

For the safety-net scheme, ${\hat{z}}_{k}(i)$ is decoded by equation
(1428),

${\hat{z}}_{k}(i - 1) = {\hat{t}}_{k}(i - 1) + A_{i - 1}{\hat{z}}_{k}(i - 2)$,
for $i$=2,..., $M$/2 (1428)

where the prediction residual, $t_{k}(i)$, is decoded by the 1^st^
BC-TCVQ.

If the predictive scheme is used, the prediction vector $p_{k}(i)$ is
obtained using (1429):

$p_{k}(i) = \rho(i){\hat{z}}_{k - 1}^{'}(i)$, for $i$=0,..., $M$-1
(1429)

where $\rho(i)$are the selected AR prediction coefficients for the VC
mode at 16kHz isf, M is the LPC order, and
${\hat{z}}_{k - 1}^{'}(i) = \lbrack{\hat{z}}_{k - 1}^{t}(0),{\hat{z}}_{k - 1}^{t}(1),\text{.}\text{.}\text{.},{\hat{z}}_{k - 1}^{t}(\frac{M}{2} - 1)\rbrack$.

The decoding of ${\hat{r}}_{k}(i)$ is performed as given by equation
(1430),

${\hat{r}}_{k}(i - 1) = {\hat{t}}_{k}(i - 1) + A_{i - 1}{\hat{r}}_{k}(i - 2)$,
for $i$=2,..., $M$/2 (1430)

where the prediction residual, $t_{k}(i)$, is decoded by the 2^nd^
BC-TCVQ.

The quantized LSF vector ${\hat{f}}_{k}(i)$ for the predictive scheme is
calculated by equation (1431),

${\hat{f}}_{k}(i) = p_{k}(i) + m(i) + {\hat{r}}_{k}^{'}(i)$, for
$i$=0,..., $M$-1 (1431)

where $m(i)$ is the mean vector for VC mode and
${\hat{r}}_{k}^{'}(i) = \lbrack{\hat{r}}_{k}^{t}(0),{\hat{r}}_{k}^{t}(1),\text{.}\text{.}\text{.},{\hat{r}}_{k}^{t}(\frac{M}{2} - 1)\rbrack$

The quantized LSF vector ${\hat{f}}_{k}(i)$for the safety-net scheme is
calculated by equation (1432).

${\hat{f}}_{k}(i) = m(i) + {\hat{z}}_{k}^{'}(i)$, for $i$=0,..., $M$-1
(1432)

![](media/image1.wmf){width="6.690972222222222in"
height="4.322222222222222in"}

Figure 88: Block diagram of the decoder for the predictive BC-TCVQ with
safety-net for an encoding **rate of 31 bits per frame**

Figure 89 shows the decoder of the predictive BC-TCVQ with safety-net
for an encoding rate of 40 bits per frame. The 40-bit LSF decoding using
the predictive BC-TCVQ with safety-net is performed as follows. The
scheme selection and the decoding method of BC-TCVQ for both the
predictive and safety-net schemes are the same as those of the 31-bit
LSF decoding. ${\hat{z}}_{2}(i)$ and ${\hat{r}}_{2}(i)$ are decoded by
the 3^rd^ and 4^th^ SVQ decoding respectively. The quantized LSF vector
${\hat{f}}_{k}(i)$ for the predictive scheme is calculated according to
equation (1433),

${\hat{f}}_{k}(i) = p_{k}(i) + m(i) + {\hat{r}}_{1}(i) + {\hat{r}}_{2}(i)$,
for $i$=0,...,$M$-1 (1433)

where ${\hat{r}}_{1}(i)$ is the output of the 2^nd^ BC-TCVQ and the
2^nd^ intra-frame prediction.

The quantized LSF vector ${\hat{f}}_{k}(i)$for the safety-net scheme is
calculated by equation (1434),

${\hat{f}}_{k}(i) = m(i) + {\hat{z}}_{1}(i) + {\hat{z}}_{2}(i)$, for
$i$=0,..., $M$-1 (1434)

where ${\hat{z}}_{1}(i)$ is the output of the 1^st^ BC-TCVQ and 1^st^
intra-frame prediction.

![](media/image2.wmf){width="6.690972222222222in" height="4.1875in"}

Figure 89: **Block diagram of the decoder for the predictive BC-TCVQ/SVQ
with safety-net for an encoding rate of 40 bits per frame**

#### 6.1.1.2 Reconstruction of the excitation

##### 6.1.1.2.1 Reconstruction of the excitation in GC and VC modes and high rate IC/UC modes

##### 6.1.1.2.1.1 Decoding the adaptive codebook vector {#decoding-the-adaptive-codebook-vector .H6}

The received adaptive codebook parameters (or pitch parameters) are the
closed-loop pitch, $T_{\text{CL}}$, and the pitch gain,
${\hat{g}}_{p}$(adaptive codebook gain), transmitted for each subframe,
serve to compute the adaptive codevector, $v\left( n \right)$.

##### 6.1.1.2.1.2 Pulse index decoding of the 43-bit algebraic codebook {#pulse-index-decoding-of-the-43-bit-algebraic-codebook .H6}

The joint indexing decoding procedure of three pulses on two tracks is
described as follows:

In the decoder side, the de-indexing procedure is as below for
$Q(Q = 3)$pulses, $M$ positions on the track:

1.  24 bits are extracted from the received bit-stream and then decoded
    as the temporary index $\text{temp}_{I}$. If $\text{temp}_{I}$ is
    smaller than *THR* which is the same as the encoder side, the joint
    index $\text{Jo}\text{int\_}\text{index}$equals to
    $\text{temp}_{I}$. If $\text{temp}_{I}$ is bigger than or equal to
    *THR*, 1 more bit will be extracted from the bit-stream as *Bit*.
    Then the global index $\text{temp}_{I}$ is adjusted as:
    $\text{temp}_{I} = (\text{temp}_{I}\text{<<}1) + \text{Bit}$. Then
    the joint index $\text{Jo}\text{int\_}\text{index}$ is computed by
    subtracting *THR* from $\text{temp}_{I}$:

$\text{Jo}\text{int\_}\text{index} = \text{temp}_{I} - \text{THR}$
(1435)

2.  Decompress the joint index $\text{Jo}\text{int\_}\text{index}$into
    the two index for each track:

$\text{ind}_{1} = \text{Jo}\text{int\_}\frac{\text{index}}{W_{2}}$
(1436)

$\text{ind}_{2} = \text{Jo}\text{int\_}\text{index}{\% W}_{2}$ (1437)

3.  Decoding the index for each track($\text{ind}_{1}$and
    $\text{ind}_{2}$) as below:

```{=html}
<!-- -->
```
1)  determining the quantity of pulse positions according to the first
    index $I_{1}(N)$

> As the offset index $I_{1}(N)$ is saved in a table (available in
> encoder and decoder), and each offset index in the table indicates the
> unique number of pulse positions in the track. So $I_{1}(N)$ can be
> decoded from the index easily. Then the number of pulse position $N$,
> the sign index$I_{4}(N)$ and $I_{\text{23}}$ are obtained.

2)  As we know the number of pulse position $N$ and index
    $I_{\text{23}}$, the index$I_{2}(N)$and $I_{3}(N)$ can be decoded
    based on permutation method from the index $I_{\text{23}}$, and each
    pulse position is also decoded from $I_{2}(N)$and
    $I_{3}(N)$.Separating and obtaining the second index $I_{3}(N)$and
    the third index $I_{3}(N)$in the following way:

$I_{2}(N) = I_{\text{23}}{\% C}_{M}^{N}$ (1438)

$I_{3}(N) = \text{Int}\lbrack\frac{I_{\text{23}}}{C_{M}^{N}}\rbrack$
(1439)

> wherein $I_{2}(N)$represents the second index, $I_{3}(N)$represents
> the third index, $N$represents the quantity of the positions with
> pulse on it, $\text{\%}$refers to taking the remainder, and "Int"
> refers to taking the integer

3)  determining the distribution of the positions with a pulse on the
    track according to the second index;

> the $I_{2}(N)$is obtained, the following calculation process is
> applied at the decoder:
>
> \(1\) $C_{M - 1}^{N - 1}$, \..., and $C_{M - y0}^{N - 1}$ are
> subtracted from $I_{2}(N)$one by one.

$R(y0) = I_{2}(N) - C_{M - 1}^{N - 1} - \text{.}\text{.}\text{.} - C_{M - y0}^{N - 1}$
(1440)

> until the $I_{2}(N)$remainder $R(y0)$changes from a positive number to
> a negative number, where $M$is the total quantity of positions on the
> track, $N$is the quantity of positions with pulses,
> $y0 \in \lbrack 1,M - N - 1\rbrack$, and C refers to calculating the
> combination function. The $p(0)$, namely, the serial number of the
> first position with a pulse(s) on the position, is recorded, where
> $p(0) = y0 - 1$.
>
> \(2\) If $N > 1$, $C_{M - p(0) - 1}^{N - 2}$, \..., and
> $C_{M - p(0) - y1}^{N - 2}$ are further subtracted from $R(y0)$one by
> one until the $R(y0)$ remainder $R1(y1)$changes from a positive number
> to a negative number. The $p(1)$namely, the serial number of the
> second position with a pulse(s) on the position, is recorded, where
> $p(1) = y1 - 1$.
>
> \(3\) And so on, $C_{M - p(0) - \ldots - p(n - 1) - 1}^{N - n - 2}$,
> \..., and $C_{M - p(0) - \ldots - p(n - 1) - \text{yn}}^{N - n - 2}$
> are further subtracted from $R(n - 1)\lbrack p(n - 1)\rbrack$ one by
> one until the $R(n - 1)\lbrack p(n - 1)\rbrack$remainder
> $\text{Rn}(\text{yn})$changes from a positive number to a negative
> number, where $n \leq N - 1$. The $p(n)$ namely, the serial number of
> the n+1 position with a pulse(s) on the position, is recorded, where
> $p(n) = \text{yn} - 1$.
>
> \(4\) The decoding of the $I_{2}(N)$is completed, and
> $P(N) = \left\{ p(0),p(1),\text{.}\text{.}\text{.},p(N - 1) \right\}$is
> obtained.

4)  determining the quantity of pulses in each position with pulses
    according to the third index;

> For each track, according to the third index $I_{3}(N)$, determine the
> number of pulses on each position that has a pulse. the $I_{3}(N)$ is
> obtained, the following calculation process is applied at the decoder:
>
> \(1\)
> $T\lbrack q(0)\rbrack = I_{3}(N) - C_{\text{PPT}}^{\text{ΔN}} - C_{\text{PPT} - q(0)}^{\text{ΔN}}$is
> calculated from a smaller $q(0)$value to a greater $q(0)$value, where:
> $q(0) \in \lbrack\text{0,}N - 1\rbrack$,
> $\text{ΔN} = Q - N$,$\text{PPT} = Q - 1$, and C refers to calculating
> the combination function. The last $q(0)$value that lets
> $T\lbrack q(0)\rbrack$be greater than zero is recorded as the position
> $v0$of the first pulse on the track.
>
> \(2\) If $\text{ΔN} > 1$,
> $T1\lbrack q(1)\rbrack = T(v0) - (C_{\text{PPT} - 1 - v0}^{\text{ΔN}} - C_{\text{PPT} - 1 - q(1)}^{\text{ΔN}})$is
> further calculated from a smaller $q(1)$value to a greater
> $q(1)$value, where $q(1) \in \lbrack v0,N - 1\rbrack$; and the last
> $q(1)$value that lets $T1\lbrack q(1)\rbrack$be greater than zero is
> recorded as the position $v1$of the second pulse on the track.
>
> \(3\) By analogy,
> $\text{Th}\lbrack q(h)\rbrack = T(h - 1)(q(h - 1) - (C_{\text{PPT} - h - q(h - 1)}^{\text{ΔN}} - C_{\text{PPT} - h - q(h)}^{\text{ΔN}})$is
> calculated from a smaller $q(h)$ value to a greater $q(h)$value,
> where: $q(h) \in \lbrack v(h - 1),N - 1\rbrack$, and
> $h \in \lbrack\text{2,Δ}N - 1\rbrack$; and the last $q(h)$ value that
> lets $\text{Th}\lbrack q(h)\rbrack$be greater than zero is recorded as
> the position $\text{vh}$for the (h+1)*^th^* pulse(h+1 is an ordinal
> number) on the track.
>
> \(4\) The decoding of the $I_{3}(N)$is completed, and
> $\text{SU}'(N) = \left\{ q(0),q(1),\text{.}\text{.}\text{.},q(\text{ΔN} - 1) \right\}$
> is obtained.

5)  After obtain
    $\text{SU}'(N) = \left\{ q(0),q(1),\text{.}\text{.}\text{.},q(\text{ΔN} - 1) \right\}$,
    mean on each position
    $q(0) \leq q(1) \leq ,\text{.}\text{.}\text{.}, \leq q(\text{ΔN} - 1)$
    have a pulse, if $q(i) = q(i + 1)$, mean on the position $q(i)$ have
    more pulses. The $\text{SU}'(N)$is the result after subtract value
    "1" from the number of pulses in each pulse position, so value "1"
    is need to be added back to $N$ position, and $\text{SU}(N)$is
    rebuilt as following

6)  By now all the pulse positions, the quantity of pulses in each pulse
    position and associated signs are decoded, so the pulses on each
    track is reconstructed.

##### 6.1.1.2.1.3 Mulit-track joint decoding of pulse indexing {#mulit-track-joint-decoding-of-pulse-indexing .H6}

> All the muti-track joint decoding step is described as following:

1)  extracting the $\text{final}_{\text{index}_{0}}$,
    > $\text{final}_{\text{index}_{1}}$,
    > $\text{final}_{\text{index}_{2}}$,$\text{final}_{\text{index}_{3}}$
    > and $\text{track}_{\text{hi}}$from the stream;

2)  Get the parameter from the table 35 according to the pulse number of
    > each track, include the index *bits~t~*, *Hi\_Bit\_bits~t~*,
    > *Hi\_Bit\_range~t~*, *re-back\_bits~t~*,

3)  Extract $h_{0}$and $\text{track}_{}$ from
    > $\text{final}_{\text{index}_{0}}$, extract $h_{1}$and
    > $\text{track}_{}$ from $\text{final}_{\text{index}_{1}}$,
    > extract$h_{2}$ and $\text{track}_{}$ from
    > $\text{final}_{\text{index}_{2}}$, extract $h_{3}$ and
    > $\text{track}_{}$ from $\text{final}_{\text{index}_{3}}$.

4)  From $\text{track}_{\text{hi}}$,$h_{0}$, $h_{1}$, $h_{2}$ and
    > $h_{3}$, $\text{hi}_{0}$, $\text{hi}_{1}$, $\text{hi}_{2}$ and
    > $\text{hi}_{3}$ are decoded out.

```{=html}
<!-- -->
```
(1) The $\text{track}_{\text{hi}}$ is combined with $h_{3}$ and obtain
    $\text{hi}_{\text{SLP}2H}$*~,~* $\text{hi}_{\text{SLP}2H}$ is
    combined with $h_{2}$ and obtain $\text{hi}_{\text{SLP}2}$, then
    $\text{hi}_{3}$ can be get as following:

$\text{hi}_{3} = \text{hi}_{\text{SLP}2}\text{\%}\text{Hi}_{\text{Bit}_{\text{range}_{3}}}$
(1441)

$\text{hi}_{\text{SLP}1H} = \frac{\text{hi}_{\text{SLP}2}}{\text{Hi}_{\text{Bit}_{\text{range}_{3}}}}$
(1442)

(2) The $\text{hi}_{\text{SLP}1H}$ is combined with $h_{1}$ and obtain
    $\text{hi}_{\text{SLP}1}$, then $\text{hi}_{2}$ can be get as
    following:

$\text{hi}_{2} = \text{hi}_{\text{SLP}1}\text{\%}\text{Hi}_{\text{Bit}_{\text{range}_{2}}}$
(1443)

$\text{hi}_{\text{SLP}0H} = \frac{\text{hi}_{\text{SLP}1}}{\text{Hi}_{\text{Bit}_{\text{range}_{2}}}}$
(1444)

(3) The $\text{hi}_{\text{SLP}0H}$ is combined with $h_{0}$ and obtain
    $\text{hi}_{\text{SLP}0}$, then $\text{hi}_{0}$, $\text{hi}_{1}$ can
    be get as following:

$\text{hi}_{1} = \text{hi}_{\text{SLP}0}\text{\%}\text{Hi}_{\text{Bit}_{\text{range}_{1}}}$
(1445)

$\text{hi}_{0} = \frac{\text{hi}_{\text{SLP}0}}{\text{Hi}_{\text{Bit}_{\text{range}_{1}}}}$
(1446)

5)  Combine $\text{hi}_{0}$, $\text{hi}_{1}$,
    > $\text{hi}_{2}$,$\text{hi}_{3}$ with $\text{track}_{}$,
    > $\text{track}_{}$, $\text{track}_{}$, $\text{track}_{}$, and get
    > the index of each track.

##### 6.1.1.2.1.4 Decoding the algebraic codebook vector {#decoding-the-algebraic-codebook-vector .H6}

The received algebraic codebook index is used to extract the positions
and amplitudes (signs) of the excitation pulses and to find the
algebraic codevector $c\left( n \right)$. If the integer part of the
pitch lag is less than the subframe size 64, the pitch sharpening
procedure is applied, which translates into modifying
$c\left( n \right)$by filtering it through the adaptive pre-filter
$F^{(0)}\left( z \right) = \left( 1 - \beta_{1}z^{- 1} \right)/\left( 1 - 0\text{.}\text{85}z^{- T} \right)$
which further consists of two parts: a periodicity enhancement part
$1/\left( 1 - 0\text{.}\text{85}z^{- T} \right)$, where $T$is the
integer part of the pitch lag representing the fine spectral structure
of the speech signal, and a tilt
part$\left( 1 - \beta_{1}z^{- 1} \right)$, where $\beta_{1}$is related
to the voicing of the previous subframe and is bounded by \[0.28, 0.56\]
at 16.4 and 24.4 kbps, and by \[0.0; 0.5\] otherwise.

The periodicity enhancement part of the filter colours the spectrum by
damping inter-harmonic frequencies, which are annoying to the human ear
in case of voiced signals.

Depending on bitrates and coding mode, and the estimated level of
background noise, the adaptive pre-filter also includes a filter based
on the spectral envelope, which colours the spectrum by damping
frequencies between the formant regions. The final form of the adaptive
pre filter $F\left( z \right)$is given by

$F\left( z \right) = F^{\left( 0 \right)}\left( z \right)\frac{\hat{A}\left( z/\eta_{1} \right)}{\hat{A}\left( z/\eta_{2} \right)}$
(1447)

where $\eta_{1} = 0\text{.}\text{75}$and $\eta_{2} = 0\text{.}9$if
$\text{sr}_{\text{celp}} = \text{12800}$Hz and
$\eta_{1} = 0\text{.}8$and $\eta_{2} = 0\text{.}\text{92}$if
$\text{sr}_{\text{celp}} = \text{16000}$Hz.

##### 6.1.1.2.1.5 Decoding of the combined algebraic codebook {#decoding-of-the-combined-algebraic-codebook .H6}

At 32 kbps and 64 kbps bit-rates, the pre-quantizer excitation
contribution is obtained from the received pre-quantizer parameters as
follows. The contribution from the pre-quantizer is obtained by first
de-quantizing the decoded (quantized) spectral coefficients using an AVQ
decoder and applying the iDCT to these de-quantized spectral
coefficients. Further the pre-emphasis filter $\frac{1}{F_{p}}(z)$ is
applied after the iDCT to form the pre-quantizer contribution $q(n)$.
The pre-quantizer contribution $q(n)$ then scales using the quantized
pre-quantizer gain ${\hat{g}}_{q}$ to form the pre-quantizer excitation
contribution.

The same above procedure applies for decoding GC, TC and IC mode at 32
kbps and 64 kbps with the exception of non-harmonic signals at 32kbps GC
mode where the iDCT stage is omitted. It is noted that at the decoder,
the order of codebooks and corresponding codebook stages during the
decoding process is not important as a particular codebook contribution
does not depend on or affect other codebook contributions. Thus the
codebook arrangement in the IC mode is identical to the GC mode codebook
arrangement. The pre-quantizer gain ${\hat{g}}_{q}$in GC and TC mode is
obtained by

${\hat{g}}_{q} = {\hat{E}}_{i} \cdot {\hat{g}}_{q,\text{norm}}$ (1448)

where ${\hat{g}}_{q,\text{norm}}$ is the decoded normalized
pre-quantizer gain and ${\hat{E}}_{i}$ predicted algebraic codevector
energy.

In IC mode, the de-quantizer gain is obtained by

${\hat{g}}_{q} = {\hat{g}}_{c} \cdot {\hat{g}}_{q,\text{norm}}$ (1449)

where ${\hat{g}}_{c}$ is the quantized algebraic codebook gain.

##### 6.1.1.2.1.6 AVQ decoding {#avq-decoding .H6}

The reading of the AVQ parameters from the bitstream is complementary to
the insertion described in subclause 5.2.3.1.6.9.3. The codebook numbers
$n_{j}$ are used to estimate the actual bit-budget needed to encode AVQ
parameters at the decoder and the number of unused AVQ bits is computed
as a difference between the allocated and actual bit budgets.

##### 6.1.1.2.1.6.1 Decoding of AVQ parameters {#decoding-of-avq-parameters .H6}

The parameters decoding involves decoding the AVQ parameters describing
each 8-dimensional quantized sub‑bands ${\hat{S}}^{'}(8j)$ of the
quantized spectrum $S^{'}(k)$. The ${\hat{S}}^{'}(8j)$ comprise several
sub-bands (8 in case of combined algebraic codebook), each of 8 samples.
The decoded AVQ parameters for each sub‑band ${\hat{S}}^{'}(8j)$
comprise:

-   the codebook number $n_{j}$,

-   the vector index $I_{j}$ *,*

-   *and,* if the codevector (i.e. lattice point) is not in a base
    codebook, the Voronoi index $I_{j}^{v}$.

The unary code for the codebook number $n_{j}$*, is first read from the
bitstream and* $n_{j}$ *is determined. From* the codebook number
$n_{j}$*, the base codebook and the Voronoi extension order* $r_{j}^{v}$
*are then obtained. If* $n_{j} < 5$, there is no Voronoi extension
($r_{j}^{v} = 0$) and the base codebook is $Q_{n_{j}}$. If $n_{j} > 5$
the base codebook is either *Q*~3~ ($n_{j}$ even) or *Q*~4~ ($n_{j}$
odd) and the Voronoi order (1 or 2) is also determined ($r_{j}^{v} = 1$
if $n_{j} < 7$; $r_{j}^{v} = 2$, otherwise).

Then, if $n_{j} > 0$, the vector index $I_{j}$, coded on $4n_{j}$ bits
is read from the bitstream and the base codevector $z_{j}$ is decoded.

After the decoding of the base codevector, if the Voronoi order
$r_{j}^{v}$ is greater than 0, the Voronoi extension index $I_{j}^{v}$
is decoded to obtain the Voronoi extension vector $v_{j}$. The number of
bits in each component of index vector $I_{j}^{v}$ is given by the
Voronoi extension order $r_{j}^{v}$, and the scaling factor $M_{j}^{v}$
of the Voronoi extension is given by $M_{j}^{v} = 2^{r_{j}^{v}}$.

Finally, from the scaling factor $M_{j}^{v}$, the Voronoi extension
vector $v_{j}$ and the base codebook vector $z_{j}$, each 8-dimensional
AVQ sub-band ${\hat{S}}^{'}(8j)$ is computed as:

${\hat{S}}^{'}(8j) = M_{j}^{v} \cdot z_{j} + v_{j}$ (1450)

In case of decoding the pre-quantizer, resp. de-quantizer, contribution
from subclause 6.1.1.2.1.3, the decoded sub-band blocks of
${\hat{S}}^{'}(k)$ corresponds to the decoded spectrum coefficients
${\hat{Q}}_{d}(k)$, resp. ${\hat{U}}_{d}(k)$.

##### 6.1.1.2.1.6.2 De-indexing of codevector in base codebook {#de-indexing-of-codevector-in-base-codebook .H6}

The index decoding of the codevector $z_{j}$ is done in several steps.
First, the absolute leader and its offset are identified by comparing
the index with the offset in the look‑up table. The offset is subtracted
from the index to produce a new index. From this index, the sign index
and the absolute vector index are extracted. The sign index is decoded
and the sign vector is obtained. The absolute vector index is decoded by
using a multi-level permutation-based index decoding method and the
absolute vector is obtained. Finally, the decoded vector is
reconstructed by combining the sign vector with the absolute vector.

##### 6.1.1.2.1.6.2.1 Sign decoding {#sign-decoding .H6}

The sign vector is obtained by extracting from left to right all the
sign bits for non-zero elements in the absolute vector. The bit number
of the sign code is read from the ($S_{n}$). If the bit number of the
sign index is not equal to the number of the non-zero elements in the
decoded absolute vector, the sign of the last non-zero element is
recovered.

##### 6.1.1.2.1.6.2.2 Decoding of the absolute vector and of its position vector {#decoding-of-the-absolute-vector-and-of-its-position-vector .H6}

The decoding method of the absolute vector index is described as
follows:

1)  The absolute vector index is decomposed into several mid-indices for
    each level from lowest level to highest level. The absolute vector
    index is the starting value for the lowest level. The mid-index of
    each lower level is obtained by dividing the absolute vector index
    by the possible index value count, $C_{m_{n - 1}}^{m_{n}}$, the
    quotient is the absolute vector index for the next lower level. The
    remainder is the middle index, $I_{\text{mid},n}$, for the current
    level.

2)  The $I_{\text{mid},n}$ of each lower level is decoded based on a
    permutation and combination function and the position vector of each
    lower level vector related to its upper level vector is obtained.

Finally, one-by-one from the lowest level to the highest level, each
lower level absolute vector is used to partly replace the upper level
absolute vector elements according to the position parameter. The
highest level vector is the decoded output absolute vector. A example of
the $L_{1}$ absolute vector partly replace the $L_{0}$absolute vector
elements is give as following:

![](media/image3.wmf){width="5.501388888888889in"
height="2.348611111111111in"}

Figure 90: Replacing example between $L_{1}$and $L_{0}$ for
$K_{a} = \text{20}$.

##### 6.1.1.2.1.6.2.3 Position vector decoding {#position-vector-decoding .H6}

To obtain the position vector from the middle index in each lower level,
the algorithm uses a permutation and combination procedure to estimate
the position sequence. The procedure is as follows:

1\) Increment the $\text{pos}$ value beginning from zero, until
$I_{\text{mid},n}$ is not more than
$C_{m_{n - 1}}^{m_{n}} - C_{m_{n - 1} - \text{pos}}^{m_{n}}$.

2\) Let $q_{0} = \text{pos} - 1$ be the first position, and subtract
$C_{m_{n - 1}}^{m_{n}} - C_{m_{n - 1} - q}^{m_{n}}$from the
$I_{\text{mid}}$.

3\) Increase $\text{pos}$, beginning from $q_{i - 1} + 1$, until
$I_{\text{mid}}$ is not more than
$C_{m_{n - 1} - q_{i - 1} - 1}^{m_{n} - i} - C_{m_{n - 1} - \text{pos}}^{m_{n} - i}$,
where $q_{i - 1}$ is the position decoded at the previous step.

4\) Let $q_{i} = \text{pos} - 1$ be the position number $i$, and
subtract
$C_{m_{n - 1} - q_{i - 1} - 1}^{m_{n} - i} - C_{m_{n - 1} - q_{i}}^{m_{n} - i}$from
the $I_{\text{mid}}$.

5\) Repeat steps 3 and 4 until all positions are decoded for the current
level position sequence.

##### 6.1.1.2.1.6.2.4 Absolute vector decoding {#absolute-vector-decoding .H6}

For the lowest level, the absolute vector only includes one type of
element whose value can be obtained from the decomposition order column
in the table of subclause 5.2.3.1.6.9.3.2. The lowest level absolute
vector is passed to the next level and at the next step another type of
element is added. This new element is obtained from the decomposition
order column in the table of subclause 5.2.3.1.6.9.3.2. This procedure
is repeated until the highest level is reached.

##### 6.1.1.2.1.6.2.5 Construction of the output codevector in base codebook {#construction-of-the-output-codevector-in-base-codebook .H6}

Constructing the 8-dimensional output codevector in the base codebook is
the final step of the decoding procedure. The codevector $z_{j}$ is
obtained by combining the sign vector with the absolute vector. If the
bit number of the sign index is not equal to the number of the non-zero
elements in the decoded absolute vector, the sign of the last non-zero
element is recovered. The recovery rule, based on the *RE*~8~ lattice
property, is as follows: if the sum of all output vector elements is not
an integer multiple of 4, the sign of the last element is set to
negative.

##### 6.1.1.2.1.7 Decoding the gains {#decoding-the-gains .H6}

##### 6.1.1.2.1.7.1 Decoding memory-less coded gains {#decoding-memory-less-coded-gains .H6}

Before calculating the adaptive and algebraic codebook gain in each
subframe, the predicted algebraic codevector energy, ${\hat{E}}_{i}$, is
decoded for the whole frame.

Now, let $E_{c}$denote the algebraic codebook excitation energy in dB in
a given subframe, which is given by

$E_{c} = \text{10}\text{log}\left( \frac{1}{\text{64}}\sum_{i = 0}^{\text{63}}{c^{2}\left( i \right)} \right)$
(1451)

In the equation above, $c\left( i \right)$is the pre-filtered algebraic
codevector.

A predicted algebraic codebook gain is then calculated as

$g_{c}^{'} = \text{10}^{0\text{.}\text{05}\left( {\hat{E}}_{i} - E_{c} \right)}$
(1452)

An index is then retrieved from the bitstream representing a
jointly-quantized adaptive codebook gain along with a correction factor.
The quantized adaptive codebook gain, ${\hat{g}}_{p}$, is retrieved
directly from the codebook and the quantized algebraic codebook gain is
given by

${\hat{g}}_{c} = \hat{\gamma}\ g_{c}^{'}$ (1453)

where$\hat{\gamma}$is the decoded correction factor.

Note that no prediction based on parameters from past frames is used.
This increases the robustness of the codec to frame erasures.

##### 6.1.1.2.1.7.2 Decoding memory-less joint coded gains at lowest bit-rates {#decoding-memory-less-joint-coded-gains-at-lowest-bit-rates .H6}

For the lowest bitrates of 7.2 and 8.0 kbps, slightly different
memory-less joint gain coding scheme is used.

Similarly as in the encoder, the estimated (predicted) gain of the
algebraic codebook in the first subframe is given by

$g_{c0}^{\lbrack 0\rbrack} = \text{10}^{a_{0} + a_{1}\text{CT} - \text{log}_{\text{10}}(\sqrt{E_{c}})}$
(1454)

where *CT* is the coding mode, selected for the current frame in the
pre-processing part, and $E_{c}$ is the energy of the filtered algebraic
codevector. The inner term inside the logarithm corresponds to the gain
of innovation vector. The only parameter in the equation above is the
coding mode *CT* which is constant for all subframes of the current
frame. The superscript \[0\] denotes the first subframe of the current
frame.

In all subframes following the first subframe the estimated value of the
algebraic codebook gain is given by

$g_{c0}^{\lbrack k\rbrack} = \text{10}^{b_{0} + b_{1}\text{CT} + \sum_{i = 1}^{k}{b_{i + 1}\text{log}_{\text{10}}(g_{c}^{\lbrack i - 1\rbrack})} + \sum_{i = 1}^{k}{b_{k + 1 + i}g_{p}^{\lbrack i - 1\rbrack}}}$
(1455)

where *k*=1,2,3. Note, that the terms in the first and in the second sum
of the exponent, there are quantized gains of algebraic and adaptive
excitation of previous subframes, respectively. Note that the term
including the gain of innovation vector
$\text{log}_{\text{10}}(\sqrt{E_{c}})$ is not subtracted. The reason is
in the use of the quantized values of past algebraic codebook gains
which are already close enough to the optimal gain and thus it is not
necessary to subtract this gain again.

The gain de-quantization in the decoder is done by retrieving the
codevector \[$g_{p}$;$\gamma$\] according to the index receing in the
bitstream. The quantized value of the fixed codebook gain is then
calculated as

$g_{c} = g_{c0}\text{.}\gamma$ (1456)

##### 6.1.1.2.1.7.3 Decoding scalar coded gains at highest bit-rates {#decoding-scalar-coded-gains-at-highest-bit-rates .H6}

As described in subclause 6.1.1.2.1.3.1, before calculating the adaptive
and algebraic codebook gain in each subframe, the predicted algebraic
codevector energy, ${\hat{E}}_{i}$, is decoded for the whole frame. Then
two indexes are retrieved from the bitstream and used to decode the
adaptive codebook gain and a correction factor. The decoded algebraic
codebook gain is further obtained using equation (1453).

##### 6.1.1.2.1.8 Reconstructed excitation {#reconstructed-excitation .H6}

The total excitation in each subframe is constructed by

$u^{'}\left( n \right) = {\hat{g}}_{p}\ v\left( n \right) + \ {\hat{g}}_{c}\ c\left( n \right),\ \text{for}\ n = 0,\ldots,\text{63}$
(1457)

where $c\left( n \right)$is the pre-filtered algebraic codevector.

In case that combined algebraic codebook is used, the total excitation
is each subframe is constructed by

$u^{'}\left( n \right) = {\hat{g}}_{p}\ v\left( n \right) + \ {\hat{g}}_{c}\ c\left( n \right) + \ {\hat{g}}_{q}\ q\left( n \right),\ \text{for}\ n = 0,\ldots,\text{63}$
(1458)

The excitation signal, $u^{'}\left( n \right)$, is used to update the
contents of the adaptive codebook for the next frame. The excitation
signal, $u^{'}\left( n \right)$, is then post processed as described in
subclause 7.1.2.4 to obtain the post-processed excitation signal
$u\left( n \right)$, which is finally used as an input to the synthesis
filter$1/\hat{A}\left( z \right)$.

##### 6.1.1.2.2 Reconstruction of the excitation in TC mode

In TC mode, the TC frame configuration (subclause 6.8.4.2.2) is decoded
first. Then, the adaptive excitation signal is either a zero vector, a
glottal-shape codevector or an adaptive codebook vector. In a subframe
where the glottal-shape codebook is used, the reconstruction of the
glottal-shape codevector is done using the received TC parameters as
described in subclause 6.8.4.2.1. In a subframe where the adaptive
codebook is used, the adaptive codevector is found as described in
subclause 7.1.2.1.1. In all subframes after the one where the
glottal-shape codebook is used, a low-pass filtering is applied and the
filtered adaptive excitation is found as
${v\left( n \right) = 0\text{.}\text{18\ \{}v}^{'}\left( n \right) + 0\text{.}\text{64\ \{}v{}^{'}\left( n - 1 \right) + 0\text{.}\text{18\ \{}v{}^{'}\left( n - 2 \right)$.

If a subframe contains a zero adaptive excitation vector, only the
algebraic codebook gain is decoded using a 2-bit or 3-bit scalar
quantizer (described in subclause 6.8.4.2.4). Otherwise, the adaptive
and algebraic codebook gains are decoded as in GC and VC modes
(described in subclause 7.1.2.1.3).

Finally, the reconstructed excitation is computed as described in
subclause 7.1.2.1.4.

##### 6.1.1.2.3 Reconstruction of the excitation in UC mode at low rates

##### 6.1.1.2.3.1 Decoding the innovative vector {#decoding-the-innovative-vector .H6}

In UC mode, the signs and indices of the two random vectors are decoded
and the excitation is reconstructed as in subclause 5.2.3.3.1. The
correction of the random codebook tilt is used as described in subclause
5.2.3.3.2.

##### 6.1.1.2.3.2 Decoding the random codebook gain {#decoding-the-random-codebook-gain .H6}

In UC mode, only the random codebook gain is transmitted. The received
index $k$ gives the gain in dB, ${\hat{g}}_{c}^{\text{dB}}$, using the
relations and quantization step defined in subclause 5.2.3.3.4. The
values$\Gamma_{\text{max}}$and$\delta$given in subclause 5.2.3.3.4. The
quantized gain, ${\hat{g}}_{c}$, is then given according to subclause
5.2.3.3.4.

##### 6.1.1.2.3.3 Enhancement of background noise {#enhancement-of-background-noise .H6}

The anti-swirling technique is applied in inactive periods, at 9.6 kb/s
for NB signals, and 9.6 kb/s and below for WB and SWB signal. This
technique is based on the decoded SAD and noisiness parameters.
Basically, the anti-swirling effect is achieved by means of LP parameter
smoothing in combination with reducing the power variations and spectral
fluctuations of the excitation signal during detected periods of signal
inactivity.

##### 6.1.1.2.3.3.1 LP parameter smoothing {#lp-parameter-smoothing .H6}

The LP parameter smoothing is done in two steps. First, a low-pass
filtered set of LSP parameters is calculated by first-order
autoregressive filtering according to

${\overline{q}}_{\text{end}}^{\left\lbrack 0 \right\rbrack} = \lambda\ {\overline{q}}_{\text{end}}^{\left\lbrack - 1 \right\rbrack} + \left( 1 - \lambda \right)\ {\hat{q}}_{\text{end}}^{\left\lbrack 0 \right\rbrack}$
(1459)

Here${\overline{q}}_{\text{end}}^{\left\lbrack 0 \right\rbrack}$represents
the low-pass filtered frame-end LSP parameter vector obtained for the
current frame, ${\hat{q}}_{\text{end}}^{\left\lbrack 0 \right\rbrack}$is
the decoded frame-end LSP parameter vector for the current frame, and
$\lambda = 0\text{.}9$is a weighting factor controlling the degree of
smoothing.

In a second step, a weighted combination between the low-pass filtered
LSP parameter vector,
${\overline{q}}_{\text{end}}^{\left\lbrack 0 \right\rbrack}$, and the
decoded LSP parameter vectors,
${\hat{q}}_{\text{end}}^{\left\lbrack - 1 \right\rbrack}$,
${\hat{q}}_{\text{end}}^{\left\lbrack 0 \right\rbrack}$and${\hat{q}}_{\text{mid}}^{\left\lbrack 0 \right\rbrack}$,
is calculated using a weighting factor $\beta$. That is

$\begin{matrix}
q_{\text{end}}^{} = \left( 1 - \beta \right)\ {\overline{q}}_{\text{end}}^{\left\lbrack - 1 \right\rbrack} + \beta\ {\hat{q}}_{\text{end}}^{\left\lbrack - 1 \right\rbrack} \\
q_{\text{mid}}^{} = \left( 1 - \beta \right)\ 0\text{.}5\ \left( {\overline{q}}_{\text{end}}^{\left\lbrack - 1 \right\rbrack} + {\overline{q}}_{\text{end}}^{\left\lbrack 0 \right\rbrack} \right) + \beta\ {\hat{q}}_{\text{mid}}^{\left\lbrack 0 \right\rbrack} \\
q_{\text{end}}^{} = \left( 1 - \beta \right)\ {\overline{q}}_{\text{end}}^{\left\lbrack 0 \right\rbrack} + \beta\ {\hat{q}}_{\text{end}}^{\left\lbrack 0 \right\rbrack} \\
\end{matrix}$ (1460)

As mentioned in subclause 7.1.1, LSP interpolation is performed to
obtain four LSP vectors, each for an individual subframe. This
interpolation is based on: the decoded frame-end LSP parameter vector of
the previous frame, the decoded mid-frame LSP parameter vector in the
current frame and the decoded frame-end LSP parameter vector of the
current frame. Subsequently, instead of using these parameters, their
smoothed versions, given in equation (1461) are employed.

It is noteworthy that the degree of smoothing is controlled by means of
the control factor$\beta$, which is described in subclause
6.1.1.2.3.3.3.

##### 6.1.1.2.3.3.2 Modification of the excitation signal {#modification-of-the-excitation-signal .H6}

One essential element of the anti-swirling technique is the reduction of
power and spectrum fluctuations of the signal during periods of signal
inactivity.

In the first step, tilt compensation of the excitation signal is
performed with a first-order tilt compensation filter given as

$H\left( z \right) = 1 - \kappa\ z^{- 1}$ (1462)

The coefficient$\kappa$is calculated as

$\kappa = \frac{r_{e}\left( 1 \right)}{r_{e}\left( 0 \right)}$ (1463)

where$r_{e}\left( 0 \right)$and $r_{e}\left( 1 \right)$are the zero-th
and the first autocorrelation coefficients of the original excitation
signal. The tilt compensation is carried out on a subframe basis.

In the second step, the spectral fluctuations of the excitation signal
are further reduced by replacing a part of it with a white noise signal.
To this end, first a properly scaled random sequence of unit variance is
generated. This signal is then scaled by means of a gain factor,
$\overset{\sim}{g}$, in such a way that its power equals the smoothed
power of the excitation signal. The gain factor, $\overset{\sim}{g}$, is
obtained by filtering the RMS value of the excitation signal, denoted as
$g_{\text{RMS}}$, on a frame-by-frame basis. That is

$\overset{\sim}{g} = 0\text{.}9\ \overset{\sim}{g} + 0\text{.}1\ g_{\text{RMS}}$
(1464)

The noise is scaled by multiplying all its samples by the gain
factor$\overset{\sim}{g}$. Then, with some weighting factor, $\alpha$,
the excitation signal, $e\left( n \right)$, is combined with the scaled
noise signal, denoted as $r\left( n \right)$. This is done according to
the following equation leading to the smoothed excitation
signal$\hat{e}\left( n \right)$:

$\hat{e}\left( n \right) = \frac{\alpha}{\sqrt{\alpha^{2} + \left( 1 - \alpha \right)^{2}}}e\left( n \right) + \left( 1 - \alpha \right)r\left( n \right),\ \text{for}\ n = 0,\ldots,\text{255}$
(1465)

It is noteworthy that the degree of excitation signal smoothing is
controlled by means of the control factor$\alpha$, which is described in
subclause 6.1.1.2.3.3.3.

##### 6.1.1.2.3.3.3 Controlling the background noise smoothing {#controlling-the-background-noise-smoothing .H6}

The anti-swirling method described in the clauses above is controlled by
means of the control parameters$\alpha$and$\beta$in response to the
received SAD and noisiness parameters.

First, the received and decoded noisiness parameter steers an
intermediate smoothing control parameter, $\gamma$, such that it is
ensured that the degree of smoothing is only increased gradually up to a
maximum degree that is indicated by the received parameter. Given the
received noisiness parameter, $\hat{\nu}$, an intermediate parameter,
$\gamma^{\left\lbrack 0 \right\rbrack}$, is set according to the
following relation:

$\gamma^{\left\lbrack 0 \right\rbrack} = \text{max}\left( \hat{\nu},\ \gamma^{\left\lbrack - 1 \right\rbrack} - \delta \right)$
(1466)

where$\gamma^{\left\lbrack - 1 \right\rbrack}$is the stored intermediate
control parameter from the previous frame and
$\delta = 0\text{.}\text{05}$is the step-size with which the smoothing
control parameters are steered towards$\hat{\nu}$as long as they are
greater than$\hat{\nu}$. In case the current frame is erased
($f_{\text{bfi}} = 1$), $\gamma^{\left\lbrack 0 \right\rbrack}$is set to
the intermediate control parameter of the previous frame,
$\gamma^{\left\lbrack - 1 \right\rbrack}$.

The SAD parameter activates the smoothing operation only when the
received SAD flag, $f_{\text{SAD}}$, indicates inactivity. However, in
order to decrease the risk that smoothing is enabled during active
signal periods, erroneously declared as inactive, the background noise
smoothing is only enabled after a hangover period of 5 frames. Further,
whenever the SAD declares a frame as active, the smoothing operation is
disabled. In order to avoid adding a new hangover period after spurious
SAD activation, no hangover is added if the detected activity period is
less or equal to 3 frames.

In addition to this SAD-driven activation, for quality reasons, it is
important to avoid the anti-swirling operation being turned on too
abruptly. To this end, after each hang-over period, a phase in period of
$K = 5$frames is applied, during which the smoothing operation is
gradually steered from inactivate to fully enabled. Accordingly, for the
n-th frame of the phase-in period, the smoothing control
parameters$\alpha$and$\beta$are calculated as follows:

$\alpha = \beta = 1 + \frac{\left( \gamma - 1 \right)n}{K}$ (1467)

For all other frames (during which the smoothing is activated)
$\alpha = \gamma$and$\beta = \gamma$.

It is noteworthy that phase-in periods are only inserted after hangover
periods, i.e., not after spurious SAD activations of less than 3 frames.

##### 6.1.1.2.4 Reconstruction of the excitation in IC/UC mode at 9.6 kbps

##### 6.1.1.2.4.1 Decoding of the innovative excitation {#decoding-of-the-innovative-excitation .H6}

In IC and UC modes at 9.6 kbps the decoding the algebraic codebood
ecitation is the same as described in n subclause 6.1.1.2.1.2.

At WB, an additional Gaussian noise excitation is generated as described
in subclause 5.2.3.4.2.

#####  6.1.1.2.4.2 Gains decoding {#gains-decoding .H6}

In NB, only the algebraic codeword gain${\hat{g}}_{c}$ is calculated as

${\hat{g}}_{c} = \text{10}^{({\hat{g}}_{c}^{\text{dB}} - E_{c})/\text{20}}$
(1468)

The algebraic codebook excitation energy in dB, $E_{c}$, is computed as
in equation (1469). The quantized gain in dB is given by

${\hat{g}}_{c}^{\text{dB}} = k \times 1\text{.}9 - \text{30}$ (1470)

The quantization index $k$(6 bits) is retrieved directly from the
bitstream (subclause 5.2.3.4.3.2)..

For WB the quantized algebraic codeword gain${\hat{g}}_{c}$and Gaussian
noise excitation gain ${\hat{g}}_{c2}$are decoded. They are calculated
respectively as

${\hat{g}}_{c} = \text{10}^{{\hat{g}}_{c}^{\text{dB}}/\text{20}}$ (1471)

${\hat{g}}_{c2} = (0\text{.}\text{25}k2 + 0\text{.}\text{25}) \cdot {\hat{g}}_{c} \cdot \frac{\sum_{n = 0}^{\text{63}}\sqrt{c^{2}(n)}}{\sum_{n = 0}^{\text{63}}\sqrt{c2^{2}(n)}}$
(1472)

The quantized gain in dB is given by

${\hat{g}}_{c}^{\text{dB}} = k \times 1\text{.}\text{25} - \text{20} - E_{c} + {\hat{E}}_{i}$
(1473)

The quantization index $k$(5 bits) and $k2$(2 bits) are retrieved from
the bitstream. The predicted algebraic codevector energy,
${\hat{E}}_{i}$, is decoded for the whole frame prior to calculating the
algebraic codebook gain in each subframe (subclause 5.2.3.4.3.2).

##### 6.1.1.2.4.4 Total excitation {#total-excitation .H6}

The total excitation in each subframe is constructed by

$u^{'}\left( n \right) = {\hat{g}}_{c}\ c\left( n \right) + \ {\hat{g}}_{c2}\ c2\left( n \right),\ \text{for}\ n = 0,\ldots,\text{63}$
(1474)

where $c\left( n \right)$ and $c2\left( n \right)$ are the pre-filtered
algebraic codevector and the pre-filtered Gaussian noise excitation
respectively.

Only the algebraic codevector ${\hat{g}}_{c}\ c\left( n \right)$ is used
to update the contents of the adaptive codebook for the next frame.

The excitation signal, $u^{'}\left( n \right)$, is then post processed
as described in subclause 6.1.1.3 to obtain the post-processed
excitation signal $u\left( n \right)$, which is finally used as an input
to the synthesis filter$1/\hat{A}\left( z \right)$.

##### 6.1.1.2.5 Reconstruction of the excitation in GSC

In GSC mode, the attack flag is first decoded (subclause 5.1.13.5.3).
Then, the number of subframe is decoded. To do so, if the bit rate is
13.2 kbit/s and the coding mode is INACTIVE, the first step is to decode
1 bit to verify if the coded frame is a SWB unvoiced frame which would
implies 4 subframes. Otherwise when the number of subframe is less than
4, the noise level $N_{\text{lev}}$ as defined in subclause 5.2.3.5.4 is
decoded. If the bitrate is 13.2 kbit/s, then a supplementary bit is
decoded to determine if the number of subframe is 1 or 2, for lower
bitrate the number of subframe is 1.

Then the cut off frequency (as defined in subclause 5.2.3.5.6) is
decoded and if it is different from 0, the time domain contribution is
decoded (subclause 5.2.3.5.2). When a time domain contribution exists,
it is converted in frequency domain and low pass filtered using the
decoded cut-off frequency as described in subclause 5.2.3.5.6, otherwise
the time domain contribution is set to 0.

Then the frequency domain component is decoded starting the gain of sub
bands as defined in subclause 5.2.3.5.7. The gain information is then
used to determine the bit allocation, the number of bands and the order
of the bands to be decoded by the PVQ as described in subclause
5.2.3.5.8. Then the PVQ is decoding the spectral difference and spectral
dynamic control and noise filling is applied on the decoded vector as
described in subclause 5.2.3.5.10. When the spectral difference vector
is complete, the gain is applied and it is combined, in the frequency
domain, with the temporal contribution as described in subclause
5.2.3.5.11. If the decoded frequency excitation meets the given
condition, predict the un-decoded frequency excitation by the decoded
frequency excitation as described in subclause 5.2.3.5.12. The complete
excitation in the frequency domain is revert back to time domain using
the inverse DCT as described in subclause 5.2.3.5.12 and then a pre-echo
removal is applied as in subclause 5.2.3.5.13 to get the total
excitation $u^{'}\left( n \right)$.

#### 6.1.1.3 Excitation post-processing

Before the synthesis, a post-processing of the excitation signal,
$u^{'}\left( n \right)$, is performed to form the updated excitation
signal, $u\left( n \right)$, as follows.

##### 6.1.1.3.1 Anti-sparseness processing

An adaptive anti-sparseness post-processing procedure is applied to the
pre-filtered algebraic codevector, $c\left( n \right)$. This is to
reduce the perceptual artefacts arising from the sparseness of algebraic
codebook vectors having only a few non-zero samples per subframe. The
anti-sparseness processing consists of circular convolution of the
algebraic codevector with an impulse response by means of an FFT. Three
pre-stored impulse responses are used and a selection number $i_{p} =$0,
1or 2 and is set to select one of them. A value of 2 or greater
corresponds to no modification; a value of 1 corresponds to medium
modification and a value of 0 corresponds to strong modification. The
selection of the impulse response is performed adaptively based on the
decoded adaptive codebook gain, ${\hat{g}}_{p}$, coding mode and bit
rate.

The following selection procedure is employed where
${\hat{g}}_{c}^{\left\lbrack - 1 \right\rbrack}$is the algebraic
codebook gain in the previous subframe,
${\hat{g}}_{p}^{\left\lbrack - k \right\rbrack}$are current and 5
previous subframes\' adaptive codebook gains and
$i_{p}^{\left\lbrack - 1 \right\rbrack}$ is the previous selection
number.

$\begin{matrix}
\text{initialize}\ i = 2 \\
\text{if}\ (!\text{UC} \land \text{bitrate} \leq \text{7200}) \vee (\text{UC} \land (\text{bitrate} \geq \text{9600} \land \text{bitrate} \leq \text{16400})) \\
\ i = 0 \\
\text{else}\ \text{if}\ !\text{VC} \land !\text{UC} \land \text{bitrate}\  \leq \text{9600}\ \text{then} \\
\ i = 1 \\
\text{if}\ {\hat{g}}_{p} < 0\text{.}6\ \text{then} \\
\ i_{p} = 0 \\
\text{else}\ \text{if}\ {\hat{g}}_{p} < 0\text{.}9\ \text{then} \\
\ i_{p} = 1 \\
\text{else} \\
\ i_{p} = 2 \\
\text{if}\ {\hat{g}}_{c} > 3{\hat{g}}_{c}^{\left\lbrack - 1 \right\rbrack}\ \text{then} \\
\ i_{p} = i_{p} + 1 \\
\text{else} \\
\ \text{initialize}\ j = 0 \\
\ \text{for}\ k = 0\text{.}5 \\
\ \text{if}\ {\hat{g}}_{p}^{\left\lbrack - k \right\rbrack} > 0\text{.}6\ \text{then} \\
\ j = j + 1 \\
\text{if}\ j > 2\ \text{then} \\
\ i_{p} = 0 \\
\text{if}\ i_{p} - i_{p}^{\left\lbrack - 1 \right\rbrack} > 1\ \text{then} \\
\ i_{p} = i_{p} - 1 \\
\text{update}\ i_{p}^{\left\lbrack - 1 \right\rbrack} = i_{p} \\
\text{compute}\ \text{the}\ \text{final}\ \text{selection}\ \text{number}\ \text{as}\ i_{p} = i_{p} + i \\
\end{matrix}$$$ (1475)

##### 6.1.1.3.2 Gain smoothing for noise enhancement

A nonlinear gain smoothing technique is applied to the algebraic
codebook gain, ${\hat{g}}_{c}$, in order to enhance the excitation in
noise. Based on the stability and voicing of the signal segment, the
gain of the algebraic codebook vector is smoothed in order to reduce
fluctuation in the energy of the excitation in case of stationary
signals. This improves the performance in case of stationary background
noise. The voicing factor $\lambda$is given by

$\lambda = 0\text{.}5\left( 1 - r_{\nu} \right)$ (1476)

with $r_{\nu}$giving a measure of signal periodicity

$r_{\nu} = \frac{\left( E_{\nu} - E_{C} \right)}{\left( E_{\nu} + E_{C} \right)}$
(1477)

where$E_{\nu}$and$E_{C}$ are the energies of the scaled pitch codevector
and scaled algebraic codevector, respectively. Note that since the value
of $r_{\nu}$ is between --1 and 1, the value of $\lambda$is between 0
and 1. Note that the factor $\lambda$is related to the amount of
\"unvoicing\" with a value of 0 for purely voiced segments and a value
of 1 for purely unvoiced segments.

A stability factor $\theta$is computed based on a distance measure
between the adjacent LP filters. Here, the factor $\theta$is related to
the LSF distance measure. The LSF distance is given by

$\text{LSF} = \sum_{i = 0}^{\text{14}}\left\lbrack f^{\left\lbrack 0 \right\rbrack}\left( i \right) - f^{\left\lbrack - 1 \right\rbrack}\left( i \right) \right\rbrack^{2}$
(1478)

where$f^{\left\lbrack 0 \right\rbrack}\left( i \right)$ in the present
frame, calculated in subclause 7.1.1,
and$f^{\left\lbrack - 1 \right\rbrack}\left( i \right)$are the LSFs in
the previous frame. The stability factor $\theta$is given by

$\theta = 1\text{.}\text{25} - \text{LSF}_{\text{dist}}/\text{400000},\ \text{constrained}\ \text{by}\ 0 \leq \theta \leq 1$
(1479)

The LSF distance measure is smaller in case of stable signals. As the
value of $\theta$is inversely related to the LSF distance measure, then
larger values of $\theta$correspond to more stable signals. The gain
smoothing factor,$S_{m}$, is given by

$S_{m} = \text{λθ}$ (1480)

The value of $S_{m}$ approaches 1 for unvoiced and stable signals, which
is the case of stationary background noise signals. For purely voiced
signals, or for unstable signals, the value of $S_{m}$approaches 0. An
initial modified gain, $g^{\left\lbrack 0 \right\rbrack}$, is computed
by comparing the algebraic codebook gain, ${\hat{g}}_{c}$, to a
threshold given by the initial modified gain from the previous subframe,
$g^{\left\lbrack - 1 \right\rbrack}$. If${\hat{g}}_{c}$is larger than or
equal to $g^{\left\lbrack - 1 \right\rbrack}$, then
$g^{\left\lbrack 0 \right\rbrack}$is computed by
decrementing${\hat{g}}_{c}$by 1.5 dB, constrained by
$g^{\left\lbrack 0 \right\rbrack} \geq g^{\left\lbrack - 1 \right\rbrack}$.
If${\hat{g}}_{c}$is smaller than $g^{\left\lbrack - 1 \right\rbrack}$,
then $g^{\left\lbrack 0 \right\rbrack}$is computed by
incrementing${\hat{g}}_{c}$by 1.5 dB, constrained by
$g^{\left\lbrack 0 \right\rbrack} \leq g^{\left\lbrack - 1 \right\rbrack}$.
Finally, the algebraic codebook gain is modified using the value of the
smoothed gain as follows

${\hat{g}}_{c} = S_{m}g^{\left\lbrack 0 \right\rbrack} + \left( 1 - S_{m} \right){\hat{g}}_{c}$
(1481)

##### 6.1.1.3.3 Pitch enhancer

A pitch enhancer scheme modifies the total
excitation$u^{'}\left( n \right)$ of voiced signals by filtering the
algebraic codebook excitation through an innovation filter. The filter
frequency response emphasizes the higher frequencies and reduces the
energy of the low-frequency portion of the innovative codevector. The
filter coefficients are related to the periodicity of the signal.
Therefore, the pitch enhancer is not applied to excitation in UC at low
bit rates, i.e. birates \< 9600 kb/s.

A filter of the form

$F_{\text{inno}}\left( z \right) = - c_{\text{pe}}z + 1 - c_{\text{pe}}z^{- 1}$
(1482)

is used where
$c_{\text{pe}} = 0\text{.}\text{125}\left( 1 - r_{\nu} \right)$ if
$\text{sr}_{\text{celp}} = \text{12800}$Hz and
$c_{\text{pe}} = 0\text{.}\text{15}\left( 1 - r_{\nu} \right)$ if
$\text{sr}_{\text{celp}} = \text{16000}$Hz, with $r_{\nu}$being a
periodicity factor given in equation (1483). The filtered algebraic
codebook vector in the current subframe is given by

$c^{'}\left( n \right) = c\left( n \right) - c_{\text{pe}}\left\lbrack c\left( n + 1 \right) + c\left( n - 1 \right) \right\rbrack\ \text{for}\ n = 0,\ldots,\text{63}$
(1484)

where the out-of-subframe samples $c\left( - 1 \right)$and
$c\left( \text{64} \right)$are set to zero. The updated post-processed
excitation is given by

$u\left( n \right) = {\hat{g}}_{p}v\left( n \right) + {\hat{g}}_{c}c^{'}\left( n \right)$
(1485)

The above procedure can be done in one step by updating the excitation
as follows

$u\left( n \right) = u^{'}\left( n \right) - {\hat{g}}_{c}c_{\text{pe}}\left( c\left( n + 1 \right) + c\left( n - 1 \right) \right)$
(1486)

where${\hat{g}}_{c}$is the modified algebraic codebook gain from
equation (1487).

##### 6.1.1.3.4 Music post processing

In case of a sound signals coded with the GSC, a music enhancer scheme
modifies the total excitation$u\left( n \right)$ corresponding to the
sound signal in such a way that the quantization noise inserted between
spectral tones during the encoding/decoding process can be reduced. The
music enhancer consists of converting the decoded excitation into
frequency domain, computing a weighting mask for retrieving spectral
information lost in the quantization noise, and modifying the frequency
domain excitation by applying the weighting mask to increase the
spectral dynamics, and converting the modified frequency domain
excitation back to time domain.

The current frequency domain post processing achieves higher frequency
resolution, without adding delay to the synthesis. A weighting mask is
created based on the past spectrum energy and used to improve the
efficiency of the inter-tone noise removal. To achieve this post
processing without adding delay to the codec, a symmetric trapezoidal
window is used. It is centred on the current frame where the window is
flat, and extrapolation is used to create the future signal. The
advantage of working on the excitation signal rather than on the
synthesis signal is that any potential discontinuities introduced by the
post processing are smoothed out by the subsequent application of the LP
synthesis filter. The following text describes the implementation of the
music post processing.

##### 6.1.1.3.4.1 Excitation buffering and extrapolation {#excitation-buffering-and-extrapolation .H6}

To increase the frequency resolution, a frequency transform longer than
the frame length is used. To do so, a concatenated excitation vector
$u_{c}\left( n \right)$ is created by concatenating the last 192 samples
of the previous frame excitation*,* the decoded excitation of the
current frame $u\left( n \right)$, and an extrapolation of 192
excitation samples of the future frame $u_{x}\left( n \right)$*.* This
is described below where $L_{w}$is the length of the past excitation as
well as the length of the extrapolated excitation, and $L$ is the frame
length. These correspond to 192 and 256 samples respectively, giving the
total length $L_{c} = \text{640}$ samples:

$u_{c}\left( n \right) = \begin{matrix}
\left\{ u\left( n \right)n = - L_{w},\text{.}\text{.}\text{.} - 1 \middle| \right.\ \left\{ u\left( n \right)n = 0,\text{.}\text{.}\text{.},L - 1 \middle| \right.\  \\
\end{matrix}$ (1488)

The extrapolation of the future excitation samples
$u_{x}\left( n \right)$ is computed by periodically extending the
current frame excitation signal $u\left( n \right)$ using the decoded
factional pitch of the last subframe of the current frame. Given the
fractional resolution of the pitch lag, an upsampling of the current
frame excitation is performed using a 35 samples long Hamming windowed
sinc function.

##### 6.1.1.3.4.2 Windowing and frequency transform {#windowing-and-frequency-transform .H6}

Prior to the time-to-frequency transform a windowing is performed on the
concatenated excitation. The selected window $u\left( \text{wn} \right)$
has a flat top corresponding to the current frame, and it decreases with
the Hanning function to 0 at each end. The following equation represents
the window used:

$w\left( n \right) = \begin{matrix}
\left\{ 0\text{.}5\left( 1 - \text{cos}\left( \frac{2\pi\left( n + L_{w} \right)}{2L_{w} - 1} \right) \right)n = - L_{w},\text{.}\text{.}\text{.} - 1 \middle| \right.\ \left\{ 1\text{.}0n = 0,\text{.}\text{.}\text{.},L - 1 \middle| \right.\  \\
\end{matrix}$ (1489)

When applied to the concatenated excitation, an input to the frequency
transform having a total length $L_{c} = \text{640}$ samples
($L_{c} = 2L_{w} + L$) is obtained in the prototype. The windowed
concatenated excitation $u_{\text{wc}}\left( n \right)$ is centered on
the current frame and is represented with the following equation:

$u_{\text{wc}}\left( n \right) = \begin{matrix}
\left\{ u\left( n \right)w\left( n \right)n = - L_{w},\text{.}\text{.}\text{.} - 1 \middle| \right.\ \left\{ u\left( n \right)w\left( n \right)n = 0,\text{.}\text{.}\text{.},L - 1 \middle| \right.\  \\
\end{matrix}$ (1490)

During the frequency-domain post processing phase, the concatenated
excitation is represented in a transform-domain using a type II DCT
giving a resolution of 10Hz. The frequency representation of the
concatenated and windowed time-domain CELP excitation *f~u~* is given
below:

$f_{u}\left( k \right) = \left\{ \begin{matrix}
\sqrt{\frac{1}{L_{c}}} \cdot \sum_{n = 0}^{L_{c} - 1}{u_{\text{wc}}\left( n \right),k = 0} \\
\sqrt{\frac{2}{L_{c}}}\sum_{n = 0}^{L_{c} - 1}{u_{\text{wc}}\left( n \right)}\text{cos}\left( \frac{\pi}{L_{c}}\left( n + \frac{1}{2} \right)k \right),1 \leq k \leq L_{c} - 1 \\
\end{matrix} \right.\ $ (1491)

where $u_{\text{wc}}\left( n \right)$, is the concatenated and windowed
time-domain excitation and $L_{c}$ is the length of the frequency
transform. The frame length $L$ is 256 samples, but the length of the
frequency transform $L_{c}$ is 640 samples for a corresponding inner
sampling frequency of 12.8 kHz.

##### 6.1.1.3.4.3 Energy per band and per bin analysis {#energy-per-band-and-per-bin-analysis .H6}

After the DCT, the resulting spectrum is divided into critical frequency
bands. The critical frequency bands used in the prototype are as close
as possible to what is specified in \[17\], and their upper limits are
defined as follows:

$\begin{matrix}
C_{B}\text{\ =\ }\left\{ \text{100,\ 200,\ 300,\ 400,\ 510,\ 630,\ 770,\ 920,\ 1080,\ 1270,\ 1480,\ }\ldots \middle| \middle| \middle| \middle| \ \text{1720,\ 2000,\ 2320,\ 2700,\ 3150,\ 3700,\ 4400,\ 5300,\ 6400} \right\}\text{\ Hz} \\
\end{matrix}$ (1492)

$$The 640-point DCT results in a frequency resolution of 10 Hz
(6400Hz/640pts). The number of frequency bins per critical frequency
band is

$M_{B}\text{\ =\ }\left\{ \text{10,\ 10,\ 10,\ 10,\ 11,\ 12,\ 14,\ 15,\ 16,\ 19,\ 21,\ 24,\ 28,\ 32,\ 38,\ 45,\ 55,\ 70,\ 90,\ 110} \right\}$
(1493)

The average spectral energy per critical frequency band $E_{B}(i)$ is
computed as follows:

$E_{B}\left( i \right) = \frac{1}{L_{c}M_{\text{CB}}\left( i \right)}\sum_{h = 0}^{M_{B}\left( i \right) - 1}{\left( f_{u}\left( h + j_{i} \right)^{2} \right),i = 0,\text{.}\text{.}\text{.},\text{20}}$
(1494)

where$f_{e}\left( h \right)$ represents the *h*^th^ frequency bin of a
critical band and $j_{i}$ is the index of the first bin in the
*[i]{.underline}*^th^ critical band given by

$j_{i} = \left\{ \text{0,\ 10,\ 20,\ 30,\ 40,\ 51,\ 63,\ 77,\ 92,\ 108,\ 127,\ 148,\ 172,\ 200,\ 232,\ 270,\ 315,\ 370,\ 440,\ 530} \right\}$
(1495)

The spectral analysis also computes the energy of the spectrum per
frequency bin, $E_{\text{BIN}}(k)$ using the following relation:

$E_{\text{BIN}}\left( k \right) = \frac{1}{L_{c}}f_{u}\left( k \right)^{2},k = 0,\text{.}\text{.}\text{.},\text{639}$
(1496)

Finally, the spectral analysis computes a total spectral energy $E_{C}$
of the concatenated excitation as the sum of the spectral energies of
the first 17 critical frequency bands using the following relation:

$E_{C} = \text{10}\text{log}_{\text{10}}\left( \sum_{}^{}{E_{B}\left( i \right)} \right) - 3\text{.}\text{0103}$
(1497)

##### 6.1.1.3.4.4 Excitation type classification {#excitation-type-classification .H6}

The method for enhancing decoded generic sound signal includes an
additional analysis of the excitation signal designed to maximize the
efficiency of the inter-harmonic noise reducer by identifying which
frame is well suited for the inter-tone noise reduction.

This classifier not only separates the decoded concatenated excitation
into sound signal categories, but it also gives instructions to the
inter-harmonic noise reducer regarding the maximum level of attenuation
and the minimum frequency where the reduction can starts.

The first operation consists in performing an energy stability analysis
based on the total spectral energy of the concatenated
excitation$E_{C}$:

${\overline{E}}_{{}_{d}} = \frac{\left( \sum_{t = - \text{40}}^{t = - 1}\Delta_{E_{C}}^{t} \right)}{\text{40}},\text{where}\ \Delta_{E_{C}}^{t} = E_{C}^{t} - E_{C}^{\left( t - 1 \right)}$
(1498)

where ${\overline{E}}_{d}$represents the average difference of the
energies of the concatenated excitation vectors of two adjacent frames,
$E_{C}^{t}$ represents the energy of the concatenated excitation of the
current frame $t$*,* and $E_{C}^{\left( t - 1 \right)}$ represents the
energy of the concatenated excitation of the previous frame $t - 1$. The
average is computed over the last 40 frames.

Then, a statistical deviation $\sigma_{C}$ of the energy variation over
the last fifteen (15) frames is calculated using the following relation:

$\sigma_{C} = p \cdot \sqrt{\sum_{t = - \text{15}}^{t = - 1}\frac{\left( \Delta_{E_{C}}^{t} - {\overline{E}}_{{}_{d}} \right)^{2}}{\text{15}}}$
(1499)

where, in the prototype, the scaling factor $p$ is found experimentally
and set to about 0.77. The resulting deviation $\sigma_{C}$ is compared
to four (4) floating thresholds to determine to what extend the noise
between harmonics can be reduced. The output of this second stage
classifier is split into five (5) sound signal categories
$e_{\text{CAT}}$, named sound signal categories 0 to 4. Each sound
signal category has its own inter-tone noise reduction tuning.

The five (5) sound signal categories 0-4 can be determined as indicated
in the following table.

Table 156: Output characteristic of the excitation classifier

  ------------------- -------------------- ------------------------
  Category (e~CAT~)   Enhanced band (Hz)   Allowed reduction (dB)
  0                   NA                   0
  1                   \[510, 6400\]        6
  2                   \[510, 6400\]        9
  3                   \[400, 6400\]        12
  4                   \[300, 6400\]        12
  ------------------- -------------------- ------------------------

The sound signal category 0 is a non-tonal, non-stable sound signal
category which is not modified by the inter-tone noise reduction
technique. This category of the decoded sound signal has the largest
statistical deviation of the spectral energy variation and in general
comprises speech signal.

Sound signal category 1 (largest statistical deviation of the spectral
energy variation after category 0) is detected when the statistical
deviation of spectral energy variation history is lower than Threshold 1
and the last detected sound signal category is ≥ 0. Then the maximum
reduction of quantization noise of the decoded tonal excitation within
the frequency band 510 to $F_{S}/2$ Hz is limited to a maximum noise
reduction $R_{\text{max}}$ of 6 dB.

Sound signal category 2 is detected when the statistical deviation of
spectral energy variation is lower than Threshold 2 and the last
detected sound signal category is ≥ 1. Then the maximum reduction of
quantization noise of the decoded tonal excitation within the frequency
band 510 to $F_{S}/2$ Hz is limited to a maximum of 9 dB.

Sound signal category 3 is detected when the statistical deviation of
spectral energy variation is lower than Threshold 3 and the last
detected sound signal category is ≥ 2. Then the maximum reduction of
quantization noise of the decoded tonal excitation within the frequency
band 4000 to $F_{S}/2$ Hz is limited to a maximum of 12 dB.

Sound signal category 4 is detected when the statistical deviation of
spectral energy variation is lower than Threshold 4 and when the last
detected signal type category is ≥ 3. Then the maximum reduction of
quantization noise of the decoded tonal excitation within the frequency
band 300 to $F_{S}/2$ Hz is limited to a maximum of 12 dB.

The floating thresholds 1-4 help preventing wrong signal type
classification. Typically, decoded tonal sound signal representing music
gets much lower statistical deviation of its spectral energy variation
than speech. However, even music signal can contain higher statistical
deviation segment, and similarly speech signal can contain segments with
lower statistical deviation. It is nevertheless unlikely that speech and
music contents change regularly from one to another on a frame basis.
The floating thresholds add decision hysteresis and act as reinforcement
of previous state to substantially prevent any misclassification that
could result in a suboptimal performance of the inter-harmonic noise
reducer.

Counters of consecutive frames of sound signal category 0, and counters
of consecutive frames of sound signal category 3 or 4, are used to
respectively decrease or increase the thresholds.

For example, if a counter counts a series of more than 30 frames of
sound signal category 3 or 4, all the floating thresholds (1 to 4) are
increased by a predefined value for the purpose of allowing more frames
to be considered as sound signal category 4.

The inverse is also true with sound signal category 0. For example, if a
series of more than 30 frames of sound signal category 0 is counted, all
the floating thresholds (1 to 4) are decreased for the purpose of
allowing more frames to be considered as sound signal category 0. All
the floating thresholds 1-4 are limited to absolute maximum and minimum
values to ensure that the signal classifier is not locked to a fixed
category.

In the case of frame erasure, all the thresholds 1-4 are reset to their
minimum values and the output of the signal classifier is considered as
non-tonal (sound signal category 0) for three (3) consecutive frames
(including the lost frame).

If information from a Voice Activity Detector (VAD) is available and it
is indicating no voice activity (presence of silence), or if the last
frame didn't contain generic audio the decision of the signal type
classifier is forced to sound signal category 0 ($e_{\text{CAT}} = 0$).

##### 6.1.1.3.4.5 Inter-tone noise reduction in the excitation domain {#inter-tone-noise-reduction-in-the-excitation-domain .H6}

Inter-tone noise reduction is performed on the frequency representation
of the concatenated excitation as a first operation of the enhancement.
The reduction of the inter-tone quantization noise is performed by
scaling the spectrum in each critical band with a scaling gain $g_{s}$
limited between a minimum and a maximum gain $g_{\text{min}}$ and
$g_{\text{max}}$. The scaling gain is derived from an estimated
signal-to-noise ratio (SNR) in that critical band. The processing is
performed on frequency bin basis and not on critical band basis. Thus,
the scaling gain is applied on all frequency bins, and it is derived
from the SNR computed using the bin energy divided by an estimation of
the noise energy of the critical band including that bin. This feature
allows for preserving the energy at frequencies near harmonics or tones,
thus substantially preventing distortion, while strongly reducing the
noise between the harmonics. The inter-tone noise reduction is performed
in a per bin manner over all 640 bins.

The minimum scaling gain $g_{\text{min}}$ is derived from the maximum
allowed inter-tone noise reduction in dB, $R_{\text{max}}$. As described
above, the second stage of classification makes the maximum allowed
reduction varying between 6 and 12 dB. Thus minimum scaling gain is
given by

$g_{\text{min}} = \text{10}^{\frac{- R_{\text{max}}}{\text{20}}}$ (1500)

The scaling gain is computed related to the SNR per bin. Then per bin
noise reduction is performed on the entire spectrum to the maximum
frequency of 6400 Hz. The noise reduction can start at the 2^th^
critical band (i.e. no reduction is performed below 300Hz). The
excitation type classifier module can push the starting critical band up
to the 4^th^ band (510 Hz), to reduce any potential degradation. This
means that the first critical band on which the noise reduction is
performed is between 300Hz and 920 Hz, and it can vary on a frame basis.
In a more conservative implementation, the minimum band where the noise
reduction starts can be set higher.

The scaling for a certain frequency bin $k$ is computed as a function of
$\text{SNR}$, given by

$g_{s}(k) = \sqrt{k_{s}\text{\ SNR}\left( k \right) + c_{s}}$, bounded
by $g_{\text{min}} \leq g_{s} \leq g_{\text{max}}$ (1501)

Usually $g_{\text{max}}$ is equal to 1 (i.e. no amplification is
allowed), then the values of $k_{s}$ and $c_{s}$ are determined such as
$g_{s} = g_{\text{min}}$ for $\text{SNR} = 1$dB, and $g_{s} = 1$ for
$\text{SNR} = \text{45}$dB. That is, for SNRs of 1 dB and lower, the
scaling is limited to $g_{\text{min}}$ and for SNRs of 45 dB and higher,
no noise reduction is performed ($g_{s} = 1$). Thus, given these two end
points, the values of $k_{s}$ and $c_{s}$ in equation are given by

$k_{s} = (1 - g_{\text{min}}^{2}\frac{)}{\text{44}}$ and
$c_{s} = (\text{45}g_{\text{min}}^{2} - 1\frac{)}{\text{44}}$ (1502)

If $g_{\text{max}}$ is set to a value higher than 1, then it allows the
process to slightly amplify the tones having the highest energy. This
can be used to compensate for the fact that the CELP codec, used in the
prototype, doesn't match perfectly the energy in the frequency domain.
This is generally the case for signals different from voiced speech.

The SNR per bin in a certain critical band $i$ is computed as

$\text{NRF}_{\text{BIN}}(h) = \frac{0\text{.}3E_{\text{BIN}}^{(1)}(h) + 0\text{.}7E_{\text{BIN}}^{(2)}(h)}{N_{B}(i)},\text{\ \ \ \ \ \ \ \ \ \ \ }h = j_{i},\text{.}\text{.}\text{.},j_{i} + M_{B}(i) - 1$
(1503)

where $E_{\text{BIN}}^{(1)}(h)$ and $E_{\text{BIN}}^{(2)}(h)$ denote the
energy per frequency bin for the past and the current frame spectral
analysis, respectively, as computed in subclause 5.1.5.2,$N_{B}(i)$
denotes the noise energy estimate of the critical band $i$, $j_{i}$ is
the index of the first bin in the *i*^th^ critical band, and $M_{B}(i)$
is the number of bins in the critical band $i$ as defined above.

The smoothing factor is adaptive and it is made inversely related to the
gain itself. The smoothing factor is given by
$\alpha_{\text{gs}} = 1 - g_{s}$. That is, the smoothing is stronger for
smaller gains $g_{s}$. This approach substantially prevents distortion
in high SNR segments preceded by low SNR frames, as it is the case for
voiced onsets. The smoothing procedure is able to quickly adapt and to
use lower scaling gains on onsets.

In case of per bin processing in a critical band with index $i$, after
determining the scaling gain and using $\text{SNR}$ the actual scaling
is performed using a smoothed scaling gain $g_{\text{BIN},\text{LP}}$,
updated in every frequency analysis as follows

$g_{\text{BIN},\text{LP}}(k) = \alpha_{\text{gs}}g_{\text{BIN},\text{LP}}(k) + (1 - \alpha_{\text{gs}})g_{s}$
(1504)

Temporal smoothing of the gains substantially prevents audible energy
oscillations while controlling the smoothing using $\alpha_{\text{gs}}$
substantially prevents distortion in high SNR segments preceded by low
SNR frames, as it is the case for voiced onsets or attacks.

The scaling in the critical band $i$ is performed as

$f_{u}^{'}(h + j_{i}) = g_{\text{BIN},\text{LP}}(h + j_{i})f_{u}(h + j_{i}),\text{\ \ \ \ \ \ \ \ \ \ \ \ }h = 0,\text{.}\text{.}\text{.},M_{B}(i) - 1$
(1505)

where $j_{i}$ is the index of the first bin in the critical band $i$ and
$M_{B}(i)$ is the number of bins in that critical band.

The smoothed scaling gains $g_{\text{BIN},\text{LP}}(k)$ are initially
set to 1. Each time a non-tonal sound frame is processed
$e_{\text{CAT}} = 0$, the smoothed gain values are reset to 1 to reduce
any possible reduction in the next frame.

Note that in every spectral analysis, the smoothed scaling gains
$g_{\text{BIN},\text{LP}}(k)$ are updated for all frequency bins in the
entire spectrum. Note that in case of low-energy signal, inter-tone
noise reduction is limited to -1.25 dB. This happens when the maximum
noise energy in all critical bands,
$\text{max}(N_{B}(i)),\text{\ \ }i = 0,\text{.}\text{.}\text{.},\text{20},$
is less or equal to 10.

##### 6.1.1.3.4.6 Inter-tone quantization noise estimation {#inter-tone-quantization-noise-estimation .H6}

The inter-tone quantization noise energy per critical frequency band is
estimated as being the average energy of that critical frequency band
excluding the maximum bin energy of the same band. The following formula
summarizes the estimation of the quantization noise energy for a
specific band $i$:

$N_{B}\left( i \right) = \frac{1}{q\left( i \right)}\left( \frac{\left( E_{B}\left( i \right)M_{B}\left( i \right) - \underset{h}{\text{max}}\left( E_{\text{BIN}}\left( h + j_{i} \right) \right) \right)}{\left( M_{B}\left( i \right) - 1 \right)} \right),\ h = 0,\text{.}\text{.}\text{.},M_{B}(i) - 1$
(1506)

where$j_{i}$ is the index of the first bin in the critical band $i$,
$M_{B}(i)$ is the number of bins in that critical band*,* $E_{B}(i)$ is
the average energy of a band $i$,
$E_{\text{BIN}}\left( h + j_{i} \right)$ is the energy of a particular
bin and $N_{B}(i)$*N~B~(i)* is the resulting estimated noise energy of a
particular band $i$. The variable$q(i)$ represents a noise scaling
factor per band that is found experimentally and is set such that more
noise can be removed in low frequencies and less noise in high
frequencies as it is shown below:

$q = \left\{ \text{10,10,10,10,10,10,11,11,11,11,11,11,11,11,11,15,15,15,15,15} \right\}$
(1507)

##### 6.1.1.3.4.7 Increasing spectral dynamic of the excitation {#increasing-spectral-dynamic-of-the-excitation .H6}

The second operation of the frequency post processing provides an
ability to retrieve frequency information that is lost within the coding
noise. The CELP codecs, especially when used at low bitrates, are not
very efficient to properly code frequency content above 3.5-4 kHz. The
following steps take advantage of the fact that music spectrum does not
often changed substantially from frame to frame. Therefore a long term
averaging can be done and some of the coding noise can be eliminated.
The following operations are performed to define a frequency-dependent
gain function. This function is then used to further enhance the
excitation before converting it back to the time domain.

##### 6.1.1.3.4.8 Per bin normalization of the spectrum energy {#per-bin-normalization-of-the-spectrum-energy .H6}

The first operation consists in creating a weighting mask based on the
normalized energy of the spectrum of the concatenated excitation. The
normalization is done such that the tones have a value above 1.0 and the
valleys a value under 1.0. To do so, the energy spectrum
$E_{\text{BIN}}(k)$ is normalized between 0.925 and 1.925 to get the
normalized energy spectrum $E_{n}(k)$ using the following equation:

$E_{n}\left( k \right) = \frac{E_{\text{BIN}}\left( k \right)}{\text{max}\left( E_{\text{BIN}} \right)} + 0\text{.}\text{925},k = 0,\text{.}\text{.}\text{.},\text{639}$
(1508)

where $E_{\text{BIN}}(k)$ represents the bin energy as calculated in
subclause 5.1.5.2. Since the normalization is performed in the energy
domain, many bins have very low values. The offset 0.925 has been chosen
such that only a small part of the normalized energy bins would have a
value below 1.0. Once the normalization is done, the resulting
normalized energy spectrum is passed through a power function of 8 to
obtain a scaled energy spectrum as shown in the following formula:

$E_{p}\left( k \right) = E_{n}\left( k \right)^{8}k = 0,\text{.}\text{.}\text{.},\text{639}$
(1509)

where $E_{n}\left( k \right)$ is the normalized energy spectrum and
$E_{p}\left( k \right)$is the scaled energy spectrum. A maximum limit of
the scaled energy spectrum is fixed to 5, creating a ratio of
approximately 10 between the maximum and minimum normalized energy
values. The following equation shows how the function is applied:

$E_{\text{pl}}\left( k \right) = \text{min}\left( 5,E_{p}\left( k \right) \right)k = 0,\text{.}\text{.}\text{.},\text{639}$
(1510)

Where $E_{\text{pl}}\left( k \right)$ represents limited scaled energy
spectrum and $E_{p}\left( k \right)$ is the scaled energy spectrum.

##### 6.1.1.3.4.9 Smoothing of the scaled energy spectrum along the frequency axis and the time axis {#smoothing-of-the-scaled-energy-spectrum-along-the-frequency-axis-and-the-time-axis .H6}

With the last two operations, the position of the most energetic pulses
begins to take shape. Applying power of 8 on the bins of the normalized
energy spectrum is a first operation to create the mask that increases
the spectral dynamics. The next 2 operations enhance this spectrum mask.
First the scaled energy spectrum is smoothed along the frequency axis
from low frequency to the high frequency with an averaging filter. Then,
the resulting mask is processed along the time domain axis to smooth the
bin values from frame to frame.

The smoothing of the scaled energy spectrum along the frequency axis can
be described with following function:

${\overline{E}}_{\text{pl}}\left( k \right) = \begin{matrix}
\left\{ \frac{E_{\text{pl}}\left( k \right) + E_{\text{pl}}\left( k + 1 \right)}{2},k = 0 \middle| \right.\ \left\{ \frac{E_{\text{pl}}\left( k - 1 \right) + E_{\text{pl}}\left( k \right) + E_{\text{pl}}\left( k + 1 \right)}{3},\ k = 1,\text{.}\text{.}\text{.},\text{638} \middle| \right.\  \\
\end{matrix}$ (1511)

Finally, the smoothing along time axis results in a time-averaged
amplification/attenuation weighting mask $G_{m}$ to be applied to the
spectrum $f_{u}^{'}$. The weighting mask, also called gain mask, is
described with the following equation:

$G_{m}^{t}\left( k \right) = \begin{matrix}
\left\{ 0\text{.}\text{95} \cdot G_{m}^{\left( t - 1 \right)}\left( k \right) + 0\text{.}\text{05}{\overline{E}}_{\text{pl}}\left( k \right),k = 0,\text{.}\text{.}\text{.},\text{319} \middle| \right.\  \\
\end{matrix}$ (1512)

where ${\overline{E}}_{\text{pl}}$ is the scaled energy spectrum
smoothed along the frequency axis, $t$ is the frame index, and $G_{m}$
is the time-averaged weighting mask.

A slower adaptation rate has been chosen for the lower frequencies to
substantially prevent gain oscillation. A faster adaptation rate is
allowed for higher frequencies since the positions of the tones are more
likely to change rapidly in the higher part of the spectrum. With the
averaging performed on the frequency axis and the long term smoothing
performed along the time axis, the final vector
$G_{m}^{t}\left( k \right)$ is used as a weighting mask to be applied
directly on the enhanced spectrum $f_{u}^{'}$of the concatenated
excitation.

##### 6.1.1.3.4.10 Application of the weighting mask to the enhanced concatenated excitation spectrum {#application-of-the-weighting-mask-to-the-enhanced-concatenated-excitation-spectrum .H6}

The weighting mask defined above is applied differently depending on the
output of the excitation type classifier (value of $e_{\text{CAT}}$).
The weighting mask is not applied if the excitation is classified as
category 0 ($e_{\text{CAT}} = 0$; i.e. high probability of speech
content).

For the first 1 kHz, the mask is applied if the excitation is not
classified as category 0 ($e_{\text{CAT}} \neq 0$). Attenuation is
possible but no amplification is performed in this frequency range
(maximum value of the mask is limited to 1).

If more than 25 consecutive frames are classified as category 4
($e_{\text{CAT}} = 0$; i.e. high probability of music content), but not
more than 40 frames, then the weighting mask is applied without
amplification for all the remaining bins (the maximum gain
$G_{\text{max}0}$ is limited to 1, and there is no limitation on the
minimum gain).

When more than 40 frames are classified as category 4, for the
frequencies between 1 and 2 kHz the maximum gain $G_{\text{max}1}$ is
set to 1.5 for bitrates below 12650 bits per second (b/s). Otherwise the
maximum gain $G_{\text{max}1}$ is set to 1. In this frequency band, the
prototype fixes the minimum gain $G_{\text{min}1}$ to 0.75 only if the
bitrate is higher than 15850 b/s, otherwise there is no limitation on
the minimum gain.

For the band 2 to 4 kHz, the maximum gain $G_{\text{max}2}$ is limited
to 2 for bitrates below 12650 b/s, and it is limited to 1.25 for the
bitrates equal to or higher than 12650 b/s and lower than 15850 b/s.
Otherwise, then maximum gain $G_{\text{max}2}$ is limited to 1. Still in
this frequency band, the minimum gain $G_{\text{min}2}$ is 0.5 only if
the bitrate is higher than 15850 b/s, otherwise there is no limitation
on the minimum gain.

For the band 4 to 6.4 kHz, the maximum gain $G_{\text{max}3}$ is limited
to 2 for bitrates below 15850 b/s and to 1.25 otherwise. In this
frequency band, the prototype fixes the minimum gain $G_{\text{min}3}$
to 0.5 only if the bitrate is higher than 15850 b/s, otherwise there is
no limitation on the minimum gain.

##### 6.1.1.3.4.11 Inverse frequency transform and overwriting of the current excitation {#inverse-frequency-transform-and-overwriting-of-the-current-excitation .H6}

After the frequency domain enhancement is completed, an inverse
frequency-to-time transform is performed in order to get the enhanced
temporal excitation back. The frequency-to-time conversion is achieved
with the same type II DCT as used for the time-to-frequency conversion.
The modified time-domain excitation $u_{\text{td}}^{'}\left( n \right)$
is obtained as

$u_{\text{td}}^{'}\left( n \right) = \left\{ \begin{matrix}
\sqrt{\frac{1}{L_{c}}} \cdot \sum_{k = 0}^{L_{c} - 1}f_{u}^{\text{\}\ \}\ \ left\ (k\ right\ ),n=0\}\ \ \{\}\ \#\#
\ sqrt\ \{\ \{\ \ \{2\}\ \ over\ \ \{L\ rSub\ \{c\}\ \}\ \}\ \}\ \ size\ 12\{\ cdot\ \ Sum\ cSub\ \{k=0\}\ \ cSup\ \{L\ rSub\ \{\ size\ 6\{c\}\ \}\ \ -\ 1\}\ \ \{f\ rSub\ \{u\}\ \ rSup\ \{}\left( k \right)}\text{cos}\left( \frac{\pi}{L_{c}}\left( k + \frac{1}{2} \right)n \right),1 \leq n \leq L_{c} - 1 \\
\end{matrix} \right.\ $ (1513)

where$f^{\text{\}\ \ \ rSub\ \{\ size\ 8\{u\}\ \}\ \}\ \}\ \{}}$ is the
frequency representation of the modified excitation,
$u_{\text{td}}^{'}\left( n \right)$ is the enhanced concatenated
excitation, and $L_{c}$ is the length of the concatenated excitation
vector.

To avoid adding delay to the synthesis, it has been decided to avoid
overlap-and-add algorithm in the LP domain path. Thus, the exact length
of the final excitation $u_{f}$ is used to generate the synthesis
directly from the enhanced concatenated excitation, without overlap as
shown in the equation below:

$u_{f}\left( n \right) = u_{\text{td}}^{'}\left( n + L_{w} \right),n = 0,\text{.}\text{.}\text{.},\text{255}$
(1514)

Here $L_{w}$ represents the length of the section of the window that was
applied on the past segment of the excitation, prior to the frequency
transformation.

### 6.1.2 Source Controlled VBR decoding

### 6.1.3 Synthesis

The LP synthesis is performed by filtering the post-processed excitation
signal $u(n)$ through the LP synthesis filter*.*. The decoded and
interpolated LP coefficients,${\hat{a}}_{i}$, are used to construct the
synthesis filter, $1/\hat{A}\left( z \right)$.

The reconstructed speech for the subframe of size 64 is given by

$\hat{s}\left( n \right) = u(n) - \sum_{i = 1}^{\text{16}}{{\hat{a}}_{i}\hat{s}(n - i)}$
(1511)

The synthesized signal is then de-emphasized by filtering through the
filter $1/(1 - 0\text{.}\text{68}z^{- 1})$ (inverse of the pre-emphasis
filter applied at the encoder input).

The de-emphasis synthesis speech
![](media/image4.wmf){width="0.2777777777777778in" height="0.19375in"}
is then passed through an adaptive post-processing which is described in
the following section.

### 6.1.4 Post-processing

The decoded signal is conveyed to several post-processing blocks. First
an adaptive post-filtering is applied for enhancing the formant and
harmonic structure of the signal. In a second step, a bass-post-filter
treats the low frequencies.

6.1.4.1 Adaptive post-filtering

The post-filtering is similar to ITU-T G.729 post-processing with the
main difference that it is performed at 12.8 or 16 kHz. The adaptive
post-filter is a cascade of three filters: a long-term post-filter,
$H_{p}\left( z \right)$, a short-term post-filter,
$H_{f}\left( z \right)$, and a tilt compensation filter,
$H_{t}\left( z \right)$, followed by an adaptive gain control procedure.
The post-filter coefficients are updated in every subframe. The
post-filtering process is organized as follows. First, the reconstructed
signal, ${\hat{s}}_{\text{pre}}(n)$, is inverse-filtered through
$\hat{A}\left( \frac{z}{\gamma_{n}} \right)$ to produce the residual
signal, $\hat{r}\left( n \right)$. This signal is used to compute the
delay, $T$, and gain, $g_{l}$, of the long-term post-filter
$H_{p}\left( z \right)$. The signal, $\hat{r}\left( n \right)$, is then
filtered through the long-term post-filter, $H_{p}\left( z \right)$, and
the synthesis filter,
$\frac{1}{\lbrack}g_{f}\hat{A}\left( \frac{z}{\gamma_{d}} \right)\rbrack$.
Finally, the output signal of the synthesis filter,
$\frac{1}{\lbrack}g_{f}\hat{A}\left( \frac{z}{\gamma_{d}} \right)\rbrack$
is passed through the tilt compensation filter, $H_{p}\left( z \right)$,
to generate the post-filtered reconstructed signal, ${\hat{s}}_{f}(n)$.
Adaptive gain control is then applied to ${\hat{s}}_{f}(n)$ to match its
energy to the energy of ${\hat{s}}_{\text{pre}}(n)$. The post-filter
parameters $\gamma_{n}$ *and* $\gamma_{d}$ *are described in detail in
subclauses 6.1.4.1.3. and* 6.1.4.1.4.

The long-term post-filter is only applied for NB modes and is bypassed
for WB and SWB. In WB and SWB cases, the post-filtering consists of a
cascade of only two filters: a short-term post-filter,
$H_{f}\left( z \right)$ (see subclause 6.1.4.3), and a tilt compensation
filter, $H_{t}\left( z \right)$ (see subclause 6.1.4.4), followed by an
adaptive gain control procedure (see subclause 6.1.4.5).

At 9.6 kbit/s NB decoding, the long-term post-filter,
$H_{p}\left( z \right)$is active only for clean speech when the level of
background noise is less than 20 dB. It is also desactivacted for UC
mode.

##### 6.1.4.1.1 Long-term post-filter

The long-term post-filter is given by:

$H_{p}\left( z \right) = \frac{1}{1 + \gamma_{p}g_{l}}\left( 1 + \gamma_{p}g_{l}z^{- T} \right)$
(1512)

where $T$is the pitch delay, and *g~l~* is the gain coefficient. Note
that $g_{l}$is bounded by 1, and is set to zero if the long-term
prediction gain is less than 3 dB. The factor $\gamma_{p}$ controls the
amount of long‑term post-filtering and has the value of
$\gamma_{p} = 0\text{.}5$. The long-term delay and the gain are computed
from the residual signal, $\hat{r}\left( n \right)$, obtained by
filtering $\hat{s}(n)$ through
$\hat{A}\left( \frac{z}{\gamma_{n}} \right)$, which is the numerator of
the short-term post-filter (see subclause ). That is

$\hat{r}\left( n \right) = \hat{s}\left( n \right) + \sum_{i = 1}^{\text{16}}{\gamma_{n}^{i}{\hat{a}}_{i}\hat{s}\left( n - i \right)}$
(1513)

The long-term delay is computed using a two-pass procedure. The first
pass selects the best integer pitch delay, $T_{0}$, in the range
$\left\lbrack \left\lfloor d_{\text{fr}}^{\lbrack 0\rbrack} \right\rfloor - 1;\ \left\lfloor d_{\text{fr}}^{\lbrack 0\rbrack} \right\rfloor + 1; \right\rbrack$,
where $\left\lfloor d_{\text{fr}}^{\lbrack 0\rbrack} \right\rfloor$ is
the integer part of the (transmitted) fractional pitch lag in the first
subframe. The best integer, $T_{0}$, is the one that maximizes the
correlation

$R\left( k \right) = \sum_{n = 0}^{\text{63}}{\hat{r}\left( n \right)\hat{r}\left( n - k \right)}$
(1514)

The second pass chooses the best fractional pitch delay, $T$, with
resolution 1/8 around $T_{0}$. This is done by finding the delay with
the highest pseudo-normalized correlation

$R^{'}\left( k \right) = \frac{\sum_{n = 0}^{\text{63}}{\hat{r}\left( n \right){\hat{r}}_{k}}\left( n \right)}{\sqrt{\sum_{n = 0}^{\text{63}}{{\hat{r}}_{k}\left( n \right){\hat{r}}_{k}}\left( n \right)}}$
(1515)

where ${\hat{r}}_{k}\left( n \right)$ is the residual signal at a
fractional delay, $k$. The fractional delayed signal,
${\hat{r}}_{k}\left( n \right)$, is first computed using an
interpolation filter of length 33. Once the optimal fractional delay,
$T$, is found, ${\hat{r}}_{k}\left( n \right)$ is recomputed with a
longer interpolation filter of length 129. The new signal replaces the
previous one only if the longer filter increases the value
of$R^{'}\left( T \right)$. Then, the corresponding correlation,
$R^{'}\left( T \right)$, is normalized with the square-root of the
energy of $\hat{r}\left( n \right)$. The squared value of this
normalized correlation is then used to determine if the long-term
post-filter should be disabled. That is, if

$\frac{R^{'}\left( T \right)^{2}}{\sum_{n = 0}^{\text{63}}{\hat{r}\left( n \right)\hat{r}\left( n \right)}} < 0\text{.}5$
(1516)

the long-term post-filter is disabled by setting $g_{l} = 0$. Otherwise,
the value of $g_{l}$ is computed as

$g_{l} = \frac{\sum_{n = 0}^{\text{63}}{\hat{r}\left( n \right){\hat{r}}_{k}\left( n \right)}}{\sum_{n = 0}^{\text{63}}{{\hat{r}}_{k}\left( n \right){\hat{r}}_{k}\left( n \right)}}$,
constrained by $0 \leq g_{l} \leq 1\text{.}0$ (1517)

##### 6.1.4.1.2 Short-term post-filter

The short-term post-filter is given by

$H_{f}\left( z \right) = \frac{1}{g_{f}}\ \frac{\hat{A}\left( \frac{z}{\gamma_{n}} \right)}{\hat{A}\left( \frac{z}{\gamma_{d}} \right)} = \frac{1}{g_{f}}\ \frac{1 + \sum_{i = 1}^{\text{16}}{\gamma_{n}^{i}{\hat{a}}_{i}z^{- i}}}{1 + \sum_{i = 1}^{\text{16}}{\gamma_{d}^{i}{\hat{a}}_{i}z^{- i}}}$
(1518)

where $\hat{A}\left( z \right)$ is the quantized LP analysis filter (LP
analysis is not done at the decoder) and the factors $\gamma_{n}$ and
$\gamma_{d}$ control the amount of short-term post-filtering. The gain,
$g_{f}$, is calculated on the truncated impulse response, $h_{f}(n)$, of
the filter
$\hat{A}\frac{\left( \frac{z}{\gamma_{n}} \right)}{\hat{A}}\left( \frac{z}{\gamma_{d}} \right)$
and is given by

$g_{f} = \sum_{n = 0}^{\text{19}}{|h_{f}\left( n \right)|}$ (1519)

Note that the gain, $g_{f}$, will be modified according to the noise
level as explained in the next clause.

##### 6.1.4.1.3 Post-filter NB parameters

In the ITU-T G.729 codec, the post-filter parameters
$\gamma_{n}$,$\gamma_{d}$ and $g_{f}$have fixed values. If a variable,
called the long-term normalized noise gain,
${\overline{g}}_{\text{norm}}$, is less than 25.0 and an active signal
is detected, $\gamma_{n}$ has a value limited in the range \[0.55,
0.70\] and $\gamma_{d}$ has a value limited in the range \[0.65, 0.75\]
as expressed by

${\gamma_{n} = - 0\text{.}\text{05\ \{}\overline{g}}_{\text{norm}} + 1\text{.}\text{45}$
(1520)

${\gamma_{d} = - 0\text{.}\text{01\ \{}\overline{g}}_{\text{norm}} + 0\text{.}9$
(1521)

Otherwise (not an active signal or
${\overline{g}}_{\text{norm}}$ ≥ 25.0), $\gamma_{n}$ = 0.1 and
$\gamma_{d}$ = 0.15.

In the case of the GSC mode the post-filter parameters $\gamma_{n}$,
$\gamma_{d}$ and $g_{f}$ *are set to* 1.

The long‑term normalized noise gain, ${\overline{g}}_{\text{norm}}$, is
updated only when in UC mode and when no signal activity is detected
($f_{\text{SAD}} = 0$). The update is performed as

${{\overline{g}}_{\text{norm}} = 0\text{.}\text{95\ \{}\overline{g}}_{\text{norm}} + 0\text{.}\text{05}g_{\text{norm}}$
(1522)

where $g_{\text{norm}}$ is the normalized gain of random excitation in
the UC mode, calculated as

$g_{\text{norm}} = \text{10}^{0\text{.}\text{05}E_{g}}\sqrt{\frac{1}{\text{64}}\sum_{n = 0}^{\text{63}}{c^{2}(n)}}$
(1523)

In the equation above, $E_{g}$ is the quantized gain of the random
excitation, $c(n)$, used in TC mode, which has been quantized with 7
bits in the logarithmic energy domain. The modified value of $g_{f}$in
equation Error: Reference source not found1524) is not filtered. The
modified value of $g_{f}$is computed as

$g_{f}^{'} = g_{f} + \mu\left( 1\text{.}0 - g_{f} \right)$ (1525)

where the factor $\mu$ is derived from ${\overline{g}}_{\text{norm}}$ as
follows

$\mu = \left( {\overline{g}}_{\text{norm}} - \text{15}\text{.}0 \right)\frac{0\text{.}1}{4}$,
constrained by $0\  \leq \mu \leq 0\text{.}\text{25}$ (1526)

Thus, the short-term post-filter, described in subclause 6.1.4.1.2, is
used with the modified value of gain, $g_{f}^{'}$, and not $g_{f}$.
These modifications help to diminish the effect of post-filtering in
noisy conditions.

##### 6.1.4.1.4 Post-filter WB and SWB parameters

The post-filter parameters $\gamma_{n}$, $\gamma_{d}$for WB and SWB have
fixed values, which depend on decoding mode. The filter may operate at
both internal sampling frequencies 12.8 kHz and 16 kHz. In case of 12.8
kHz internal frequency the parameters take the default value
$\gamma_{n}$ *= 0.7,* $\gamma_{d}$= 0.75

Table 157 Post filter WB and SWB parameters for 12.8 kHz

  ------ ---------------------------------- ----------------------------- ----------------------------- -------------------------- ------------------------------ --------------------------
  Mode   Inactive & AMRWB IO clean speech   \< 13.2 kbit/s clean speech   \< 24.4 kbit/s clean speech   ≤ 32 kbit/s clean speech   \< 15.85 kbit/s noisy speech   ≤ 32 kbit/s noisy speech
         0.7                                0.80                          0.75                          0.72                       0.75                           0.7
  ------ ---------------------------------- ----------------------------- ----------------------------- -------------------------- ------------------------------ --------------------------

In case of 16 kHz internal frequency, noisy speech (the level of
background noise is less than 20) and for any mode not depicted in the
table below the parameters take the default value $\gamma_{d}$ *= 0.76,*
$\gamma_{n}$= 0.76.

Table 158 Post filter WB and SWB parameters for 16 kHz

  ------ ------------- ------------- ------------- -----------
  Mode   13.2 kbit/s   16.4 kbit/s   24.4 kbit/s   32 kbit/s
         0.82          0.80          0.78          0.78
  ------ ------------- ------------- ------------- -----------

##### 6.1.4.1.5 Tilt compensation

The filter$H_{t}\left( z \right)$ compensates for the tilt in the
short-term post-filter $H_{f}\left( z \right)$ and is given by

$H_{t}\left( z \right) = \frac{1}{g_{t}}\left( 1 + \gamma_{t}k_{1}z^{- 1} \right)$
(1527)

where $\gamma_{t}k_{1}$ is a tilt factor with $k_{t}$ being the first
reflection coefficient, calculated from$h_{f}(n)$as

$k_{1} = - \frac{r_{h}\left( 1 \right)}{r_{h}\left( 0 \right)}$ (1528)

where

$r_{h}\left( i \right) = \sum_{j = 0}^{\text{19} - i}{h_{f}\left( j \right)h_{f}\left( j + i \right)}$
(1529)

The gain term$g_{t} = 1 - \left| \gamma_{t}k_{1} \right|$ compensates
for the decreasing effect of$g_{f}$in$H_{f}\left( z \right)$.
Furthermore, it has been shown that the product
$H_{f}\left( z \right)$$H_{t}\left( z \right)$has generally no gain. Two
values are used for $\gamma_{t}$ depending on the sign of $k_{1}$. If
$k_{1}$ is negative, $\gamma_{t}$= 0.9, and if $k_{1}$ is positive,
$\gamma_{t}$ = 0.2.

##### 6.1.4.1.6 Adaptive gain control

Adaptive gain control is used to compensate for gain differences between
the synthesized signal, ${\hat{s}}_{\text{pre}}(n)$, and the
post-filtered signal, ${\hat{s}}_{f}(n)$. A gain factor, $f_{g}$, for
the current subframe is computed by

$f_{g} = \frac{\sum_{n = 0}^{\text{63}}{|{\hat{s}}_{\text{pre}}\left( n \right)|}}{\sum_{n = 0}^{\text{63}}{|{\hat{s}}_{f}\left( n \right)|}}$
(1530)

Then, the post-filtered signal, ${\hat{s}}_{f}(n)$, is scaled as

${\hat{s}}_{f}(n) = g_{\text{cont}}(n){\hat{s}}_{f}(n)$, for *n* =
0,...,63 (1531)

where $g_{\text{cont}}(n)$ is a continuous gain, updated on a
sample-by-sample basis for NB input as

for NB input

$g_{\text{cont}}(n) = 0\text{.}\text{9875}g_{\text{cont}}(n - 1) + 0\text{.}\text{0125}f_{g}$,
for n = 0,...,63 (1532)

for SWB TBE input

$g_{\text{cont}}(n) = 0\text{.}\text{85}g_{\text{cont}}(n - 1) + 0\text{.}\text{15}f_{g}$,
for n = 0,...,63 (1533)

The initial value of $g_{\text{cont}}( - 1) = 1\text{.}0$ is used. Then,
for each new subframe, $g_{\text{cont}}( - 1)$ is set equal to
$g_{\text{cont}}(\text{63})$ of the previous subframe.

For NB signals, the post-filtered synthesized signal,
${\hat{s}}_{f}(n)$, is used instead of ${\hat{s}}_{\text{pre}}(n)$ for
signal de‑emphasis, as described in subclause 6.3.

#### 6.1.4.2 Bass post-filter

This clause describes the functionality of the bass post-filter, a
low-frequency pitch enhancement procedure, which is closely related to
the corresponding procedures in \[11\].

The main difference compared to the previous standards is that the last
step of post filtering is performed in the frequency domain. The reason
for this is a different method of resampling from the internal sampling
frequency to the output sampling frequency. Instead of time domain
resampling (see clause 7.6 in \[25\]) complex low delay filter bank
synthesis is used (see subclause 6.9).

The filter is applied to all LP-based modes up to 32 kbit/s except for
NB noisy speech (the level of background noise \> 20).

The bass post-filter uses two-band decomposition and adaptive filtering
is applied only to the lower band. This results in a total
post-processing that is mostly targeted at frequencies near the first
harmonics of the synthesized signal.

![](media/image5.wmf){width="6.539583333333334in"
height="3.109722222222222in"}

Figure 91: Block diagram of bass post-filter

Figure 92 shows the block diagram of the low-band pitch enhancer. Note
that this is a simplified block diagram, which is equivalent to adding
the low-pass filtered enhanced signal to the high-pass filtered signal
(see subclause 6.1.3 in \[11\]). The decoded signal, $\hat{s}(n)$, is
first processed through an adaptive pitch enhancer module leading to an
enhanced (full-band) signal, ${\hat{s}}_{f}(n)$. By subtracting the
decoded signal, an enhancement signal, $r(n)$, is obtained. Then CLDFB
analysis (see subclause 5.1.2) is applied to transform signal into
frequency domain $R_{C}(k)$. This signal is subsequently filtered in the
frequency domain through a low-pass filter to obtain the signal
${\hat{R}}_{C}(k)$ which is the low-band part of this
response$W_{C}(k)$. The enhanced signal after post-processing,
${\hat{S}}_{\text{outC}}(k)$, is then obtained by adding the low-band
enhancement signal to the transformed into frequency domain decoded
signal${\hat{S}}_{C}(k)$. Resampling to the output sampling frequency
and converting into time domain signal, ${\hat{s}}_{\text{out}}(n)$,
which is performed by CLDFB synthesis, is not a part of the bass
post-filter and is applied for all modes (see subclause 6.9).

The object of the pitch enhancer module is to reduce the inter-harmonic
noise in the decoded signal, which is achieved here by a time-varying
linear filter described by the following equation:

${\hat{s}}_{f}(n) = (1 - \alpha)\hat{s}(n) + \text{αs}_{p}(n)$ (1534)

where ${\hat{s}}_{f}(n)$ is the output signal of the pitch enhancer,
$\alpha$is a coefficient that controls the inter-harmonic attenuation.
The signal $s_{p}(n)$ is the two-sided long-term prediction signal that
is computed in each subframe as

$s_{p}(n) = 0\text{.}5\hat{s}(n - T) + 0\text{.}5\hat{s}(n + T)$ (1535)

where $T$ is the pitch period of the decoded signal $\hat{s}(n)$.
Parameters $T$ and $\alpha$ vary in time. With a value of
$\alpha = 0\text{.}5$, the gain of the filter described by equation
(1536) is exactly 0 at frequencies $\frac{1}{(}2T)$,$\frac{3}{(}2T)$,
$\frac{5}{(}2T)$, etc.; i.e., at the mid-point between the harmonic
frequencies $\frac{1}{T}$, $\frac{2}{T}$, $\frac{3}{T}$, $\frac{4}{T}$,
$\frac{5}{T}$, etc. When $\alpha$approaches 0, the attenuation between
the harmonics produced by the filter of equation (1537) decreases.

The pitch lag parameter $T$ is the received closed-loop pitch lag of the
respective subframe. However, this parameter is only accurate for the
part of the two-sided long-term prediction of Equation (1538) predicting
from the past pitch cycle. The prediction from the future pitch cycle
may be less accurate, especially if the pitch lag value is not constant.

Thus, in order to improve the prediction accuracy, in case of voiced
onset frames it is preferable to make use of the pitch lag value of the
subframe containing the future pitch cycle, i.e., of that subframe whose
closed-loop pitch lag points into the present subframe. This requires
the availability of pitch lag parameters of a frame following the
current frame.

The pitch lag parameter, $T$, is further enhanced by means of a pitch
tracker which makes the pitch contour smoother and avoids pitch
doublings.

The factor $\alpha$ is computed as follows. First, the correlation
between the signal and the predicted signal is given by

$C_{p} = \sum_{n = 0}^{N - 1}{\hat{s}(n)s_{p}(n)}$ (1539)

and the energy of the predicted signal is given by

$E_{p} = \sum_{n = 0}^{N - 1}{s_{p}(n)s_{p}(n)}$ (1540)

The factor $\alpha$ is given by

$\alpha = \frac{k_{1}\text{.}C_{p}}{(E_{p} + \text{10}^{0\text{.}1{\overline{E}}_{\text{pp}}})}$,
constrained by $0 \leq \alpha \leq 0\text{.}5$, (1541)

where ${\overline{E}}_{\text{pp}}$ is the mean prediction error energy
in dB in the present subframe and *k*~1~ takes values of 0.5 or 1
depending on the operating point. The mean prediction error energy,
${\overline{E}}_{\text{pp}}$is updated as follows. The long-term
prediction error is first computed by

$e_{p}(n) = k_{2}\hat{s}(n) - \frac{C_{p}}{E_{p}}s_{p}(n)$ (1542)

where *k*~2~ equals *C~p~*/*E~p~* or 1 depending on the operating point,
and then emphasized in the low frequencies using the relation

$e_{\text{pp}}(n) = e_{p}(n) + 0\text{.}9e_{\text{pp}}(n - 1)$ (1543)

The energy of the emphasized error signal is then computed in dB as

$E_{\text{pp}} = \text{10}\text{log}\left\lbrack \sum_{n = 0}^{N - 1}{e_{\text{pp}}(n)e_{\text{pp}}(n)} \right\rbrack$
(1544)

and the mean error energy is then updated in every subframe by

${{\overline{E}}_{\text{pp}} = 0\text{.}\text{99\ \{}\overline{E}}_{\text{pp}} + 0\text{.}\text{01}E_{\text{pp}}$
(1545)

with initial value ${\overline{E}}_{\text{pp}} = 0$.

The factor $\alpha$ is further adapted to a measure of signal
stationarity, which limits the level of inter‑harmonic attenuation when
the signal is not in a steady-state mode. The adaptation is based on the
stability factor of the current frame,
$\theta^{\left\lbrack 0 \right\rbrack}$ and a recursively smoothed
version of stability factor ${\overline{\theta}}^{\lbrack 0\rbrack}$
defined as

${\overline{\theta}}^{\left\lbrack 0 \right\rbrack} = 0\text{.}8 \cdot \theta^{\left\lbrack 0 \right\rbrack} + 0\text{.}2 \cdot {\overline{\theta}}^{\left\lbrack - 1 \right\rbrack}$
(1546)

The factor $\alpha$, defined in equation (1547), is finally scaled as

$\alpha = (1 + 0\text{.}\text{15}\sqrt{\theta^{\left\lbrack 0 \right\rbrack}} - 2\text{.}0\left| {\overline{\theta}}^{\left\lbrack 0 \right\rbrack} - \theta^{\left\lbrack 0 \right\rbrack} \right|) \cdot \alpha$
(1548)

Since larger portions of noise are aurally masked when the signal
rapidly changes, the above adaptation gives a better balance between
attenuation of quantization noise and signal degradation.

At 16.4 and 24.4 kbps, the factor $\alpha$ is adjusted by decoding the
gain adjustment ${\hat{\alpha}}_{\gamma}$, which is quantized at the
encoder (see subclause 5.2.4) and transmitted in the bitstream on 2
bits.

$\alpha = {\hat{\alpha}}_{\gamma} \cdot \alpha$ (1549)

### 6.1.5 Decoding of upper band for LP-based Coding Modes

#### 6.1.5.1 Decoding Time-domain Bandwidth Extension

The time domain bandwidth extension decoder synthesizes the high band
excitation signal from the excitation signal generated by the low band
ACELP decoder and a set of high band model parameters received from the
time domain bandwidth extension encoder. The synthesized high band
signal is then combined with the output from the lowband ACELP decoder
to generate a superwideband output. The high level schematic of the time
domain bandwidth extension decoder is shown in figure 93.

![](media/image6.wmf){width="6.690972222222222in"
height="2.202777777777778in"}

Figure 92: Time domain bandwidth extension decoder

##### 6.1.5.1.1 Generation of the upsampled version of the lowband excitation

An upsampled version of the low band excitation signal is derived from
the ACELP core as show in figure 93. For each ACELP core coding
subframe, *i*, a random noise scaled by a factor voice factor,
$\text{Vf}_{i}$ is first added to the fixed codebook excitation that is
generated by the ACELP core encoder. The voice factor is determined
using the subframe maximum normalized correlation parameter,
$\beta_{i},$ that is derived during the ACELP encoding. First the
$\beta_{i}$ factors are combined to generate$\text{Vf}_{i}$.

$\text{Vf}_{i} = 0\text{.}\text{34} + 0\text{.}5 \times \beta_{i} + \left( 0\text{.}5 - 0\text{.}\text{34} \right) \times \beta_{i^{2}}$
(1545)

$\text{Vf}_{i}$ calculated above is limited to a maximum of 1 and a
minimum of 0. When the ACELP coder type is voiced the V~f~ is modified
based on the integer pitch value T~0~ is modified as in the pseudo-code
below:

if((coder\_type == VOICED))

if(T~0~ \<= 57.75f)

$\text{Vf}_{i}$ = -0.0126f\*T~0~ + 1.23f;

else if(T~0~ \> 57.75f && T~0~ \< 115.5f)

$\text{Vf}_{i}$ = 0.0087f\*T~0~;

end

end

Regardless of the ACELP coder type, if the open loop pitch lag T~0~
exceeded 115, V~f~ is set to 1;

$\varepsilon_{1}\left( n \right) = \text{code}\left( n \right) + \text{Vf}_{i} \times \text{random}\left( n \right)\text{for}0 \leq n \leq \text{256}$
if the ACELP core encodes a maximum of 6.4 KHz or
$0 \leq n \leq \text{320}$ if the ACELP core encodes a maximum bandwidth
of 8 KHz.

The ACELP fixed code book excitation signal mixed with noise is then
resampled by a factor $\beta$. The resampling factor $\beta$is set to
5/2 when the ACELP core encodes a maximum bandwidth of 6.4 KHz and it is
set to 2 when the ACELP core encodes a maximum bandwidth of 8 KHz.

The resampled output is scaled by the ACELP fixed codebook gain and
added to a delayed version of itself.

$\varepsilon\left( n \right) = g_{c} \times \varepsilon_{2}\left( n \right) + g_{p} \times \varepsilon_{2}\left( n - \text{βP} \right)$
(1546)

where g~c~ is the subframe ACELP fixed codebook gain, g~p~ is the
subframe ACELP adaptive codebook gain and P is the open loop pitch lag.

##### 6.1.5.1.2 Non-Linear Excitation Generation

The excitation signal $\varepsilon\left( n \right)$ is processed through
a non-linear function in order to extend the pitch harmonics in the low
band signal into the high band. The non-linear processing is applied to
a frame of $\varepsilon\left( n \right)$ in two stages; the first stage
works on the first half subframe (160 samples) of
$\varepsilon\left( n \right)$ and the second stage works on the second
half subframe. The non-linear processing steps for the two stages are
described below. In the first stage
$n_{1} = 0\text{,~}n_{2} = \text{160}$, and in the second stage,
$n_{1} = \text{160}\text{,~}n_{2} = \text{320}$.

First, the maximum amplitude sample $\varepsilon_{\text{max}}$ and its
location relative to the first sample in the stage $i_{\text{max}}$ are
determined.

$\varepsilon_{\text{max}} = \text{max}\left( \left| \varepsilon\left( n \right) \right| \right)\text{~~}\text{and}i_{\text{max}} = \text{argmax}\left( \left| \varepsilon\left( n \right) \right| \right) - n_{1}\text{for}n_{1} \leq n < n_{2}$
(1547)

Based on the value of $\varepsilon_{\text{max}}$, the scale factor
$\text{sf}$ is determined.

$\text{sf} = \left\{ \begin{matrix}
\frac{0\text{.}\text{67}}{\varepsilon_{\text{max}}}\text{if}\varepsilon_{\text{max}} > 1 \\
0\text{.}\text{67}\text{if}\varepsilon_{\text{max}} \leq 1 \\
\end{matrix} \right.\ $ (1548)

The scale factor $\text{sf}$ and the previous scale factor parameter
from the memory $\text{sf}_{\text{prev}}$ are then used to determine the
parameter scale step$\text{ss}$.

$\text{ss} = \left\{ \begin{matrix}
1 & \text{if}\text{sf}_{\text{prev}} \leq 0 \\
e^{\left( \frac{1}{i_{\text{max}}} \right) \ast \text{log}\left( \frac{\text{sf}}{\text{sf}_{\text{prev}}} \right)} & \text{otherwise} \\
\end{matrix} \right.\ $ (1549)

If $\text{sf}_{\text{prev}} \leq 0$, then
$\text{sf}_{\text{prev}} = \text{ss}$

The output of the non-linear processing
$\varepsilon_{\text{NL}}\left( n \right)$ is derived as per

$\varepsilon_{\text{NL}}\left( n \right) = \left\{ \begin{matrix}
\varepsilon^{2}\left( n \right) \times \text{sf}_{\text{prev}} & \text{if}\varepsilon\left( n \right) \leq 0 \\
 - \varepsilon^{2}\left( n \right) \times \text{sf}_{\text{prev}} & \text{if}\varepsilon\left( n \right) < 0 \\
\end{matrix}\ \text{for}n_{1} \leq n < n_{2} \right.\ $ (1550)

The previous scale factor parameter is updated recursively for all
$j < i_{\text{max}}$ according to

for(j=n~1~; j\< n~2~; j++)

if(j\<i~max~)

$\text{sf}_{\text{prev}}$=$\text{sf}_{\text{prev}} \times \text{ss}$

end

end

##### 6.1.5.1.3 De-quantization of high band parameters

The high band LSF, gain shape and gain frame parameters are de-quantized
by looking up the quantization tables for these parameters based on the
indices. The LSF de-quantization is done as follows:

##### 6.1.5.1.3.1 LSF de-quantizing {#lsf-de-quantizing .H6}

The first five LSFs ${\hat{\rho}}_{k}^{\text{SHB}},\ k = 1,\ldots,5$ are
reconstructed directly from the received CB indices. The mirroring
frequency and optimal grid are reconstructed from the received indics.
The upper-half ot the coefficients
${\hat{\rho}}_{k}^{\text{SHB}},\ k = 6,\ldots,\text{10}$ are
reconstructed by flipping the lower-half of the coefficients over the
reconstructed mirroring frequency, rescaling and then smoothing with the
reconstructed optimal grid, as described in subclause 5.2.4.1.3.1.

${\hat{\rho}}_{k + 5}^{\text{SHB}} = \begin{matrix}
\left( 1 - \lambda_{k} \right){\overset{\sim}{\rho}}_{k}^{\text{SHB}} + \lambda_{k}{\overset{\sim}{g}}_{i^{\text{opt}},k} & k = 1,\ldots,5 \\
\end{matrix}$ (1551)

Using the received VQ index parameter for the gain shape, the
de-quantized gain shape vector that contains the gain shape parameter in
the log domain is retrieved. The quantized gain shape parameters
$\text{gs}_{q}\left( j \right)\text{for}j = 1,\ldots 4$ are then
obtained from the log domain values by inverse logarithm operation.

The de-quantized frame gain parameter $\text{GF}_{q}$ is obtained by
obtaining the log domain frame gain value from the table and by
converting this back into linear domain by inverse logarithm operation.

For the bit rates of 24.4 kb/s and 32 kb/s, the de-quantized high band
subframe residual energy
${\hat{\vartheta}}_{\text{res}_{q}}\left( j \right)$, the de-quantized
high band target energy,$\vartheta_{q}$ and the mixing factor,
$\text{fac}_{q}$ ,are obtained by table lookup using the respective
received indices.

##### 6.1.5.1.4 LSP interpolation

Refer to subclauses 5.2.6.1.4 and 5.2.6.1.4.2 for 24.4 kbps and 32kbps
LSP interpolation.

##### 6.1.5.1.4.1 LSP interpolation at 13.2 kbps and 16.4 kbps {#lsp-interpolation-at-13.2-kbps-and-16.4-kbps .H6}

Refer to subclause 5.2.4.1.4.1

##### 6.1.5.1.5 Spectral flip in time domain

The non-linear excitation $\varepsilon_{\text{NL}}\left( n \right)$ is
spectrally flipped so that the high band portion of the excitation is
modulated down to the low frequency region. This spectral flip is
accomplished in time domain

$\varepsilon_{\text{flipped}}\left( n \right) = \left( - 1 \right)^{n}\varepsilon_{\text{NL}}\left( n \right)\text{,~}\text{for}n = 0,\ldots\text{319}$
(1552)

##### 6.1.5.1.6 Down-sample using all-pass filters

$\varepsilon_{\text{flipped}}\left( n \right)$ is then decimated using a
pair of all pass filters to obtain an 8 KHz bandwidth (16 KHz sampled)
excitation singal $\varepsilon_{\text{16}k}\left( n \right)$. This is
done by filtering the even samples of
$\varepsilon_{\text{flipped}}\left( n \right)$ by an all pass filter
whose transfer function is given by

$H_{d,1} = \left( \frac{a_{0,1} + z^{- 1}}{1 + a_{0,1}z^{- 1}} \right)\left( \frac{a_{1,1} + z^{- 1}}{1 + a_{1,1}z^{- 1}} \right)\left( \frac{a_{2,1} + z^{- 1}}{1 + a_{1,1}z^{- 1}} \right)$
(1553)

And the odd samples of $\varepsilon_{\text{flipped}}\left( n \right)$ by
an all pass filter whose transfer function is given by

$H_{d,2} = \left( \frac{a_{0,2} + z^{- 1}}{1 + a_{0,2}z^{- 1}} \right)\left( \frac{a_{1,2} + z^{- 1}}{1 + a_{1,2}z^{- 1}} \right)\left( \frac{a_{2,2} + z^{- 1}}{1 + a_{1,2}z^{- 1}} \right)$
(1554)

The 16 KHz sampled excitation signal
$\varepsilon_{\text{16}k}\left( n \right)\text{for}n = 0,\ldots\text{159}$
are obtained by averaging the outputs of the above filter.

These filter coefficients are described in subclause 5.2.6.1.9.

##### 6.1.5.1.7 Adaptive spectral whitening

Due to the nonlinear processing applied to obtain the excitation signal
$\varepsilon_{\text{16}k}\left( n \right)$, the spectrum of this
excitation is no longer flat. In order to flatten the spectrum of the
excitation signal $\varepsilon_{\text{16}k}\left( n \right)$, 4^th^
order linear prediction coefficients are estimated from
$\varepsilon_{\text{16}k}\left( n \right)\text{.}$The spectrum of
$\varepsilon_{\text{16}k}\left( n \right)$ is then flattened by inverse
filtering $\varepsilon_{\text{16}k}\left( n \right)$ using the linear
prediction filter.

The first step in the adaptive whitening process is to estimate the
autocorrelation of the excitation signal

$r_{\text{exc}}^{\text{SHB}}\left( k \right) = \underset{n = k}{\overset{L - 1}{\sum_{}^{}}}\varepsilon_{\text{16}k}\left( n \right) \times \varepsilon_{\text{16}k}\left( n - k \right)\text{,~~}k = 0,\ldots\text{,~}4\text{and}n = 0,\ldots\text{159}$
(1555)

A bandwidth expansion is applied to the autocorrelation coefficients by
multiplying the coefficients by the expansion function:

${\hat{r}}_{\text{exc}}^{\text{SHB}}\left( k \right) = r_{\text{exc}}^{\text{SHB}}\left( k \right) \times \text{wac}\left( k \right)\text{,~~}k = 0,\ldots\text{,~}4$
(1556)

The bandwidth expanded autocorrelation coefficients are used to obtain
LP filter coefficients,
$a_{k}^{\text{WHT}}\text{,~}k = 1,\ldots\text{,~}5,$ by solving the
following set of equations using the Levinson-Durbin algorithm as
described in section.

$\underset{k = 1}{\overset{4}{\sum_{}^{}}}a_{k}^{\text{WHT}} \times {\hat{r}}_{\text{exc}}^{\text{SHB}}\left( i - k \right) = - {\hat{r}}_{\text{exc}}^{\text{SHB}}\left( i \right)\text{,~~}i = 1,\ldots 4$
(1557)

It must be noted that $a_{1}^{\text{WHT}} = 1$.

The whitened excitation signal
$\varepsilon_{\text{WHT}}\left( n \right)$ is obtained from
$\varepsilon_{\text{16}k}\left( n \right)$ by inverse filtering

$\varepsilon_{\text{WHT}}\left( n \right) = \varepsilon_{\text{16}k}\left( n \right) - \underset{k = 1}{\overset{4}{\sum_{}^{}}}a_{k}^{\text{WHT}}\varepsilon_{\text{16}k}\left( n - k \right)$
(1558)

4 samples of $\varepsilon_{\text{16}k}\left( n \right)$ from the
previous frame are used as memory for the above filtering operation.

For bit rates 24.4 kb/s and 32 kb/s, the whitened excitation is further
modulated by the normalized residual energy parameter
${\hat{\vartheta}}_{\text{res}}\left( j \right)$. In other words, for
bitrates 24.4 kb/s and 32 kb/s,

$\varepsilon_{\text{WHT}}\left( \left( j - 1 \right) \times \text{80} + n \right) = \varepsilon_{\text{WHT}}\left( \left( j - 1 \right) \times \text{80} + n \right) \times {\hat{\vartheta}}_{\text{res}}\left( j \right)\ \text{for}\left( j - 1 \right) \times \text{80} \leq n < j \times \text{80}\text{and}j = 1,\ldots 4$
(1559)

##### 6.1.5.1.8 Envelope modulated noise mixing

To the whitened excitation, a random noise vector whose amplitude has
been modulated by the envelope of the whitened excitation is mixed using
a mixing ratio that is dependent on the extent of voicing in the low
band.

First,
$\text{eabs}\left( n \right) = \left| \varepsilon_{\text{WHT}}\left( n \right) \right|$
is calculated and then the envelope of the envelope of the whitened
excitation signal $\varepsilon_{\text{WHT}}\left( n \right)$is
calculated by smoothing $\text{eabs}\left( n \right)$

$\text{envNE}\left( n \right) = \alpha_{1} \times \text{eabs}\left( n \right) + \alpha_{2} \times \text{envNE}\left( n - 1 \right)$
(1560)

In SWB, the factors $\alpha_{1}$ and $\alpha_{2}$ are calculated using
the voicing factors, $\text{Vf}_{i}$ for subframes $i = 1,\ldots 4$,
determined from the low band ACELP encoder. The average of the 4 voicing
factors,
$\text{Vf} = 0\text{.}\text{25} \times \sum_{}^{}\text{Vf}_{i}$, is
calculated and modified as
$\text{Vf} = 1\text{.}\text{09875} - 0\text{.}\text{49875} \times \text{Vf}$.
This is then confined to values between 0.6 and 0.999. Then $\alpha_{1}$
and $\alpha_{2}$ are estimated as

$\alpha_{1} = 1 - \text{Vf}$ (1561)

$\alpha_{2} = - \text{Vf}$ (1562)

However, for bit rates 16.4 kb/s and 24.4 kb/s and if TBE was not used
in the previous frame, $\alpha_{1}$ and $\alpha_{2}$ are set to

$\alpha_{1} = 0\text{.}2$ (1563)

$\alpha_{2} = - 0\text{.}8$ (1564)

and for $n = 0$, $\text{envNE}(n - 1)$is substituted by an approximated
value $\text{envNE}_{\text{prev},\text{approx}}$ as

$\text{envNE}_{\text{prev},\text{approx}} = \frac{1}{\text{20}}\sum_{n = 0}^{\text{19}}{\text{eabs}(n)}$
(1565)

In WB mode, the factors $\alpha_{1}$ and $\alpha_{2}$are initialized to
$\alpha_{1} = 0\text{.}\text{05}$and$\alpha_{2} = - 0\text{.}\text{96}$.
However, if the bitrate is 9.6kb/s, they might get reset to
$\alpha_{1} = 0\text{.}2$and$\alpha_{2} = - 0\text{.}8$if the if the low
band coder type is voiced or$\text{Vf} > 0\text{.}\text{35}$, or to
$\alpha_{1} = 0\text{.}\text{01}$and$\alpha_{2} = - 0\text{.}\text{99}$
if the low band coder type is unvoiced or$\text{Vf} < 0\text{.}2$.

A vector of random numbers, $\text{rnd}\left( n \right)$ of length 160
is then modulated by $\text{envNE}\left( n \right)$ to generate
$\text{rn}_{\text{wht}}\left( n \right)$ as

$\text{rn}_{\text{wht}}\left( n \right) = \text{rnd}\left( n \right) \times \text{envNE}\left( n \right)$
(1566)

The whitened excitation is then de-emphasized with
$\mu = 0\text{.}\text{68}$ which is the pre-emphasised effect since the
used spectrum is flipped.

$\text{rn}_{\text{wht}}\left( n \right) = \text{rn}_{\text{wht}}\left( n \right) + \mu \times \text{rn}_{\text{wht}}\left( n - 1 \right)$
(1567)

If the lowband coder type is unvoiced, the excitation
$\text{rn}_{\text{wht}}\left( n \right)$ is first rescaled to match the
energy level of the whitened excitation
$\varepsilon_{\text{WHT}}\left( n \right)$

$\text{rn}_{\text{wht}}\left( n \right) = \text{scale} \times \text{rn}_{\text{wht}}\left( n \right)$
(1568)

where
$\text{scale} = \sqrt{\sum_{}^{}\left( \varepsilon_{\text{wht}}(n) \right)^{2}/\sum_{}^{}\left( \text{rn}_{\text{wht}}(n) \right)^{2}}$and
then pre-emphasised with $\mu$=0.68 to generate the final excitation
which is the de-emphasised effect since the used spectrum is flipped.

$\varepsilon_{1}\left( n \right) = \text{rn}_{\text{wht}}\left( n \right) - \mu \times \text{rn}_{\text{wht}}\left( n - 1 \right)$
(1569)

If the lowband coder type was not un-voiced, the final excitation is
calculated as

$\varepsilon_{1}\left( n \right) = \alpha_{1}\left( i \right) \times \varepsilon_{\text{wht}}\left( n \right) + \alpha_{2}\left( i \right) \times \text{rn}_{\text{wht}}\left( n \right)$
(1570)

for each sample index $n$within subframe $i$.

For bit rates less than 24.4 kb/s, the mixing parameters $\alpha_{1}$
and $\alpha_{2}$ are estimated as

$\alpha_{1}\left( i \right) = \left( \text{Vf}_{i} \right)^{\frac{1}{4}}$
(1571)

$\alpha_{2}\left( i \right) = \sqrt{\frac{\left( \sum_{}^{}\left( \varepsilon_{\text{wht}}\left( n \right) \right)^{2} \right) \times \left( 1 - \sqrt{\text{Vf}_{i}} \right)}{\sum_{}^{}\left( \text{rn}_{\text{wht}}\left( n \right) \right)^{2}}}$
(1572)

For bit rates 24.4 kb/s and 32 kb/s, the mixing parameters
![](media/image7.wmf){width="0.1875in" height="0.20833333333333334in"},
$\alpha_{2}$ are estimated as follows:

$\alpha_{1}\left( i \right) = \sqrt{\left( \text{Vf}_{i} \right) \times \left( 1\text{.}0 - 0\text{.}\text{15} \times \text{fac}_{\text{formant}} \right)}$
(1573)

$\alpha_{2}(i) = \sqrt{\frac{\left( \sum_{}^{}\left( \varepsilon_{\text{wht}}\left( n \right) \right)^{2} \right) \times \left( 1\text{.}0 - \left( \text{Vf}_{i} \right) \times \left( 1\text{.}0 - 0\text{.}\text{15} \times \text{fac}_{\text{formant}} \right) \right)}{\sum_{}^{}\left( \text{rn}_{\text{wht}}\left( n \right) \right)^{2}}}$
(1573a)

where the parameter $\text{fac}_{\text{formant}}$ is defined in in
subclause 5.2.6.1.13.

$\varepsilon_{1}(n)$ is then de-emphasised to generate the final
excitation.

##### 6.1.5.1.9 Spectral shaping of the noise added excitation

The excitation signal $\varepsilon_{1}\left( n \right)$ is then put
through the high band LPC synthesis filter that is derived from the
quantized LPC coefficients (see subclause 5.2.4.1.3).

For bitrates below 24.4 kb/s, a single LPC synthesis filter
${\overset{\sim}{a}}_{k}^{\text{SHB}}\text{,~}k = 1\text{,~}\ldots\text{11}$
is used and the shaped excitation signal $\text{sε}\left( n \right)$ is
generated as

$\text{sε}\left( n \right) = \varepsilon_{1}\left( n \right) - \underset{k = 1}{\overset{\text{11}}{\sum_{}^{}}}{\overset{\sim}{a}}_{k}^{\text{SHB}} \times \text{sε}\left( n - k \right)$
(1574)

For bitrates above 24.4 kb/s the LPC synthesis filter is applied to the
excitation signal $\varepsilon_{1}\left( n \right)$ in four subframes
based on

$\text{sε}\left( n + \left( j - 1 \right) \times \text{80} \right) = \varepsilon_{1}\left( n + \left( j - 1 \right) \times \text{80} \right) - \underset{k = 1}{\overset{\text{11}}{\sum_{}^{}}}{\overset{\sim}{a}}_{k}^{\text{SHB}}\left( j \right) \times \text{sε}\left( n + \left( j - 1 \right) \times \text{80} - k \right)\ \text{for}\ j = 1,\ldots,4$
(1575)

##### 6.1.5.1.10 Post processing of the shaped excitation

Refer to subclause 5.2.6.1.13.

##### 6.1.5.1.11 Gain shape update

The gain shapes are updated according to the coding type of both the
current frame and the previous frame. The pitch gain of the current
frame is also taken into account.

The pitch gain $\text{pitch}_{\text{gs}}$of the current frame is
calculated
by$\text{pitch}_{\text{buf}}(j),j = 1,\text{.}\text{.}\text{.},N,N = 4\text{or}5$:

$\text{pitch}_{\text{gs}} = \begin{matrix}
\left\{ 0\text{.}\text{25} \ast \sum_{j = 1}^{4}{\text{pitch}_{\text{buf}}(j)},N = 4 \middle| \right.\  \\
\end{matrix}$ (1576)

If the coding type of the current frame and the previous frame are the
same, or the coding type of the current frame is GENERIC and the coding
type of the previous frame is VOICED, or the coding type of the current
frame is VOICED and the coding type of the previous frame is GENERIC,
and the pitch gain of the current frame $\text{pitch}_{\text{gs}}$ is
greater than 70, then the gain shape parameters are smoothed as follows:

$\text{gs}_{q}(j) = 0\text{.}5 \ast \text{Ener}_{\text{prev}}(j\frac{)}{\text{Ener}}(j) \ast \text{gs}_{q_{\text{prev}}}(j) + 0\text{.}5 \ast \text{gs}_{q}(j),j = 1,2,3,4$
(1577)

$\text{Ener}(j) = \sqrt{\sum_{n = 0}^{\text{79}}{(\text{sε}(j \ast \text{80} + n)} \ast 0\text{.}\text{0125})^{2}},j = 1,2,3,4$
(1578)

where $\text{Ener}(j),j = 1,2,3,4$are the subframe energies in the
shaped excitation signal of the current frame,
$\text{Ener}_{\text{prev}}(j),j = 1,2,3,4$ are the subframe energies in
the shaped excitation signal of the previous
frameand$\text{gs}_{q_{\text{prev}}}(j),j = 1,2,3,4$ are the quantized
gain shape parameters of the previous frame.

##### 6.1.5.1.12 SHB synthesis

In order to smooth the evolution of the post-processed spectrally shaped
highband excitation signal at the frame boundary, the energy ratio
between the current frame's overlap samples and the previous frame's
overlap samples are calculated as below:

$\text{SclF} = \sqrt{\frac{\sum_{n = \text{L\_SHB\_LAHEAD} + \text{10}}^{2 \ast (\text{L\_SHB\_LAHEAD} + \text{10}) - 1}\left( \text{sεb}(n)^{2} \right)}{\sum_{n = 0}^{\text{L\_SHB\_LAHEAD} + \text{10} - 1}\left( \text{sεb}(n)^{2} \right)}}$
(1579)

where $\text{L\_SHB\_LAHEAD}$ is 20 samples. The tenth-order LPC
synthesis performed as described according to subclause 6.1.5.1.9 uses a
memory of ten samples, thus there is atleast a ten sample energy
propagation from the previous frame into the current frame. When
calculating the energy scaling to be applied to the current frame, it
should be noted that the first 10 samples of the present frame are
considered as a part of previous frame energy. If the voicing factor
$\text{Vf}_{0}$is greater than 0.75, the numerator in the above equation
is attenuated by 0.25. The spectrally shaped high band excitation signal
is then modified by the above scaling factor as follows:

$\text{sεb}(n) = \left\{ \begin{matrix}
\text{SclF} \times \text{sεb}(n),\ 0 \leq n < L_{\text{SHB}_{\text{LAHEAD}}} \\
(\text{SclF} \times \frac{\text{29} - i}{\text{10}} + \frac{i - \text{19}}{\text{10}}) \times \text{sεb}(n),\ L_{\text{SHB}_{\text{LAHEAD}}} \leq n < L_{\text{SHB}_{\text{LAHEAD}}} + \text{10} \\
\end{matrix} \right.\ $ (1580)

For bit rates 24.4 kb/s or higher, gain shape values are then up sampled
from 4 values to 16 values as described in below. First subframe
energies from the spectrally shaped highband excitation signal are
calculated.

$\text{Et}(j) = \sqrt{0\text{.}\text{0125} \times \sum_{i = j \times \text{80}}^{(j + 1) \times \text{80} - 1}{\text{sεb}(i)^{2}}}$
for $j = 0,1,2,3$ (1581)

The interpolated gain shape parameters are obtained as follows

$\text{gs}_{\text{temp}}(k) = \text{gs}_{q}(\text{floor}(\frac{k}{4}))$
for $k = 0,1,\text{.}\text{.}\text{.},\text{15}$

Based on either $\text{gs}_{\text{int}}(k)$ or
$\text{gs}_{q}(k)$(depending on the bit rate), the shaped highband
excitation signal is scaled. The scaling is performed using overlapping
windows as described below:

$\text{sε}_{\text{scaled}}\left( n - \text{20} \right) = \underset{j = 1}{\overset{4}{\sum_{}^{}}}\text{gs}_{q}\left( j \right) \times \text{swin}_{1}\left( n - \left( j - 1 \right) \times \text{80} \right) \times \text{sε}\left( n - \text{20} \right)\text{for}n = 0,\ldots\text{359}$where
the definition of swin~1~ is described in section 5.2.6.1.15. The scaled
excitation is then finally multiplied by the quantized frame gain to
obtain the highband synthesized signal.

$\text{syn}_{\text{scaled}}\left( n - \text{20} \right) = \text{gf} \times \text{sε}_{\text{scaled}}\left( n - \text{20} \right)$
for *n=0,...359*

The overlap portion from the previous frame are then added to the first
20 samples of the current frame of $\text{syn}_{\text{scaled}}$.

The highband synthesized signal is then used to generate a 32 KHz
sampled highband component of the final output decoded speech signal.
First the highband synthesized signal is upsampled by 2 using an
interpolator. The $\text{syn}_{\text{scaled}}$ signal is filtered
through all-pass filters as per below.

$H_{I,1} = \left( \frac{b_{0,1} + z^{- 1}}{1 + b_{0,1}z^{- 1}} \right)\left( \frac{b_{1,1} + z^{- 1}}{1 + b_{1,1}z^{- 1}} \right)\left( \frac{b_{2,1} + z^{- 1}}{1 + b_{1,1}z^{- 1}} \right)$

and

Table 159: All-pass filter coefficients for interpolation by a factor of
2

  -------- -----------------------
           All pass coefficients
  b~0,1~   0.06056541924291
  b~1,1~   0.42943401549235
  b~2,1~   0.80873048306552
  b~0,2~   0.22063024829630
  b~1,2~   0.63593943961708
  b~2,2~   0.94151583095682
  -------- -----------------------

And the output samples from both these filters are interlaced to
generate the upsampled highband signal. At bitrate of 13.2 and 16.4 kb/s
where the 12.8 KHz sampled core is used, the upsampled higband signal is
downmixed using a Hilbert operator.

##### 6.1.5.1.13 Core-switching and high-band memory updates

##### 6.1.5.1.13.1 TBE/IGF switching {#tbeigf-switching .H6}

When switching from ACELP to TCX core and thus from TBE to IGF, or vice
versa, the transition of the high-band signals is performed implicitly
by the cross-fade transition mechanism of the core signals. Due to
differing delay compensations, the high-band IGF and TBE signals
overlap, when switching from IGF to TBE. On the other hand, when
switching from TBE to IGF the differing delay compensations cause a gap
in between the high-band signals. To fill this gap and additionally
provide overlapping signals for the cross-fade, a transition signal
$\text{syn}_{\text{transition}}$is generated as follows.

To obtain a continuous high-band signal to the previous frame, the
overlap portion of the high-band synthesized signal
$\text{syn}_{\text{scaled}}$ is used, as described in the SHB synthesis
subclause 6.1.5.1.12. This overlap portion $\text{syn}_{\text{overlap}}$
is up-sampled using the same filters $H_{I,1}$and$H_{I,2}$. The output
samples of the filters are interlaced, if the underlying core is sampled
at 16 kHz or processed using a Hilbert operator to generate the
up-sampled high-band signal$\text{syn}_{\text{overlap},\text{32}k}$.

The needed length of $\text{syn}_{\text{transition}}$is 148 samples, so
the 40 samples of $\text{syn}_{\text{overlap},\text{32}k}$are
extrapolated using the temporally mirrored end
$\text{syn}_{\text{prev},\text{mirror}}$of the high-band synthesized
signal of the previous frame$\text{syn}_{\text{prev}}$, where

$\text{syn}_{\text{prev},\text{mirror}}(n) = \text{syn}_{\text{prev}}(\text{641} - n)\ \text{for}\ n = 1,\ldots,\text{148}$
(1582)

The signals $\text{syn}_{\text{overlap},\text{32}k}$ and
$\text{syn}_{\text{prev},\text{mirror}}$are merged to generate
$\text{syn}_{\text{transition}}$by overlap and add using the window
$\text{win}_{\text{transition}}$as described in table 159, as

$\begin{matrix}
\text{syn}_{\text{transition}}(n) = \\
\  \\
 \\
\end{matrix}\begin{matrix}
\left\{ \text{win}_{\text{transition}}(\text{41} - n) \ast \text{syn}_{\text{overlap},\text{32}k}(n) + \text{win}_{\text{transition}}(n) \ast \text{syn}_{\text{prev},\text{mirror}(n)},n = 1,\text{.}\text{.}\text{.},\text{40} \middle| \right.\  \\
\end{matrix}$ (1583)

Table 160 Window for generation of transition signal

  ---- ------------ ---- ----------- ---- ----------- ---- -----------
  n                 n                n                n    
  1    0.04618346   11   0.4866045   21   0.8249975   31   0.9904104
  2    0.09216993   12   0.5258704   22   0.8493099   32   0.9946717
  3    0.1381564    13   0.5651364   23   0.8736224   33   0.9989330
  4    0.1835534    14   0.6019916   24   0.8942082   34   0.9994665
  5    0.2289505    15   0.6388468   25   0.9147939   35   1
  6    0.2733710    16   0.6729768   26   0.9314773   36   1
  7    0.3177914    17   0.7071068   27   0.9481606   37   1
  8    0.3608562    18   0.7382205   28   0.9607993   38   1
  9    0.4039210    19   0.7693340   29   0.9734381   39   1
  10   0.4452628    20   0.7971658   30   0.9819242   40   1
  ---- ------------ ---- ----------- ---- ----------- ---- -----------

##### 6.1.5.1.14 TEC/TFA post processing

The TEC and the TFA are complementally activated according to the
transmitted information. The TEC is performed when an onset is detected
in the high frequency band at the encoder (i.e.
$\text{tec}_{\text{flag}} > 0$). On the other hand, the TFA is performed
when the temporal envelope of the high band signal is detected to be
flat at the encoder (i.e. $\text{tfa}_{\text{flag}} = 1$).

Decoding the transmitted codeword, the TEC and TFA parameters are set
as:

Table 161: Decoding the transmitted codeword to the TEC and TFA
parameters.

  ---------- ----------- -----------
  Codeword   tec\_flag   tfa\_flag
  00         0           0
  01         0           1
  10         1           0
  11         2           0
  ---------- ----------- -----------

When $\text{tec}_{\text{flag}} > 0$, the temporal envelope of the high
frequency band is calculated from the temporal envelope of the low
frequency band and the TEC parameter and then the high frequency band
signal is shaped with the calculated temporal envelope of the high
frequency band. Firstly, the temporal envelope of the low frequency band
of the decoded signal $\text{env}_{l,\text{dec}}(i)$ is calculated as:

$\text{env}_{l,\text{dec}}(i) = \frac{1}{3}\sum_{m = 0}^{2}{\text{env}_{{\text{ls},\text{dec}}^{m}}(i)}\text{\ \ \ \ \ \ for\ }i = 0,\text{.}\text{.}\text{.},\text{15}$
(1584)

where

$\text{env}_{{\text{ls},\text{dec}}^{m}}(i) = \text{10}\text{log}_{\text{10}}\left( \frac{1}{\left( k_{u,m} - k_{l,m} + 1 \right)}\sum_{k = k_{l,m}}^{k_{u,m}}\left| {\hat{S}}_{\text{outC}}(k,i) \right|^{2} \right)\text{\ \ \ \ \ \ for\ }i = 0,\text{.}\text{.}\text{.},\text{15}$
(1585)

and where ${\hat{S}}_{\text{outC}}(k,i)$ is the low frequency band
signal in the QMF domain described in subclause 6.1.4.2.

Then, the temporal envelope of the high frequency band is calculated
from the temporal envelope of the low frequency band and the TEC
parameter as:

$\text{env}_{h,\text{dec}}(i) = \left\{ \begin{matrix}
\text{10}^{0\text{.}1\text{env}_{l,\text{dec}}(i)} & \text{tec}_{\text{flag}} = 1 \\
\text{10}^{0\text{.}1\text{env}_{l,\text{sm},\text{dec}}(i)} & \text{tec}_{\text{flag}} = 2 \\
\end{matrix} \right.\ \text{\ \ \ \ \ \ for\ }i = 0,\text{.}\text{.}\text{.},\text{15}$
(1586)

where
$\text{env}_{l,\text{sm},\text{dec}}(i) = 1\text{.}\text{19205} \times \sum_{}^{}{\text{sc}(j) \cdot \text{env}_{l,\text{dec}}(i - j)}\text{\ \ \ \ \ for\ }i = 0,\text{.}\text{.}\text{.},\text{15}$.

The gain values to be applied to the high frequency band signal is
calculated as

$g_{\text{tec}}(i) = \frac{\text{env}(i)}{\frac{1}{\text{16}}\sum_{j = 0}^{\text{15}}{\text{env}(j)}}\text{\ \ \ \ \ \ for\ }i = 0,\text{.}\text{.}\text{.},\text{15}$
(1587)

The gain values are limited by the lower
limit$g_{\text{tec},\text{lower}}$:

$g_{\text{tec},\text{lim}}(i) = \left\{ \begin{matrix}
g_{\text{tec},\text{lower}} & g_{\text{tec}}(i) < g_{\text{tec},\text{lower}} \\
g_{\text{tec}}(i) & \text{otherwise} \\
\end{matrix} \right.\ \text{\ \ \ \ \ \ for\ }i = 0,\text{.}\text{.}\text{.},\text{15}$
(1588)

The lower limit $g_{\text{tec},\text{lower}}$ is defined as:

$g_{\text{tec},\text{lower}} = 0\text{.}5 \cdot \text{min}\begin{pmatrix}
0\text{.}1, & \frac{1}{\text{inv}_{\text{enr}_{\text{max}}}} \\
\end{pmatrix}$ (1589)

where

$\text{inv}_{\text{enr}_{\text{max}}} = \text{max}\begin{pmatrix}
\text{10}^{- 6}, & \underset{i = 0\cdots\text{15}}{\text{max}}\left( \frac{1}{\left( \text{16} \cdot \text{enr}_{\text{shb}}(i) \right)}\sum_{i = 0}^{\text{15}}{\text{enr}_{\text{shb}}(i)} \right) \\
\end{pmatrix}$ (1590)

and where

$\text{enr}_{\text{shb}}(i) = \sum_{t = i \cdot l_{\text{subfr}_{\text{tec}}}}^{(i + 1) \cdot l_{\text{subfr}_{\text{tec}}} - 1}{\text{shb}(t)^{2}}\text{\ \ \ \ \ \ for\ }i = 0,\text{.}\text{.}\text{.},\text{15}$
(1591)

Then, the gain values are modified for maintaining the energy of the
high frequency band signal of the frame

$g_{\text{tec},\text{norm}}(i) = \frac{g_{\text{tec},\text{lim}}(i)}{\text{enr}_{\text{shb}}(i)}\text{\ \ \ \ \ \ for\ }i = 0,\text{.}\text{.}\text{.},\text{15}$
(1592)

Finally, the gain values are applied to the high frequency band signal

$\begin{matrix}
\text{syn}_{\text{scaled}^{\prime}}(t) = \text{min}\begin{pmatrix}
3\text{.}0, & g_{\text{tec},\text{norm}}(i) \\
\end{pmatrix} \cdot \text{syn}_{\text{scaled}}(t) \\
\ \text{\ \ \ }\ \text{\ \ \ }\ \text{\ \ \ }\ \text{\ \ \ }\ \text{\ \ \ \ for\ }t = i \cdot l_{\text{subfr}_{\text{tec}}},\cdots,(i + 1) \cdot l_{\text{subfr}_{\text{tec}}} - 1\text{\ and\ }i = 0,\text{.}\text{.}\text{.},\text{15} \\
\end{matrix}$ (1593)

where $l_{\text{subfr}_{\text{tec}}}$is the subframe length of TEC and
TFA which is 1.25 ms at the output sampling rate
($1\text{.}\text{25}R$).

When the $\text{tfa}_{\text{flag}} = 1$, the temporal envelope of the
high frequency band signal is determined as "flat" and then it is
flattened as follows. The gain values for the TFA $g_{\text{tfa}}(i)$
are calculated by:

$g_{\text{tfa}}(i) = \sqrt{\frac{\sum_{i = 0}^{\text{15}}{\text{enr}_{\text{shb}}(i)}}{\text{16} \cdot \text{enr}_{\text{shb}}(i)}}\text{\ \ \ \ \ \ for\ }i = 0,\text{.}\text{.}\text{.},\text{15}$
(1594)

By applying the gain values, the temporal envelope of the high frequency
band signal is flattened:

$\text{syn}_{\text{scaled}^{\prime}}(t) = g_{\text{tfa}}(i) \cdot \text{syn}_{\text{scaled}}(t)\text{\ \ \ \ \ for\ }t = i \cdot l_{\text{subfr}_{\text{tec}}},\cdots,(i + 1) \cdot l_{\text{subfr}_{\text{tec}}} - 1\text{\ and\ }i = 0,\text{.}\text{.}\text{.},\text{15}$
(1595)

#####  6.1.5.1.15 Full-band synthesis

Four bits are decoded from the bitstream to obtain the energy
ratio${\hat{\phi}}_{\text{ratio}_{q}}$, and then calculate the
$\phi_{\text{ratio}}$ described as follows:

$\phi_{\text{ratio}} = 2^{{\hat{\phi}}_{\text{ratio}_{q}}}$ (1596)

Interpolate the signal
$s{\hat{\varepsilon}}_{\text{FB}}\left( n \right),n = 0,\text{.}\text{.}\text{.}\text{319}$
(see subclause 5.2.6.1.17) from 16 kHz to 48 kHz with zeros

$\text{sε}_{\text{FB}_{\text{48}}}(n) = \begin{matrix}
\left\{ 3\text{.}0 \ast s{\hat{\varepsilon}}_{\text{FB}}(n),\text{if}\text{mod}(n,3) = 0 \middle| \right.\  \\
\end{matrix}$ (1597)

The interpolated signal
$\text{sε}_{\text{FB}_{\text{48}}}\left( n \right),n = 0,\text{.}\text{.}\text{.}\text{959}$
passes through the bandpass filter and gets the
signal$s\varepsilon_{\text{FB}_{\text{48}}}^{'}\left( n \right),n = 0,\text{.}\text{.}\text{.}\text{959}$.
The calculation of the energy $\phi_{\text{FB}_{\text{48}}}$ is
described as follows:

$\phi_{\text{FB}_{\text{48}}} = \sum_{n = 0}^{\text{959}}{s\varepsilon_{\text{FB}_{\text{48}}}^{'}(n) \ast s\varepsilon_{\text{FB}_{\text{48}}}^{'}(n),n = 0,\text{.}\text{.}\text{.},\text{959}}$
(1598)

The energy $\phi_{\text{syn}}$of
$s{\hat{\varepsilon}}_{\text{FB}}\left( n \right),n = 0,\text{.}\text{.}\text{.}\text{319}$is
calculated as follows,

$\phi_{\text{syn}} = \sum_{n = 0}^{\text{319}}{s{\hat{\varepsilon}}_{\text{FB}}(n) \ast s{\hat{\varepsilon}}_{\text{FB}}(n)}$
(1599)

The synthesized full-band signal is calculated as follows,

$\text{sε}_{\text{FB}}(n) = s\varepsilon_{\text{FB}_{\text{48}}}^{'}(n) \ast \phi_{\text{ratio}} \ast \sqrt{\frac{\phi_{\text{syn}}}{\phi_{\text{FB}_{\text{48}}}}},n = 0,\text{.}\text{.}\text{.},\text{959}$
(1600)

#### 6.1.5.2 Multi-mode FD Bandwidth Extension decoding

The super higher band (SHB) signal for SWB signal or the higher band
(HB) signal for WB signal is adaptively decoded with multi-mode BWE
algorithm according to the result of the classification decision process
of the SHB or HB signal decoded from the received bitstream and a
determined excitation signal. In case of FB mode, the energy ratio of
the current frame is decoded, the full-band (FB) signal is synthesized
based upon the energy ratio or the envelope ratio calculated from low
band envelope and the generated SHB frequency excitations. Combining
with the low band signal decoded based on the received bitstream, the
output signal is obtained.

##### 6.1.5.2.1 SWB multi-mode FD BWE decoding

First of all, the SHB signal class of current frame is decoded. Then the
spectral envelopes or spectral/time envelopes are adaptively decoded
depending upon the decoded SHB signal class. Four spectral envelopes and
four time envelopes are decoded from the received bitstream for
TRANSIENT frames. For all of the other cases, i.e. NON-TRANSIENT frames,
fourteen spectral envelopes are decoded from the received bitstream and
no time envelope is decoded. Frequency excitations are then generated
according to the SHB signal class and finally, the super higher band
signal is synthesised based upon the signal class, the decoded envelopes
and generated frequency excitations.

##### 6.1.5.2.1.1 Decoding the multi-mode FD BWE signal class {#decoding-the-multi-mode-fd-bwe-signal-class .H6}

Two bits are decoded from the bitstream to obtain the SHB signal class
according to subclause 5.2.6.2.1.3.

##### 6.1.5.2.1.2 Decoding the spectral envelope {#decoding-the-spectral-envelope .H6}

In TRANSIENT frames, the envelope VQ indices
$\left\{ \text{idx}_{\text{env}_{1}},\text{idx}_{\text{Ierr}_{2}} \right\}$
are used to regenerate the synthesised signal envelope,

${\hat{f}}_{\text{rms}_{\text{SHB}}}(j) = \begin{matrix}
\left\{ \hat{e}\text{nv}_{1}(\left\lfloor \frac{j}{2} \right\rfloor)\text{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }\text{for}j = 0,2 \middle| \right.\ \left\{ \hat{I}\text{err}_{2}(0) + \frac{\hat{e}\text{nv}_{1}\left( 0 \right) + \hat{e}\text{nv}_{1}\left( 1 \right)}{2}\text{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }\text{for}j = 1 \middle| \right.\ \left\{ \middle| \right.\  \\
\end{matrix}$ (1601)

In Non-TRANSIENT frames, the envelope VQ indices
$\left\{ \text{idx}_{\text{env}_{1}},\text{idx}_{\text{err}_{\text{21}}},\text{idx}_{\text{err}_{\text{22}}},\text{idx}_{\text{Ierr}_{\text{31}}},\text{idx}_{\text{Ierr}_{\text{32}}} \right\}$
are used to generate the synthesised signal envelope,

$\begin{matrix}
{\hat{f}}_{\text{rms}_{\text{SHB}}}(j) = \\
\  \\
 \\
\end{matrix}\begin{matrix}
\left\{ \hat{e}\text{nv}_{1}(\left\lfloor \frac{j}{2} \right\rfloor) + \hat{e}\text{rr}_{2}(\left\lfloor \frac{j}{2} \right\rfloor)\text{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }\text{for}j = 0,2,4,6,8,\text{10},\text{12} \middle| \right.\ \left\{ \hat{I}\text{err}_{3}\left( \left\lfloor \frac{j - 1}{2} \right\rfloor \right) + \frac{\hat{e}\text{nv}_{1}\left( \left\lfloor \frac{j - 1}{2} \right\rfloor \right) + \hat{e}\text{rr}_{2}\left( \left\lfloor \frac{j - 1}{2} \right\rfloor \right) + \hat{e}\text{nv}_{1}\left( \left\lfloor \frac{j + 1}{2} \right\rfloor \right) + \hat{e}\text{rr}_{2}\left( \left\lfloor \frac{j + 1}{2} \right\rfloor \right)}{2}\text{for}j = 1,3,5,7,9,\text{11} \middle| \right.\ \left\{ \middle| \right.\  \\
\end{matrix}$(1601)

The final de-quantized envelope is then calculated:

$\begin{matrix}
{\hat{f}}_{\text{env}}(j) = \text{10}^{\left( {\hat{f}}_{\text{rms}_{\text{SHB}}}(j) + f_{\text{rms}_{\text{mean}}}(j) \right) \ast \text{fac}_{e}} \\
\text{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }\text{for}j = 0,\text{.}\text{.}\text{.},\text{13}(\text{Non}_{\text{TRANSIENT}})\text{\ \ OR\ j} = 0,1,2,3(\text{TRANSIENT}) \\
\end{matrix}$ (1602)

where ,

$\text{fac}_{e} = \begin{matrix}
\left\{ 0\text{.}\text{025}\text{\ \ \ \ \ \ \ \ \ \ }\text{for}\text{\ \ }\text{TRANSIENT} \middle| \right.\  \\
\end{matrix}$ (1603)

##### 6.1.5.2.1.3 Decoding the time envelope {#decoding-the-time-envelope .H6}

If the current frame is a TRANSIENT frame, then four bits are decoded to
obtain the index of each time envelope,
$t_{\text{rms}}^{'}\left( j \right)$. This envelope is converted into
the linear domain as follows:

${\hat{t}}_{\text{rms}}^{'}\left( j \right) = 2^{t_{\text{rms}}^{'}\left( j \right)}\ j = 0,\ldots,3$
(1604)

The linear domain time envelope of the previous sub-frame is preserved
as${\hat{t}}_{\text{rms}}^{}$. ${\hat{t}}_{\text{rms}}^{}$is set to zero
for the first frame. Time envelope de-normalization is performed after
the frequency domain processing in subclause 6.1.5.2.1.6.

##### 6.1.5.2.1.4 Windowing and time-to-frequency transformation {#windowing-and-time-to-frequency-transformation .H6}

640-point length MDCT is used for SWB FD BWE. Refer to subclause 5.3.2.

##### 6.1.5.2.1.5 Frequency excitation generation {#frequency-excitation-generation .H6}

The base frequency excitation signal
${\hat{X}}_{M_{\text{exc}_{\text{base}}}}(k)$ is generated from the
wideband MDCT coefficients ${\hat{X}}_{M_{\text{exc}_{\text{WB}}}}(k)$
of synthesized wideband signal or from random noise depending on the
decoded SHB signal class.

To Non-TRANSIENT frames, four parameters,
$E_{\text{FENV}} = \sum_{}^{}{{\hat{f}}_{\text{env}}\left( j \right)}/\text{SWB}_{\text{FENV}}$
,$\text{fenvL} = \sqrt{\sum_{}^{}{{\hat{X}}_{M_{\text{exc}_{\text{WB}}}}\frac{\left( j \right)^{2}}{\text{16}}}}$,
$E_{T} = \sqrt{\frac{\sum_{}^{}{{\hat{X}}_{M_{\text{exc}_{\text{WB}}}}\left( j \right)^{2}}}{\text{240}}}$,
and spectral tilt of WB signal are calculated. When
$E_{\text{FENV}} > \text{75}$ and $\text{fenvL} > \text{25}$, if one of
the condition: $F_{\text{FENV}} > E_{T}$,
$\text{tilt}_{\text{nb}} > 7\text{and}E_{\text{FENV}} > 0\text{.}5E_{T}$*,*
$\text{tilt}_{\text{nb}} > \text{12}$is satisfied, the fricative flag
$F_{\text{fractive}}$ is set to 1. It is noted that
parameter$F_{\text{fractive}}$ initialized to 0. It is calculated for
every frame and preserved as$F_{\text{fractive}}^{\lbrack - 1\rbrack}$.

> -- The base frequency excitation coefficients are obtained from the
> wideband MDCT coefficients:

${\hat{X}}_{M_{\text{exc}_{\text{base}}}}(k) = {\hat{X}}_{M_{\text{exc}_{\text{WB}}}}(k)\text{\ \ \ \ \ \ \ \ }k = 0,\text{.}\text{.}\text{.},K_{\text{cut}_{\text{off}}} - 1$
(1606)

> where $K_{\text{cut}_{\text{off}}}$is the cut-off spectrum bin of WB
> signal, and $K_{\text{cut}_{\text{off}}} = \text{246}$ at 13.2kbps and
> $K_{\text{cut}_{\text{off}}} = \text{320}$at 32kbps .
>
> -- If the current frame is a NOISE frame or $F_{\text{fractive}}$ is
> equal to 1, the base frequency excitation signal is generated from
> linear congruential uniform random noise generator as follows

${\hat{X}}_{M_{\text{exc}_{\text{base}}}}(K_{\text{cut}_{\text{off}}} + k) = S_{\text{noise}}(k)\text{\ \ \ \ \ \ \ \ }k = 0,\text{.}\text{.}\text{.},\text{319}$
(1607)

> where

$S_{\text{noise}}(k) = \frac{\lambda_{\text{seed}}}{\text{32768}}\text{\ \ \ \ and\ \ \ \ }\lambda_{\text{seed}} = \text{12345}\text{.}\lambda_{\text{seed}} + \text{20101}\text{\ \ \ \ \ \ \ \ }k = 0,\text{.}\text{.}\text{.},\text{319}$
(1608)

> Parameter $\lambda_{\text{seed}}$ is initialized as 21211 and updated
> for each MDCT coefficient. It should be noted that
> $S_{\text{noise}}(k)$ is calculated for every frame.
>
> -- Otherwise, the base frequency excitation signal is copied as
> defined in subclause 5.2.6.2.1.5 (Frequency mapping to generate base
> excitation spectrum in FD BWE).

##### 6.1.5.2.1.6 Frequency excitation normalization and spectral envelope de-normalization {#frequency-excitation-normalization-and-spectral-envelope-de-normalization .H6}

Firstly, the base frequency excitation signal or the spectral envelope
is adjusted depending upon the SHB signal class. Then the base frequency
excitation signal is adaptively normalized to remove the original low
frequency envelope information. Finally, the spectral envelopes are
applied to the normalized excitation signal.

If the current frame is NORMAL and the fricative flag
$F_{\text{fractive}}$ (as defined in subclause 6.1.5.2.1.5) is equal to
0, the spectral envelope and the base frequency excitation signal are
firstly adjusted. The spectral envelope is adjusted as follows:

$\begin{matrix}
{\hat{f}}_{\text{env}}(j + 1) = {\hat{f}}_{\text{env}}(j) \ast (0\text{.}8 + 0\text{.}\text{015} \cdot j)\text{\ \ \ \ }\text{if}{\hat{f}}_{\text{env}}(j + 1) < 0\text{.}9{\hat{f}}_{\text{env}}(j) \\
{\hat{f}}_{\text{env}}(j) = {\hat{f}}_{\text{env}}(j) \ast (0\text{.}8 + 0\text{.}\text{015} \cdot j)\text{\ \ \ \ \ \ \ \ \ }\text{if}{\hat{f}}_{\text{env}}(j) < 0\text{.}9{\hat{f}}_{\text{env}}(j + 1) \\
\end{matrix}$ (1609)

where $j = 0,\text{.}\text{.}\text{.},\text{12}$.

And the base frequency excitation signal is adjusted.

> -- while weighting factor $R_{1}$ is smaller than 1, the base
> frequency excitation
> ${\hat{X}}_{M_{\text{exc}_{\text{base}}}}(k),k = \text{St}_{\text{dst},\text{FD}}(1)$
> is adjusted by multiplying by $R_{1}$, $R_{1}$ is then increased by
> 0.1 and the index $k$is then incremented by 1.
>
> where, weighting factor $R_{1}$ is initialized as follows:

$R_{1} = \text{max}\left( \frac{\left| {\hat{X}}_{M_{\text{exc}_{\text{base}}}}\left( \text{St}_{\text{dst},\text{FD}}(1) - 3 \right) \right| + \left| {\hat{X}}_{M_{\text{exc}_{\text{base}}}}\left( \text{St}_{\text{dst},\text{FD}}(1) - 2 \right) \right| + \varepsilon}{\left| {\hat{X}}_{M_{\text{exc}_{\text{base}}}}\left( \text{St}_{\text{dst},\text{FD}}(1) \right) \right| + \left| {\hat{X}}_{M_{\text{exc}_{\text{base}}}}\left( \text{St}_{\text{dst},\text{FD}}(1) + 1 \right) \right| + \varepsilon},0\text{.}3 \right)$
(1610)

> where $\text{St}_{\text{dst},\text{FD}}(1)$ is defined in subclause
> 5.2.6.2.1.5.
>
> -- while weighting factor $R_{2}$ is larger than 1, the base frequency
> excitation
> ${\hat{X}}_{M_{\text{exc}_{\text{base}}}}(k),k = \text{St}_{\text{dst},\text{FD}}(1) - 1$
> is adjusted by multiplying by $R_{2}$, $R_{2}$ is then decreased by
> 0.5 and the index $k$ is then decremented by 1.
>
> where, weighting factor $R_{2}$ is initialized as follows:

$R_{2} = \text{min}\left( \frac{\left| {\hat{X}}_{M_{\text{exc}_{\text{base}}}}\left( \text{St}_{\text{dst},\text{FD}}(1) \right) \right| + \left| {\hat{X}}_{M_{\text{exc}_{\text{base}}}}\left( \text{St}_{\text{dst},\text{FD}}(1) + 1 \right) \right| + \varepsilon}{\left| {\hat{X}}_{M_{\text{exc}_{\text{base}}}}\left( \text{St}_{\text{dst},\text{FD}}(1) - 3 \right) \right| + \left| {\hat{X}}_{M_{\text{exc}_{\text{base}}}}\left( \text{St}_{\text{dst},\text{FD}}(1) - 2 \right) \right| + \varepsilon},5 \right)$
(1611)

> -- while weighting factor $R_{3}$ is larger than 1, the base frequency
> excitation
> ${\hat{X}}_{M_{\text{exc}_{\text{base}}}}(k),k = \text{St}_{\text{dst},\text{FD}}(2)$
> is adjusted by multiplying by $R_{3}$, $R_{3}$ is then increased by
> 0.1 and the index $k$ is then incremented by 1.
>
> where, weighting factor$R_{3}$ is initialized as follows:

$R_{3} = \text{max}\left( \frac{\sum_{j = 1}^{4}\left| {\hat{X}}_{M_{\text{exc}_{\text{base}}}}\left( \text{St}_{\text{dst},\text{FD}}(2) - j \right) \right| + \varepsilon}{\left| {\hat{X}}_{M_{\text{exc}_{\text{base}}}}\left( \text{St}_{\text{dst},\text{FD}}(2) \right) \right| + \left| {\hat{X}}_{M_{\text{exc}_{\text{base}}}}\left( \text{St}_{\text{dst},\text{FD}}(2) + 1 \right) \right| + \varepsilon},0\text{.}3 \right)$
(1612)

> and $\text{St}_{\text{dst},\text{FD}}(2)$ is defined in subclause
> 5.2.6.2.1.5.
>
> -- while weighting factor $R_{4}$ is larger than 1, the base frequency
> excitation
> ${\hat{X}}_{M_{\text{exc}_{\text{base}}}}(k),k = \text{St}_{\text{dst},\text{FD}}(2) - 1$
> is adjusted by multiplying by $R_{4}$, and then $R_{4}$ is multiplied
> by 0.95 and the index $k$ is decremented by 1.
>
> where, weighting factor $R_{4}$ is initialized as follows:

$R_{4} = 0\text{.}5 \cdot \frac{\left| {\hat{X}}_{M_{\text{exc}_{\text{base}}}}\left( \text{St}_{\text{dst},\text{FD}}(2) \right) \right| + \left| {\hat{X}}_{M_{\text{exc}_{\text{base}}}}\left( \text{St}_{\text{dst},\text{FD}}(2) + 1 \right) \right| + \varepsilon}{\sum_{j = 1}^{4}{\left| {\hat{X}}_{M_{\text{exc}_{\text{base}}}}\left( \text{St}_{\text{dst},\text{FD}}(1) - j \right) \right| + \varepsilon}}$
(1613)

Otherwise, there is no need to adjust the base frequency signal.

${\hat{X}}_{M_{\text{exc}_{\text{ad}}}1}(k) = {\hat{X}}_{M_{\text{exc}_{\text{base}}}}(k)\text{\ \ \ \ }k = K_{\text{cut}_{\text{off}}},\text{.}\text{.}\text{.},K_{\text{cut}_{\text{off}}} + \text{319}$
(1614)

In order to normalize the base frequency excitation, the parameter of
adaptive normalization length $L_{\text{norm}}$ is calculated depending
on the decoded SHB signal class and the wideband MDCT coefficients:

> -- The 256 wideband MDCT coefficients in the 0-6400 Hz frequency
> range,
> ${\hat{X}}_{M_{\text{exc}_{\text{WB}}}}(k),k = 0,\text{.}\text{.}\text{.},\text{255}$
> are split into 16 sharpness bands (16 coefficients per band). In
> sharpness band *j*, if
> $\text{23}A_{\text{sharp}}(j) > 8\sum_{}^{}\left| {\hat{X}}_{M_{\text{exc}_{\text{WB}}}}(k) \right|$
> and $A_{\text{sharp}}(j) > \text{10}$, the counter $C_{\text{band}}$
> is incremented by one.
>
> where $j = 0,\text{.}\text{.}\text{.},\text{15}$, and the maximum
> magnitude of the spectral coefficients in a sharpness band, denoted
> $A_{\text{sharp}}(j)$, is:

$A_{\text{sharp}}(j) = \underset{k = \text{16}j,\text{.}\text{.}\text{.},\text{16}j + \text{15}}{\text{max}}\left| {\hat{X}}_{M_{\text{exc}_{\text{WB}}}}(k) \right|\text{\ \ \ \ \ \ \ \ \ \ \ \ }j = 0,\text{.}\text{.}\text{.},\text{15}$
(1615)

> Parameter $C_{\text{band}}$ is initialized to 0 and calculated for
> every frame.
>
> -- Then the normalization length $L_{\text{norm}}$ is obtained:

$L_{\text{norm}} = \left\lfloor 0\text{.}5L_{\text{norm}_{\text{pre}}} + 0\text{.}5L_{\text{norm}_{\text{cur}}} \right\rfloor$
(1616)

> where the current normalization length $L_{\text{norm}_{\text{cur}}}$
> is calculated depending on the SHB signal class:

$L_{\text{norm}_{\text{cur}}} = \begin{matrix}
(\left\lfloor 4 + 0\text{.}\text{25}C_{\text{band}} \right\rfloor\ \text{if}\text{mode} = \text{TRANSIENT} \\
(\left\lfloor 8 + 0\text{.}5C_{\text{band}} \right\rfloor\ \text{if}\text{mode} = \text{NORMAL} \\
(\text{max}\left( \left\lfloor \text{32} + 2C_{\text{band}} \right\rfloor,\text{24} \right)\text{if}\text{mode} = \text{HARMONIC} \\
\end{matrix}($ (1617)

and the current normalization length is preserved as
$L_{\text{norm}_{\text{pre}}}$.

When the current frame is not NOISE and the fricative flag
$F_{\text{fractive}}$ is equal to 0, the noise content of the base
frequency excitation signal should be generated, and the base frequency
excitation signal should be normalized to remove the core envelope
information. The above algorithm is according to the adaptive
normalization length $L_{\text{norm}}$.

The normalization envelopes are firstly calculated:

$f_{\text{rms}_{\text{norm}}}(k) = \begin{matrix}
\left\{ \sum_{j = k - \left\lfloor \frac{L_{\text{norm}}}{2} \right\rfloor}^{k + \left\lfloor (L_{\text{norm}} - 1\frac{)}{2} \right\rfloor}\left| {\hat{X}}_{M_{\text{exc}_{\text{ad}}}1}(j) \right|\text{\ \ \ \ \ \ \ \ }K_{\text{cut\_off}}k < K_{\text{cut\_off}} + \text{319} - \left\lfloor L_{\text{norm}}2 \right\rfloor \middle| \right.\  \\
\end{matrix}$ (1618)

Then the signs and the amplitudes of the base frequency excitation
signal are calculated by:

$\text{sign}(k) = \text{sgn}\left( {\hat{X}}_{M_{\text{exc}_{\text{ad}}}1}(k) \right)\text{\ \ \ \ \ \ \ \ }K_{\text{cut}_{\text{off}}} \leq k < K_{\text{cut}_{\text{off}}} + \text{320}$
(1619)

$\text{amplitude}(k) = \left| {\hat{X}}_{M_{\text{exc}_{\text{ad}}}1}(k) \right|\text{\ \ \ \ \ \ \ \ }K_{\text{cut}_{\text{off}}} \leq k < K_{\text{cut}_{\text{off}}} + \text{320}$
(1620)

The adjusted coefficients are obtained by the amplitudes, the
normalization envelopes and adaptive normalization length:

${\hat{X}}_{M_{\text{exc}_{\text{ad}}}2}(k) = \text{amplitude}(k) - \frac{f_{\text{rms}_{\text{norm}}}(k)}{L_{\text{norm}}}\text{\ \ \ \ \ \ \ \ }K_{\text{cut}_{\text{off}}} \leq k < K_{\text{cut}_{\text{off}}} + \text{320}$
(1621)

If ${\hat{X}}_{M_{\text{exc}_{\text{ad}}}2}(k) > 0$, the adjusted
coefficients are further modified by the modification factor $W_{1}$,
and then the base frequency excitation signal with the noise content is
obtained by the signs and the adjusted coefficients:

${\hat{X}}_{M_{\text{exc}_{\text{norm}}}}(k) = \begin{matrix}
\left\{ \text{sign}(k) \cdot (1\text{.}2 - W_{1}) \cdot {\hat{X}}_{M_{\text{exc}_{\text{ad}}}2}(k)\text{\ \ \ \ \ \ \ \ }\text{if}{\hat{X}}_{M_{\text{exc}_{\text{ad}}}2}(k) > 0 \middle| \right.\  \\
\end{matrix}$ (1622)

$W_{1}$ is the modification factor and can be determined as

$W_{1} = 0\text{.}4W_{\text{cur}} + 0\text{.}6W_{\text{pre}}$ (1623)

where, $W_{\text{cur}} = 0\text{.}\text{25}$ for HARMONIC frame,
otherwise,
$W_{\text{cur}} = \text{max}(\text{min}(3/L_{\text{norm}},0\text{.}5),0\text{.}\text{25})$,
and $W_{1}$ is preserved for the next frame.

The normalized frequency excitation is obtained by removing the core
envelope information:

${\hat{X}}_{M_{\text{exc}}}\left( k \right) = \begin{matrix}
\left\{ \frac{{\hat{X}}_{M_{\text{exc}_{\text{ad}}}1}\left( k \right)}{f_{\text{rms}_{\text{norm}}}\left( k \right)}\text{for}\text{TRANSIENT}\text{frame} \middle| \right.\  \\
\end{matrix}$ (1624)

where
$k = K_{\text{cut}_{\text{off}}},\text{.}\text{.}\text{.},K_{\text{cut}_{\text{off}}} + \text{319}$.

Finally, the spectral envelope is applied to the normalized excitation
signal to obtain the SHB coefficients.

> -- For TRANSIENT frames, it is achieved as follows:

${\hat{X}}_{M_{\text{SWB}}}^{\text{SWB}}(k) = {\hat{X}}_{M_{\text{exc}}}(k) \cdot {\hat{f}}_{\text{env}}(j)\sqrt{\frac{N_{\text{swbcf}}(j)}{\left( \sum_{k = b_{\text{swb}}(j)}^{b_{\text{swb}}(j + 1) - 1}{{\hat{X}}_{M_{\text{exc}}}(k)^{2}} \right) + \varepsilon_{\text{rms}}}}$
(1625)

where
$K_{\text{cut}_{\text{off}}} + b_{\text{swb}}(j) \leq k < K_{\text{cut}_{\text{off}}} + b_{\text{swb}}(j + 1)$
and $j = 0,\text{.}\text{.}\text{.},3$.

> -- For non-TRANSIENT frames, if
> ${\hat{F}}_{\text{class}} = \text{HARMONIC}$ *AND*
> $\left| {\hat{X}}_{M_{\text{exc}}}(k) \right| < \frac{1}{\text{16}}\sum_{}^{}\left| {\hat{X}}_{M_{\text{exc}}}(k) \right|$,
> $K_{\text{cut}_{\text{off}}} + \text{16}j \leq k \leq K_{\text{cut}_{\text{off}}} + \text{16}j + \text{15}$
> and $j = 0,\text{.}\text{.}\text{.},\text{18}$, the frequency signal
> is multiplied by 0.2:

${\hat{X}}_{M_{\text{exc}_{\text{temp}}}}(k) = 0\text{.}2 \cdot {\hat{X}}_{M_{\text{exc}}}(k)$
(1626)

> Otherwise, there is no adjustment.

${\hat{X}}_{M_{\text{exc}_{\text{temp}}}}(k) = {\hat{X}}_{M_{\text{exc}}}(k)$
(1627)

> Then the MDCT coefficients of the reconstructed SHB signal are further
> adaptively adjusted with different modes:

${\hat{X}}_{M_{\text{SWB}_{\text{temp}}}}(k) = {\hat{X}}_{M_{\text{exc}_{\text{temp}}}}(k) \cdot \sqrt{\frac{b_{\text{swb}}(j + L) - b_{\text{swb}}(j)}{\left( \sum_{k = K_{\text{cut}_{\text{off}}} + b_{\text{swb}}(j)}^{K_{\text{cut}_{\text{off}}} + b_{\text{swb}}(j + L) - 1}{{\hat{X}}_{M_{\text{exc}_{\text{temp}}}}(k)^{2}} \right) + \varepsilon_{\text{rms}}}}$
(1628)

> where $L = 1$ for NOISE or NORMAL frame and $L = 2$for HARMONIC frame,
> $K_{\text{cut}_{\text{off}}} + b_{\text{swb}}(j) \leq k < K_{\text{cut}_{\text{off}}} + b_{\text{swb}}(j + 1)$
> and the index $j$ is incremented by $L$ if $j$ is smaller than 14.

The weighted envelopes $W_{\text{fenv}}(j)$ are obtained from the
spectral envelopes of the current frame and the previous frame:

$W_{\text{fenv}}(j) = W_{2} \cdot {\hat{f}}_{\text{env}}^{\lbrack - 1\rbrack}(j) + (1 - W_{2}) \cdot {\hat{f}}_{\text{env}}(j)\text{\ \ \ \ \ \ \ \ }j = 0,\text{.}\text{.}\text{.},\text{13}$
(1629)

> where,

$W_{2} = \begin{matrix}
\left\{ 0\text{.}5 \cdot \frac{E_{T}}{E_{T}^{\lbrack - 1\rbrack}}\text{if}\frac{E_{T}^{\lbrack - 1\rbrack}}{E_{T}} > 1\text{.}\text{25} \middle| \right.\  \\
\end{matrix}$ (1630)

> and
> $E_{T} = \sqrt{\sum_{}^{}{{\hat{X}}_{M_{\text{exc}_{\text{WB}}}}(j\frac{)^{2}}{\text{240}}}}$is
> calculated for every frame and preserved as the previous
> energy$E_{T}^{\lbrack - 1\rbrack}$for the next frame.
>
> The index *k* is initialized to 0, and four weighting factors,
> $W_{\text{fac}1} = \sqrt{1/\text{16}\sum_{}^{}{{\hat{X}}_{M_{\text{exc}_{\text{WB}}}}\left( j \right)^{2}}}$,
> $W_{\text{fac}2} = 0\text{.}\text{125} \cdot \left( W_{\text{fenv}}(0) - W_{\text{fac}1} \right)$,
> $W_{\text{fac}3}(j) = {\hat{f}}_{\text{env}}(j),\text{\ \ 0} \leq j < \text{13}$,
> $W_{\text{fac}4}(j) = \text{smooth}_{\text{fac}}(j) \cdot \left( W_{\text{fenv}}\left( j + 1 \right) - {\hat{f}}_{\text{env}}\left( j \right) \right),\ 0 \leq j < \text{13}$
> , are calculated. The smoothing factor
> $\text{smooth}_{\text{fac}}(j)$is defined in table 162.

Table 162: Smoothing factor $\text{smooth}_{\text{fac}}(j)$

  ----- ------------------
  *j*   Smoothing factor
  0     0.05
  1     0.05
  2     0.05
  3     0.05
  4     0.05
  5     0.05
  6     0.05
  7     0.0417
  8     0.0417
  9     0.0417
  10    0.0417
  11    0.03125
  12    0.03125
  ----- ------------------

> While the index *k* is smaller than 8, the frequency excitation
> ${\hat{X}}_{M_{\text{SWB}_{\text{temp}}}}(K_{\text{cut}_{\text{off}}} + k)$
> is adjusted by multiplying $W_{\text{fac}1}$, and then the index *k*
> is incremented by 1, and $W_{\text{fac}1}$ is increased by adding
> $W_{\text{fac}2}$.
>
> In the$j^{\text{th}}$ sub-band $0 \leq j < \text{13}$, while the index
> *k* is smaller than $b_{\text{swb}}(j + 1)$, the frequency excitation
> ${\hat{X}}_{M_{\text{SWB}_{\text{temp}}}}(K_{\text{cut}_{\text{off}}} + k)$
> is adjusted by multiplying by $W_{\text{fac}3}(j)$, and then, the
> index *k* is incremented by 1, and $W_{\text{fac}3}(j)$ is increased
> by adding $W_{\text{fac}4}(j)$.
>
> In the 13^th^ sub-band, while the *k* is smaller than
> $b_{\text{swb}}(\text{14})$, the frequency excitation
> ${\hat{X}}_{M_{\text{SWB}_{\text{temp}}}}(K_{\text{cut}_{\text{off}}} + k)$
> is adjusted by multiplying by$W_{\text{fenv}}(\text{13})$, and then,
> the index *k* is incremented by 1.
>
> The frequency excitation ${\hat{X}}_{M_{\text{SWB}_{\text{temp}}}}(k)$
> is adjusted by the weighted spectral envelopes to obtain the final SHB
> frequency signal
> ${\hat{X}}_{M_{\text{SWB}}}^{\text{SWB}}(k)$,$K_{\text{cut}_{\text{off}}} \leq k < K_{\text{cut}_{\text{off}}} + \text{320}$.

It should be noted that, for Non-TRANSIENT frames, the spectral
envelopes of current frame are preserved as
${\hat{f}}_{\text{env}}^{\lbrack - 1\rbrack}(j)$. For TRANSIENT frame,
the spectral envelope is calculated and preserved:

${\hat{f}}_{\text{env}}^{\lbrack - 1\rbrack}\left( j \right) = \begin{matrix}
\left\{ {\hat{f}}_{\text{env}}\left( \frac{j}{4} \right)^{2}\text{for}j = 0,\text{.}\text{.}\text{.},7 \middle| \right.\  \\
\end{matrix}$ (1631)

Further adjustment is performed by:

${\hat{X}}_{M_{\text{SWB}}}^{\text{SHB}}(K_{\text{cut}_{\text{off}}} + k) = 0\text{.}5 \cdot {\hat{X}}_{M_{\text{SWB}}}^{\text{SHB}}(K_{\text{cut}_{\text{off}}} + k)\text{\ \ \ \ }0 \leq k < 4$
(1632)

##### 6.1.5.2.1.7 Windowing and frequency-to-time transformation {#windowing-and-frequency-to-time-transformation .H6}

640-point length inverse MDCT is used for SWB FD BWE. Refer to subclause
6.2.4.

##### 6.1.5.2.1.8 Time domain post-processing {#time-domain-post-processing .H6}

The SHB synthesis signal is adjusted depending upon the SHB class.

-- If the current frame is TRANSIENT, the SHB synthesis signal in time
domain is adjusted by the time envelopes to match the transient
characteristics of the original signal.

> The 640 SHB synthesized samples
> ${\hat{s}}_{\text{SHB}}^{'}\left( n \right),0 \leq n < \text{640}$ are
> divided into 4 sub-frames, and the energy of each sub-frame is
> calculated:

$E_{\text{SHB}}(j) = \sqrt{\frac{1}{\text{160}}\sum_{n = \text{160}j}^{\text{160}j + \text{159}}\left( {\hat{s}}_{\text{SHB}}^{'}\left( n \right) \right)^{2}}0 \leq j < 4$
(1633)

next, the time envelope is adjusted:

${\hat{t}}_{\text{env}}(j) = \begin{matrix}
\left\{ E_{\text{SHB}}(j)\text{if}E_{\text{SHB}}(j) < 0\text{.}8 \ast {\hat{t}}_{\text{rms}}^{'}(j) < 2 \middle| \right.\  \\
\end{matrix}$ (1634)

and finally, the SHB synthesis signal is adjusted as follows:

${\hat{s}}_{\text{SHB}}\left( n \right) = {\hat{s}}_{\text{SHB}}^{'}\left( n \right) \ast {\hat{t}}_{\text{env}}(j)/E_{\text{SHB}}(j)$
(1635)

where, $\text{160}j \leq n \leq \text{160}j + \text{159}$and
$0 \leq j < 4$.

In this case, the value of ${\hat{t}}_{\text{env}}(3)$is preserved for
the next frame.

$E_{\text{td}_{\text{energy}}}^{\lbrack - 1\rbrack} = {\hat{t}}_{\text{env}}(3)$
(1636)

-- Else if fricative flag$F_{\text{fractive}}$ defined in subclause
6.1.5.2.1.5 is equal to 1 and the previous fricative
flag$F_{\text{fractive}}^{\left\lbrack - 1 \right\rbrack}$is equal to 0,
pre-echo reduction is performed and the preserved time-domain energy is
updated.

Firstly, the 640 ACELP core synthesized samples,
${\hat{s}}_{\text{ACELP}}\left( n \right),0 \leq n < \text{640}$ are
divided into 4 sub-frames, and the energy of each sub-frame is
calculated:

$E_{\text{ACELP}}^{\lbrack j\rbrack} = \sqrt{\frac{1}{\text{160}}\sum_{n = \text{160}j}^{\text{160}j + \text{159}}\left( {\hat{s}}_{\text{ACELP}}\left( n \right) \right)^{2}}0 \leq j < 4$
(1637)

In *j*^th^ sub-frame, if
$E_{\text{ACELP}}^{\lbrack j + 1\rbrack} > 1\text{.}8 \cdot E_{\text{ACELP}}^{\lbrack j\rbrack}$and
$E_{\text{ACELP}}^{\lbrack j + 1\rbrack} > \text{50}$, the position is
introduced to separate 4 sub-frames into two parts and it is initialized
as 0: $\text{pos} = \begin{matrix}
\left\{ j + 1\text{for}j = 2 \middle| \right.\  \\
\end{matrix}$ (1638)

Next, if $\text{pos} > 2$, the SHB synthesis signal is adjusted.

${\hat{s}}_{\text{SHB}}\left( n \right) = \begin{matrix}
\left\{ {\hat{s}}_{\text{SHB}}^{'}\left( n \right) \cdot \frac{E_{\text{td}_{\text{energy}}}^{\left\lbrack - 1 \right\rbrack}}{E_{\text{td}_{\text{energy}}1}}\text{for}0 \leq n < \text{160} \cdot \text{pos} \middle| \right.\  \\
\end{matrix}$ (1639)

where, $E_{\text{td}_{\text{energy}}1}$ and
$E_{\text{td}_{\text{energy}}2}$ are the energies of the SHB synthesized
samples
${\hat{s}}_{\text{SHB}}^{'}\left( n \right),0 \leq n < \text{160} \cdot \text{pos}$
and the energy of SHB synthesized samples
${\hat{s}}_{\text{SHB}}^{'}\left( n \right),\text{160} \cdot \text{pos} \leq n < \text{160} \cdot (\text{pos} + 1)$.
$E_{\text{td}_{\text{energy}}}^{\left\lbrack - 1 \right\rbrack}$ is the
energy value from the previous frame, and
if$E_{\text{td}_{\text{energy}}}^{\left\lbrack - 1 \right\rbrack} < 0\text{.}2 \cdot E_{\text{td}_{\text{energy}}1}$,
the value of
$E_{\text{td}_{\text{energy}}}^{\left\lbrack - 1 \right\rbrack}$ is
updated to $E_{\text{td}_{\text{energy}}1}$.

-- Otherwise the energy is calculated and preserved for next frame:

$E_{\text{td}_{\text{energy}}}^{\left\lbrack - 1 \right\rbrack} = \sqrt{\frac{1}{\text{160}}\sum_{n = \text{480}}^{\text{639}}\left( {\hat{s}}_{\text{SHB}}^{'}\left( n \right) \right)^{2}}$
(1640)

##### 6.1.5.2.2 WB multi-mode FD BWE decoding

The HB signal class and the spectral envelopes are decoded (at 13.2kbps)
or predicted (at 7.2/8kbps), and the frequency excitations are generated
from the decoded low-band synthesized signal or from random noise, and
then the frequency excitations are adjusted along with the signal class
and decoded or predicted spectral envelopes to obtain the higher band
signal.

##### 6.1.5.2.2.1 Decoding the multi-mode FD BWE signal class {#decoding-the-multi-mode-fd-bwe-signal-class-1 .H6}

At 13.2kbps, one bit is decoded from bitstream to get the HB signal
class according to subclause 5.2.6.2.2.2. And at 7.2kbps or 8kbps, the
HB signal class is set to NORMAL.

##### 6.1.5.2.2.2 Windowing and time-to-frequency transformation {#windowing-and-time-to-frequency-transformation-1 .H6}

320-point MDCT is used for WB FD BWE. Refer to subclause 5.3.2.

##### 6.1.5.2.2.3 Decoding the spectral envelope {#decoding-the-spectral-envelope-1 .H6}

At 13.2kbps, five bits are decoded to obtain the index of spectral
envelope, ${\hat{k}}_{\text{ind}}$. This envelope is converted into the
linear domain as follows:

${\hat{f}}_{\text{env}_{\text{WB}}}\left( j \right) = 2^{0\text{.}5 \cdot \text{codebook}_{\text{HB}}(2 \cdot {\hat{k}}_{\text{ind}} + j)}\ j = 0,1$
(1641)

where $\text{codebook}_{\text{HB}}(k)$ is defined in subclause
5.2.6.2.2.3.

The average BWE signal envelope of the current frame at 13.2kbps is
preserved for the envelope estimation for 7.2kbps and 8kbps when
bit-rate switching from 13.2kbps to 7.2 or 8kbps, as described as
follows:

${\hat{f}}_{\text{env}_{\text{WB}_{\text{av}}}}^{\lbrack - 1\rbrack} = 0\text{.}5\left( {\hat{f}}_{\text{env}_{\text{WB}}}(0) + {\hat{f}}_{\text{env}_{\text{WB}}}(1) \right)$
(1642)

At 7.2kbps or 8kbps, the spectral envelope is predicted in the decoder.
If the extended layer of the previous frame is different from the one of
current frame, that is,
$M_{\text{last}_{\text{extl}}}! = \text{WB}_{\text{BWE}}$, the preserved
spectral envelope
$f_{\text{env}_{\text{WB}}}^{\lbrack - 1\rbrack}(j),j = 0,1$ are set to
0. In order to get the predicted spectral envelope, two bands
$\lbrack\text{128},\text{191}\rbrack$and$\lbrack\text{192},\text{255}\rbrack$are
firstly selected. Then three average energies are needed based on the
frequency coefficients in the above two bands. Finally, the spectral
envelopes used for the following frequency adjustment are obtained. In
order to decrease the complexity, the energies are calculated with the
MDCT coefficients
${\hat{X}}_{M_{\text{core}_{\text{dec}}}}(k),0 \leq k < \text{256}$:

$E_{L} = \sum_{k = \text{128}}^{\text{191}}\left( {\hat{X}}_{M_{\text{core}_{\text{dec}}}}\left( k \right) \right)^{2}$
(1643)

$f_{\text{env}_{\text{WB}}}(0) = \sum_{k = \text{192}}^{\text{223}}\left( {\hat{X}}_{M_{\text{core}_{\text{dec}}}}(k) \right)^{2}$
(1644)

$f_{\text{env}_{\text{WB}}}(1) = \sum_{k = \text{224}}^{\text{255}}\left( {\hat{X}}_{M_{\text{core}_{\text{dec}}}}(k) \right)^{2}$
(1645)

Two
factors$\text{voice}_{\text{fac}} = \sum_{}^{}{\text{voice}_{\text{factor}}(j)}$,
$T_{\text{sum}} = \sum_{}^{}{\text{pitch}(j)}$, are calculated. When
$E_{L} < \text{16} \cdot \text{max}\left( f_{\text{env}_{\text{WB}}}(0),f_{\text{env}_{\text{WB}}}(1) \right)$
and $T_{\text{sum}} < \text{308}$, the energy variation flag
$F_{\text{ener}\text{\_var}}$ is set to 1. It should be noted that
$F_{\text{ener}\text{\_var}}$ is initialized to 0 and calculated for
every frame.

Then the weighting factor $\alpha_{1}$is initialized to 1, and updated
according to the spectral envelope and code type$\text{CT}$:

$\alpha_{1} = \begin{matrix}
\left\{ \text{max}\left( 2 \cdot \frac{f_{\text{env}_{\text{WB}}}(1)}{f_{\text{env}_{\text{WB}}}(0)},0\text{.}1 \right)\ \text{if}f_{\text{env}_{\text{WB}}}(0) > 2 \cdot f_{\text{env}_{\text{WB}}}(1) \middle| \right.\  \\
\end{matrix}$ (1646)

and the spectral envelope is accordingly adjusted by:

$f_{\text{env}_{\text{WB}_{\text{ad}}}1}(0) = \begin{matrix}
\left\{ \alpha_{1} \cdot f_{\text{env}_{\text{WB}}}(0)\text{\ \ \ \ \ \ \ \ \ \ \ \ }\text{if}\text{\ f}_{\text{env\_WB}}(0) > 2 \cdot f_{\text{env\_WB}}(1) \middle| \right.\  \\
\end{matrix}$ (1647)

$f_{\text{env}_{\text{WB}_{\text{ad}}}1}(1) = \begin{matrix}
\left\{ \alpha_{1} \cdot f_{\text{env}_{\text{WB}}}(1)\text{\ \ \ \ \ \ \ \ }\text{if\ \ f}_{\text{env}_{\text{WB}}}(1) > 2 \cdot f_{\text{env}_{\text{WB}}}(0)\text{\ AND\ CT}! = \text{UNVOICED} \middle| \right.\  \\
\end{matrix}$ (1648)

Next, the first envelope is further adjusted.

> -- The first envelope is firstly adjusted
> with$f_{\text{env}_{\text{WB}_{\text{ad}}}1}(j),j = 0,1$ by:

$f_{\text{env}_{\text{WB}_{\text{ad}}}2}(0) = \sqrt{(f_{\text{env}_{\text{WB}_{\text{ad}}}1}(0) + f_{\text{env}_{\text{WB}_{\text{ad}}}1}(1)\frac{)}{\text{64}}}$
(1649)

> -- If the conditions:
> $\text{CT}! = \text{AUDIO}$,$\text{CT}! = \text{UNVOICED}$, and
> $F_{\text{ener}\text{\_var}} = 0$, are all satisfied, the first
> envelope is adjusted by:

$f_{\text{env}_{\text{WB}_{\text{ad}}}3}(0) = 1\text{.}5 \cdot f_{\text{env}_{\text{WB}_{\text{ad}}}2}(0)$
(1650)

Otherwise, there is no adjustment.

$f_{\text{env}_{\text{WB}_{\text{ad}}}3}(0) = f_{\text{env}_{\text{WB}_{\text{ad}}}2}(0)$
(1651)

> -- If the conditions: $\text{CT}! = \text{TRANSITION}$,
> $\text{CT}! = \text{AUDIO}$ , $\text{CT}! = \text{UNVOICED}$,
> $\sqrt{E_{L}} > \text{40} \cdot f_{\text{env}_{\text{WB}_{\text{ad}}}3}(0)$,
> $\alpha_{1} > 0\text{.}9$, $F_{\text{adj}} = 0$, are all satisfied,
> the first envelope is adjusted as follows:

$f_{\text{env}_{\text{WB}_{\text{ad}}}4}(0) = \text{min}\left( 0\text{.}\text{025} \cdot \sqrt{E_{T}}/f_{\text{env}_{\text{WB}_{\text{ad}}}3}(0),4 \right) \cdot f_{\text{env}_{\text{WB}_{\text{ad}}}3}(0)$
(1652)

> and

$f_{\text{env}_{\text{WB}_{\text{ad}}}5}(0) = \begin{matrix}
\left\{ 0\text{.}3f_{\text{env}_{\text{WB}_{\text{ad}}}4}(0) + 0\text{.}7f_{\text{env}_{\text{WB}}}^{\lbrack - 1\rbrack}(0)\text{\ \ \ \ }\text{if}f_{\text{env}_{\text{WB}_{\text{ad}}}4}(0) > f_{\text{env}_{\text{WB}}}^{\lbrack - 1\rbrack}(0) \middle| \right.\  \\
\end{matrix}$ (1653)

> where, the adjustment flag$F_{\text{adj}}$is initialized to 0. If the
> coder type of current frame is equal to that of the previous frame and
> the first spectral envelope is larger than the envelope of the
> previous frame, that is,
> $\text{CT} = \text{CT}^{\lbrack - 1\rbrack}\text{\ \ AND\ \ f}_{\text{env}_{\text{WB}_{\text{ad}}}3}(0) > f_{\text{env}_{\text{WB}}}^{\lbrack - 1\rbrack}(0)$,
> the adjustment flag $F_{\text{adj}}$ is set to 1. The
> values$f_{\text{env}_{\text{WB}}}^{\lbrack - 1\rbrack}(j),j = 0,\text{.}\text{.}\text{.},1$
> are the spectral envelopes of the previous frame.

Otherwise, there is no adjustment.

$f_{\text{env}_{\text{WB}_{\text{ad}}}5}(0) = f_{\text{env}_{\text{WB}_{\text{ad}}}3}(0)$
(1654)

> -- If the conditions:
> $\sqrt{E_{L}} > \text{64} \cdot \text{min}(1\text{.}5\text{,max}(0\text{.}5,\text{77} \cdot \text{voice}_{\text{fac}}/T_{\text{sum}}) \cdot f_{\text{env}_{\text{WB}_{\text{ad}}}5}(0)$,
> $3 \cdot f_{\text{env}_{\text{WB}_{\text{ad}}}5}(0) \cdot f_{\text{env}_{\text{WB}_{\text{ad}}}5}(0) < \sqrt{E_{L}}$
> , $\text{CT}^{\lbrack - 1\rbrack}! = \text{UNVOICED}$, are all
> satisfied, the envelope variation flag $F_{\text{env}\text{\_var}}$
> initialized to 0 is set to 1, and the first envelope is adjusted as
> follows:

$f_{\text{env}_{\text{WB}_{\text{ad}}}6}(0) = \text{min}\left( 0\text{.}\text{015625} \cdot \sqrt{E_{T}}/f_{\text{env}_{\text{WB}_{\text{ad}}}5}(0),4 \right) \cdot f_{\text{env}_{\text{WB}_{\text{ad}}}5}(0)$
(1655)

and

$f_{\text{env}_{\text{WB}_{\text{ad}}}7}(0) = \begin{matrix}
\left\{ 0\text{.}3f_{\text{env}_{\text{WB}_{\text{ad}}}6}(0) + 0\text{.}7f_{\text{env}_{\text{WB}}}^{\lbrack - 1\rbrack}(0)\text{if}f_{\text{env}_{\text{WB}_{\text{ad}}}6}(0) > f_{\text{env}_{\text{WB}}}^{\lbrack - 1\rbrack}(0) \middle| \right.\  \\
\end{matrix}$ (1656)

Otherwise, there is no adjustment.

$f_{\text{env}_{\text{WB}_{\text{ad}}}7}(0) = f_{\text{env}_{\text{WB}_{\text{ad}}}5}(0)$
(1657)

> -- If the coder types of current frame or previous frame is UNVOICED,
> the first envelope is adjusted as follows:

$f_{\text{env}_{\text{WB}_{\text{ad}}}8}(0) = \begin{matrix}
\left\{ 0\text{.}5 \cdot f_{\text{env}_{\text{WB}_{\text{ad}}}7}(0)\text{\ \ \ \ }\text{if\ \ CT} = \text{UNVOICED\ \ or\ \ CT}^{\lbrack - 1\rbrack} = \text{UNVOICED} \middle| \right.\  \\
\end{matrix}$ (1658)

> -- If the coder types of current frame is not AUDIO, that is,
> $\text{CT}! = \text{AUDIO}$, the first envelope is adjusted as
> follows:

$\begin{matrix}
f_{\text{env}_{\text{WB}_{\text{ad}}}9}(0) = \\
\  \\
 \\
\end{matrix}\begin{matrix}
\left\{ f_{\text{env}_{\text{WB}_{\text{ad}}}8}(0) \cdot \text{min}(2,\text{max}(0\text{.}\text{125},T_{\text{sum}}/\text{400}))/\text{max}(1\text{.}2 \cdot \text{voice}_{\text{fac}},1\text{.}0)\text{if}\text{CT}! = \text{AUDIO} \middle| \right.\  \\
\end{matrix}$ (1659)

> -- If the last core bit-rate is larger than 8000, and the first
> spectral envelope is larger than the average BWE signal envelope of
> the previous frame, that is,
> $\text{last}_{\text{core}_{\text{bitrate}}} > \text{8000}\text{\ \ AND\ \ f}_{\text{env}_{\text{WB}_{\text{ad}}}9}(0) > f_{\text{env}_{\text{WB}_{\text{av}}}}^{\lbrack - 1\rbrack}$,
> the adjustment is by:

$f_{\text{env}_{\text{WB}_{\text{ad}}}\text{10}}(0) = 0\text{.}1 \cdot f_{\text{env}_{\text{WB}_{\text{ad}}}9}(0) + 0\text{.}9 \cdot {\hat{f}}_{\text{env}_{\text{WB}_{\text{av}}}}^{\lbrack - 1\rbrack}$
(1660)

Otherwise, there is no adjustment:

$f_{\text{env}_{\text{WB}_{\text{ad}}}\text{10}}(0) = f_{\text{env}_{\text{WB}_{\text{ad}}}9}(0)$
(1661)

> -- If the extended layer of the previous frame is different from the
> one of current frame, the adjustment is as follows:

$f_{\text{env}_{\text{WB}_{\text{ad}}}\text{11}}(0) = 0\text{.}5 \cdot f_{\text{env}_{\text{WB}_{\text{ad}}}\text{10}}(0)\text{\ \ \ \ if\ \ M}_{\text{last}_{\text{extl}}}! = \text{WB}_{\text{BWE}}$
(1662)

Otherwise, there is no adjustment:

$f_{\text{env}_{\text{WB}_{\text{ad}}}\text{11}}(0) = f_{\text{env}_{\text{WB}_{\text{ad}}}\text{10}}(0)$
(1663)

Finally, the spectral envelopes are adjusted as follows:

$f_{\text{env}_{\text{WB}_{\text{ad}}}2}(1) = \begin{matrix}
\left\{ 1\text{.}5 \cdot f_{\text{env}_{\text{WB}_{\text{ad}}}\text{11}}(0)\text{\ \ \ if\ }F_{\text{env}\text{\_var}} = 1 \middle| \right.\  \\
\end{matrix}$ (1664)

and

${\hat{f}}_{\text{env}_{\text{WB}}}(0) = \begin{matrix}
\left\{ 0\text{.}\text{75} \cdot f_{\text{env}_{\text{WB}_{\text{ad}}}\text{11}}(0)\text{\ \ \ if\ }F_{\text{env}\text{\_var}} = 1 \middle| \right.\  \\
\end{matrix}$ (1665)

${\hat{f}}_{\text{env}_{\text{WB}}}(1) = \begin{matrix}
\left\{ 0\text{.}5 \cdot f_{\text{env}_{\text{WB}_{\text{ad}}}2}(1)\text{if}\text{CT} = \text{UNVOICED}\text{OR}\text{CT}^{\lbrack - 1\rbrack} = \text{UNVOICED} \middle| \right.\  \\
\end{matrix}$ (1666)

The spectral envelopes${\hat{f}}_{\text{env}_{\text{WB}}}(j),j = 0,1$are
used for the following frequency adjustment.

##### 6.1.5.2.2.4 Frequency excitation generation {#frequency-excitation-generation-1 .H6}

The base frequency excitation
signal${\hat{X}}_{M_{\text{exc}_{\text{base}_{\text{WB}}}}}\left( k \right)$is
generated from the MDCT coefficients
${\hat{X}}_{M_{\text{core}_{\text{dec}}}}(k)$ of the core decoded signal
or from random noise depending upon the bit-rate and coder type
$\text{CT}$. The core type flag$F_{\text{core}_{\text{type}}}$is
introduced. It is initialized to 1, and is set to 0 if the coder type is
not AUDIO and the total bit-rate is not larger than 8000.

> -- The LF MDCT coefficients are obtained from the MDCT coefficients of
> core decoded signal:

${\hat{X}}_{M_{\text{exc}_{\text{base}_{\text{WB}}}}}(k) = {\hat{X}}_{M_{\text{core}_{\text{dec}}}}(k)\text{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }k = 0,\text{.}\text{.}\text{.},\text{239}$
(1667)

> -- If the coder type of current frame is UNVOICED, the base frequency
> excitation signal is generated from linear congruential uniform random
> noise generator as follows:

$\hat{X}(\text{240} + k) = S_{\text{noise}}(k)\text{\ \ \ \ \ \ \ \ \ \ \ \ }k = 0,\text{.}\text{.}\text{.},\text{79}$
(1668)

> where

$S_{\text{noise}}(k) = \frac{\lambda_{\text{seed}}}{\text{32768}}\text{\ \ \ \ and\ \ \ \ }\lambda_{\text{seed}} = \text{12345}\text{.}\lambda_{\text{seed}} + \text{20101}\text{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ k} = 0,\text{.}\text{.}\text{.},\text{79}$
(1669)

> Parameter $\lambda_{\text{seed}}$ is initialized as 21211 and updated
> for each MDCT coefficient. It is noted that $S_{\text{noise}}(k)$ is
> calculated for every frame.
>
> -- Otherwise, the base frequency excitation signal is copied as
> defined in subclause 5.2.6.2.1.5.

##### 6.1.5.2.2.5 Frequency excitation normalization and spectral envelope de-normalization {#frequency-excitation-normalization-and-spectral-envelope-de-normalization-1 .H6}

In order to normalize the base frequency excitation to remove the
original low frequency envelope information, the parameter of adaptive
normalization length $L_{\text{norm}}$ is calculated depending on the HB
signal class and the MDCT coefficients of core decoded signal:

> -- The 256 MDCT coefficients in the 0-6400 Hz frequency range,
> ${\hat{X}}_{M_{\text{core}_{\text{dec}}}}(k),k = 0,\text{.}\text{.}\text{.},\text{255}$
> are split into 16 sharpness bands (16 coefficients per band). In
> sharpness band *j*, if
> $\text{19} \cdot A_{\text{sharp}}\left( j \right) > 4\sum_{}^{}\left| {\hat{X}}_{M_{\text{core}_{\text{dec}}}}\left( k \right) \right|$
> and$A_{\text{sharp}}(j) > \text{10}$, the counter $C_{\text{band}}$is
> incremented by one.
>
> where $j = 0,\text{.}\text{.}\text{.},\text{15}$, and the maximum
> magnitude of the spectral coefficients in a sharpness band, denoted
> $A_{\text{sharp}}(j)$, is:

$A_{\text{sharp}}(j) = \underset{k = \text{16}j,\text{.}\text{.}\text{.},\text{16}j + \text{15}}{\text{max}}\left| {\hat{X}}_{M_{\text{core}_{\text{dec}}}}(k) \right|\text{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }j = 0,\text{.}\text{.}\text{.},\text{15}$
(1670)

> Parameter $C_{\text{band}}$ is initialized to 0 and calculated for
> every frame.
>
> -- Then the normalization length $L_{\text{norm}}$ is obtained:

$L_{\text{norm}} = \left\lfloor 0\text{.}5L_{\text{norm}_{\text{pre}}} + 0\text{.}5L_{\text{norm}_{\text{cur}}} \right\rfloor$
(1671)

> where the current normalization length $L_{\text{norm}_{\text{cur}}}$
> is calculated depending on the HB signal class:

$L_{\text{norm}_{\text{cur}}} = \begin{matrix}
(\left\lfloor 8 + 0\text{.}5C_{\text{band}} \right\rfloor\ \text{if}\text{mode} = \text{NORMAL} \\
(\text{max}\left( \left\lfloor \text{32} + 2C_{\text{band}} \right\rfloor,\text{24} \right)\ \text{if}\text{mode} = \text{HARMONIC} \\
\end{matrix}($ (1672)

and the current normalization length is preserved
as$L_{\text{norm}_{\text{pre}}}$.

Then, according to the adaptive normalization length, the noise content
of the base frequency excitation signal is generated, and the base
frequency excitation signal is normalized to remove the core envelope
information.

-   The normalized envelope is calculated:

$f_{\text{rms}_{\text{norm}}}(k) = \begin{matrix}
\left\{ \sum_{j = k - \left\lfloor \frac{L_{\text{norm}}}{2} \right\rfloor}^{k + \left\lfloor (L_{\text{norm}} - 1\frac{)}{2} \right\rfloor}\left| {\hat{X}}_{M_{\text{exc}_{\text{base}_{\text{WB}}}}}(j) \right|\text{\ \ \ \ \ \ \ \ }\text{240} \leq k < \text{319} - \left\lfloor L_{\text{norm}}2 \right\rfloor \middle| \right.\  \\
\end{matrix}$ (1673)

> -- If the bitrate is 7200 or 8000 and the coder type of current frame
> is not UNVOICED, the signs and amplitudes of HB coefficients are
> calculated by:

$\text{sign}(k) = \text{sgn}\left( {\hat{X}}_{M_{\text{exc}_{\text{base}_{\text{WB}}}}}(k) \right)\text{\ \ \ \ \ \ \ \ \ \ }\text{240} \leq k < \text{320}$
(1674)

$\text{amplitude}(k) = \left| {\hat{X}}_{M_{\text{exc}_{\text{base}_{\text{WB}}}}}(k) \right|\text{\ \ \ \ \ \ \ \ }\text{240} \leq k < \text{320}$
(1675)

> The adjusted coefficients are obtained by the amplitudes, the
> normalization envelopes and adaptive normalization length:

${\hat{X}}_{M_{\text{exc}_{\text{ad}}}}(k) = \text{amplitude}(k) - 0\text{.}\text{45} \cdot \frac{f_{\text{rms}_{\text{norm}}}(k)}{L_{\text{norm}}}\text{\ \ \ \ \ \ \ \ }\text{240} \leq k < \text{320}$
(1676)

> If ${\hat{X}}_{M_{\text{exc}_{\text{ad}}}}(k) > 0$, the adjusted
> coefficients are modified further by the modification factor $W_{1}$,
> and then the base frequency excitation signal with the noise content
> is obtained by the signs and the adjusted coefficients:

${\hat{X}}_{M_{\text{exc}_{\text{norm}}}}(k) = \begin{matrix}
\left\{ \text{sign}(k) \cdot (0\text{.}\text{55} - W_{1}) \cdot {\hat{X}}_{M_{\text{exc}_{\text{ad}}}}(k)\text{\ \ \ \ \ \ \ \ }\text{if\ \ \ \{}\hat{X} \middle| \middle| M_{\text{exc}_{\text{ad}}}(k) > 0 \middle| \right.\  \\
\end{matrix}$ (1677)

where, the modification factor $W_{1} = 0\text{.}\text{25}$ for HARMONIC
frame, otherwise,
$W_{1} = \text{max}(\text{min}(3/L_{\text{norm}},0\text{.}5),0\text{.}\text{25})$.

> -- Otherwise, there is no adjustment, that is,

${\hat{X}}_{M_{\text{exc}_{\text{norm}}}}\left( k \right) = {\hat{X}}_{M_{\text{exc}_{\text{base}_{\text{WB}}}}}(k)\text{240} \leq k < \text{320}$
(1678)

> -- Next, the adjusted frequency excitation signal is normalized to
> remove the core envelope information:

${\hat{X}}_{M_{\text{exc}_{\text{WB}_{\text{norm}}}}}\left( k \right) = \frac{{\hat{X}}_{M_{\text{exc}_{\text{norm}}}}\left( k \right)}{f_{\text{rms}_{\text{norm}}}\left( k \right)}\text{240} \leq k < \text{320}$
(1679)

> -- If the coder type of current frame is not UNVOICED, the frequency
> signal is adaptively adjusted further as follows:

${\hat{X}}_{M_{\text{exc}_{\text{WB}}}}\left( k \right) = \begin{matrix}
\left\{ {\hat{X}}_{M_{\text{exc}_{\text{WB}_{\text{norm}}}}}\left( k \right) \cdot \sqrt{\frac{\text{80}}{\left( \sum_{l = \text{240}}^{\text{319}}{{\hat{X}}_{M_{\text{exc}_{\text{WB}_{\text{nrom}}}}}\left( l \right)^{2}} \right) + \varepsilon_{\text{rms}}}}\text{for}\text{HARMONIC}\text{frame} \middle| \right.\ \left\{ {\hat{X}}_{M_{\text{exc}_{\text{WB}_{\text{norm}}}}}\left( k \right) \cdot \sqrt{\frac{N_{\text{swbc}}f(j)}{\left( \sum_{l = b_{\text{swb}}\left( j \right)}^{b_{\text{swb}}\left( j + 1 \right) - 1}{{\hat{X}}_{M_{\text{exc}_{\text{norm}}}}\left( l \right)^{2}} \right) + \varepsilon_{\text{rms}}}}\text{otherwise} \middle| \right.\  \\
\end{matrix}$ (1680)

where, $b_{\text{swb}}\left( j \right)$ and $N_{\text{swbc}}f(j)$,
$0 \leq j < 4$are defined in table 163.

Otherwise, there is no adjustment.

${\hat{X}}_{M_{\text{exc}_{\text{WB}}}}\left( k \right) = {\hat{X}}_{M_{\text{exc}_{\text{WB}_{\text{norm}}}}}\left( k \right)\text{for}\text{240} \leq k < \text{320}$
(1681)

Table 164: Sub-band boundaries and number of coefficients per sub-band
in NORMAL frames

  ----- ----- ----
  *j*         
  0     240   16
  1     256   24
  2     280   16
  3     304   24
  4     320   \-
  ----- ----- ----

Finally, the spectral envelope is applied to the normalized excitation
signal to obtain the HB coefficients.

Three parameters: the energy$E_{L}$, two control
factors$\alpha$,$\beta$, are calculated according to the core type
flag$F_{\text{core}_{\text{type}}}$, coder type and bit-rate as follows:

$E_{L} = \begin{matrix}
\left\{ \begin{matrix}
\left. \ \sum_{k = \text{160}}^{\text{239}}{\left| {\hat{X}}_{M_{\text{core}_{\text{dec}}}}\left( k \right) \right|\text{if}\text{CT}^{( - 1)}! = \text{AUDIO}\text{AND}\text{bitrate} \leq \text{8000}} \middle| \right\} \\
\end{matrix} \middle| \middle| \text{if}F_{\text{core}_{\text{type}}} = 1 \middle| \right.\  \\
\end{matrix}$ (1682)

$\alpha = \begin{matrix}
\left\{ \begin{matrix}
\left. \ 0\text{.}8\text{if}\text{bitrate} \leq \text{8000} \middle| \right\} \\
\end{matrix} \middle| \middle| \text{if}F_{\text{core}_{\text{type}}} = 1 \middle| \right.\  \\
\end{matrix}$ (1683)

$\beta = \begin{matrix}
\left\{ \begin{matrix}
\left. \ 1\text{.}\text{25}\text{if}\text{bitrate} \leq \text{8000} \middle| \right\} \\
\end{matrix} \middle| \middle| \text{if}F_{\text{core}_{\text{type}}} = 1 \middle| \right.\  \\
\end{matrix}$ (1684)

When$F_{\text{core}_{\text{type}}} = 0$, if
$0\text{.}5 \cdot E_{L}^{\lbrack - 1\rbrack} < E_{L} < 2 \cdot E_{L}^{\lbrack - 1\rbrack}$
and $F_{\text{env}_{\text{ad}}}^{\lbrack - 1\rbrack} = 1$, or the coder
type is GENERIC, the envelope adjustment flag
$F_{\text{env}_{\text{ad}}}$ is set to 1 and the spectral envelope is
adjusted:

${\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}1}(j) = 0\text{.}5 \cdot {\hat{f}}_{\text{env}_{\text{WB}}}(j)\text{for}j = 0,1$
(1685)

where, $E_{L}^{\lbrack - 1\rbrack}$is the energy of previous frame,
and$F_{\text{env}_{\text{ad}}}^{\lbrack - 1\rbrack}$ is the previous
envelope adjustment flag. It is noted that the envelope adjustment flag
$F_{\text{env}_{\text{ad}}}$is initialized to 0 and preserved for the
next frame.

Otherwise, there is no adjustment:

${\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}1}(j) = {\hat{f}}_{\text{env}_{\text{WB}}}(j)\text{for}j = 0,1$
(1686)

The spectral envelopes are smoothed by the one between the current frame
and the previous frame according to the following conditions, and when
the current and previous frames apply different extended layer or the
current frame is lost frame, the previous spectral envelopes are set to
the current spectral
envelopes$f_{\text{env}_{\text{WB}}}^{\lbrack - 1\rbrack}(j) = {\hat{f}}_{\text{env}_{\text{WB}}}(j),j = 0,1$.

When the current frame is NORMAL, or the current frame is HARMONIC and
${\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}1}(1) < 0\text{.}\text{25} \cdot {\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}1}(0)$,
the adjustment is as follows.

> -- If
> $\text{bitrate} \leq \text{8000}$and$M_{\text{last}_{\text{extl}}} = \text{WB}_{\text{BWE}}$,
> and at least one of the coder types of current and previous frames is
> AUDIO, that is,
> $\text{CT}^{\lbrack - 1\rbrack} = \text{AUDIO}\text{AND}\text{CT}! = \text{AUDIO}$or
> $\text{CT}^{\lbrack - 1\rbrack}! = \text{AUDIO}\text{AND}\text{CT} = \text{AUDIO}$,
> the smoothing process is performed by:

$\begin{matrix}
\left\{ \begin{matrix}
\left. \ {\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}2}(0) = 0\text{.}3 \cdot {\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}1}(0) + 0\text{.}7 \cdot f_{\text{env}_{\text{WB}}}^{\lbrack - 1\rbrack}(0) \middle| \right\} \\
\end{matrix} \middle| \middle| \text{if}{\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}1}(0) > f_{\text{env}_{\text{WB}}}^{\lbrack - 1\rbrack}(0) \middle| \right.\  \\
\end{matrix}$ (1687)

> Else if the conditions:
> $M_{\text{last}_{\text{extl}}} = \text{WB}_{\text{BWE}}$,
> $f_{\text{env}_{\text{WB}}}^{\lbrack - 1\rbrack}(0) \cdot E_{L} < {\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}1}(0) \cdot E_{L}^{\lbrack - 1\rbrack}$,
> ${\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}1}(0) > f_{\text{env}_{\text{WB}}}^{\lbrack - 1\rbrack}(0)$,
> $\text{CT}! = \text{AUDIO}$,$\text{CT}! = \text{UNVOICED}$,and
> $\text{bitrate} \leq \text{8000}$, are all satisfied, the smoothing
> process is performed by:

${\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}2}(j) = 0\text{.}3 \cdot {\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}1}(j) + 0\text{.}7 \cdot f_{\text{env}_{\text{WB}}}^{\lbrack - 1\rbrack}(j)\text{for}j = 0,1$
(1688)

where, $E_{L}^{\lbrack - 1\rbrack}$is the energy of previous frame, and
the$E_{L}$ is preserved for the next frame at the end of spectral
envelope adjustment.

> Else if the conditions:
> $M_{\text{last}_{\text{extl}}} = \text{WB}_{\text{BWE}}$,
> $\alpha \cdot E_{L}^{\lbrack - 1\rbrack} < E_{L} < \beta \cdot E_{L}^{\lbrack - 1\rbrack}$,
> and $\text{CT}^{\lbrack - 1\rbrack}! = \text{UNVOICED}$, are all
> satisfied, the smoothing process is performed by:

${\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}2}(j) = 0\text{.}5 \cdot {\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}1}(j) + 0\text{.}5 \cdot f_{\text{env}_{\text{WB}}}^{\lbrack - 1\rbrack}(j)\text{for}j = 0,1$
(1689)

> Otherwise, there is no adjustment.

${\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}2}(j) = {\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}1}(j)\text{for}j = 0,1$
(1690)

> -- The spectral envelope is further adjusted by:

$\begin{matrix}
\left\{ {\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}3}(j) = \text{att} \cdot {\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}2}(j)\text{if}\text{CT}! = \text{AUDIO}\text{AND}\text{first}_{\text{CNG}} = 1\text{AND}\text{CNG}_{\text{mode}} \geq 2 \middle| \right.\  \\
\end{matrix}$ (1691)

> where, $\text{att}$ is the attenuation factor. It is initialized to 1
> and set to
> $\text{att} = \text{BWE}_{\text{ATT}}\lbrack\text{CNG}_{\text{mode}} - 2\rbrack$
> if $\text{first}_{\text{CNG}} = 1$ and
> $\text{CNG}_{\text{mode}} \geq 2$are satisfied.
> $\text{BWE}_{\text{ATT}}(j),j = 0,1,2$are defined in table 165.

Table 166: The envelope attenuation factor

  ----- --------
  *j*   
  0     0.8000
  1     0.7746
  2     0.7483
  ----- --------

> -- Then the adjusted spectral envelopes are applied to the excitation
> signal by:

$\begin{matrix}
\left\{ {\hat{X}}_{M_{\text{WB}}}^{\text{HB}}\left( k \right) = {\hat{X}}_{M_{\text{exc}_{\text{WB}}}}\left( k \right) \cdot {\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}3}(0)\text{for}\text{240} \leq k < \text{280} \middle| \right.\  \\
\end{matrix}$ (1692)

When the conditions: the current frame is NORMAL frame, or the current
frame is HARMONIC frame and
${\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}1}(1) < 0\text{.}\text{25} \cdot {\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}1}(0)$,
are not satisfied, the adjustment is as follows.

-- The first spectral envelope is firstly processed as follows.

${\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}2}(0) = 0\text{.}5 \cdot \left( {\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}1}(0) + {\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}1}(1) \right)$
(1693)

> -- If the conditions:
> $M_{\text{last}_{\text{extl}}} = \text{WB}_{\text{BWE}}$,
> $0\text{.}5 \cdot E_{L}^{\lbrack - 1\rbrack} < E_{L} < 2 \cdot E_{L}^{\lbrack - 1\rbrack}$,
> are satisfied, the adjustment is performed by:

${\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}3}(0) = 0\text{.}\text{25} \cdot {\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}2}(0) + 0\text{.}\text{375} \cdot \left( f_{\text{env}_{\text{WB}}}^{\lbrack - 1\rbrack}(0) + f_{\text{env}_{\text{WB}}}^{\lbrack - 1\rbrack}(1) \right)$
(1694)

> Otherwise, there is no adjustment:

${\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}3}(0) = {\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}2}(j)$
(1695)

-- Then the adjusted spectral envelopes are applied to the excitation
signal by:

${\hat{X}}_{M_{\text{WB}}}^{\text{HB}}\left( k \right) = {\hat{X}}_{M_{\text{exc}_{\text{WB}}}}\left( k \right) \cdot \text{att} \cdot {\hat{f}}_{\text{env}_{\text{WB}_{\text{ad}}}3}(0)\text{for}\text{240} \leq k < \text{320}$
(1696)

> where, $\text{att}$ is the attenuation factor. It is initialized to 1
> and set to
> $\text{att} = \text{BWE}_{\text{ATT}}\lbrack\text{CNG}_{\text{mode}} - 2\rbrack$
> if $\text{first}_{\text{CNG}} = 1$ and
> $\text{CNG}_{\text{mode}} \geq 2$.$\text{BWE}_{\text{ATT}}(j),j = 0,1,2$are
> defined in table 167.

The MDCT coefficients of HB signal are refined by:

${\hat{X}}_{M_{\text{WB}}}^{\text{HB}}\left( k \right) = \begin{matrix}
\left\{ {\hat{X}}_{M_{\text{WB}}}^{\text{HB}}\left( k \right) \cdot \left( 0\text{.}2 + 0\text{.}\text{05} \cdot \left( k - \text{240} \right) \right)\text{for}\text{240} \leq k < \text{256} \middle| \right.\ \left\{ {\hat{X}}_{M_{\text{WB}}}^{\text{HB}}\left( k \right) \cdot \left( 1\text{.}0 - 0\text{.}\text{02} \cdot \left( k - \text{280} \right) \right)\text{for}\text{280} \leq k < \text{320}\text{if}F_{\text{core}_{\text{type}}} = 1 \middle| \right.\  \\
\end{matrix}$ (1697)

And the spectral envelopes of current frame are preserved
as$f_{\text{env}_{\text{WB}}}^{\lbrack - 1\rbrack}\left( j \right),j = 0,1$
for the next frame.

##### 6.1.5.2.2.6 Windowing and frequency-to-time transformation {#windowing-and-frequency-to-time-transformation-1 .H6}

A 320-point inverse MDCT is used for WB FD BWE. Refer to subclause
6.2.4.

#### 6.1.5.3 Decoding of upper band at 64 kb/s

The upper band at 64 kbps bit-rate decoding starts with dequantizing the
received spectrum coefficients by means of the AVQ as described in
subclause 6.1.1.2.1.6.

The spectrum between 14.4 kHz and 16 kHz in SWB, resp. 20 kHz in FB, is
reconstructed using decoded part of the upper band spectrum.

Further the spectral envelope is decoded and the quantized spectral
envelope (four bands in normal mode or two bands in transient mode) is
used to denormalize per envelope the decoded spectrum. Each spectral
coefficient in an overlap region (7.6 kHz -- 8 kHz) is multiplied by a
factor lower than 1.0. The overlap region corresponds to the part of the
spectrum where the ACELP lower band synthesis is suppressed due to the
attenuation of the resampling filters. Consequently spectral
coefficients in an overlap region equalize the spectral gap that would
be present if the upper band coding would start at 8 kHz only.

Finally the spectrum is de-normalized by the decoded global gain and
transformed to the time domain using iDCT and OLA function.

##### 6.1.5.3.1 Decoding in normal mode

The global gain ${\hat{g}}_{\text{global}}$and the spectral envelope
${\hat{f}}_{\text{env}_{\text{band}}}(j),0 \leq j < 4$corresponding to 4
sub-bands are decoded. The global gain ${\hat{g}}_{\text{global}}$ is
de-quantized using a 5-bit log gain de-quantizer at the range of \[3.0;
500.0\]. The spectral envelopes
${\hat{f}}_{\text{env}_{\text{band}}}(j),0 \leq j < 4$ are de-quantized
using two-dimensional VQs by means of 6bits and 5bits respectively as
defined in subclause 5.2.6.3.1.

Then the band index with the minimum envelope
$\text{pos}_{\text{en}_{\text{min}}}$ is calculated
by$\text{pos}_{\text{en}_{\text{min}}} = \underset{j = 0,\text{.}\text{.}\text{.},3}{\text{argmin}({\hat{f}}_{\text{env}_{\text{band}}}(j))}$,
and the envelope of the spectrum between 14.4 kHz and 16 kHz in SWB,
resp. 20 kHz in FB is predicted as follows:

1)  If$\text{if}M_{\text{extl}} = \text{SWB}_{\text{BW}_{\text{HIGHRATE}}}$,
    ${\hat{f}}_{\text{env}_{\text{non}_{\text{dec}}}} = 0\text{.}5 \cdot {\hat{f}}_{\text{env}_{\text{band}}}\left( \text{pos}_{\text{en}_{\text{min}}} \right)$.

2)  If $M_{\text{extl}} = \text{FB}_{\text{BW}_{\text{HIGHRATE}}}$, the
    index of attenuation factor ${\hat{I}}_{\text{att}}$is decoded.
    Then, the ${\hat{f}}_{\text{env}_{\text{non}_{\text{dec}}}}$is
    adjusted depending upon the index:

${\hat{f}}_{\text{env}_{\text{non}_{\text{dec}}}} = \begin{matrix}
\left\{ {\hat{f}}_{\text{env}_{\text{non}_{\text{dec}}}}\text{if}{\hat{I}}_{\text{att}} = 0 \middle| \right.\ \left\{ 0\text{.}5 \cdot {\hat{f}}_{\text{env}_{\text{non}_{\text{dec}}}}\text{if}{\hat{I}}_{\text{att}} = 1 \middle| \right.\ \left\{ 2\text{.}4 \cdot {\hat{f}}_{\text{env}_{\text{non}_{\text{dec}}}}\text{if}{\hat{I}}_{\text{att}} = 2 \middle| \right.\  \\
\end{matrix}$ (1698)

The number of the sub-bands$N_{\text{sv}1}$is obtained according to the
number of the total bits $R_{\text{tot}}^{'}$ and the saturated
threshold $\text{Thr}1 = \text{400}$as follows:

$N_{\text{sv}1} = \begin{matrix}
\left\{ \text{34}\text{if}R_{\text{tot}}^{'} > \text{400} \middle| \right.\  \\
\end{matrix}$ (1699)

The first stage sub-vectors
${\hat{X}}_{M_{\text{norm}}1}(k),0 \leq k < 8 \cdot N_{\text{sv}1}$ are
decoded by means of AVQ and the spectrum of the upper band is obtained
by the first stage sub-vectors
${\hat{X}}_{M_{\text{norm}}1}(k),0 \leq k < 8 \cdot N_{\text{sv}1}$,

${\hat{X}}_{M_{\text{tmp}}}(k) = {\hat{X}}_{M_{\text{norm}}1}(k),0 \leq k < 8 \cdot N_{\text{sv}1}$
(1700)

and the $\text{nq}(b)$is saved to $\text{nq}_{\text{tmp}}(b)$, i.e.
$\text{nq}_{\text{tmp}}(b) = \text{nq}(b),0 \leq b < N_{\text{sv}1}$.

If the number of the remaining bits$R_{\text{rem}}$ after the first
stage decoding is larger than 14 and the first stage quantized spectrum
is non-zero, then the second stage decoding is performed. The second
stage global gain${\hat{g}}_{\text{global}2}$, is decoded and updated
by:

${\hat{g}}_{\text{global}2} = {\hat{g}}_{\text{global}2} \ast 0\text{.}\text{0625}$
(1701)

The number of the sub-bands$N_{\text{sv}2}$is obtained according to the
remaining bits$R_{\text{rem}}$and the saturated
threshold$\text{Thr}2 = \text{12}$as follows:

$N_{\text{sv}2} = \begin{matrix}
\left\{ \text{33}\text{if}R_{\text{rem}} > \text{396} \middle| \right.\  \\
\end{matrix}$ (1702)

The second stage sub-vectors
${\hat{X}}_{M_{\text{norm}}2}(k),0 \leq k < 8 \cdot N_{\text{sv}2}$ are
also decoded by means of AVQ.

Then, the spectrum of the upper band is reconstructed by the
contribution of the second stage decoding as follows:

-- The counter $i$ is initialized to 0.

-- In the sub-band $b$, $0 \leq b < N_{\text{sv}1}$, if the first stage
AVQ codebook index $\text{nq}(b) = 0\text{AND}i < N_{\text{sv}2}$, the
spectrum of the upper band is adjusted by
${\hat{X}}_{M_{\text{tmp}}}(8 \cdot b + k) = {\hat{g}}_{\text{global}2} \cdot {\hat{X}}_{M_{\text{norm}}2}(8 \ast i + k),0 \leq k < 8$,
and the second stage AVQ codebook index$\text{nq}_{2}(i)$ is added to
the first stage AVQ codebook index
$\text{nq}(b) = \text{nq}(b) + \text{nq}(i)$. Then, the counter $i$are
incremented by 1.

-- The sub-band index$b_{1}$is initialized to 0,
while$i < N_{\text{sv}2}$, if $\text{nq}_{\text{tmp}}(b_{1})! = 0$, the
spectrum is adjusted by
${\hat{X}}_{M_{\text{tmp}}}(8 \cdot b_{1} + k) = {\hat{X}}_{M_{\text{tmp}}}(8 \cdot b_{1} + k) + {\hat{g}}_{\text{global}2} \cdot {\hat{X}}_{M_{\text{norm}}2}(8 \cdot i + k),0 \leq k < 8$,
and $\text{nq}(b_{1}) = \text{nq}(b_{1}) + \text{nq}_{2}(i)$. Then, the
counter $i$is incremented by 1.

The spectrum is then reordered according to the number of the total
bits$R_{\text{tot}}^{'}$.

-- If $R_{\text{tot}}^{'} > \text{400}$, the reordered spectrum is
obtained by:

$\hat{X}(k_{\text{start}} + k) = \hat{X}(k)0 \leq k < \text{272}$ (1703)

where $k_{\text{start}}$is the start frequency bin of spectrum
reconstruction, and $k_{\text{start}} = \text{304}$for normal frames.

-- Otherwise, the reordered spectrum is obtained by:

$\begin{matrix}
\left\{ \hat{X}(k_{\text{start}} + k) = \hat{X}(k)0 \leq k < k_{\text{ind}1} \middle| \right.\  \\
\end{matrix}$ (1704)

where the $k_{\text{ind}1}$and $k_{\text{ind}2}$are set as follows:

$k_{\text{ind}1} = \text{64} \cdot \text{pos}_{\text{en}\text{\_min}} + 8 \cdot \left\lfloor \frac{\text{pos}_{\text{en}\text{\_min}}}{2} \right\rfloor$
(1705)

$k_{\text{ind}2} = \text{64} \cdot (\text{pos}_{\text{en}\text{\_min}} + 1) + 8 \cdot \left\lfloor (\text{pos}_{\text{en}\text{\_min}} + 1\frac{)}{2} \right\rfloor$
(1706)

And then the spectrum of the band with the minimum envelope is
reconstructed as follows:

$\begin{matrix}
\left\{ \hat{X}(k_{\text{start}} + \text{200} + k) = \hat{X}(k_{\text{start}} + \text{128} + k)0 \leq k < \text{72}\text{if}\text{pos}_{\text{en}\text{\_min}} = 3 \middle| \right.\ \left\{ \hat{X}(k_{\text{start}} + k_{\text{ind}1} + k) = \hat{X}(k_{\text{start}} + k_{\text{ind}2} + k)\text{otherwise} \middle| \right.\  \\
\end{matrix}$ (1707)

Meanwhile, the AVQ codebook index $\text{nq}(b)$is adjusted as follows:

If $\text{pos}_{\text{en}\text{\_min}} = 3$,

$\text{nq}(b + \text{25}) = \text{nq}(b + \text{16})0 \leq b < 9$ (1708)

Otherwise,

$\text{nq}(\text{33} - (b - k_{\text{ind}1})) = \text{nq}(b),k_{\text{ind}1} \leq b < N_{\text{sv}1}$
(1709)

And then,

$\text{nq}(k_{\text{ind}1} + b) = \text{nq}(k_{\text{ind}2} + b)0 \leq b < 8 + \text{pos}_{\text{en}\text{\_min}}\text{\%}2$
(1710)

Then the noise filling is applied to the spectrum. If the remaining bits
after the above decoding$R_{\text{rem}1} < \text{200}$, the 272 MDCT
coefficients of the upper band
${\hat{X}}_{M_{\text{spec}}}(k),k = \text{304},\text{.}\text{.}\text{.},\text{575}$
are divided into 34 sub-bands (8 coefficients per band). Two
indices$\text{pos}_{\text{start}}$, $\text{pos}_{\text{end}}$ are
introduced to select a base frequency band which is used to reconstruct
the un-decoded coefficients in the
sub-bands$\text{nq}\lbrack b\rbrack = 0$.

-- The sub-band index $i$is initialized to 0.

-- If$\text{nq}\lbrack 0\rbrack = 0$, in the index range from 0 to 34,
the index$\text{pos}_{\text{start}}$ of the first sub-band which AVQ
codebook index$\text{nq}(\text{pos}_{\text{start}})! = 0$is searched ,
and then in the index range from the index $\text{pos}_{\text{start}}$to
34, the index $\text{pos}_{\text{end}}$ of the first sub-band which AVQ
codebook index$\text{nq}(\text{pos}_{\text{end}}) = 0$is searched, and
the sub-band index is set
by$i = \text{pos}_{\text{end}}$,and$\text{pos}_{\text{end}} = \text{pos}_{\text{end}} - 1$.
If
$\text{pos}_{\text{end}} - \text{pos}_{\text{start}} > \text{pos}_{\text{start}}$,
the $\text{pos}_{\text{end}}$ is adjusted by
$\text{pos}_{\text{end}} = 2 \cdot \text{pos}_{\text{start}} - 1$ , and
then the MDCT coefficients in the sub-bands $b,0 \leq b < \text{pos}$
are reconstructed by:

${\hat{X}}_{M_{\text{spec}}}\left( k_{\text{start}} + 8 \cdot b + k \right) = \alpha \cdot {\hat{X}}_{M_{\text{spec}}}\left( k_{\text{start}} + 8 \cdot \text{pos} + k \right) + \beta \cdot s_{\text{noise}}\left( 8 \cdot b + k \right)/\text{32768}\ 0 \leq k < 8$
(1711)

where, $\alpha$and $\beta$ are the weighted factors, and
$\alpha = 0\text{.}\text{25}$, $\beta$is obtained by:

$\beta = \begin{matrix}
\left\{ 0\text{.}\text{25}\text{if}\text{tilt}_{\text{wb}} > 5\text{.}0 \middle| \right.\ \left\{ 0\text{.}\text{25}\text{else}\text{if}\text{tilt}_{\text{wb}} \leq 5\text{.}0\text{AND}\text{100} > 0\text{.}\text{25} \cdot T_{\text{pitch}} \middle| \right.\  \\
\end{matrix}$ (1712)

$T_{\text{pitch}} = \sum_{}^{}{\text{pitch}(i)} + \varepsilon$ (1713)

the index of sub-band $b$is from $\text{pos}_{\text{start}} - 1$ to 0,
and$\text{pos}$ is initialized to $\text{pos}_{\text{end}}$ and updated
by:

$\text{pos} = \begin{matrix}
\left\{ \text{pos}_{\text{end}}\ \text{if}\text{pos} < \text{pos}_{\text{start}} \middle| \right.\  \\
\end{matrix}$ (1714)

> 1\. If $\text{nq}\lbrack i\rbrack! = 0,\ i \leq \text{34}$, the index
> $i$is incremented by 1; Otherwise, a base frequency band is selected
> to reconstruct the un-decoded coefficients as follows:
>
> 2\. Initialize the indices$\text{pos}_{\text{start}} = i$and
> $\text{pos}_{\text{end}} = i$, and then in the sub-band
> $b$,$\text{pos}_{\text{start}} \leq b < \text{34}$, search the index
> $\text{pos}_{\text{end}}$ of the first sub-band which AVQ codebook
> index$\text{nq}(\text{pos}_{\text{end}})! = 0$, and
> set$i = \text{pos}_{\text{end}}$. If
> $\text{pos}_{\text{start}} = \text{pos}_{\text{end}}$, the index and
> the position are further adjusted: $i = \text{34}$,
> $\text{pos}_{\text{end}} = \text{34}$.
>
> 3\. Then the MDCT coefficients of the upper band are adjusted by:

${\hat{X}}_{M_{\text{spec}}}\left( k_{\text{start}} + 8 \cdot b + k \right) = \alpha \cdot {\hat{X}}_{M_{\text{spec}}}\left( k_{\text{start}} + 8 \cdot \text{pos}_{2} + k \right) + \beta \cdot s_{\text{noise}}\left( k \right)/\text{32768}\ 0 \leq k < 8$
(1715)

where $b$is from$\text{pos}_{\text{end}} - 1$ to
$\text{pos}_{\text{start}}$, and the $\text{pos}_{2}$ is initialized to
$\text{pos}_{\text{start}} - 1$ and it is adjusted by:

$\text{pos}_{2} = \begin{matrix}
\left\{ \text{pos}_{\text{start}} - 1\ \text{if}\text{pos}_{2} = 0 \middle| \right.\  \\
\end{matrix}$ (1716)

and,

$s_{\text{noise}}\left( k \right) = \lambda_{\text{seed}}\ \text{and}\ \lambda_{\text{seed}} = \text{31821} \cdot \lambda_{\text{seed}} + \text{13849}\ 0 \leq k < 8$
(1717)

> Parameter $\lambda_{\text{seed}}$ is initialized as 12345 and updated
> for each MDCT coefficient. It should be noted that
> $s_{\text{noise}}\left( k \right)$ is calculated for every frame.

4\. Finally, judge whether $i < \text{34}$or not. If $i < \text{34}$,
return to step 1.

If the spectral tilt $\text{tilt}_{\text{wb}}$of the decoded core signal
${\hat{s}}_{\text{16}}(n)$is larger than 5, the MDCT coefficients of the
upper band are further adjusted. In sub-band $b,0 \leq b < \text{34}$,
if${\hat{X}}_{M_{\text{spec}}}\left( k_{\text{start}} + 8 \cdot b + k \right) = 0$,
the adjustment is performed as follows:

${\hat{X}}_{M_{\text{spec}}}\left( k_{\text{start}} + 8 \cdot b + k \right) = \begin{matrix}
\left\{ 0\text{.}5 \cdot E_{\text{min}}\text{if}s_{\text{noise}}\left( k \right) > 0 \middle| \right.\  \\
\end{matrix}$ (1718)

where $\text{tilt}_{\text{wb}}$is obtained by the algorithm described in
equation (629) and (630), and$E_{\text{min}}$is obtained as follows:

$E_{\text{min}} = \underset{k = 0,\text{.}\text{.}\text{.},7}{\text{min}}\left( \left| {\hat{X}}_{M_{\text{spec}}}\left( k_{\text{start}} + 8 \cdot b + k \right) \right| \right)\text{if}\left| {\hat{X}}_{M_{\text{spec}}}\left( k_{\text{start}} + 8 \cdot b + k \right) \right| > 0$
(1719)

and if
$E_{\text{min}} = \underset{k = 0,\text{.}\text{.}\text{.},7}{\text{max}}\left( \left| {\hat{X}}_{M_{\text{spec}}}\left( k_{\text{start}} + 8 \cdot b + k \right) \right| \right)\text{AND}E_{\text{min}} > 1\text{.}0$,
$E_{\text{min}}$ is refined by:

$E_{\text{min}} = 0\text{.}5 \cdot E_{\text{min}}$ (1720)

When
$\text{pos}_{\text{en}\text{\_min}} = 3\text{AND}R_{\text{tot}}^{'} \leq \text{400}$,
the coefficients of the upper band in the index range \[504, 511\] are
smoothed by:

${\hat{X}}_{M_{\text{spec}}}\left( k_{\text{start}} + \text{200} + k \right) = {\hat{X}}_{M_{\text{spec}}}\left( k_{\text{start}} + \text{200} + k \right) \cdot \left( \left( 1 - \frac{k}{8} \right) \cdot R_{1} + \frac{k}{8} \right)k = 0,\text{.}\text{.}\text{.},7$
(1721)

where $R_{1}$ is defined as follows:

$R_{1} = \sqrt{\frac{\sum_{k = - 8}^{- 1}\left( {\hat{X}}_{M_{\text{spec}}}\left( k_{\text{start}} + \text{200} + k \right) \right)^{2} + \varepsilon}{\sum_{k = 0}^{7}\left( {\hat{X}}_{M_{\text{spec}}}\left( k_{\text{start}} + \text{200} + k \right) \right)^{2} + \varepsilon}}$
(1722)

The spectrum between 14.4 kHz and 16 kHz in SWB, resp. 20 kHz in FB is
reconstructed by:

${\hat{X}}_{M_{\text{spec}}}\left( \text{576} + k \right) = {\hat{X}}_{M_{\text{spec}}}\left( \text{576} - L_{\text{non}_{\text{dec}}} + k \right)k = 0,\text{.}\text{.}\text{.},L_{\text{non}_{\text{dec}}} - 1$
(1723)

where $L_{\text{non}_{\text{dec}}}$is the number of the coefficients
between 14.4 kHz and 16 kHz in SWB, resp. 20 kHz in FB:

$L_{\text{non}_{\text{dec}}} = \begin{matrix}
\left\{ \text{64}\text{for}\text{SWB}\text{signal} \middle| \right.\  \\
\end{matrix}$ (1724)

Then
$\text{if}M_{\text{extl}} = \text{SWB}_{\text{BW}_{\text{HIGHRATE}}}$ or
$\text{max}\left( {\hat{f}}_{\text{env}_{\text{band}}}(j) \right)/\text{min}\left( {\hat{f}}_{\text{env}_{\text{band}}}(j) \right) > 2\text{.}2,0 \leq j < 4,$the
coefficients in the index range \[576, 583\] are smoothed by,

${\hat{X}}_{M_{\text{spec}}}\left( \text{576} + k \right) = {\hat{X}}_{M_{\text{spec}}}\left( \text{576} + \text{200} + k \right) \cdot R_{2}k = 0,\text{.}\text{.}\text{.},7$
(1725)

where $R_{2}$ is defined as follows:

$R_{2} = \sqrt{\frac{\sum_{k = - 8}^{- 1}\left( {\hat{X}}_{M_{\text{spec}}}\left( \text{576} + k \right) \right)^{2} + \varepsilon}{\sum_{k = 0}^{7}\left( {\hat{X}}_{M_{\text{spec}}}\left( \text{576} + k \right) \right)^{2} + \varepsilon}}$
(1726)

and the spectrum is de-normalized using the spectral envelope by:

$\begin{matrix}
\left\{ {\hat{X}}_{M_{\text{denorm}}}(k_{\text{start}} + k) = {\hat{X}}_{M_{\text{spec}}}(k_{\text{start}} + k) \cdot {\hat{f}}_{\text{env}_{\text{band}}}(j)0 \leq j < 4,\text{68} \cdot j \leq k < \text{68} \cdot (j + 1) \middle| \right.\ \left\{ {\hat{X}}_{M_{\text{denorm}}}(\text{576} + k) = {\hat{X}}_{M_{\text{spec}}}(\text{576} + k) \cdot \left( \left( 1 - \frac{k}{8} \right) \cdot {\hat{f}}_{\text{env}_{\text{band}}}(3) + \frac{k}{8} \cdot {\hat{f}}_{\text{env}_{\text{non}_{\text{dec}}}} \right)0 \leq k < 8 \middle| \right.\  \\
\end{matrix}$ (1727)

Otherwise the spectrum is obtained as:

$\begin{matrix}
\left\{ {\hat{X}}_{M_{\text{denorm}}}(\text{576} + k) = \middle| \right.\ \left\{ \ {\hat{X}}_{M_{\text{spec}}}(\text{576} + k) \cdot 2\text{.}2 \cdot {\hat{f}}_{\text{env}_{\text{non}_{\text{dec}}}} \cdot (1 - \frac{k}{\text{160}}),0 \leq k < L \middle| \right.\ \left\{ {\hat{X}}_{M_{\text{denorm}}}(\text{576} + k) = \middle| \right.\  \\
\end{matrix}$ (1727a)

where $L_{\text{non}_{\text{dec}}1} = \text{64}$ for 32 kHz sampled
output or $L_{\text{non}_{\text{dec}}1} = \text{88}$ for 48 kHz smapled
output. Next the overlap coefficients
$f_{\text{overlap}_{\text{coefs}}}(k),0 \leq k < \text{16}$, which
depend on the output sampling rate (32 kHz or 48 kHz), defined in
table165 are used for adjustment as follows:

${\hat{X}}_{M_{\text{denorm}}}(k_{\text{start}} + k) = f_{\text{overlap}_{\text{coefs}}}(k) \cdot {\hat{X}}_{M_{\text{denorm}}}(k_{\text{start}} + k)0 \leq k < \text{16}$
(1728)

Table 165: Overlap coefficients $f_{\text{overlap}_{\text{coefs}}}(k)$

  ------------------------------------------------ ------- ------- ------- ------- ------- ------- ------- --------
  ***k***                                          0       1       2       3       4       5       6       7
  $f_{\text{overlap}_{\text{coefs}}}(k)$, 32 kHz   0.27    0.306   0.324   0.351   0.378   0.396   0.414   0.4275
  $f_{\text{overlap}_{\text{coefs}}}(k)$, 48 kHz   0.30    0.34    0.36    0.39    0.42    0.44    0.46    0.475
  *k*                                              8       9       10      11      12      13      14      15
  $f_{\text{overlap}_{\text{coefs}}}(k)$, 32 kHz   0.441   0.459   0.486   0.513   0.558   0.648   0.747   0.855
  $f_{\text{overlap}_{\text{coefs}}}(k)$, 48 kHz   0.49    0.51    0.54    0.57    0.62    0.72    0.83    0.95
  ------------------------------------------------ ------- ------- ------- ------- ------- ------- ------- --------

Finally the decoded global gain ${\hat{g}}_{\text{global}}$ is applied
to adjust the spectrum of the upper band.

${\hat{X}}_{M}(k_{\text{start}} + k) = \begin{matrix}
\left\{ 0\text{.}\text{85} \cdot {\hat{g}}_{\text{global}} \cdot {\hat{X}}_{M_{\text{denorm}}}(k_{\text{start}} + k)\text{if}R_{\text{tot}}^{'} \leq \text{400} \middle| \right.\  \\
\end{matrix}$ (1728)

The MDCT coefficients are preserved for the next frame as follows:

$\begin{matrix}
\left\{ {\hat{X}}_{M}^{\lbrack - 1\rbrack}(k) = {\hat{X}}_{M}(k_{\text{start}} + k)0 \leq k < \text{336}\text{for}\text{SWB}\text{signal} \middle| \right.\  \\
\end{matrix}$ (1729)

Two parameters of $E_{\text{ener}_{\text{shb}}}^{\lbrack - 1\rbrack}$and
${\hat{f}}_{\text{env}_{\text{SWB}}}^{\lbrack - 1\rbrack}(j),0 \leq j < \text{14}$
are updated by:

$E_{\text{ener}_{\text{shb}}}^{\lbrack - 1\rbrack} = \hat{g} \cdot 0\text{.}\text{25} \cdot \sum_{j = 0}^{4}{{\hat{f}}_{\text{env}_{\text{band}}}(j)}$
(1730)

${\hat{f}}_{\text{env}_{\text{SWB}}}^{\lbrack - 1\rbrack}(j) = \hat{g} \cdot {\hat{f}}_{\text{env}}0 \leq j < \text{14}$
(1731)

##### 6.1.5.3.2 Decoding in transient mode

There are 4 sub-fames for transient mode. In
sub-frame$j$,$0 \leq j < 4$, the global gain
${\hat{g}}_{\text{global}}$and spectral envelopes
${\hat{f}}_{\text{env}_{\text{band}}}(i),i = 0,1$, are decoded. The
global gain of each sub-frame${\hat{g}}_{\text{global}}$ is de-quantized
using a 5-bit log gain de-quantizer at the range of \[3.0; 500.0\]. The
first sub-frame spectral envelopes
${\hat{f}}_{\text{env}_{\text{band}}}(i),i = 0,1$ are de-quantized
firstly using two-dimensional VQs by means of 4 bits codebook defined in
subclause 5.2.6.3.2. The indices of the first sub-frame spectral
envelopes is noted as ${\hat{I}}_{\text{env}}(0)$.

If ${\hat{I}}_{\text{env}}(0) < 8$, which means the first sub-frame
spectral envelopes are de-quantized in the first part of the 4 bits
codebook, the spectral envelope
${\hat{f}}_{\text{env}_{\text{band}}}(i),i = 0,1$ of the following three
sub-frame are de-quantized using two-dimensional VQs by means of 3 bits
codebook , i.e. $0 \leq {\hat{I}}_{\text{env}}(j) < 8$, $1 \leq j < 4$
as described in subclause 5.2.6.3.2.

If ${\hat{I}}_{\text{env}}(0) \geq 8$, the spectral envelope
${\hat{f}}_{\text{env}_{\text{band}}}(i),i = 0,1$ of the following three
sub-frame are de-quantized using two-dimensional VQs by means of 3 bits
codebook, i.e. $8 \leq {\hat{I}}_{\text{env}}(j) < \text{15}$,
$1 \leq j < 4$ as described in subclause 5.2.6.3.2.

And then the spectrum of the upper band is reconstructed.

The number of the coefficients between 14.4 kHz and 16 kHz in SWB, resp.
20 kHz in FB, $L_{\text{non}_{\text{dec}}}$ , is set by:

$L_{\text{non}_{\text{dec}}} = \begin{matrix}
\left\{ \text{16}\text{for}\text{SWB}\text{signal} \middle| \right.\  \\
\end{matrix}$ (1732)

And the envelope of the MDCT coefficients between 14.4 kHz and 16 kHz in
SWB, resp. 20 kHz in FB
${\hat{f}}_{\text{env}_{\text{non}_{\text{dec}}}}$is calculated by:

1)  If $M_{\text{extl}} = \text{SWB}_{\text{BWE}_{\text{HIGHRATE}}}$

${\hat{f}}_{\text{env}_{\text{non}_{\text{dec}}}} = {\hat{f}}_{\text{env}_{\text{band}}}(1)$
(1733)

2)  If $M_{\text{extl}} = \text{FB}_{\text{BWE}_{\text{HIGHRATE}}}$, the
    index of attention factor ${\hat{I}}_{\text{att}}$is decoded, and
    then the ${\hat{f}}_{\text{env}_{\text{non}_{\text{dec}}}}$is
    adjusted depending upon the index${\hat{I}}_{\text{att}}$.

${\hat{f}}_{\text{env}_{\text{non}_{\text{dec}}}} = \begin{matrix}
\left\{ {\hat{f}}_{\text{env}_{\text{non}_{\text{dec}}}}\text{if}{\hat{I}}_{\text{att}} = 0 \middle| \right.\ \left\{ 0\text{.}1 \cdot {\hat{f}}_{\text{env}_{\text{non}_{\text{dec}}}}\text{if}{\hat{I}}_{\text{att}} = 1 \middle| \right.\ \left\{ 0\text{.}3 \cdot {\hat{f}}_{\text{env}_{\text{non}_{\text{dec}}}}\text{if}{\hat{I}}_{\text{att}} = 2 \middle| \right.\  \\
\end{matrix}$ (1734)

The normalized spectrum of the upper band is decoded by the
sub-vectors${\hat{X}}_{M_{\text{norm}}}(k)$ which are obtained by means
of the AVQ:

${\hat{X}}_{M_{\text{spec}}}(k_{\text{start}} + j \cdot L_{\text{fr}}/4 + k) = {\hat{X}}_{M_{\text{norm}}}(k)0 \leq k < \text{64}$
(1735)

where $k_{\text{start}}$is the start frequency bin of spectrum
reconstruction, and $k_{\text{start}} = \text{64}$for transient frames.
$L_{\text{fr}}$is the frame length. $L_{\text{fr}} = \text{640}$for SWB
signal and $L_{\text{fr}} = \text{960}$for FB signal.

Then the noise filling is applied to the spectrum. The first 64 MDCT
coefficients of the upper band
${\hat{X}}_{M_{\text{spec}}}(k),k = \text{76},\text{.}\text{.}\text{.},\text{139}$
are divided into 8 sub-bands (8 coefficients per band). In the sub-band
$b$, $0 \leq b < 8$, if the AVQ codebook index is equal to 0, that
is,$\text{nq}(b) = 0$, the signal is generated from linear congruential
uniform random noise generator as follows:

${\hat{X}}_{M_{\text{spec}}}\left( k_{\text{start}} + j \cdot L_{\text{fr}}/4 + k \right) = s_{\text{noise}}\left( k \right)/\text{65536}\ 8 \cdot b \leq k < 8 \cdot (b + 1)$
(1736)

where

$s_{\text{noise}}\left( k \right) = \lambda_{\text{seed}}\ \text{and}\ \lambda_{\text{seed}} = \text{31821} \cdot \lambda_{\text{seed}} + \text{13849}\ 8 \cdot b \leq k < 8 \cdot (b + 1)$
(1737)

Parameter $\lambda_{\text{seed}}$ is initialized as 12345 and updated
for each MDCT coefficient. It should be noted that
$s_{\text{noise}}\left( k \right)$ is calculated for every frame.

If the spectral tilt $\text{tilt}_{\text{wb}}$of the decoded core signal
${\hat{s}}_{\text{16}}(n)$is larger than 5, the MDCT coefficients of the
upper band are further adjusted.
If${\hat{X}}_{M_{\text{spec}}}\left( k_{\text{start}} + j \cdot L_{\text{fr}}/4 + k \right) = 0$,
the adjustment is by:

${\hat{X}}_{M_{\text{spec}}}\left( k_{\text{start}} + j \cdot L_{\text{fr}}/4 + k \right) = \begin{matrix}
\left\{ 0\text{.}5 \cdot E_{\text{min}}\text{if}s_{\text{noise}}\left( k \right) > 0 \middle| \right.\  \\
\end{matrix}$ (1738)

where $\text{tilt}_{\text{wb}}$is obtained by the algorithm described in
equations (629) and (630), and$E_{\text{min}}$is obtained as follows:

$E_{\text{min}} = \underset{k = 8b,\text{.}\text{.}\text{.},8b + 7}{\text{min}}\left( \left| {\hat{X}}_{M_{\text{spec}}}\left( k_{\text{start}} + j \cdot L_{\text{fr}}/4 + k \right) \right| \right)\text{if}\left| {\hat{X}}_{M}\left( k_{\text{start}} + j \cdot L_{\text{fr}}/4 + k \right) \right| > 0$
(1739)

and if
$E_{\text{min}} = \underset{k = 8b,\text{.}\text{.}\text{.},8b + 7}{\text{max}}\left( \left| {\hat{X}}_{M_{\text{spec}}}\left( k_{\text{start}} + j \cdot L_{\text{fr}}/4 + k \right) \right| \right)\text{AND}E_{\text{min}} > 1\text{.}0$,
$E_{\text{min}}$ is refined by:

$E_{\text{min}} = 0\text{.}5 \cdot E_{\text{min}}$ (1740)

The spectrum between 14.4 kHz and 16 kHz in SWB, resp. 20 kHz in FB is
reconstructed by replicating the nearby coefficients:

${\hat{X}}_{M_{\text{spec}}}(\text{140} + j \cdot L_{\text{fr}}/4 + k) = 0\text{.}5 \cdot {\hat{X}}_{M}(\text{140} + j \cdot L_{\text{fr}}/4 - (L_{\text{non}_{\text{dec}}} + 4) + k)0 \leq k < L_{\text{non}_{\text{dec}}} + 4$
(1741)

Then the spectrum of the upper band is de-normalized using the spectral
envelope by:

$\begin{matrix}
\left\{ {\hat{X}}_{M_{\text{denorm}}}(k_{\text{start}} + j \cdot L_{\text{fr}}/4 + k) = {\hat{X}}_{M_{\text{spec}}}(k_{\text{start}} + j \cdot L_{\text{fr}}/4 + k) \cdot {\hat{f}}_{\text{env}_{\text{band}}}(0)0 \leq k < \text{34} \middle| \right.\ \left\{ {\hat{X}}_{M_{\text{denorm}}}(k_{\text{start}} + j \cdot L_{\text{fr}}/4 + k) = {\hat{X}}_{M_{\text{spec}}}(k_{\text{start}} + j \cdot L_{\text{fr}}/4 + k) \cdot {\hat{f}}_{\text{env}_{\text{band}}}(1)\text{34} \leq k < \text{68} \middle| \right.\  \\
\end{matrix}$ (1742)

and the modification factors
$f_{\text{overlap}_{\text{coefs}}}(k),0 \leq k < \text{16}$defined in
table 168 are used to adjust the overlapped coefficients as follows:

${\hat{X}}_{M_{\text{denorm}}}(k_{\text{start}} + j \cdot L_{\text{fr}}/4 + k) = 0\text{.}9 \cdot {\hat{X}}_{M_{\text{denorm}}}(k_{\text{start}} + j \cdot L_{\text{fr}}/4 + k) \cdot f_{\text{overlap}_{\text{coefs}}}(4 \cdot k)$
(1743)

where, $0 \leq k < 4$.

Finally, the decoded global gain ${\hat{g}}_{\text{global}}$ is applied
to adjust the spectrum of the upper band.

${\hat{X}}_{M}(k_{\text{start}} + j \cdot L_{\text{fr}}/4 + k) = {\hat{g}}_{\text{global}} \cdot {\hat{X}}_{M_{\text{denorm}}}(k_{\text{start}} + j \cdot L_{\text{fr}}/4 + k)0 \leq k < \text{68} + L_{\text{non}_{\text{dec}}}$
(1744)

##### 6.1.5.3.3 Windowing and frequency-to-time transformation

A 640-point (SWB) or 960-point (FB) inverse MDCT is used for the upper
band frequency signal. Refer to subclause 6.2.4.

##### 6.1.5.3.4 Post-processing in temporal domain

If the current frame is a good one, further adjustment of the upper band
synthesized temporal signal ${\hat{s}}_{\text{hb}_{\text{syn}}}(n)$is
needed. The synthesized temporal signal of the upper band
${\hat{s}}_{\text{hb}_{\text{syn}}}(n)$is divided into 4 sub-frames, and
the energy of each sub-frame $E^{\lbrack m\rbrack}$, is computed by:

$E^{\lbrack m\rbrack} = \sum_{n = \frac{m \cdot L_{\text{fr}}}{4}}^{(m + 1\frac{) \cdot L_{\text{fr}}}{4} - 1}\left( {\hat{s}}_{\text{hb}_{\text{syn}}}(n \right)^{2}\ \text{for}\ m = 0,\ldots,3$
(1745)

For each sub-frame, the long term energy
$E_{\text{LT}}^{\left\lbrack m \right\rbrack}$ is initialized to 0, and
updated according to the following equation:

$E_{\text{LT}}^{\left\lbrack m \right\rbrack} = (1 - \alpha)E_{\text{LT}}^{\left\lbrack m - 1 \right\rbrack} + \text{αE}^{\left\lbrack m \right\rbrack}\ \text{for}\ m = 0,\ldots,3$
(1746)

In the above equation, the weighted factor $\alpha$ is set to 0.25, and
the convention is that for the first sub-frame,

$E_{\text{LT}}^{\left\lbrack - 1 \right\rbrack} = E_{\text{LT}}^{\left\lbrack 3 \right\rbrack}$
from the previous frame. For each sub-frame $m$, a comparison between
the short term energy $E^{\lbrack m\rbrack}$ and the long term energy
$E_{\text{LT}}^{\left\lbrack m \right\rbrack}$is performed. A transient
is detected whenever the energy ratio is above a certain threshold and
the sub-frame index$m$is recorded as$\text{pos}$. Formally, a transient
is detected whenever:

$E^{\left\lbrack m \right\rbrack} > \text{ρE}_{\text{LT}}^{\left\lbrack m \right\rbrack}$
(1747)

where $\rho$ is the energy ratio threshold and is set to
$\rho = \text{12}\text{.}5$.

When the current frame is transient and the conditions:$\text{pos} > 0$,
$\text{tilt}_{\text{wb}} < 3$,$\sum_{}^{}{\text{pitch}(j)} + \varepsilon > \text{500}$,
are all satisfied, the adjustment is processed.

$E_{\text{LT}}^{\left\lbrack - 1 \right\rbrack}$ is obtained depending
upon whether the current and previous frames apply the same extend
layer:

$E_{\text{LT}}^{\left\lbrack - 1 \right\rbrack} = \begin{matrix}
\left\{ E\text{if}M_{\text{last}_{\text{extl}}}! = M_{\text{extl}} \middle| \right.\  \\
\end{matrix}$ (1748)

where the energy$E$is calculated by:

$N = \frac{\text{pos} \cdot L_{\text{fr}}}{4}$ (1749)

$E = \sum_{n = 0}^{N}\left( {\hat{s}}_{\text{hb}_{\text{syn}}}(n) \right)^{2}$
(1750)

then,

${\hat{s}}_{\text{hb}_{\text{syn}}}^{'}(n) = \begin{matrix}
\left\{ {\hat{s}}_{\text{hb}_{\text{syn}}}(n) \cdot 0\text{.}2 \cdot \sqrt{\text{pos} \cdot \frac{E_{\text{LT}}^{\left\lbrack - 1 \right\rbrack}}{E}}0 \leq n < N \middle| \right.\  \\
\end{matrix}$ (1751)

The signal class $F_{\text{class}}$ of the current frame is preserved as
$F_{\text{class}}^{\left\lbrack - 1 \right\rbrack}$ for the next frame.

When $\text{last}_{\text{core}} = \text{HQ}_{\text{CORE}}$or
$M_{\text{last}_{\text{extl}}}! = M_{\text{extl}}$, if
$\text{tilt}_{\text{wb}} < 3$, the post-processing is performed in case
of switching of different extend layers or different cores. The gain
factor $g_{\text{post}_{\text{pro}}}$is first calculated by:

$g_{\text{post}_{\text{pro}}} = \begin{matrix}
\left\{ \sqrt{\frac{1}{\text{80}}\sum_{n = L_{\text{fr}} - \text{80}}^{L_{\text{fr}} - 1}\left( {\hat{s}}_{\text{hb}_{\text{syn}}}^{'}(n) \right)^{2}}\text{if}\text{pos}_{\text{max}}\text{160} \middle| \right.\  \\
\end{matrix}$ (1752)

where $\text{pos}_{\text{max}}$is the index of the time sample with the
maximum magnitude, and

$\text{pos}_{\text{max}} = \text{arg}\underset{n = 0,\text{.}\text{.}\text{.},\text{Lfr} - 1}{\text{max}(\left| {\hat{s}}_{\text{hb}_{\text{syn}}}^{'}(n) \right|)}$
(1753)

The gain factor $g_{\text{post}_{\text{pro}}}$ is refined by:

$g_{\text{post}_{\text{pro}}} = \text{min}(1,\frac{g_{\text{post}_{\text{pro}}}}{\sqrt{\frac{1}{k_{\text{ind}2} - k_{\text{ind}1}}\sum_{n = k_{\text{ind}1}}^{k_{\text{ind}2} - 1}\left( {\hat{s}}_{\text{hb}_{\text{syn}}}^{'}(n) \right)^{2} + \varepsilon}})$
(1754)

where $k_{\text{ind}1}$and $k_{\text{ind}2}$are obtained by:

$k_{\text{ind}1} = \text{max}(0,\text{pos}_{\text{max}} - \text{40})$
(1755)

$k_{\text{ind}2} = \text{min}(L_{\text{fr}},\text{pos}_{\text{max}} + \text{40})$
(1756)

Then the synthesized signal of the upper band is adjusted by:

$\begin{matrix}
{\hat{s}}_{\text{hb}_{\text{syn}}}^{''}(n) = \\
\  \\
 \\
\end{matrix}\begin{matrix}
\left\{ {\hat{s}}_{\text{hb}_{\text{syn}}}^{'}(n) \cdot g_{\text{post}_{\text{pro}}}k_{\text{ind}1} \leq n < L_{\text{fr}}\text{if}M_{\text{last}_{\text{extl}}} = \text{SWB}_{\text{BWE}}\text{OR}\text{FB}_{\text{BWE}} \middle| \right.\  \\
\end{matrix}$ (1757)

where $\beta(n)$is calculated as follows:

$\alpha = \begin{matrix}
\left\{ 1\text{if}g_{\text{post}_{\text{pro}}} > 0\text{.}5 \middle| \right.\  \\
\end{matrix}$ (1758)

$\beta(n) = (n - k_{\text{ind}2}) \cdot \left( \alpha - g_{\text{post}_{\text{pro}}} \right)/(L_{\text{fr}} - k_{\text{ind}2})k_{\text{ind}2} \leq n < L_{\text{fr}}$
(1759)

And the preserved synthesized signal of the upper band for OLA function,
${\hat{s}}_{\text{hb}_{\text{syn}}}^{\lbrack - 1\rbrack}(n)$, is
adjusted by:

${\hat{s}}_{\text{hb}_{\text{syn}}}^{\lbrack - 1\rbrack}(n) = {\hat{s}}_{\text{hb}_{\text{syn}}}^{\lbrack - 1\rbrack}(n) \cdot g_{\text{post}_{\text{pro}}}0 \leq n < L_{\text{fr}}$
(1760)
