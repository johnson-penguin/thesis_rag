6.2 MDCT Coding mode decoding
-----------------------------

### 6.2.1 General MDCT decoding

MDCT based codec frames can be either encoded by the MDCT based TCX or
the High Quality Coder. Which mode is actually used, is determined by
table 76 in subclause 5.3.1. For those configurations where both modes
are switched, a signaling bit determines the MDCT mode.

### 6.2.2 MDCT based TCX

A general description of the MDCT based TCX coder module can be found in
subclause5.3.3.1. In the following, the configurations are described,
the initialization process from the bit stream data and the general
decoding process.

#### 6.2.2.1 Rate dependent configurations

The rate dependent configuration of the TCX coder is described for the
encoder in subclause 5.3.3.1.2. The configurations are valid for the
decoder as well. Depending on the configuration, the initialization
order of the modules changes. The following subclause describes the
module initialization therefore just on a principle level.

#### 6.2.2.2 Init module parameters

##### 6.2.2.2.1 TCX block configuration

The coding modes TCX20 or TCX10 are signalled within the bit stream.
Binary code for the overlap width as defined in subclause 5.3.2.3 is
read from the bitstream. Overlap code for the current frame is formed
from the short/long transform decision bit and from the binary code for
the overlap width as defined in subclause 5.3.2.3. The TCX block is then
configured as described in subclause 6.2.4.2.

##### 6.2.2.2.2 LPC parameter

This subclause describes the inverse quantization of LPC.

##### 6.2.2.2.2.1 Low-rate LPC {#low-rate-lpc .H6}

MDCT based TCX relies on smoothed LPC spectral envelope. Decoding
process of LSF is common to that for ACELP except the case for 9.6 kbps
(NB/WB/SWB). Decoding process of weighted LSF and conversion of LSF used
for 9.6 kbps (NB/WB/SWB) are described in this subclause.

Weighted domain quantized LSF vector ${\hat{q}}_{\gamma}$is
reconstructed with two stage or three stage VQ as described in
5.3.3.2.1. These VQ codebooks are used in two ways. In case of primary
decoding, weighted LSF vector ${\hat{q}}_{\text{VQ}}$is retrieved from
two stage VQ and after adding mean vector $m$and the MA predicted
contribution vector$q_{\text{MA}}$, reconstructed LSF vector,
${\hat{q}}_{\gamma}( = {\hat{q}}_{\text{VQ}} + m + q_{\text{MA}})$ is
obtained. ${\hat{q}}_{\gamma}$is corresponding to the weighted envelope
and can be directly used for inverse shaping of MDCT coefficients. The
VQ uses 5 bits for 16 samples at the first stage, 4 bits for the lower 6
LSF parameters, and 4 bits for the higher 10 LSF parameters.

In the secondary decoding, weighted LSF vector is reconstructed without
adding MA predicted contribution vector. This can inform the shape of
envelope for the envelope base arithmetic coding even when the decoder
cannot get the information from the previous frame. The conditional
third stage VQ with addition of mean vector is applied to the retrieved
vector from two stage VQ to get ${\hat{q}}_{\gamma}^{''}$. After
reconstruction of LSF vector ${\hat{q}}_{\text{VQ}}$with two stage VQ
and adding mean vector$m$, the first and the second lower position
${\hat{q}}_{\gamma}^{'}(0)$ and ${\hat{q}}_{\gamma}^{'}(1)$ of the
reconstructed LSF vector
${\hat{q}}_{\gamma}^{'}( = m + {\hat{q}}_{\text{VQ}})$are checked. If
the ${\hat{q}}_{\gamma}^{'}$is expected to have large spectral
distortion from ${\hat{q}}_{\gamma}$, the third stage VQ is applied. The
retrieved vector ${\hat{q}}_{3\text{VQ}}$at the third stage VQ with 2
bits is applied to modify ${\hat{q}}_{\gamma}^{'}(0)$and
${\hat{q}}_{\gamma}^{'}(1)$ to get
${\hat{q}}_{\gamma}^{''}( = {\hat{q}}_{\text{VQ}} + m + {\hat{q}}_{3\text{VQ}})$,
only when, ${\hat{q}}_{\gamma}^{'}(0)$or
$({\hat{q}}_{\gamma}^{'}(1) - {\hat{q}}_{\gamma}^{'}(0))$has smaller
values than the threshold. Otherwise, the reconstructed LSF up to the
second stage VQ, ${\hat{q}}_{\gamma}^{'}$is used for the final
reconstruction LSF, ${\hat{q}}_{\gamma}^{''}$.

For the interpolation of LSF between the LSF in the possible ACELP at
the next frame, the reconstructed LSF vector ${\hat{q}}_{\gamma}$with MA
prediction needs to be converted to unweighted domain LSF vector
${\hat{q}}_{1}$. In envelope based arithmetic coding, unweighted LSF
vector without depending on MA prediction ${\hat{q}}_{1}^{'}$is also
necessary to estimate the MDCT envelope. These can be achieved by
low-complex direct matrix conversion described in 5.3.3.2.1.1

##### 6.2.2.2.2.2 Mid-rate LPC {#mid-rate-lpc .H6}

The inverse quantization for mid-rate bitrates (13.2 till 32 kbps) is
the same as for ACELP (with the quantizer being in AUDIO mode). However
there is a different interpolation, the same as described in subclause
5.3.3.2.1.2.

##### 6.2.2.2.2.3 High-rate LPC {#high-rate-lpc .H6}

Inverse quantization of an LPC filter is performed as described in
figure 93. The LPC filters are quantized using the line spectral
frequency (LSF) representation. A first-stage approximation is computed
by inverse Vector Quantization by a simple table look-up with an 8 bit
index. An algebraic vector quantized (AVQ) refinement is then calculated
as described in 6.1.1.2.1.4. The quantized LSF vector is reconstructed
by adding the first-stage approximation and the inverse-weighted AVQ
contribution.

Depending on the frame being coded as a single TCX20 frame or subdivided
into TCX10/TCX5 sub-frames one or two sets of LPC have to be
de-quantized. In case two sets are transmitted the first set is decoded
in the same way a single set would be decoded. For the second set an
initial bit signals if it has to be decoded depending on the first set
or not. If zero, the first stage approximation of the second set has to
be decoded with another 8 bit inverse Vector Quantizer. If one, the
inverse quantized first set will be used as first stage approximation.
The inverse weights in figure 93 are the reciprocal of the weights used
in the encoder (see subclause 5.3.3.2.1.3.3).

The AVQ decoder is described in subclause 6.1.1.2.1.4.

![](media/image1.wmf){width="4.5472222222222225in"
height="1.9229166666666666in"}

Figure 93: Overview high-rate LPC decoding

The inverse-quantized LSF vector is subsequently converted into a vector
of LSF coefficients, then interpolated and converted again into LPC
parameters. The interpolation is the same described in 5.3.3.2.1.2.

##### 6.2.2.2.3 PLC Wavefrom adjustment

The waveform adjustment tool reads one bit for initialization where 1
stands for harmonic and 0 for non-harmonic.

##### 6.2.2.2.4 Global Gain

The TCX global gain index $I_{T\text{CX},\text{gain}}$ is transmitted in
the bitstream as a 7 bit unsigned integer.

##### 6.2.2.2.5 Noise fill parameter

The TCX noise factor index $I_{\text{NF}}$ is transmitted in the
bitstream as a 3 bit unsigned integer.

##### 6.2.2.2.6 LTP

The LTP on/off flag $\text{LTP}_{\text{on}}$ is transmitted in the
bitstream as a single bit. If the LTP flag is one, the quantized pitch
lag and gain are transmitted after the LTP flag. The pitch lag index
$I_{\text{LTP},\text{lag}}$ is transmitted as unsigned 9 bit integer.
The gain index $I_{\text{LTP},\text{gain}}$ is transmitted as unsigned 2
bit integer.

##### 6.2.2.2.7 TNS parameter

The TNS on/off flat is transmitted in the bitstream as a single bit. If
the TNS flag is one and if the configuration (see subclause 5.3.3.2.2)
indicates that 2 filters are possible then an additional single bit
transmitted in the bitstream indicates if the parameters for 1 or 2
filters are transmitted in the bitstream (nMaxFilters = 1 or nMaxFilters
= 2). For each filter, order and coefficients are the parameters
transmitted in the bitstream. The order and the coefficients are coded
using Huffman coding. Which Huffman code will be used for the filter
order depends on the frame configuration (TCX20/TCX10/TCX5) and on the
bandwidth (SWB,WB). Which Huffman code will be used for a parcor
coefficient depends on the frame configuration (TCX20/TCX10/TCX5), on
the bandwidth (SWB,WB) and on the parcor coefficent's index. If the
parameters for 1 filter are transmited in the bitstream, then the second
filter is inactive. If the parameters for 2 filters are transmitted in
the bitstream, then order 1 and the filter coefficient set to 0 for the
first filter indicates that the first filter is disabled and that only
the second filter is active.

##### 6.2.2.2.8 Harmonic model

For both context and envelope based arithmetic coding, a harmonic model
is used for efficient coding of frames with harmonic content. The
harmonic model is disabled if any of the following conditions apply:

\- The bit-rate is not one of 9.6, 13.2, 16.4, 24.4, 32, 48 kbps.

\- The previous frame was coded by ACELP.

\- Envelope based arithmetic coding is used and the coder type is
neither Voiced nor Generic.

In the above cases, no further signalling is used.

Otherwise, a single-bit harmonic model flag is read from the bit-stream.
When the flag is non-zero, the decoding proceeds by reading the harmonic
model interval parameter as follows.

##### 6.2.2.2.8.1 Decoding of Interval of harmonics {#decoding-of-interval-of-harmonics .H6}

When pitch lag and gain are used for the LTP post processing, the lag
parameter is utilized for representing the interval of harmonics in the
frequency domain. Otherwise, normal representation of interval is
applied.

##### 6.2.2.2.8.1.1 Decoding interval depending on time domain pitch lag {#decoding-interval-depending-on-time-domain-pitch-lag .H6}

According to the procedure in subclause 5.3.3.2.8.1.8.1.1,
$T_{\text{UNIT}}$, $\text{Index}_{T}$,
$\text{Index}_{\text{Bandwidth}}$are set up,
$\text{Index}_{\text{MUL}}$is read from the bit-stream, and finally
$T_{\text{MDCT}}$is calculated.

##### 6.2.2.2.8.1.2 Decoding interval without depending on time domain pitch lag {#decoding-interval-without-depending-on-time-domain-pitch-lag .H6}

When pitch lag and gain in the time domain is not used or the pitch gain
is less than or equals to 0.46, normal decoding of the interval with
un-equal resolution is used. The 8-bit $\text{index}$is read from the
bit-stream and $T_{\text{UNIT}}$ and $T_{\text{MDCT}}$ are calculated as
in subclause 5.3.3.2.8.1.8.1.1.

##### 6.2.2.2.8.2 Decoding of gain {#decoding-of-gain .H6}

In case of envelope based arithmetic coding and Voiced coder type, a
2-bit gain index is read from the bit-stream.

##### 6.2.2.2.9 IGF bit stream reader

On the decoder side the IGF scale factors, the IGF whitening levels and
the IGF temporal flatness indicator flag are extracted from the bit
stream and subsequently decoded. The decoding of the IGF scale factors
is described in subclause 6.2.2.2.9.2.

##### 6.2.2.2.9.1 IGF whitening level decoding {#igf-whitening-level-decoding .H6}

The IGF whitening levels are decoded according to the following pseudo
code:

nT = $\text{nT}$;

for (k = 0; k \< nT; k++) {

$\text{currWLevel}\left( k \right)$ = 0;

}

tmp = -1;

if ($\text{isIndep}$) {

tmp = 0;

} else {

tmp = read\_bit();

}

if (tmp == 1) {

for (k = 0; k \< nT; k++) {

$\text{currWLevel}\left( k \right)$ =
$\text{prevWLevel}\left( k \right)$;

}

} else {

k = 0;

$\text{currWLevel}\left( k \right)$ = decode\_whitening\_level(k);

tmp = read\_bit();

if (tmp == 1) {

for (k = 1; k \< nT; k++) {

$\text{currWLevel}\left( k \right)$ = decode\_whitening\_level(k);

}

} else {

for (k = 1; k \< nT; k++) {

$\text{currWLevel}\left( k \right)$ =
$\text{currWLevel}\left( 0 \right)$;

}

}

}

for (k = 0; k \< nT; k++) {

$\text{prevWLevel}\left( k \right)$ =
$\text{currWLevel}\left( k \right)$;

}

wherein the vector $\text{prevWLevel}$ contains the whitening
levels$$from the previous frame and the function
decode\_whitening\_level takes care of the decoding the actual whitening
level from the bit stream. The function is implemented according to the
pseudo code below:

tmp = read\_bit();

if (tmp == 1) {

tmp = read\_bit();

if (tmp == 1) {

return 2;

} else {

return 0;

}

} else {

return 1;

}

Finally the IGF temporal flatness indicator flag is extracted from the
bit stream.

In case of a TCX10 frame ($\text{isTCX}\text{10} = \text{true}$), the
IGF sideinfo for both sub-frames is extracted from the bit stream prior
to the IGF processing. Therefore, the decoded sideinfo for the
individual sub-frames is stored in a temporary buffer, so that the
sideinfo for the current sub-frame under IGF processing can be accessed
via the temporary buffer.

##### 6.2.2.2.9.2 IGF noiseless decoding of scale factors {#igf-noiseless-decoding-of-scale-factors .H6}

The noiseless decoding of the IGF scale factor vector $g$ is very
similar to the noiseless encoding part. The entire encoding and decoding
procedures are highly symmetric, and therefore the decoding procedure
can be uniquely and unambiguously derived from the encoding procedure.

The module uses the common raw arithmetic decoder functions from the
infrastructure, which are available from the core coder. The functions
used are
$\text{ari}_{\text{decode}_{\text{14}}}\text{bits}_{\text{bit}_{\text{ext}}}\left( \text{returnValue} \right)$,
which decodes one bit into $\text{returnValue}$,
$\text{ari}_{\text{decode}_{\text{14}}}\text{bits}_{s}\text{27}_{\text{ext}}\left( \text{returnValue}\text{,~}\text{cumulativeFrequencyTable} \right)$,
which decodes one value into $\text{returnValue}$ from an alphabet of 27
symbols ($\text{SYMBOLS}_{\text{IN}_{\text{TABLE}}}$) using the
cumulative frequency table $\text{cumulativeFrequencyTable}$,
$\text{ari}_{\text{start}_{\text{decoding}_{\text{14}}}}\text{bits}()$,
which initializes the arithmetic decoder. Note that there is no
$\text{ari}_{\text{finish}_{\text{decoding}_{\text{14}}}}\text{bits}()$
to finalize the arithmetic decoder. Instead, the equivalent function
$\text{arith}_{\text{flush}_{\text{decoding}}}()$ was locally defined,
which returns the last 14 bits read back to the bit stream reader.

##### 6.2.2.2.9.2.1 IGF independency flag {#igf-independency-flag .H6}

The behaviour and processing related to the $\text{isIndepFlag}$ flag is
identical to the encoder side.

##### 6.2.2.2.9.2.2 IGF all-Zero flag {#igf-all-zero-flag .H6}

The $\text{allZero}$ flag is read from the bit stream first. In case the
flag is 1, the decoder state is reset and no further data is read from
the bit stream, because the decoded scale factors are all set to zero:

$g\left( k \right)�: = 0\text{,~}\text{for~all\ }0 \leq k < \text{nB}$
(1762)

Otherwise, if the flag is 0, the arithmetic coded scale factor vector
$g$ is decoded from the bit stream.

##### 6.2.2.2.9.2.3 IGF arithmetic decoding helper functions {#igf-arithmetic-decoding-helper-functions .H6}

##### 6.2.2.2.9.2.3.1 The reset function {#the-reset-function .H6}

The behaviour and processing related to the reset function is identical
to the encoder side.

##### 6.2.2.2.9.2.3.2 The arith\_decode\_bits function {#the-arith_decode_bits-function .H6}

The $\text{arith}_{\text{decode}_{\text{bits}}}$ function decodes an
unsigned integer of length $\text{nBits}$ bits, by reading one bit at a
time.

arith\_decode\_bits(nBits)

{

x = 0;

for (i = 0; i \< nBits; ++i) {

ari\_decode\_14bits\_bit\_ext(&bit);

x = (x \<\< 1) \| bit;

}

return x;

}

##### 6.2.2.2.9.2.4 IGF arithmetic decoding {#igf-arithmetic-decoding .H6}

The $\text{arith}_{\text{decode}_{\text{residual}}}$ function decodes an
integer valued prediction residual, using the cumulative frequency table
$\text{cumulativeFrequencyTable}$, and the table offset
$\text{tableOffset}$.

The behaviour and processing related to the function is very similar to
the corresponding $\text{arith}_{\text{encode}_{\text{residual}}}$
function in the encoder.

arith\_decode\_residual(cumulativeFrequencyTable, tableOffset)

{

ari\_decode\_14bits\_s27\_ext(&val, cumulativeFrequencyTable);

if ((val != 0) && (val != SYMBOLS\_IN\_TABLE - 1)) {

x = (val - 1) + MIN\_ENC\_SEPARATE;

x -= tableOffset;

return x;

}

extra = arith\_decode\_bits(4);

if (extra == 15) {

extra\_tmp = arith\_decode\_bits(6);

if (extra\_tmp == 63) {

extra\_tmp = 63 + arith\_decode\_bits(7);

}

extra = 15 + extra\_tmp;

}

if (val == 0) {

x = (MIN\_ENC\_SEPARATE - 1) - extra;

} else { /\* val == SYMBOLS\_IN\_TABLE - 1 \*/

x = (MAX\_ENC\_SEPARATE + 1) + extra;

}

x -= tableOffset;

return x;

}

The function $\text{decode}_{\text{sfe}_{\text{vector}}}$ decodes the
scale factor vector $g$, which consists of $\text{nB}$ integer values.
The value $t$ and the $\text{prev}$ vector, which constitute the decoder
state, are used as additional parameters for the function. Note that the
top level function $\text{iisIGFSCFDecoderDecode}$ must call the common
arithmetic decoder initialization function
$\text{ari}_{\text{start}_{\text{decoding}_{\text{14}}}}\text{bits}$
before calling the function
$\text{decode}_{\text{sfe}_{\text{vector}}}$, and also call the locally
defined arithmetic decoder finalization function
$\text{arih}_{\text{decode}_{\text{flush}}}$ afterwards.

decode\_sfe\_vector(t, prev, g, nB)

{

for (f = 0; f \< nB; f++) {

if (t == 0) {

if (f == 0) {

ari\_decode\_14bits\_s27\_ext(&pred, cf\_se00);

g\[f\] = pred \<\< 2;

g\[f\] += arith\_decode\_bits(2); /\* LSBs as 2 bit raw \*/

}

else if (f == 1) {

pred = g\[f - 1\]; /\* pred = b \*/

g\[f\] = pred + arith\_decode\_residual(cf\_se01, cf\_off\_se01);

} else { /\* f \>= 2 \*/

pred = g\[f - 1\]; /\* pred = b \*/

ctx = quant\_ctx(g\[f - 1\] - g\[f - 2\]); /\* Q(b - e) \*/

g\[f\] = pred + arith\_decode\_residual(cf\_se02\[CTX\_OFFSET + ctx\],

cf\_off\_se02\[CTX\_OFFSET + ctx\]);

}

}

else { /\* t == 1 \*/

if (f == 0) {

pred = prev\[f\]; /\* pred = a \*/

g\[f\] = pred + arith\_decode\_residual(cf\_se10, cf\_off\_se10);

} else { /\* (t == 1) && (f \>= 1) \*/

pred = prev\[f\] + g\[f - 1\] - prev\[f - 1\]; /\* pred = a + b - c \*/

ctx\_f = quant\_ctx(prev\[f\] - prev\[f - 1\]); /\* Q(a - c) \*/

ctx\_t = quant\_ctx(x\[f - 1\] - prev\[f - 1\]); /\* Q(b - c) \*/

g\[f\] = pred + arith\_decode\_residual(

cf\_se11\[CTX\_OFFSET + ctx\_t\]\[CTX\_OFFSET + ctx\_f\],

cf\_off\_se11\[CTX\_OFFSET + ctx\_t\]\[CTX\_OFFSET + ctx\_f\]);

}

}

}

}

The cumulative frequency tables and the corresponding table offsets are
initialized identically to the encoder side.

##### 6.2.2.2.10 Spectral data

The quantized spectral coefficients are read from the bit-stream by the
means of arithmetic decoding.

##### 6.2.2.2.11 Residual bits

The left-over bits (to the target bit budget) after arithmetic decoding
are read by the residual decoding module.

#### 6.2.2.3 Decoding process

##### 6.2.2.3.1 Arithmetic decoder

The arithmetic decoder is described by the following pseudo-code. It
takes as input arguments the cumulative frequency table *cum\_freq\[\]*
and the size of the alphabet *cfl*.

symbol = ari\_decode(cum\_freq\[\], cfl) {

if (arith\_first\_symbol()) {

value = 0;

for (i=1; i\<=16; i++) {

value = (val\<\<1) \| arith\_get\_next\_bit();

}

low = 0;

high = 65535;

}

range = high-low+1;

cum =((((int) (value-low+1))\<\<14)-((int) 1))/range;

p = cum\_freq-1;

do {

q = p + (cfl\>\>1);

if ( \*q \> cum ) { p=q; cfl++; }

cfl\>\>=1;

}

while ( cfl\>1 );

symbol = p-cum\_freq+1;

if (symbol)

high = low + ((range\*cum\_freq\[symbol-1\])\>\>14) - 1;

low += (range \* (cum\_freq\[symbol\])\>\>14);

for (;;) {

if (high\<32768) { }

else if (low\>=32768) {

value -= 32768;

low -= 32768;

high -= 32768;

}

else if (low\>=16384 && high\<49152) {

value -= 16384;

low -= 16384;

high -= 16384;

}

else break;

low += low;

high += high+1;

value = (value\<\<1) \| arith\_get\_next\_bit();

}

return symbol;

}

##### 6.2.2.3.1.1 Context-based arithmetic decoder {#context-based-arithmetic-decoder .H6}

The context-based arithmetic decoder reads the following data in the
following order:

1.  $\left\lceil \text{log}_{2}(\frac{L}{2}) \right\rceil$ bits for
    decoding *lastnz/2-1*.

2.  The entropy-coded MSBs bits

3.  The sign bits

4.  The residual quantization bits

5.  The LSBs bits are read backwardly from the end of the bitstream
    buffer.

The following pseudo-code shows how the spectral coefficients *X\[\]* or
${\hat{X}}_{M}$are decoded. It takes as input argument the allocated bit
budget *target\_bits* and the number of coded samples *lastnz*. The
helper functions are given in encoder subsection from 5.3.3.2.8.1.2 to
5.3.3.2.8.1.2.

X=ari\_context\_decode(target\_bits,pi,hi,last\_nz) {

c\[0\]=c\[1\]=p1=p2=0;

for (k=0; k\<L; k++) {

X\[k\]=0;

for (k=0; k\<lastnz; k+=2) {

a=b=0;

(a1\_i,p1,idx1) = get\_next\_coeff(pi,hi,lastnz);

(b1\_i,p2,idx2) = get\_next\_coeff(pi,hi,lastnz);

t=get\_context(idx1,idx2,c,p1,p2);

/\* MSBs decoding \*/

for (lev=esc\_nb=0;;){

pki = ari\_context\_lookup \[t + 1024\*esc\_nb \];

ari\_decode(ari\_cf\_m \[pki\],17);

if(r\<16) break;

/\*LSBs decoding\*/

a=(a)+read\_bit\_end() \<\<(lev));

b=(b)+ read\_bit\_end() \<\<(lev));

lev++;

esc\_nb=min(lev,3);

}

/\*MSBs contributions\*/

b1= r\>\>2;

a1= r&0x3;

a += (a1)\<\<lev;

b += (b1)\<\<lev;

/\*Dectect overflow\*/

if(nbbits\>target\_bits){

break;

}

c=update\_context(a,b,a1,b1,c,p1,p2);

/\* Store decoded data \*/

X\[a1\_i\] = a;

X\[b1\_i\] = b;

}

/\*decode signs\*/

for (i=0; i\<L; i++){

if(X\[i\]\>0){

if ( read\_bit()==1 ){

X\[i\] = -X\[i\];

}

}

}

}

##### 6.2.2.3.1.2 Envelope-based arithmetic decoder {#envelope-based-arithmetic-decoder .H6}

The probability model is computed as described in the encoder subclause
5.3.3.2.8.1.2.3.

##### 6.2.2.3.2 Adaptive low frequency de-emphasis

A general description of ALFE can be found in subclause 5.3.3.2.4.1.

##### 6.2.2.3.2.1 Adaptive de-emphasis algorithm 1 {#adaptive-de-emphasis-algorithm-1 .H6}

ALFE algorithm 1 reverses the encoder-side LF emphasis 1 (see subclause
5.3.3.2.4.2). First, as was done in the encoder, the minimum and maximum
of the first nine gains are found using comparison operations executed
within a loop over the gain indices 0 to 8.

Then, if the ratio between the minimum and maximum exceeds a threshold
of 1/32, a gradual lowering of the lowest lines in x is performed such
that the first line is attenuated by (max/(32 min))^0.25^ and the 33^rd^
line is not attenuated:

tmp = 32 \* min;

if ((max \< tmp) && (tmp \> 0)) {

fac = tmp = pow(max / tmp, 1/128);

for (i = 31; i \>= 0; i\--) { /\* gradual lowering of lowest 32 lines
\*/

X\[i\] \*= fac;

fac \*= tmp;

}

}

##### Adaptive de-emphasis algorithm 2 {#adaptive-de-emphasis-algorithm-2 .H6}

ALFE algorithm 2 reverses the encoder-side LF emphasis 2 (see subclause
5.3.3.2.4.3) by checking for modifications to the quantized LF MDCT
lines and undoing them. As was done in the encoder, the procedure is
split into five steps:

-   Step 1: first find first magnitude maximum at index i\_max in lower
    > spectral quarter (*k* = 0 ...
    > $L_{\text{TCX}}^{\left( \text{bw} \right)}$ / 4) for which
    > \|Xq\[*k*\]\| ≥ 4 and modify the maximum as follows: Xq\[i\_max\]
    > += (Xq\[i\_max\] \< 0) ? 2 : -2

-   Step 2: then expand value range of all X\[*k*\] up to i\_max by
    > multiplying all lines at *k* = 0...i\_max--1 with 0.5

-   Step 3: again find first magnitude maximum in lower quarter of
    > spectrum if the i\_max found in step 1 is \> -1

-   Step 4: again expand value range of all X\[i\] up to i\_max as in
    > step 2, but using the i\_max found in step 3

-   Step 5: finish and always expand two lines at the latest i\_max
    > found, i.e. at *k* = i\_max+1, i\_max+2. If the line magnitude at
    > *k* is greater than or equal to 4, move it toward zero by two,
    > otherwise multiply it by 0.5. As in the encoder all i\_max are
    > initialized to --1. For details please see AdaptLowFreqDeemph() in
    > tcx\_utils.c.

##### 6.2.2.3.3 Global gain decoding

The global gain ${\hat{g}}_{\text{TCX}}$ is decoded from the index
transmitted in the bit stream as follows:

\(1763\)

##### 6.2.2.3.4 Residual bits decoding

At 13.2 kbps and above the 3 first bits are used for refining the global
gain. The variable *n* is initialized to *0*:

The following bits refine the non-zeroed decoded lines. 1 bit per
non-zeroed spectral value is read. The rounding offset used in the first
quantization stage with dead-zone is taking into account for computing
the reconstructed points:

If at least 2 bits are left to read, a zeroed value is refined as:

##### 6.2.2.3.5 TCX formant enhancement

The TCX formant enhancement intends to replicate a behavior similar to
that of the ACELP formant enhancement. It operates based on the LPC
frequency-band gains, lpcGains\[\]. First, the square-root of each gain
is computed. Then,

fac = 1 / min(sqrtGains\[0\], sqrtGains\[1\]);

k = 0;

for (i = 1; i \< numGains - 1; i++) {

if ((sqrtGains\[i-1\] \<= sqrtGains\[i\]) && (sqrtGains\[i+1\] \<=
sqrtGains\[i\])) {

step = max(sqrtGains\[i-1\], sqrtGains\[i+1\]);

step = (1 / step - fac) / (i - k);

sqrtGains\[k\] = 1;

fac += step;

for (j = k + 1; j \< i; j++) {

sqrtGains\[j\] = min(1, sqrtGains\[j\] \* fac);

fac += step;

}

k = i;

}

}

where sqrtGains\[\] contains the square-roots of the lpcGains\[\], and
numGains denotes the number of LPC gains. In order to complete the above
algorithm for the last gain at *i* = numGains -- 1, the following
operation is executed,

step = min(sqrtGains\[i-1\], sqrtGains\[i\]),

and the above steps inside the if-condition, starting with "step = (1 /
step -- fac) / (i -- k)", are repeated. Finally, we set
sqrtGains\[numGains -- 1\] = 1 and multiply the modified set of gains
onto the decoded spectrum:

for (i = j = 0; i \< $L_{\text{TCX}}^{\left( \text{bw} \right)}$ j++) {

for (k = 0; k \< $L_{\text{TCX}}^{\left( \text{bw} \right)}$/ numGains;
i++, k++) {

${\hat{X}}_{M}$\[i\] \*= sqrtGains\[j\];

}

}

with ${\hat{X}}_{M}$ being the decoded spectrum. Like its ACELP
counterpart, TCX formant enhancement is only used at 9.6 kbps.

##### 6.2.2.3.6 Noise Filling

Noise filling is applied to fill gaps in the MDCT spectrum where
coefficients have been quantized to zero. Pseudo-random noise is
inserted into the gaps, starting at bin $k_{\text{NFstart}}$ up to bin
$k_{\text{NFstop}} - 1$. The amount of noise inserted is controlled by a
noise factor transmitted in the bit stream. To compensate for LPC tilt,
a tilt compensation factor is computed. At each side of a noise filling
segment a fadeout over $t_{\text{NF}}$ bins is applied to the inserted
noise to smooth the transition.

The start and stop bins $k_{\text{NFstart}}$ and $k_{\text{NFstop}}$ are
determined as described in subclause 5.3.3.2.10.2 .
$k_{\text{NFstop},\text{LP}}$ is set to the same value as
$k_{\text{NFstop}}$:

$k_{\text{NFstop},\text{LP}} = k_{\text{NFstop}}$ (1764)

Computation of the tilt compensation factor $t_{\text{NF}}$ is described
in subclause 5.3.3.2.10.1. The transition width $w_{\text{NF}}$ is
computed as described in 5.3.3.2.10.3.

##### 6.2.2.3.6.1 Decoding of Noise Factor {#decoding-of-noise-factor .H6}

The dequantized noise factor ${\hat{f}}_{\text{NF}}$ is obtained from
the transmitted index $I_{\text{NF}}$ as follows:

${\hat{f}}_{\text{NF}} = 0\text{.}\text{09375} \cdot I_{\text{NF}}$
(1765)

##### 6.2.2.3.6.2 Noise Filling Seed {#noise-filling-seed .H6}

The inserted noise is generated as a sequence of pseudo-random numbers,
which is computed in a recursive way starting with a seed
$s_{\text{NF}}$ computed from the quantized MDCT coefficients
${\hat{X}}_{M}$:

$s_{\text{NF}} = \left( \left( \text{32768} + \sum_{i = 0}^{k_{\text{NFstop}} - 1}{2 \cdot i \cdot \left| {\hat{X}}_{M}\left( i \right) \right|} \right)\ \text{mod}\ \text{65536} \right) - \text{32768}$
(1766)

##### 6.2.2.3.6.3 Filling Noise Segments {#filling-noise-segments .H6}

Determining the number and start/stop bins of noise filling segments is
described in 5.3.3.2.10.2 and 5.3.3.2.10.4.

For each segment pseudo-random noise is generated and normalized, so
that it has an RMS of one. Then tilt compensation, noise factor and
transition fadeouts are applied. The resulting coefficients are inserted
to the quantized MDCT spectrum ${\hat{X}}_{M}$ and replace the zeroes in
the noise filling segments. The following pseudo-code defines the exact
procedure:

##### 6.2.2.3.7 Apply global gain and LPC shaping in MDCT domain

The decoded global gain factor ${\hat{g}}_{\text{TCX}}$ is applied to
all MDCT coefficients. The LPC shaping of the MDCT spectrum applied on
encoder side is inverted by multiplying the spectral coefficients by the
LPC shaping gains$g_{\text{LPC}}$.

The computation of the shaping gains is performed in the same way as on
encoder side, see subclause 5.3.3.2.3.2.

The following pseudo-code defines how global gain and LPC shaping are
applied to the MDCT bins corresponding to the CELP frequency range:

For the remaining MDCT coefficients above the CELP frequency range (if
any) the last LPC shaping gain is used:

$X_{M}^{'}\left( i \right) = {\hat{g}}_{\text{TCX}} \cdot g_{\text{LPC}}\left( \text{63} \right) \cdot {\hat{X}}_{M}\left( i \right)\ ,\ i = L_{\text{TCX}}^{\left( \text{celp} \right)}\text{.}\text{.}\text{.}L_{\text{TCX}}^{\left( \text{bw} \right)} - 1$
(1767)

##### 6.2.2.3.8 IGF apply

##### 6.2.2.3.8.1 IGF independent noise filling {#igf-independent-noise-filling .H6}

IGF uses independent noise filling in the IGF range. Through independent
noise filling, core coder noise filling is replaced by random noise
which is de-correlated from the core coder noise filling. Therefore a
vector $t\left( 0 \right)$ is filled with either 0 or 1 by evaluating
the TCX noise-filling routine from subclause 6.2.2.3.6.3 such that every
subband, which is noise-filled by TCX noise-filling, represents a 1 in
$\phi$, all other entries are set to 0 in $\phi$.

First, the total noise energy $\phi$ in the IGF source range in the
decoded MDCT spectrum $X$ is calculated:

$E\left( k \right): = \underset{i = \text{minSB}}{\overset{t\left( 0 \right) - 1}{\sum_{}^{}}}\left( \phi\left( i \right) \cdot X\left( i \right)^{2} \right)$,
(1768)

where $E = 0$. The noise indicated by $\phi$ is replaced according to
the following formula:

$r:N \rightarrow R$ (1769)

where $X_{n}$ contains $X_{n}$ copies of the spectrum with independent
noise per copy, i.e. per IGF tile. For creating pseudo random numbers
r(i), the random generator described in subclause 6.2.2.3.6.3 is used.

The energy $\text{nT}$ of the inserted pseudo random numbers is measured
with

$E_{\text{IGF}}$. (1770)

Now the inserted noise is adjusted to the same energy level as the
original noise. Therefore the correction factor $g$ is calculated:

$g$ (1771)

Using $g$, the replaced noise is rescaled to match the original noise
energy level in $X$:

$X_{n}\left( i\text{,~}j \right): = \left\{ \begin{matrix}
g\left( j \right)� \cdot X_{n}\left( i\text{,~}j \right)\text{,~~}\phi\left( i \right) = 1 \\
X\left( i \right)\text{,~~}\phi\left( i \right) = 0 \\
\end{matrix} \right.\ ,\text{~~}\forall i \in \lbrack\text{minSB}\text{,~}\text{minSB} + 1\text{,~}\text{minSB} + 2\text{,~}\ldots,t\left( 0 \right)\lbrack\text{,~~}\forall j \in \lbrack 0\text{,~}1\text{,~}\ldots\text{,~}\text{nT}\lbrack$
(1772)

##### 6.2.2.3.8.2 IGF whitening generation {#igf-whitening-generation .H6}

In order to remove possible formant structure of the tiled signal $X$
and to suppress strong tonal components the routine
*IGF\_getWhiteSpectralData()* will be applied to the TCX spectrum $X$ if
the bitstream element $\text{currWLevel}\left( k \right)$ is 1 for any
tile $t$. The algorithm is a low complex simplification of the following
formula:

$Y\left( b \right) = \frac{X\left( b \right)}{\sqrt{{\sum_{}^{}}_{i = b - 7}^{b + 7}X\left( i \right)^{2}}}$
(1773)

which is a division of the spectrum by the square root of a moving
average calculated on the spectrum. $X\left( b \right)$ denotes the TCX
coefficient of the decoded core signal with index $b$ prior to
application of the LPC filter.

Since the above formula would need a division and a square root
operation per line $b$ -- two complex operations (18 and 10 OPS) -- the
operations are done in logarithmic domain, while the logarithm is
replaced with a low complex rounded integer logarithm to the basis 2.

$Y\left( b \right) = X\left( b \right) \cdot �2^{- 0\text{.}5� \cdot \text{INT}_{\text{LOG}_{2}}}$
(1774)

where

$\text{INT}_{\text{LOG}_{2}}\left( x \right) = \left\lfloor \frac{\text{log}\left( x \right)}{\text{log}\left( 2 \right)} \right\rfloor$
(1775)

The length of the moving average (MA) filter
$\text{Xma}_{b} = \underset{i = b - 7}{\overset{b + 7}{\sum_{}^{}}}X\left( i \right)^{2}$
is 15 bins in total.

The range of bins$b$ on which this whitening operation has to be carried
out is going from $\text{minSb}$ to $\text{startLine}$, where
$\text{startLine}$ is the index of the first scale factor band - 1.
Because $\text{minSb}$ is always greater 7, the MA filter will be
calculated from $\text{minSb} - 7$ on. However, the calculation of the
MA filter has to be different for the last $6$ bins below
$\text{startLine}$:

$\text{Xma}_{\text{stopLine} - n + 7 + 1} = \underset{i = \text{stopLine} - n}{\overset{\text{stopLine}}{\sum_{}^{}}}\frac{\text{15}}{n}X\left( i \right)^{2}\text{,~~}n = \left\lbrack \text{14}\text{.}\text{.}7 \right\rbrack$
(1776)

If the bitstream element $\text{currWLevel}\left( k \right)$ is 2 for
any tile $k$ no core signal will be copied but a sequence of
pseudo-random numbers will be used instead as described in subclause
6.2.2.3.6.2.

The seed for the pseudo random number generator (described in subclause
6.2.2.3.6.3) is derived from the TCX noise filling seed by:

$\text{IGF}_{\text{SEED}} = S_{\text{NF}} \cdot \text{31821} + \text{13849}$
(1777)

##### 6.2.2.3.8.3 IGF envelope reconstruction {#igf-envelope-reconstruction .H6}

The IGF envelope reconstruction tool shapes the noise components filled
into the gaps in the IGF range in order to adjust the spectral envelope
as a function of the transmitted IGF scale factors.

##### 6.2.2.3.8.3.1 Dequantizing IGF scale factors {#dequantizing-igf-scale-factors .H6}

For de-quantizing the IGF scale factors $N_{\text{bs}}$, transmitted in
the bitstream, to $N_{d}$ the following mapping is applied:

$N_{d}\left( k \right) = 2^{\frac{1}{4}N_{\text{bs}}\left( \left\lbrack k \right\rbrack \right) - 4},\text{~~}\forall k \in \lbrack 0\text{,~}1\text{,~}2,\ldots\text{,~}\text{nB}\lbrack$
(1778)

##### 6.2.2.3.8.3.2 Refining IGF scale factor borders {#refining-igf-scale-factor-borders .H6}

In order to optionally smooth the transmitted scale factors along the
frequency axis, a refinement of the IGF scale-factor borders is
introduced:

${t^{'}\left( 2k + 0 \right): = �t\left( k \right)\text{,~~\ \{}t}^{'}\left( 2k + 1 \right)�: = \left\lfloor t\left( k \right) + \frac{9}{\text{20}}\left( t\left( k + 1 \right) - t\left( k \right) \right) + \frac{1}{2} \right\rfloor\text{,~~}\forall k \in \lbrack 0\text{,~}1\text{,~}2,\ldots\text{,~}\text{nB}\lbrack$
(1779)

The de-quantized IGF scale factors shall be mapped:

$N_{d}^{'\left\lbrack 2k + 0 \right\rbrack}: = N_{d}^{'\left\lbrack 2k + 1 \right\rbrack}: = N_{d}\left\lbrack k \right\rbrack\text{,~~}\forall k \in \lbrack 0\text{,~}1\text{,~}2,\ldots\text{,~}\text{nB}\lbrack$
(1780)

For simplicity, $t\left\lbrack k \right\rbrack$ is also mapped:

$\begin{matrix}
t\left( k \right): = �t^{'}\left( k \right)\text{,~~}\forall k \in \lbrack 0\text{,~}1\text{,~}2,\ldots\text{,~}2\text{nB}\lbrack \\
N_{d}\left( k \right)�: = N_{d}^{'}\left( k \right)\text{,~~}\forall k \in \lbrack 0\text{,~}1\text{,~}2,\ldots\text{,~}2\text{nB}\lbrack \\
\end{matrix}$ (1781)

The IGF envelope refinement is active for bitrates $$64 kbps for all
operating modes WB, SWB, FB.

##### 6.2.2.3.8.3.3 Collecting energies below $t\left( 0 \right)$ {#collecting-energies-below-tleft-0-right .H6}

To stabilize energy distribution in the range of $t\left( 0 \right)$,
energy below $t\left( 0 \right)$ is collected:

$N_{b} = \sqrt{\frac{1}{\text{24}}\underset{i = t\left( 0 \right) - \text{24}}{\overset{t\left( 0 \right) - 1}{\sum_{}^{}}}X\left( i \right)^{2}}$
(1782)

The energy $N_{b}$ is later used to adapt the first IGF scale factor
band energy as described in subclause 6.2.2.3.8.3.7.

##### 6.2.2.3.8.3.4 Collecting residual energies in IGF range {#collecting-residual-energies-in-igf-range .H6}

The residual energy $N_{s}$ determines the energy of the non-zero
subbands in the IGF range:

$N_{s}\left( k \right)�\text{~:} = \underset{i = t\left( k \right)}{\overset{t\left( k + 1 \right) - 1}{\sum_{}^{}}}X\left( i \right)^{2}\text{,~~}\forall k \in \lbrack 0\text{,~}1\text{,~}2,\ldots\text{,~}2\text{nB}\lbrack$
(1783)

$N_{s}$ is therefore the energy of the de-quantized subband values above
$t\left( 0 \right)$ which are not quantized to zero by the tonal mask
detection of the encoder described in subclause 5.3.3.2.11.5.

##### 6.2.2.3.8.3.5 Collecting tile energies in IGF range {#collecting-tile-energies-in-igf-range .H6}

The tile energy $N_{\text{IGF}}$ determines the energy of the signal
which is filled into the gaps in the IGF range:

$N_{\text{IGF}}\left( k \right)�\text{~:} = \underset{i = t\left( k \right)}{\overset{t\left( k + 1 \right) - 1}{\sum_{}^{}}}X_{\text{IGF}}\left( i \right)^{2}b\left( i \right)\text{,~~}\forall k \in \lbrack 0\text{,~}1\text{,~}2,\ldots\text{,~}\text{nB}\lbrack$
(1784)

$b\left( i \right) = \left\{ \begin{matrix}
0\text{,~~}X\left( i \right) \neq 0 \\
1\text{,~~}\text{otherwise} \\
\end{matrix} \right.\ $ (1785)

where $X_{\text{IGF}}$ is the signal after filling the gaps in $X$ using
the mapping function $m$ as described in subclause 5.3.3.2.11.1.8:

$X_{\text{IGF}}\left( i \right): = \left\{ \begin{matrix}
X\left( m\left( i \right) \right)\text{,~~}X\left( i \right) = 0 \\
X\left( i \right)\text{,~~}\text{otherwise} \\
\end{matrix} \right.\ \text{,~~}\forall i \in \lbrack t\left( 0 \right)\text{,~}t\left( 1 \right)\text{,~}\ldots\text{,~}t\left( 2\text{nB} \right)\lbrack$
(1786)

$N_{\text{IGF}}$ is therefore the energy of the synthesized subband
values above $t\left( 0 \right)$ which are quantized to zero by the
tonal mask detection of the encoder described in subclause 5.3.3.2.11.5.

##### 6.2.2.3.8.3.6 Rescaling IGF scale factor band energies {#rescaling-igf-scale-factor-band-energies .H6}

The rescaling of the IGF scale factors has to be done in order to bring
them on the correct energy level for the subsequent calculation of the
IGF gains. In dependency of the refinement rescaling is applied on a
scale factor band basis or on a group of scale factor bands. The
rescaled IGF scale factor band energy is therefore called IGF
destination energy $N_{d}$.

In case refinement is not active, the rescaling is applied as follows:

$N_{d}\left( k \right)�: = \sqrt{\text{max}\left( 0\text{.}\text{001}� \cdot \frac{N_{s}\left( k \right)}{t\left( k + 1 \right) - t\left( k \right)},N_{d}\left( k \right)^{2} - \frac{N_{s}\left( k \right)}{t\left( k + 1 \right) - t\left( k \right)} \right)}\text{,~~}\forall k \in \lbrack 0\text{,~}1\text{,~}2,\ldots\text{,~}\text{nB}\lbrack$
(1787)

In case refinement is active, two subsequent scale factor band energies
are mapped:

$N_{d}\left( k \right): = \left\{ \begin{matrix}
\sqrt{\text{max}\left( 0\text{.}\text{001} \cdot �\frac{N_{s}\left( k \right) + N_{s}\left( k + 1 \right)}{t\left( k + 2 \right) - t\left( k \right)},N_{d}\left( \frac{k}{2} \right)^{2} - \frac{N_{s}\left( k \right) + N_{s}\left( k + 1 \right)}{t\left( k + 2 \right) - t\left( k \right)} \right)}\text{,~~~}\forall k \in \lbrack 0\text{,~}2\text{,~}4,\ldots\text{,~}2\text{nB}\lbrack \\
N_{d}\left( k - 1 \right)\text{,~~~}\forall k \in \lbrack 1\text{,~}3\text{,~}5,\ldots\text{,~}2\text{nB}\lbrack \\
\end{matrix} \right.\ $ (1788)

##### 6.2.2.3.8.3.7 Adaption of IGF scale factor band energies {#adaption-of-igf-scale-factor-band-energies .H6}

The IGF scale factor band energies have to be adapted to fulfil the
signal requirements. The first scale factor band energy is adapted to
the energy below $t\left( 0 \right)$ using $N_{b}$ as introduced in
subclause 6.2.2.3.8.3.3:

$N_{d^{'}}\left( 0 \right): = \left\{ \begin{matrix}
N_{d}\left( 0 \right) + \text{fFac} \cdot �\left( N_{b} - N_{d}\left( 0 \right) \right)\text{,~~~}N_{b} < N_{d}\left( 0 \right) \\
N_{d}\left( 0 \right)\text{,~~~}\text{otherwise} \\
\end{matrix} \right.\ $ (1789)

where $N_{d^{'}}$ is the adapted IGF scale factor band energy $N_{d}$
and $\text{fFac}$ is the adaption factor for the first scale factor band
energy according to table 1:

Table 166: IGF scale factor band energy adaption factors

  ------------ ------ --------------- --------------- ---------------
  Bitrate      Mode   $\text{fFac}$   $\text{gFac}$   $\text{lFac}$
  9.6 kbps     WB     0.7             0.8             0.6
  9.6 kbps     SWB    0               1.0             1.0
  13.2 kbps    SWB    0.2             0.93            0.85
  16.4 kbps    SWB    0.2             0.93            0.85
  24.4 kbps    SWB    0.2             0.965           0.85
  32.0 kbps    SWB    0.2             0.965           0.85
  48.0 kbps    SWB    0.2             1.0             1.0
  64.0 kbps    SWB    0.2             1.0             1.0
  16.4 kbps    FB     0.2             0.93            0.85
  24.4 kbps    FB     0.2             0.965           0.85
  32.0 kbps    FB     0.2             0.965           0.85
  48.0 kbps    FB     0.2             1.0             1.0
  64.0 kbps    FB     0.2             1.0             1.0
  96.0 kbps    FB     0               1.0             1.0
  128.0 kbps   FB     0               1.0             1.0
  ------------ ------ --------------- --------------- ---------------

The last scale factor band energy is adapted as follows:

$N_{d^{'}}\left( 2\text{nB} - 1 \right) = \text{lFac} \cdot �N_{d}\left( 2\text{nB} - 1 \right)$
(1790)

where $\text{lFac}$ is the adaption factor for the last scale factor
band energy according to table 167.

If refinement is active and $\text{currWLevel}\left( 0 \right) = 2$, the
remaining scale factor band energies are low-pass filtered in order to
smooth the frequency envelope:

$N_{d^{'}}\left( k \right): = �0\text{.}\text{201} \cdot �N_{d}\left( k - 1 \right) + 0\text{.}\text{389} \cdot �N_{d}\left( k \right) + 0\text{.}\text{41} \cdot �N_{d}\left( k + 1 \right)\text{,~~}\forall k \in \lbrack 1\text{,~}2\text{,~}3,\ldots\text{,~}\text{nB} - 1\lbrack$
(1791)

Otherwise the scale factor band energies are not affected by further
modifications:

$N_{d^{'}}\left( k \right)�: = N_{d}\left( k \right)\text{,~~}\forall k \in \lbrack 1\text{,~}2\text{,~}3,\ldots\text{,~}\text{nB} - 1\lbrack$
(1792)

##### 6.2.2.3.8.3.8 Calculation of IGF gain factors {#calculation-of-igf-gain-factors .H6}

The IGF gain factors are used to finally shape the tiled subband values
in order to adjust the spectral envelope of the synthesized signal above
$t\left( 0 \right)$. First, the target energy level $N_{t}$ has to be
calculated:

$N_{t}\left( k \right)�: = \underset{i = 0}{\overset{\text{hop} - 1}{\sum_{}^{}}}\left( N_{d^{'}}\left( \text{min}\left( k + i\text{,~}2\text{nB} - 1 \right) \right)^{2} \cdot t\left( \text{min}\left( k + i + 1\text{,~}2\text{nB} \right) \right) - t\left( \text{min}\left( k + i\text{,~}2\text{nB} \right) \right) \right),$
(1793)

$\forall k \in \lbrack 0\text{,~}\text{hop},2\text{hop}\text{,~}3\text{hop}\text{,~}\ldots\text{,~}2\text{nB}\lbrack$
(1794)

where $\text{hop}$ is the hop-size of the refinement in dependency of
$\text{currWLevel}\left\lbrack 0 \right\rbrack$ and the maximal possible
hop-size $\text{mHop}$ according to table 168:

$\text{hop} = \text{min}\left( \text{mHop}\text{,~}\left\{ \begin{matrix}
4\text{,~~}\text{currWLevel}\left( 0 \right) = 0 \\
1\text{,~~}\text{currWLevel}\left( 0 \right) = 2 \\
2\text{,~~~~~~~~~~~~~~~~~~~~~~~~~~~}\text{otherwise} \\
\end{matrix} \right.\  \right)$ (1795)

Table 169: Maximal IGF hop-size

  ------------ ------ ---------------
  Bitrate      mode   $\text{mHop}$
  9.6 kbps     WB     4
  9.6 kbps     SWB    2
  13.2 kbps    SWB    4
  16.4 kbps    SWB    4
  24.4 kbps    SWB    4
  32.0 kbps    SWB    4
  48.0 kbps    SWB    4
  64.0 kbps    SWB    4
  16.4 kbps    FB     4
  24.4 kbps    FB     2
  32.0 kbps    FB     2
  48.0 kbps    FB     2
  64.0 kbps    FB     2
  96.0 kbps    FB     1
  128.0 kbps   FB     1
  ------------ ------ ---------------

Second, a normalization term $\text{norm}$ for normalizing the target
energy $N_{t}$ is calculated as follows:

$\text{norm}\left( k \right)�: = \underset{i = 0}{\overset{\text{hop} - 1}{\sum_{}^{}}}\left( t\left( \text{min}\left( k + i + 1\text{,~}2\text{nB} \right) \right) - t\left( \text{min}\left( k + i\text{,~}2\text{nB} \right) \right) \right),$
(1796)

$\forall k \in \lbrack 0\text{,~}\text{hop},2\text{hop}\text{,~}3\text{hop}\text{,~}\ldots\text{,~}2\text{nB}\lbrack$
(1797)

Finally, the IGF gain factors have to be calculated according to the
following formula:

$g\left( k \right) = \sqrt{\frac{1}{N_{\text{IGF}}\left( k \right)}\left( t\left( k + 1 \right) - t\left( k \right) \right)\left( \text{gFac}� \cdot \sqrt{\frac{\text{hop} \cdot �N_{t}\left( k \right)}{\text{norm}\left( k \right)}} \right)^{2}}\text{,~~}\forall k \in \lbrack 0\text{,~}\text{hop},2\text{hop}\text{,~}3\text{hop}\text{,~}\ldots\text{,~}2\text{nB}\lbrack$
(1798)

where $\text{gFac}$ is the general adaption factor for all scale factor
band energy according to table 170.

If hop-size $\text{hop} > 1$, the IGF gain factors in between a
particular hop are hold beginning at the hop-start:

$g\left( k \right) = g\left( i \right)\text{,~~}\forall i \in \lbrack 0\text{,~}\text{hop},2\text{hop}\text{,~}3\text{hop}\text{,~}\ldots\text{,~}2\text{nB}\lbrack\text{,~~}\forall k \in \lbrack i + 1,i + 2\text{,~}\ldots\text{,~}i + \text{hop}\lbrack$
(1799)

void (1800)

##### 6.2.2.3.8.3.9 IGF envelope adjustment {#igf-envelope-adjustment .H6}

With the calculated IGF gain factors $g$ as described in subclause
6.2.2.3.8.3.8, the envelope of the spectrum above $t\left( 0 \right)$ is
adjusted as follows:

$X\left( \text{tb} \right): = \left\{ \begin{matrix}
g\left( \left\lbrack k \right\rbrack \right)� \cdot X_{\text{IGF}}\left( \text{tb} \right)\text{,~~}X\left( i \right) = 0 \\
X_{\text{IGF}}\left( \left\lbrack \text{tb} \right\rbrack \right)\text{,~~}\text{otherwise} \\
\end{matrix} \right.\ \text{,~}\forall\text{tb} \in \lbrack t\left( k \right)\text{,~}t\left( k \right) + 1\text{,~}t\left( k \right) + 2\text{,~}\ldots\text{,~}t\left( k + 1 \right)\lbrack\text{,~~}\forall k \in \lbrack 0\text{,~}1\text{,~}2,\ldots\text{,~}\text{nB}\lbrack$
(1799)

where
$t\left( 0 \right),t\left( 1 \right),\ldots,t\left( \text{nB} \right)$
shall be already mapped with the function $\text{tF}\text{,~}$see
subclause 5.3.3.2.11.1.1, and $\text{nB}$ being the number of bands.
$X_{\text{IGF}}$ *is the gap-filled signal in accordance with subclause
6.2.2.3.8.3.5.*

##### 6.2.2.3.9 Inverse window grouping (TCX5 separation)

If the configuration, determined as described in subclause 6.2.4.2,
indicates that some sub-frames are coded using TCX5 then a sub-frame
containing MDCT bins of 2 TCX5 sub-frames is de-interleaved to form 2
consecutive TCX5 sub-frames before the optional Temporal Noise Shaping,
the optional IGF temporal flattening and before the transformation with
the inverse MDCT:

$\begin{matrix}
X_{M}^{1}(k) = X_{M}(2k), \\
X_{M}^{2}(k) = X_{M}(2k + 1),\ k = 0,\text{.}\text{.}\text{.},\frac{L}{4} - 1 \\
\end{matrix}$ (1800)

##### 6.2.2.3.10 Temporal Noise Shaping

The decoding process for Temporal Noise Shaping is carried out
separately on each window of the current frame by applying the so called
lattice filter to selected regions of the spectral coefficients (see in
subclause 5.3.3.2.2). The number of noise shaping filters applied to
each window is specified by \"nMaxFilters \".

For TCX5 the same rearrangement is done as described in subclause
5.3.3.2.2 prior to the TNS filtering and the rearrangement is reverted
after the filtering.

First the transmitted filter coefficients have to be decoded, i.e.
conversion to signed numbers, inverse quantization. Then the so called
lattice filters are applied to the target frequency regions of the
spectral coefficients (see subclause 5.3.3.2.2). The maximum possible
filter order is defined by the constant TNS\_MAX\_FILTER\_ORDER.

The application of TNS shaping filter is done before the optional IGF
temporal flattening and before the transformation with the inverse MDCT

The decoding process for one window can be described as follows pseudo
code:

/\* TNS decoding for one window \*/

tns\_decode()

{

set\_zero( state, TNS\_MAX\_FILTER\_ORDER );

for (iFilter = nMaxFilters-1; iFilter \>= 0; iFilter\--) {

tns\_decode\_coef( order, index\[iFilter\], parCoeff\[iFilter\] );

tns\_filter( spectrum, startLine, endLine, parCoeff\[iFilter\], order,
state );

}

}

/\* Decoder transmitted coefficients index\[\] for one TNS filter \*/

tns\_decode\_coef( order, index\[\], parCoeff\[\] )

{

/\* Conversion to signed integer \*/

for (i = 0; i \< order; i++)

tmp\[i\] = index\[i\] + (1 \<\< (TNS\_COEF\_RES-1));

/\* Inverse quantization \*/

iqfac = ((1 \<\< (TNS\_COEF\_RES-1)) - 0.5) / (π/2.0);

iqfac\_m = ((1 \<\< (TNS\_COEF\_RES-1)) + 0.5) / (π/2.0);

for (i = 0; i \< order; i++) {

parCoeff\[i\] = sin( tmp\[i\] / ((tmp\[i\] \>= 0) ? iqfac : iqfac\_m) );

}

}

/\* Lattice filter \*/

tns\_filter( spectrum\[\], startLine, endLine, parCoeff\[\], order,
state )

{

for (j = startLine; j \<= endLine; j++) {

spectrum\[j\] -= parCoeff\[order-1\] \* state\[order-1\];

for (i = order-2; i \>= 0; i\--) {

spectrum\[j\] -= parCoeff\[i\] \* state\[i\];

state\[i+1\] = parCoeff\[i\] \* spectrum\[j\] + state\[i\];

}

state\[0\] = spectrum\[j\];

}

}

Filter order 1 with the first coefficient equal to 0 identifies disabled
filter.

Please note that this pseudo code uses a „C"-style interpretation of
arrays and vectors, i.e. if parCoeff describes the coefficients for all
filters, parCoeff\[iFilter\] is a pointer to the coefficients of one
particular filter.

##### 6.2.2.3.11 IGF temporal flattening

The reconstructed signal by IGF is temporally flattened in the frequency
domain when $\text{isIgfTemFlat} = 1$. The temporal flattening is
performed in a frequency-selective manner as follows.

The selection of the spectral contents to be temporally flattened is
done by comparing the quantized spectral coefficients with 0 and the
contents whose coefficients are quantized to 0 are selected.

In order to maintain the significant spectral contents, they are
temporarily replaced by the spectra which are similarly generated to the
filled spectra by IGF:

$X_{\text{tempFlat}}\lbrack\text{tb}\rbrack = \left\{ \begin{matrix}
X\lbrack\text{tb}\rbrack & X_{\text{dec}}\lbrack\text{tb}\rbrack = 0 \\
g\lbrack k\rbrack X_{\text{dec}}\lbrack m(k)\rbrack & \text{abs}(X_{\text{dec}}\lbrack\text{tb}\rbrack) > 0 \\
\end{matrix} \right.\ ,\text{\ \ \ }t(k) \leq \text{tb} < t(k + 1),\text{\ \ \ }k = 0,1,\ldots,\text{nB} - 1$
(1803)

where $X_{\text{dec}}\lbrack\text{tb}\rbrack$ is the quantized MDCT
coefficient after arithmetic decoding and $X\lbrack\text{tb}\rbrack$ is
the reconstructed MDCT coefficient by IGF.

The linear prediction of the spectra
$X_{\text{tempFlat}}\lbrack\text{tb}\rbrack$ is done and the linear
prediction coefficients
$a_{\text{igfTemp}}(m),\text{\ \ \ }m = 1,2,\ldots,8$ are calculated.
Then the temporally flattened spectrum is given by the following
filtering:

$X_{\text{tempFlat}^{\prime}}\lbrack\text{tb}\rbrack = X_{\text{tempFlat}}\lbrack\text{tb}\rbrack + \sum_{m = 1}^{M}{a_{\text{igfTemp}}(m)} \cdot X_{\text{tempFlat}}\lbrack\text{tb} - m\rbrack,\text{\ \ \ }t(k) \leq \text{tb} < t(k + a),\text{\ \ \ }k = 0,1,\ldots,\text{nB} - 1$.
(1801)

Finally, the significant spectral contents are restored by:

$X_{\text{tempFlat}^{\prime}}\lbrack\text{tb}\rbrack = \left\{ \begin{matrix}
X_{\text{tempFlat}^{\prime}}\lbrack\text{tb}\rbrack & X_{\text{dec}}\lbrack\text{tb}\rbrack = 0 \\
X\lbrack\text{tb}\rbrack & \text{abs}(X_{\text{dec}}\lbrack\text{tb}\rbrack) > 0 \\
\end{matrix} \right.\ ,\text{\ \ \ }t(k) \leq \text{tb} < t(k + a),\text{\ \ \ }k = 0,1,\ldots,\text{nB} - 1$,
(1805)

and then the frequency-selectively temporally flattened spectrum
$X_{\text{tempFlat}^{\prime}}\lbrack\text{tb}\rbrack$ is output to IMDCT
for getting the time domain signal.

### 6.2.3 High Quality MDCT decoder (HQ)

#### 6.2.3.1 Low-rate HQ decoder

##### 6.2.3.1.1 Mode decoding

Based on the encoded bandwidth and operated bit-rate, mode information
is decoded from 1 or 2 bits. Based on the decoded mode information,
decoding configurations like band structures are set. The band structure
definition for NB, WB, SWB, and FB is the same as encoder presented in
table 103 to 108.

##### 6.2.3.1.2 Energy Envelope decoding

From the received low-rate HQ envelope coding method bit and coding mode
bit, the low-rate HQ energy decoding mode is determined and the coded
quantization differential indices are decoded by the Large symbol
decoding method or the Small symbol decoding method. From the received
coding mode bits for energy envelope decoding, the envelope coding mode
flag $\text{DENG}_{\text{CMODE}}$is determined, based on the coding mode
the transmitted differential indices are decoded. For example, if flag
$\text{DENG}_{\text{CMODE}}\ $ has value 1 the Small symbol decoding
method is used otherwise the Large symbol decoding method is used for
decoding the differential indices.

The final resulting reconstructed quantized energies
${\hat{I}}_{M}(b)\ ,\ b = 0,\ldots,N_{\text{bands}} - 1$ are obtained
equally as in the encoder, described in subclause 5.3.4.1.3.

##### 6.2.3.1.2.1 Small symbol decoding method {#small-symbol-decoding-method .H6}

If the flag $\text{DENG}_{\text{CMODE}}\ $ has value 1, the flag
*LC~mode~* information is extracted from the bit stream. If the
*LC~mode\ ~*has value 1 resized Huffman decoding mode is used otherwise
context based Huffman decoding mode is used for decoding the
differential indices.

*If IsTransient* is *True*,

The decoded differential
indices$\text{ΔI}_{M}(b)\ ,\ b = 1,\text{.}\text{.}\text{.}\text{.},N_{\text{bands} - 1}$
is extracted either from context based or resized Huffman coding mode
according to flag *LC~mode~* and the differential indices for band
*b*=0$\text{ΔI}_{M}(0)$, are up packed directly with 5 bits. The decoded
differential indices are adjusted to extract the original values
according to

$\text{ΔI}_{M}(b) \leftarrow \text{ΔI}_{M}(b) - \text{15}\ ,\ b = 0,\text{.}\text{.}\text{.}\text{.},N_{\text{bands} - 1}$
(1802)

*If IsTransient* is *False*,

The decoded differential
indices$\text{ΔI}_{M}(b)\ ,\ b = 1,\text{.}\text{.}\text{.}\text{.},N_{\text{bands} - 1}$
is extracted either from context based or resized Huffman coding mode
according to flag *LC~mode~* and the differential indices for band
*b*=0$\text{ΔI}_{M}(0)$, are up packed directly with 5 bits. Once the
differential indices are extracted, least significant code
$R_{\text{LSB}}$ are up packed directly with 1 bit and the differential
indices are reconstructed according to

$\text{ΔI}_{M}(b)\  = 2\text{ΔI}_{M}(b)\ \text{OR}\ R_{\text{LSB}}(\text{Binary}\ \text{operation})\ b = 0,\text{.}\text{.}\text{.}\text{.},N_{\text{bands} - 1}$
(1803)

The decoded differential indices are adjusted to extract the original
values according to

$\begin{matrix}
\text{ΔI}_{M}(b) \leftarrow \text{ΔI}_{M}(b) - \text{32}\ ,\ b = 1,\text{.}\text{.}\text{.}\text{.},N_{\text{bands} - 1} \\
\text{ΔI}_{M}(0) \leftarrow \text{ΔI}_{M}(0) - \text{46} \\
\end{matrix}$ (1804)

##### 6.2.3.1.2.1.1 Context based Huffman decoding mode {#context-based-huffman-decoding-mode .H6}

If the context based Huffman decoding mode has been determined, the
decoding is performed by referring table 171 and table 172 based on the
context described in subclause 5.3.4.1.3.3.1. Four LSBs of entries in
table 171 and table 172 indicates how many bits shall be read from
bit-stream buffer to decode the next symbol and the signs indicate if
the Huffman decoding is terminated or not. The procedure of how to
perform Huffman decoding is shown below:

i=0

while( hufftab\[i\] \> 0)

{

read\_bits += hufftab\[i\] & 0xF

i = (hufftab\[i\]\>\>4)+read\_bits(hufftab\[i\] & 0xF)

}

return hufftab\[i\]

Table 171: Huffman decoding table for the context based Huffman decoding
(*group0*,*group2*)

  ------- ------- ------- ------- ------- ------- ------- ------- ------- -------
  Index   Code    Index   Code    Index   Code    Index   Code    Index   Code
  0       0X13    11      -0X0D   22      -0X18   33      0X41    44      -0X05
  1       -0X10   12      0X51    23      -0X16   34      -0X1C   45      -0X1E
  2       -0X0F   13      0X62    24      0X71    35      -0X08   46      -0X04
  3       -0X11   14      -0X14   25      -0X0B   36      0X31    47      -0X1F
  4       0X51    15      0X81    26      0X71    37      0X41    48      0X11
  5       0X61    16      -0X0C   27      -0X1A   38      -0X1D   49      -0X03
  6       -0X0E   17      0X81    28      0X71    39      -0X06   50      0X11
  7       -0X12   18      -0X15   29      -0X09   40      0X31    51      -0X02
  8       0X51    19      -0X17   30      -0X1B   41      0X41    52      0X11
  9       0X61    20      0X71    31      -0X0A   42      -0X07   53      -0X01
  10      -0X13   21      0X81    32      -0X19   43      0X41    54      0X00
  ------- ------- ------- ------- ------- ------- ------- ------- ------- -------

Table 172: Huffman decoding table for the context based Huffman decoding
(*group1*)

  ------- ------- ------- ------- ------- ------- ------- ------- ------- -------
  Index   Code    Index   Code    Index   Code    Index   Code    Index   Code
  0       0X12    12      -0X12   24      0X51    36      -0X18   48      -0X1B
  1       0X41    13      0X42    25      0X61    37      -0X05   49      -0X1A
  2       -0X0F   14      -0x0C   26      -0X16   38      -0X04   50      0X11
  3       0X41    15      0X61    27      -0X09   39      -0X03   51      0X00
  4       -0X10   16      -0X13   28      0X51    40      0X51    52      0X11
  5       -0X0E   17      0X61    29      0X61    41      -0X06   53      -0X1D
  6       0X31    18      0X71    30      -0X17   42      0X51    54      0X11
  7       -0X11   19      -0X0A   31      0X62    43      -0X19   55      -0X1E
  8       0X31    20      0X71    32      -0X08   44      0X51    56      -0X1F
  9       0X41    21      -0X0B   33      0X81    45      -0X01   57      -0X1B
  10      -0X0D   22      -0X14   34      -0X07   46      -0X1C   \-      \-
  11      0X41    23      -0X15   35      0X81    47      -0X02   \-      \-
  ------- ------- ------- ------- ------- ------- ------- ------- ------- -------

##### 6.2.3.1.2.1.2 Resized Huffman decoding mode {#resized-huffman-decoding-mode .H6}

If *IsTransient* is *True*

If the frame is Transient, the Huffman decoding is then performed on the
transmitted differential indices. The Huffman codes for the differential
indices are given in table 111 in subclause 5.3.4.1.3.3.

For Non-Transient frames, the Huffman decoding is then performed on the
transmitted differential indices. The Huffman codes for decoding the
indices are given in table 115 in subclause 5.3.4.1.3.3.3. The
differential indices decoded using table 115 takes the form,
$\Delta I_{M}^{'}(b)$the decoded differential indices
$\Delta I_{M}^{'}(b)$ are reconstructed which is exactly reverse to the
encoder described in subclause 5.3.4.1.3.3.3 equation (1040). The way to
reconstruct the differential index, which corresponds to the
modification in encoder, can be done as shown in the following equation.

![](media/image4.wmf){width="4.333333333333333in"
height="0.8229166666666666in"} (1809)

##### 6.2.3.1.2.2 Large symbol decoding method {#large-symbol-decoding-method .H6}

If the Large symbol coding method is determined, the encoded envelope
data should be decoded using the reverse process of encoding either the
pulse mode or the scale mode as described in subclause 5.3.4.1.3.4

The Huffman data in the encoded envelope data is decoded by a Huffman
decoding method described in subclause 6.2.3.1.2.1.1 using table 173.

Table 174: Huffman decoding table for the Large symbol decoding method

  ------- ------- ------- ------- ------- -------
  Index   Code    Index   Code    Index   Code
  0       0X11    5       0X21    10      -0X01
  1       0X21    6       -0X02   11      -0X06
  2       -0X04   7       -0X05   12      0X11
  3       0X21    8       0X11    13      -0X07
  4       -0X03   9       0X21    14      -0X00
  ------- ------- ------- ------- ------- -------

##### 6.2.3.1.3 Spectral coefficients decoding

##### 6.2.3.1.3.1 Normal Mode {#normal-mode .H6}

Figure 94 shows the overview of the normal mode decoder.

![](media/image5.wmf){width="6.5in" height="2.8541666666666665in"}

Figure 94: Block diagram of the Normal mode decoder overview

##### 6.2.3.1.3.1.1 Energy envelope decoding {#energy-envelope-decoding-1 .H6}

Details are described in subclause 6.2.3.1.2.

##### 6.2.3.1.3.1.2 Tonality flag decoding {#tonality-flag-decoding .H6}

Tonality flags described in subclause 5.3.4.1.4.1.3 are decoded and used
for calculation of the bit allocations.

##### 6.2.3.1.3.1.3 Bit allocation {#bit-allocation .H6}

The processing is in the same manner with the one at the encoder side.

Firstly, the fine gain adjustment bits are derived.

Secondly, the bands of the limited-band mode are identified based on the
decoded limited-band mode flags, and their corresponding bandwidths are
set if the limited-band mode is used in encoding. As is described in
5.3.4.1.4.1.4.4.2, the band is limited to the vicinity of the maximum
amplitude spectrum frequency of the previous frame. The position of the
maximum amplitude spectrum frequency of the previous frame is stored in
a memory, which was searched using the decoded MDCT spectrum in the
previous frame. The information of the limited band (i.e. identified
vicinity of the maximum amplitude spectrum frequency position) is output
to the TCQ decoder along with the bit budget allocated through the
following bit allocation process.

Thirdly, bands encoded using PFSC are identified based on the decoded
tonality flags among the four highest bands and necessary bits (1 or 2
bits) are allocated to each of the identified bands.

Finally, remaining bits are allocated to other bands based on perceptual
importance using the decoded quantized band energies. When there is any
band whose assigned bit results in zero in the four bands, such band is
re-identified as a PFSC encoding band and the bit allocations are
re-calculated.

##### 6.2.3.1.3.1.4 Fine structure decoding {#fine-structure-decoding .H6}

##### 6.2.3.1.3.1.4.1 TCQ decoding {#tcq-decoding .H6}

##### 6.2.3.1.3.1.4.1.1 Joint USQ and TCQ {#joint-usq-and-tcq .H6}

In order to de-quantize the fine structure of the normalized spectrum,
the ISC and the information for the selected ISCs in each band are
decoded by the position, number, sign and magnitude of the ISCs.

The magnitude information is decoded by the joint USQ and TCQ with an
arithmetic decoding, while the position, number and sign are decoded by
an arithmetic decoding.

The decoding method is selected at the Selecting Decoding Method block
by the bit allocation and the information for each band. If a bit
allocated for a band is zero, all the samples in the band are decoded to
zero by the zero decoding block. Otherwise, each band is decoded by the
selected de-quantizer.

The quantizer selection information selects between the TCQ and USQ
quantizes to get the same results as that of encoder.

The Estimating Number of Pulses block determines the number of pulses
per a band using the band length and the bit allocation data R\[\]. Its
principle of operation is same as that of the method which is used in
the Scaling Bands module in encoder, see subclause 5.3.4.1.4.1.5.1.1.

The Lossless Decoding and the Decoding Position Info block reconstruct
the position information of the ISCs, i.e. the number of ISCs and their
positions. This process is similar to encoder side and same
probabilities should be used for the proper decoding, see subclause
5.3.4.1.4.1.5.1.

In the Joint USQ and TCQ Decoding block, the magnitudes of the gathered
ISCs are decoded by the arithmetic decoding and de-quantized by the
joint USQ and TCQ decoding. In this block the non-zero position and the
number of the ISC is utilized for the arithmetic decoding. The joint USQ
and TCQ have two types of decoding methods. One is TCQ and USQ with
2^nd^ bit allocation for the NB and WB, and the other one is the LSB TCQ
for USQ for the SWB and FB. These methods are described in subclause
6.2.3.1.3.1.4.1.2 TCQ and USQ with second bit allocation and
6.2.3.1.3.1.4.1.3 LSB TCQ for USQ.

In the Decoding Signs block, the sign information of the selected ISC is
decoded by the arithmetic decoding with equal probabilities for the
positive and negative signs.

In order to recover the quantized components for each band, the
position, sign and magnitude information is added to the quantized
components to recover the real components at the Recovering Quantized
Components block.

At this point the determined bands with no transmitted data are filled
by zeroes. Then the number of pulses in the non-zero bands is estimated
and the position information, including the number and position of ISCs,
is decoded using this estimated number. After the magnitude information
is decoded using the lossless decoder, the joint USQ and TCQ decoding is
performed. For non-zero magnitude values the signs and quantized
components are finally reconstructed.

In the Inverse Scaling Bands block, the inverse scaling of the quantized
components is performed by using the transmitted norm information. The
inverse scaled signal is the output of the TCQ decoding.

![](media/image6.wmf){width="4.947916666666667in"
height="3.9270833333333335in"}

Figure 95: Block diagram of fine structure decoding using TCQ

##### 6.2.3.1.3.1.4.1.2 TCQ and USQ with second bit allocation {#tcq-and-usq-with-second-bit-allocation .H6}

The general de-quantization and decoding scheme of the TCQ and USQ with
second bit allocation consists of several main blocks: quantizer
decision, TCQ decoder, USQ decoder, lossless decoder, and Second bit
allocation. In the quantizer decision module the quantization mode of
the current band is selected by using the results of the Selecting
Decoding Method block. Then the selected decoder restores the current
band in association with the lossless decoder, based on the arithmetic
decoding with the transmitted bit stream.

![](media/image7.wmf){width="6.6875in" height="2.0520833333333335in"}

Figure 95: Block diagram of **TCQ and USQ decoding with second bit
allocation**

The decoding process is started by the recovering the non-zero bands and
positions using the transmitted bit-stream and the bit allocation R\[\]
for the selected quantizer. By using this information, the appropriate
magnitude for the decoded band is selected. The difference between bit
allocation R\[\] and actual decoded bits per band is accumulated and
called the surplus. This surplus will be used while decoding two band
determined by second bit allocation procedure described in encoder in
subclause 5.3.4.1.4.1.5.1.2.

The magnitude decoding based on binary arithmetic decoding is as
follows. First the probability of symbol is calculated by the equations
in encoder subclause 5.3.4.1.4.1.5.1.2. Then the number of pulses for
each magnitude is decoded by using the probabilities ${\hat{p}}_{1}$ and
${\hat{p}}_{0}$, where ${\hat{p}}_{1}$corresponds to last pulse in
magnitude and ${\hat{p}}_{0}$ to all other pulses. The magnitude of the
pulse probabilities are then modified after this calculation with
respect to the trellis code limitation, i.e. magnitudes that are
impossible are assigned zero probability.

This algorithm was modified to save complexity for bands with a large
number of pulses. The procedure is same as that of encoder subclause
5.3.4.1.4.1.5.1.2.

Location decoding is done based on the same algorithm as that of
magnitudes decoding and uses the same complexity reduction technique.

Signs are decoded with the arithmetic decoder, using equal probabilities
of positive and negative signs.

##### 6.2.3.1.3.1.4.1.3 LSB TCQ for USQ {#lsb-tcq-for-usq .H6}

The idea of the LSB TCQ for USQ is to use advantages of both quantizers
(USQ and TCQ) in one scheme and exclude the path limitation from the
TCQ.

![](media/image8.wmf){width="6.697916666666667in" height="2.78125in"}

Figure 96: **Block diagram for LSB TCQ decoding**

The decoding process starts from receiving the bit allocation R\[\] and
the decoding of the band information including:

-   Number of nonzero positions for ISCs

-   Nonzero positions

-   USQ magnitude

-   Signs for nonzero magnitudes

First the number of nonzero pulses and their positions are decoded using
the arithmetic decoder. Then the USQ magnitudes are decoded band by band
using bit allocation with surplus control. This generates Delta values
in the same manner as the encoder, see subclause 5.3.4.1.4.1.5.1.3. The
difference between the bit allocation R\[\] and actual decoded bits per
band is accumulated and called the surplus, which is then used in the
next bands.

The algorithms used for decoding positions and magnitudes are the same
as those described in subclause 6.2.3.1.3.1.4.1.2 in TCQ and USQ
decoder.

After receiving the USQ magnitudes, the TCQ path is decoded from the
bit-stream using the arithmetic decoder.

The decoded path is used to reconstruct the residual array according to
the decoded trellis state. From each path bit, two LSB bits are
generated in the residual array. This process shown in pseudo code:

for( state = 0, i = 0; i \< bcount; i++)

{

residualbuffer\[2\*i\] = dec\_LSB\[state\]\[dpath\[i\]\] & 0x1;

residualbuffer \[2\*i + 1\] = dec\_LSB\[state\]\[dpath\[i\]\] & 0x2;

state = trellis\_nextstate\[state\]\[dpath\[i\]\];

}

Starting from *state* 0, the decoder moves through the trellis using
decoded *dpath* bits, and extracts two bits corresponding to the current
trellis edge.

In the Spectrum recovering block the decoded residual array is added to
the non-zero spectral components. The output of this block is the
reconstructed spectrum.

The decoded MDCT coefficients are de-normalized using the decoded band
energies.

Finally, as described in subclause 5.3.4.1.4.1.4.4.1, fine gain
adjustment is performed on the dominant bands. Decoded fine gain
adjustment factor is applied to the de-normalized decoded MDCT
coefficients.

##### 6.2.3.1.3.1.4.2 Noise-filling {#noise-filling-1 .H6}

Noise-filling is performed between "De-norm. and Fine gain adj." and
"PFSC decoder" blocks in Figure 94 and the process is the same as the
one at the encoder side.

##### 6.2.3.1.3.1.4.3 PFSC decoding {#pfsc-decoding .H6}

##### 6.2.3.1.3.1.4.3.1 Envelope normalization {#envelope-normalization .H6}

This process is the same with the one described in subclause
5.3.4.1.4.1.5.3.2.

##### 6.2.3.1.3.1.4.3.2 Lag information decoding {#lag-information-decoding .H6}

Lag indices for the last four sub-bands (i.e. *b*=18 to 21 in 13.2 kbps
and *b*=20 to 23 in 16.4 kbps) are decoded if the corresponding decoded
tonality flag is set to "0". The starting position is decoded as
$k^{i} + \text{lag}^{i}\lbrack k'\rbrack$ as described in subclause
5.3.4.1.4.1.5.3.3. Based on the starting position and width of search
band, the predicted high-frequency spectrum is generated from the
envelope normalized TCQ-decoded low-frequency spectrum.

##### 6.2.3.1.3.1.4.3.3 Scaling and noise smoothing {#scaling-and-noise-smoothing .H6}

Scaling factors are calculated for the predicted bands using the decoded
band energies. Each scaling factor is calculated as the square root of
the quotient of the quantized band energy divided by its corresponding
band energy from the predicted high-frequency spectrum. The calculated
scaling factors are attenuated by the scaling factor of 0.9 and applied
to the predicted high-frequency spectrum.

Inter-frame smoothing process for the noise components are applied as
described in subclause 5.3.4.1.4.1.5.3.3.3.

The Normal mode PFSC decoding overview is shown in figure 97.

![](media/image9.png){width="4.8375in" height="3.5in"}

Figure 98: Block diagram of the Normal mode PFSC decoder

##### 6.2.3.1.3.2 Transient Mode {#transient-mode .H6}

6.2.3.1.3.2.1 Energy envelope decoding

Details are described in subclause 6.2.3.1.2.

6.2.3.1.3.2.2 Bit allocation

The processing is the same as subclause 5.3.4.1.4.2.2

6.2.3.1.3.2.3 Fine structure decoding

TCQ decoding with Transient mode configurations is performed.

##### 6.2.3.1.3.3 Harmonic Mode {#harmonic-mode .H6}

##### 6.2.3.1.3.3.1 Overview {#overview .H6}

The high-level decoder structure of the Harmonic mode is basically the
same with the Normal mode. The main difference can be found in its
detailed structure of the PFSC block, and it is shown in the following
figure.

![](media/image10.png){width="4.697222222222222in"
height="3.501388888888889in"}

Figure 98: Block diagram of the Harmonic mode decoder overview

##### 6.2.3.1.3.3.2 Energy envelope decoding {#energy-envelope-decoding-2 .H6}

Details are described in subclause 6.2.3.1.2.

##### 6.2.3.1.3.3.3 Bit allocation {#bit-allocation-1 .H6}

The processing is in the same manner with the one at the encoder side.

At first, the fine gain adjustment bits are derived, procedure is same
as in explained in sub-clause 5.3.4.1.4.3.2.1, and then remaining bits
are allocated in an adaptive manner where more bits are allocated to the
bands in a perceptually significant group than those in a less
significant group. Detailed procedure is same as in explained in
sub-clause 5.3.4.1.4.3.2.2.

##### 6.2.3.1.3.3.4 Fine structure decoding {#fine-structure-decoding-1 .H6}

##### 6.2.3.1.3.3.4.1 TCQ decoding {#tcq-decoding-1 .H6}

This part is the same with the Normal mode as described in subclause
6.2.3.1.3.1.4.1.

##### 6.2.3.1.3.3.4.2 Noise filling for quantized spectrum {#noise-filling-for-quantized-spectrum .H6}

In this subclause noise is filled in the quantized spectrum where
coefficients have been quantized to zero when the bit allocation
subclause allocates non zero bits to the bands and also fills the un
quantized bands up to the transition frequency$f_{t}$ in the same manner
as in the encoder, see subclause 5.3.4.1.4.3.3.2

##### 6.2.3.1.3.3.4.3 PFSC-based gap filling {#pfsc-based-gap-filling .H6}

#####  6.2.3.1.3.3.4.3.1 Overview {#overview-1 .H6}

This subclause is only applied to SWB and FB input signals. The spectral
coefficients which belong to bands which are assigned zero bits from the
bit‑allocation subclause are not quantized. This means that not all
transform coefficients are transmitted to the decoder. From the noise
filled quantized spectrum, the gaps in the high frequency region
$b = N_{\text{bands}} - 4,\text{.}\text{.},N_{\text{bands}} - 1$ which
has zero bit allocation are identified and are filled with the new
generated spectrum. The predicted spectrum is generated using normalized
noise filled quantized spectrum described in subclause
6.2.3.1.3.3.4.3.2.

Based on the bit allocation described in subclause 6.2.3.1.3.3.3, if any
of
$R(b),\ b = N_{\text{bands}} - 4,\text{.}\text{.},N_{\text{bands}} - 1$
is allocated with zero bits, the corresponding band with start and end
positions $k_{\text{start}},k_{\text{end}}$ according to table 108 in
the${\hat{X}}_{M}(k)$has a gap and it is filled with the predicted
spectrum described in subclause 6.2.3.1.3.3.4.3.5 corresponding to
$k_{\text{start}},k_{\text{end}}$.in ${\overset{\sim}{H}}_{M}(k)$

##### 6.2.3.1.3.3.4.3.2 Envelope Normalization {#envelope-normalization-1 .H6}

The envelope normalization is performed equally as in the encoder,
described in subclause 5.3.4.1.4.3.3.3.2. As a result the envelope
normalized signal
${\overset{\sim}{X}}_{M}^{'}(k) = {\overset{\sim}{X}}_{M}(k) + {\overset{\sim}{N}}_{M}(k)$
is obtained, where${\overset{\sim}{X}}_{M}(k)$is the envelope normalized
low frequency quantized spectrum and ${\overset{\sim}{N}}_{M}(k)$ is the
envelope normalized low frequency noise spectrum.

##### 6.2.3.1.3.3.4.3.3 Decoding of lag index {#decoding-of-lag-index .H6}

Lag index $\text{LagIndex}^{i}$ for sub-bands i=0,1 is decoded from the
bit stream. For sub-bands 0 and 1, encoded best match position
![](media/image11.wmf){width="0.5034722222222222in"
height="0.21666666666666667in"} is decoded using the starting position
$k^{i}$ and the lag index $\text{LagIndex}^{i}$, $k^{i}$is defined in
equation (1147).

Based on the best match position the predicted spectrum is generated
from the envelope normalized noise filled quantized spectrum. The
detailed description of the predicted spectrum generation is described
in following subclause 6.2.3.1.3.3.4.3.5.

##### 6.2.3.1.3.3.4.3.4 Structure analysis for Harmonics {#structure-analysis-for-harmonics .H6}

The structure analysis for Harmonic mode is performed equally as in the
encoder, described in subclause 5.3.4.1.4.3.3.3.4. As a result estimated
harmonic $\text{Est}_{\text{freq}_{2}}\ $is obtained; the estimated
harmonic is used for generating the predicted spectrum for the HF region

##### 6.2.3.1.3.3.4.3.5 Predicted spectrum generation {#predicted-spectrum-generation .H6}

Predicted spectrum ${\overset{\sim}{H}}_{M}(k)$ is generated for the
high frequency region by using the envelope normalized noise-filled
quantized
spectrum${\overset{\sim}{X}}_{M}(k),{\overset{\sim}{N}}_{M}(k)$, which
is obtained from subclause 6.2.3.1.3.3.4.3.2. Predicted spectrum is
generated, first by extracting the desired noise components from the
${\overset{\sim}{N}}_{M}(k)$ described in subclause 6.2.3.1.3.3.4.3.6
followed by tonal generation using ${\overset{\sim}{X}}_{M}(k)$described
in subclause 6.2.3.1.3.3.4.3.7.

Noise filled spectrum ${\overset{\sim}{H}}_{M}(k)$ is used for
estimating the tonal energy
$E_{M}^{'}(b),b = N_{\text{bands}} - 4,\text{.}\text{.},N_{\text{bands}} - 1$
and the tonal components $\text{pul}^{i}\lbrack l\rbrack$ of the
spectrum in the high frequency region, which is obtained from subclause
6.2.3.1.3.3.4.3.7 are normalized using the estimated tonal
energy$E_{M}^{'}(b)$, where $E_{M}^{'}(b)$ is calculated as follows:

$E_{M}^{'}(b) = 2^{E_{M}(b)} - E_{\text{Noise}}(b)\ b = N_{\text{bands}} - 4,\text{.}\text{.}\text{.},N_{\text{bands}} - 1$
(1805)

$E_{\text{Noise}}(b)$: is the noise energy obtained using the noise
filled spectrum ${\overset{\sim}{H}}_{M}(k)$ according to

$E_{\text{Noise}}(b) = \sum_{k = k_{\text{start}}(b)}^{k_{\text{end}}(b)}{\overset{\sim}{H}}_{M}(k)^{2}$
(1806)

The noise energy obtained from equation (1807) is adjusted, when the
noise filled spectrum has low level noise and / or when the noise filled
spectrum ${\overset{\sim}{H}}_{M}(k)$has high level noise. Low noise
level is detected using the energy ratio $E_{\text{ratio}}(b)$between
noise and the total band energy and high noise level is detected when
the estimated tonal energy $E_{M}^{'}(b)$ is negative. The adjustment
factor $N_{\text{gain}}(b)$ is estimated according to

$\begin{matrix}
\text{for}\ b = N_{\text{bands}} - 4\ \text{to}\ N_{\text{bands}} - 1 \\
\ E_{\text{ratio}}(b)\  = \ \frac{E_{\text{Noise}}}{2^{E_{M}(b)}} \\
\ \text{if}\ E_{\text{ratio}}(b) < 0\text{.}\text{06} \\
\ \text{fac}\  = \ 0\text{.}6 \\
\ \text{if}\ \text{pul}^{b_{\text{res}}}\ ! = 0 \\
\ \text{fac}\  = \ \sqrt{\frac{E_{\text{Noise}}}{k_{\text{width}}(b)\text{pul}^{b}\lbrack 0\rbrack}} \\
\ \text{end} \\
\ n_{g} = \text{fac}\sqrt{\frac{2^{E_{M}(b)}}{k_{\text{width}}(b)}} \\
\ \text{if}\ E_{\text{ratio}}n_{g^{2}}\text{>=}\ 0\text{.}\text{12} \\
\ n_{g} \leftarrow 0\text{.}\text{05}n_{g} \\
\ \text{end} \\
\ N_{\text{gain}}(b)\  = \ \text{max}(n_{g},1\text{.}4) \\
\ {\overset{\sim}{H}}_{M}(k) \leftarrow N_{\text{gain}}(b){\overset{\sim}{H}}_{M}(k),\ k = k_{\text{start}}(b),\text{.}\text{.},k_{\text{end}}(b) \\
\ \text{end} \\
\ E_{M}^{'}(b) = 2^{E_{M}(b)} - E_{\text{Noise}}(b) \\
\ \text{if}\ E_{M}^{'}(b) < 0 \\
\ N_{\text{gain}}(b) = 0\text{.}\text{25} \\
\ {\overset{\sim}{H}}_{M}(k) \leftarrow N_{\text{gain}}(b){\overset{\sim}{H}}_{M}(k),\ k = k_{\text{start}}(b),\text{.}\text{.},k_{\text{end}}(b) \\
\ \text{end} \\
\text{end} \\
\end{matrix}$ (1808)

For each band, based on the $N_{\text{gain}}(b)$obtained from equation
(1809) is used to re-calculate the tonal energy $E_{M}^{'}(b)$ and
estimated noise $E_{\text{Noise}}(b)$ using equations (1810) and (1811).
The tonal components $\text{pul}^{b}(l)$ of the spectrum in the high
frequency region are normalized using the scale factor
$\text{ton}_{\text{fac}}(b)$ calculated as follows

$\text{ton}_{\text{fac}}(b) = \sqrt{\frac{E_{M}^{'}(b)}{\sum_{l = 0}^{l = \text{pul}_{\text{res}}^{b} - 1}{\text{pul}^{b}(l)^{2}}}},\ b = N_{\text{bands}} - 4,\text{.}\text{.}\text{.},N_{\text{bands}} - 1$
(1812)

The calculated scale factor $\text{ton}_{\text{fac}}(b)$ and extracted
tonal components are used for injecting the tonal components into the
noise filled spectrum ${\overset{\sim}{H}}_{M}(k)$ according to

$\begin{matrix}
b = N_{\text{bands}} - 4\ \text{to}\ N_{\text{bands}} - 1 \\
j = 0 \\
l = 0 \\
\text{while}\ k_{\text{start}}(b) < \text{pk}_{\text{pos}}(j) < k_{\text{end}}(b)\ \text{AND}\ j < \text{res}_{\text{tot}} \\
\ {\overset{\sim}{H}}_{M}(\text{pk}_{\text{pos}}(j)) = \text{pul}^{b}(l)\text{ton}_{\text{fac}}(b)\sqrt{\frac{E_{M}^{'}(b)}{2^{E_{M}(b)}}\ } \\
j = j + 1 \\
l = l + 1 \\
\text{end} \\
\end{matrix}$ (1813)

where,
$\text{pk}_{\text{pos}}(j)\ j = 0,\text{.}\text{.},\text{res}_{\text{tot}}$
is the tonal positions obtained from subclause 5.3.4.1.4.3.3.3.5

##### 6.2.3.1.3.3.4.3.6 Noise filling for the predicted spectrum {#noise-filling-for-the-predicted-spectrum .H6}

Noise filling for the predicted spectrum is performed equally as in the
encoder, described in subclause 5.3.4.1.4.3.3.3.5. As a result noise
filled spectrum ${\overset{\sim}{H}}_{M}(k)$ and tonal
positions$\text{pk}_{\text{pos}}\lbrack j\rbrack$is obtained, where *j*
is the pulse resolution. The obtained predicted spectrum which contains
noise is adjusted using the noise factor ${\hat{N}}_{\text{fac}}$
according to

${\overset{\sim}{H}}_{M}(k) \leftarrow {\overset{\sim}{H}}_{M}(k){\hat{N}}_{\text{fac}},\ k = \text{hf}_{\text{start}},\text{.}\text{.}\text{.},\text{hf}_{\text{width}} - 1$
(1814)

where ${\hat{N}}_{\text{fac}}$ is the noise factor which is decoded from
the bit stream and the decoded noise factor is converted to linear
domain as follows

${\hat{N}}_{\text{fac}} \leftarrow \text{10}^{{\hat{N}}_{\text{fac}}}$
(1815)

##### 6.2.3.1.3.3.4.3.7 Tonal generation for predicted spectrum {#tonal-generation-for-predicted-spectrum .H6}

First, the tonal components $\text{pul}^{i}(l)$ are extracted from the
desired portion of envelope normalized quantized
spectrum${\overset{\sim}{X}}_{M}(k)$ based on the decoded best match
position ![](media/image11.wmf){width="0.5034722222222222in"
height="0.21666666666666667in"}. The extracted tonal components
$\text{pul}^{i}(l)$ are used for the spectrum in the high frequency
region. As the normalized quantized spectrum characteristics are flat
all the values during the normalization process will have similar
values, all the non-zero coefficients in the desired region of
${\overset{\sim}{X}}_{M}(k)$is identified as follows

![](media/image12.wmf){width="1.461111111111111in"
height="2.9298611111111112in"}

where, $\text{pul}_{\text{res}}^{i},\text{pul}^{i}(l)$ are defined as
follows

$\text{pul}_{\text{res}}^{i}$ is the tonal resolution obtained from the
normalized quantized spectrum for sub band *i*=0,1

$\text{pul}^{i}(l)$ is the tonal components extracted from the
normalized quantized spectrum and used as the spectrum in the high
frequency for sub band *i*=0,1

The tonal information$\text{pul}_{\text{res}}^{i},\text{pul}^{i}(l)$,
for *i*=0, 1 obtained from normalized quantized spectrum is used for sub
band *i*=2, 3. Using the estimated harmonic frequency obtained from
subclause 6.2.3.1.3.3.4.3.4 frequency positions of the extracted tonal
components are adjusted as described in subclause 6.2.3.1.3.3.4.3.5.

Based on the band definition described in table 108, the high frequency
band ranges are defined
$b\  = \ N_{\text{bands}} - 4,\text{.}\text{.},N_{\text{bands}} - 1$.
Using the band definitions for high frequency region, the extracted
tonal components and its corresponding pulse resolutions are
restructured, and used for generating predicted spectrum. For example,
the restructured information for sub band *i*=0 is equivalent to
$b\  = \ N_{\text{bands}} - 4$~.~

#### 6.2.3.2 High-rate HQ decoder

A high level structural block diagram of the high-rate HQ decoder is in
figure 99.

![](media/image13.wmf){width="6.570138888888889in"
height="2.5902777777777777in"}

Figure 100: High level structure of the high-rate HQ decoder

Firstly, the High-rate HQ coding mode information is decoded.

##### 6.2.3.2.1 Normal Mode

##### 6.2.3.2.1.1 Envelope decoding {#envelope-decoding .H6}

From the received high-rate HQ norm coding mode bits, the high-rate HQ
norm coding mode is determined and the transmitted differential indices
are decoded using the selected method. The quantization index of the
lowest-frequency band, i.e., $I_{M}(0)$, is directly decoded in all
modes.

##### 6.2.3.2.1.1.1 Context based Huffman decoding mode {#context-based-huffman-decoding-mode-1 .H6}

If this coding mode is determined for the current frame, the context
based Huffman decoding is then performed on the transmitted quantization
differential indices using the method described in subclause
6.2.3.1.2.1.1 and the tables shown in 175 and 176.

##### 6.2.3.2.1.1.2 Re-sized Huffman decoding mode {#re-sized-huffman-decoding-mode .H6}

If this coding mode is determined for the current frame, the resized
Huffman decoding is then performed on the transmitted quantization
differential indices using the method described in subclause
6.2.3.1.2.1.2. The Huffman codes for the differential indices are given
in table 105.

##### 6.2.3.2.1.1.3 Normal Huffman decoding and bit-packing mode {#normal-huffman-decoding-and-bit-packing-mode .H6}

If this coding mode is determined for the current frame, the Normal
Huffman decoding is then performed on the transmitted differential
indices. The Huffman codes for the differential indices are given in
subclause 5.3.4.2.1.2.3.

When the bit-packing mode is determined; the adjusted differential
indices are un-packed directly with 5 bits.

The actual quantized norms${\hat{E}}_{M}(b)$ are obtained by lookup
table, defined in subclause 5.3.4.2.1.1.

##### 6.2.3.2.1.2 Normal mode fine structure inverse quantization {#normal-mode-fine-structure-inverse-quantization .H6}

##### 6.2.3.2.1.2.1 Fine structure inverse PVQ-quantization {#fine-structure-inverse-pvq-quantization .H6}

The spectral coefficient inverse quantization is done as is described in
subclause 6.2.3.2.6

##### 6.2.3.2.1.2.2 Fine gain prediction, inverse quantization and application {#fine-gain-prediction-inverse-quantization-and-application .H6}

The bit allocation for the PVQ shape vector $R_{\text{PVQ}}(b)$and fine
gain adjustment $R_{\text{FG}}(b)$, as well as $g_{\text{pred}}(b)$ and
$g_{\text{rms}1}(b)$are obtained as in subclause 5.3.4.2.1.3a.1. The
quantized gain prediction error ${\hat{g}}_{\text{err}}(b)$is obtained
by using the assigned bitrate$R_{\text{FG}}(b)$and the fine gain
adjustment $g_{\text{fg}}(b)$is obtained by

$g_{\text{fg}}(b) = {\hat{g}}_{\text{err}}(b)g_{\text{rms}1}(b)g_{\text{pred}}(b)$
(1816)

with ${\hat{g}}_{\text{err}}(b) = 1$for$R_{\text{FG}}(b) = 0$. The gain
of the synthesis is adjusted by scaling the decoded fine structure with
the fine gain$g_{\text{fg}}(b)$.

##### 6.2.3.2.1.3 Spectral filling {#spectral-filling .H6}

This subclause gives a technical overview of the spectrum filling
processing which is applied at the decoder in HQ high rate mode.

##### 6.2.3.2.1.3.1 Wideband adaptive noise filling at 24.4/32kbps {#wideband-adaptive-noise-filling-at-24.432kbps .H6}

Wideband adaptive noise filling at 24.4 and 32 kbps proceeds by
calculating the total available bits and the bits variance for the
sub-bands in non-transient frames over the index
range$b = \lbrack 8,b_{\text{last}_{\text{sfm}}}\rbrack$,

$\text{bit}_{\text{tot}} = \sum_{i = 8}^{b_{\text{last}_{\text{sfm}}}}{R(i)}$
(1817)

$\text{bit\_var} = \frac{\sum_{i = 8}^{b_{\text{last}_{\text{sfm}}}}\left| R(i) - R(i - 1) \right|}{\text{bit}_{\text{tot}}}$
(1818)

The average bit allocation threshold
$\text{THR}_{\text{bit}}\lbrack b\rbrack$is initialized for each
coefficient in each sub-band according to the values in table 177.

Table 178: Threshold for average bit allocation

  ------ ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- -----
  Band   0     1     2     3     4     5     6     7     8     9     10    11    12
         1.5   1.5   1.5   1.5   1.5   1.5   1.5   1.5   1.5   1.5   1.5   1.5   1.5
  Band   13    14    15    16    17    18    19    20    21    22    23    24    25
         1.5   1.5   1.5   1.0   1.0   1.0   1.0   1.0   1.0   1.0   1.0   0.8   0.8
  ------ ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- -----

For the sub-bands in the index
range$b = \lbrack 8,b_{\text{last}_{\text{sfm}}}\rbrack$,
$N_{\text{sat}}$denotes the number of the sub-bands where the average
number of allocated bits for each coefficient is not less than the
threshold$\text{THR}_{\text{bit}}\lbrack b\rbrack$. The harmonic
parameter $S_{M}$for those sub-bands is calculated as follows:

$S_{M} = \sum_{b = 8,R(b\frac{)}{L_{M}}(b)\text{>=}\text{THR}_{\text{bit}}(b)}^{b_{\text{last}_{\text{sfm}}}}\frac{L_{M}(b) \ast {\overset{\sim}{X}}_{\text{max}}(b)}{\sum_{}^{}{{\overset{\sim}{X}}_{M}(k)}}$
(1819)

$S_{M} = \frac{2 \ast N_{\text{sat}}}{S_{M}}$ (1820)

The step length, $\text{step}$, is calculated according to:

$\text{step} = \frac{5 \ast S_{M}}{b_{\text{last}_{\text{sfm}}}}$ (1821)

For any sub-band in non-transient frames the following procedure is then
followed. If the average number allocated bits for each coefficient in
the sub-band is greater than or equal to the threshold 1.5, then the bit
allocation for the sub-band is saturated and the un-decoded coefficients
of the sub-band are not processed further by the noise filling.
Otherwise, the bit allocation to the sub-band is un-saturated, and the
un-decoded coefficients of the sub-band are reconstructed by noise
filling. For any un-saturated sub-band with zero bits allocated to its
coding, the envelope of the un-decoded coefficients in the sub-band are
set to the decoded norm for that sub-band. Otherwise, if the
un-saturated sub-band has bits allocated to it, the envelope of the
un-decoded coefficients is calculated as follows:

The average energy of the sub-band $E_{\text{av}}(b)$ is then calculated
using the de-quantized norm ${\overset{\sim}{I}}_{N}^{q}(b)$ as follows:

$E_{\text{av}}(b) = {\overset{\sim}{I}}_{N}^{q}(b) \ast {\overset{\sim}{I}}_{N}^{q}(b) \ast L_{M}(b)$
(1822)

The energy sum of the all decoded non-zero coefficients in this subband
$E_{\text{sub}}(b)$ is then calculated

$E_{\text{sub}}(b) = \sum_{k = k_{\text{start}}(b)}^{k_{\text{end}}(b)}{{\overset{\sim}{X}}_{M}(k) \ast {\overset{\sim}{X}}_{M}(k),{\overset{\sim}{X}}_{M}(k) \neq 0}$
(1823)

A search of the maximum magnitude ${\overset{\sim}{X}}_{\text{max}}$and
the minimum magnitude${\overset{\sim}{X}}_{\text{min}}$ of the decoded
coefficients in each subband is also calculated for further processing.

The energy
difference$E_{\text{diff}}(b) = E_{\text{sub}}(b) - E_{\text{av}}(b)$is
next calculated. If$E_{\text{diff}}(b) \leq 0$, the envelope of the
un-decoded coefficients is set to zero
${\overset{\sim}{I}}_{\text{nf}}(b) = 0$. Otherwise, the envelope of the
un-decoded coefficients${\overset{\sim}{I}}_{\text{nf}}(b)$is calculated
as follows:

The initial envelope $I_{\text{nf}}(b)$of the un-decoded coefficients in
the un-saturated sub-band is calculated by the energy difference,

$I_{\text{nf}}(b) = \sqrt{E_{\text{diff}}(b\frac{)}{L_{M}}(b)}$ (1824)

The average norm of the un-saturated
sub-band${\overset{\sim}{I}}_{\text{av}}^{q}$is calculated

${\overset{\sim}{I}}_{\text{av}}^{q} = \begin{matrix}
\left\{ ({\overset{\sim}{I}}_{N}^{q}(0) + {\overset{\sim}{I}}_{N}^{q}(1) + {\overset{\sim}{I}}_{N}^{q}(2)\frac{)}{3},b = 0 \middle| \right.\ \left\{ ({\overset{\sim}{I}}_{N}^{q}(b - 1) + {\overset{\sim}{I}}_{N}^{q}(b) + {\overset{\sim}{I}}_{N}^{q}(b + 1)\frac{)}{3,0} < b < N_{\text{bands}} - 1 \middle| \right.\  \\
\end{matrix}$ (1825)

If $\text{bit\_var} > 0\text{.}3$or
$4 \ast {\overset{\sim}{I}}_{N}^{q}(b) < {\overset{\sim}{X}}_{\text{max}}$,
then the spectrum of the sub-band is *sharp*. The envelope of the
un-decoded coefficients is obtained by modifying the initial envelope as
follows:

${\overset{\sim}{I}}_{\text{nf}}(b) = \begin{matrix}
\left\{ I_{\text{nf}}(b) \ast 3 \ast S_{M} \ast {\overset{\sim}{I}}_{\text{av}}^{q}\text{*/\ \{}\overset{\sim}{X} \middle| \middle| \text{max},\text{if}\text{bit\_var} > 0\text{.}3\text{or}4 \ast {\overset{\sim}{I}}_{N}^{q}(b) < {\overset{\sim}{X}}_{\text{max}} \middle| \right.\  \\
\end{matrix}$ (1826)

If the spectrum of the sub-band is not *sharp* and
${\overset{\sim}{X}}_{\text{max}} > 2\text{.}5 \ast {\overset{\sim}{I}}_{N}^{q}(b)$,
${\overset{\sim}{I}}_{\text{nf}}(b) = {\overset{\sim}{I}}_{\text{nf}}(b) \ast {\overset{\sim}{I}}_{\text{nf}}(b\frac{)}{{\overset{\sim}{X}}_{\text{max}}}$,
then the harmonic parameter $S_{M}$is added by the step
length$\text{step}$.

If the envelope is more than the half of the minimum
magnitude${\overset{\sim}{X}}_{\text{min}}$, then the envelope is set to
be equal to the half of the minimum
magnitude${\overset{\sim}{X}}_{\text{min}}$.

${\overset{\sim}{I}}_{\text{nf}}(b) = 0\text{.}5 \ast {\overset{\sim}{X}}_{\text{min}},\text{if}{\overset{\sim}{I}}_{\text{nf}}(b) > 0\text{.}5 \ast {\overset{\sim}{X}}_{\text{min}}$
(1827)

If the ratio of the average norms ${\overset{\sim}{I}}_{\text{av}}^{q}$
in the current frame to that of the previous frame lies in the range
(0.5,..., 2), and the previous frame is a non-transient frame, the the
envelope of the un-decoded coefficients for the current frame and the
previous frame are weighted as follows.

${\overset{\sim}{I}}_{\text{nf}}(b) = 0\text{.}5 \ast {\overset{\sim}{I}}_{\text{nf}}(b) + 0\text{.}5 \ast {\overset{\sim}{I}}_{\text{nf}}^{( - 1)}(b)$
(1828)

For the un-decoded coefficients in the sub-band, the coefficients are
generated using a random noise generator and multiplied by the estimated
envelope as described above.

For the last sub-band, a check is made whether the mode of the previous
frame was not a transient, and whether the ratio of the decoded norms of
the current frame to those of the previous frame are in the range (0.5,
...,2.0), and the bit variance $\text{bit\_var}$is not more than 0.3,
and the sub-band of the current frame is bit allocated and the sub-band
of the previous frame is not bit allocated or vice versa. If all of the
above conditions are fulfilled, then the coefficients in the current
frame and the previous frame for the last 20 coefficients in the last
sub-band are weighted as follows:

$\begin{matrix}
{\overset{\sim}{X}}_{M}(k) = \text{sign}({\overset{\sim}{X}}_{M}(k)) \ast (0\text{.}5 \ast \left| {\overset{\sim}{X}}_{M}(k) \right| + 0\text{.}5 \ast \left| {\overset{\sim}{X}}_{M}^{( - 1)}(k) \right|), \\
\begin{matrix}
\begin{matrix}
\begin{matrix}
\begin{matrix}
\begin{matrix}
\begin{matrix}
\begin{matrix}
 & \\
\end{matrix} & \\
\end{matrix} & \\
\end{matrix} & \\
\end{matrix} & \\
\end{matrix} & \\
\end{matrix} & \\
\end{matrix}\text{if}\left| {\overset{\sim}{X}}_{M}(k) \right| > 4\text{.}0 \ast \left| {\overset{\sim}{X}}_{M}^{( - 1)}(k) \right|\text{or}\left| {\overset{\sim}{X}}_{M}(k) \right| < 0\text{.}\text{25} \ast \left| {\overset{\sim}{X}}_{M}^{( - 1)}(k) \right|,\ \text{300} \leq k < \text{320} \\
\end{matrix}$ (1829)

In the transient mode, un-decoded coefficients in a sub-band are
generated from random noise, and de-normalized by the decoded norm for
that sub-band.

##### 6.2.3.2.1.3.2 General spectral filling {#general-spectral-filling .H6}

Based on the received bit-allocation, the transition frequency$f_{t}$is
estimated in the same manner as in the encoder, see subclause
5.3.4.2.1.4. Spectral filling consists of two algorithms. The first
algorithm fills the low‑frequency spectrum up to the transition
frequency$f_{t}$, the second algorithm regenerates the possibly
non-coded high-frequency components by using the low-frequency
noise-filled spectrum.

The interaction between these two algorithms is shown in figure 101. The
resulting spectrum from both the noise-filling algorithm and the high
frequency noise fill is a normalized spectrum which is shaped by the
received quantized norms.

![](media/image14.wmf){width="4.741666666666666in"
height="1.5590277777777777in"}

Figure 102: Spectrum filling block diagram

##### 6.2.3.2.1.3.2.1 Noise filling {#noise-filling-2 .H6}

The first step of the noise fill procedure relies on the building of the
so-called spectral codebook from the received (decoded) normalized
transform coefficients. This step is achieved by concatenating the
perceptually relevant coefficients of the decoded spectrum. Figure 103
illustrates this procedure. The decoded spectrum has several series of
zero coefficients that are called spectral holes of a certain length.
This length is the sum of the consecutive lengths of bands which were
allocated zero bits.

![](media/image15.wmf){width="6.5in" height="2.775in"}

Figure 104: Building the spectral codebook from the decoded transform
signal

Since the length of all spectral holes can be higher than the length of
the spectral codebook, the codebook elements might be re-used for
filling several spectral holes.

![](media/image16.wmf){width="6.539583333333334in"
height="3.1416666666666666in"}

Figure 105: Noise filling from the spectral codebook up to the
transition frequency

Figure 106 shows how, based on the spectral codebook C, the
non-quantized spectral coefficients are filled. Spectral holes are
filled by increasing the codebook index j as much as the index i, used
to cover all the spectral holes up to the transition frequency. Reading
from the spectral codebook is done sequentially and as a circular buffer
according to the following:

*i=*0; *j=*0\
(1:) if $R(b_{i}) = 0$then ${\hat{X}}_{M}(i) = C(j)$,\
increment *i*,*j* (if out of bound, rewind *j* to start of codebook)\
if *i=*0 then\
STOP\
else\
goto (1:)\
endif

For low bit rates, many of the quantized bands will contain few pulses
and have a sparse structure. For signals which require a more dense and
noise-like fill, a set of two anti-sparseness processed codebooks are
created instead of the regular spectral codebook as illustrated in
figure 107.

![](media/image17.wmf){width="6.498611111111111in"
height="4.3180555555555555in"}

Figure 108: Creation of two parallel codebooks to handle sparse coded
vectors.

The compression of the coded residual vectors is done according to the
following definition:

${\hat{X}}_{M,\text{comp}}(k) = \left\{ \begin{matrix}
1,\ {\hat{X}}_{M} > 0 \\
0,\ {\hat{X}}_{M} = 0 \\
 - 1,\ {\hat{X}}_{M} < 0 \\
\end{matrix} \right.\ $ (1830)

The virtual codebook which constitutes the spectral codebook is built
only from "populated" sub-vectors, where each sub-vector has a length of
8. If a coded sub-vector does not fulfill the criterion:

$\sum_{k = k_{\text{start}}(b) + 8i}^{k_{\text{start}}(b) + 8i + 7}{\left| {\hat{X}}_{M,\text{comp}}(k) \right| \geq 2},\ i = 0,\text{.}\text{.}\text{.},\frac{L_{M}(b)}{8}$
(1831)

it is considered sparse, and is rejected. Since the sub-vector length is
8, this corresponds to a rejection criterion if less than 25% of the
vector positions are populated. The remaining compressed sub-vectors are
concatenated into Spectral codebook 1, $Y_{M}(k)$with the length
$L_{Y}$. The final step of the anti-sparseness processing is to combine
the codebook samples pair-wise sample-by-sample with a frequency
reversed version of the codebook. The combination can be described with
the following relation:

> $Y_{M}^{'}(k) = \left\{ \begin{matrix}
> \text{sign}\left( Y_{M}(k) \right) \times \left( \left| Y_{M}(k) \right| + \left| Y_{M}(L_{Y} - k) \right| \right),\ Y_{M}(k) \neq 0 \\
> \left| Y_{M}(L_{Y} - k) \right|,\ Y_{M}(k) = 0 \\
> \end{matrix} \right.\ ,\ k = 0,1,\text{.}\text{.}\text{.},L_{Y}$
> (1832)

For SWB processing at 24.4 or 32 kbps in case of low spectral stability,
spectral codebook 1 is used below band $f_{\text{cb}} = \text{20}$ and
the spectral codebook 2 is used above and including band
$f_{\text{cb}} = \text{20}$. The spectral filling using these two
codebooks is depicted in figure 109.

![](media/image18.wmf){width="6.5in" height="3.136111111111111in"}

Figure 110: Creation of two parallel codebooks to handle sparse coded
vectors.

##### 6.2.3.2.1.3.2.2 High frequency noise fill {#high-frequency-noise-fill .H6}

Based on the low-frequency filled spectrum, and prior to noise level
attenuation, as described in the previous clause, the last step of the
spectral filling consists of the generation of the target bandwidth
audio signal. In other words, the process synthesizes a high-frequency
spectrum from the filled spectrum by spectral folding based on the value
of the transition frequency.

The target bandwidth generation is based on the spectral folding of the
spectrum below the transition frequency to the high-frequency spectrum
(zeroes above the transition frequency), see figure 111. A first
spectral folding is achieved with respect to the point of symmetry
defined by the transition frequency$f_{t}$. No spectrum coefficients
from frequencies below$f_{t}/2$ are folded into the high frequencies. In
other words, only the upper half of the low frequencies are folded. If
there are not enough coefficients in the upper half of the low
frequencies to fill the whole spectrum above the transition frequency,
the spectrum is folded again around the last filled coefficient. This
process is repeated until the last band is filled.

![](media/image19.wmf){width="4.754861111111111in"
height="1.2763888888888888in"}

Figure 112: The spectrum above the transition frequency is regenerated
using spectral folding from the transition frequency

##### 6.2.3.2.1.3.2.3 Noise level adjustment {#noise-level-adjustment .H6}

After the fine structure of the spectral holes has been determined, the
noise-filled part of the spectrum is attenuated according to the
received *NoiseLevel* index. In the case of transient mode, the
*NoiseLevel* is not estimated in the encoder and is automatically set to
the value corresponding to zero index, i.e., 0 dB.

This operation is summarized by the following equation:

${\hat{X}}_{M}^{\text{fill}}(k) = 2^{- \text{NoiseLevel}}{\hat{X}}_{M}(k),\text{\ \ \ for\ }k\text{\ \ such\ that\ }R(b) = 0\text{\ \ and\ }k \leq f_{t}$
(1833)

For SWB processing at 24.4 or 32 kbps in case of low spectral stability,
an additional adaptive noise-fill level adjustment is employed. First,
an envelope adjustment vector $g_{\text{adj}_{1}\text{st}}(b)$is derived
according to the following pseudo-code:

> *For* $b = 0,1,\text{.}\text{.}\text{.},N_{\text{bands}}$,\
> *if* $K(b) = 0$,\
> *if* $L_{M}(b) \leq \text{16}$,\
> *if* $b > 0$\
> *if* $\text{Qadj}(b)$,\
> $g_{\text{adj}_{1}\text{st}}(b) = 0\text{.}\text{36}$\
> *else*\
> $g_{\text{adj}_{1}\text{st}}(b) = 0\text{.}\text{54}$\
> *else*\
> $g_{\text{adj}_{1}\text{st}}(b) = 0\text{.}\text{72}$\
> *else*\
> *if* $b < b_{\text{last}}$ *and*$\text{Qadj}(b)$ ,\
> $g_{\text{adj}_{1}\text{st}}(b) = 0\text{.}\text{54}$\
> *else*\
> $g_{\text{adj}_{1}\text{st}}(b) = 0\text{.}\text{72}$\
> *else\
> * $g_{\text{adj}_{1}\text{st}}(b) = 1\text{.}0$

where
$\text{Qadj}(b) = \text{TRUE}\ \text{if}\ K(b - 1) > 0\ \text{and}\ K(b + 1) > 0\ $.
Further, $K(b)$denotes the number of pulses for band $b$as described in
subclause 5.3.4.2.7, where $K(b) = 0$corresponds to the case when zero
bits are assigned to band $b$. In short it permits strong attenuation
for short bands where the neighboring bands are quantized, and gradually
less when these requirements are not fulfilled. Once
$g_{\text{adj}_{1}\text{st}}(b)$has been obtained, attenuation regions
of consecutive bands $b$where
$g_{\text{adj}_{1}\text{st}}(b) < 1\text{.}0$are identified. The
attenuation for each of these regions are adjusted according to

$g_{\text{adj}_{\text{lim}}}(b) = \alpha_{\text{adj}}(w) + \left( 1 - \alpha_{\text{adj}}(w) \right)g_{\text{adj}_{1}\text{st}}(b)$
(1834)

where $w$is the number of consecutive bands in the attenuation region.
The width-dependent attenuation function $\alpha_{\text{adj}}(w)$is a
piece-wise linear function defined as

$\alpha_{\text{adj}}(w) = \left\{ \begin{matrix}
0,\ w < 6 \\
1,\ (w - 6)/5 > 1 \\
(w - 6)/5,\ \text{otherwise} \\
\end{matrix} \right.\ $ (1835)

The resulting vector $g_{\text{adj}_{\text{lim}}}(b)$is further combined
with a limiting function which prevents attenuation during audio with
high spectral stability. The spectral stability is calculated based on a
low-pass filtered Euclidian distance
${\overset{\sim}{D}}_{M}^{\left\lbrack n \right\rbrack}$between the
spectral envelope values $E_{M}^{\left\lbrack n \right\rbrack}(b)$ of
adjacent frames:

$D_{M}^{\left\lbrack n \right\rbrack} = \sqrt{\frac{1}{\text{27}}\sum_{b = 0}^{\text{26}}\left( E_{M}^{\left\lbrack n \right\rbrack}(b) - E_{M}^{\left\lbrack n - 1 \right\rbrack}(b) \right)^{2}}$
(1836)

${\overset{\sim}{D}}_{M}^{\left\lbrack n \right\rbrack} = 0\text{.}1D_{M}^{\left\lbrack n \right\rbrack} + 0\text{.}9D_{M}^{\left\lbrack n - 1 \right\rbrack}$
(1837)

Here ${}^{\left\lbrack n \right\rbrack}$denotes the value of the
variable for frame $n$. The spectral envelope stability parameter
$S^{\left\lbrack n \right\rbrack}$is derived by mapping
${\overset{\sim}{D}}_{M}^{\left\lbrack n \right\rbrack}$ to the range
$\left\lbrack 0,1 \right\rbrack$using a discreetly sampled sigmoid
function implemented as a lookup table $\text{stab}_{\text{trans}}(I)$.
Due to the symmetry of the function, the table is mirrored around the
mid-point such that the final stability parameter can be obtained by

$S^{\left\lbrack n \right\rbrack} = \left\{ \begin{matrix}
1 - \text{stab}_{\text{trans}}(I),\ {\overset{\sim}{D}}_{M}^{\left\lbrack n \right\rbrack} < 2\text{.}\text{571757} \\
\text{stab}_{\text{trans}}(I),\ {\overset{\sim}{D}}_{M}^{\left\lbrack n \right\rbrack} \geq 2\text{.}\text{571757} \\
\end{matrix} \right.\ $ (1838)

where the quantization index $I$is found by
$I^{'} = \left\lbrack \left| {\overset{\sim}{D}}_{M}^{\left\lbrack n \right\rbrack} - 2\text{.}\text{571757} \right|/0\text{.}\text{103138} \right\rbrack$and
clamping the index $I^{'}$to the range $\left\lbrack 0,9 \right\rbrack$.
Finally, the gain adjustment vector $g_{\text{adj}}(b)$is derived as

$g_{\text{adj}}(b) = \text{max}\left( S^{\left\lbrack n \right\rbrack},g_{\text{adj}_{\text{lim}}}(b) \right)$
(1839)

where the envelope stability$S^{\left\lbrack n \right\rbrack}$acts as a
limiting function for the gain adjustment vector.

For WB processing, a slightly different gain adjustment vector is
derived. Here, the $g_{\text{adj}}(b)$is computed as

$g_{\text{adj}}(b) = \left\{ \begin{matrix}
\text{gain}_{\text{att}}(I),\ 0 < K(b) < \text{40} \\
1\text{.}0,\ \text{otherwise} \\
\end{matrix} \right.\ $ (1840)

where $\text{gain}_{\text{att}}(I)$is a gain attenuation table for index
$I$, which in turn is derived by

$I = \left\lbrack K(b) \times \text{att}_{\text{step}}\left( \left\lfloor L_{M}(b\frac{)}{8} \right\rfloor \right) \right\rbrack - 1$
(1841)

For SWB and 24.4 and 32 kbps, the gain adjustment is applied using a
hangover logic which only permits attenuation in case a sequence of 150
frames without transients has been observed. In case this requirement is
met for SWB encoded bandwidth or if the encoded bandwidth is WB, the
gain adjustment vector is combined with the quantized envelope vector
${\hat{E}}_{M}(b)$to form the gain adjusted envelope vector
${\overset{\sim}{E}}_{M}(b) = {\hat{E}}_{M}(b) \cdot g_{\text{adj}}(b)$.

##### 6.2.3.2.1.3.2.4 Spectral fill envelope shaping {#spectral-fill-envelope-shaping .H6}

When the full-bandwidth fine spectral structure is generated, the
resulting spectrum is shaped by applying the gain adjusted envelope
vectors for each band
$b = 0,1,\text{.}\text{.}\text{.},N_{\text{bands}} - 1$ according to:

$X_{M}^{'}(k) = {\overset{\sim}{E}}_{M}(b){\hat{X}}_{M}(k),k = k_{\text{start}}(b),\ldots,k_{\text{end}}\left( b \right)$
(1842)

##### 6.2.3.2.2 Transient Mode

##### 6.2.3.2.2.1 Envelope decoding {#envelope-decoding-1 .H6}

The envelope is decoded as is described in subclause 6.2.3.2.1.1. In
addition to those step the norms are also sorted as is done in the
encoder, see subclause 5.3.4.2.2.1.

##### 6.2.3.2.2.2 Fine structure inverse quantization (spectral coefficients decoding) {#fine-structure-inverse-quantization-spectral-coefficients-decoding .H6}

The spectral coefficients are decoded as for the Normal HQ mode as
described in subclause 6.2.3.2.1.2.

##### 6.2.3.2.2.3 Spectral filling {#spectral-filling-1 .H6}

The spectral filling is done as described in 6.2.3.2.1.3, but the
bandwidth extension in subclause 6.2.3.2.1.3.2.2 is not done.

##### 6.2.3.2.3 Harmonic Mode

##### 6.2.3.2.3.1 Core decoding {#core-decoding .H6}

Envelope decoding and the PVQ decoder are described in subclause
6.2.3.2.1.1 and subclause 6.2.3.2.1.2, respectively.

If a sub-band has bits allocated to it, then the decoded coefficients of
the sub-band are de-normalized by multiplying the de-quantized norm of
the sub-band, and in this way the de-normalized coefficients
${\overset{\sim}{X}}_{M}(k),k = 0,\text{.}\text{.}\text{.},k_{\text{end}}(b_{\text{last}_{\text{sfm}}})$
are obtained. Otherwise, if a sub-band has no bits allocated to it, the
de-normalized coefficients ${\overset{\sim}{X}}_{M}(k)$ of that sub-band
are set to 0. And the higher frequency band coefficients with the index
of sub-band above $b_{\text{last}_{\text{sfm}}}$ are 0 and are
reconstructed by bandwidth extension, where
$b_{\text{last}_{\text{sfm}}}$ is the index of the highest frequency
sub-band of the decoded low frequency band signal.

##### 6.2.3.2.3.2 Bandwidth extension decoding for harmonic mode {#bandwidth-extension-decoding-for-harmonic-mode .H6}

The start index for the bandwidth extension is adaptively obtained
according to the value of$b_{\text{last\_sfm}}$.

Firstly preset the start index for bandwidth extension
$b_{\text{high}_{\text{sfm}}}$:

$b_{\text{high}_{\text{sfm}}} = \begin{matrix}
\left\{ \text{21},\text{24}\text{.}4\text{kbps} \middle| \right.\  \\
\end{matrix}$ (1843)

Then, in order to predict the excitation signal of bandwidth extension,
judge whether the index of the highest frequency sub-band of the decoded
low frequency band signal$b_{\text{last}_{\text{sfm}}}$ is less than the
start index for bandwidth extension $b_{\text{high}_{\text{sfm}}}$, i.e.
judge whether the highest frequency bin of bit allocation is less than
the preset start frequency bin for bandwidth extension,

-   if $b_{\text{last}_{\text{sfm}}} < b_{\text{high}_{\text{sfm}}}$,
    $b_{\text{last}_{\text{sfm}}}$ is then set to
    $b_{\text{high}_{\text{sfm}}}$. The excitation signal of bandwidth
    extension is predicted by the preset start index
    $b_{\text{high}_{\text{sfm}}}$ and the chosen excitation signal from
    the decoded low frequency band signal with the given bandwidth
    length.

-   Otherwise, the excitation signal of bandwidth extension is predicted
    by the preset start index $b_{\text{high}_{\text{sfm}}}$, the index
    of the decoded highest frequency sub-band
    $b_{\text{last}_{\text{sfm}}}$ and the chosen excitation signal from
    the decoded low frequency signal with the given bandwidth length.

Finally, the higher frequency band signal is reconstructed by the
predicted excitation signal and the envelopes as described in subclause
6.2.3.2.2.1.

##### 6.2.3.2.3.2.1 Calculate excitation adaptive normalization lengths {#calculate-excitation-adaptive-normalization-lengths .H6}

The de-normalized coefficients calculated in subclause 6.2.3.2.3.1 need
to be recovered to remove the original core envelope effects to give the
excitation for bandwidth extension. The normalization length
$L_{\text{mdct}_{\text{norm}}}$ is adaptively obtained according to the
signal characteristics. The normalization length of the previous frame
$L_{\text{mdct}_{\text{norm}}}^{\left\lbrack - 1 \right\rbrack}$ is
initialized to 8.

208 MDCT coefficients in the 0-5200 Hz frequency range are split into 13
normalization sub-bands with 16 coefficients per sub-band. The peak
magnitude and average magnitude in each normalization sub-band are then
calculated. The counter $\text{n\_band}$ is initialized to zero and
increased by one if $r_{p2a}(j) > 8$ and $\text{peak}(j) > \text{10}$,
where

$r_{p2a}(j) = \begin{matrix}
\left\{ \frac{\text{15} \cdot \text{peak}(j)}{\text{avg}(j) - \text{peak}(j)},\text{if}\text{avg}(j) \neq \text{peak}(j) \middle| \right.\  \\
\end{matrix}$ (1844)

The normalization length $L_{\text{mdct}_{\text{norm}}}$ is set to
$\text{32} + 2\text{.}5 \cdot n_{\text{band}}$, and it is adjusted with
reference to the value from the previous frame,
$L_{\text{mdct}_{\text{norm}}}^{\left\lbrack - 1 \right\rbrack}$

$L_{\text{mdct}_{\text{norm}}} = 0\text{.}1 \cdot L_{\text{mdct}_{\text{norm}}} + 0\text{.}9 \cdot L_{\text{mdct}_{\text{norm}}}^{\left\lbrack - 1 \right\rbrack}$
(1845)

##### 6.2.3.2.3.2.2 Calculate envelopes for excitation normalization {#calculate-envelopes-for-excitation-normalization .H6}

The normalization envelopes,
$E_{\text{base}_{\text{exc}}}(k),\ k = 0,\text{.}\text{.}\text{.},\text{201}$
for each spectral bin are calculated as follow:

$E_{\text{base}_{\text{exc}}}(k) = \begin{matrix}
\left\{ \sum_{k = 0}^{\frac{L_{\text{mdct}_{\text{norm}}}}{2} + i}{\left| {\overset{\sim}{X}}_{M}(k) \right|,i = 0,\cdots,\frac{L_{\text{mdct}_{\text{norm}}}}{2}} \middle| \right.\ \left\{ \sum_{k = i - \frac{L_{\text{mdct}_{\text{norm}}}}{2}}^{\frac{L_{\text{mdct}_{\text{norm}}}}{2} + i}{\left| {\overset{\sim}{X}}_{M}(k) \right|,i = L_{\text{mdct}_{\text{norm}}}2,\cdots,\text{201} - L_{\text{mdct}_{\text{norm}}}2} \middle| \right.\  \\
\end{matrix}$ (1846)

The value
${\overset{\sim}{X}}_{M}(k),k = 0,\text{.}\text{.}\text{.},\text{201}$
are then normalized using the normalization envelopes
$E_{\text{base}_{\text{exc}}}\lbrack k\rbrack,\ k = 0,\text{.}\text{.}\text{.},\text{201}$
to obtain the normalized coefficients
${\overset{\sim}{X}}_{\text{base}_{\text{exc}}}(k),\ k = 0,\text{.}\text{.}\text{.},\text{201}$,

${\overset{\sim}{X}}_{\text{base}_{\text{exc}}}(k) = {\overset{\sim}{X}}_{M}(k\frac{)}{E_{\text{base}_{\text{exc}}}}(k),\begin{matrix}
 & k = 0,\text{.}\text{.}\text{.},\text{201} \\
\end{matrix}$ (1847)

##### 6.2.3.2.3.2.3 Adaptive excitation generation {#adaptive-excitation-generation .H6}

The normalized coefficients in the frequency range 1500-5025Hz, i.e. the
$\text{60}^{\text{th}} - \text{201}^{\text{st}}$ coefficients, are
selected for the excitation calculation. The starting frequency bin of
the excitation, $\text{src}$, is calculated as follows,

$\text{src} = \begin{matrix}
\left\{ {\overset{\sim}{X}}_{\text{base}_{\text{exc}}} + \text{60} + k_{\text{end}}(b_{\text{last}_{\text{sfm}}}) - k_{\text{end}}(b_{\text{high}_{\text{sfm}}}),\text{if}k_{\text{end}}(b_{\text{last}_{\text{sfm}}}) - k_{\text{end}}(b_{\text{high}_{\text{sfm}}}) \leq \text{202} - \text{60} \middle| \right.\  \\
\end{matrix}$ (1848)

The selected low frequency normalized coefficients from which the
re-constructed higher band coefficients
${\overset{\sim}{X}}_{M_{\text{norm}}}$ are obtained are copied to the
high band starting at frequency, $\text{dst}$ , as follows

$\text{dst} = {\overset{\sim}{X}}_{M_{\text{norm}}} + k_{\text{end}}(b_{\text{last}_{\text{sfm}}})$
(1849)

The low frequency normalized coefficients may in practice be copied N
times as a circular buffer in order to fill in the re-constructed higher
bands, where N can be a decimal fraction.

##### 6.2.3.2.3.2.4 Weighting the re-constructed higher band coefficients and random noise {#weighting-the-re-constructed-higher-band-coefficients-and-random-noise .H6}

The envelopes ${\overset{\sim}{I}}_{\text{norm}}(b)$ of the
re-constructed higher band coefficients are calculated according to the
band structure given in table 129, and then the re-constructed higher
band signal is weighted and random noise added.

${\overset{\sim}{X}}_{M}(k) = \alpha \ast {\overset{\sim}{X}}_{M_{\text{norm}}}(k) \ast {\overset{\sim}{I}}_{N}^{q}(b\frac{)}{{\overset{\sim}{I}}_{\text{norm}}}(b) + \beta \ast \text{random}(k\frac{)}{\text{32768}}\text{.}0 \ast {\overset{\sim}{I}}_{N}^{q}(b)$
(1850)

Where$b = \lbrack b_{\text{last}_{\text{sfm}}} + 1,N_{\text{bands}} - 1\rbrack$
and $k = \lbrack k_{\text{start}}(b),k_{\text{end}}(b)\rbrack$.

The weighting factor for the normalized re-constructed higher band
signal, $\alpha$, is

$\alpha = \sqrt{1 - f_{\text{noise}_{\text{level}}}}$ (1851)

The weighting value of the normalized re-constructed higher band signal,
$\beta$, is

$\beta = 0\text{.}5\sqrt{f_{\text{noise}_{\text{level}}}}$ (1852)

where the noise level $f_{\text{noise}_{\text{level}}}$ is estimated as
follows:

$f_{\text{noise}_{\text{level}}} = \text{max}(\text{min}(0\text{.}\text{25} - \frac{{\overset{\sim}{I}}_{\text{norm}_{\text{diff}_{\text{sum}}}}}{{\overset{\sim}{I}}_{\text{norm}_{\text{sum}}}},0),0\text{.}\text{25})$
(1853)

and the sum of the differences between the consecutive norms
${\overset{\sim}{I}}_{\text{norm}_{\text{diff}_{\text{sum}}}}$ and the
sum of the norms${\overset{\sim}{I}}_{\text{norm}_{\text{sum}}}$ in the
index range$b = \lbrack 0,\text{28}\rbrack$, are given by

${\overset{\sim}{I}}_{\text{norm}_{\text{diff}_{\text{sum}}}} = \sum_{b = 0}^{\text{28}}\left| I_{N}^{q}(b + 1) - I_{N}^{q}(b) \right|$
(1854)

${\overset{\sim}{I}}_{\text{norm}_{\text{sum}}} = \sum_{b = 0}^{\text{28}}\left| I_{N}^{q}(b) \right|$
(1855)

##### 6.2.3.2.4 HVQ

First the HVQ decoder extracts from the bitstream number of coded peaks,
and reconstructs spectral peaks positions ${\hat{P}}_{k}$ and peak
gains${\hat{G}}_{p}(k)$. The peaks positions are decoded with either
Huffman decode or space coding decoder, based on the received mode
decision. The peak shapes vectors $\hat{S}(k)$are reconstructed from the
received VQ indices and further scaled with reconstructed peak
gains${\hat{G}}_{p}(k)$for the corresponding shape region. The
low-frequency bands are PVQ decoded, with number of bands determined as
described in 5.3.4.2.5

The unquantized coefficients below 5.6 kHz for 24.4 kb/s and 8 kHz for
32 kb/s are grouped into 2 sections and noise filled and scaled. Each of
the sections covers half of coded band (of 112 bins at 24.4 kbps and 160
bins at 32 kbps). After the noise fill each of the sections is scaled
with the corresponding reconstructed gains ${\hat{G}}_{\text{ne}}(0)$and
${\hat{G}}_{\text{ne}}(1)$. The gains reconstructed in the current frame
$t$ are smoothed with the levels from the past frame $t - 1$

${\hat{G}}_{h}^{(t)}(b) = 0\text{.}9{\hat{G}}_{h}^{(t - 1)} + 0\text{.}1{\hat{G}}_{h}^{(t)}\ b = 0,1$
(1856)

The reconstructed envelope levels used above 5.6 kHz for 24.4 kb/s and 8
kHz for 32 kb/s are adjusted based on the presence or absence of peak in
the low-frequency fine structure used in the noise-fill.

$\begin{matrix}
\text{if}_{\text{peak}} & \\
 & I_{b} = 0\text{.}1I_{b - 1} + 0\text{.}8I_{b} + 0\text{.}1I_{b + 1} \\
\text{else} & \\
 & \text{min}\left( I_{b - 1},I_{b},I_{b + 1} \right) \\
\end{matrix}$ (1857)

##### 6.2.3.2.5 Generic Mode

![](media/image20.wmf){width="6.688888888888889in"
height="3.803472222222222in"}

Figure 107: Generic mode Decoder Block Diagram

##### 6.2.3.2.5.1 Low frequency envelope decoding {#low-frequency-envelope-decoding .H6}

This is described in subclause 6.2.3.2.1.1.

##### 6.2.3.2.5.2 High frequency envelope de-quantization {#high-frequency-envelope-de-quantization .H6}

The envelope VQ indices
$\left\{ \text{idx}_{\text{env}1},\text{idx}_{\text{err}\text{21}},\text{idx}_{\text{err}_{\text{22}}},\text{idx}_{\text{Ierr}_{\text{31}}},\text{idx}_{\text{Ierr}_{\text{32}}} \right\}$
for SWB or
$\left\{ \text{idx}_{\text{env}_{1}},\text{idx}_{\text{err}\text{21}},\text{idx}_{\text{err}_{\text{22}}},\text{idx}_{\text{Ierr}_{\text{31}}},\text{idx}_{\text{Ierr}_{\text{32}}},\text{idx}_{\text{FB}} \right\}$
for FB are used to de-quantize the high frequency envelope.

At 24.4kbps, the de-quantized high frequency envelope can be determined
by:

$\begin{matrix}
{\hat{f}}_{\text{rms}_{G}}(j) = \\
\ \begin{matrix}
\left\{ \hat{e}\text{nv}_{1}(\left\lfloor \frac{j}{2} \right\rfloor) + \hat{e}\text{rr}_{2}(\left\lfloor \frac{j}{2} \right\rfloor)\text{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }\text{for}j = 0,2,4,6,8,\text{10},\text{12} \middle| \right.\ \left\{ \hat{I}\text{err}_{3}\left( \left\lfloor \frac{j - 1}{2} \right\rfloor \right) + \frac{\hat{e}\text{nv}_{1}\left( \left\lfloor \frac{j - 1}{2} \right\rfloor \right) + \hat{e}\text{rr}_{2}\left( \left\lfloor \frac{j - 1}{2} \right\rfloor \right) + \hat{e}\text{nv}_{1}\left( \left\lfloor \frac{j + 1}{2} \right\rfloor \right) + \hat{e}\text{rr}_{2}\left( \left\lfloor \frac{j + 1}{2} \right\rfloor \right)}{2} \middle| \right.\ \left\{ \text{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }\text{for}j = 1,3,5,7,9,\text{11} \middle| \right.\ \left\{ \middle| \right.\  \\
\end{matrix} \\
 \\
\end{matrix}$(1859)

*While at 32kbps, the de-quantized high frequency envelope can be
determined by:* $\begin{matrix}
{\hat{f}}_{\text{rms}_{G}}(j) = \\
\  \\
 \\
\end{matrix}\begin{matrix}
\left\{ \hat{e}\text{nv}_{1}(0) + \hat{e}\text{rr}_{2}(0) + \hat{I}\text{err}_{3}\left( 0 \right)\text{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }\text{for}j = 0 \middle| \right.\ \left\{ \hat{I}\text{err}_{3}\left( \left\lfloor \frac{j + 1}{2} \right\rfloor \right) + \frac{\hat{e}\text{nv}_{1}\left( \left\lfloor \frac{j - 1}{2} \right\rfloor \right) + \hat{e}\text{rr}_{2}\left( \left\lfloor \frac{j - 1}{2} \right\rfloor \right) + \hat{e}\text{nv}_{1}\left( \left\lfloor \frac{j + 1}{2} \right\rfloor \right) + \hat{e}\text{rr}_{2}\left( \left\lfloor \frac{j + 1}{2} \right\rfloor \right)}{2} \middle| \right.\ \left\{ \text{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }\text{for}j = 1,3,5,7,9 \middle| \right.\ \left\{ \middle| \right.\  \\
\end{matrix}$(1860)

The final de-quantized envelope is then calculated:

$\hat{E}\text{nv}(j) = \text{10}^{\left( {\hat{f}}_{\text{rms}_{G}}(j) + f_{\text{rms}_{\text{mean}}}(j) \right) \ast 0\text{.}\text{05}}\text{\ \ }\text{for}j = 0,\text{.}\text{.}\text{.},N_{\text{bands}_{G}} - 1$
(1858)

In FB case, $\text{idx}_{\text{FB}}$is further used to generate the
de-quantized high frequency envelope.

##### 6.2.3.2.5.3 High frequency envelope refinement {#high-frequency-envelope-refinement .H6}

The high frequency envelope refinement is described in subclause
5.3.4.2.6.5. After de-quantizing the high frequency envelope using the
VQ described in subclause 6.2.3.2.5.2, the de-quantized high frequency
envelope is mapped to one of the HQ high rate normal mode bands. To
generate the norms the mapped high frequency envelope is quantized and
de-quantized with the scalar quantizer, as shown in subclause 5.3.4.2.6.
The de-quantized low frequency envelope and the de-quantized high
frequency norms are then combined. Using the combined norms, the bit
allocation information per each band is calculated using the fractional
bit allocation method. If there are any high bands which have allocated
bits, the refinement data is decoded and used to update the high
frequency norms. The updated norms are used for de-normalizing the
de-quantized spectrum by the PVQ algorithm in subclause 6.2.3.2.5.4 and
the noise filling algorithm in subclause 6.2.3.2.5.5.Then the initial
bit allocation information is updated, based on the number of bits used
for representing the refinement data.

##### 6.2.3.2.5.4 PVQ {#pvq .H6}

This is described in subclause 6.2.3.2.1.2.2

##### 6.2.3.2.5.5 Noise filling {#noise-filling-3 .H6}

Noise filling is performed described in subclause 6.2.3.2.1.3.2.1. The
last band for this noise filling in Generic mode is defined
as$\text{max}(\text{core}_{\text{sfm}},N_{\text{band},\text{LF}} - 1)$,
where $\text{core}_{\text{sfm}}$is the last band index where the
spectrum was quantized using PVQ. The filled spectrum is further
de-normalized to generate $X_{M_{Q}}^{'}(k)$ as described in subclause
6.2.3.2.1.3.2.4. If *core\_sfm* is higher than *N~band\_LF~*-1, then the
${\overset{\sim}{E}}_{M}(b)$are the high frequency norms described in
subclause 6.2.3.2.5.3.

##### 6.2.3.2.5.6 High frequency excitation spectrum {#high-frequency-excitation-spectrum .H6}

The high frequency excitation spectrum is based on a copy of the decoded
low frequency spectrum. First spectral anti-sparseness processing is
applied, and then dynamic range control is applied to depending on the
decoded excitation class. Finally, a simple spectral copy is done to
create the high frequency excitation spectrum.

##### 6.2.3.2.5.6.1 Spectral anti-sparseness processing {#spectral-anti-sparseness-processing .H6}

The spectral anti-sparseness processing is performed on the low
frequency spectrum by inserting a 0.5 amplitude coefficient, with a
random sign, where the normalized spectrum is zero. The end band for the
spectral anti-sparseness processing is specified by *B~anti~*
(=max(*core\_sfm*,*N~band\_LF~*-1)) and the end frequency is specified
by *L~anti~*(=*k~end~*(*B~anti~*)).

${\hat{X}}_{M_{\text{anti}}}(k) = \begin{matrix}
\left\{ X_{M_{Q}}^{'}(k)\text{\ \ \ \ \ \ \ \ \ \ \ }\text{if\ \ \{}X \middle| \middle| '_{M_{Q}}(k)\text{\ !} = 0 \middle| \right.\ \left\{ 0\text{.}5\text{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }\text{if\ \ \{}X \middle| \middle| '_{M_{Q}}(k) = 0\text{\ and\ λ}_{\text{seed}_{G}} > 0 \middle| \right.\  \\
\end{matrix}$ (1859)

where $\lambda_{\text{seed}_{G}}$is a random seed and updated by
$\lambda_{\text{seed}_{G}} = \lambda_{\text{seed}_{G}} \ast \text{31821} + \text{13849}$.

After applying this anti-sparseness processing, the energy is further
modified by applying the low band dequantized envelope as described in
subclause 6.2.3.2.5.1.

##### 6.2.3.2.5.6.2 Control of dynamics based on the excitation class {#control-of-dynamics-based-on-the-excitation-class .H6}

Following the spectral anti-sparseness processing, the spectrum is
further modified by additional processing to control the dynamics.

The spectrum is first normalised by calculating the envelope of the
processed spectrum, then dividing the spectrum by this envelope. The
window size*,*$L_{\text{norm}}$, for this normalisation depends on the
signal characteristics..

The 256 low frequency MDCT coefficients in the 0-6400 Hz frequency
range,
${\hat{X}}_{M_{\text{anti}}}\left( k \right),k = 0,\text{.}\text{.}\text{.},\text{255}$are
split into 16 sharpness bands (16 coefficients per band). In sharpness
band *j*, if
$\text{23}A_{\text{sharp}}\left( j \right) > 8\sum_{k = \text{16}j}^{\text{16}j + \text{15}}\left| {\hat{X}}_{M_{\text{anti}}}\left( k \right) \right|$
and$A_{\text{sharp}}\left( j \right) > \text{10}$ , the counter
$C_{\text{band}}$is incremented by one.

The maximum magnitude of the spectral coefficients in a sharpness band,
denoted$A_{\text{sharp}}\left( j \right)$, is:

$A_{\text{sharp}}\left( j \right) = \underset{k = \text{16}j,\ldots\text{16}j + \text{15}}{\text{max}}\left| {\hat{X}}_{M_{\text{anti}}}\left( k \right) \right|\ j = 0,\ldots,\text{15}$
(1860)

Parameter$C_{\text{band}}$is initialized to 0 and calculated for every
frame. Then the normalization length $L_{\text{norm}}$is obtained:

$L_{\text{norm}} = \left\lfloor 0\text{.}1L_{\text{norm}^{\lbrack - 1\rbrack}} + 0\text{.}9L_{\text{norm}} + 0\text{.}5 \right\rfloor$
(1861)

where the current normalization length $L_{\text{norm}}$ is calculated
as follows:

$L_{\text{norm}} = \left\lfloor 8 + 0\text{.}5C_{\text{band}} \right\rfloor$
(1862)

and the current normalization length is preserved
as$L_{\text{norm}^{\lbrack - 1\rbrack}}$.

The spectrum is then normalized

$X_{\text{Norm}}(k) = \frac{{\hat{X}}_{M_{\text{anti}}}(k)}{\sum_{l = k - \left\lfloor \frac{L_{\text{norm}}}{2} \right\rfloor}^{k + \left\lfloor (L_{\text{norm}} - 1\frac{)}{2} \right\rfloor}\left| {\hat{X}}_{M_{\text{anti}}}(l) \right|}\text{\ \ \ \ \ \ \ }\text{for}k = 2,\text{.}\text{.}\text{.},N_{\text{bands}_{d}}\text{*16} + \text{1\ }$
(1863)

where $N_{\text{bands}_{d}}$is the number of bands used in the control
of dynamics.

The sign vectors for the spectrum are then removed, leaving just the
magnitude, and the mean is then calculated for each band *p*. The bands
are 16 frequency bins wide, and start at frequency bin 2. For the SWB
case, at 24.4kbps there are 9 bands ending at frequency bin 145, while
for 32kbps there are 8 bands, ending at frequency bin 129. For the FB
case, at 24.4kbps there are 19 bands ending at frequency bin 305, while
for 32kbps there are 18 bands, ending at frequency bin 289

The amplitude of each frequency bin is then reduced by a dynamics
control factor of the difference between the bin amplitude and mean of
the band.

$\left| {\overset{\sim}{X}}_{\text{Norm}}(k) \right| = \left| X_{\text{Norm}}(k) \right| - \left\{ \left| X_{\text{Norm}}(k) \right| - \text{Mean}\left( p \right) \right\} \ast \text{drf}\text{\ \ \ \ \ }\text{for\ k} = 2,\text{.}\text{.}\text{.}\text{,N}_{\text{bands}_{d}} \ast \text{16} + 1$
(1864)

where *drf* is the dynamics control factor depending on the decoded
excitation class, $\text{drf} = \begin{matrix}
\left\{ 0\text{.}\text{05}\ \text{for}\text{HF}_{\text{excitation}_{\text{class}}}1 \middle| \right.\ \left\{ 0\text{.}8\ \text{for}\text{HF}_{\text{excitation}_{\text{class}}}0 \middle| \right.\  \\
\end{matrix}$ (1865)

The original signs are then re-applied for the
*HF\_Speech\_excitation\_class* and the *HF\_excitation\_class1*;
however random signs are used for the *HF excitation\_class0*. If
$\lambda_{\text{seed,dc}} = \lambda_{\text{seed,dc}} \ast \text{31821} + \text{13849}$is
higher than 0, the original sign is re-applied, otherwise, a reversed
sign of the original is applied. The initial random seed is

$\lambda_{\text{seed}_{\text{dc}}} = R(0) \ast 8 + R(1) \ast 4 + R(2) \ast 2 + R(3)$
(1866)

where $R(b)$is the number of allocated integer bits for each band.

The spectrum is then normalised:

$\overset{\sim}{X}(k) = \frac{{\overset{\sim}{X}}_{\text{Norm}}(k)}{\sqrt{1\text{16}\sum_{}^{}\left\lbrack {\overset{\sim}{X}}_{\text{Norm}}(i) \right\rbrack^{2}}}\text{\ \ \ \ \ \ \ }\text{for}k = 2,\text{.}\text{.}\text{.}\text{,N}_{\text{bands}_{d}} \ast \text{16} + 1$
(1867)

The normalised spectrum is then copied, using the mapping in table 179,
to create the high frequency excitation spectrum.

Table 180: Frequency mapping to generate high frequency excitation
spectrum

  ------------- ----- ----- ----- ----- -----
                *l*                     
  24.4kbps      0     2     129   320   447
                1     2     129   448   575
                2     80    143   576   639
  24.4kbps FB   3     144   303   640   799
  32kbps        0     2     129   384   511
                1     2     129   512   639
  32kbps FB     2     130   289   640   799
  ------------- ----- ----- ----- ----- -----

Finally the high frequency excitation spectrum is adjusted at the
junction boundaries,

$\overset{\sim}{X}(j) = \overset{\sim}{X}(j) \ast R_{3}(j)\text{\ \ \ \ }\text{\ j} = \text{St}_{\text{dst}_{G}}(1)\text{,St}_{\text{dst}_{G}}(1) + 1,\text{.}\text{.}\text{.}\text{\ \ \ \ \ }j \in \left\{ R_{3}(j) < 1 \right\}$
(1868)

where
$R_{\text{10}} = \sum_{}^{}\left| {\overset{\sim}{X}}_{\text{Norm}}(i) \right|$,$R_{\text{20}} = \sum_{}^{}\left| {\overset{\sim}{X}}_{\text{Norm}}(i) \right|$,$R_{3}(\text{St}_{\text{dst}_{G}}(1)) = \text{max}\left( 0\text{.}3,R_{\text{20}}/R_{\text{10}} \right)$
and $R_{3}(j + 1) = R_{3}(j) + 0\text{.}1$.

If $\frac{R_{\text{10}}}{R_{\text{20}}} > 5,$and then

$\overset{\sim}{X}(j) = \overset{\sim}{X}(j) \ast R_{4}(j)\text{\ \ }\text{for\ j} = \text{St}_{\text{dst}_{G}}(1) - 1,\text{St}_{\text{dst}_{G}}(1) - 2,\text{.}\text{.}\text{.}\text{\ \ \ \ }j \in \left\{ R_{4}(j) > 1 \right\}$
(1869)

where$R_{4}(\text{St}_{\text{dst}_{G}}(1) - 1) = \text{min}\left( 5,\frac{R_{\text{10}}}{R_{2}}0 \right)$
and$R_{4}(j - 1) = R_{4}(j) - 0\text{.}5\text{\ \ for\ j} = 0,1,\text{.}\text{.}\text{.}$

At 24.4kbps,

$\overset{\sim}{X}(j) = \overset{\sim}{X}(j) \ast R_{3}(j)\text{\ \ \ \ }\text{\ j} = \text{St}_{\text{dst}_{G}}(2)\text{,St}_{\text{dst}_{G}}(2) + 1,\text{.}\text{.}\text{.}\text{\ \ \ \ }j \in \left\{ R_{3}(j) < 1 \right\}$
(1870)

where
$R_{\text{11}} = \sum_{}^{}\left| {\overset{\sim}{X}}_{\text{Norm}}(i) \right|$,$R_{\text{21}} = \sum_{}^{}\left| {\overset{\sim}{X}}_{\text{Norm}}(i) \right|$,$R_{3}(\text{St}_{\text{dst}_{G}}(2)) = \text{max}\left( 0\text{.}3,R_{\text{21}}/R_{\text{11}} \right)$
and $R_{3}(j + 1) = R_{3}(j) + 0\text{.}1$, and then

$\overset{\sim}{X}(j) = \overset{\sim}{X}(j) \ast R_{6}(j)\text{\ \ }\text{for\ j} = \text{St}_{\text{dst}_{G}}(2) - 1,\text{St}_{\text{dst}_{G}}(2) - 2,\text{.}\text{.}\text{.}\text{\ \ \ \ \ }j \in \left\{ R_{6}(j) > 1 \right\}$
(1871)

where$R_{6}(\text{St}_{\text{dst}_{G}}(2) - 1) = 0\text{.}\frac{5 \ast R_{\text{11}}}{R_{\text{21}}}$,$R_{5} = 0\text{.}\frac{\text{025} \ast R_{\text{11}}}{R_{\text{21}}}$
and $R_{6}(j + 1) = R_{6}(j) - R_{5}$.

##### 6.2.3.2.5.7 Spectral envelope adjustment {#spectral-envelope-adjustment .H6}

Spectral envelope adjustment is used to generate high frequency spectrum
with combining the high frequency excitation spectrum and the
interpolated envelope according to the frequency. The low frequency
envelope is used in the first band. The interpolated envelope is
calculated as follows:

$\hat{E}\text{nv}_{t}(k) = \begin{matrix}
\left\{ \hat{E}\text{nv}( - 1) \cdot w_{0}(k) + \hat{E}\text{nv}(0) \cdot (1 - w_{0}(k))\text{\ \ \ \ \ \ \ \ }\text{for}k = k_{\text{st}}(0),\text{.}\text{.}\text{.},k_{\text{st}}(0) + 7 \middle| \right.\ \left\{ \hat{E}\text{nv}(p - 1) \cdot w_{p}(k) + \hat{E}\text{nv}(p) \cdot (1 - w_{p}(k))\text{\ \ }\text{for}k = \frac{k_{\text{st}}(p - 1) + k_{\text{st}}(p)}{2},\text{.}\text{.}\text{.},\frac{k_{\text{st}}(p) + k_{\text{st}}(p + 1)}{2} - 1 \middle| \right.\  \\
\end{matrix}$ (1872)

where *p* (*p*=1,...,*N~band\_G~*-1) is a band index;

*w~p~*(*k*) is a interpolation function where
$w_{0}(k) = 0\text{.}\text{125}(k - k_{\text{st}}(0))$and
$w_{p}(k) = 2 \cdot \left( k - \left( k_{\text{st}}(p - 1) + k_{\text{st}}(p) \right)/2 \right)/\left( k_{\text{st}}(p + 1) - k_{\text{st}}(p - 1) \right)$;
and

$\hat{E}\text{nv}( - 1)$ is the initial value of the spectral envelope
$\left( \hat{E}\text{nv}( - 1) = \sqrt{1\text{16}\sum_{}^{}{X_{M_{Q}}^{'}(k) \ast X_{M_{Q}}^{'}(k)}} \right)$.

The envelope is then multiplied by the generated high frequency
excitation spectrum in subclause 6.2.3.2.5.6.

${\hat{X}}_{M_{G}}(k) = \overset{\sim}{X}(k) \ast \hat{E}\text{nv}_{t}(k)\text{\ \ \ \ }\text{for}k = \text{St}_{\text{dst},\text{HQG}}(0),\text{St}_{\text{dst},\text{HQG}}(0) + 1,\text{.}\text{.}\text{.},\text{639}$
(1873)

In the FB case, the maximum value of *k* in equations (1874) and (1875)
is corrected to 799 and a decision is made on whether or not to
interpolate the envelope by comparing the envelope of the first band in
FB and the last band in SWB.

$\text{Inf}_{\text{int}} = \begin{matrix}
\left\{ 1\text{\ \ \ \ \ \ \ \ \ }\text{if\ \ \{}\hat{E} \middle| \middle| \text{nv}(p_{b} - 1) - \hat{E}\text{nv}(p_{b}) > \text{15}\text{\ or\ \ \{}\hat{E} \middle| \middle| \text{nv}(p_{b}) < 5 \middle| \right.\  \\
\end{matrix}$ (1876)

where *p~b~* is the index of the first band in FB, 14 at 24.4kbps or 12
at 32kbps.

##### 6.2.3.2.5.8 Spectral combining {#spectral-combining .H6}

The final step of the Generic mode is to combine the noise filled
spectrum$X_{M_{Q}}^{'}(k)$, obtained from decoding the quantized
spectrum in subclauses 6.2.3.2.5.4 and 6.2.3.2.5.5, with the high
frequency spectrum${\overset{\sim}{X}}_{M_{G}}(k)$, generated in
subclause 6.2.3.2.5.7. The noise filled spectrum includes the low
frequency spectrum and some bands in the high frequency spectrum where
bits were allocated during the spectral quantization. The generated high
frequency spectrum includes only the high frequency spectrum.

There are two kinds of overlap bands between these two spectra; one is a
partial overlap at the junction between the low frequency and the high
frequency (376\~400 at 32kbps, 304\~328 at 24.4kbps). The other is a
full overlap due to the difference between the two band allocations,
i.e. due to some bands in the high frequency spectrum being allocated
bits during the spectral quantisation.

In the partial overlap band, the spectral combining is performed based
on an overlap and add process. If there are any allocated bits from the
spectral quantizer, the noise filled spectrum $X_{M_{Q}}^{'}(k)$is used
directly for the final decoded spectrum. If there were no bits allocated
by the spectral quantizer, a overlap and add process between the two
spectra is performed:

$X_{M}^{'}(k) = X_{M_{Q}}^{'}(k) \ast \left( \frac{l}{L_{\text{ov}}} \right) + {\overset{\sim}{X}}_{M_{G}}(k) \ast (1 - \frac{l}{L_{\text{ov}}})\text{\ \ \ \ }\text{for}k = \text{St}_{\text{dst}_{G}}(0),\text{St}_{\text{dst}_{G}}(0) + 1,\text{.}\text{.}\text{.},\text{St}_{\text{dst}_{G}}(0) - L_{\text{ov}} - 1$
(1877)

where $L_{\text{ov}}$is the overlapped length at the junction band, 16
at 24.4kbps and 8 at 32kbps.

In the full overlap bands, the spectrum is combined in a selective way.
If there are any allocated bits from the spectral quantizer, the noise
filled spectrum $X_{M_{Q}}^{'}(k)$is used directly for the final decoded
spectrum. If there were no bits allocated by the spectral quantizer, the
high frequency spectrum ${\overset{\sim}{X}}_{M_{G}}(k)$ is used for
generating the final decoded spectrum $X_{M}^{'}(k)$.

##### 6.2.3.2.6 PVQ decoding and de-indexing

##### 6.2.3.2.6.1 High dynamic range arithmetic decoding {#high-dynamic-range-arithmetic-decoding .H6}

The PVQ-codewords are extracted from the bit stream using the Range
decoder.

##### 6.2.3.2.6.2 Split-PVQ decoding approach {#split-pvq-decoding-approach .H6}

The PVQ-split parameters are obtained as inverse of the functions in
subclause 5.3.4.2.7.2

##### 6.2.3.2.6.2.1 Split-PVQ Decoder band splitting calculation {#split-pvq-decoder-band-splitting-calculation .H6}

The initial number of segments (parts) $N_{p_{\text{init}}}$is computed
according to the first equation in subclause 5.3.4.2.7.2.1. In case
$N_{p_{\text{init}}} < \text{10}$ and the band bit rate is high, the
flag $\text{pvq}_{\text{split}_{\text{inc}}}$is read from the bit
stream. Finally, $N_{p}$is computed as

$N_{p} = \left\{ \begin{matrix}
N_{p_{\text{init}}} + 1,\ \text{pvq}_{\text{split}_{\text{inc}}} = 1 \\
N_{p_{\text{init}}},\ \text{pvq}_{\text{split}_{\text{inc}}} = 0 \\
\end{matrix} \right.\ $ (1878)

##### 6.2.3.2.6.2.2 PVQ sub vector gain decoding {#pvq-sub-vector-gain-decoding .H6}

The decoded Split-PVQ angles are converted into sub-vector gains.

##### 6.2.3.2.6.3 PVQ sub-vector MPVQ de-indexing {#pvq-sub-vector-mpvq-de-indexing .H6}

First the$N$, $K$ values for the sub vector $y$ to be decoded are used
in a 'FindSizeAndOffsets(N,K)' function which pre-computes the row
$n = N$of the MPVQ offset matrix \[$A(N,0\text{.}\text{.}\text{.}K)$,
$U(N,K + 1)$\] and also calculates the integer size of the MPVQ-index
*MPVQ-size* using this last row. The last four equation in subclause
5.3.4.2.7.4.1 are employed for the offset and size calculations.

Secondly the 1 bit leading sign index and the MPVQ-index$\text{index}$is
obtained from the Range decoder using the calculated *MPVQ-size*
information. The leading sign$\text{lead}_{\text{sign}}$is decoded from
the 1 bit leading sign index, where a zero sign index yields a positive
$\text{lead}_{\text{sign}}$ value of "+1", and a non-zero sign index
yields a negative $\text{lead}_{\text{sign}}$value of "-1".

The third step is the actual MPVQ-de-indexing scheme, converting the
leading sign $\text{lead}_{\text{sign}}$ and the $\text{index}$ to a
valid integer $\text{PVQ}(N,K)$vector $y$.

The MPVQ de-indexing loop is carried out according to figure 113, where
$\text{index}$ is the MPVQ-index, $n$is the current row number of the
MPVQ offset matrix, $\text{pos}$is the pointer into the
samples/coefficients of the received PVQ-vector $y$. The function
"FindAmplitudeAndOffset" obtains the amplitude $k_{\text{delta}}$ and
the MPVQ indexing offset $\text{amp}_{\text{offset}}$ for the current
number of accumulated pulses$k\text{\_max\_}\text{local}$, by searching
in the current row
$A(n,0\text{.}\text{.}\text{.}k\text{\_max\_}\text{local})$in the MPVQ
offset matrix. Further the function "UpdateOffsetsBwd" iteratively
updates the required MPVQ-offsets for the next larger dimension using
combinations of the last four equations in subclause 5.3.4.2.7.4.1. The
function "GetLeadSign" obtains the next leading sign value
$\text{lead}_{\text{sign}}$ from the LSB of $\text{index}$, and shifts
the $\text{index}$one bit to the right. On the decoder side the MPVQ
recursion is run in the order of position 0 to position$N - 1$, with a
dimension $n$decreasing from $N$ to 1.

![](media/image21.wmf){width="4.874305555555556in"
height="6.627083333333333in"}

Figure 113: Detailed MPVQ-de-indexing

The calculation of the indexing offset matrix is optimized to use direct
calculations up to row $n = 3$for any combination of $N$and $K$, further
if the number of unit pulses $K$ are low enough and the dimension $N$ is
5 or lower, a direct row $n$initialization of the offset matrix is used
for the offset determination, where the last column in row $n$ is
calculated using the low dynamic "row-only" relation:

$U(n,k) = \left\lfloor \frac{A(n,k - 2)}{2} \right\rfloor + \frac{\left( n \cdot A(n,k - 1) - \left( 1 + \left\lfloor \frac{A(n,k - 1)}{2} \right\rfloor + \left\lfloor \frac{A(n,k - 2)}{2} \right\rfloor \right) \right)}{k - 1}$
(1879)

### 6.2.4 Frequency-to-time transformation

#### 6.2.4.1 Long block transformation (ALDO window)

##### 6.2.4.1.1 eDCT

The IDCT~IV~ is identical to the DCT~IV~ and is given by the following
equation, with omitted normalization:

${\overset{\sim}{x}}^{q}(n) = \sum_{k = 0}^{L - 1}{z^{q}(k)\text{cos}\left\lbrack \left( n + \frac{1}{2} \right)\left( k + \frac{1}{2} \right)\frac{\pi}{L} \right\rbrack},n = 0,1,\ldots,L - 1$
(1880)

##### 6.2.4.1.2 Unfolding and windowing

The frame ${\overset{\sim}{x}}^{q}(n)$, $n = 0,\ldots,L - 1$, coming
from the inverse eDCT transform is unfolded in order to obtain two
frames that can be used for overlap- add with the previous unfolded
frame to remove the aliasing introduced by the folding process at the
encoder.

Similar to the folding done at the encoder, unfolding and window
decimation operations are combined in the same process to automatically
resample the ALDO windows at 48 and 25.6 kHz while keeping perfect
reconstruction conditions. The decimation factor and offset parameters
are the same are the one used in the encoder.

The frame ${\overset{\sim}{x}}^{q}(n)$ issued from the eDCT inverse
transform is unfolded into a block $T_{2L}^{q}$ of length $2L$. The ALDO
window is stored at a sampling rate corresponding to two frames of
length $N$ ($N \geq L$). The ratio between $N$and $L$is called the
decimation factor ($d_{f}$). The unfolding and windowing process is
illustrated in figure 114.

![](media/image22.png){width="4.554861111111111in"
height="3.270138888888889in"}

Figure 115: Unfolding and windowing with ALDO window.

The unfolded frame is obtained for $n = 0,\ldots,\frac{L}{2} - 1$:

$T_{2L}^{q}\left( n \right) = {\overset{\sim}{x}}^{q}\left( \frac{L}{2} + n \right)h_{s}\left( n\text{.}d_{f} + d \right)$,
(1882)

, (1883)

$T_{2L}^{q}\left( L + n \right) = - {\overset{\sim}{x}}^{q}\left( \frac{L}{2} - n - 1 \right)h_{s}\left( N + n\text{.}d_{f} + d \right)$,
(1884)

$T_{2L}^{q}\left( \frac{3L}{2} + n \right) = - {\overset{\sim}{x}}^{q}\left( n \right)h_{s}\left( \frac{3N}{2} - 1 + \left( n + 1 \right)d_{f} - d \right)$,
(1885)

where $h_{s}\left( n \right)$ is the time-reversed version of the ALDO
window $h_{a}\left( n \right)$used in the encoder

$h_{s}\left( n \right) = h_{a}\left( 2N - n - 1 \right)$, (1886)

$d_{f}$ is the decimation factor and $d$ is the offset.

For the 32 kHz case, to have perfect reconstruction, the ALDO window
decimated from 48 to 16 kHz applied on one sample over 2, the other
samples are weighted by a complementary window $h_{\text{comp}}(n)\ $.
For this 32 kHz case, the unfolded frames are given by:

, (1887)

, (1888)

, (1889)

, (1890)

, (1891)

, (1892)

, (1893)

, (1894)

where is the length of the 16kHz frame, $L$ is the length of MDCT core
frame at 32kHz, $d_{f} = 3$ is the decimation factor and $d = 1$ is the
offset.

##### 6.2.4.1.3 Overlap-add

Finally, the output full-band signal is constructed by overlap-adding
the signals ${\overset{\sim}{x}}^{(r)}(n)$ for two successive frames:

$x^{(r)}(n) = T_{2L}^{q^{(r - 1)}}(n + L) + T_{2L}^{q^{(r)}}(n),\text{\ \ \ }\ n = 0,\ldots,2L - 1$
(1881)

##### 6.2.4.1.4 Pre-echo attenuation

A typical artefact in transform coding known as pre-echo is observed
especially when the signal energy grows suddenly, like speech onsets or
music percussions. The origin of pre-echoes is explained below. The
quantization noise in the frequency domain is translated into the time
domain by an inverse MDCT transform and an add/overlap operation. Thus
the quantization noise is spread uniformly in the MDCT synthesis window.
In case of an onset, the part of the input signal preceding the onset
often has a very low energy compared to the energy of the onset part.
Since the quantization noise level depends on the mean energy of the
frame, it can be quite high in the whole synthesis window. In this case,
the signal to noise ratio (SNR) is very low (often negative) in the low
energy part. The quantization noise can be audible before the onset as
an extra artificial signal called pre-echo. To prevent the pre-echo
artefact, an attenuation scheme is necessary when there is a significant
energy increase (attack or onset) in some part of the synthesis window,
and the pre-echo reduction has to be performed in the low energy part of
the synthesis window preceding the onset. In the following, this low
energy part preceding an onset will be referenced as \"pre-echo zone\".
On the other hand the signal energy after pre-echo reduction should not
lower than the mean energy in the preceding frames. However, if the
preceding frame have low frequency spectrum, knowing that the pre-echo
has often white noise like spectrum, even if the energy of the pre-echo
zone is reduced to the level of the previous frames the pre-echo is
still audible in the higher frequencies.

To improve the pre-echo reduction, an adaptive spectral shaping
filtering is applied in the pre-echo zone up to the detected attack or
onset to eliminate undesirable higher frequency pre-echo noise. This
adaptive spectral shaping filter is realized by a two-band filterbank:
the decoded signal is decomposed into two sub-signals according to a
frequency criterion to obtain two sub-bands and a pre-echo attenuation
factor is calculated in the determined pre-echo zone for each sample in
both sub-bands. The attenuation factors of the sub-bands that
determinate the spectral response of the filter are computed in function
of several parameters of the full-band and sub-band signals as detailed
below. The pre-echo attenuation is made in the sub-bands by applying
these attenuation factors in the pre-echo-zone. Finally the two
attenuated sub-bands are combined to obtain the pre-echo attenuated
decoded signal. The pre-echo attenuation is activated for received
frames, when the previous frame was also received, and when the bitrate
is not higher than 32 kbit/s.

A pre-echo in the current frame can be caused by a sharp onset in the
current or the next frame, as the MDCT analysis window covers these two
consecutive frames. An onset in the next frame can be detected by
analysing the memory of inverse MDCT that will be used in the next frame
in the overlap-add operation. A discrimination of pre-echo/non-pre-echo
zones and the attenuation factor computation are based on two signals of
the inverse MDCT transform: on the decoded output full-band signal
$x^{(r)}(n)$, $n = 0,\text{.}\text{.}\text{.},L - 1$ and on the first
$L_{\text{premem}} = \frac{7}{\text{32}}L$ un-windowed memory of inverse
MDCT
$x_{\text{premem}}(n) = {\overset{\sim}{x}}^{\text{wq}^{(r)}}(n + L)$,
$n = 0,\text{.}\text{.}\text{.},L_{\text{premem}} - 1$ that will be used
in the next frame in the overlap-add operation to synthesize the output
content for the next frame and the pre-echo reduction is done in echo
zones preceding the onsets.

**Decomposition in two sub-bands**

The decoded signal $x^{(r)}(n)$ is decomposed in a lower and an upper
frequency band sub-signals. These signals are computed by applying an
adaptive zero-delay FIR filter with transfer function
![](media/image33.png){width="1.2986111111111112in"
height="0.16666666666666666in"} in low-band, with
![](media/image34.png){width="9.027777777777778e-2in"
height="0.1597222222222222in"} = 0.25 in the current frame and 0
otherwise; the high-band is given by the complementary filter. The
first, lower band sub-signal is obtained by a first filtering of the
full-band signal by the low-pass filter

![](media/image35.png){width="4.631944444444445in" height="0.5625in"}
(1896)

and the second, higher band sub-signal is obtained by subtracting the
lower band sub-signal from the decoded signal:

$x_{\text{HB}}(n) = x^{(r)}(n) - x_{\text{LB}}(n)$ (1882)

For the memory part $x_{\text{premem}}(n)$ only the higher-band
component is computed as

$x_{\text{premem}_{\text{LB}}}(n)\  = \ \left\{ \begin{matrix}
 - 0\text{.}\text{25}x^{(r - 1)}(L - 1) + 0\text{.}5x_{\text{premem}}(n) - 0\text{.}\text{25}x_{\text{premem}}(n + 1) & n = 0 \\
 - 0\text{.}\text{25}x_{\text{premem}}(n - 1) + 0\text{.}5x_{\text{premem}}(n) - 0\text{.}\text{25}x_{\text{premem}}(n + 1) & n = 1,\ldots,L_{\text{premem}} - 2 \\
0\text{.}\text{25}x_{\text{premem}}(n - 1) + 0\text{.}5x_{\text{premem}}(n) & n = L_{\text{premem}} - 1 \\
\end{matrix} \right.\ $ (1883)

**Discrimination procedure of pre-echo/non-pre- echo zones**

The discrimination procedure between pre-echo zones and non-pre-echo
zones is based on the concatenated signal formed from $x^{(r)}(n)$,
$n = 0,\text{.}\text{.}\text{.},L - 1$ and
$x_{\text{premem}}(n) = {\overset{\sim}{x}}^{\text{wq}^{(r)}}(n + L)$,
$n = 0,\text{.}\text{.}\text{.},L_{\text{premem}} - 1$. This signal is
divided in sub-blocks and its temporal envelope is computed.

The current frame part of the concatenated signal, $x^{(r)}(n)$,
$n = 0,\text{.}\text{.}\text{.},L - 1$ is divided into $N_{\text{sf}}$
sub-blocks of $L_{\text{sf}} = \frac{L}{N_{\text{sf}}}$ samples where
$N_{\text{sf}}$ =8 (2.5 ms sub-blocks). The temporal envelope
$\text{Es}_{\text{MDCT}}(i)$ of this signal is computed as successive
sub-block energies.

$\text{Es}_{\text{MDCT}}(i) = \sum_{n = L_{\text{sf}}\text{.}i}^{L_{\text{sf}}\text{.}\left( i + 1 \right) - 1}\left\lbrack x^{(r)}(n) \right\rbrack^{2}$,
$i = 0,\ldots,N_{\text{sf}} - 1$ (1884)

The memory part of the concatenated signal forms one sub-block, its
energy is computed as

$\text{Es}_{\text{MDCT}}(N_{\text{sf}}) = \sum_{n = 0}^{L_{\text{premem}} - 1}\left\lbrack x_{\text{premem}}(n) \right\rbrack^{2}$
(1885)

The energy of the first half and the first ¾ samples of each sub-blocks
of the current frame are also memorized:

$\text{Es}_{\text{MDCT}_{h}}(i) = \sum_{n = L_{\text{sf}}\text{.}i}^{L_{\text{sf}}\text{.}\left( i + 1 \right) + \frac{L_{\text{sf}}}{2} - 1}\left\lbrack x^{(r)}(n) \right\rbrack^{2}$,
$i = 0,\ldots,N_{\text{sf}} - 1$ (1886)

$\text{Es}_{\text{MDCT}_{\text{tq}}}(i) = \sum_{n = L_{\text{sf}}\text{.}i}^{L_{\text{sf}}\text{.}\left( i + 1 \right) + 3\frac{L_{\text{sf}}}{4} - 1}\left\lbrack x^{(r)}(n) \right\rbrack^{2}$,
$i = 0,\ldots,N_{\text{sf}} - 1$ (1887)

The temporal envelope of the higher band in the current frame is also
computed:

$\text{Es}_{\text{MDCT}_{\text{hb}}}(i) = \sum_{n = L_{\text{sf}}\text{.}i}^{L_{\text{sf}}\text{.}\left( i + 1 \right) - 1}\left\lbrack x_{{}^{\text{hb}}}^{(r)}(n) \right\rbrack^{2}$,
$i = 0,\ldots,N_{\text{sf}} - 1$ (1888)

Then, $\text{Es}_{\text{MDCT}_{h}}(i)$, $i = 0,\ldots,N_{\text{sf}} - 1$
is then modified as follows:

$\text{Es}_{\text{MDCT}_{\text{hb}}}(i) = \left\{ \begin{matrix}
2\left( \text{Es}_{\text{MDCT}}(i) - \text{Es}_{\text{MDCT}_{\text{hb}}}(i) \right) & \text{if}\ \text{Es}_{\text{MDCT}_{h}}(i) < \text{Es}_{\text{MDCT}}(i\frac{)}{2} \\
\text{Es}_{\text{MDCT}}(i) & \text{otherwise} \\
\end{matrix} \right.\ $ (1889)

In this paragraph, index $n$ is used for samples, and index $i$ is used
for sub-blocks.

In the concatenated signal the sub-block with maximal energy, including
the memory sub-block, is also searched:

$\text{Max}_{\text{Es}} = \underset{i = 0,\ldots,N_{\text{sf}}}{\text{max}}\text{Es}_{\text{MDCT}}(i)$
(1890)

The transition of the temporal envelope to a high-energy zone is
detected in the sub-block with the index $\text{Maxind}_{\text{Es}}$
given by:

$\text{Maxind}_{\text{Es}} = \text{arg}\underset{i = 0,\ldots,N_{\text{sf}}}{\text{max}}\text{Es}_{\text{MDCT}}(i)$
(1891)

Note that when $\text{Maxind}_{\text{Es}}$=0 either no pre-echo
attenuation is made or the pre-echo attenuation of the previous frame is
finished on the first samples of the current frame.

The zero-crossing rate
$\text{zcr}(i)$*,*$i = 0,\ldots,N_{\text{sf}} - 1$ is also computed for
each sub-block. A zero-crossing is detected when the product of two
consecutive samples is smaller or equal to 0. The parameter
$\text{zcr}(i)$*,*$i = 0,\ldots,N_{\text{sf}} - 1$ is defined as the
number of times when the following condition is verified:

$x^{(r)}(\text{iN}_{\text{sf}} + n)x^{(r)}(\text{iN}_{\text{sf}} + n) \leq 0$,
$n = 1,\ldots,L_{\text{sf}} - 1$ (1892)

The zero crossings between two consecutive sub-blocks count for the next
sub-block. The zero crossing rate of the memory part is also computed.

The maximum length without zero crossing
$\text{nzcr}(i)$*,*$i = 0,\ldots,N_{\text{sf}} - 1$ is also stored for
each sub-block. A period without zero crossing that covers a sub-block
border is taken into account for the previous sub-block.

The maximal energy $\text{Max}_{\text{Es}}$ is compared to that of the
preceding sub-blocks:

$r_{\text{Es}}(i) = \frac{\text{Max}_{\text{Es}}}{\text{Es}_{\text{MDCT}}(i)}$,
$i = 0,\ldots,\text{Maxind}_{\text{Es}} - 1$ (1893)

The low energy sub-blocks preceding the sub-block in which a transition
has been detected with $r_{\text{Es}}(i)$\> 16 are determined as
pre-echo zone. However in the following cases the sub-block is
considered as non-pre-echo zone:

> if
> $\text{Es}_{\text{MDCT}_{\text{hb}}}(i) > \text{100}\left( \text{Es}_{\text{prev}_{\text{nc}}} + \text{500000} \right)$

or

> if
> $\text{Es}_{\text{MDCT}_{\text{hb}}}(i) > \text{100}\left( \text{Es}_{\text{prev}_{\text{nc}}} + \text{500000} \right)$
> and $\text{zcr}(i) < \text{lim}_{\text{zcr}}$

or

> if
> $\text{Es}_{\text{MDCT}_{\text{hb}}}(i) > \text{100}\left( \text{Es}_{\text{prev}_{\text{nc}}} + \text{500000} \right)$
> and
> $6\text{Es}_{\text{MDCT}_{\text{tq}}}(i) < \text{Es}_{\text{MDCT}}(i)$

where, computed in the previous frame and memorised,

$\text{Es}_{\text{prev}_{\text{nc}}} = \text{max}\left( \frac{\sum_{i = 0}^{N_{\text{sf}} - 1}{\text{Es}_{\text{MDCT}}(i)}}{N_{\text{sf}}},2\frac{\sum_{i = \frac{N_{\text{sf}}}{2}}^{N_{\text{sf}} - 1}{\text{Es}_{\text{MDCT}}(i)}}{N_{\text{sf}}} \right)$
(1894)

and $\text{lim}_{\text{zcr}}$= 10 for narrowband signals and 16
otherwise.

Even the previous sub-blocks are considered as non-pre-echo zone if
their energy is higher than $\text{Es}_{\text{MDCT}}(i\frac{)}{2}$*.*

The pre-echo attenuation of low energy sub-block determined as pre-echo
zone is made by multiplying the two sub-band signals, the lower band
$x_{\text{LB}}(n)$ and the higher band $x_{\text{HB}}(n)$ by attenuation
factors $g_{\text{pre}}(n)$ and $g_{\text{pre}_{\text{hb}}}(n)$
respectively, where $g_{\text{pre}}(n)$ and
$g_{\text{pre}_{\text{hb}}}(n)$ are determined as a function of the
temporal envelope of the concatenated signal
$\text{Es}_{\text{MDCT}}(i)$*,*$i = 0,\ldots,N_{\text{sf}}$.

For each sample of the pre-echo zone sub-blocks, these gains are set to
0.01 if $r_{\text{Es}}(i)$\> 32 and to 0.1 otherwise. For the other
sub-blocks, the initial gains are set to 1, they form the non-pre-echo
zone. Following this $\text{Maxind}2_{\text{Es}}$ is set as the index of
the first non-echo sub-block (where the initial gain is equal to 1).

A false alarm detection is made at this point. If the last pre-echo
attenuation gain in the previous frame is higher than 0.5 and in the
current frame only one sub-block has attenuation gain of 0.1 and the
other gains are 0, $\text{Maxind}2_{\text{Es}}$is set to 0.

The initial pre-echo attenuation gains depend also on the energy of the
previous frame: a minimal attenuation value for each pre-echo zone
sub-block and for both sub-bands are also fixed as a function of the
temporal envelope of the reconstructed signal of the previous frame.
This value is fixed in a way that the attenuated sub-block energy in the
sub-band cannot be lower than the pre-echo attenuation gain compensated
mean energy of the previous frame in that sub-band, to preserve
background noise energy. In the lower band:

$g_{\text{pre}'}(n) = \left\{ \begin{matrix}
\text{max}\left( 0\text{.}\text{01},\underset{i = 0,\ldots,\text{Maxind}2_{\text{Es}} - 1}{\text{min}}\left( \sqrt{\frac{\text{Es}_{\text{prev}}}{\text{Es}_{\text{MDCT}}(i)}},1 \right) \right) & \text{if}\ r_{\text{ES}}(i) > \text{32} \\
\text{max}\left( 0\text{.}1,\underset{i = 0,\ldots,\text{Maxind}2_{\text{Es}} - 1}{\text{min}}\left( \sqrt{\frac{\text{Es}_{\text{prev}}}{\text{Es}_{\text{MDCT}}(i)}},1 \right) \right) & \text{if}\ \text{16} < r_{\text{ES}}(i) \leq \text{32} \\
1 & \text{if}\ r_{\text{ES}}(i) \leq \text{16} \\
\end{matrix} \right.\ $ (1895)

for
$n = L_{\text{sf}}\text{.}i,\ldots,L_{\text{sf}}\text{.}\left( i + 1 \right) - 1$
and where $\text{Es}_{\text{prev}}$ was computed in the previous frame
as:

$\text{Es}_{\text{prev}} = \text{max}\left( \frac{\sum_{i = 0}^{N_{\text{sf}} - 1}{\text{Es}_{\text{MDCT}}(i)g_{\text{pre}'}(L_{\text{sf}}\text{.}i)^{2}}}{N_{\text{sf}}},2\frac{\sum_{i = \frac{N_{\text{sf}}}{2}}^{N_{\text{sf}} - 1}{\text{Es}_{\text{MDCT}}(i)g_{\text{pre}'}(L_{\text{sf}}\text{.}i)^{2}}}{N_{\text{sf}}},2\frac{\sum_{i = N_{\text{sf}} - 2}^{N_{\text{sf}} - 1}{\text{Es}_{\text{MDCT}}(i)}}{2} \right)$
(1896)

However $g_{\text{pre}'}(n)$ is set to 1 if
$\text{zcr}(i) < \frac{\text{lim}_{\text{zcr}}}{2}$ or
$\text{max}\text{nzcr}(i) > \frac{L}{\text{24}}$.

In a similar way the initial pre-echo attenuation gain for the higher
band signal is computed as:

$g_{\text{pre}_{\text{hb}}'}(n) = \left\{ \begin{matrix}
\text{max}\left( 0\text{.}\text{01},\underset{i = 0,\ldots,\text{Maxind}2_{\text{Es}} - 1}{\text{min}}\left( \sqrt{\frac{\text{Es}_{\text{prev}_{\text{hb}}}}{\text{Es}_{\text{MDCT}_{\text{hb}}}(i)}},1 \right) \right) & \text{if}\ r_{\text{ES}}(i) > \text{32} \\
\text{max}\left( 0\text{.}1,\underset{i = 0,\ldots,\text{Maxind}2_{\text{Es}} - 1}{\text{min}}\left( \sqrt{\frac{\text{Es}_{\text{prev}_{\text{hb}}}}{\text{Es}_{\text{MDCT}_{\text{hb}}}(i)}},1 \right) \right) & \text{if}\ \text{16} < r_{\text{ES}}(i) \leq \text{32} \\
1 & \text{if}\ r_{\text{ES}}(i) \leq \text{16} \\
\end{matrix} \right.\ $ (1897)

for
$n = L_{\text{sf}}\text{.}i,\ldots,L_{\text{sf}}\text{.}\left( i + 1 \right) - 1$
where

$\text{Es}_{\text{prev}_{\text{hb}}} = \text{max}\left( \frac{\sum_{i = 0}^{N_{\text{sf}} - 1}{\text{Es}_{\text{MDCT}_{\text{hb}}}(i)g_{\text{pre}_{\text{hb}}'}(L_{\text{sf}}\text{.}i)^{2}}}{N_{\text{sf}}},2\frac{\sum_{i = \frac{N_{\text{sf}}}{2}}^{N_{\text{sf}} - 1}{\text{Es}_{\text{MDCT}_{\text{hb}}}(i)g_{\text{pre}_{\text{hb}}'}(L_{\text{sf}}\text{.}i)^{2}}}{N_{\text{sf}}},2\frac{\sum_{i = N_{\text{sf}} - 2}^{N_{\text{sf}} - 1}{\text{Es}_{\text{MDCT}_{\text{hb}}}(i)}}{2} \right)$
(1898)

Note that the initial attenuation gain in both the lower band and the
higher band are identical for each samples of a sub-block.

Before applying the pre-echo attenuation gains the position of the onset
is refined. If the onset was detected in the current frame, each sub
frames from index $\text{Maxind}2_{\text{Es}}$ to $N_{\text{sf}} - 1$
are divided into $N_{\text{ssf}}$ sub-sub-blocks where
$N_{\text{ssf}}$=4 if the sampling frequency is 8 kHz and
$N_{\text{ssf}}$=8 otherwise. If $\text{Maxind}2_{\text{Es}}$= 0 only
the first sub-block is considered.

The energy of these sub-sub-blocks is computed:

$\text{Eshr}_{\text{MDCT}}(j) = \sum_{n = L_{\text{sf}}\text{.}\text{Maxind}2_{\text{Es}} + L_{\text{ssf}}\text{.}j}^{L_{\text{sf}}\text{.}\text{Maxind}2_{\text{Es}} + L_{\text{ssf}}\text{.}(j + 1) - 1}\left\lbrack x^{(r)}(n) \right\rbrack^{2}$,
$j = 0,\ldots,\text{Num}_{\text{ssf}} - 1$ (1899)

where

$L_{\text{ssf}} = \frac{L_{\text{sf}}}{N_{\text{ssf}}}$ (1900)

and

$\text{Num}_{\text{ssf}} = \left\{ \begin{matrix}
N_{\text{ssf}} & \text{if}\ \text{Maxind}2_{\text{Es}}\text{=0} \\
\left( N_{\text{sf}} - \text{Maxind}2_{\text{Es}} \right)N_{\text{ssf}} & \text{otherwise} \\
\end{matrix} \right.\ $ (1901)

When the onset was detected in the future memory part
$x_{\text{premem}}(n)$, only the first $L_{\text{sf}}$samples are
examined and $\text{Num}_{\text{ssf}} = N_{\text{ssf}}$ and

$\text{Eshr}_{\text{MDCT}}(j) = \sum_{n = L_{\text{ssf}}\text{.}j}^{L_{\text{ssf}}\text{.}(j + 1) - 1}\left\lbrack x_{\text{premem}}(n) \right\rbrack^{2}$,
$j = 0,\ldots,\text{Num}_{\text{ssf}} - 1$ (1902)

The maximum of these values is searched:

$\text{Eshr}_{\text{max}} = \underset{j = 0,\ldots,\text{Num}_{\text{ssf}}}{\text{max}}\left( \text{Eshr}_{\text{MDCT}}(j) \right)$,
$j = 0,\ldots,\text{Num}_{\text{ssf}} - 1$ (1903)

The values $\text{Eshr}_{\text{MDCT}}(j)$ are compared to adaptive
thresholds. The first one is independent of the sub-sub-block index:

$\text{Thres}_{\text{MDCT}1} = \frac{\text{Eshr}_{\text{max}}}{8}$
(1904)

The second one is computed as:

$\text{Thres}_{\text{MDCT}2}(j) = \left\{ \begin{matrix}
\text{max}(\text{Eshr}_{\text{MDCT}}(0),\text{Es}_{\text{prev}_{\text{nc}}}) & \text{if}\ \text{Maxind}2_{\text{Es}} = 0\ \text{and}\ j = 0 \\
\text{max}\left( \frac{\text{Es}_{\text{prev}_{\text{nc}}} + 4\sum_{k = 0}^{j - 1}{\text{Eshr}_{\text{MDCT}}(k)}}{j + 1},\text{Es}_{\text{prev}_{\text{nc}}} \right) & \text{if}\ \text{Maxind}2_{\text{Es}} = 0\ \text{and}\ j > 0 \\
\text{max}(\text{Eshr}_{\text{MDCT}}(0),\text{mcrit}) & \text{if}\ \text{Maxind}2_{\text{Es}} > 0\ \text{and}\ j = 0 \\
\text{max}\left( \frac{\text{Eshr}_{\text{MDCT}}(\text{Maxind}2_{\text{Es}} - 1) + 4\sum_{k = 0}^{j - 1}{\text{Eshr}_{\text{MDCT}}(k)}}{j + 1},\text{Es}_{\text{prev}_{\text{nc}}} \right) & \text{if}\ \text{Maxind}2_{\text{Es}} > 0\ \text{and}\ j > 0 \\
\end{matrix} \right.\ $ (1905)

where

$\text{mcrit} = \text{Es}_{\text{MDCT}}(\text{Maxind}2_{\text{Es}} - 1)\text{.}g_{\text{pre}'}\left( (\text{Maxind}2_{\text{Es}} - 1)L_{\text{sf}} \right)$
(1906)

If $\frac{\text{Max}_{\text{Es}}}{\text{80}} > \text{mcrit}$ and
$\text{zcr}(\text{Maxind}2_{\text{Es}}) > \text{lim}_{\text{zcr}}$ this
value is modified as:

$\text{mcrit} = \frac{\text{Max}_{\text{Es}}}{\text{80}}$ (1907)

Initially the starting position of the onset for both the lower and the
higher band is the beginning of the sub-block
$\text{Maxind}2_{\text{Es}}$. This position is delayed by
$L_{\text{ssf}}$samples by sub-sub-blocks as long as
$\text{Eshr}_{\text{MDCT}}(j) < \text{min}(\text{Thres}_{\text{MDCT}1},\text{Thres}_{\text{MDCT}2}(j))$*.*
The pre-echo attenuation gain of these samples moved from the
non-pre-echo zone to the pre-echo-zone is set equal to the gain of last
sample of the original pre-echo zone
$g_{\text{pre}'}\left( (\text{Maxind}2_{\text{Es}} - 1)L_{\text{sf}} \right)$
and
$g_{\text{pre}_{\text{hb}}'}\left( (\text{Maxind}2_{\text{Es}} - 1)L_{\text{sf}} \right)$
respectively in the 2 sub-bands. In the following these new samples in
the pre-echo zone are considered as the part of the last pre-echo zone
sub-block (index $\text{Maxind}2_{\text{Es}} - 1$), the length of this
sub-block $\text{Maxind}2_{\text{Es}} - 1$ can be longer than
$L_{\text{sf}}$.

To avoid false pre-echo detection, the energies of the last 2 or 3
sub-blocks preceding the onset is verified for both the full-band and
the high-band signals: the regression coefficient for these sub-blocks
energies is computed by the least squares estimation technique and
compared to thresholds. If at least one regression coefficient is lower
to its threshold the pre-echo attenuation is inhibited. In fact it is
checked whether the sub-blocks preceding the onset have stable or
increasing energy, this is always true for pre-echos. For easy
comparison to threshold the regression coefficients are normalised by
the sub-band energies when the threshold is different to 0. If the
threshold is 0, only the sign of the regression coefficient is checked,
no normalisation is needed.

When the onset is detected in the first or second sub-block this
verification is not possible.

When the onset is detected in the third sub-block only the high-band
regression coefficient is computed and compared to the threshold . As
only the sign is checked here no normalization is needed for the
regression coefficient:

If \< the pre-echo attenuation in the pre-echo zone is inhibited.

When the onset is detected in the fourth or later sub-block both the
full-band regression coefficient and the normalized high-band regression
coefficient are computed on the last 3 sub-blocks preceding the onset
and they are compared to the thresholds and respectively. Let's note the
index of the sub-block where the onset is detected .

In the full-band only the sign is checked, no normalization of the
regression coefficient is needed:

In the higher band the normalized regression coefficient is estimated
as:

The comparison is equivalent to :

If the \< or \< the pre-echo attenuation in the pre-echo zone is
inhibited.

The pre-echo attenuation functions $g_{\text{pre}'}(n)$ and
$g_{\text{pre}_{\text{hb}}'}(n)$ are stair-like, the gain is constant
within a sub-block. To avoid annoying noise due to this discontinuity,
the final pre-echo attenuation gain for the lower band
$g_{\text{pre}}(n)$ is obtained by linear smoothing of the initial
pre-echo attenuation gain $g_{\text{pre}'}(n)$ introducing
$\text{smoothlen}$intermediate levels between the gains of consecutive
sub-blocks. For narrow band signals $\text{smoothlen}$= 20, for other
bandwidths $\text{smoothlen}$= 4. This smoothing is done before the
detected onset position and at the beginning of each sub-block. For the
first sub-block the smoothing is done between the memorized last gain
value of the previous frame and the gain of the first sub-block of the
current frame. If the onset position is detected in the next frame no
smoothing is done at the end of the frame, this will be done at the
beginning of the next frame. For example at the beginning sub-block
$i$*,* $i = 1,\ldots,N_{\text{sf}} - 1$ and if the gains determined for
the sub-blocks $i - 1$ and $i$ are $g_{1}$ and $g_{2}$ respectively, for
wide band signals ($\text{smoothlen}$= 4) the gains are smoothed in the
following way:

Before smoothing:

  ------- ----- -- -- -- -- -- -- -- -- -----
  index   ...                           ...
  gain    ...                           ...
  ------- ----- -- -- -- -- -- -- -- -- -----

After smoothing:

  ------- ----- -- -- -- -- -- -- -- -- -----
  index   ...                           ...
  gain    ...                           ...
  ------- ----- -- -- -- -- -- -- -- -- -----

In the higher band no smoothing is necessary,
$g_{\text{pre}_{\text{hb}}}(n) = g_{\text{pre}_{\text{hb}}'}(n)$.

In both sub-band, the pre-echo is attenuated in the pre-echo-zone by
applying these gains to the sub-signals:

$x_{\text{LB}_{\text{pre}}}(n) = g_{\text{pre}}(n)x_{\text{LB}}(n)$
(1908)

$x_{\text{HB}_{\text{pre}}}(n) = g_{\text{pre}_{\text{hb}}}(n)x_{\text{HB}}(n)$
(1909)

The final pre-echo attenuated synthesized signal
$x_{\text{pre}^{(r)}}(n)$ is obtained by combining the two attenuated
sub-signals:

$x_{\text{pre}^{(r)}}(n) = x_{\text{LB}_{\text{pre}}}(n) + x_{\text{HB}_{\text{pre}}}(n)$
(1910)

#### 6.2.4.2 Transient location dependent overlap and transform length

The configuration for the overlap and transform lengths is depends on
the overlap code for the current frame and on the overlap code for the
previous frame as described in subclause 5.3.2.3, where the overlap code
is obtained as described in subclause 6.2.2.2.1.

#### 6.2.4.3 Short block transformation

##### 6.2.4.3.1 Short window transform in TDA domain

This processing is done when the Transient mode is selected*,* the
spectrum is first de-interleaved into four spectra
${\hat{X}}_{M}^{\left\lbrack m \right\rbrack}\left( k \right)$ with
m = 0,\...,3. This operation is the inverse of the interleaving
performed in the encoder, see subclause 5.3.2.4.1.3.

The four spectra corresponding to short 5-ms transforms are first
transformed to the time-aliased domain using the short inverse DCT~IV~
transforms. The obtained signals are denoted
${\hat{x}}_{\text{TDA}}^{\left\lbrack m \right\rbrack}(n)$$m = 0,\ldots,3$
and are each of a length$\frac{L}{4}$.

The obtained time-domain aliased signals are further expanded into the
time domain by using the inverse time-domain aliasing operation. This
operation can be seen as a pseudo-inverse of the matrix used in equation
(8) (with $L$replaced by$\frac{L}{4}$).

Formally, this is performed according to:

${\hat{x}}_{\text{ITDA}}^{\left\lbrack m \right\rbrack} = \begin{bmatrix}
0 & I_{\frac{L}{8}} \\
0 & - J_{\frac{L}{8}} \\
 - J_{\frac{L}{8}} & 0 \\
 - I_{\frac{L}{8}} & 0 \\
\end{bmatrix}{\hat{x}}_{\text{TDA}}^{\left\lbrack m \right\rbrack}$
(1911)

The length of the resulting signal for each sub-frame index $m$ is equal
to double the length of the input spectrum, i.e., $\frac{L}{2}$.

![](media/image54.wmf){width="6.606944444444444in"
height="2.7243055555555555in"}

Figure 116: Algorithm for inverse transform in the case of transient
mode.

The resulting time domain aliased signals for each sub-frame are
windowed using the same configuration of windows as those in the
encoder. The resulting windowed signals are overlap‑added. Note that the
window for the first m = 0 and last m = 3 sub-frame is zero. This is due
to the zero padding that is used in the encoder. These two frame edges
do need to be computed and are effectively dropped. The resulting signal
of the overlap-add operations of all sub-frames is reordered using the
inverse operation performed in the encoder, which leads to the signal
${\hat{x}}_{\text{TDA}}(n)$, $n = 0,\ldots,L - 1$. An overview of these
operations is shown in figure 117. Then windowing and overlap-add are
performed on ${\hat{x}}_{\text{TDA}}(n)$the same as for the long window
transform in subclause 5.3.2.2.

##### 6.2.4.3.2 Short window transform for MDCT based TCX

After choosing the transform and overlap length configuration for
transient frame as described in subclause 6.2.4.2 each sub-frame (TCX5
or TCX10) is windowed and transformed using the inverse MDCT, which is
implemeted using IDCT~IV~ and inverse TDA.

#### 6.2.4.4 Special window transitions

The overlap mode FULL is used for transitions between long ALDO windows
and short symmetric windows (HALF, MINIMAL) for short block
configurations (TCX10, TCX5) described in subclause 6.2.4.2. The
transition window is derived from the ALDO and sine window overlaps.

##### 6.2.4.4.1 ALDO to short transition

The left part of the transition window uses the left slope of the ALDO
synthesis window (short slope), which has a length of 8.75ms (see figure
118).

For the right part of the transition window HALF or MINIMAL overlap is
used.

![](media/image55.jpeg){width="5.509027777777778in"
height="2.0305555555555554in"}

Figure 119: ALDO to short transition

##### 6.2.4.4.2 Short to ALDO transition

HALF or MINIMAL overlap is used for the left part of the transition
window.

The right overlap of the transition window has a length of 8.75ms (FULL
overlap) and is derived from the ALDO window. The right slope of the
ALDO synthesis window (long slope) is first shortened to 8.75ms by
removing the last 5.625ms. Then the last 1.25ms of the remaining slope
are multiplied with the 1.25ms MINIMAL overlap slope to smooth the edge.
The resulting 8.75ms slope is depicted in figure120 .

![](media/image56.jpeg){width="5.509027777777778in"
height="2.0305555555555554in"}

Figure 121: Short to ALDO transition

#### 6.2.4.5 Low Rate MDCT Synthesis

In addition to the full MDCT synthesis of length
$L_{\text{TCX}}^{\left( \text{full} \right)}$, which gives an output
signal at the configured output sampling rate $\text{sr}_{\text{out}}$,
a further MDCT synthesis of the lower part of the spectrum is performed
to obtain an output signal at the CELP sampling rate
$\text{sr}_{\text{celp}}$. The low rate output is required for switching
from TCX to ACELP. An MDCT synthesis of length
$L_{\text{TCX}}^{\left( \text{celp} \right)}$ is performed on the lowest
$L_{\text{TCX}}^{\left( \text{celp} \right)}$ MDCT coefficients. In case
the output sampling rate is set lower than the CELP sampling rate (so
that
$L_{\text{TCX}}^{\left( \text{celp} \right)} < L_{\text{TCX}}^{\left( \text{full} \right)}$),
the spectrum is padded with zeroes to the required length
$L_{\text{TCX}}^{\left( \text{celp} \right)}$. The low rate synthesis
transform is performed as defined above with the only difference being
the transform length.

6.3 Switching coding modes in decoding
--------------------------------------

### 6.3.1 General description

This clause describes all transitions between coding modes including
changes for sample rates, bit rates and audio bandwidths for the
decoding process. The transitions between CELP coding mode and MDCT
coding mode within the same bit rate and audio bandwidth are described
in 6.3.2 and 6.3.3.

The handling of sample rate changes within the CELP or LP-based coding
mode and MDCT-based TCX mode is described in 6.3.4.

The switching between primary and AMR-WB IO modes is described in 6.3.5.

The handling of transitions in the context of bit rate switching is
described in 6.3.6.

Finally, the transition between NB, WB, SWB and FB are described in
6.3.7.

### 6.3.2 MDCT coding mode to CELP coding mode

When a CELP encoded frame is preceded by a MDCT based encoded frame, the
memories of the CELP encoded frame have to be updated before starting
the decoding of the CELP frame, similarly to the encoder case (see
clause 5.4.2).

Additionally, cross-fading is applied in the time-domain at the output
sampling rate $\text{sr}_{\text{out}}$ to avoid any discontinuities
between the MDCT based output and the CELP based output including
bandwidth extension.

The CELP memories update and the cross-fading are performed depending on
the bitrate and the previous encoding mode. In general three different
MDCT to CELP (MC1 to MC3) transitions are supported. The table in clause
5.4.2 describes which transition mode is used for a specific
configuration. The different decoding cases are described in detail in
the following sub-clauses.

#### 6.3.2.1 MDCT to CELP transition 1 (MC1)

MC1 is used when the previous frame was decoded with HQ MDCT and the
current frame is decoded with CELP. The CELP state variables are reset
in the current frame to predetermined (fixed) values. In particular the
following memories are reset to 0 in the CELP decoder:

-   Resampling memories of the CELP synthesis

-   Pre-emphasis and de-emphasis memories

-   LPC synthesis memories

-   Past excitation (adaptive codebook memory)

-   Bass post-filter memories

The old LPC coefficients and associated representations (LSP, LSF) and
CELP gain quantization memories are reset to predetermined (fixed)
values. The CELP decoder in the current frame is forced to operate in
Transition coding (TC), i.e. without using an adaptive codebook from the
previous frame. Since the LPC coefficients from the previous frame are
not available, only one set of LPC coefficients corresponding to the end
of frame are decoded and using for all subframes in the current frame.

To avoid discontinuities at the output sampling rate between the decoded
HQ MDCT signal in the previous frame and the decoded CELP signal
(including time-domain BWE) in the current frame, cross-fading (i.e.
overlap-add) is used.

The decoded HQ MDCT signal could be windowed to compensate for the MDCT
synthesis window, however in practice this compensation is not done.
Note that the synthesis of the CELP decoder is more delayed than the
synthesis of the MDCT decoder as shown in Figure 112a; the time
difference is denoted here *D*. In the current CELP frame, the first
samples are replaced by the HQ MDCT synthesis from the previous frame (D
samples). The unweighted HQ MDCT aliased memory is overlap-added with
the CELP output.

![](media/image57.wmf){width="4.683333333333334in"
height="1.8722222222222222in"}

Figure 122a: Overlap-add in MDCT to CELP transition.

#### 6.3.2.2 MDCT to CELP transition 2 (MC2)

As described in clause 6.2.4.5, the MDCT based TCX decoder generates two
time-domain signals, one at the output sampling rate
$\text{sr}_{\text{out}}$ and one at the CELP sampling rate
$\text{sr}_{\text{celp}}$. The signal at the CELP sampling rate is used
to update the CELP memories, similarly to the encoder case (see clause
5.4.2.2). It is also used at the decoder side to update the memories of
the CLDFB based resampler that is used to resample the decoded CELP
signal. The signal at the output sampling rate is the signal that is
actually sent to the decoder output. To avoid discontinuities between
this MDCT based TCX signal and the decoded CELP signal at the output
sampling rate, cross-fading is used.

The decoded CELP signal at the output sampling rate is obtained after
CELP decoding at the CELP sampling rate, CLDFB based resampling and
time-domain bandwidth extension decoding (see clause 6.1). Both the
CLDFB based resampling and the time-domain bandwidth extension decoding
introduce a delay. Consequently, the decoded CELP frame is delayed
compared to the MDCT based TCX frame and an overlap between the two
frames is then introduced. This overlap is used to perform a cross-fade
and thus to avoid any discontinuities between the two frames. The output
signal is given by

$s_{\text{out}}\left( n \right) = \begin{matrix}
\left\{ s_{\text{mdct}}\left( n \right),\ n = 0,\text{.}\text{.}\text{.},d_{\text{LTP}} - 1 \middle| \right.\ \left\{ \frac{\Delta - n}{\Delta - d_{\text{LTP}}}s_{\text{mdct}}\left( n \right) + \frac{n - d_{\text{LTP}}}{\Delta - d_{\text{LTP}}}s_{\text{celp}}\left( n \right) \middle| \right.\  \\
\end{matrix}$ (1927)

with $s_{\text{out}}\left( n \right)$ is the output signal,
$s_{\text{mdct}}\left( n \right)$ is the MDCT based TCX signal,
$s_{\text{celp}}\left( n \right)$ is the CELP signal, $d_{\text{LTP}}$
is the delay of the TCX LTP postfilter (0.25ms), $\Delta$ is the delay
introduced by the CLDFB resampler and the time-domain BWE (1.25ms if
$\text{sr}_{\text{out}} = 8\text{kHz}$ and 2.3125ms otherwise), and
$N_{\text{out}}$ is the frame length at the output sampling rate (20ms).

#### 6.3.2.3 MDCT to CELP transition 3 (MC3)

Similarly to MC1, the CELP memories are either reset or extrapolated
similarly as in the encoder (see clause 5.4.2.3).

To avoid discontinuities between the decoded MDCT based TCX signal and
the decoded CELP signal (including time-domain BWE) at the output
sampling rate, cross-fading is used. The same approach as used in clause
6.3.2.1 is used.

### 6.3.3 CELP coding mode to MDCT coding mode

When a MDCT encoded frame is preceded by a CELP encoded frame, a
beginning portion of the MDCT encoded frame cannot be reconstructed
properly due to the aliasing introduced by the missing previous MDCT
encoded frame. As already described in clause 5.4.3, two approaches are
used to solve this problem, depending on the MDCT based coding mode
(either MDCT based TCX or HQ MDCT). The decoder part of these two
approaches is described in detail in the following sub-clauses.

#### 6.3.3.1 CELP coding mode to MDCT based TCX coding mode

If MDCT based TCX is used in the current frame and if the previous frame
was encoded with CELP, the MDCT based TCX frame length is increased and
the left part of the MDCT window is modified, as already described in
clause 5.4.3.1.

At the decoder side, the MDCT coefficients are decoded as described in
clause 6.2.2. The decoded MDCT coefficients are then transformed back to
the time-domain as described in clause 6.2.4. Two inverse transforms are
performed and two time-domain signals are generated, as described in
clause 6.2.4.5. One signal is generated at the CELP sampling rate and
follows the previous decoded CELP signal at the CELP sampling rate. The
other signal is generated at the output sampling rate and follows the
previous decoded CELP signal at the output sampling rate (after CLDFB
resampling and time-domain BWE). The decoding of the CELP signal
(including the time-domain BWE) was described in clause 6.1.

To avoid any discontinuities that could be introduced in the decoded
time-domain signal at the border between the two frames, a smoothing
mechanism is applied. This algorithm is described in detail in the
following.\
Let's first assume the following notations. The frame length at the CELP
sampling rate is noted$N_{\text{celp}}$. The decoded CELP signal at the
CELP sampling rate is noted $s_{\text{celp}}\left( n \right)$ with
$n = - N_{\text{celp}},\text{.}\text{.}\text{.}, - 1$. The decoded MDCT
signal (including the windowed portion overlapping with the previous
CELP frame) is noted $s_{\text{mdct}}\left( n \right)$ with
$n = - N_{T},\text{.}\text{.}\text{.},N_{\text{celp}} - 1$ ,
$N_{T} = 0\text{.}\text{00125}\text{sr}_{\text{celp}}$ is the length of
the segment where both the MDCT signal and the CELP signal overlap (it
is also equal to the length of the sine window used in the left part of
the transition window as described in clause 5.4.3.1), and
$\text{sr}_{\text{celp}}$ is the CELP sampling rate. The LPC synthesis
filter used in last subframe of the previous CELP frame is noted
$1/A_{\text{celp}}\left( z \right)$with
$A_{\text{celp}}\left( z \right) = \sum_{}^{}{a_{\text{celp}}^{m}z^{- m}}$
and $M = \text{16}$is the LPC filter.\
A modified CELP signal is first computed by performing an overlap-add
operation with the decoded MDCT signal on the overlap region and by
artificially compensating the aliasing introduced by the decoded MDCT
signal using the decoded CELP signal. The modified CELP signal can be
defined as follow

$\begin{matrix}
{\hat{s}}_{\text{celp}}\left( n \right) = \\
\begin{matrix}
\left\{ s_{\text{celp}}\left( n \right),\ n = - N_{\text{celp}},\text{.}\text{.}\text{.}, - N_{T} - 1 \middle| \right.\  \\
\end{matrix} \\
 \\
\end{matrix}$ (1928)

with $w_{T}\left( n \right)$ is the sine window used in the left-part of
the transition window as described in clause 5.4.3.1. Contrary to the
non-modified CELP signal case, discontinuities are significantly reduced
(or even completely supressed in most cases) in the modified CELP signal
preceding the MDCT signal, due to the overlap-add operation. However,
the modified CELP signal cannot be used directly to generate the decoder
output signal of the current frame, because it would introduce an
additional decoder delay equal to the overlap length. Instead, the
modified CELP signal is used only to generate a zero-input-response
(ZIR) of the LPC synthesis filter. This ZIR is then used to modify the
decoded MDCT signal, reducing significantly (or even removing in most
cases) the possible discontinuity, and without introducing any
additional decoder delay. The ZIR $s_{\text{zir}}\left( n \right)$of the
LPC synthesis filter $1/A_{\text{celp}}\left( z \right)$ is generated by
first computing the memory of the LPC synthesis filter as follow

$s_{\text{zir}}\left( n \right) = S_{\text{celp}}\left( n \right) - {\hat{S}}_{\text{celp}}\left( n \right),\ n = - M,\text{.}\text{.}\text{.}, - 1$
(1929)

and then computing the zero-input-response as follow

$s_{\text{zir}}\left( n \right) = - \sum_{m = 1}^{M}a_{m}s_{\text{zir}}\left( n - m \right),\ n = 0,\text{.}\text{.}\text{.},N_{\text{zir}} - 1$
(1930)

with $N_{\text{zir}} = \text{64}$ is the number of generated ZIR
samples. The ZIR is then windowed such that its amplitude always
decreases to 0, producing the windowed ZIR

${\hat{s}}_{\text{zir}}\left( n \right) = s_{\text{zir}}\left( n \right)\frac{N_{\text{zir}} - n}{N_{\text{zir}}},\ n = 0,\text{.}\text{.}\text{.},N_{\text{zir}} - 1$
(1931)

Finally, the windowed ZIR is added to the beginning portion of the
decoded MDCT signal, corresponding to the time samples
$n = 0,\text{.}\text{.}\text{.},N_{\text{zir}} - 1$.

The same smoothing mechanism is applied to the decoded signals at the
output sampling rate, with the exception that the ZIR is not re-computed
but obtained by resampling the ZIR computed at the CELP sampling rate.
The resampling is performed using linear interpolation as described in
clause 5.4.4.4. The resampled ZIR is then added to the decoded MDCT
signal at the output sampling rate.

The smoothing mechanism described above ensures a smooth transition
between the CELP and MDCT signals at the output sampling rate, but only
in the CELP bandwidth part. Due to the delay introduced by the
time-domain BWE, a gap is introduced in the high frequency region as
explained in clause 6.1.5.1.13.1. To fill this gap, a transition signal
is generated as described in clause 6.1.5.1.13.1. This transition signal
is long enough to cover not only the gap but also an additional signal
portion following the gap. This additional signal portion is then used
to perform a cross-fading with the decoded MDCT signal, ensuring smooth
transition at the output sampling rate.

#### 6.3.3.2 CELP coding mode to HQ MDCT coding mode

When the previous frame is CELP and the current frame is to be coded by
HQ MDCT, the current frame is a transition frame in which two types of
decoding are used:

-   Constrained CELP coding and (when required) simplified time-domain
    BWE coding

-   HQ MDCT coding with a modified window

Constrained CELP decoding means here that CELP is restricted to decode
only a subset of CELP parameters, to reuse parameters (LPC coefficients)
from the previous CELP frame, and to cover only the first subframe of
the current frame. These constraints are set to minimize the bit budget
taken by continuing CELP decoding in the current frame, this bit budget
being taken out of HQ MDCT decoding.

As shown in Figure 112b, the transition frame includes at the decoder
side a gap between the previous output frame (decoded by CELP) and the
decoded signal with only the contribution from HQ MDCT. The length of
this gap at the decoder is 4.375 ms, which corresponds to 10-5.625 ms
(10 ms for ¼ of MDCT window support -- 5.625 ms which is the length of
the zero segment at the beginning of the ALDO synthesis window). In
addition, an overlap period of 1,825 ms is used to attenuate
discontinuities between CELP and HQ MDCT decoded signal. The total
transition region between CELP and HQ MDCT in the decoder (grey zone
decoder in Figure 112b) is 4.375+1.825 = 6.25 ms..

![](media/image58.wmf){width="5.616666666666666in"
height="3.3868055555555556in"}

Figure 112b: Modified MDCT synthesis window in the transition frame
(CELP to HQ MDCT).

##### 6.3.3.2.1 Constrained CELP decoding and simplified BWE decoding

The bit budget for CELP and BWE in the current (transition) frame is
determined depending on the CELP coder used in the previous frame (12.8
kHz or 16 kHz) and decoded audio bandwidth in the current frame, as
described in the pseudo-code in clause 5.4.3.2.1. Note that the current
frame being a transition frame, one bit is used to indicate the type of
CELP coding (12.8 kHz or 16 kHz); this bit is allows decoding the
transition frame even when the information about the previous CELP
coding type was lost due to frame erasures..

LPC coefficients from the end of the previous frame are reused,
constrained CELP decoding only relies on decoding an extra subframe with
the same CELP core decoder (12.8 kHz or 16 kHz) as in the previous
frame; subframe decoding similar to clause 6.1 is applied (without LSF
decoding). The length of the decoded subframe is 5 ms if CELP is at 12.8
kHz and 4 ms if CELP is at 16 kHz. The decoded CELP synthesis is
normally delayed by 1.25 ms at the decoder due to the FIR
resampling/delay operation. However, to have enough samples to cover the
transition region of 6.25 ms, the resampling memory is resampled with
0-delay using the optimized cubic interpolation described in clause
6.3.3.2.1.1.

Note that the cubic interpolation requires to have two future samples,
which are estimated by simply repeating the last value of the FIR
memory.

Hence, if CELP is at 12.8 kHz,, the CELP synthesis (after FIR resampling
and 0-delay resampling) is 6.25 ms long; if CELP is at 16 kHz, the
subframe is 1 ms shorter and the CELP synthesis is extended by ringing
to get a decoded signal of 6.25 ms; the ringing is used only in the
overlap region and its influence is perceptually minimal.

When the coded audio bandwidth is higher than the bandwidth of the core
CELP coder, BWE decoding is applied. The previous frame is high-pass FIR
filtered to obtain the high-band, and the decoded pitch lag and gain are
decoded to repeat 6.25 ms of high-band signal which is added to the 6.25
ms of decoded CELP signal.

###### 6.3.3.2.1.1 Optimized cubic interpolation

The missing signal at the output sampling frequency is partly available
in the memory buffer at the internal sampling frequency, 12.8 kHz or 16
kHz. By doing low delay resampling like interpolation method of this
memory a good estimation of the missing signal can be obtained. Third
order cubic interpolation is used here, where cubic curves are used to
interpolate the output values within 3 input interval delimited by 4
input samples. Respectively, in each input interval the interpolation
can be made by using 3 different cubic curves. To further improve the
quality of this estimation the interpolated samples are obtained by
computing a weighted mean value of the possible cubic interpolated
values computed on the plurality intervals covering the time position of
the sample to interpolate.

The length of the resampling buffer (input to cubic interpolation) is
1.25 ms (16 samples at 12.8 kHz sampling rate or 20 samples at 16 kHz
sampling rate) plus 2 past samples used as memory for the first cubic
interpolations of the first 2 intervals. In cubic interpolation, 4
consecutive input samples determinate a cubic curve, the general
equation of this curve is . To simplify the computations of the
coefficients the temporal index of the 4 consecutive input samples are
always considered as $x = - 1$, $x = 0$, $x = 1$and $x = 2$and so they
define 3 intervals, \[-1, 0\], \[0, 1\] et \[1, 2\]. Noting the values
of these 4 input samples$v_{\text{in}}( - 1)$, $v_{\text{in}}(0)$,
$v_{\text{in}}(1)$and$v_{\text{in}}(2)$, the coefficients $a_{3}$,
$b_{3}$, $c_{3}$ and $d_{3}$ can be computed as:

$b_{3} = \frac{v_{\text{in}}( - 1) + v_{\text{in}}(1)}{2} - v_{\text{in}}(0)$
(1932a)

$a_{3} = \frac{v_{\text{in}}( - 1) + v_{\text{in}}(2) - v_{\text{in}}(0) - v_{\text{in}}(1) - 4b_{3}}{6}$
(1933b)

$c_{3} = v_{\text{in}}(1) - v_{\text{in}}(0) - a_{3} - b_{3}$ (1934c)

$d_{3} = v_{\text{in}}(0)$ (1935d)

To get the output resampled signal often the value of the output is
needed to be determined between two input samples, in the interval
limited by these input samples. As mentioned above, in cubic
interpolation one cubic curve covers 3 intervals and respectively each
interval can be covered by 3 different cubic curves: by the interval
central \[0, 1\] of the central cubic curve or by the interval \[1,2\]
of the previous cubic curve or the interval \[-1, 0\] of the next cubic
curve. In the following the index $x = 0$corresponds to the beginning of
the input interval where the output interpolated sample is computed.
Let's note the coefficients of the cubic curve of which the central
interval is used $a_{n}$, $b_{n}$, $c_{n}$, $d_{n}$, the coefficients of
the previous cubic curve $a_{n - 1}$, $b_{n - 1}$, $c_{n - 1}$,
$d_{n - 1}$ and the coefficients of the next cubic curve $a_{n + 1}$,
$b_{n + 1}$, $c_{n + 1}$, $d_{n + 1}$. This gives 3 possible values for
a given time instant $x$, $0 \leq x \leq 1$

$\text{vc}_{n - 1}(x) = a_{n - 1}(x + 1)^{3} + b_{n - 1}(x + 1)^{2} + c_{n - 1}(x + 1) + d_{n - 1}$
(1931e)

$\text{vc}_{n}(x) = a_{n}x^{3} + b_{n}x^{2} + c_{n}x + d_{n}$ (1931f)

$\text{vc}_{n + 1}(x) = a_{n + 1}(x - 1)^{3} + b_{n + 1}(x - 1)^{2} + c_{n + 1}(x - 1) + d_{n + 1}$
(1931g)

The interpolated output value $v_{\text{out}}(x)$ for a given instant
$0 \leq x \leq 1$ is computed as the weighted mean value of these 3
possible interpolated values:

$v_{\text{out}}(x) = w_{n - 1}\text{vc}_{n - 1}(x) + w_{n}\text{vc}_{n}(x) + w_{n + 1}\text{vc}_{n + 1}(x)$
(1936h)

The weights used are same for each interpolated value,
$w_{n - 1}$=$w_{n}$=$w_{n + 1}$=1/3. To reduce the complexity the values
of x/3, x^2^/3, x^3^/3, (x-1)/3, (x-1)^2^/3, (x-1)^3^/3, (x+1) /3,
(x+1)^2^/3, and (x+1)^3^/3, are tabulated for all possible values of $x$
needed for the interpolations. So the weighting by 1/3 is integrated in
these tables, only the coefficients $d_{n - 1}$, $d_{n}$ and
$d_{n + 1}$are needed with a multiplication by 1/3 when the output value
is computed. For example to upsample from 12.8 kHz to 32 kHz the
required values of $x$ are 0.2, 0.4, 0.6 and 0.8.

The last 2intervals cannot be covered by 3 cubic curves as future
samples are not available to compute all curves. Here simplified
interpolation is used. For the last but one input interval the central
interval of the last possible cubic curve is used to compute the
interpolated signal:

$v_{\text{out}}(x) = a_{n}x^{3} + b_{n}x^{2} + c_{n}x + d_{n}$ (1937i)

and for the last input interval the interval \[1,2\] of the same last
cubic curve is used to compute the interpolated signal

$v_{\text{out}}(x) = a_{n - 1}(x + 1)^{3} + b_{n - 1}(x + 1)^{2} + c_{n - 1}(x + 1) + d_{n - 1}$
(1938j)

In case of subsampling, the output samples after the last input sample
cannot be interpolated, that causes a small delay of up to 3 output
samples.

##### 6.3.3.2.2 HQ MDCT decoding with a modified synthesis window

HQ MDCT decoding in the transition frame is identical to clause 6.2.3,
except the MDCT synthesis window is modified and the bit budget in the
current frame is decreased as described in clause 6.3.3.2.1.

The modified MDCT window is designed to avoid aliasing in the first part
of the frame. Its shape also allows cross-fading between the synthesis
from constrained CELP and simplified BWE and the synthesis from HQ MDCT.

##### 6.3.3.2.3 Cross-fading

As shown in Figure 112b, the CELP and HQ MDCT decoded signals are
overlapping; the length of this overlapping region is 1,825 ms. The HQ
MDCT synthesis is already windowed by the modified MDCT window at the
decoder. The CELP decoded signal is windowed by the complementary window
and added to the HQ MDCT output in the overlap region.

### 6.3.4 Internal sampling rate switching

When changing the internal sampling rate in CELP or MDCT-based TCX, a
number of memory and buffer updates needs to be done. These are
described in subsequent sub-clauses.

#### 6.3.4.1 Reset of LPC memory

Same as subclause 5.4.4.1.

#### 6.3.4.2 Conversion of LP filter between 12.8 and 16 kHz internal sampling rates

Same as subclause 5.4.4.2.

#### 6.3.4.3 Extrapolation of LP filter

Same as subclause 5.4.4.3.

#### 6.3.4.4 Update of CELP synthesis memories

Same as subclause 5.4.4.7.

#### 6.3.4.5 Update of CELP decoded past signal

When switching from CELP coding mode to MDCT-base TCX coding mode, the
CELP decoded past signal$s_{\text{celp}}\left( n \right)$ with
$n = - N_{\text{celp}},\text{.}\text{.}\text{.}, - 1$ is needed as
described in subclause 6.3.3.1. The past signal is resampled with the
method described in subclause 5.4.4.4 in case of internal sampling rate
switching before proceeding as described in subclause 6.3.3.1.

#### 6.3.4.6 Post-processing

In case of sampling rate switching, the post-processing module described
in clause 6.1.4 has a specific behavior during the transition.

#### 6.3.4.6.1 Adaptive post-filtering

The memories of the adaptive post-filtering are resampled with the
linear interpolation described in subclause 5.4.4.4 in case of sampling
rate switching and in case post-filtering was applied in the previous
frame.

If the post-filtering was not employed in the previous frame, the
adaptive post-filter is not employed in the first frame after the
transition. In such a case, only the memories of the post-filter are
populated and updated for the next frame.

Moreover, in case the adaptive post-filter was activated in the previous
frame and is switched off in the current frame, a smoothing mechanism is
applied for avoiding any discontinuities. It is achieved by computing
the zero impulse response of the post-filter states and adding it to the
zero memory response of the current decoded frame. First, the first
subframe of the current decoded frame is filtered by the corresponding
set of LPC analysis filter $\hat{A}\left( z \right)$ and using as memory
the previously decoded frame samples before being post-processed. The
past non post-processed samples are eventually resampled as described in
clause 5.4.4.4 in case of internal sampling rate switching. The residual
is re-synthesized with $\frac{1}{\hat{A}}\left( z \right)$ using this
time as memory the past decoded frame sampled computing after being
post-processed. As stated above, the past non post-processed samples are
resampled in case of internal sampling rate switching. The rest the
current decoded frame is not processed further.

#### 6.3.4.6.2 Bass post filter

At 9.6, 16.4 and 24.4 kbps, the past memory of signal ${\hat{s}}_{f}(n)$
defined in clause 6.1.4.2 is reset in case of sampling rate switching.
That means that the Bass post-filter has no effect during the
transition.

#### 6.3.4.7 CLDFB

In case of internal sampling rate switching, the states of the analysis
CLDFB needs to be resampled for both the decoded signal coming from
either CELP or MDCT-based TCX decoded module, and also for the error
signal $r(n)$provided by the Bass post-filter as defined in clause
6.1.4.2.

The resampling of the two set of states is performed with the help of
the linear interpolation described in subclause 5.4.4.4.

### 6.3.5 EVS primary modes and AMR-WB IO

#### 6.3.5.1 Switching from primary modes to AMR-WB IO

In addition to processing described Subclause 5.4.5.1, the following is
done:

-   Reset the unvoiced/audio signal improvement memories

-   Reset AMR-WB BWE memories

-   bass post-filter is not employed in the first AMR-WB IO frame

-   formant post-filter is not employed in the first AMR-WB IO frame

#### 6.3.5.2 Switching from AMR-WB IO mode to primary modes

Same as Subclause 5.4.5.2.

### 6.3.6 Rate switching

When the bit-rate is changing, the different coding tools are
reconfigured at the beginning of the frame. The different bit-rate
dependent setups of each tool are described in each corresponding
clause. Rate switching doesn't require any specific handling, except in
the following scenarios.

#### 6.3.6.1 Rate switching along with internal sampling rate switching

In case the internal sampling rate changes when switching the bit-rate,
the processing described in clause 6.3.4 is performed at first.

#### 6.3.6.2 Rate switching along with coding mode switching

In case the internal sampling rate changes when switching the bit-rate,
the processing described in clause 6.3.3 is performed. If the internal
sampling rate is also changing, the processing of clause 6.3.4 is
performed beforehand.

#### 6.3.6.3 Adaptive post-filter reset and smoothing

The adaptive post-filter can be reset and it effect smoothed when it is
switched on or off from frame to frame, respectively. The procedure is
described in suclause 6.3.4.6.1, where the buffer resampling is
performed only in case of internal sampling rate switching.

### 6.3.7 Bandwidth switching

When rate switching happens and the bandwidth of the output signal is
changed from WB to SWB and from SWB to WB, bandwidth switching
post-processing is performed in order to improve the perceptual quality
for the end users. The smoothing is applied for switching from WB to SWB
and the blind bandwidth extension is employed for switching from SWB to
WB.

#### 6.3.7.1 Bandwidth switching detector

Firstly, bandwidth switching detector is employed to detect if there is
bandwidth switching or not.

Initialize the counter of bandwidth switching from WB to SWB
$\text{bws\_cnt1} = \text{20}$, and initialize the counter of bandwidth
switching from SWB to WB $\text{bws}_{\text{cnt}} = \text{40}$.

The counter $\text{bws\_cnt1}$is calculated as follows:

1)  If the counter$\text{bws\_cnt1} \geq \text{20}$, the counter is
    reset to 0;

2)  else if the output bandwidth of the current frame is SWB, the total
    bit rate of the current frame is large than 9.6kbps, and the
    bandwidth of the previous frame is WB, the total bit rate of the
    previous frame is not large than 9.6kbps, the counter
    $\text{bws\_cnt1}$is incremented 1;

3)  else if the counter$\text{bws\_cnt1} > 0$, the
    counters$\text{bws\_cnt1}$and $\text{bws}_{\text{cnt}}$ will be
    reset as follows:

$\text{bws\_cnt1} = \begin{matrix}
\left\{ 0,\text{if}\text{BW} < \text{BW}^{\lbrack - 1\rbrack} \middle| \right.\ \left\{ \text{bws\_cnt1} + 1,\text{else}\ \text{if}\text{BW} = \text{SWB} \middle| \right.\  \\
\end{matrix}$ (1939)

$\text{bws}_{\text{cnt}} = \begin{matrix}
\left\{ 2 \ast (\text{20} - \text{bws\_cnt1}) - 1,\text{if}\text{BW} < \text{BW}^{\lbrack - 1\rbrack} \middle| \right.\  \\
\end{matrix}$ (1940)

The counter $\text{bws\_cnt}$is calculated as follows:

1)  If the counter$\text{bws}_{\text{cnt}} \geq \text{40}$, the counter
    is reset to 0;

2)  else if the conditions
    $\text{bitrate} \leq \text{9600}\text{AND}\text{bitrate}^{\lbrack - 1\rbrack} > \text{9600}\text{AND}\text{BW} < \text{BW}^{\lbrack - 1\rbrack}\text{AND}\text{BW} = \text{WB}$are
    all satisfied, the counter $\text{bws}_{\text{cnt}}$is incremented 1

3)  else if the counter$\text{bws}_{\text{cnt}} > 0$, the
    counters$\text{bws\_cnt1}$and $\text{bws}_{\text{cnt}}$ will be
    reset as follows:

$\text{bws}_{\text{cnt}} = \begin{matrix}
\left\{ 0,\text{if}\text{BW} > \text{BW}^{\lbrack - 1\rbrack} \middle| \right.\ \left\{ \text{bws}_{\text{cnt}} + 1,\text{else}\text{if}\text{BW} = \text{WB} \middle| \right.\  \\
\end{matrix}$ (1941)

$\text{bws}_{\text{cnt}}1 = \begin{matrix}
\left\{ (\text{40} - \text{bws}_{\text{cnt}}\frac{)}{2},\text{if}\text{BW} > \text{BW}^{\lbrack - 1\rbrack} \middle| \right.\  \\
\end{matrix}$ (1942)

Finally, the counter$\text{bws}_{\text{cnt}} > 0$indicates the switching
from super wideband to wideband; and the counter $\text{bws\_cnt1} > 0$
indicates the switching from wideband to super wideband.

#### 6.3.7.2 Super wideband switching to wideband

TBE mode, multi-mode FD BWE or MDCT based scheme will be employed to
generate the SHB signal when switching to wideband.

If the following conditions

$\begin{matrix}
\text{CT}! = \text{AC}\text{AND}\text{CT}! = \text{IC}\text{AND}\text{core}_{\text{brate}} > \text{2400}\text{AND}\text{core} = \text{ACELP}\text{AND}\text{Fs} \geq \text{32000} \\
\text{AND}\text{BW} > \text{NB}\text{AND}\text{bws}_{\text{cnt}} > 0\text{AND}!\text{ppp}_{\text{mode}_{\text{dec}}} \\
\end{matrix}$ (1943)

are satisfied, TBE mode is applied to reconstruct the SHB signal.

Otherwise, if the conditions
$\text{core} = \text{ACELP}\text{AND}\text{Fs} \geq \text{32000}\text{AND}\text{BW} > \text{NB}\text{AND}\text{bws}_{\text{cnt}} > 0\text{AND}!\text{ppp}_{\text{mode}_{\text{dec}}}$
are satisfied, multi-mode FD BWE algorithm is applied;

If the core is MDCT coding, the MDCT coefficients of the upper band are
predicted.

##### 6.3.7.2.1 TBE mode

The following steps are performed when TBE mode is used to generate the
SHB signal for wideband output:

1)  Estimate the high band LSF, gain shape according to the
    corresponding parameters of the previous frame or by looking for the
    pre-determined tables

2)  Reconstruct an initial SHB signal according to the TBE algorithm
    described in subclause 5.2.6.1.

3)  Predict a global gain of the initial SHB signal according to the
    spectral tilt parameter of the current frame and the correlation of
    the low frequency signal between the current frame and the previous
    frame

4)  Modify the initial SHB signal by the predicted global gain to obtain
    a final SHB signal

5)  Finally, the final SHB signal and low frequency signal are combined
    to obtain the output signal.

The spectral tilt parameter can be calculated as described by the
algorithm described in equations (800) and (801), and the correlation of
the low frequency signals of the current frame and the previous frame
can be the energy ratio between the current frame and the previous
frame.

In detail, the algorithm of predicting the global gain is described as
follows:

1)  Classify the signal of the current frame to fricative signal
    $F_{\text{fractive}} = 1$or non- fricative signal
    $F_{\text{fractive}} = 0$ according to the spectral tilt parameter
    and the correlation of the low frequency signal between the current
    frame and the previous frame:\
    When the spectral tilt parameter of the current frame is larger than
    5 and the FEC class of the low frequency signal is UNVOICED\_CLAS,
    or the spectral tilt parameter is larger than 10. And if the signal
    of the previous frame is non-fricative signal, and the correlation
    parameter is larger than a threshold, or if the signal of the
    previous frame is fricative signal and the correlation parameter is
    less than a threshold, the current frame is classified as fricative
    signal $F_{\text{fractive}} = 0$. Otherwise, the current frame is
    classified as fricative signal $F_{\text{fractive}} = 1$.

2)  For non-fricative signal, the spectral tilt parameter is limited to
    the range \[0.5, 1.0\]. For fricative signal, the spectral tilt
    parameter is limited to not larger than 8. The limited spectral tilt
    parameter is used as the global gain of the SHB signal.

> For some speacial cases: If the energy of the SHB signal(calculated by
> the global gain and $E_{\text{SHB}}^{'}$) is larger than the energy of
> the signal with the frequency range in \[3200, 6400\] $E_{\text{LH}}$,
> the global gain of the SHB signal is calculated as follows:

$G_{\text{global}}^{\text{SHB}} = 0\text{.}\frac{5 \ast E_{\text{LH}}}{E_{\text{SHB}}^{'}}$
(1944)

> where $E_{\text{SHB}}^{'}$is the energy of the initial SHB signal.
>
> If the energy of the SHB signal is less than 0.05 times of the energy
> of the signal with the frequency range in \[3200, 6400\]
> $E_{\text{LH}}$, the global gain of the SHB signal is calculated as
> follows:

$G_{\text{global}}^{\text{SHB}} = 0\text{.}\frac{\text{25} \ast E_{\text{LH}}}{E_{\text{SHB}}^{'}}$
(1938)

> For non-fricative signal, the global gain is multiplied by 2; and for
> fricative signal, the global gain is multiplied by 8. And then the
> global gain of the SHB signal $G_{\text{global}}^{\text{SHB}}$ will be
> smoothed further as follows:

-   If the signal of the current frame and the previous frame are both
    > fricative signal and
    > $G_{\text{global}}^{\text{SHB}} > R_{\text{ener}}$

$G_{\text{global}}^{\text{SHB}} = 0\text{.}2 \ast G_{\text{global}}^{\text{SHB}} + 0\text{.}8 \ast R_{\text{ener}}$
(1939)

-   else if the energy ratio of the low frequency signal between the
    > current frame and the previous frame is in the range of \[0.5,
    > 2\], and the modes of the signal of the current frame and the
    > previous frame are both fricative or are both non-fricative

$G_{\text{global}}^{\text{SHB}} = 0\text{.}5 \ast G_{\text{global}}^{\text{SHB}} + 0\text{.}5 \ast R_{\text{ener}}$
(1945)

-   Otherwise

$G_{\text{global}}^{\text{SHB}} = \begin{matrix}
\left\{ (1 - 0\text{.}1 \cdot G_{\text{global}}^{\text{SHB}}) \cdot G_{\text{global}}^{\text{SHB}} + 0\text{.}1 \cdot G_{\text{global}}^{\text{SHB}} \cdot R_{\text{ener}},\text{if}F_{\text{fractive}} = 0\text{AND}F_{\text{fractive}}^{\lbrack - 1\rbrack} = 1 \middle| \right.\  \\
\end{matrix}$ (1946)

> where $R_{\text{ener}}$is the energy ratio between the final SHB
> signal of the previous frame and the initial SHB signal of the current
> frame.

At the end, fade out the global gain of the SHB signal frame by frame as
follows:

$G_{\text{global}}^{\text{SHB}} = G_{\text{global}}^{\text{SHB}} \ast (\text{40} - \text{bws}_{\text{cnt}}\frac{)}{\text{40}}$
(1947)

##### 6.3.7.2.2 Multi-mode FD BWE mode

Predict the SHB signal of the current frame, and weight the SHB signal
of the current frame and the previous frame to obtain the final SHB
signal of the current frame. Then the SHB signal and the low frequency
signal are combined to obtain the output signal.

The SHB signal of the current frame is generated as follows:

1\) Predict the fine structure of the SHB signal of the current frame as
described in subclause 6.1.5.2.1.5.

2\) Predict the envelope of the SHB signal of the current frame, and
weight the envelopes of the current frame and the previous frame to
obtain the final envelope of the current frame.

3\) Reconstruct the SHB signal of the current frame by the predicted
fine structure and the weighted envelope.

In detail, the algorithm of predicting and weighting the envelopes is
described as follows:

1)  The 224 MDCT coefficients in the 800-6400 Hz frequency range
    $X_{M_{C}}\left( k \right),k = 0,\text{.}\text{.}\text{.},\text{223}$
    are split into 7 sharpness bands (32 coefficients per band).
    Calculate the peak of the magnitudes and the average magnitude in
    each sharpness band.

2)  The low frequency signal is classified into NORMAL or HARMONIC
    according to the ratios of the peak of the magnitudes and the
    average magnitude.

3)  Predict the initial envelope of the SHB signal according to the
    average magnitudes, the maximum value of the average magnitudes, the
    minimum value of the average magnitudes and the tilt parameter of
    the low frequency signal.

4)  An energy ratio $r_{\text{bws}}$between the same parts of the low
    frequency signal of the current frame and the previous frame is
    introduced to control the weighted value of the predicted envelope.
    This ratio$r_{\text{bws}}$ reflects the correlation of the current
    frame and the previous frame.

5)  Factor $w_{\text{bws}}$ is the weighting factor for the spectral
    envelope of the current frame, and $(1 - w_{\text{bws}})$is the one
    for the previous frame. $w_{\text{bws}}$ is initialized to 0.1. Note
    that $w_{\text{bws}}$ is reset to 0.1 if $\text{bws}_{\text{cnt}}$
    equals to zero.

6)  If $0\text{.}5 < r_{\text{bws}} < 2\text{.}0$, the predicted
    spectral envelope is weighted according to the energy
    ratio$w_{\text{bws}}$

> ${\hat{f}}_{\text{env}}(j) = \begin{matrix}
> \left\{ w_{\text{bws}} \cdot {\hat{f}}_{\text{env}}^{'}(j) + (1 - w_{\text{bws}}) \cdot {\hat{f}}_{\text{env}}^{\lbrack - 1\rbrack}(j),\text{if}w_{\text{bws}} < 0\text{.}9 \middle| \right.\  \\
> \end{matrix}$ (1948)
>
> and
> ${\hat{f}}_{\text{env}}(j) = 0\text{.}1 \cdot {\hat{f}}_{\text{env}}^{'}(j) + 0\text{.}9 \cdot {\hat{f}}_{\text{env}}^{\lbrack - 1\rbrack}(j)$,
> when$M_{\text{extl}}! = M_{\text{last}_{\text{extl}}}\text{AND}{\hat{f}}_{\text{env}}^{'}(j) > 2\text{.}0 \cdot {\hat{f}}_{\text{env}}^{\lbrack - 1\rbrack}(j)\text{AND}w_{\text{bws}} < 0\text{.}9$
>
> where ${\hat{f}}_{\text{env}}^{\lbrack - 1\rbrack}(j)$ is the envelope
> of the previous frame. Factor $w_{\text{bws}}$ is incremented by 0.05
> and saved for next frame.
>
> Otherwise, the predicted envelope is weighted as follows:

${\hat{f}}_{\text{env}}(j) = 0\text{.}9 \cdot {\hat{f}}_{\text{env}}^{'}(j) + 0\text{.}1 \cdot {\hat{f}}_{\text{env}}^{\lbrack - 1\rbrack}(j)j = 0,\cdots,\text{13}$
(1949)

> Then, fade out the predicted envelope of the SHB signal frame by frame
> as follows:

${\hat{f}}_{\text{env}}(j) = {\hat{f}}_{\text{env}}(j) \ast (\text{40} - \text{bws}_{\text{cnt}}\frac{)}{\text{40}}$
(1950)

##### 6.3.7.2.3 MDCT core

For low bit rate core: predict the envelopes of the upper band from the
2 decoded highest frequency envelopes and the average envelope of all
the decoded envelopes, and reconstruct he normalized coefficients by
random noise. And then the MDCT coefficients of the upper band are
reconstructed by the envelopes and the normalized coefficients.

For high bit rate core: for transient mode, predict the envelopes by the
20 decoded highest frequency coefficients; and for non-transient mode,
predict the envelopes by the 2 decoded highest frequency envelopes. The
normalized coefficients are predicted by random noise or by weighting
the random noise and the decoded low frequency coefficients. And then
the MDCT coefficients of the upper band are reconstructed by the
envelopes and the normalized coefficients.

#### 6.3.7.3 Wideband switching to super wideband

In the case of switching from wideband to super wideband for multi-mode
FD BWE or the MDCT core the coefficients in the frequency domain are
faded using the factor$\text{bws}_{\text{cnt}}\frac{1}{\text{20}}$. When
operating with TBE, the global gain in the temporal domain is faded
using the same factor $\text{bws}_{\text{cnt}}\frac{1}{\text{20}}$.

6.4 De-emphasis
---------------

The reverse of the filtering process described in subclause 5.1.4 is
performed at the output of the decoder.

$H_{\text{de} - \text{emph}}(z) = 11 - \beta_{\text{pre} - \text{emph}}z^{- 1}$
(1951)

where $\beta_{\text{pre} - \text{emph}}$ is the de-emphasis factor which
is set according to the sample rate and core type as described in
subclause 5.1.4.

6.5 Resampling to the output sampling frequency
-----------------------------------------------

The CELP and MDCT decoder output signals are sample rate converted,
depending on the selected output sample rate, i.e. 8 kHz, 16 kHz, 32 kHz
or 48 kHz. The CELP signal is resampled by the CLDFB, while the MDCT
part is resampled by its frequency to time transformation.

6.6 Decoding of frame erasure concealment side information
----------------------------------------------------------

The parameters described in subclause 5.5 are decoded to aid in the
error concealment procedure.

These parameters are;

-   Signal classification parameter

-   Energy information

-   Phase control information

-   Pich lag information

-   Spectral envelope diffuser

For more information how these parameters are employed, refer to
subclause 5.3.3 of \[6\].

6.7 Decoding in DTX/CNG operation
---------------------------------

### 6.7.1 Overview

When the decoder is in the CNG operation, the first bit in the SID frame
is decoded to point to the CNG mode in which the decoder will be
operating. In the LP-CNG mode, excitation(s) and synthesis filter(s) are
calculated from the decoded CN parameters, and the comfort noise is
synthesized by a LP synthesis approach.

In the FD-CNG mode, a spectral envelope is generated with the help of
the energy level information decoded from the SID data. The spectral
envelope is refined by a noise estimator running during active frames.
The resulting envelope determines the actual comfort noise which is
rendered inside different frequency domains, such as MDCT, FFT or CLDFB
and finally transformed to time-domain.

Subsequent subclauses describe the respect LP-CNG decoding and FD-CNG
decoding in details.

### 6.7.2 Decoding for LP-CNG

#### 6.7.2.1 LP-CNG decoding Overview

When the decoder is in the LP-CNG operation, a procedure to synthesize a
comfort noise signal is applied.

For each received SID frame, the one bit indicating the bandwidth type
of the SID frame is first decoded. WB SID frame is received if the
bandwidth bit equals "0", otherwise the SWB SID frame is received. The
LP-CNG decoder only operates in WB mode if no SWB SID frame has been
received, in which case the comfort noise is only generated for
low-band. Otherwise, the LP-CNG decoder will switch to SWB mode upon the
receiving of the SWB SID frame. Since the transmission of high-band CN
parameter is not synchronized with the transmission of the low-band CN
parameters, WB SID frames can be received even the LP-CNG decoder
operates in SWB mode. In which case, the energy parameter for high-band
CN synthesis is extrapolated from the low-band CN synthesis signal. The
low-band excitation energy is decoded from each LP-CNG SID frame based
on which a smoothed low-band excitation energy used for low-band CNG
synthesis is computed, as described in subclause 6.7.2.1.3. The low-band
LSF vector is decoded from each LP-CNG SID frame then converted to LSP
vector based on which a smoothed LSP vector is computed then converted
to LP coefficients to obtain the low-band CNG synthesis filter, as
described in subclause 6.7.2.1.4. If WB LP-CNG SID frame is received,
the residual spectral envelope is decoded based on which a smoothed
residual spectral envelope is computed, as described in subclause
6.7.2.1.5. A random excitation signal is generated from the smoothed
low-band excitation energy which is combined with a second excitation
signal generated from the smoothed residual spectral envelope to form
the final excitation signal for the low-band CNG synthesis, as described
in subclause 6.7.2.1.5. Low-band comfort noise is synthesized by
filtering the low-band final excitation signal through the low-band CNG
synthesis filter, as described in subclause 6.7.2.1.6.

In subclause 6.7.2.1.7, high-band decoding and synthesis is described if
the decoder is operating in SWB mode. When SWB LP-CNG SID frame is
received, the high-band energy of the frame is decoded from the SID
frame. For other types of received frames, that is the WB LP-CNG SID
frames and the NO\_DATA frames, the high-band energy of the frame is
generated locally at the decoder by extrapolating from the smoothed
low-band energy of the frame which is obtained from the low-band CNG
synthesis together with a high-band to low-band energy ratio calculated
at the last received SWB LP-CNG SID frame. The high-band energy of the
frame is further smoothed in each frame to be used for final high-band
CNG synthesis. For each CN frame, the high-band LSF spectrum used to
obtain the high-band CNG synthesis filter for each CN frame is
interpolated from the LSF spectrum of the hangover frames. The high-band
comfort noise is synthesized for each CN frame by filtering a random
excitation through the high-band CNG synthesis filter, then scaled to
the level corresponding to the smoothed high-band energy. The scaled
high-band synthesis signal is finally spectral flipped to the bandwidth
from 12.8 kHz to 14.4kHz, as described in subclause 6.1.5.1.12. The
resulting spectral flipped high-band synthesis signal is added to the
low-band synthesis signal so to form the final SWB comfort noise
synthesis signal.

##### 6.7.2.1.1 CNG parameter updates in active periods

During actively encoded periods without comfort noise parameters, four
buffers of the fixed predetermined size $\text{HO\_HIST\_SIZE}$are kept
updated with the current actively encoded frame's LSPs, an LSP domain
flag memory, the frame's excitation energy(in the LP-residual domain)
and the current low frequency spectral envelope of the excitation as:

$\begin{matrix}
\text{ho}_{\text{lsp}}(\text{frame},i) = \text{lsp}_{\text{new},\text{dec}}(i), & \begin{matrix}
\text{for} & i = 0\text{.}\text{.}\text{.}M - 1 \\
\end{matrix} \\
\end{matrix}$ (1947)

$\begin{matrix}
\text{ho}_{\text{16}\text{kLSP}}(\text{frame}) = \text{FALSE}, & \begin{matrix}
\text{if} & L_{\text{frame}} = \text{256} \\
\end{matrix} \\
\text{ho}_{\text{16}\text{kLSP}}(\text{frame}) = \text{TRUE}, & \begin{matrix}
\text{if} & L_{\text{frame}} \neq \text{256} \\
\end{matrix} \\
\end{matrix}$ (1948)

$\text{enr}_{\text{dec}}(\text{frame}) = \frac{1}{L_{\text{frame}}}\sum_{i = 0}^{L_{\text{frame}} - 1}{\text{exc}(i)^{2}}$
(1949)

$\begin{matrix}
\text{ho}_{\text{env}}(\text{frame},i) = \text{att}\frac{2}{L_{\text{FFT}}}\left( X_{R}^{2}(i) + X_{I}^{2}(i) \right), & \begin{matrix}
\text{for} & i = 0,\text{.}\text{.}\text{.},\text{19} \\
\end{matrix} \\
\end{matrix}$ (1950)

where $X_{R}\left( i \right)$and$X_{I}\left( i \right)$are,
respectively, the real and the imaginary parts of the$i$-th frequency
bin as outputted by the FFT of the LP excitation signal,
$L_{\text{FFT}}$ = 256 is the size of FFT analysis. The attenuation
factor $\text{att}$is given by

$\text{att} = \frac{1}{2^{\text{Tab}_{\text{enr}_{\text{att}}}\left( R_{\text{latest}_{\text{active}}} \right)}}$
(1950a)

where $\text{Tab}_{\text{enr}_{\text{att}}}$ is determined by the latest
bitrate used for actively encoded frames
$R_{\text{latest}_{\text{active}}}$, not including the current frame,
according to Table 172a.

Table 172a: Attenuation factor selection

  -------------------------------- ----------------------------------------
  Latest active bitrate \[kbps\]   $\text{Tab}_{\text{enr}_{\text{att}}}$
                                   1.7938412
                                   1.3952098
                                   1.0962363
                                   0.9965784
                                   0.9965784
  -------------------------------- ----------------------------------------

These buffers are implemented as circular FIFO (First in First Out)
buffers of size$\text{HO\_HIST\_SIZE}$to save complexity.

##### 6.7.2.1.2 DTX-hangover based parameter analysis in LP-CNG mode

To provide smoother sounding comfort noise synthesis in transitions from
active to inactive (CNG) coding, the 3 bit parameter
$\text{burstho}_{\text{cnt},\text{rec}}$is decoded from the bit stream
and used as the indicator for determining the initial subset of the
$\text{HO\_HIST\_SIZE}$sized buffers with
($\text{ho}_{\text{lsp}},\text{ho}_{\text{16}\text{kLSP}},\text{enr}_{\text{dec}},\text{ho}_{\text{env}}$)
parameters from the last active frames. The most recent
$\text{burstho}_{\text{cnt},\text{rec}}$ number of frames of the stored
parameters
($\text{ho}_{\text{lsp}},\text{ho}_{\text{16}\text{kLSP}},\text{enr}_{\text{dec}},\text{ho}_{\text{env}}$),
are used for an additional comfort noise parameter analysis in the very
first SID frame after an active speech segment.

Before copying the $\text{burstho}_{\text{cnt},\text{rec}}$most recent
$\text{ho}_{\text{lsp}}$vectors to the CNG-analysis buffer
$\text{ho}_{\text{lsp} - \text{hist}}$, the past LSP's which were
analysed with a different sampling frequency than the current SID
frame's sampling frequency is converted to the current frames sampling
frequency according to the information available in the flag vector
$\text{ho}_{\text{16}\text{kLSP}}$. The
$\text{burstho}_{\text{cnt},\text{rec}}$most recent
$\text{enr}_{\text{dec}}$values are copied into the analysis
vector$\text{enr}_{\text{hist}}$ and the
$\text{burstho}_{\text{cnt},\text{rec}}$ most recent
$\text{ho}_{\text{env}}$ values are copied into the analysis
vector$\text{ho}_{\text{env} - \text{hist}}$.

An age weighted average energy of the $\text{enr}_{\text{hist}}$ entries
which are less than 103% of the most recent energy value and greater
than 70 % of the most recent energy value, is computed
as$\text{enr}_{\text{hist} - \text{ave} - \text{weighted}}$, further the
number of entries in$\text{enr}_{\text{hist}}$ used for this average
calculation is stored as$m$. The age weights for the
$\text{enr}_{\text{hist} - \text{ave} - \text{weighted}}$ computation
are:

$w_{\text{ho} - \text{enr}} = \left\lbrack \text{\ 0}\text{.}\text{2,\ 0}\text{.}\text{16,\ 0}\text{.}\text{128,\ 0}\text{.}\text{1024,\ 0}\text{.}\text{08192,\ 0}\text{.}\text{065536,\ 0}\text{.}\text{0524288,\ 0}\text{.}\text{01048576\ } \right\rbrack$
(1951)

Further the $m$$\text{ho}_{\text{lsp} - \text{hist}}$vectors
corresponding in time to the past residual energies in
$\text{enr}_{\text{hist}}$used for
$\text{enr}_{\text{hist} - \text{ave} - \text{weighted}}$are saved in a
buffer$\text{ho}_{\text{lsp} - \text{hist} - \text{sel}}$. The buffer
$\text{ho}_{\text{lsp} - \text{hist} - \text{sel}}$is converted into the
LSF domain in buffer
$\text{ho}_{\text{lsf} - \text{hist} - \text{sel}}$.

Two outlier vector indices
\[$\text{max}_{\text{idx0}}\text{,max}_{\text{idx1}}$\] in
the$\text{ho}_{\text{lsf} - \text{hist} - \text{sel}}$ buffer among the
$m$ vector entries are found, by analysing the maximum average LSF
deviation to a uniform LSF spectrum. An average LSP-vector
$\text{ho}_{\text{lsp} - \text{ave} - \text{weighted}}$is calculated, by
computing the LSP-average with exclusion of zero, one or two of the
found outlier vectors, depending on the value of$m$.

The sum of the LSP-deviations with respect to the received SID-frame's
quantized LSPs $\text{lsp}_{\text{new},\text{dec}}$, is computed as:

$\text{lsp}_{\text{dist}} = \sum_{i = 0}^{M - 1}\left| \text{ho}_{\text{lsp} - \text{ave} - \text{weighted}}(i) - \text{lsp}_{\text{new},\text{dec}}(i) \right|$
(1952)

Further the maximum individual distortion contribution in the summation
above is saved as$\text{lsp}_{\text{maxdev}}$.\
\
If there were no past CN-parameters to analyse or an residual energy
step was detected, the received
$\text{lsp}_{\text{new},\text{dec}}$vector is used as the final
$\text{lsp}_{\text{CNG}}$ vector right away, on the other hand if there
were some past active SAD hangover frames to analyse and there was no
energy step detected , the $\text{lsp}_{\text{dist}}$and
$\text{lsp}_{\text{maxdev}}$are now used to control the vector update
over $i = 0\text{.}\text{.}\text{.}M - 1$, of the final CNG LSPs
$\text{lsp}_{\text{CNG}}$ using the average LSP-vector
$\text{ho}_{\text{lsp} - \text{ave} - \text{weighted}}$ as follows:

$\begin{matrix}
\begin{matrix}
\text{lsp}_{\text{CNG}}(i) = \text{ho}_{\text{lsp} - \text{ave} - \text{weighted}}(i), \\
\text{lsp}_{\text{CNG}}(i) = 0\text{.}8 \cdot \text{ho}_{\text{lsp} - \text{ave} - \text{weighted}}(i) + 0\text{.}2 \cdot \text{lsp}_{\text{new},\text{dec}}(i),\  \\
\end{matrix} & \begin{matrix}
\begin{matrix}
\text{if} & \left( \text{lsp}_{\text{dist}} > 0\text{.}4 \right) \vee \left( \text{lsp}_{\text{maxdev}} > 0\text{.}1 \right) \\
\end{matrix} \\
\text{otherwise} \\
\end{matrix} \\
\end{matrix}$ (1953)

The energy step is detected if it is the first CN frame after an active
frame and the energy quantization index$I_{q}$ decoded from the current
SID frame is greater than the previous energy quantization
index$I_{q}^{\lbrack - 1\rbrack}$ by more than 1, where
$I_{q}^{\lbrack - 1\rbrack} \geq 0$. Additionally, if there were past
CN-parameters, an energy step is detected if the most recent energy
value in $\text{enr}_{\text{hist}}$ is more than four times larger than
the smoothed quantized excitation energy $E_{\text{CN}}$. Further the
$m_{1}$ $\text{ho}_{\text{env} - \text{hist}}$vectors that originate
from active or WB SID frames among the
$m$$\text{ho}_{\text{env} - \text{hist}}$vectors corresponding in time
to the past residual energies in $\text{enr}_{\text{hist}}$used for
$\text{enr}_{\text{hist} - \text{ave} - \text{weighted}}$are saved in a
buffer$\text{ho}_{\text{env} - \text{hist} - \text{sel}}$. The average
envelope of $\text{ho}_{\text{env} - \text{hist} - \text{sel}}$ is
computed and from which two times of the smoothed residual spectral
envelope of the previous frame,
$\text{Env}_{\text{CN}}^{\lbrack - 1\rbrack}(k)$, calculated in equation
(1953) is subtracted. The resulting average envelope is used to
initialize the smoothed residual spectral envelope if there is no energy
step detected.

When a SID frame is received and there was no energy step detected,
first the received and decoded LSP vector
$\text{lsp}_{\text{new},\text{dec}}$is added to the CNG-analysis buffer
$\text{ho}_{\text{lsp} - \text{hist}}$in a FIFO manner for a buffer size
of up to$\text{HO\_HIST\_SIZE}$, and secondly the decoded residual
energy value in the SID frame $E_{\text{new}}$ is added to the CNG
analysis buffer $\text{enr}_{\text{hist}}$in a FIFO manner for a buffer
size of up to$\text{HO\_HIST\_SIZE}$, then thirdly, if applicable
(depending on if the SID frame is of WB type or not), the decoded low
frequency envelope of the excitation from the SID frame is added to the
CNG analysis buffer $\text{ho}_{\text{env} - \text{hist}}$ for a buffer
size of up to$\text{HO\_HIST\_SIZE}$.

During actively encoded periods, i.e. not including SID frames, the
currently least recent buffer element (firstly added) in the buffer
![](media/image59.wmf){width="0.5833333333333334in"
height="0.2361111111111111in"} and the corresponding element in the
buffer ![](media/image60.wmf){width="0.40347222222222223in"
height="0.20833333333333334in"} are excluded from the buffers with a
period of number of consecutive actively encoded frames given by the
decrement factor ![](media/image61.wmf){width="1.1354166666666667in"
height="0.17430555555555555in"}. As circular FIFO buffers are
implemented the elements do not actually have to be deleted but the
variable ![](media/image62.wmf){width="0.625in"
height="0.20833333333333334in"} representing the number of valid buffer
elements, i.e. elements used for determination of
![](media/image63.wmf){width="0.7923611111111111in"
height="0.2361111111111111in"} and
![](media/image64.wmf){width="1.1395833333333334in"
height="0.2361111111111111in"}, is given by:

![](media/image65.wmf){width="5.565277777777778in"
height="0.2534722222222222in"} (1953a)

where ![](media/image66.wmf){width="0.625in"
height="0.2638888888888889in"} is the number of valid buffer elements in
the very beginning of the actively encoded period,
![](media/image67.wmf){width="0.125in" height="0.16666666666666666in"}
is a non-negative integer and ![](media/image68.wmf){width="0.375in"
height="0.20833333333333334in"} is a counter of consecutive actively
encoded frames. The variable ![](media/image69.wmf){width="0.625in"
height="0.20833333333333334in"} does together with a pointer to the most
recently added buffer element determine the valid buffer elements.

##### 6.7.2.1.3 LP-CNG low-band energy decoding

The quantized low-band excitation energy in logarithmic domain is
decoded from each LP-CNG SID frame and converted to linear domain using
the procedure described in subclause 5.6.2.1.5. The resulting linear
domain low-band excitation energy $\overline{\hat{E}}$ is used to obtain
the smoothed low-band excitation energy $E_{\text{CN}}$ used for
low-band CNG synthesis in the same way as described in subclause
5.6.2.1.6.

##### 6.7.2.1.4 LP-CNG low-band filter parameters decoding

The quantized LSF vector is found in the same way as described in
subclause 6.1.1.1.1. For the two stage quantizer there are two indexes
that define the LSF vector. The index of the first stage codevector is
retrieved and the codevector components are obtained from the
16-dimensional codebook of 16 codevectors. The second stage index is
interpreted like in subclause 6.1.1.1.1. and the corresponding multiple
scale lattice codevector is obtained. If the codevector index from the
first stage has one of the values 0, 1, 2, 3, 7, 9, 12, 13, 14, 15 the
permutations specified in subclause 5.6.2.1.3 are applied to the decoded
codevector. The resulting codevector is added to the codevector obtained
in the first stage and the result corresponds to the decoded LSF vector.
The sampling frequency of the LP-CNG frame can be determined by checking
the value of the highest order LSF coefficient (last coefficient). If
the last decoded LSF coefficient is larger than 6350 the decoded frame
has sampling rate of 16 kHz, otherwise it is sampled at 12.8kHz and
contains either NB or WB LSF data. The smoothed LP synthesis filter,
$\hat{A}(Z)$, is then obtained in the same way as described in subclause
5.6.2.1.4.

##### 6.7.2.1.5 LP-CNG low-band excitation generation

The low-band excitation signal used for CNG synthesis is generated by
combining a random excitation and an excitation representing the low
frequency spectral details of the excitation signal.

The random excitation is generated for each subframe using a random
integer generator, the seed of which is updated by

$s_{r} = \text{short}\left\lbrack s_{r} \times \text{31821} + \text{13849} \right\rbrack$
(1954)

where $s_{r}$ is the seed value, initially set to 21845, and short\[.\]
limits the value to the interval \[--32767; 32768\]. The generated
random sequence, denoted as
$r(n),\ n = 0,\text{.}\text{.}\text{.},L_{\text{sf}} - 1$, is scaled for
each subframe by

$e_{r}(n) = r(n)\sqrt{\frac{{\overset{\sim}{E}}_{\text{CN}} \cdot L_{\text{sf}}}{\sum_{i = 0}^{L_{\text{sf}} - 1}\left( r(i) \right)^{2}}}\ n = 0,\ldots,L_{\text{sf}} - 1$
(1955)

where $L_{\text{sf}}$ denotes the length of subframe,
${\overset{\sim}{E}}_{\text{CN}}$ is the smoothed quantized excitation
energy, as described in subclause 6.7.2.1.3, with some random variation
between subframes added. The random variation is added to the smoothed
quantized excitation energy by

${\overset{\sim}{E}}_{\text{CN}} = E_{\text{CN}}(1 + 0\text{.}\text{000011} \cdot s_{E})$
(1956)

where $s_{E}$ is a random integer number generated for each subframe
using the same equation (1957) with the initial value of 21845. The
purpose of which is to better model the variance of background noise
during inactive signal periods. The scaled random sequence in each
subframe, $e_{r}(n),\ n = 0,\text{.}\text{.}\text{.},L_{\text{sf}}$, is
concatenated to form the random excitation signal for the whole frame,
$e_{r}(n),\ n = 0,\text{.}\text{.}\text{.},L$, where $L$ is the frame
length.

The excitation representing the low frequency spectral details of the
excitation signal is generated from the quantized residual spectral
envelope. The quantized residual spectral envelope is recovered from
each WB SID frame in the inverse way as described in subclause 5.6.2.1.6
that

$E\hat{n}v(k) = 2^{{\hat{E}}_{\text{exc}} - D(k)},\ k = 0,\text{.}\text{.}\text{.},\text{19}$
(1958)

where $E\hat{n}v(k)$ is the quantized residual spectral envelope, $D(k)$
is the entry of the residual spectral envelope codebook found with the
index decoded from the SID frame, $\hat{E_{\text{exc}}}$ is the
quantized total excitation energy calculated using the similar equation
in subclause 5.6.2.1.6,. A smoothed residual spectral envelope is
updated at each CN frame by $E\hat{n}v(k)$ through an AR filtering

$\text{Env}_{\text{CN}}(k) = 0\text{.}9\text{Env}_{\text{CN}}^{\lbrack - 1\rbrack}(k) + 0\text{.}1E\hat{n}v(k),\ k = 0,\text{.}\text{.}\text{.},\text{19}$
(1959)

where $\text{Env}_{\text{CN}}^{\lbrack - 1\rbrack}(k)$ denotes the
smoothed residual spectral envelope from the previous frame. If the
current frame is of NO\_DATA type, the $E\hat{n}v(k)$ from the last
received SID frame is used. The FFT spectrum of the random excitation,
$e_{r}(n),\ n = 0,\text{.}\text{.}\text{.},L$, generated in equation
(1960) is computed and based on this the low frequency spectral
envelope,
$\text{Env}_{\text{Rd}}(k),\ k = 0,\text{.}\text{.}\text{.},\text{19}$,
corresponding to the one transmitted in the SID frame is calculated in a
similar manner. The difference envelope between the smoothed spectral
envelope $\text{Env}_{\text{CN}}(k)$ and the random excitation envelope
$\text{Env}_{\text{Rd}}(k)$ is calculated

$D_{\text{Env}}(k) = \text{MAX}\left\lbrack \text{Env}_{\text{CN}}(k) + 2E_{\text{CN}} - \text{Env}_{\text{Rd}}(k),\ 0 \right\rbrack,\ k = 0,\text{.}\text{.}\text{.},\text{19}$
(1961)

where $E_{\text{CN}}$ is the smoothed quantized excitation energy
obtained in subclause 6.7.2.1.3, 2 times of $E_{\text{CN}}$ is
compensated to the $\text{Env}_{\text{CN}}(k)$ before the difference
envelope is calculated. Slight random variation is added to the
difference envelope.

${\overset{\sim}{D}}_{\text{Env}}(k) = D_{\text{Env}}(k) + 0\text{.}\text{000011} \cdot s_{\text{env}}(k) \cdot D_{\text{Env}}(k),\ k = 0,\text{.}\text{.}\text{.},\text{19}$
(1962)

where $s_{\text{env}}(k),\ k = 0,\text{.}\text{.}\text{.},\text{19}$ is
a series of random integer numbers generated for each envelope band
using the same equation (1963) with the initial value of 21845. A series
of 256-point random-phase FFT coefficients are generated where its low
frequency spectral envelope is made equal to the difference envelope
${\overset{\sim}{D}}_{\text{Env}}(k)$ and the coefficients corresponding
to other frequencies are set to 0. An IFFT is performed to the above FFT
coefficients and a 256-point time domain sequence $d(n)$ is outputted.
$d(n)$ is re-sampled to 320 points if operating in 16kHz core. $d(n)$ is
scaled for each subframe in a similar way to equation (1964) that

$e_{d}(n) = d(n)\sqrt{\frac{E_{d}(1 + 0\text{.}\text{000011}s_{\text{env}}) \cdot L_{\text{sf}}}{\sum_{i = 0}^{L_{\text{sf}} - 1}\left( d(i) \right)^{2}}}\ n = 0,\ldots,L_{\text{sf}} - 1$
(1965)

where $e_{d}(n)$ is the scaled $d(n)$ with random variation added,
$L_{\text{sf}}$ denotes the length of subframe, $s_{\text{env}}$ is a
random integer number generated for each subframe using the same random
generator as used in equation (1966), $E_{d}$ is the average energy of
$d(n)$ calculated as

$E_{d} = \frac{1}{L}\sum_{n = 0}^{L - 1}\left( d(n) \right)^{2}$ (1967)

where $L$ is the frame length. Energy increasing is not allowed if the
current frame is the first SID frame after an active burst in which
case, for subframe with $e_{d}(n) > d(n)$, $e_{d}(n)$ is limited to
$d(n)$. The $e_{d}(n)$ is the excitation representing the low frequency
spectral details of the excitation signal whichis attenuated and
combined with the earlier calculated random excitation $e_{r}(n)$

$e(n) = 0\text{.}\text{75}e_{d}(n) + e_{r}(n),\ n = 0,1,\text{.}\text{.}\text{.},L - 1$
(1968)

where $L$ is the frame length, $e(n)$ is the combined excitation signal.
The combined excitation $e(n)$ is scaled if its average energy is higher
than the smoothed quantized excitation energy $E_{\text{CN}}$ obtained
in subclause 6.7.2.1.3.

$e^{'}(n) = e(n)\sqrt{\text{min}\left( \frac{E_{\text{CN}}}{\frac{1}{L}\sum_{i = 0}^{L - 1}\left( e(i) \right)^{2}},\ 1 \right)}\ n = 0,\ldots,L - 1$
(1969)

where $L$ is the frame length, $e^{'}(n)$ is the scaled combined
excitation which is the final excitation signal for low-band CNG
synthesis.

##### 6.7.2.1.6 LP-CNG low-band synthesis

The low-band comfort noise is synthesized by filtering the scaled
combined excitation signal, $e^{'}(n)$, obtained in previous subclause
6.7.2.1.5 through the smoothed LP synthesis filter, $\hat{A}(Z)$,
obtained in subclause 6.7.2.1.4.

##### 6.7.2.1.7 LP-CNG high-band decoding and synthesis

To enable high perceptual quality in the inactive portions of speech on
the decoder side, during SWB mode operation of the codec, a high band
comfort noise synthesis (SHB-CNG) (12.8 - 14.4 kHz) is added to the low
bandwidth (0-12.8 kHz) LP-CNG synthesis output. This also helps to
ensure smooth transitions between active and inactive speech.

However, this is being done without transmitting any extra parameters
from the encoder to decoder to model the high-band spectral
characteristics of the inactive frames. Instead, to model the high band
spectrum (12.8 - 14.4 kHz) of the comfort noise, the high band LSF
parameters of the active speech frames preceding the current inactive
frames are used after interpolation as described below. The hangover
setting in the SAD algorithm ensures the active speech segments used for
the spectral characteristics estimation of the inactive frames,
sufficiently capture the background noise characteristics without
significant impact from the talk spurt.

The quantized LSF vectors of order 10 corresponding to active speech
high band (subclauses 5.2.4.1.3.1 and 6.1.5.1.3.1) received at the
decoder are buffered up to two past active frames (N-1) and (N), denoted
by $\rho_{N - 1,k}^{\text{SHB}}\ k = 1,\ldots,\text{10}$ and
$\rho_{N,k}^{\text{SHB}}\ k = 1,\ldots,\text{10}$where N+M is the
current inactive frame. Using these, the LSF vector corresponding to
SHB-CNG of (N+M) ^th^ inactive frame
$\rho_{N + M,k}^{\text{SHB} - \text{CNG}}\ k = 1,\ldots,\text{10}$is
interpolated as

$\rho_{N + M,k}^{\text{SHB} - \text{CNG}} = T \ast \rho_{N,k}^{\text{SHB}} + (1 - T) \ast \rho_{N - 1,k}^{\text{SHB}}\ k = 1,\text{.}\text{.}\text{.},\text{10}$
(1970)

where interpolation factor *T* is computed as

$T = \text{min}(\frac{M}{\text{32}},1)$ (1971)

using the number of inactive frames M leading up to the current inactive
frame (N+M) since the last active frame N.

This interpolated LSF vector $\rho_{N + M}^{\text{SHB} - \text{CNG}}$is
then converted to LPC coefficients and used as the coefficients of LP
synthesis filter to generate a synthesized signal. The energy of the
high-band signal is obtained for each CN frame by either directly
decoding from the SID frame if the SID frame is a SWB SID frame or by
extrapolating for other received frame types. If SWB SID frame is
received, the high-band energy of the frame which is the quantized
high-band log average energy, ${\overline{\hat{E}}}_{h}^{'}$, is
recovered by

${\overline{\hat{E}}}_{h}^{'} = \text{10}\text{log}_{\text{10}}2 \cdot \left( \frac{I}{0\text{.}9} - 6 \right)$
(1972)

where $I$ is the high-band energy index decoded from the SWB SID frame.
If $I$ is 0, $I$ is set to -15 for a lower noise floor. If WB SID frame
or NO\_DATA frame is received, the high-band energy of the frame is
generated locally at the decoder by extrapolating from the smoothed
low-band energy of the frame together with the high-band to low-band
energy ratio at the last received SWB LP-CNG SID frame. The smoothed
low-band energy of the frame is a weighted average of the low-band
energy of the current frame and the smoothed low-band energy of the
previous frame. The low-band energy of the current frame which is the
log average energy of the low-band signal is calculated from the
low-band synthesis signal

${\overline{E}}_{l}^{'} = \text{10}\text{log}_{\text{10}}\left( \frac{1}{L} \cdot \sum_{i = 0}^{L - 1}{{\hat{s}}_{l}(i)^{2}} \right)$
(1973)

where ${\hat{s}}_{l}(i)$ is the low-band synthesis signal as obtained in
subclause 6.7.2.1.6, $L$= 640 is the length of the low-band synthesis
signal. If the low-band energy ${\overline{E}}_{l}^{'}$ of the current
frame is deviating from the smoothed low-band energy of the previous
frame ${\overline{\overline{E}}}_{l^{\lbrack - 1\rbrack}}$ by more than
12 dB, a step update flag $f_{\text{step}}$ is set to 1 indicating the
permission of step update, otherwise is set to 0. If the flag
$f_{\text{step}}$ is set to 1, the smoothed low-band energy at the
current frame, ${\overline{\overline{E}}}_{l}$, is set to the current
frame's low-band energy ${\overline{E}}_{l}^{'}$. Otherwise, if the flag
$f_{\text{step}}$ is set to 0, the smoothed low-band energy is updated
at the current frame as

${\overline{\overline{E}}}_{l} = 0\text{.}1{\overline{\overline{E}}}_{l}^{\lbrack - 1\rbrack} + 0\text{.}9{\overline{E}}_{l}^{'}$
(1969)

where ${\overline{\overline{E}}}_{l^{\lbrack - 1\rbrack}}$ denotes the
smoothed low-band energy of the previous frame. The high-band energy of
the frame,${\overline{\hat{E}}}_{h}^{'}$, for received WB SID or
NO\_DATA frame is thus extrapolated as the sum of
${\overline{\overline{E}}}_{l}$ and$\Delta$, where
$\Delta = {\overline{\overline{E}}}_{h^{\lbrack - i\rbrack}} - {\overline{\overline{E}}}_{l^{\lbrack - i\rbrack}}$
denotes the high-band to low-band energy ratio at the last received SWB
SID frame *i* frames ago. The high-band energy of the frame is then
smoothed for final use according to

${\overline{\overline{E}}}_{h} = \alpha{\overline{\overline{E}}}_{h}^{\lbrack - 1\rbrack} + (1 - \alpha){\overline{E}}_{h}^{'}$
(1970)

where ${\overline{\overline{E}}}_{h}$is the smoothed high-band energy of
the current frame, ${\overline{\overline{E}}}_{h^{\lbrack - 1\rbrack}}$
denotes the smoothed high-band energy of the previous frame, $\alpha$ is
the forgetting factor which is set to 0 if $f_{\text{step}}$ is set to 1
or the current frame is the first frame after an active burst, otherwise
$\alpha$ is set to 0.75. The high-band comfort noise is synthesized by
filtering a 320-point white noise excitation signal through the LP
synthesis filter derived earlier in this subclause. The synthesized
comfort noise signal is then level adjusted to match the calculated
smoothed high-band energy ${\overline{\overline{E}}}_{h}$. A smoothing
period is setup for the first 5 frames after an active burst of more
than 3 frames and if the core technology used in the last active frame
is not HQ-core. Within the smoothing period, the synthesized comfort
noise is not level adjusted to the calculated smoothed high-band energy
${\overline{\overline{E}}}_{h}$, but to an interpolated energy between
${\overline{\overline{E}}}_{h}$ and the high-band log average energy
calculated at the last active frame. The interpolated energy is
calculated as

${\overline{\overline{E}}}_{\text{hs},i} = {\overline{\overline{E}}}_{h} + \text{SIN}\left\lbrack \frac{\pi}{2} \cdot \frac{6 - i}{\text{15}} \right\rbrack(E_{h,\text{act}} - {\overline{\overline{E}}}_{h}),\ i = 1,2,3,4,5$
(1971)

where ${\overline{\overline{E}}}_{\text{hs},i}$ denotes the interpolated
high-band energy of the $i$-th CN frame in the smoothing period,
$E_{h,\text{act}}$ denotes the high-band log average energy of the last
active frame, $\text{SIN}\left\lbrack \right\rbrack$ denotes the sine
function. Finally, the level adjusted synthesized high-band comfort
noise is spectral flipped to the bandwidth from 12.8kHz to 14.4kHz as
described in subclause 6.1.5.1.12. The resulting high-band synthesis
signal is later added to the low-band synthesis signal to form the final
SWB comfort noise synthesis signal.

#### 6.7.2.2 Memory update

When an inactive signal frame is processed, the following updates are
performed:

-- MA memory of the ISF quantizer is set to zero;

-- AR memory of the ISF quantizer is set to mean values (UC mode, WB
case);

-- phase dispersion memory is set to zero;

-- synthesis excitation spectrum tilt is set to zero;

-- noise enhancer memory is set to zero;

-- class of last received good frame for FEC is set to UNVOICED\_CLAS;

-- floating point pitch for each subframe is set to the subframe length;

-- the low-pass filtered pitch gain for FEC is set to zero;

-- the filtered algebraic codebook gain for FEC is set to the square
root of the smoothed quantized CNG excitation energy, $E_{\text{CN}}$,
from subclause 6.7.2.1.3;

-- the excitation buffer memory is updated;

-- previous pitch gains are all set to zero;

-- previous codebook gain is set to zero;

-- active frame counter is set to zero;

-- voicing factors used by the bandwidth extension are all set to 1;

-- bass post-filter is tuned off;

-- synthesis filter memories are updated.

### 6.7.3 Decoding for FD-CNG

In FD-CNG, the comfort noise is generated in the frequency domain. Based
on the information provided by the SID frames, the amplitude of the
random sequences can be individually computed in each band such that the
spectrum of the generated comfort noise resembles the spectrum of the
actual background noise in the input signal.

Unfortunately, the limited number of parameters transmitted in the SID
frames allows only to reproduce the smooth spectral envelop of the
background noise. Hence, it cannot capture the fine spectral structure
of the noise. At the output of a DTX system, the discrepancy between the
smooth spectrum of the reconstructed comfort noise and the spectrum of
the actual background noise can become very audible at the transitions
between active frames (involving regular coding and decoding of a noisy
speech portion of the signal) and the comfort noise frames. Since the
fine spectral structure of the background noise cannot be transmitted
efficiently from the encoder to the decoder, it is highly desirable to
recover this information directly at the decoder side. This can be
carried out using a noise estimator.

Note that noise-only frames are considered as inactive frames in a DTX
system. Therefore, the noise estimation in the decoder must operate
during active phases only, i.e., on noisy speech contents. In FD-CNG,
the decoder uses in fact the same noise estimation algorithm as in the
encoder, but applying a significantly higher spectral resolution at the
decoder than at the encoder.

#### 6.7.3.1 Decoding SID frames in FD-CNG

The decoded SID parameters
$N_{\text{FD} - \text{CNG}}^{\lbrack\text{SID}\rbrack}(i),i = 0,\text{.}\text{.}\text{.},L_{\text{SID}} - 1$describe
the energy of the background noise in the spectral partitions defined in
subclause 5.6.3.6. The first
$L_{\text{SID}}^{\lbrack\text{FFT}\rbrack}$parameters capture the
spectral energy of the noise in FFT bins covering the core bandwidth.
The remaining$L_{\text{SID}}^{\lbrack\text{CLDFB}\rbrack}$parameters
capture the spectral energy of the noise in CLDFB bands above the core
bandwidth.

##### 6.7.3.1.1 SID parameters decoding

The SID parameters
$N_{\text{FD} - \text{CNG}}^{\lbrack\text{SID}\rbrack}(i),i = 0,\text{.}\text{.}\text{.},L_{\text{SID}} - 1$
are decoded using MSVQ decoding and global gain adjustment.

Seven indices are decoded from the bitstream. The first six indices
$I_{\text{MSVQ,FD} - \text{CNG}}\left( k \right),k = 0,\text{.}\text{.}\text{.},5$are
used for MSVQ decoding. They correspond to the six stages of the MSVQ.
The first index is encoded on 7 bits and the five next indices are
encoded on 6 bits. The last index$I_{\text{g,FD} - \text{CNG}}$, encoded
on 7 bits, is used for decoding the global gain.

The MSVQ decoder output is given by

${\overline{N}}_{\text{FD} - \text{CNG}}^{\lbrack\text{SID}\rbrack}\left( i \right) = \sum_{k = 0}^{5}{V_{k}\left( I_{\text{MSVQ,FD} - \text{CNG}}\left( k \right),i \right)}$,
(1974)

where $V_{k}\left( j,i \right)$ is the $i$-th coefficient of the $j$-th
vector in the codebook of stage $k$.

The decoded global gain is given by

$g_{\text{FD} - \text{CNG}}^{\lbrack\text{SID}\rbrack} = \frac{I_{\text{g,FD} - \text{CNG}} - \text{60}}{1\text{.}5}$.
(1975)

The SID parameters are then obtained

$N_{\text{FD} - \text{CNG}}^{\lbrack\text{SID}\rbrack}(i) = \text{10}^{\left( \frac{{\overline{N}}_{\text{FD} - \text{CNG}}^{\lbrack\text{SID}\rbrack}\left( i \right) + g_{\text{FD} - \text{CNG}}^{\lbrack\text{SID}\rbrack}}{\text{10}} \right)}$.
(1976)

Finally the last band parameter is adjusted in case the encoded last
band size is different from the decoded last band size

##### 6.7.3.1.2 SID parameters interpolation

The SID parameters are interpolated using linear interpolation in the
log domain. The interpolation is carried out separately for the FFT
partitions ($i < L_{\text{SID}}^{\lbrack\text{FFT}\rbrack}$) and CLDFB
partitions ($i \geq L_{\text{SID}}^{\lbrack\text{FFT}\rbrack}$).

$N_{\text{FD} - \text{CNG}}^{\lbrack\text{SID,FR}\rbrack}(j) = \begin{matrix}
\left\{ 0\ j = 0,\text{.}\text{.}\text{.},j_{\text{min}}(0) - 1 \middle| \right.\ \left\{ N_{\text{FD} - \text{CNG}}^{\lbrack\text{SID}\rbrack}(i)\ j = j_{\text{min}}(i),\text{.}\text{.}\text{.},j_{\text{mid}}(i)\ \text{}i = 0 \middle| \right.\ \left\{ N_{\text{FD} - \text{CNG}}^{\lbrack\text{SID}\rbrack}(i - 1)\left( \Delta(i) \right)^{j - j_{\text{mid}}^{\lbrack\text{SID}\rbrack}(i - 1)}\ \text{}j = j_{\text{mid}}(i - 1) + 1,\text{.}\text{.}\text{.},j_{\text{mid}}(i)\ i = 1,\text{.}\text{.}\text{.},L_{\text{SID}}^{\lbrack\text{FFT}\rbrack} - 1 \middle| \right.\ \left\{ N_{\text{FD} - \text{CNG}}^{\lbrack\text{SID}\rbrack}(i)\text{min}\left( \Delta(i),1 \right)^{j - j_{\text{mid}}^{\lbrack\text{SID}\rbrack}(i)}\ \text{}j = j_{\text{mid}}(i) + 1,\text{.}\text{.}\text{.},j_{\text{max}}(i)\ \ i = L_{\text{SID}}^{\lbrack\text{FFT}\rbrack} - 1 \middle| \right.\ \left\{ N_{\text{FD} - \text{CNG}}^{\lbrack\text{SID}\rbrack}(i)\ j = j_{\text{min}}(i),\text{.}\text{.}\text{.},j_{\text{mid}}(i)\ \text{}i = L_{\text{SID}}^{\lbrack\text{FFT}\rbrack} \middle| \right.\ \left\{ N_{\text{FD} - \text{CNG}}^{\lbrack\text{SID}\rbrack}(i - 1)\left( \Delta(i) \right)^{j - j_{\text{mid}}^{\lbrack\text{SID}\rbrack}(i - 1)}\ \text{}j = j_{\text{mid}}(i - 1) + 1,\text{.}\text{.}\text{.},j_{\text{mid}}(i)\ \text{}i = L_{\text{SID}}^{\lbrack\text{FFT}\rbrack},\text{.}\text{.}\text{.},L_{\text{SID}} - 1 \middle| \right.\ \left\{ N_{\text{FD} - \text{CNG}}^{\lbrack\text{SID}\rbrack}(i)\text{min}\left( \Delta(i),1 \right)^{j - j_{\text{mid}}^{\lbrack\text{SID}\rbrack}(i)}\ \text{}j = j_{\text{mid}}(i) + 1,\text{.}\text{.}\text{.},j_{\text{max}}(i)\ i = L_{\text{SID}} - 1 \middle| \right.\  \\
\end{matrix}$, (1977)

where

$j_{\text{mid}}(i) = \begin{matrix}
\left\{ j_{\text{max}}(0)\ i = 0 \middle| \right.\  \\
\end{matrix}$ (1978)

denotes the centre bin in each spectral partition, and

$\Delta(i) = \text{exp}\left( \frac{\text{log}(N_{\text{FD} - \text{CNG}}^{\lbrack\text{SID}\rbrack}(i)) - \text{log}(N_{\text{FD} - \text{CNG}}^{\lbrack\text{SID}\rbrack}(i - 1))}{j_{\text{mid}}(i) - j_{\text{mid}}(i - 1)} \right)$
(1979)

is the multiplicative increment.

##### 6.7.3.1.3 LPC estimation from the interpolated SID parameters

A set of LPC coefficients is estimated from the SID spectrum in order to
update excitation and LPC related memories.

A noise floor is first added to the interpolated SID parameters and a
pre-emphasis function is then applied in the frequency domain

${\overset{\sim}{N}}_{\text{FD} - \text{CNG}}^{\lbrack\text{SID,FR}\rbrack}(j) = \text{max}\left( N_{\text{FD} - \text{CNG}}^{\lbrack\text{SID,FR}\rbrack}(j),0\text{.}\text{001} \right)\left( 1 + \text{pf}^{2} - 2\text{pf}\text{cos}\left( \frac{- 2\text{πj}}{L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack}} \right) \right)$,
(1980)

with $\text{pf}$ is the pre-emphasis factor (0.68 at 12.8 kHz and 0.72
at 16 kHz).

The noise estimates are then transformed using an inverse FFT, producing
autocorrelation coefficients

$r_{\text{FD} - \text{CNG}}\left( n \right) = \frac{L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack}}{2}\sum_{j = 0}^{L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack}/2}{{\overset{\sim}{N}}_{\text{FD} - \text{CNG}}^{\lbrack\text{SID,FR}\rbrack}(j)}\text{cos}\left( 2\text{πn}\frac{j}{L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack}} \right),\ n = 0,\text{.}\text{.}\text{.},\text{16}$.
(1981)

Then the first autocorrelation coefficient is adjusted

$r_{\text{FD} - \text{CNG}}\left( 0 \right) = 1\text{.}\text{0005}\text{max}(r_{\text{FD} - \text{CNG}}\left( 0 \right),\text{100})$.
(1982)

And finally LPC coefficients
$a_{\text{FD} - \text{CNG}}\left( n \right),\ n = 0,\text{.}\text{.}\text{.},\text{16}$
are estimated from the autocorrelation coefficients
$r_{\text{FD} - \text{CNG}}$ using Levinson-Durbin (see subclause
5.1.9.4).

#### 6.7.3.2 Noise tracking during active frames in FD-CNG

At the decoder side, the noise estimator is applied at the output of the
core decoder during active frames. To achieve a trade-off between
spectral resolution and computational complexity, spectral energies are
averaged among groups of spectral bands called partitions, just like in
the encoder (see subclause 5.6.3.1). However, the size of each partition
is significantly smaller in the decoder compared to the encoder,
yielding thereby a finer quantization of the frequency axis in the
decoder. Moreover, the decoder-side noise estimation operates solely in
the FFT domain and covers only the core bandwidth. Hence FFT partitions
are formed, but no CLDFB partitions.

##### 6.7.3.2.1 Spectral partition energies

The output of the core decoder is first transformed by an FFT of
size$L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack} = \text{sr}_{\text{CELP}}/\text{25}$,
where$\text{sr}_{\text{CELP}}$refers to the sampling rate of the core
decoder output. Then $L_{\text{shaping}}$ partitions are formed as
follows:

$E_{\text{FD} - \text{CNG}}(i) = \frac{4}{(L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack})^{2}}\frac{\sum_{}^{}\left| X\left( j \right) \right|^{2}}{j_{\text{max}}^{\lbrack\text{shaping}\rbrack}(i) - j_{\text{min}}^{\lbrack\text{shaping}\rbrack}(i) + 1}\ i = 0,\text{.}\text{.}\text{.},L_{\text{shaping}} - 1$,
(1983)

where$X\left( j \right)$ is the FFT transform of the core output signal.
The following table lists the number of partitions and their upper
boundaries for the different FD-CNG configurations at the decoder, as a
function of bandwidths and bit-rates.

Table 173: FD-CNG decoder parameters

  ------- ------------ ---------------------- --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
          Bit-rates\   $L_{\text{shaping}}$   $f_{\text{max}}^{\lbrack\text{shaping}\rbrack}(i),\ i = 0,\text{.}\text{.}\text{.},L_{\text{shaping}} - 1$\
          (kbps)                              (Hz)

  NB                   56                     50, 75, 100, 125, 150, 175, 200, 225, 250, 275, 300, 325, 350, 375, 400, 425, 450, 475, 500, 525, 550, 575, 600, 625, 650, 675, 700, 725, 750, 775, 800, 825, 850, 875, 900, 925, 950, 975, 1000, 1075, 1175, 1275, 1375, 1475, 1600, 1725, 1850, 2000, 2150, 2325, 2500, 2700, 2925, 3150, 3400, 3975

  WB/\                 62                     50, 75, 100, 125, 150, 175, 200, 225, 250, 275, 300, 325, 350, 375, 400, 425, 450, 475, 500, 525, 550, 575, 600, 625, 650, 675, 700, 725, 750, 775, 800, 825, 850, 875, 900, 925, 950, 975, 1000, 1075, 1175, 1275, 1375, 1475, 1600, 1725, 1850, 2000, 2150, 2325, 2500, 2700, 2925, 3150, 3375, 3700, 4050, 4400, 4800, 5300, 5800, 6375
  SWB/\                                       
  FB                                          

                       61                     50, 75, 100, 125, 150, 175, 200, 225, 250, 275, 300, 325, 350, 375, 400, 425, 450, 475, 500, 525, 550, 575, 600, 625, 650, 675, 700, 725, 750, 775, 800, 825, 850, 875, 900, 925, 950, 975, 1000, 1075, 1175, 1275, 1375, 1475, 1600, 1725, 1850, 2000, 2150, 2325, 2500, 2700, 2925, 3150, 3400, 3700, 4400, 5300, 6400, 7700, 7975
  ------- ------------ ---------------------- --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

For each
partition$i = 0,\text{.}\text{.}\text{.},L_{\text{shaping}} - 1$,$f_{\text{max}}^{\lbrack\text{shaping}\rbrack}(i)$corresponds
to the frequency of the last band in the *i*-th partition. The
indices$j_{\text{min}}^{\lbrack\text{shaping}\rbrack}(i)$and
$j_{\text{max}}^{\lbrack\text{shaping}\rbrack}(i)$ of the first and
last bands in each spectral partition can be derived as a function of
the FFT size $L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack}$and
the sampling rate of the core decoder $\text{sr}_{\text{CELP}}$as
follows:

$j_{\text{max}}^{\lbrack\text{shaping}\rbrack}(i) = f_{\text{max}}^{\lbrack\text{shaping}\rbrack}(i)\frac{L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack}}{\text{sr}_{\text{CELP}}}\ i = 0,\text{.}\text{.}\text{.},L_{\text{shaping}} - 1$,
(1984)

$j_{\text{min}}^{\lbrack\text{shaping}\rbrack}(i) = \begin{matrix}
\left\{ f_{\text{min}}^{\lbrack\text{shaping}\rbrack}(0)\frac{L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack}}{\text{sr}_{\text{CELP}}}\ i = 0 \middle| \right.\  \\
\end{matrix}$, (1985)

where $f_{\text{min}}^{\lbrack\text{shaping}\rbrack}(0) = \text{50Hz}$
is the frequency of the first band in the first spectral partition.
Hence the FD-CNG generates some comfort noise above 50Hz only.

##### 6.7.3.2.2 FD-CNG noise estimation

In FD-CNG, encoder and decoder rely on the same noise estimator, except
that the number of partitions differs. As in subclause 5.6.3.2, the
input partition energies are first processed by a non-linear transform
before applying the noise tracking algorithm on the
inputs$E_{\text{FD} - \text{CNG}}(i),i = 0,\text{.}\text{.}\text{.},L_{\text{shaping}} - 1$.
The inverse transform is then used to recover the original dynamic
range. In the sequel, the resulting decoder-side noise estimates are
referred to as
$N_{\text{FD} - \text{CNG}}^{\lbrack\text{shaping}\rbrack}(i),i = 0,\text{.}\text{.}\text{.},L_{\text{shaping}} - 1$.
They are used as shaping parameters in the next subclause.

##### 6.7.3.2.3 Noise shaping in FD-CNG

Note that the shaping
parameters$N_{\text{FD} - \text{CNG}}^{\lbrack\text{shaping}\rbrack}(i),i = 0,\text{.}\text{.}\text{.},L_{\text{shaping}} - 1$computed
directly at the decoder differ from the SID
parameters$N_{\text{FD} - \text{CNG}}^{\lbrack\text{SID}\rbrack}(i),i = 0,\text{.}\text{.}\text{.},L_{\text{SID}}^{\lbrack\text{FFT}\rbrack} - 1$
which are transmitted via SID frames. Both sets are computed from FFT
partitions covering the core bandwidth, but the decoder benefits from a
significantly higher number of spectral partitions, i.e.,
$L_{\text{shaping}} > L_{\text{SID}}^{\lbrack\text{FFT}\rbrack}$. In
fact, the high-resolution noise estimates obtained at the decoder
capture information about the fine spectral structure of the background
noise. However, the decoder-side noise estimates cannot adapt to changes
in the actual background noise during inactive phases. In contrast, the
SID frames deliver new information about the spectral envelop at regular
intervals during inactive phases. The FD-CNG therefore combines these
two sources of information in an effort to reproduce the fine spectral
structure captured from the background noise present during active
phases, while updating only the spectral envelop of the comfort noise
during inactive parts with the help of the SID information.

##### 6.7.3.2.3.1 Conversion to a lower spectral resolution {#conversion-to-a-lower-spectral-resolution .H6}

Interpolation is first applied to the shaping
parameters$N_{\text{FD} - \text{CNG}}^{\lbrack\text{shaping}\rbrack}(i)$to
obtain a full-resolution FFT power spectrum as follows:

> $N_{\text{FD} - \text{CNG}}^{\lbrack\text{shaping,FR}\rbrack}(j) = \begin{matrix}
> \left\{ 0\ j = 0,\text{.}\text{.}\text{.},j_{\text{min}}^{\lbrack\text{shaping}\rbrack}(0) - 1 \middle| \right.\ \left\{ N_{\text{FD} - \text{CNG}}^{\lbrack\text{shaping}\rbrack}(i)\ \ j = j_{\text{min}}^{\lbrack\text{shaping}\rbrack}(i),\text{.}\text{.}\text{.},j_{\text{mid}}^{\lbrack\text{shaping}\rbrack}(i)\ i = 0 \middle| \right.\ \left\{ N_{\text{FD} - \text{CNG}}^{\lbrack\text{shaping}\rbrack}(i - 1)\left( \Delta(i) \right)^{j - j_{\text{mid}}^{\lbrack\text{shaping}\rbrack}(i - 1)}\ j = j_{\text{mid}}^{\lbrack\text{shaping}\rbrack}(i - 1) + 1,\text{.}\text{.}\text{.},j_{\text{mid}}^{\lbrack\text{shaping}\rbrack}(i)\ i = 1,\text{.}\text{.}\text{.},L_{\text{shaping}} - 1 \middle| \right.\  \\
> \end{matrix}$, (1986)

where

$j_{\text{mid}}^{\lbrack\text{shaping}\rbrack}(i) = \begin{matrix}
\left\{ j_{\text{max}}^{\lbrack\text{shaping}\rbrack}(0)\ i = 0 \middle| \right.\  \\
\end{matrix}$ (1987)

denote the center FFT bins in each spectral partition, and
$\Delta(i) = \text{exp}\left( \frac{\text{log}(N_{\text{FD} - \text{CNG}}^{\lbrack\text{shaping}\rbrack}(i)) - \text{log}(N_{\text{FD} - \text{CNG}}^{\lbrack\text{shaping}\rbrack}(i - 1))}{j_{\text{mid}}^{\lbrack\text{shaping}\rbrack}(i) - j_{\text{mid}}^{\lbrack\text{shaping}\rbrack}(i - 1)} \right)$
is the multiplicative increment for the interpolation. The above
corresponds in fact to a linear interpolation in the log domain of the
FFT shaping partitions.

The full-resolution spectrum
$N_{\text{FD} - \text{CNG}}^{\lbrack\text{shaping,FR}\rbrack}(j)$is
subsequently converted again to a lower resolution based on the SID
spectral partitions (see subclause 5.6.3.6). The resulting noise energy
spectrum
$N_{\text{FD} - \text{CNG}}^{\lbrack\text{shaping,LR}\rbrack}(i),i = 0,\text{.}\text{.}\text{.},L_{\text{SID}}^{\lbrack\text{FFT}\rbrack} - 1$exhibits
therefore the same spectral resolution as the SID
parameters$N_{\text{FD} - \text{CNG}}^{\lbrack\text{SID}\rbrack}(i),i = 0,\text{.}\text{.}\text{.},L_{\text{SID}}^{\lbrack\text{FFT}\rbrack} - 1$.
Hence, both sets are comparable and can be combined in the next
subclause.

##### 6.7.3.2.3.2 Combining SID and shaping parameters {#combining-sid-and-shaping-parameters .H6}

Comparing the low-resolution noise
estimates$N_{\text{FD} - \text{CNG}}^{\lbrack\text{SID}\rbrack}(i)$and$N_{\text{FD} - \text{CNG}}^{\lbrack\text{shaping,LR}\rbrack}(i)$obtained
from the encoder (via SID frames) and decoder, respectively, the
full-resolution noise spectrum
$N_{\text{FD} - \text{CNG}}^{\lbrack\text{shaping,FR}\rbrack}(i)$can now
be scaled to yield a full-resolution noise power spectrum as follows:

$N_{\text{FD} - \text{CNG}}^{\lbrack\text{CNG}\rbrack}(j) = \begin{matrix}
\left\{ 0\ j = 0,\text{.}\text{.}\text{.},j_{\text{min}}^{\lbrack\text{SID}\rbrack}(0) - 1 \middle| \right.\  \\
\end{matrix}$, (1988)

where$j_{\text{min}}^{\lbrack\text{SID}\rbrack}(i)$and
$j_{\text{max}}^{\lbrack\text{SID}\rbrack}(i)$refer to the first and
last FFT bin of the *i*-th SID partition (see subclause 5.6.3.6). The
full-resolution noise power
spectrum$N_{\text{FD} - \text{CNG}}^{\lbrack\text{CNG}\rbrack}(j)$is
recomputed for each active frame. It can be used to accurately adjust
the level of comfort noise in each FFT bin during SID frames or zero
frames, as shown in the next subclause.

#### 6.7.3.3 Noise generation for SID or zero frames in FD-CNG

##### 6.7.3.3.1 Update of the noise levels for FD-CNG

During the first non-active frame following an active frame, the
low-resolution shaping
parameters$N_{\text{FD} - \text{CNG}}^{\lbrack\text{shaping,LR}\rbrack}(i),i = 0,\text{.}\text{.}\text{.},L_{\text{SID}}^{\lbrack\text{FFT}\rbrack} - 1$
are recomputed
from$N_{\text{FD} - \text{CNG}}^{\lbrack\text{shaping,FR}\rbrack}(j)$ by
averaging over the SID partitions as in subclause 5.6.3.1.1.

If an SID frame occurs while the noise estimator (subclause 6.7.3.2.2)
is still in its initialization phase, the interpolated SID parameters
$N_{\text{FD} - \text{CNG}}^{\lbrack\text{SID,FR}\rbrack}\left( i \right)$
(see subclause 6.7.3.1.2) are used as comfort noise levels.

If an SID frame occurs once the noise estimator left the initialization
phase, the comfort noise levels are computed for FFT bins by combining
the noise estimates from encoder and decoder as described in
subclause 6.7.3.2.3.2, while the CLDFB levels are obtained directly by
interpolating the SID parameters corresponding to the CLDFB partitions,
i.e.,

$N_{\text{FD} - \text{CNG}}^{\lbrack\text{CNG}\rbrack}(j) = \begin{matrix}
\left\{ 0\ j = 0,\text{.}\text{.}\text{.},j_{\text{min}}^{\lbrack\text{SID}\rbrack}(0) - 1 \middle| \right.\ \left\{ \frac{N_{\text{FD} - \text{CNG}}^{\lbrack\text{SID}\rbrack}(i)}{N_{\text{FD} - \text{CNG}}^{\lbrack\text{shaping,LR}\rbrack}(i)}N_{\text{FD} - \text{CNG}}^{\lbrack\text{shaping,FR}\rbrack}(j)\ j = j_{\text{min}}^{\lbrack\text{SID}\rbrack}(i),\text{.}\text{.}\text{.},j_{\text{max}}^{\lbrack\text{SID}\rbrack}(i)\ i = 0,\text{.}\text{.}\text{.},L_{\text{SID}}^{\lbrack\text{FFT}\rbrack} - 1 \middle| \right.\ \left\{ N_{\text{FD} - \text{CNG}}^{\lbrack\text{SID}\rbrack}(i)\ j = j_{\text{min}}^{\lbrack\text{SID}\rbrack}(i),\text{.}\text{.}\text{.},j_{\text{mid}}^{\lbrack\text{SID}\rbrack}(i)\ i = L_{\text{SID}}^{\lbrack\text{FFT}\rbrack} \middle| \right.\ \left\{ N_{\text{FD} - \text{CNG}}^{\lbrack\text{SID}\rbrack}(i - 1)\left( \Delta(i) \right)^{j - j_{\text{mid}}^{\lbrack\text{SID}\rbrack}(i - 1)}\ j = j_{\text{mid}}^{\lbrack\text{SID}\rbrack}(i - 1) + 1,\text{.}\text{.}\text{.},j_{\text{mid}}^{\lbrack\text{SID}\rbrack}(i)\ i = L_{\text{SID}}^{\lbrack\text{FFT}\rbrack},\text{.}\text{.}\text{.},L_{\text{SID}} - 1 \middle| \right.\  \\
\end{matrix}$, (1989)

where$N_{\text{FD} - \text{CNG}}^{\lbrack\text{SID}\rbrack}(i)$are the
SID parameters decoded from the SID
frames,$N_{\text{FD} - \text{CNG}}^{\lbrack\text{shaping,LR}\rbrack}(i)$are
computed during the first non-active frame following an active frame, as
explained just above,
and$N_{\text{FD} - \text{CNG}}^{\lbrack\text{shaping,FR}\rbrack}(j)$is
the full-resolution noise spectrum obtained by interpolating the
decoder-side noise estimates during active frames (see
subclause 6.7.3.2.3.1).

##### 6.7.3.3.2 Comfort noise generation in the frequency domain

The FFT noise spectrum corresponding to the
first$j_{\text{max}}^{\lbrack\text{SID}\rbrack}(L_{\text{SID}}^{\lbrack\text{FFT}\rbrack} - 1)$
parameters in the array
$N_{\text{FD} - \text{CNG}}^{\lbrack\text{CNG}\rbrack}(j)$can finally be
used to generate some random Gaussian noise of zero mean and
variance$N_{\text{FD} - \text{CNG}}^{\lbrack\text{CNG}\rbrack}(j\frac{)}{2}$
separately for the real and imaginary parts of the FFT coefficients.

The second part of the CNG spectrum, i.e.,
$N_{\text{FD} - \text{CNG}}^{\lbrack\text{CNG}\rbrack}(j),j = j_{\text{min}}^{\lbrack\text{SID}\rbrack}(L_{\text{SID}}^{\lbrack\text{FFT}\rbrack}),\text{.}\text{.}\text{.},j_{\text{max}}^{\lbrack\text{SID}\rbrack}(L_{\text{SID}} - 1)$
corresponds to the CLDFB noise levels for frequencies above the core
bandwidth. For each CLDFB time slot, some random Gaussian noise of zero
mean and variance
$N_{\text{FD} - \text{CNG}}^{\lbrack\text{CNG}\rbrack}(j\frac{)}{2}$is
generated separately for the real and imaginary parts of the CLDFB
coefficients corresponding to frequencies above the core bandwidth.

##### 6.7.3.3.3 Comfort noise generation in the time domain

The FFT coefficients obtained after comfort noise generation in the
frequency domain are transformed by an inverse FFT, producing a CNG
time-domain signal of
length$L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack}$. This
signal is then windowed using a sine-based window that can be defined as
follow

$w\left( n \right) = 0$, for
$n = 0,\text{.}\text{.}\text{.},\frac{L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack}}{8} - 1$.
(1990)

$w\left( n \right) = \text{sin}\left\lbrack \left( n - \frac{L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack}}{8} + \frac{1}{2} \right)\frac{2\pi}{L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack}} \right\rbrack$,
for
$n = \frac{L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack}}{8},\text{.}\text{.}\text{.},\frac{3L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack}}{8} - 1$.
(1991)

$w\left( n \right) = 1$, for
$n = \frac{3L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack}}{8},\text{.}\text{.}\text{.},\frac{5L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack}}{8} - 1$.
(1992)

$w\left( n \right) = \text{sin}\left\lbrack \left( n - \frac{3L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack}}{8} + \frac{1}{2} \right)\frac{2\pi}{L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack}} \right\rbrack$,
for
$n = \frac{5L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack}}{8},\text{.}\text{.}\text{.},\frac{7L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack}}{8} - 1$.
(1993)

$w\left( n \right) = 0$, for
$n = \frac{7L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack}}{8},\text{.}\text{.}\text{.},L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack} - 1$.
(1994)

An overlap-add method is finally applied on the current windowed CNG
signal and the previous windowed CNG signal. The final FD-CNG frame
corresponds
to$n = \frac{L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack}}{8},\text{.}\text{.}\text{.},\frac{3L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack}}{8} - 1$.

To avoid discontinuities at transitions from active frames to inactive
frames, a cross-fading mechanism is employed. Several approaches are
described in the following subclauses, depending on the bitrate and the
previous encoding mode.

##### 6.7.3.3.3.1 Transitions from MDCT to FD-CNG at 9.6kbps, 16.4kbps and 24.4kbps {#transitions-from-mdct-to-fd-cng-at-9.6kbps-16.4kbps-and-24.4kbps .H6}

At 9.6 kbps, 16.4 kbps and 24.4 kbps and when the previous frame was
active and encoded with an MDCT-based coding mode, a cross-fading
operation is performed using the MDCT window.

First, the left part of the FD-CNG frame is not windowed after the
inverse FFT and there is no overlap-add operation with the previous
(missing) FD-CNG frame.

Instead, the left part of the FD-CNG frame is windowed using the
complementary version of the MDCT window used in the right part of the
previous MDCT-based frame (see subclause 6.2.4). An overlap-add method
is then applied on the MDCT-windowed FD-CNG frame and the previous
MDCT-based frame.

##### 6.7.3.3.3.2 Transitions from ACELP to FD-CNG at 9.6kbps, 16.4kbps and 24.4kbps {#transitions-from-acelp-to-fd-cng-at-9.6kbps-16.4kbps-and-24.4kbps .H6}

At 9.6 kbps, 16.4 kbps and 24.4 kbps and when the previous frame was
active and encoded with ACELP, a cross-fading operation is performed
using an extrapolation of the previous ACELP frame.

A random excitation with the same energy as the last half of the
excitation of the previous ACELP frame is computed

$\text{exc}\left( n \right) = \text{randn}\left( n \right)\sqrt{\frac{2\sum_{n = \frac{L_{\text{celp}}}{2}}^{L_{\text{celp}} - 1}{u^{'}\left( n \right)}}{\sum_{n = 0}^{L_{\text{celp}} - 1}{\text{rand}\left( n \right)}}},\ n = 0,\text{.}\text{.}\text{.},L_{\text{celp}} - 1$
(1995)

where $u^{'}\left( n \right)$ is the total excitation of the previous
ACELP frame (see subclause 6.1.1.2), $\text{rand}(n)$ is a random
Gaussian noise with zero mean and
$L_{\text{celp}} = \frac{L_{\text{FFT}}^{\lbrack\text{FD} - \text{CNG}\rbrack}}{2}$
is the length of the ACELP frame.

The random excitation $\text{exc}\left( n \right)$ is then filtered
through the same LPC synthesis filter and de-emphasis filter as used in
the last subframe of the previous ACELP frame (see subclause 6.1.3),
producing the extrapolated ACELP signal.

Finally the extrapolated ACELP signal is windowed and the overlap-add
method is applied as if the extrapolated ACELP signal was the previous
FD-CNG frame.

##### 6.7.3.3.3.3 Transitions from active to FD-CNG at bitrates\<=8kbps and at 13.2kbps {#transitions-from-active-to-fd-cng-at-bitrates8kbps-and-at-13.2kbps .H6}

At bitrates\<=8 kbps and at 13.2 kbps, a FD-CNG frame is converted to a
combination of an excitation signal and a set of LPC coefficients. It
then becomes very similar to a LP-CNG frame, and can be further
processed as such.

First, the left part of the FD-CNG frame is not windowed after the
inverse FFT and there is no overlap-add operation with the previous
(missing) FD-CNG frame.

The time-domain FD-CNG signal is then pre-emphasized and filter through
the LP analysis filter
$a_{\text{FD} - \text{CNG}}\left( n \right),\ n = 0,\text{.}\text{.}\text{.},\text{16}$
(see subclause 6.7.3.1.3), producing an excitation signal.

The set of LPC coefficients associated with the excitation
is$a_{\text{FD} - \text{CNG}}\left( n \right),\ n = 0,\text{.}\text{.}\text{.},\text{16}$.
These LPC coefficients are then used to synthesize the final CNG signal
using the excitation and the filter memories from the previous frame, as
it is done in LP-CNG.

##### 6.7.3.3.4 FD-CNG decoder memory update

The LPC coefficients
$a_{\text{FD} - \text{CNG}}\left( n \right),\ n = 0,\text{.}\text{.}\text{.},\text{16}$
are converted to LSP and to LSF. The LPC, LSP and LSF are then used to
update all LPC/LSP/LSF-related memories.

The FD-CNG time-domain output is used to update all signal domain
memories.

The FD-CNG time-domain signal is pre-emphasized and the pre-emphasized
signal is then used to update all pre-emphasized signal domain memories.

The pre-emphasized signal is filtered through the LP analysis filter
$a_{\text{FD} - \text{CNG}}\left( n \right),\ n = 0,\text{.}\text{.}\text{.},\text{16}$
and the obtained residual is then used to update all excitation domain
memories.

All the other memories are updated similarly to LP-CNG (see subclause
6.7.2.2).
