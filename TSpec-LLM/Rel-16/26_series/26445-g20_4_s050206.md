### 5.2.6 Coding of upper band for LP-based Coding Modes

#### 5.2.6.1 Bandwidth extension in time domain

The time-domain bandwidth extension (TBE) module codes the signal
content beyond the range of frequencies that are coded by the low band
core encoder. The inaccuracies in the representation of the spectral and
the temporal information content at higher frequencies in a speech
signal are masked more easily than contents at lower frequencies.
Consequently, TBE manages to encode the spectral regions beyond what is
coded by the core encoder in speech signals with far fewer bits than
what is used by the core encoder.

The TBE algorithm is used for coding the high band of clean and noisy
speech signals when the low band is coded using the ACELP core. The
input time domain signal of current frame is divided into two parts: the
low band signal and the super higher band (SHB) signal for SWB signal
($S_{\text{HB}}^{\text{Tar}}(n)$) or the higher band (HB) signal for WB
signal ($S_{\text{HB}}^{\text{Tar}}(n)$). While the SWB TBE encoding of
upper band (6.4 to 14.4 kHz or 8 to 16 kHz) is supported at bitrates 9.6
kbps, 13.2 kbps, 16.4 kbps, 24.4 kbps, and 32 kbps; the WB TBE encoding
of upper band (6 to 8 kHz) is supported at 9.6 kbps and 13.2 kbps.
Specifically, at 13.2 kbps and 32 kbps the SWB TBE algorithm is employed
as the bandwidth extension algorithm when the speech/music classifier
determines that the current frame of signal is active speech or when GSC
coding is selected to encode super wideband noisy speech. Similarly, at
9.6 kbps, 16.4 kbps and 24.4 kbps the TBE algorithm is used to perform
bandwidth extension for all ACELP frames. The ACELP/MDCT core coder
selection at 9.6 kbps, 16.4 kbps and 24.4 kbps is based on an open-loop
decision as described in subclause 5.1.14.1.

In coding the higher frequency bands that extend beyond the narrowband
frequency range, bandwidth extension techniques exploit the inherent
relationship between the signal structures in these bands. Since the
fine signal structure in the higher bands are closely related to that in
the lower band, explicit coding of the fine structure of the high band
is avoided. Instead, the fine structure is extrapolated from the low
band. The high level architecture of the TBE encoder is shown in figure
1 below. The front end processing to generate the high band target
signal in figure 2, is replaced by a simple flip-and-decimate-by-4
operation in the WB TBE framework.

![](media/image1.wmf){width="6.688888888888889in"
height="4.658333333333333in"}

Figure 44: Time Domain Bandwidth Extension Encoder. Blocks in dashed
lines are activated only at higher bit rates (24.4 kb/s or higher)

##### 5.2.6.1.1 High band target signal generation

The input speech signal,
![](media/image2.wmf){width="0.4409722222222222in"
height="0.23333333333333334in"}, that is sampled at either 32 kHz or 48
kHz sampling frequency, is processed through the QMF analysis filter
bank. This processing step is performed as part of the common processing
step as described in subclause 5.1. The output of the QMF analysis
filter bank, ![](media/image3.wmf){width="0.6in"
height="0.20694444444444443in"} and
![](media/image4.wmf){width="0.5666666666666667in"
height="0.20694444444444443in"} are the real and imaginary sub-band
values, respectively,
![](media/image5.wmf){width="9.861111111111111e-2in" height="0.15in"} is
the sub-band time index with
![](media/image6.wmf){width="0.5666666666666667in"
height="0.1673611111111111in"} and
![](media/image7.wmf){width="0.12569444444444444in"
height="0.18263888888888888in"} is sub-band frequency band index with
![](media/image8.wmf){width="0.6416666666666667in"
height="0.20694444444444443in"}. The number of sub-bands,
![](media/image9.wmf){width="0.9986111111111111in"
height="0.20694444444444443in"}, where *F~s~* is the sample rate of the
input signal, ![](media/image10.wmf){width="0.4583333333333333in"
height="0.23333333333333334in"}. For example, for a SWB 32 kHz sampled
input, *L~c~* = 40, and for a FB 48 kHz sampled input, *L~c~* = 60
sub-bands.

The spectral flip and down mix module extracts the high band components
from the input speech signal. The high band target signal contains the
high frequency components of the input signal that are to be represented
by the time domain bandwidth extension encoder. The frequency range of
the high band depends on the coding bandwidth of the low band ACELP
core. When the low band ACELP core codes up to a maximum bandwidth of
6.4 kHz, then the high band target signal,
![](media/image11.wmf){width="0.4826388888888889in"
height="0.20694444444444443in"}, contains input signal components in the
6.4 \-- 14.4 kHz band. When the low band ACELP core codes up to a
maximum bandwidth of 8 kHz, then the high band target signal contains
input signal components in the 8 \-- 16 kHz band. In the high band
target signal, ![](media/image12.wmf){width="0.4826388888888889in"
height="0.20694444444444443in"}, the input signal components are
arranged in a flipped and down-mixed format such that the 0 frequency
value in the SWB high band target signal corresponds to the maximum
frequency in the above mentioned bandwidth. The process of deriving the
SWB high band target signal is shown pictorially in figure 45.

Figure 46: Generation of high band target signal for SWB TBE

Similarly, the WB high band target signal containing signal components
from 6 to 8 kHz is generated as shown in figure 47. In particular, a
simple flip-and-decimate-by-4 operation is performed to extract the 6 to
8 kHz high band from the 16 kHz sampled WB input signal. In case of
fixed point operation, the input signal is scaled dynamically based on
the spectral tilt of the input signal prior to performing the
flip-and-decimate-by-4 operation. This adjustment of the scaling is done
such that for signals with low energy in the high band (indicated by
having a spectral tilt \>= 0.95), no headroom is provided prior to
decimation to avoid any loss of precision after decimation, and for
signals with relatively higher energy in the high band (indicated by
having a spectral tilt \< 0.95), a headroom of 3 bits is provided prior
to decimation to avoid any saturation in the decimation operation.

![](media/image14.wmf){width="3.6729166666666666in"
height="1.6333333333333333in"}

Figure 48: Generation of high band target signal for WB TBE

The process of deriving the SWB high band target signal using the
complex low-delay filter bank (CLDFB) analysis is described below. The
real, ![](media/image15.wmf){width="0.5819444444444445in"
height="0.20694444444444443in"}, and imaginary,
![](media/image16.wmf){width="0.5666666666666667in"
height="0.20694444444444443in"}, CLDFB coefficients are first flipped as
follows:

$\begin{matrix}
\begin{matrix}
{\hat{X}}_{\text{CR}}(t,k) = - ( - 1)^{\text{tM}}X_{\text{CR}}(t,M - k) \\
{\hat{X}}_{\text{CI}}(t,k) = ( - 1)^{\text{tM}}X_{\text{CI}}(t,M - k) \\
\end{matrix} & \text{for}\ 0 \leq t < L_{C},\  \\
\end{matrix}0 \leq k < M - m$ (664)

The values *m* and *M* are dependent on the maximum bandwidth coded by
the ACELP core as shown in table 1. The flipped coefficients,
![](media/image17.wmf){width="0.6in" height="0.23333333333333334in"} and
![](media/image18.wmf){width="0.5819444444444445in"
height="0.23333333333333334in"}are used to generate the high band target
signal using the CLDFB synthesis as described in subclause 6.9.3.

Table 52: Maximum and minimum frequencies for spectral flipping and
downmix

  --------------------------- -------------------------- ---- ------------------------------ -------------- --
  ACELP core                  m                          M    High band target signal band                  
  Low band core sample rate   Low band coded bandwidth                                                      
  \@12.8 kHz core             6.4 kHz                    14   34                             6.4-14.4 kHz   
  @ 16 kHz core               8 kHz                      19   39                             8-16 kHz       
  \@12.8 kHz core             6.4 kHz                    \-   \-                             6-8 kHz (WB)   
  --------------------------- -------------------------- ---- ------------------------------ -------------- --

##### 5.2.6.1.2 TBE LP analysis

TBE linear prediction analysis is performed on a 33.75ms high band
signal that includes the current 20ms SHB target frame with 5ms of past
samples and 8.75ms of look ahead samples. The SWB high band target
signal ![](media/image11.wmf){width="0.4826388888888889in"
height="0.20694444444444443in"} is generated using the CLDFB synthesis
filter bank described in subclause 6.9.3. Twenty milliseconds of the
high band target signal is used to populate the shb\_old\_speech buffer
from sample 220 to sample 539 as shown in figure 49 . Both the WB TBE
and SWB TBE LP analysis follow similar steps as described below except
that the buffer lengths in SWB TBE and WB TBE are different reflecting
the effective upper band coding bandwidth. Certain steps that are
relevant at low bit rates and only for WB TBE and not for SWB TBE LP
analysis are specified where applicable.

![](media/image19.wmf){width="4.480555555555555in"
height="3.2305555555555556in"}

Figure 47: SWB Highband target signal buffers

The first 220 samples in the shb\_old\_speech buffer are filled from the
memory shb\_old\_speech\_mem. The shb\_old\_speech\_mem is updated as

![](media/image20.wmf){width="4.016666666666667in"
height="0.20694444444444443in"} (665)

For linear prediction analysis, a 540 sample LPC analysis frame is
derived from the shb\_old\_speech buffer. A single analysis window
![](media/image21.wmf){width="1.2236111111111112in"
height="0.20694444444444443in"}, is used to calculate 10 auto
correlation coefficients. The window function is as shown in figure 50

![](media/image22.wmf){width="5.110416666666667in"
height="2.6069444444444443in"}

Figure 51: SWB TBE analysis window

The autocorrelation coefficients
![](media/image23.wmf){width="0.5006944444444444in"
height="0.24861111111111112in"} is calculated according to

![](media/image24.wmf){width="2.807638888888889in"
height="0.5423611111111111in"} (666)

where $s_{w}^{\text{SHB}}(n)$ is obtained by multiplying
$S_{\text{HB}}^{\text{Tar}}(n)$by $W_{\text{SHB}}(n)$.

A bandwidth expansion is applied to the autocorrelation coefficients by
multiplying the coefficients by the expansion function:

![](media/image25.wmf){width="2.3069444444444445in"
height="0.24861111111111112in"} (667)

The bandwidth expanded autocorrelation coefficients are used to obtain
LP filter coefficients,
![](media/image26.wmf){width="1.148611111111111in"
height="0.26666666666666666in"} by solving the following set of
equations using the Levinson-Durbin algorithm.

![](media/image27.wmf){width="2.582638888888889in"
height="0.5423611111111111in"} (668)

It should be noted that
![](media/image28.wmf){width="0.5666666666666667in"
height="0.26666666666666666in"}

##### 5.2.6.1.3 Quantization of linear prediction parameters

First a spectral bandwidth expansion operation is performed on the LPC
coefficients by multiplying
![](media/image29.wmf){width="0.3506944444444444in"
height="0.24861111111111112in"} with bandwidth expansion weights
![](media/image30.wmf){width="0.4826388888888889in"
height="0.24861111111111112in"}

![](media/image31.wmf){width="2.0006944444444446in"
height="0.24861111111111112in"} (669)

The ![](media/image32.wmf){width="0.5006944444444444in"
height="0.26666666666666666in"} coefficients are given in table 53:

Table 54: LPC bandwidth expansion coefficients

  ------- ---------- ------------- ------------- ------------- ------------- -------------- ------------- ------------- -------------
  k                                                                                                                     
  2       3          4             5             6             7             8              9             10            11
  0.975   0.950625   0.926859375   0.903687891   0.881095693   0.859068301   0.837591593f   0.816651804   0.796235509   0.776329621
  ------- ---------- ------------- ------------- ------------- ------------- -------------- ------------- ------------- -------------

The bandwidth expansion of LP coefficients is performed in WB TBE LP
analysis and low bitrate SWB TBE analysis for bit rates below 13.2 kbps.
The bandwidth expanded LP coefficients
![](media/image33.wmf){width="0.9833333333333333in"
height="0.24861111111111112in"} are converted to line spectral
frequencies ![](media/image34.wmf){width="1.0256944444444445in"
height="0.24861111111111112in"}

The LSP weights ![](media/image35.wmf){width="0.35694444444444445in"
height="0.24861111111111112in"} are calculated from the line spectral
frequencies ![](media/image36.wmf){width="0.35694444444444445in"
height="0.24861111111111112in"}

![](media/image37.wmf){width="2.015972222222222in"
height="0.5666666666666667in"} (670)

And based on the spacing between adjacent LSF parameters,
![](media/image38.wmf){width="0.1673611111111111in"
height="0.20694444444444443in"} and
![](media/image39.wmf){width="0.18263888888888888in"
height="0.20694444444444443in"}

![](media/image40.wmf){width="1.9736111111111112in"
height="0.4826388888888889in"} (671)

![](media/image41.wmf){width="1.7909722222222222in"
height="0.4826388888888889in"} (672)

where ![](media/image42.wmf){width="1.1909722222222223in"
height="0.20694444444444443in"} and
![](media/image43.wmf){width="0.5576388888888889in"
height="0.20694444444444443in"}, otherwise.

##### 5.2.6.1.3.1 LSF quantization {#lsf-quantization .H6}

WB TBE LSF quantization uses a single stage vector quantizer that
utilizes 2 bits and 8 bits for LSF quantization, respectively, at 9.6
kbps and at 13.2 kbps. For low bit rate SWB LSF quantization at 9.6 kbps
and primary frame encoding in channel aware mode at 13.2 kbps (see
subclause 5.8.3.1), a simple 8-bit 10-dimensional single stage vector
quantizer is used. In SWB TBE encoding, for bit rates at and above 13.2
kbps, the 10 dimensional LSF
vector![](media/image44.wmf){width="1.1423611111111112in"
height="0.24861111111111112in"}is encoded in a SQ and extrapolation
procedure. The low-frequency half (first five LSF coefficents
![](media/image45.wmf){width="1.082638888888889in"
height="0.24861111111111112in"}) of the LSF vector are scalar quantized
with the following number of bits {4, 4, 3, 3, 3}. That is the first two
coefficents are quantized with four bits each, with the CB from table
55, while the remaining three coefficients are quantized with three bits
each with reconstruction values in table 56.

Table 57: Four bit CB for LSF quantization

  ------- ------------
  Index   Value
  0000    0.01798018
  0001    0.02359377
  0010    0.02790103
  0011    0.03181538
  0100    0.03579450
  0101    0.03974377
  0110    0.04364637
  0111    0.04754591
  1000    0.05181858
  1001    0.05624165
  1010    0.06022101
  1011    0.06419064
  1100    0.06889389
  1101    0.07539274
  1110    0.08504436
  1111    0.10014875
  ------- ------------

Table 58: Three bit CB for LSF quantization

  ------- ------------
  Index   Value
  000     0.02070812
  001     0.02978384
  010     0.03800822
  011     0.04548685
  100     0.05307309
  101     0.06137543
  110     0.07216742
  111     0.09013262
  ------- ------------

The output of the SQ is five quantized coefficients
![](media/image46.wmf){width="1.082638888888889in"
height="0.24861111111111112in"}, which are also used as an input to
extrapolation of the remaining five coefficients.

The high-frequency half (last five LSF coefficents
![](media/image47.wmf){width="1.148611111111111in"
height="0.24861111111111112in"}) are calculated as weighted averaging of
the quantized low-frequency part of the LSF vector and selected optimal
grid points. First the already quantized coefficents are flipped arround
a quantized mirroring frequency, which separates the low-frequency part
from the high-frequency part of the LSF vector. Then the the fipped
coefficients are adjusted by an optimal frequency grid codebook, which
is obtained in a closed-loop search procedure.

The transmitted mirroring frequency
![](media/image48.wmf){width="0.15in" height="0.18263888888888888in"} is
obtained as quantized difference between the first extrapolated and last
quantized coefficient, added to the last coded position

![](media/image49.wmf){width="1.667361111111111in"
height="0.24861111111111112in"} (673)

The quantization is performed with two bit SQ with reconstruction points
{0.01436178, 0.02111641, 0.02735687, 0.03712105}.

The quanized five low-frequency LSF coefficents
![](media/image50.wmf){width="1.0256944444444445in"
height="0.24861111111111112in"} are flipped arround the mirroring
frequency ![](media/image48.wmf){width="0.15in"
height="0.18263888888888888in"}, to form a set of flipped coefficients
![](media/image51.wmf){width="0.35694444444444445in"
height="0.24861111111111112in"}

![](media/image52.wmf){width="1.9826388888888888in"
height="0.26666666666666666in"} (674)

Then the flipped coefficients are further scaled according to

![](media/image53.wmf){width="3.248611111111111in"
height="0.6506944444444445in"} (675)

The flip and scaled coefficients
![](media/image54.wmf){width="0.35694444444444445in"
height="0.24861111111111112in"}are adjusted with one of four grid
vectors. The pre-stored set of four grid vectors
![](media/image55.wmf){width="0.8159722222222222in"
height="0.20694444444444443in"}from table 59, is first re-scaled to fit
into the interval between the last quantized LSF
![](media/image56.wmf){width="0.35694444444444445in"
height="0.24861111111111112in"} and maximum grid point value 0.5

![](media/image57.wmf){width="3.0in" height="0.26666666666666666in"}
(676)

Table 56: CB with LSF grid points

  ------------ ------------ ------------ ------------
  grid 1       grid 2       grid 3       grid 4
  0.15998503   0.15614473   0.14185823   0.15416561
  0.31215086   0.30697672   0.26648724   0.27238427
  0.47349756   0.45619822   0.39740108   0.39376780
  0.66540429   0.62493785   0.55685745   0.59287916
  0.84043882   0.77798001   0.74688616   0.86613986
  ------------ ------------ ------------ ------------

Then smoothed coefficients ![](media/image58.wmf){width="0.375in"
height="0.26666666666666666in"} are obtained by weighed averaging of the
re-scaled grid sets ![](media/image59.wmf){width="0.26666666666666666in"
height="0.225in"} and re-scaled flipped coefficients
![](media/image60.wmf){width="0.35694444444444445in"
height="0.24861111111111112in"}

![](media/image61.wmf){width="2.9819444444444443in"
height="0.26666666666666666in"} (677)

where ![](media/image62.wmf){width="0.19166666666666668in"
height="0.20694444444444443in"} are pre-defined weights
![](media/image63.wmf){width="1.8569444444444445in"
height="0.20694444444444443in"}

Different grid vectors
![](media/image64.wmf){width="0.1673611111111111in"
height="0.20694444444444443in"} form different sets of smoothed
coefficients ![](media/image65.wmf){width="0.375in"
height="0.26666666666666666in"}. The optimal grid is selected as the one
that produces smoothed coefficients
![](media/image66.wmf){width="0.375in" height="0.26666666666666666in"}
closest, in the mean-squared-error sense, to the actual high-frequency
coefficients ![](media/image67.wmf){width="1.0256944444444445in"
height="0.24861111111111112in"}

![](media/image68.wmf){width="2.1in" height="0.5423611111111111in"}
(678)

The CB indices for the five low-frequency coefficients, mirroring
frequency index, and the index of the optimal grid are transmitted to
the decoder.

The quantized LSF parameters
![](media/image69.wmf){width="0.35694444444444445in"
height="0.24861111111111112in"} are checked for inter-LSF spacing.
First, the spacing between adjacent LSFs is determined

![](media/image70.wmf){width="2.0006944444444446in"
height="0.7319444444444444in"} (679)

If ![](media/image71.wmf){width="1.0583333333333333in"
height="0.20694444444444443in"}, then the quantized LSFs are adjusted as
follows

If ![](media/image72.wmf){width="0.3506944444444444in"
height="0.18263888888888888in"}, then

![](media/image73.wmf){width="1.9409722222222223in"
height="0.24861111111111112in"}.

If ![](media/image74.wmf){width="0.39861111111111114in"
height="0.18263888888888888in"}, then

![](media/image75.wmf){width="1.9409722222222223in"
height="0.24861111111111112in"}.

Otherwise,

![](media/image76.wmf){width="2.3069444444444445in"
height="0.4583333333333333in"}

##### 5.2.6.1.4 Interpolation of LSF coefficients

The quantized LSF parameters
![](media/image77.wmf){width="0.35694444444444445in"
height="0.24861111111111112in"} are converted into LSPs
![](media/image78.wmf){width="0.35694444444444445in"
height="0.24861111111111112in"}

![](media/image79.wmf){width="1.35in" height="0.24861111111111112in"}
(680)

The interpolation between the LSPs of the current frame,
![](media/image80.wmf){width="0.35694444444444445in"
height="0.24861111111111112in"}, and that of the previous frame
![](media/image81.wmf){width="0.5819444444444445in"
height="0.24861111111111112in"} is performed to a set of 4 interpolated
LSPs, ![](media/image82.wmf){width="1.2659722222222223in"
height="0.24861111111111112in"} as follows:

![](media/image83.wmf){width="4.106944444444444in"
height="0.24861111111111112in"} (681)

The interpolated LSPs are then converted back to LSFs. This process
gives 4 sets of interpolated LSFs![](media/image84.wmf){width="1.275in"
height="0.24861111111111112in"}. Further the LSFs are converted into LP
coefficients ![](media/image85.wmf){width="1.8506944444444444in"
height="0.24861111111111112in"}. Note
![](media/image86.wmf){width="0.7076388888888889in"
height="0.24861111111111112in"} for all *j*. The conversion from the
interpolated LSFs to LP coefficients is done similar to the process
employed in the core coding modules.

##### 5.2.6.1.4.1 LSP Interpolation at 13.2 kbps and 16.4 kbps {#lsp-interpolation-at-13.2-kbps-and-16.4-kbps .H6}

LSP interpolation is employed to smooth the SWB TBE LSP parameters at
13.2 kbps and 16.4 kbps. When the bit rate of operation is 13.2 kbps or
16.4 kbps, the similarity of signal characteristics of the current frame
and the previous frame are analysed to determine whether they meet the
Preset Modification Conditions (PMCs) or not. The PMCs denote if the
PMCs are met, then a first set of correction weights are determined from
the Linear Spectral Frequency (LSF) differences of the current frame and
the LSF differences of the previous frame. Otherwise a second set of
correction weights are set with constant values that lie in the range
0.0 to 1.0. The LSPs are then interpolated using the appropriate set of
correction weights. The PMCs are used to determine whether the signal
characteristic of the current frame and the previous frame is close or
not.

The PMCs are determined by first converting the linear prediction
coefficients (LPCs) to reflection coefficients (RCs) as follows using a
backwards Levinson Durbin recursion. For a given N-th order LPC
vector![](media/image87.wmf){width="1.5416666666666667in"
height="0.24861111111111112in"} the Nth reflection coefficient value is
derived using the
equality![](media/image88.wmf){width="0.9833333333333333in"
height="0.24861111111111112in"}, it is then possible to calculate the
lower order LPC vectors
![](media/image89.wmf){width="1.0256944444444445in"
height="0.20694444444444443in"}using the following recursion.

![](media/image90.wmf){width="2.5409722222222224in"
height="0.9986111111111111in"} (682)

which yields the reflection coefficient vector
![](media/image91.wmf){width="1.4423611111111112in"
height="0.20694444444444443in"}.

A spectral tilt parameter
![](media/image92.wmf){width="0.6083333333333333in"
height="0.19166666666666668in"} is then calculated from the first
reflection coefficient
![](media/image93.wmf){width="0.39861111111111114in"
height="0.20694444444444443in"} as follows:

![](media/image94.wmf){width="4.6409722222222225in"
height="0.20694444444444443in"} (683)

The PMCs are then determined from the spectral tilts of the current
frame and the previous frame along with the coding types of the current
and the previous frames. In the case that the current frame is a
transition frame, the PMCs are by default not met.

In order to determine that the current frame is not a transition frame
requires the following steps:

1)  Determining whether there is a change from a fricative frame to a
    non-fricative frame. Specifically, if the tilt of the previous frame
    is greater than a tilt threshold value of 5.0 and the coder type of
    the frame is a transient, or the tilt of the previous frame is
    greater than a tilt threshold value of 5.0 and the tilt of the
    current frame is smaller than a tilt threshold value of 1.0 then the
    frame is a transition frame.

2)  Determining whether there is a change from a non-fricative frame to
    a fricative frame. Specifically, if the tilt of the previous frame
    is smaller than a tilt threshold value of 3.0 and the coder type of
    the previous frame is equal to one of the four types of VOICED,
    GENERIC, TRANSITION or AUDIO, and the tilt of the current frame is
    greater than a tilt threshold value of 5.0 then again the frame is a
    transition frame

3)  The current frame is not a transition frame if both 1) and 2) are
    not met, and then the PMCs are met.

When the PMCs are met, the first set of correction weights are defined
as follows

![](media/image95.wmf){width="4.316666666666666in"
height="0.7916666666666666in"} (684)

where the ![](media/image96.wmf){width="1.275in"
height="0.27569444444444446in"} and
![](media/image97.wmf){width="1.2506944444444446in"
height="0.27569444444444446in"} are defined as

![](media/image98.wmf){width="3.017361111111111in"
height="0.7319444444444444in"} (685)

![](media/image99.wmf){width="2.792361111111111in"
height="0.7319444444444444in"} (686)

where the![](media/image100.wmf){width="0.9986111111111111in"
height="0.26666666666666666in"} are the LSFs of the current frame and
the ![](media/image101.wmf){width="0.9833333333333333in"
height="0.26666666666666666in"}are the LSFs of the previous frame.

When the PMCs are not met, the second set of correction weights is used
and these are set to 0.5 as follows:

![](media/image102.wmf){width="1.4819444444444445in"
height="0.20694444444444443in"} (687)

![](media/image103.wmf){width="2.5256944444444445in"
height="0.4826388888888889in"} (688)

The correction weights
![](media/image104.wmf){width="0.8909722222222223in"
height="0.19166666666666668in"}are finally used in the interpolation
between the LSPs of the current frame and the LSPs of the previous
frame, it is described as follows:

${\hat{\sigma}}_{k}^{\text{SHB}} = (1 - w(k)) \ast \hat{\sigma}\text{prev}_{k}^{\text{SHB}} + w(k) \ast \hat{\sigma}\text{curr}_{k}^{\text{SHB}},k = 0,\text{.}\text{.}\text{.},9$
(689)

where ![](media/image105.wmf){width="1.1819444444444445in"
height="0.24861111111111112in"} are the LSPs of the previous frame,
![](media/image106.wmf){width="1.2236111111111112in"
height="0.29097222222222224in"}are the LSPs of the current frame,
![](media/image107.wmf){width="0.9569444444444445in"
height="0.29097222222222224in"}are the interpolated LSPs. The
interpolated LSPs are used to encode the current frame.

The interpolated LSPs are then converted back to LSFs，further the LSFs
are converted into LP coefficients.

##### 5.2.6.1.4.2 LSP Interpolation at 24.4 kbps and 32 kbps {#lsp-interpolation-at-24.4-kbps-and-32-kbps .H6}

The interpolation between the LSPs of the current frame,
![](media/image80.wmf){width="0.35694444444444445in"
height="0.24861111111111112in"}, and that of the previous frame
![](media/image81.wmf){width="0.5819444444444445in"
height="0.24861111111111112in"} is performed to yield a set of 4
interpolated LSPs, ![](media/image82.wmf){width="1.2659722222222223in"
height="0.24861111111111112in"} as follows:

![](media/image83.wmf){width="4.106944444444444in"
height="0.24861111111111112in"} (690)

Table 57: LSP interpolation factors IC1 and IC2 over four sets

  ------------ ----- -----
  LSP set, j   IC1   IC2
  Set 1        0.7   0.3
  Set 2        0.4   0.6
  Set 3        0.1   0.9
  Set 4        0     1.0
  ------------ ----- -----

The interpolated LSPs are then converted back to LSFs. This process
gives 4 sets of interpolated LSFs![](media/image84.wmf){width="1.275in"
height="0.24861111111111112in"}. Further the LSFs are converted into LP
coefficients![](media/image85.wmf){width="1.8506944444444444in"
height="0.24861111111111112in"}. Note
![](media/image86.wmf){width="0.7076388888888889in"
height="0.24861111111111112in"} for all *j*.

##### 5.2.6.1.5 Target and residual energy calculation and quantization

At 24.4 kb/s and 32 kb/s, energy parameters from the high band target
frame and an LPC residual calculated from the target signal and the
interpolated LP coefficients,
![](media/image108.wmf){width="0.5819444444444445in"
height="0.28194444444444444in"}, are calculated and transmitted to the
decoder.

For calculation of the energy parameters, the signal in the high band
target frame (see figure 52), denoted as
![](media/image109.wmf){width="0.5486111111111112in"
height="0.28194444444444444in"} is used. The 4 energy parameters are
calculated according to:

![](media/image110.wmf){width="2.1173611111111112in"
height="0.5576388888888889in"} (691)

The sum of energy parameters,
![](media/image111.wmf){width="0.6923611111111111in" height="0.375in"},
is quantized using 6 bits in SWB TBE at 24.4 kbps and 32 kbps. A
residual signal ![](media/image112.wmf){width="0.525in"
height="0.28194444444444444in"} is calculated from
![](media/image113.wmf){width="0.5486111111111112in"
height="0.28194444444444444in"} using the interpolated LP
coefficients![](media/image114.wmf){width="0.5819444444444445in"
height="0.28194444444444444in"}. For j=1, ...4 and n=0,...79,

![](media/image115.wmf){width="3.998611111111111in" height="0.6in"}
(692)

The residual signal is then used to calculate the residual energy
parameters,![](media/image116.wmf){width="0.9986111111111111in"
height="0.20694444444444443in"}

![](media/image117.wmf){width="1.65in" height="0.5576388888888889in"}
(693)

The residual energy parameters are then normalized. First the maximum
residual energy parameter is calculated
![](media/image118.wmf){width="1.35in" height="0.20694444444444443in"} .
Then ![](media/image119.wmf){width="0.42569444444444443in"
height="0.20694444444444443in"} is normalized to get
![](media/image120.wmf){width="0.42569444444444443in"
height="0.24861111111111112in"} as per

![](media/image121.wmf){width="1.1576388888888889in" height="0.45in"}
(694)

Each ![](media/image122.wmf){width="0.4409722222222222in"
height="0.24861111111111112in"}is then scalar quantized using a 3 bit
uniform quantizer with the lowest quantization point as 0.125 and
uniform quantization steps of 0.125.

##### 5.2.6.1.6 Generation of the upsampled version of the lowband excitation

An upsampled version of the low band excitation signal is derived from
the ACELP core as show in figure 53 below.

![](media/image123.wmf){width="5.422916666666667in"
height="1.4430555555555555in"}

Figure 54: Generating the upsampled version of the lowband excitation

For each ACELP core coding subframe, *i*, a random noise scaled by a
factor voice factor,
![](media/image124.wmf){width="0.20694444444444443in"
height="0.20694444444444443in"} is first added to the fixed codebook
excitation that is generated by the ACELP core encoder. The voice factor
is determined using the subframe maximum normalized correlation
parameter, ![](media/image125.wmf){width="0.225in"
height="0.20694444444444443in"} that is derived during the ACELP
encoding. First the ![](media/image126.wmf){width="0.1736111111111111in"
height="0.20694444444444443in"} factors are combined to generate
![](media/image127.wmf){width="0.20694444444444443in"
height="0.20694444444444443in"}.

![](media/image128.wmf){width="2.1326388888888888in"
height="0.24861111111111112in"} (695)

![](media/image129.wmf){width="0.20694444444444443in"
height="0.20694444444444443in"} calculated above is limited to a maximum
of 1 and a minimum of 0.

![](media/image130.wmf){width="2.732638888888889in"
height="0.20694444444444443in"} if the ACELP core encodes a maximum of
6.4 KHz or ![](media/image131.wmf){width="0.6833333333333333in"
height="0.1673611111111111in"} if the ACELP core encodes a maximum
bandwidth of 8 KHz.

The resampled output is scaled by the ACELP fixed codebook gain and
added to a delayed version of itself.

$\varepsilon\left( n \right) = g_{c} \times \varepsilon_{2}\left( n \right) + g_{p} \times \varepsilon\left( n - \text{βP} \right)$
(696)

where g~c~ is the subframe ACELP fixed codebook gain, g~p~ is the
subframe ACELP adaptive codebook gain and P is the open loop pitch lag.

##### 5.2.6.1.7 Non-Linear Excitation Generation

The excitation signal
![](media/image132.wmf){width="0.27569444444444446in"
height="0.20694444444444443in"} is processed through a non-linear
function in order to extend the pitch harmonics in the low band signal
into the high band. The non-linear processing is applied to a frame of
![](media/image133.wmf){width="0.27569444444444446in"
height="0.20694444444444443in"} in two stages; the first stage works on
the first half subframe (160 samples) of
![](media/image134.wmf){width="0.27569444444444446in"
height="0.20694444444444443in"} and the second stage works on the second
half subframe. The non-linear processing steps for the two stages are
described below. In the first stage
![](media/image135.wmf){width="0.8909722222222223in"
height="0.20694444444444443in"}, and in the second stage,
![](media/image136.wmf){width="1.0256944444444445in"
height="0.20694444444444443in"}.

First, the maximum amplitude sample
![](media/image137.wmf){width="0.30833333333333335in"
height="0.20694444444444443in"} and its location relative to the first
sample in the stage
![](media/image138.wmf){width="0.27569444444444446in"
height="0.20694444444444443in"} are determined.

![](media/image139.wmf){width="3.566666666666667in"
height="0.23333333333333334in"} (696)

Based on the value of
![](media/image140.wmf){width="0.30833333333333335in"
height="0.20694444444444443in"}, the scale factor
![](media/image141.wmf){width="0.18263888888888888in"
height="0.20694444444444443in"} is determined.

![](media/image142.wmf){width="1.275in" height="0.6in"} (697)

The scale factor ![](media/image143.wmf){width="0.20694444444444443in"
height="0.21597222222222223in"} and the previous scale factor parameter
from the memory ![](media/image144.wmf){width="0.3659722222222222in"
height="0.25763888888888886in"} are then used to determine the parameter
scale step![](media/image145.wmf){width="0.20694444444444443in"
height="0.15833333333333333in"}.

![](media/image146.wmf){width="2.192361111111111in"
height="0.6986111111111111in"} (698)

If ![](media/image147.wmf){width="0.6in"
height="0.23333333333333334in"}, then
![](media/image148.wmf){width="0.6326388888888889in"
height="0.23333333333333334in"}

The output of the non-linear processing
![](media/image149.wmf){width="0.42569444444444443in"
height="0.20694444444444443in"} is derived as per

![](media/image150.wmf){width="3.182638888888889in"
height="0.5333333333333333in"} (699)

If the current frame is VOICED frame and sum of voice factors over the
subframes is less than a threshold,
![](media/image151.wmf){width="0.225in" height="0.1673611111111111in"},
then the sign reversal when
![](media/image152.wmf){width="0.4826388888888889in"
height="0.20694444444444443in"} is not performed. The threshold,
![](media/image153.wmf){width="0.225in" height="0.1673611111111111in"}=
0.70 when there are five subframes per frame and
![](media/image153.wmf){width="0.225in" height="0.1673611111111111in"}=
0.78 when there are four subframes per frame.

The previous scale factor parameter is updated recursively for all
![](media/image154.wmf){width="0.4826388888888889in"
height="0.20694444444444443in"} according to

for(j=n~1~; j\< n~2~; j++)

if(j\<i~max~)

![](media/image155.wmf){width="0.3659722222222222in"
height="0.25763888888888886in"}=![](media/image156.wmf){width="0.6659722222222222in"
height="0.25763888888888886in"}

end

end

##### 5.2.6.1.8 Spectral flip of non-linear excitation in time domain

The non-linear excitation
![](media/image157.wmf){width="0.4583333333333333in"
height="0.20694444444444443in"} is spectrally flipped so that the high
band portion of the excitation is modulated down to the low frequency
region. This spectral flip is accomplished in time domain

![](media/image158.wmf){width="2.342361111111111in"
height="0.27569444444444446in"} (701)

##### 5.2.6.1.9 Down-sample using all-pass filters

![](media/image159.wmf){width="0.6326388888888889in"
height="0.2423611111111111in"} is then decimated using a pair of all
pass filters to obtain an 8 kHz bandwidth (16 kHz sampled) excitation
signal ![](media/image160.wmf){width="0.4409722222222222in"
height="0.20694444444444443in"}. This is done by filtering the even
samples of ![](media/image161.wmf){width="0.6173611111111111in"
height="0.2423611111111111in"} by an all pass filter whose transfer
function is given by

![](media/image162.wmf){width="2.6006944444444446in"
height="0.5333333333333333in"} (702)

And the odd samples of
![](media/image163.wmf){width="0.6173611111111111in"
height="0.2423611111111111in"} by an all pass filter whose transfer
function is given by

![](media/image164.wmf){width="2.6819444444444445in"
height="0.5333333333333333in"} (703)

The 16 kHz sampled excitation signal
![](media/image165.wmf){width="1.3319444444444444in"
height="0.20694444444444443in"} are obtained by averaging the outputs of
the above filter.

These filter coefficients are specified in below.

Table 58: All-pass filter coefficients for decimation by a factor of 2

  -------- -----------------------
           All pass coefficients
  a~0,1~   0.06056541924291
  a~1,1~   0.42943401549235
  a~2,1~   0.80873048306552
  a~0,2~   0.22063024829630
  a~1,2~   0.63593943961708
  a~2,2~   0.94151583095682
  -------- -----------------------

##### 5.2.6.1.10 Adaptive spectral whitening

Due to the nonlinear processing applied to obtain the excitation signal
![](media/image166.wmf){width="0.4409722222222222in"
height="0.20694444444444443in"}, the spectrum of this excitation is no
longer flat. In order to flatten the spectrum of the excitation signal
![](media/image167.wmf){width="0.4409722222222222in"
height="0.20694444444444443in"}, 4^th^ order linear prediction
coefficients are estimated from
![](media/image168.wmf){width="0.4826388888888889in"
height="0.20694444444444443in"}The spectrum of
![](media/image169.wmf){width="0.4409722222222222in"
height="0.20694444444444443in"} is then flattened by inverse filtering
![](media/image170.wmf){width="0.4409722222222222in"
height="0.20694444444444443in"} using the linear prediction filter.

The first step in the adaptive whitening process is to estimate the
autocorrelation of the excitation signal

![](media/image171.wmf){width="3.515972222222222in"
height="0.5333333333333333in"} (704)

A bandwidth expansion is applied to the autocorrelation coefficients by
multiplying the coefficients by the expansion function:

![](media/image172.wmf){width="2.2319444444444443in"
height="0.24861111111111112in"} (705)

The bandwidth expanded autocorrelation coefficients are used to obtain
LP filter coefficients, ![](media/image173.wmf){width="0.975in"
height="0.2423611111111111in"} by solving the following set of equations
using the Levinson-Durbin algorithm as described in section.

![](media/image174.wmf){width="2.5256944444444445in"
height="0.5333333333333333in"} (706)

It must be noted that
![](media/image175.wmf){width="0.5819444444444445in"
height="0.2423611111111111in"}.

The whitened excitation signal ![](media/image176.wmf){width="0.525in"
height="0.20694444444444443in"} is obtained from
![](media/image177.wmf){width="0.4409722222222222in"
height="0.20694444444444443in"} by inverse filtering

![](media/image178.wmf){width="2.348611111111111in"
height="0.5333333333333333in"} (707)

4 samples of ![](media/image179.wmf){width="0.4409722222222222in"
height="0.20694444444444443in"} from the previous frame are used as
memory for the above filtering operation.

For bit rates 24.4 kb/s and 32 kb/s, the whitened excitation is further
modulated (in a two-stage gain shape modulation) by the normalized
residual energy
parameter![](media/image180.wmf){width="0.42569444444444443in"
height="0.24861111111111112in"}. In other words, for bitrates 24.4 kb/s
and 32 kb/s,

![](media/image181.wmf){width="4.5in" height="0.45in"} (708)

##### 5.2.6.1.11 Envelope modulated noise mixing

To the whitened excitation, a random noise vector whose amplitude has
been modulated by the envelope of the whitened excitation is mixed using
a mixing ratio that is dependent on the extent of voicing in the low
band.

First, ![](media/image182.wmf){width="1.1423611111111112in"
height="0.23333333333333334in"} is calculated and then the envelope of
the envelope of the whitened excitation signal
![](media/image183.wmf){width="0.5423611111111111in"
height="0.20694444444444443in"}is calculated by smoothing
![](media/image184.wmf){width="0.45in" height="0.20694444444444443in"}

![](media/image185.wmf){width="2.475in" height="0.20694444444444443in"}
(709)

In SWB mode, the factors
![](media/image186.wmf){width="0.18263888888888888in"
height="0.20694444444444443in"} and
![](media/image187.wmf){width="0.19166666666666668in"
height="0.20694444444444443in"} are calculated using the voicing
factors, ![](media/image188.wmf){width="0.23333333333333334in"
height="0.20694444444444443in"} for subframes
![](media/image189.wmf){width="0.525in" height="0.1736111111111111in"},
which calculated by parameters which determined from the low band ACELP
encoder. The voicing factors denote voicing extend of the high band
signal since the fine signal structure in the higher bands are closely
related to that in the lower band. The average of the 4 voicing factors,
![](media/image190.wmf){width="1.35in" height="0.375in"}, is calculated
and modified as ![](media/image191.wmf){width="1.5833333333333333in"
height="0.19166666666666668in"}. This is then confined to values between
0.6 and 0.999. Then
![](media/image192.wmf){width="0.18263888888888888in"
height="0.20694444444444443in"} and
![](media/image193.wmf){width="0.19166666666666668in"
height="0.20694444444444443in"} are estimated as

![](media/image194.wmf){width="0.6659722222222222in"
height="0.20694444444444443in"} (710)

![](media/image195.wmf){width="0.5819444444444445in"
height="0.20694444444444443in"} (711)

However, for bit rates 16.4 kb/s and 24.4 kb/s and if TBE was not used
in the previous frame,
![](media/image192.wmf){width="0.18263888888888888in"
height="0.20694444444444443in"} and
![](media/image193.wmf){width="0.19166666666666668in"
height="0.20694444444444443in"} are set to

![](media/image196.wmf){width="0.5159722222222223in"
height="0.20694444444444443in"} (712)

![](media/image197.wmf){width="0.6083333333333333in"
height="0.20694444444444443in"} (713)

and for ![](media/image198.wmf){width="0.3326388888888889in"
height="0.1673611111111111in"},
![](media/image199.wmf){width="0.7583333333333333in"
height="0.19166666666666668in"}is substituted by an approximated value
![](media/image200.wmf){width="0.9986111111111111in"
height="0.23333333333333334in"} as

![](media/image201.wmf){width="1.9736111111111112in"
height="0.5159722222222223in"} (714)

In WB mode, the factors
![](media/image186.wmf){width="0.18263888888888888in"
height="0.20694444444444443in"} and
![](media/image187.wmf){width="0.19166666666666668in"
height="0.20694444444444443in"}are initialized to
![](media/image202.wmf){width="0.5819444444444445in"
height="0.20694444444444443in"}and![](media/image203.wmf){width="0.6659722222222222in"
height="0.20694444444444443in"}. However, if the bitrate is 9.6kb/s,
they are reset to ![](media/image204.wmf){width="0.5159722222222223in"
height="0.20694444444444443in"}and![](media/image205.wmf){width="0.6083333333333333in"
height="0.20694444444444443in"}if the low band coder type is voiced
or![](media/image206.wmf){width="0.5756944444444444in"
height="0.20694444444444443in"}, or to
![](media/image207.wmf){width="0.5666666666666667in"
height="0.20694444444444443in"}and![](media/image208.wmf){width="0.6659722222222222in"
height="0.20694444444444443in"} if the low band coder type is unvoiced
or![](media/image209.wmf){width="0.5069444444444444in"
height="0.19166666666666668in"}. In SWB mode, for bit rates 24.4 kbps
and 32 kbps, the mix factors are estimated based on both the low band
voice factor, ![](media/image210.wmf){width="0.20694444444444443in"
height="0.20694444444444443in"}, and the high band closed-loop
estimation, where

![](media/image211.wmf){width="2.3756944444444446in"
height="0.20694444444444443in"}

The ![](media/image212.wmf){width="1.0256944444444445in"
height="0.20694444444444443in"} mix factor is estimated based on the
high band residual signal,
![](media/image213.wmf){width="0.4583333333333333in"
height="0.24861111111111112in"}, transformed low band excitation,
![](media/image214.wmf){width="0.4583333333333333in"
height="0.20694444444444443in"}, and the modulated white noise
excitation ![](media/image215.wmf){width="0.5159722222222223in"
height="0.20694444444444443in"}.

A vector of random numbers,
![](media/image216.wmf){width="0.4166666666666667in"
height="0.20694444444444443in"} of length 160 is then modulated by
![](media/image217.wmf){width="0.5819444444444445in"
height="0.20694444444444443in"} to generate
![](media/image218.wmf){width="0.5069444444444444in"
height="0.20694444444444443in"} as

![](media/image219.wmf){width="1.6319444444444444in"
height="0.20694444444444443in"} (715)

The whitened excitation is then de-emphasized with
![](media/image220.wmf){width="0.525in" height="0.1736111111111111in"}
which is the pre-emphasised effect since the used spectrum is flipped.

![](media/image221.wmf){width="2.0819444444444444in"
height="0.20694444444444443in"} (716)

If the lowband coder type is unvoiced, the excitation
![](media/image222.wmf){width="0.5069444444444444in"
height="0.20694444444444443in"} is first rescaled to match the energy
level of the whitened excitation ![](media/image223.wmf){width="0.525in"
height="0.20694444444444443in"}

![](media/image224.wmf){width="1.5173611111111112in"
height="0.20694444444444443in"} (717)

where

$\text{scale} = \sqrt{\frac{\sum_{}^{}\left( \varepsilon_{\text{wht}}\left( n \right) \right)^{2}}{\sum_{}^{}\left( \text{rn}_{\text{wht}}\left( n \right) \right)^{2}}}$
(718)

And then pre-emphasised with ![](media/image225.wmf){width="0.15in"
height="0.15in"}=0.68 to generate the final excitation which is the
de-emphasised effect since the used spectrum is flipped.

![](media/image226.wmf){width="1.9076388888888889in"
height="0.20694444444444443in"} (719)

If the lowband coder type was not un-voiced, the final excitation is
calculated as

$\varepsilon_{1}\left( n \right) = \alpha_{1}\left( i \right) \times \varepsilon_{\text{wht}}\left( n \right) + \alpha_{2}\left( i \right) \times \text{rn}_{\text{wht}}\left( n \right)$
(720)

for each sample index $n$ within subframe $i$.

For bit rates less than 24.4 kb/s, the mixing parameters
![](media/image227.wmf){width="0.18263888888888888in"
height="0.20694444444444443in"} and
![](media/image228.wmf){width="0.19166666666666668in"
height="0.20694444444444443in"} are estimated as,

$\alpha_{1}\left( i \right) = \left( \text{Vf}_{i} \right)^{\frac{1}{4}}$
(720)

$\alpha_{2}\left( i \right) = \sqrt{\frac{\left( \sum_{}^{}\left( \varepsilon_{\text{wht}}\left( n \right) \right)^{2} \right) \times \left( 1 - \sqrt{\text{Vf}_{i}} \right)}{\sum_{}^{}\left( \text{rn}_{\text{wht}}\left( n \right) \right)^{2}}}$
(721)

For bit rates 24.4 kb/s and 32 kb/s, the mixing parameters
![](media/image229.wmf){width="0.18263888888888888in"
height="0.20833333333333334in"}, $\alpha_{2}$are estimated for as
follows:

$\alpha_{1}\left( i \right) = \sqrt{\left( \text{Vf}_{i} \right) \times \left( 1\text{.}0 - 0\text{.}\text{15} \times \text{fac}_{\text{formant}} \right)}$
(723)

$\alpha_{2}(i) = \sqrt{\frac{\left( \sum_{}^{}\left( \varepsilon_{\text{wht}}\left( n \right) \right)^{2} \right) \times \left( 1\text{.}0 - \left( \text{Vf}_{i} \right) \times \left( 1\text{.}0 - 0\text{.}\text{15} \times \text{fac}_{\text{formant}} \right) \right)}{\sum_{}^{}\left( \text{rn}_{\text{wht}}\left( n \right) \right)^{2}}}$
(723a)

where the parameter ![](media/image230.wmf){width="0.6409722222222223in"
height="0.2326388888888889in"} is defined in equation (722).

$\varepsilon_{1}(n)$ is then de-emphasised to generate the final
excitation.

##### 5.2.6.1.12 Spectral shaping of the noise added excitation

The excitation signal
![](media/image231.wmf){width="0.4166666666666667in"
height="0.28194444444444444in"} is then put through the high band LPC
synthesis filter that is derived from the quantized LPC coefficients
(see subclause 5.2.4.1.3).

For bitrates below 24.4 kb/s, a single LPC synthesis filter
![](media/image232.wmf){width="0.9506944444444444in"
height="0.2423611111111111in"} is used and the shaped excitation signal
![](media/image233.wmf){width="0.3506944444444444in"
height="0.20694444444444443in"} is generated as

![](media/image234.wmf){width="2.025in" height="0.5333333333333333in"}
(723)

For bitrates at and above 24.4 kb/s the LPC synthesis filter is applied
to the excitation signal
![](media/image235.wmf){width="0.3173611111111111in"
height="0.20694444444444443in"} in four subframes based on

![](media/image236.wmf){width="4.457638888888889in"
height="0.7256944444444444in"} (724)

In particular, for bit rates at and above 24.4 kbps, first a memory-less
synthesis is performed (with past LP filter memories set to zero) and
the energy of the synthesized high band is matched to that of the
original signal. In the subsequent step, the scaled or energy
compensated excitation signal as shown below,
![](media/image237.wmf){width="0.3326388888888889in"
height="0.20694444444444443in"}, is used to perform synthsesis in the
second step.

![](media/image238.wmf){width="3.167361111111111in"
height="1.1069444444444445in"}

##### 5.2.6.1.13 Post processing of the shaped excitation

The shaped excitation
![](media/image239.wmf){width="0.35694444444444445in"
height="0.19166666666666668in"}is the synthesized high band signal which
is generated by passing the excitation signal
![](media/image240.wmf){width="0.3326388888888889in"
height="0.20694444444444443in"} through the LPC synthesis filter. The
excitation signal ![](media/image240.wmf){width="0.3326388888888889in"
height="0.20694444444444443in"} is determined by the low band model
parameters and the coefficients of the LPC synthesis filter are
determined by the high band model parameters. A short-term post-filter
is applied to the synthesized high band signal to obtain a short-term
post-filtered signal. Comparing with the shape of the spectral envelope
of the synthesized high frequency band signal, the shape of the spectral
envelope of the short-term post-filtered signal is closer to the shape
of the spectral envelope of the high-frequency band signal. The
short-term post-filter includes a pole-zero filter, the coefficients of
the pole-zero filter are set by the set of high band model parameters.
It is described as follows:

$H_{f}\left( z \right) = \frac{H_{n}(Z)}{H_{d}(Z)} = \frac{1 - {\overset{\sim}{a}}_{1}^{\text{SHB}}\text{βz}^{- 1} - {\overset{\sim}{a}}_{2}^{\text{SHB}}\beta^{2}z^{- 2} - \text{.}\text{.}\text{.} - {\overset{\sim}{a}}_{M}^{\text{SHB}}\beta^{M}z^{- M}}{1 - {\overset{\sim}{a}}_{1}^{\text{SHB}}\text{γz}^{- 1} - {\overset{\sim}{a}}_{2}^{\text{SHB}}\gamma^{2}z^{- 2} - \text{.}\text{.}\text{.} - {\overset{\sim}{a}}_{M}^{\text{SHB}}\gamma^{M}z^{- M}},\ 0 < \beta \leq \gamma < 1\ M = \text{10}$
(725)

![](media/image241.wmf){width="1.1666666666666667in"
height="0.26666666666666666in"} (726)

![](media/image242.wmf){width="0.43194444444444446in"
height="0.23333333333333334in"} is derived from the quantized LPC
coefficients (see subclause 5.2.6.1.3) with the factors
![](media/image243.wmf){width="0.15in" height="0.19166666666666668in"}
and ![](media/image244.wmf){width="0.12569444444444444in"
height="0.1673611111111111in"}controlling the degree of the short-term
post‑filtering.
${\overset{\sim}{a}}_{1}^{\text{SHB}}\text{.}\text{.}\text{.}\ {\overset{\sim}{a}}_{M}^{\text{SHB}}$
are the quantized LPC coefficients. The
factors![](media/image243.wmf){width="0.15in"
height="0.19166666666666668in"} and
![](media/image244.wmf){width="0.12569444444444444in"
height="0.1673611111111111in"}are calculated according to:

![](media/image245.wmf){width="1.65in" height="0.4826388888888889in"}
(727)

where ![](media/image246.wmf){width="0.6416666666666667in"
height="0.23333333333333334in"} is parameter that jointly controls
envelope shape and excitation noisiness. It is based on the spectral
tilt, determined by the LPC
coefficient![](media/image247.wmf){width="0.3326388888888889in"
height="0.24861111111111112in"}:

![](media/image248.wmf){width="2.3756944444444446in"
height="0.3173611111111111in"} (728)

where ![](media/image249.wmf){width="0.6416666666666667in"
height="0.29097222222222224in"} is the past value of
![](media/image246.wmf){width="0.6416666666666667in"
height="0.23333333333333334in"} .

![](media/image250.wmf){width="2.582638888888889in"
height="0.23333333333333334in"} (729)

![](media/image251.wmf){width="1.9736111111111112in"
height="0.23333333333333334in"} (730)

The gain term ![](media/image252.wmf){width="0.225in"
height="0.23333333333333334in"} is calculated from the truncated impulse
response ![](media/image253.wmf){width="0.375in"
height="0.23333333333333334in"} of the
filter![](media/image242.wmf){width="0.43194444444444446in"
height="0.23333333333333334in"} and is given by:

![](media/image254.wmf){width="1.0166666666666666in"
height="0.5159722222222223in"} (731)

The shaped excitation
![](media/image239.wmf){width="0.35694444444444445in"
height="0.19166666666666668in"} is divided into four
subframes![](media/image255.wmf){width="1.667361111111111in"
height="0.20694444444444443in"}, and each subframe
![](media/image255.wmf){width="1.667361111111111in"
height="0.20694444444444443in"}is filtered through
![](media/image256.wmf){width="0.6506944444444445in"
height="0.23333333333333334in"}, and then filtered with the synthesis
filter ![](media/image257.wmf){width="0.5423611111111111in"
height="0.20694444444444443in"} to produce
![](media/image258.wmf){width="1.7069444444444444in"
height="0.20694444444444443in"}.

After filtering the synthesized high band signal using the pole-zero
filter, filter ![](media/image259.wmf){width="0.3923611111111111in"
height="0.20694444444444443in"}then compensates for the tilt in the
pole-zero filter ![](media/image260.wmf){width="0.43194444444444446in"
height="0.23333333333333334in"} and is given by:

![](media/image261.wmf){width="0.9416666666666667in"
height="0.24861111111111112in"} (732)

![](media/image262.wmf){width="1.0409722222222222in"
height="0.23333333333333334in"} (733)

where ![](media/image263.wmf){width="0.15in"
height="0.1673611111111111in"}is set to default constant value or
adaptively calculated according to the high band coding parameters and
the synthesized high band signal. The calculation process is as follows:
![](media/image264.wmf){width="0.5006944444444444in"
height="0.24861111111111112in"} is a tilt factor, with
![](media/image265.wmf){width="0.15in" height="0.24861111111111112in"}
being the first reflection coefficient calculated from
![](media/image266.wmf){width="0.375in"
height="0.23333333333333334in"}by:

![](media/image267.wmf){width="2.432638888888889in"
height="0.5423611111111111in"} (734)

A gain term ![](media/image268.wmf){width="0.8069444444444445in"
height="0.24861111111111112in"} is applied to compensate for the
decreasing effect of ![](media/image252.wmf){width="0.225in"
height="0.23333333333333334in"}in![](media/image269.wmf){width="0.43194444444444446in"
height="0.26666666666666666in"}. It has been shown that the product
filter ![](media/image270.wmf){width="0.7736111111111111in"
height="0.26666666666666666in"}has a gain close to unity.
![](media/image271.wmf){width="0.15in" height="0.20694444444444443in"}
is set according to the sign of![](media/image272.wmf){width="0.15in"
height="0.24861111111111112in"}. If
![](media/image273.wmf){width="0.15in" height="0.24861111111111112in"}
is positive,![](media/image274.wmf){width="0.5576388888888889in"
height="0.20694444444444443in"},
otherwise,![](media/image275.wmf){width="0.5576388888888889in"
height="0.20694444444444443in"}.

Then ![](media/image276.wmf){width="1.7069444444444444in"
height="0.20694444444444443in"}is passed through the tilt compensation
filter ![](media/image277.wmf){width="0.3923611111111111in"
height="0.23333333333333334in"} resulting in the post‑filtered speech
signal ![](media/image278.wmf){width="1.7756944444444445in"
height="0.20694444444444443in"}

Adaptive Gain Control (AGC) is applied to compensate for any gain
difference between the synthesized speech
signal![](media/image255.wmf){width="1.667361111111111in"
height="0.20694444444444443in"} and the post‑filtered
signal![](media/image279.wmf){width="1.7333333333333334in"
height="0.20694444444444443in"}. The gain scaling factor
![](media/image280.wmf){width="0.25833333333333336in"
height="0.24166666666666667in"} for each subframe is calculated by:

![](media/image281.wmf){width="1.7909722222222222in"
height="1.0673611111111112in"} (735)

and the post processed shaped
excitation$s\hat{\varepsilon}(n + (j - 1) \ast \text{80}),\ j = 1,2,3,4$
is given by:

![](media/image282.wmf){width="3.9569444444444444in"
height="0.24861111111111112in"} (736)

where ![](media/image283.wmf){width="0.4166666666666667in"
height="0.20694444444444443in"} is updated in sample‑by‑sample basis and
given by:

![](media/image284.wmf){width="1.8173611111111112in"
height="0.20694444444444443in"} (737)

and where ![](media/image285.wmf){width="0.15in"
height="0.14097222222222222in"} is an AGC factor with value of 0.85.

In order to smooth the evolution of the post-processed spectrally shaped
highband excitation signal across frame boundaries, the look-ahead and
the overlap samples are scaled based on the ratio of the current frame's
energy in the overlap region and the previous frame's energy in the
overlap region. The scale factor computation is performed as shown in
equation (1579) in subclause 6.1.5.1.12.

The tenth-order LPC synthesis performed as described according to
subclause 5.2.6.1.12 uses a memory of ten samples, thus there is at
least an energy propagation over ten samples from the previous frame
into the current frame. When calculating the energy scaling to be
applied to the current frame, the first 10 samples of the current frame
are considered as a part of previous frame energy. If the voicing factor
$\text{Vf}_{0}$is greater than 0.75, the numerator in equation (1579) is
attenuated by 0.25. The spectrally shaped high band signal is then
modified by the scale factor as shown in equation (1580) in Clause
6.1.5.1.12.

##### 5.2.6.1.14 Estimation of temporal gain shape parameters

There are different initialization estimation of temporal gain shape for
the WB mode and the SWB mode.

##### 5.2.6.1.14.1 Initialization estimation of temporal gain shape for WB mode {#initialization-estimation-of-temporal-gain-shape-for-wb-mode .H6}

The frame is divided into eight segments, and the energy envelope of
each segment is calculated, then the 4 gain shapes are calculated from
the calculated 8 energy envelopes.

The energy envelopes of the eight segments of the target signal and the
shaped excitation signal are calculated as follows:

Asymmetric windows are applied to the first and the eighth segments,

![](media/image286.wmf){width="4.067361111111111in"
height="0.8756944444444444in"} (738)

![](media/image287.wmf){width="3.848611111111111in"
height="0.8756944444444444in"} (739)

And symmetric windows are applied to the segments from the second to the
seventh.

![](media/image288.wmf){width="4.391666666666667in" height="0.375in"}
(740)

![](media/image289.wmf){width="3.975in" height="0.43194444444444446in"}
(741)

Four high band gain shapes are then calculated by combining pairs of
energy envelopes as follows

![](media/image290.wmf){width="3.167361111111111in"
height="0.5159722222222223in"} (742)

The asymmetric windows are determined by the number of look head samples
and the number of segments. The asymmetric window and the symmetric
windows are described as follows, the number of look-ahead samples is 5.

![](media/image291.wmf){width="6.69375in" height="2.1020833333333333in"}

Figure 50: Asymmetric window and symmetric window

The variable ![](media/image292.wmf){width="0.4826388888888889in"
height="0.19166666666666668in"} for
![](media/image293.wmf){width="0.6416666666666667in"
height="0.18263888888888888in"}is tabulated in table 60 below:

Table 61: Window for highband gain shape calculation

  ------- ------------
  Index   Value
  0       0.0
  1       0.15643448
  2       0.30901700
  3       0.45399052
  4       0.58778524
  5       0.70710677
  6       0.80901700
  7       0.89100653
  8       0.95105654
  9       0.98768836
  10      1.0
  ------- ------------

##### 5.2.6.1.14.2 Initialization estimation of temporal gain shape for SWB mode {#initialization-estimation-of-temporal-gain-shape-for-swb-mode .H6}

The high band target frame (see subclause 5.2.6.1.1),
![](media/image294.wmf){width="0.4673611111111111in"
height="0.24861111111111112in"} and the post-processed shaped excitation
$s\hat{\varepsilon}(n)$ are used to calculate 4 temporal gain shape
parameters, ![](media/image295.wmf){width="0.38333333333333336in"
height="0.20694444444444443in"}
for![](media/image296.wmf){width="0.675in"
height="0.21597222222222223in"}. The gain shape parameters are
calculated using an overlap of 20 samples from the previous frame to
avoid transition artifacts during the reconstruction at the decoder.

![](media/image297.wmf){width="1.7756944444444445in"
height="0.4583333333333333in"} (744)

where the subframe energies in the target high band signal and the
shaped excitation signal are calculated as

![](media/image298.wmf){width="3.683333333333333in"
height="0.5333333333333333in"} (745)

and

$\phi_{\text{ShE}}\left( j \right) = \sum_{n = 0}^{\text{99}}\left( s\hat{\varepsilon}\left( n + \left( j - 1 \right) \times \text{80} - \text{20} \right) \right)^{2} \times \text{swin}\left( n \right),\ \text{for}\ j = 1,\text{.}\text{.}\text{.}4$.
(746)

The window function ![](media/image299.wmf){width="0.4673611111111111in"
height="0.20694444444444443in"} is a window signal is given by

![](media/image300.wmf){width="2.033333333333333in"
height="0.6506944444444445in"} (747)

The variable ![](media/image301.wmf){width="0.4166666666666667in"
height="0.20694444444444443in"} for
![](media/image302.wmf){width="0.7583333333333333in"
height="0.21597222222222223in"} is tabulated in table 62 below.

Table 63: Window for highband gain shape calculation

  ------- ----------
  Index   Value
  0       0.0
  1       0.006156
  2       0.024472
  3       0.054497
  4       0.095492
  5       0.146447
  6       0.206107
  7       0.273005
  8       0.345492
  9       0.421783
  10      0.5
  11      0.578217
  12      0.654508
  13      0.726995
  14      0.793893
  15      0.853553
  16      0.904508
  17      0.945503
  18      0.975528
  19      0.993844
  20      1.0
  ------- ----------

##### 5.2.6.1.14.3 Additional processing of temporal gain shape {#additional-processing-of-temporal-gain-shape .H6}

Additionally, the gain shape values are normalized such that

![](media/image303.wmf){width="1.292361111111111in"
height="0.5756944444444444in"} (743)

The 4^th^ subframe gain shape value from the last subframe
![](media/image304.wmf){width="0.39861111111111114in"
height="0.23333333333333334in"} is used to smooth the Gain Shape
parameter evolution. A variable
![](media/image305.wmf){width="0.19166666666666668in"
height="0.19166666666666668in"} is calculated as

![](media/image306.wmf){width="2.957638888888889in" height="0.6in"}
(744)

If the sum of the voicing factors
![](media/image307.wmf){width="0.9173611111111111in"
height="0.3416666666666667in"}, then the gain shape parameters are
smoothed as follows:

![](media/image308.wmf){width="1.9319444444444445in"
height="0.2423611111111111in"} (745)

![](media/image309.wmf){width="2.873611111111111in"
height="0.20694444444444443in"} (746)

The gain shape parameters vector corresponding to a given frame are
transformed into the log domain and vector quantized. The quantized gain
shape parameters are denoted
![](media/image310.wmf){width="1.1159722222222221in"
height="0.2423611111111111in"}

##### 5.2.6.1.15 Estimation of frame gain parameters

In addition to the gain shape parameter, an overall frame gain parameter
![](media/image311.wmf){width="0.24861111111111112in"
height="0.1673611111111111in"} is calculated. First the spectrally
shaped excitation is scaled by the gain shape parameters.

![](media/image312.wmf){width="4.373611111111111in"
height="0.5576388888888889in"} (747)

Samples with negative indices are obtained from the previous frame and

![](media/image313.wmf){width="1.8923611111111112in"
height="0.43194444444444446in"} (748)

The energies of the ![](media/image314.wmf){width="0.4826388888888889in"
height="0.20694444444444443in"} and
![](media/image315.wmf){width="0.3in" height="0.2423611111111111in"} for
the entire duration of the frame and the overlaps is calculated using a
window:

![](media/image316.wmf){width="2.042361111111111in"
height="0.5333333333333333in"} (749)

![](media/image317.wmf){width="1.9736111111111112in"
height="0.5333333333333333in"} (750)

where the negative samples are obtained from previous frames, and the
window function ![](media/image318.wmf){width="0.5069444444444444in"
height="0.20694444444444443in"} is given by

![](media/image319.wmf){width="2.2916666666666665in"
height="0.6506944444444445in"} (751)

where ![](media/image320.wmf){width="0.4166666666666667in"
height="0.20694444444444443in"} is defined in table 64.

If the high band target energy as calculated in Equation (754) is
saturated, then the target signal, ![](media/image315.wmf){width="0.3in"
height="0.2423611111111111in"}, is scaled based on the number of
subframes that are saturated (from clause 5.2.6.1.14.2). Then the high
band target energy is recalculated using the scaled target signal using
Equation (754). Subsequently, the gain frame GF in Equation (757) is
compensated for the scaling performed on the target signal.

The overall frame gain parameter
![](media/image321.wmf){width="0.24861111111111112in"
height="0.1673611111111111in"} is calculated as

![](media/image322.wmf){width="0.8006944444444445in"
height="0.4583333333333333in"} (752)

The parameter ![](media/image323.wmf){width="0.24861111111111112in"
height="0.1673611111111111in"} is attenuated if the quantization of the
gain shape parameter is poor. First the power-off-the-peak value for
unquantized and quantized gain shape parameters is calculated:

![](media/image324.wmf){width="2.1506944444444445in"
height="0.7256944444444444in"} (753)

![](media/image325.wmf){width="2.1659722222222224in"
height="0.7256944444444444in"} (754)

If ![](media/image326.wmf){width="0.8909722222222223in"
height="0.23333333333333334in"}, then the gain shape parameter
quantization is deemed poorly quantized and the gain frame parameter is
attenuated as follows in order to avoid perceptually annoying artifacts
in the reconstructed speech signal at the decoder.

![](media/image327.wmf){width="1.275in" height="0.5069444444444444in"}
(755)

Further, the ![](media/image323.wmf){width="0.24861111111111112in"
height="0.1673611111111111in"}parameter is smoothed if the current frame
is determined to be similar in spectral characteristics to the previous
frames. To determine similarity in spectral characteristics, the fast
and slow evolution rates,
![](media/image328.wmf){width="0.3173611111111111in"
height="0.15833333333333333in"} and
![](media/image329.wmf){width="0.30833333333333335in"
height="0.1673611111111111in"} , and the minimum LSP spacing
![](media/image330.wmf){width="0.29097222222222224in"
height="0.20694444444444443in"} are determined as follows:

![](media/image331.wmf){width="3.6in" height="0.5333333333333333in"}
(756)

where ![](media/image332.wmf){width="4.575in"
height="0.28194444444444444in"} and
![](media/image333.wmf){width="1.0583333333333333in"
height="0.20694444444444443in"}
and![](media/image334.wmf){width="0.4583333333333333in"
height="0.20694444444444443in"}![](media/image335.wmf){width="0.35694444444444445in"
height="0.24861111111111112in"}when k=1 and
![](media/image336.wmf){width="0.4583333333333333in"
height="0.20694444444444443in"}![](media/image337.wmf){width="0.8159722222222222in"
height="0.24861111111111112in"}otherwise.

A smoothed version of
![](media/image338.wmf){width="0.3236111111111111in"
height="0.20694444444444443in"} using
the![](media/image339.wmf){width="0.3326388888888889in"
height="0.20694444444444443in"}values from the previous frames is also
determined:

![](media/image340.wmf){width="4.067361111111111in"
height="0.2423611111111111in"} (757)

If the minimum LSP spacing and smoothed LSP spacing satisy a spacing
critierion (e.g., *δ~min~* \< 0.008, *δ~smoothed~* \< 0.005) indicating
an artifact generating condition, the high band target is filtered using
the high band LP to attenuate the coding artifacts before estimating the
gain shape and gain frame parameters.

If the ![](media/image341.wmf){width="0.3416666666666667in"
height="0.20069444444444445in"} and
the![](media/image342.wmf){width="0.3659722222222222in"
height="0.1736111111111111in"} values are smaller than 0.001, then the
gain frame parameter
![](media/image343.wmf){width="0.24861111111111112in"
height="0.1673611111111111in"} is smoothed between the previous and the
current frame.

![](media/image344.wmf){width="1.457638888888889in"
height="0.23333333333333334in"} (758)

Also, if![](media/image345.wmf){width="1.1159722222222221in"
height="0.20694444444444443in"}, then an additional attenuation of the
![](media/image346.wmf){width="0.24861111111111112in"
height="0.1673611111111111in"} is performed:
![](media/image347.wmf){width="0.8159722222222222in"
height="0.2423611111111111in"}. Also, if the current frame's
![](media/image348.wmf){width="1.0583333333333333in"
height="0.23333333333333334in"}, then
![](media/image349.wmf){width="0.24861111111111112in"
height="0.1673611111111111in"} is modified as per

![](media/image350.wmf){width="1.5173611111111112in"
height="0.20694444444444443in"} (759)

where ![](media/image351.wmf){width="0.19166666666666668in"
height="0.19166666666666668in"} is calculated as described in subclause
5.2.6.1.15.

For the WB mode and if the bitrate is 9.6 kb/s, the gain frame parameter
![](media/image352.wmf){width="0.24861111111111112in"
height="0.1673611111111111in"}is further adapted, based on the average
of the 4 voicing factors,
![](media/image353.wmf){width="1.3583333333333334in" height="0.375in"},
as ![](media/image354.wmf){width="0.8756944444444444in"
height="0.1673611111111111in"}, if the low band coder type is voiced,
and as ![](media/image355.wmf){width="0.9416666666666667in"
height="0.1673611111111111in"}, if the low band coder type is not
voiced, but ![](media/image356.wmf){width="0.5756944444444444in"
height="0.20694444444444443in"}.

The gain frame parameter
![](media/image352.wmf){width="0.24861111111111112in"
height="0.1673611111111111in"} is scalar quantized in the log domain
using 5 bits. The lowest quantization point is chosen to be -1.0 and the
quantization steps are set to be 0.15.

##### 5.2.6.1.16 Estimation of TEC/TFA envelope parameters

The Temporal Envelope Coding (TEC) and the Temporal Flatness Adjuster
(TFA) shape the temporal envelope of the high frequency band signal
generated by the TBE. They are enabled as the post processing of the TBE
at 16.4 and 24.4 kbps with the output sampling frequencies higher than
8000 Hz.

The TEC is for getting better shapes of onsets at the decoder by using
the temporal envelope of the low frequency band and the transmitted
information on the temporal envelope of the high frequency band. The
information indicates the two different shapes, one is "steep onset" and
the other is "gentle onset". The TEC has two modes for accommodating
those shapes of the onsets, "no smoothing mode" is for steep onsets and
"smoothing mode" is for gentle onsets. Thus, the transmitted information
represents the mode of TEC to be used at the decoder as well as the
shape of the onset. At the decoder, the information is used to calculate
the temporal envelope of the high frequency band.

The TFA flattens the temporal envelope of the high frequency band
according to the transmitted information on the flatness of the temporal
envelope of the input signal.

##### 5.2.6.1.16.1 Estimation of TEC parameters {#estimation-of-tec-parameters .H6}

The TEC parameter ![](media/image357.wmf){width="0.6in"
height="0.20694444444444443in"} to be transmitted to the decoder is
estimated as follows, which is the information on the temporal envelope
of the high frequency band and indicates the activation and the used
mode of the TEC at the decoder.

The temporal envelope of the low frequency band of the input signal is
defined as the mean of the temporal envelopes of three sub-bands in the
low frequency band (sub-low-frequency-bands) in the CLDFB domain. The
temporal envelope of the *m*-th sub-low-frequency-band
![](media/image358.wmf){width="0.5666666666666667in"
height="0.24861111111111112in"}is calculated by

![](media/image359.wmf){width="3.917361111111111in"
height="0.6236111111111111in"} (760)

where ![](media/image360.wmf){width="0.5006944444444444in"
height="0.20694444444444443in"} is the energy in the CLDFB domain
described in subclause 5.1.2.2 and,
![](media/image361.wmf){width="0.27569444444444446in" height="0.225in"}
and ![](media/image362.wmf){width="0.29097222222222224in"
height="0.225in"} are the lower and upper limits of the CLDFB sub-band
of the *m*-th sub-low-frequency-band. And then, the temporal envelope of
the low frequency band
![](media/image363.wmf){width="0.4409722222222222in"
height="0.20694444444444443in"} is calculated by

![](media/image364.wmf){width="2.3756944444444446in"
height="0.5159722222222223in"} (761)

The temporal envelope of the high frequency band of the input signal
![](media/image365.wmf){width="0.4583333333333333in"
height="0.20694444444444443in"}is calculated in the CLDFB domain.

![](media/image366.wmf){width="3.6083333333333334in" height="0.6in"}
(762)

where ![](media/image360.wmf){width="0.5006944444444444in"
height="0.20694444444444443in"} is the energy in the CLDFB domain
described in subclause 5.1.2.2 and,
![](media/image367.wmf){width="0.15in" height="0.20694444444444443in"}
and ![](media/image368.wmf){width="0.15in"
height="0.20694444444444443in"} are the lower and upper limits of the
CLDFB sub-band in the frequency range of the TBE.

The shape of the onset is detected by these temporal envelopes of the
high and low frequency bands. A steep onset is detected and the no
smoothing mode is selected when
![](media/image369.wmf){width="0.7736111111111111in"
height="0.20694444444444443in"}. And, a gentle onset is detected and the
smoothing mode is selected when
![](media/image370.wmf){width="0.8069444444444445in"
height="0.20694444444444443in"}.

![](media/image371.wmf){width="3.7916666666666665in"
height="0.7076388888888889in"} (763)

where ![](media/image372.wmf){width="0.18263888888888888in"
height="0.20694444444444443in"} and
![](media/image373.wmf){width="0.15in" height="0.20694444444444443in"}
are the variances of
![](media/image374.wmf){width="0.18263888888888888in"
height="0.20694444444444443in"}and
![](media/image375.wmf){width="0.15in"
height="0.20694444444444443in"}respectively.

When ![](media/image369.wmf){width="0.7736111111111111in"
height="0.20694444444444443in"}, the maximum values of the temporal
envelopes of the high and low frequency bands and their positions are
detected:

![](media/image376.wmf){width="2.816666666666667in"
height="0.30833333333333335in"} (764)

![](media/image377.wmf){width="2.732638888888889in"
height="0.30833333333333335in"} (765)

And then, the local minimum and maximum values of the temporal envelope
of the high frequency band at the position *i*, are detected and the
difference between the local maximum and minimum values is calculated:

![](media/image378.wmf){width="2.933333333333333in" height="0.6in"}
(766)

![](media/image379.wmf){width="3.4583333333333335in"
height="0.23333333333333334in"} (767)

The maximum of the difference
![](media/image380.wmf){width="0.9416666666666667in"
height="0.23333333333333334in"}and its position are detected:

![](media/image381.wmf){width="5.057638888888889in"
height="0.30833333333333335in"} (768)

Using the parameters above,
![](media/image382.wmf){width="0.5819444444444445in"
height="0.20694444444444443in"}is set as

![](media/image383.wmf){width="5.141666666666667in"
height="1.1006944444444444in"} (769)

When ![](media/image384.wmf){width="0.8069444444444445in"
height="0.20694444444444443in"}, the smoothed temporal envelope of the
low frequency band is calculated

![](media/image385.wmf){width="3.3569444444444443in"
height="0.5423611111111111in"} (770)

where

![](media/image386.wmf){width="3.308333333333333in"
height="0.20694444444444443in"} (771)

And then, the correlation coefficient
![](media/image387.wmf){width="0.525in" height="0.225in"}between
![](media/image388.wmf){width="0.4583333333333333in" height="0.225in"}
and ![](media/image389.wmf){width="0.3326388888888889in"
height="0.20694444444444443in"} is calculated. Further, the ratio
between the variances of
![](media/image388.wmf){width="0.4583333333333333in" height="0.225in"}
and ![](media/image389.wmf){width="0.3326388888888889in"
height="0.20694444444444443in"}is calculated:

![](media/image390.wmf){width="1.275in" height="0.43194444444444446in"}
(772)

Using these parameters,
![](media/image382.wmf){width="0.5819444444444445in"
height="0.20694444444444443in"}is set as

![](media/image391.wmf){width="3.848611111111111in"
height="0.43194444444444446in"} (773)

##### 5.2.6.1.16.2 Estimation of TFA parameters {#estimation-of-tfa-parameters .H6}

The parameter ![](media/image392.wmf){width="0.5666666666666667in"
height="0.20694444444444443in"} to be transmitted to the decoder is
estimated as follows, which represents the flatness of the temporal
envelope of the high frequency band as well as the activation of the TFA
at the decoder.

The flatness measure
![](media/image393.wmf){width="0.4826388888888889in"
height="0.20694444444444443in"}of the temporal envelope of the signal in
the high band target frame
![](media/image394.wmf){width="0.5006944444444444in"
height="0.24861111111111112in"} is calculated as:

![](media/image395.wmf){width="2.025in" height="1.1819444444444445in"}
(774)

where ![](media/image396.wmf){width="2.9006944444444445in"
height="0.3506944444444444in"}and where
![](media/image397.wmf){width="0.6506944444444445in"
height="0.24861111111111112in"}.

In addition to the flatness measure, the mean of the pitch lags
![](media/image398.wmf){width="0.4409722222222222in"
height="0.23333333333333334in"}and the mean of the open-loop pitch gains
of the half frames ![](media/image399.wmf){width="0.4826388888888889in"
height="0.23333333333333334in"}are calculated. Finally, depending to the
last core mode, the parameter
![](media/image400.wmf){width="0.5666666666666667in"
height="0.20694444444444443in"}is estimated by the parameters above:

in the case that the last core mode is not TCX20,

![](media/image401.wmf){width="3.848611111111111in"
height="0.43194444444444446in"} (775)

in the case that the last core mode is TCX20,

![](media/image402.wmf){width="2.792361111111111in"
height="0.43194444444444446in"} (776)

##### 5.2.6.1.16.3 Set the transmitted parameter for TEC and TFA {#set-the-transmitted-parameter-for-tec-and-tfa .H6}

The TEC and TFA parameters are jointly coded by 2 bits and then
transmitted to the decoder together with the other TBE information:

![](media/image403.wmf){width="3.0416666666666665in"
height="0.8486111111111111in"} (777)

##### 5.2.6.1.17 Estimation of full-band frame energy parameters

The full-band TBE algorithm is used for coding the full band. Since the
fine signal structure in the full bands are closely related to that in
the high band and low band, the full band of the signal are coded by
using only 4 bits together with the information from the low band and
the high band. A synthesized full band signal is obtained by coding the
high band and predicting spectrum from the high band, the synthesized
full band signal is then de-emphasized with
![](media/image404.wmf){width="0.29097222222222224in"
height="0.20694444444444443in"}which is determined by the characteristic
factors derived from coding the low band signal. A band passed full band
signal is obtained by band-pass filtering the input signal. The energy
ratio is calculated by comparing the energy calculated from the
de-emphasized synthesized full band signal with the energy calculated
from the band passed full band signal. Finally the parameters including
the characteristic factors, high band coding information and the energy
ratio are transmitted to the decoder.

The synthesized full band signal is obtained as follow: A vector of
random numbers![](media/image405.wmf){width="1.082638888888889in"
height="0.20694444444444443in"} of length 320 passes through the LPC
synthesis filter, the spectrum of
![](media/image406.wmf){width="1.082638888888889in"
height="0.20694444444444443in"} is used as the predicted spectrum from
the high band and the coefficients of the LPC synthesis filter are
derived from the quantized LPC coefficients (see subclause 5.2.6.1.3).

![](media/image407.wmf){width="3.107638888888889in"
height="0.5423611111111111in"} (778)

Then the synthesized full band signal
![](media/image408.wmf){width="1.1666666666666667in"
height="0.20694444444444443in"}is de-emphasized as follows:

The spectrum of ![](media/image408.wmf){width="1.1666666666666667in"
height="0.20694444444444443in"} are moving corrected described as
follows:

![](media/image409.wmf){width="2.625in" height="0.20694444444444443in"}
(779)

The variables ![](media/image410.wmf){width="1.7333333333333334in"
height="0.20069444444444445in"}are the parameters of spectrum moving
correction tabulated in Table 65 below:

Table 66: Parameters of spectrum moving correction

  ------- ------------------------- ------- -------------------------
  Index   Value                     Index   Value
  0       9.536743164062500e-007    16      -9.536743164062500e-007
  1       9.353497034680913e-007    17      -9.353497034680913e-007
  2       8.810801546133007e-007    18      -8.810801546133007e-007
  3       7.929511980364623e-007    19      -7.929511411930434e-007
  4       7.929511980364623e-007    20      -6.743495077898842e-007
  5       5.298330165715015e-007    21      -5.298329597280826e-007
  6       3.649553264040151e-007    22      -3.649552411388868e-007
  7       1.860525884467279e-007    23      -1.860525173924543e-007
  8       0.000000000000000e+000    24      0.000000000000000e+000
  9       -1.860526737118562e-007   25      1.860527589769845e-007
  10      -3.649554116691434e-007   26      3.649554969342717e-007
  11      -5.298331302583392e-007   27      5.298331871017581e-007
  12      -6.743496214767220e-007   28      6.743496783201408e-007
  13      -7.929512548798812e-007   29      7.929513117233000e-007
  14      -8.810802114567196e-007   32      8.810802683001384e-007
  15      -9.353497603115102e-007   31      9.353497603115102e-007
  ------- ------------------------- ------- -------------------------

And then flip the spectrum of
![](media/image411.wmf){width="1.1666666666666667in"
height="0.20694444444444443in"} to get
![](media/image412.wmf){width="1.1666666666666667in"
height="0.20694444444444443in"}

![](media/image413.wmf){width="2.3069444444444445in"
height="0.24861111111111112in"} (780)

The signal![](media/image414.wmf){width="1.1666666666666667in"
height="0.20694444444444443in"}is then de-emphasized with
![](media/image415.wmf){width="0.29097222222222224in"
height="0.20694444444444443in"}described as follows:

![](media/image416.wmf){width="2.1326388888888888in"
height="0.20694444444444443in"} (781)

The de-emphasized factor
![](media/image417.wmf){width="0.29097222222222224in"
height="0.20694444444444443in"} is determined by the characteristic
factors of the signal such as "voicing factors", "spectral tilt",
"short-term average energy", "short-term average zero crossing rate".
The calculation of de-emphasized factor
![](media/image418.wmf){width="0.29097222222222224in"
height="0.20694444444444443in"} using the voicing factors is described
as follows:

![](media/image419.wmf){width="1.7069444444444444in"
height="0.24861111111111112in"} (782)

![](media/image420.wmf){width="2.9159722222222224in"
height="1.0673611111111112in"} (783)

where ![](media/image421.wmf){width="0.20694444444444443in"
height="0.20694444444444443in"}is the voicing factor of the ith
subframe.

The signal![](media/image422.wmf){width="1.1909722222222223in"
height="0.20694444444444443in"}is modulated by the gain shape values
![](media/image423.wmf){width="0.9569444444444445in"
height="0.20069444444444445in"}(see subclause 5.2.6.1.14) and the
overall frame gain parameter
![](media/image424.wmf){width="0.24861111111111112in"
height="0.1673611111111111in"}(see subclause 5.2.6.1.15).

![](media/image425.wmf){width="3.0in" height="0.20694444444444443in"}
(784)

The energy of ![](media/image426.wmf){width="1.1666666666666667in"
height="0.20694444444444443in"} is described as follows:

![](media/image427.wmf){width="1.6826388888888888in"
height="0.5159722222222223in"} (785)

The original input signal
![](media/image428.wmf){width="0.9416666666666667in"
height="0.20694444444444443in"} pass through the band-pass filter to get
the band passed full band
signal![](media/image429.wmf){width="0.9416666666666667in"
height="0.20694444444444443in"}, and then calculate the energy
![](media/image430.wmf){width="0.26666666666666666in"
height="0.20694444444444443in"} of
![](media/image431.wmf){width="0.9416666666666667in"
height="0.20694444444444443in"}from 16 kHz to 20 kHz. The energy ratio
is calculated as follows:

![](media/image432.wmf){width="0.8909722222222223in"
height="0.4826388888888889in"} (786)

![](media/image433.wmf){width="1.082638888888889in"
height="0.29097222222222224in"} (787)

![](media/image434.wmf){width="2.042361111111111in"
height="0.23333333333333334in"} (788)

The energy ratio![](media/image435.wmf){width="0.5006944444444444in"
height="0.2423611111111111in"} is then transmitted to the decoder using
4 bits.

#### 5.2.6.2 Multi-mode FD Bandwidth Extension Coding

The input signal of current frame is divided into two parts: the low
band signal and the super higher band (SHB) signal for SWB signal or the
higher band (HB) signal for WB signal. The low band signal of the input
signal is coded by LP coding modes, and the SHB or HB signal of the
input signal is coded by the multi-mode FD bandwidth extension (BWE)
algorithm. A classification decision process of the SHB or HB signal of
input signal is first performed. Then, the multi-mode BWE algorithm for
LP-based coding modes uses a combination of adaptive spectral envelope
and time envelope coding for super wideband extension, and spectral
envelope coding for wideband extension, according to the result of the
classification decision process. The coded bitstream of low band signal,
the adaptive coded bitstream of SHB or HB signal as well as the result
of the classification decision process of current input signal are
output. Table 67 describes the multi-mode FD BWE at the different
bitrates of operation. Theoretically, the delay of the synthesized
output signal can be determined adaptively in the range of
![](media/image436.wmf){width="1.4756944444444444in"
height="0.20694444444444443in"} according to the delay of the core
coding algorithm![](media/image437.wmf){width="0.20694444444444443in"
height="0.20694444444444443in"} and the delay of the multi-mode
bandwidth extension
algorithm![](media/image438.wmf){width="0.23333333333333334in"
height="0.20694444444444443in"}. To achieve lowest delay for bandwidth
extension coding, the super higher band (SHB) signal is delayed by
![](media/image439.wmf){width="0.525in" height="0.20694444444444443in"}.
Here ![](media/image437.wmf){width="0.20833333333333334in"
height="0.20833333333333334in"} is larger than
![](media/image438.wmf){width="0.2326388888888889in"
height="0.20833333333333334in"}. Then, the achieved lowest delay of the
multi-mode bandwidth extension is
![](media/image437.wmf){width="0.20833333333333334in"
height="0.20833333333333334in"} in encoder side.

Table 62: Multi-mode FD BWE at different bitrates

  ------------------ ----------- -----------------------------------------
  Bitrate \[kbps\]   Bandwidth   Multi-mode FD BWE
  7.2, 8             WB          Blind, HARMONIC/NORMAL
  13.2               WB          Guided, HARMONIC/NORMAL
                     SWB         Guided, TRANSIENT/HARMONIC/NORMAL/NOISE
  32                 SWB/FB      Guided, TRANSIENT/HARMONIC/NORMAL/NOISE
  ------------------ ----------- -----------------------------------------

##### 5.2.6.2.1 SWB/FB Multi-mode FD Bandwidth Extension

For frames declared as TRANSIENT (TS) frames or as non-TRANSIENT, a bit
budget of 31 bits is allocated to the SWB Multi-mode FD Bandwidth
Extension. If the super higher band (SHB) signal of the input in the
previous frame or in the current frame is detected as TRANSIENT, then
the current frame is also classified as TRANSIENT. Non-TRANSIENT frames
can be further classified as HARMONIC (HM), NORMAL (NM) or NOISE (NS)
depending upon the frequency fluctuation that is detected. Two bits of
the bit budget are allocated to the signal class. In case of a TRANSIENT
frame, the remaining 29 bits are allocated to encode four spectral
envelopes and four time envelopes. For other cases, i.e. non-TRANSIENT
frames, the remaining 29 bits are allocated to encode fourteen spectral
envelopes, and no time envelope is encoded. For FD BWE encoding, the 320
MDCT coefficients of the SHB signal,
![](media/image440.wmf){width="1.5833333333333333in"
height="0.23333333333333334in"} are coded. In the case of the FB mode,
the encoding algorithm from 8kHz to 15.5kHz is the same as the SWB mode.
To encode 15.5kHz to 20kHz, the spectral energies of from 11 kHz to 15.5
kHz and from 15.5 kHz to 20 kHz are calculated, and then the ratio of
the two energies is coded using 4 bits after being quantized.

##### 5.2.6.2.1.1 Windowing and time-to-frequency transformation {#windowing-and-time-to-frequency-transformation .H6}

The input high-pass filtered
signal![](media/image441.wmf){width="0.4409722222222222in"
height="0.20694444444444443in"} is delayed
by![](media/image439.wmf){width="0.525in"
height="0.20833333333333334in"}samples and windowed to obtain the
windowed input signal![](media/image442.wmf){width="0.3in"
height="0.20694444444444443in"} as shown in figure 51, where
![](media/image443.wmf){width="0.525in"
height="0.20694444444444443in"}is equal to:

![](media/image444.wmf){width="1.8173611111111112in"
height="0.43194444444444446in"} (794)

![](media/image445.wmf){width="6.635416666666667in"
height="1.9076388888888889in"}

Figure 51: Windowing of the input high-pass filtered signal

A 640-point length MDCT on top of
![](media/image446.wmf){width="1.1666666666666667in"
height="0.20694444444444443in"}is used for SWB FD BWE. Refer to
subclause 5.3.2.

##### 5.2.6.2.1.2 Transient detection {#transient-detection .H6}

The input time-domain SHB
signal![](media/image447.wmf){width="0.4826388888888889in"
height="0.20694444444444443in"} of current frame, sampled at 16kHz, is
first high-pass filtered; the high-pass filter serves as a precaution
against low frequency components adversely affecting the processing. A
first order IIR filter is used, and it is given by:
![](media/image448.wmf){width="1.4819444444444445in"
height="0.4409722222222222in"} (795)

The output of the high-pass filter
![](media/image449.wmf){width="0.7319444444444444in"
height="0.23333333333333334in"} is obtained according to:
![](media/image450.wmf){width="4.982638888888889in"
height="0.23333333333333334in"} (796)

where ![](media/image451.wmf){width="0.4826388888888889in"
height="0.1673611111111111in"} denotes the 20ms frame length at 16kHz.
The high-pass filtered signal
![](media/image452.wmf){width="0.7319444444444444in"
height="0.23333333333333334in"}is divided into four sub-frames; each
corresponding to 5 ms or 80 samples.

The energy of each sub-frame,
![](media/image453.wmf){width="0.25763888888888886in"
height="0.1736111111111111in"}, is computed according to:

![](media/image454.wmf){width="3.0833333333333335in" height="0.525in"}
(797)

For each sub-frame, the signal's long term energy,
![](media/image455.wmf){width="0.25763888888888886in" height="0.225in"},
is updated according to the following equation:

![](media/image456.wmf){width="3.0236111111111112in"
height="0.26666666666666666in"} (798)

In the above equation, the forgetting factor
![](media/image457.wmf){width="0.15in" height="0.14097222222222222in"}
is set to 0.25, and the convention is that for the first sub-frame,

![](media/image458.wmf){width="0.6236111111111111in" height="0.225in"}
from the previous frame. It should be noted that when the current frame
and the previous frame apply different BWE algorithms, or the core
configurations are different, then the signals' long term
energy![](media/image459.wmf){width="0.27569444444444446in"
height="0.225in"} is calculated as
![](media/image460.wmf){width="1.2416666666666667in"
height="0.29097222222222224in"}.

The memory state of the high-pass filter,
![](media/image461.wmf){width="0.4583333333333333in"
height="0.1736111111111111in"}and![](media/image462.wmf){width="0.24861111111111112in"
height="0.225in"} are saved for the next frame's processing. For each
sub-frame ![](media/image463.wmf){width="0.15in"
height="0.14097222222222222in"}, a comparison between the short term
energy ![](media/image453.wmf){width="0.25763888888888886in"
height="0.175in"} and the short term energy of previous sub-frame
![](media/image464.wmf){width="0.35694444444444445in"
height="0.25763888888888886in"} or the long term energy
![](media/image465.wmf){width="0.35694444444444445in"
height="0.225in"}is performed to detect whether the current frame is
TRANSIENT or not. A transient is detected whenever the energy ratio is
above a certain threshold which is larger than 1. Formally, a transient
is detected whenever:

![](media/image466.wmf){width="0.8909722222222223in"
height="0.26666666666666666in"} (799)

where ![](media/image467.wmf){width="0.15in"
height="0.1673611111111111in"} is the energy ratio threshold and is set
to ![](media/image468.wmf){width="0.39861111111111114in"
height="0.19166666666666668in"} for INACTIVE frames and
![](media/image469.wmf){width="0.5159722222222223in"
height="0.19166666666666668in"}otherwise.

It should be noted that if the previous frame did not use SWB Multi-mode
FD BWE then the current frame is not classified as a transient frame. In
general, the time-frequency transform is applied on a 40ms frame;
therefore, a transient affects two consecutive frames. To overcome this,
a hangover for a detected transient is applied. A transient detected at
a certain frame also triggers a transient in the next frame.

The output of the transient detector is a flag, denoted
![](media/image470.wmf){width="0.6923611111111111in"
height="0.1673611111111111in"}. The flag is set to the logical value
*TRUE* if a transient is detected or *FALSE* otherwise.

In addition, the *parameters of spectral tilt and* frame class *for the
current frame are also used for further* refinement of the *transient*
decision.

The spectral tilt of the low frequency signal
![](media/image471.wmf){width="0.6659722222222222in"
height="0.23333333333333334in"} is calculated by:

![](media/image472.wmf){width="1.082638888888889in"
height="0.26666666666666666in"} (800)

where, ![](media/image473.wmf){width="0.15in"
height="0.20694444444444443in"}and
![](media/image474.wmf){width="0.14097222222222222in"
height="0.20694444444444443in"}are calculated by:

![](media/image475.wmf){width="1.832638888888889in"
height="0.5159722222222223in"} (801)

![](media/image476.wmf){width="0.14097222222222222in"
height="0.20694444444444443in"}is initialized
to![](media/image477.wmf){width="1.4159722222222222in"
height="0.29097222222222224in"}, and if
![](media/image478.wmf){width="4.442361111111111in"
height="0.23333333333333334in"},
![](media/image476.wmf){width="0.14166666666666666in"
height="0.20833333333333334in"}is adjusted by adding
![](media/image479.wmf){width="1.6256944444444446in"
height="0.29097222222222224in"}.

The spectral tilt and class of the current frame are checked against
threshold values, and the high frequency TRANSIENT signal classification
of the current frame is adjusted. Formally, when
![](media/image480.wmf){width="0.6923611111111111in"
height="0.1673611111111111in"} *is TRUE, and*
![](media/image481.wmf){width="0.4166666666666667in"
height="0.18263888888888888in"} , *the*
![](media/image480.wmf){width="0.6916666666666667in"
height="0.16666666666666666in"} signal classification *is set to FALSE,
and also* the hangover is set to 0.

Another flag, ![](media/image482.wmf){width="0.9986111111111111in"
height="0.19166666666666668in"}, is used to indicate whether a transient
is present in the low frequency signal
![](media/image483.wmf){width="0.26666666666666666in"
height="0.26666666666666666in"}of the current frame. It is calculated as
follows: When the
condition![](media/image484.wmf){width="1.5986111111111112in"
height="0.26666666666666666in"}is satisfied, then the
![](media/image485.wmf){width="0.9986111111111111in"
height="0.19166666666666668in"}flag is set to logical *TRUE; and it is
set to* *FALSE* otherwise*.
Here,*![](media/image486.wmf){width="2.2319444444444443in"
height="0.35694444444444445in"}, and the convention is that for the
first sub-frame,![](media/image487.wmf){width="0.6173611111111111in"
height="0.225in"} from the previous frame.

##### 5.2.6.2.1.3 Frequency domain classification and coding {#frequency-domain-classification-and-coding .H6}

In frames that are classified as containing transients, the value of
![](media/image488.wmf){width="0.30833333333333335in" height="0.225in"}
is set (![](media/image489.wmf){width="0.30833333333333335in"
height="0.2423611111111111in"}=TRANSIENT). For frames without
transients, a frequency sharpness parameter is computed to reflect the
spectral fluctuation of the frequency coefficients in the super high
band signal and those frames are categorized in one of three classes:

a\) HARMONIC: when frequency sharpness is high.

b\) NOISE: when frequency sharpness is low.

c\) NORMAL: when frequency sharpness is moderate.

The 288 MDCT coefficients in the 6400-13600 Hz frequency range,
![](media/image490.wmf){width="1.3319444444444444in"
height="0.23333333333333334in"} are split into nine sharpness bands (32
coefficients per band). The frequency
sharpness,![](media/image491.wmf){width="0.29097222222222224in"
height="0.20694444444444443in"}, is then defined as the ratio of the
peak magnitude to the average magnitude in a sharpness band
![](media/image492.wmf){width="0.12569444444444444in"
height="0.19166666666666668in"}

![](media/image493.wmf){width="5.1506944444444445in"
height="0.8159722222222222in"} (802)

where the maximum magnitude of spectral coefficients in a sharpness
band, denoted![](media/image494.wmf){width="0.5666666666666667in"
height="0.23333333333333334in"}, is given by

![](media/image495.wmf){width="3.225in" height="0.3506944444444444in"}
(803)

Then, six parameters are calculated; the global gain,
![](media/image496.wmf){width="1.7666666666666666in"
height="0.35694444444444445in"}, the
average![](media/image497.wmf){width="1.6916666666666667in"
height="0.35694444444444445in"}, the
![](media/image498.wmf){width="2.4in" height="0.5423611111111111in"},
and three further sharpness parameters are determined; the maximum
sharpness, ![](media/image499.wmf){width="0.3326388888888889in"
height="0.20694444444444443in"} , the sharpness band counter,
![](media/image500.wmf){width="0.375in" height="0.23333333333333334in"},
and the noise band counter,
![](media/image501.wmf){width="0.3506944444444444in"
height="0.20694444444444443in"}.

The maximum
sharpness,![](media/image502.wmf){width="0.3326388888888889in"
height="0.20694444444444443in"}, in all sharpness bands is computed as:

![](media/image503.wmf){width="1.4423611111111112in"
height="0.30833333333333335in"} (804)

The counter![](media/image504.wmf){width="0.375in"
height="0.23333333333333334in"}is computed from the nine frequency
sharpness
parameters,![](media/image505.wmf){width="0.29097222222222224in"
height="0.20694444444444443in"}, and from the nine maximum magnitudes,
![](media/image506.wmf){width="0.5666666666666667in"
height="0.23333333333333334in"}, as follows: Initialized to zero,
![](media/image507.wmf){width="0.375in" height="0.23333333333333334in"}
is incremented by one for each
![](media/image508.wmf){width="0.12569444444444444in"
height="0.19166666666666668in"},![](media/image509.wmf){width="0.6in"
height="0.19166666666666668in"},
if![](media/image510.wmf){width="0.6083333333333333in"
height="0.20694444444444443in"}and![](media/image511.wmf){width="0.7736111111111111in"
height="0.23333333333333334in"}.

The counter![](media/image512.wmf){width="0.3506944444444444in"
height="0.20694444444444443in"} is computed from the nine frequency
sharpness
parameters![](media/image513.wmf){width="0.29097222222222224in"
height="0.20694444444444443in"}as follows: Initialized to zero,
![](media/image514.wmf){width="0.3506944444444444in"
height="0.20694444444444443in"} is incremented by one for
each![](media/image508.wmf){width="0.125in"
height="0.19166666666666668in"},![](media/image515.wmf){width="0.6083333333333333in"
height="0.19166666666666668in"}if
![](media/image516.wmf){width="0.29097222222222224in"
height="0.20694444444444443in"}is less than 3.

The class of non-TRANSIENT frames is determined from the three sharpness
parameters, ![](media/image502.wmf){width="0.3333333333333333in"
height="0.20833333333333334in"},![](media/image517.wmf){width="0.375in"
height="0.23333333333333334in"}
and![](media/image512.wmf){width="0.35in"
height="0.20833333333333334in"} and four other parameters; the previous
frame saved class, ![](media/image518.wmf){width="0.35694444444444445in"
height="0.26666666666666666in"}, $A_{\text{av}}$, $S_{\text{var}}$, and
the ratio of the global gains in the current and previous frames.

The threshold of the number of harmonics$i_{\text{sharp}}$ and the
threshold of the maximum sharpness $l_{\text{sharp}}$are set according
to the signal class of previous
frame$F_{\text{class}}^{\left\lbrack - 1 \right\rbrack}$ and the mode of
previous extension layer$M_{\text{last}_{\text{extl}}}$. When the
bandwidth is changed i.e.,
$M_{\text{last}_{\text{extl}}} \neq \text{SWB}_{\text{BWE}}$, the
$i_{\text{sharp}}$ and $l_{\text{sharp}}$ will be decreased for harmonic
mode and increased for other signal mode:

![](media/image519.wmf){width="4.565972222222222in"
height="1.4006944444444445in"} (805)

![](media/image520.wmf){width="2.582638888888889in"
height="0.7916666666666666in"} (806)

-- If![](media/image521.wmf){width="0.8159722222222222in"
height="0.23333333333333334in"},![](media/image522.wmf){width="1.35in"
height="0.29097222222222224in"} and
![](media/image523.wmf){width="0.7736111111111111in"
height="0.23333333333333334in"}, the current frame is classified as
HARMONIC frame (![](media/image489.wmf){width="0.35694444444444445in"
height="0.27569444444444446in"}= HARMONIC) and the counter for signal
class![](media/image524.wmf){width="0.3506944444444444in"
height="0.20694444444444443in"}is incremented by one
when![](media/image525.wmf){width="0.3506944444444444in"
height="0.20694444444444443in"}is less than twelve. Otherwise,
![](media/image525.wmf){width="0.35in" height="0.20833333333333334in"}is
decremented by one when![](media/image525.wmf){width="0.35in"
height="0.20833333333333334in"}is larger than zero.

-- Then, if![](media/image526.wmf){width="0.5576388888888889in"
height="0.20694444444444443in"}, the current frame is also classified as
HARMONIC frame (![](media/image489.wmf){width="0.3576388888888889in"
height="0.275in"}= HARMONIC).

-- For other cases, depending on the noise
counter![](media/image512.wmf){width="0.35in"
height="0.20833333333333334in"},![](media/image527.wmf){width="0.24861111111111112in"
height="0.20694444444444443in"},
![](media/image528.wmf){width="0.29097222222222224in"
height="0.20694444444444443in"}, and the spectral
tilt![](media/image529.wmf){width="0.5576388888888889in"
height="0.20694444444444443in"}**,**the current frame is classified as
NORMAL or NOISE:

> if![](media/image530.wmf){width="0.6in"
> height="0.24861111111111112in"},![](media/image531.wmf){width="0.8909722222222223in"
> height="0.20694444444444443in"}and![](media/image532.wmf){width="0.7673611111111112in"
> height="0.20694444444444443in"}, the current frame is classified as
> NOISE frame (![](media/image489.wmf){width="0.3576388888888889in"
> height="0.275in"}= NOISE), otherwise, the current frame is classified
> as NORMAL frame (![](media/image489.wmf){width="0.3576388888888889in"
> height="0.275in"}= NORMAL).

Two bits are transmitted for SHB signal class coding. Table 63 gives the
coded bits for each class.

Table 64: SHB signal class coding

  ------------------------------------------------------------------------------------- ------------
  Signal class ![](media/image489.wmf){width="0.3576388888888889in" height="0.275in"}   Coded bits
  NOISE                                                                                 00
  TRANSIENT                                                                             01
  NORMAL                                                                                10
  HARMONIC                                                                              11
  ------------------------------------------------------------------------------------- ------------

The signal class ![](media/image533.wmf){width="0.35694444444444445in"
height="0.27569444444444446in"} of the current frame is preserved as
![](media/image534.wmf){width="0.35694444444444445in"
height="0.26666666666666666in"} for the next frame.

##### 5.2.6.2.1.4 Sub-band division {#sub-band-division .H6}

The 320 MDCT coefficients
(![](media/image535.wmf){width="0.5819444444444445in"
height="0.23333333333333334in"}at 13.2kbps in the 6150-14150 Hz
frequency range, ![](media/image536.wmf){width="0.6506944444444445in"
height="0.23333333333333334in"} at 32kbps in the 8000-16000 Hz frequency
range) are either split into four sub-bands for TRANSIENT frames or
fourteen sub-bands for non-TRANSIENT frames. Table 65 and table 66
define the sub-band boundaries and sizes for TRANSIENT frames and
non-TRANSIENT frames respectively.
The![](media/image537.wmf){width="0.12569444444444444in"
height="0.19166666666666668in"}-th sub-band comprises coefficients
![](media/image538.wmf){width="0.7673611111111112in"
height="0.23333333333333334in"} where
![](media/image539.wmf){width="1.3736111111111111in"
height="0.20694444444444443in"}.

Table 67: Sub-band boundaries and number of coefficients per sub-band in
TRANSIENT frames

  --------- -------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------
  ***j***   ![](media/image540.wmf){width="0.4583333333333333in" height="0.20694444444444443in"}   ![](media/image541.wmf){width="0.6083333333333333in" height="0.23333333333333334in"}
  0         0                                                                                      76
  1         76                                                                                     76
  2         152                                                                                    84
  3         236                                                                                    84
  4         320                                                                                    \-
  --------- -------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------

Table 68: Sub-band boundaries and number of coefficients per sub-band in
Non-TRANSIENT frames

  ----- ----------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------
  *j*   ![](media/image540.wmf){width="0.4583333333333333in" height="0.20833333333333334in"}*)*   ![](media/image542.wmf){width="0.6083333333333333in" height="0.23333333333333334in"}
  0     0                                                                                         16
  1     16                                                                                        24
  2     40                                                                                        16
  3     56                                                                                        24
  4     80                                                                                        16
  5     96                                                                                        24
  6     120                                                                                       16
  7     136                                                                                       24
  8     160                                                                                       24
  9     184                                                                                       24
  10    208                                                                                       24
  11    232                                                                                       24
  12    256                                                                                       32
  13    288                                                                                       32
  14    320                                                                                       \-
  ----- ----------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------

##### 5.2.6.2.1.5 Spectral envelope calculation and quantization {#spectral-envelope-calculation-and-quantization .H6}

The spectral envelope, or the energy of each band, is computed as
follows:

![](media/image543.wmf){width="4.358333333333333in" height="0.6in"}
(807)

If the current frame is a Non-TRANSIENT frame, energy control is
performed to prevent too much noise being applied to the generated
spectrum. The energy control adjusts the spectral energy of each band,
depending on the different characteristics between the original high
frequency spectrum and the base excitation spectrum.

First a spectral copy is created by mapping the frequencies, depending
upon the bandwidth, the ACELP coding modes and the FD BWE mode as
defined in table 69.

Table 70: Frequency mapping to generate base excitation spectrum in FD
BWE

+-----------+-----+-----------+-----------+-----------+-----------+
| ***Mode,  | *l* | ![](med   | ![](med   | ![](med   | ![](med   |
| Bit-rate, |     | ia/image5 | ia/image5 | ia/image5 | ia/image5 |
| ACELP     |     | 44.wmf){w | 45.wmf){w | 46.wmf){w | 47.wmf){w |
| coding    |     | idth="0.6 | idth="0.7 | idth="0.6 | idth="0.7 |
| modes***  |     | 326388888 | 319444444 | 326388888 | 319444444 |
|           |     | 888889in" | 444444in" | 888889in" | 444444in" |
|           |     | heig      | heig      | heig      | heig      |
|           |     | ht="0.215 | ht="0.206 | ht="0.215 | ht="0.215 |
|           |     | 972222222 | 944444444 | 972222222 | 972222222 |
|           |     | 22223in"} | 44443in"} | 22223in"} | 22223in"} |
+-----------+-----+-----------+-----------+-----------+-----------+
| WB @ 7.2, | 0   | 160       | 239       | 240       | 319       |
| 8kbps     |     |           |           |           |           |
|           |     |           |           |           |           |
| All       |     |           |           |           |           |
| LP-based  |     |           |           |           |           |
| modes     |     |           |           |           |           |
| except    |     |           |           |           |           |
| for AUDIO |     |           |           |           |           |
+-----------+-----+-----------+-----------+-----------+-----------+
| WB @ 7.2, | 0   | 80        | 159       | 240       | 319       |
| 8kbps     |     |           |           |           |           |
|           |     |           |           |           |           |
| AUDIO     |     |           |           |           |           |
|           |     |           |           |           |           |
| WB @      |     |           |           |           |           |
| 13.2kbps  |     |           |           |           |           |
|           |     |           |           |           |           |
| All       |     |           |           |           |           |
+-----------+-----+-----------+-----------+-----------+-----------+
| SWB @     | 0   | 112       | 239       | 246       | 373       |
| 13.2kbps  |     |           |           |           |           |
|           |     |           |           |           |           |
| NORMAL,   |     |           |           |           |           |
| NOISE     |     |           |           |           |           |
+-----------+-----+-----------+-----------+-----------+-----------+
|           | 1   | 112       | 239       | 374       | 501       |
+-----------+-----+-----------+-----------+-----------+-----------+
|           | 2   | 176       | 239       | 502       | 565       |
+-----------+-----+-----------+-----------+-----------+-----------+
| SWB @     | 0   | 0         | 239       | 246       | 485       |
| 13.2kbps  |     |           |           |           |           |
|           |     |           |           |           |           |
| HARMONIC  |     |           |           |           |           |
+-----------+-----+-----------+-----------+-----------+-----------+
|           | 1   | 128       | 207       | 486       | 565       |
+-----------+-----+-----------+-----------+-----------+-----------+
| SWB @     | 0   | 112       | 239       | 320       | 447       |
| 32kbps    |     |           |           |           |           |
|           |     |           |           |           |           |
| NORMAL,   |     |           |           |           |           |
| NOISE     |     |           |           |           |           |
+-----------+-----+-----------+-----------+-----------+-----------+
|           | 1   | 112       | 239       | 448       | 575       |
+-----------+-----+-----------+-----------+-----------+-----------+
|           | 2   | 176       | 239       | 576       | 639       |
+-----------+-----+-----------+-----------+-----------+-----------+
| SWB @     | 0   | 0         | 239       | 320       | 559       |
| 32kbps    |     |           |           |           |           |
|           |     |           |           |           |           |
| HARMONIC  |     |           |           |           |           |
+-----------+-----+-----------+-----------+-----------+-----------+
|           | 1   | 128       | 207       | 560       | 639       |
+-----------+-----+-----------+-----------+-----------+-----------+

To generate the base excitation spectrum, the spectral copy is
normalized by the sum of its absolute spectral components; the window
size used depends on the signal characteristics.

![](media/image548.wmf){width="4.607638888888889in"
height="0.7673611111111112in"} (808)

The tonality measures used for the energy control are then calculated:

![](media/image549.wmf){width="5.291666666666667in"
height="0.9326388888888889in"} (809)

The ratio between the tonality of the original high frequency spectrum
(![](media/image550.wmf){width="0.7743055555555556in"
height="0.2326388888888889in"}) and the tonality of the base excitation
spectrum (![](media/image551.wmf){width="0.7736111111111111in"
height="0.23333333333333334in"}) is then calculated as follows:

![](media/image552.wmf){width="5.417361111111111in" height="0.9in"}
(810)

where ![](media/image553.wmf){width="0.6083333333333333in"
height="0.23333333333333334in"}is 0.35.

The envelope control factor
![](media/image554.wmf){width="0.8333333333333334in"
height="0.20694444444444443in"} is then applied to the envelope
![](media/image555.wmf){width="0.9in" height="0.29097222222222224in"}:

![](media/image556.wmf){width="3.542361111111111in"
height="0.26666666666666666in"} (811)

Next the spectral envelope is adjusted by subtracting the mean
vectors![](media/image557.wmf){width="0.7666666666666667in"
height="0.26666666666666666in"} which are shown in table 67.

![](media/image558.wmf){width="3.8756944444444446in"
height="0.26666666666666666in"} (812)

Table 71: Mean vectors in FD BWE

  --------- ----------- ---------------
  ***j***   TRANSIENT   Non-TRANSIENT
  0         27.23       28.62
  1         23.81       28.96
  2         23.87       28.05
  3         19.51       27.97
  4         \-          26.91
  5         \-          26.82
  6         \-          26.35
  7         \-          25.98
  8         \-          24.94
  9         \-          24.03
  10        \-          22.94
  11        \-          22.14
  12        \-          21.23
  13        \-          20.40
  --------- ----------- ---------------

If the current frame is a TRANSIENT frame, the following smoothing
processes are applied before the envelope quantization.

> -- If ![](media/image485.wmf){width="1.0in"
> height="0.19166666666666668in"}*is TRUE*, the coder type is INACTIVE
> and the transient hangover is equal to one, the flag is set to 1, and
> the time envelope is adjusted as follows:

![](media/image559.wmf){width="2.441666666666667in"
height="0.23333333333333334in"} (813)

-- Otherwise, the adjustment is as follows:

![](media/image560.wmf){width="2.1659722222222224in"
height="0.6506944444444445in"} (814)

If the current frame is a Non-TRANSIENT frame,

![](media/image561.wmf){width="3.0659722222222223in"
height="0.29097222222222224in"} (815)

If the current frame is a TRANSIENT frame, the mean squared error (MSE)
criterion is used for the search of the VQ, in a Non-TRANSIENT frame,
the weighted mean squared error (WMSE) is used. The weighting serves to
emphasise the lower frequency bands and is calculated by two methods;
one is a deterministic weighting based solely on the frequency, and the
other is a weighting that is calculated based upon the envelope. The
first frequency weighting ![](media/image562.wmf){width="0.65in"
height="0.2326388888888889in"}is defined in table 68 and the second
frequency weighting ![](media/image563.wmf){width="0.5423611111111111in"
height="0.20694444444444443in"}is calculated as follows:

![](media/image564.wmf){width="5.5256944444444445in"
height="0.6506944444444445in"} (816)

Table 72: Frequency weighting
![](media/image565.wmf){width="0.6506944444444445in"
height="0.23333333333333334in"}

  --------- ---------------
  ***j***   Non-TRANSIENT
  0         1.0
  1         0.97826087
  2         0.957446809
  3         0.9375
  4         0.918367347
  5         0.9
  6         0.882352941
  7         0.865384615
  8         0.849056604
  9         0.833333333
  10        0.818181818
  11        0.803571429
  12        0.789473684
  13        0.775862069
  --------- ---------------

The SWB spectral envelope is quantized with a multi-stage split VQ using
envelope interpolation as in figure 52. In the first stage, two or three
candidates' (![](media/image566.wmf){width="0.3923611111111111in"
height="0.20694444444444443in"}, three in TRANSIENT frame, two in
Non-TRANSIENT frame) indices are chosen using the error minimization
criterion. The set of candidates with the least quantization error,
taking into account all quantization steps, is then selected and the
selected indices transmitted.

![](media/image567.wmf){width="6.690972222222222in" height="2.75625in"}

Figure 53: Envelope VQ in a TRANSIENT frame and a Non-TRANSIENT frame

Again during the first stage, values in even positions are selected and
quantized using VQ with 5 bits for Non-TRANSIENT frames and 7 bits for
TRANSIENT frames.

$\hat{e}\text{nv}_{1}(j) = \begin{matrix}
{\overline{f}}_{\text{rms}_{\text{SHB}}}(2 \ast j) & j = 0,\text{.}\text{.}\text{.}6\ (\text{Non} - \text{TRANSIENT}) \\
\end{matrix}$ (817)

$\hat{e}\text{nv}_{1}(j) = \begin{matrix}
{\overline{f}}_{\text{rms}_{\text{SHB}}}(2 \ast j) & j = 0,1\ (\text{TRANSIENT}) \\
\end{matrix}$ (818)

In Non-TRANSIENT frames, the candidate indices from the first stage VQ
are defined as ![](media/image568.wmf){width="1.082638888888889in"
height="0.23333333333333334in"}. The quantization error
![](media/image569.wmf){width="0.25in" height="0.20833333333333334in"}is
calculated and the error is split into
![](media/image570.wmf){width="0.3159722222222222in"
height="0.20833333333333334in"} and
![](media/image571.wmf){width="0.3173611111111111in"
height="0.20694444444444443in"}and quantized using 7 bits and 6 bits
respectively, as follows:

![](media/image572.wmf){width="3.332638888888889in"
height="0.26666666666666666in"} (817)

then;

![](media/image573.wmf){width="3.5006944444444446in"
height="0.5159722222222223in"} (818)

The candidate indices from the second stage VQ are defined as
![](media/image574.wmf){width="1.1423611111111112in"
height="0.23333333333333334in"} and
![](media/image575.wmf){width="1.148611111111111in"
height="0.23333333333333334in"}.

The two quantized values
![](media/image576.wmf){width="0.6416666666666667in"
height="0.20694444444444443in"}are then combined:

![](media/image577.wmf){width="2.4in" height="0.4826388888888889in"}
(821)

At odd positions, an interpolation using boundary values is applied for
intra-frame prediction and the predicted error is calculated:

![](media/image578.wmf){width="5.25in" height="0.6833333333333333in"}
(819)

The errors are then split into
![](media/image579.wmf){width="0.35694444444444445in"
height="0.20694444444444443in"} and
![](media/image580.wmf){width="0.375in"
height="0.20694444444444443in"}and quantized using 5 bits and 6 bits
respectively.

![](media/image581.wmf){width="3.0in" height="0.43194444444444446in"}
(820)

The candidate indices from the third stage VQ are defined
as![](media/image582.wmf){width="1.1069444444444445in"
height="0.23333333333333334in"}. In a TRANSIENT frame only 2 stages of
quantization are applied. At odd positions, an interpolation using
boundary values is applied for intra-frame prediction and the predicted
error is calculated and quantized

$\text{Ierr}_{2}(j) = \left\{ \begin{matrix}
\begin{matrix}
{\overline{f}}_{\text{rms}_{\text{SHB}}}(2 \ast j + 1) - \frac{(\hat{e}\text{nv}_{1}(j) + \hat{e}\text{nv}_{1}(j + 1))}{2} & \\
\end{matrix} & j = 0 \\
{\overline{f}}_{\text{rms}_{\text{SHB}}}(2 \ast j + 1) - \hat{e}\text{nv}_{1}(j) & j = 1 \\
\end{matrix} \right.\ $ (824)

The candidate indices from the second stage VQ are defined as
![](media/image583.wmf){width="1.5569444444444445in"
height="0.23333333333333334in"}.

The final selected set of indices
![](media/image584.wmf){width="2.3333333333333335in"
height="0.23333333333333334in"} for a Non-Transient frame, or
![](media/image585.wmf){width="0.9569444444444445in"
height="0.23333333333333334in"} for a Transient frame are then
transmitted.

##### 5.2.6.2.1.6 Time envelope calculation and encoding {#time-envelope-calculation-and-encoding .H6}

In case of TRANSIENT frames, ie, the super higher band (SHB) signal of
the input in the previous frame is detected as TRANSIENT and the super
higher band (SHB) signal of the input in the current frame is detected
as NON-TRANSIENT, or the super higher band (SHB) signal of the input in
the current frame is detected as TRANSIENT, the time envelope is also
calculated. The time envelope, which represents the temporal energy of
the SHB signal, is computed as a set of root mean square (RMS)
calculations from each 80 samples of time-domain SHB signal. This
results in four time envelope coefficients per frame.

![](media/image586.wmf){width="3.107638888888889in"
height="0.4166666666666667in"} (821)

The time envelope is firstly adjusted by the attenuated value which
represents the energy attenuation of the WB signal, and the attenuated
value is calculated by the original WB
signal![](media/image587.wmf){width="0.43194444444444446in"
height="0.20694444444444443in"} and local synthesized WB
signal![](media/image588.wmf){width="0.4409722222222222in"
height="0.23333333333333334in"}:

![](media/image589.wmf){width="2.357638888888889in"
height="0.39861111111111114in"} (822)

![](media/image590.wmf){width="3.2333333333333334in"
height="0.6506944444444445in"} (823)

In order to highlight the characteristics of the transient signal, the
time envelope of the transient signals is modified. A reference
sub-frame is first selected from the sub-frames of the input transient
signal, which has the maximal amplitude value of envelope compared with
values of the envelopes of the rest sub-frames. Then the time envelope
of the reference sub-frame is increased whilst at the same time the
envelopes of the sub-frames before and after the reference sub-frame are
decreased. Then, the adjusted time envelopes of the SHB signal of the
current frame are quantized and coded into the bitstream. I**n order to
get better transient effect, in** sub-frames before and after the
reference sub-frame**, the difference between the** decreased **time
envelope and the maximum time envelope is greater than a preset
threshold**.

-- If the sub-frame index
![](media/image591.wmf){width="0.39861111111111114in"
height="0.20694444444444443in"} which is defined
as![](media/image592.wmf){width="1.7909722222222222in"
height="0.20694444444444443in"}is less than 4, the time envelope is
adjusted **by:**

![](media/image593.wmf){width="2.642361111111111in"
height="0.7673611111111112in"} (824)

> where![](media/image594.wmf){width="1.7486111111111111in"
> height="0.3506944444444444in"} is the sub-frame index with the maximum
> time envelope . It should be noted when the sub-frame
> index![](media/image595.wmf){width="0.9173611111111111in"
> height="0.23333333333333334in"},and when the condition
> ![](media/image596.wmf){width="3.392361111111111in"
> height="0.4409722222222222in"} is satisfied, the adjustment of time
> envelope of sub-frame
> ![](media/image597.wmf){width="1.0256944444444445in"
> height="0.23333333333333334in"} can be performed.

-- For other cases, to obtain the time envelopes of the SHB signal of
the current frame used to encode, the adjustment is as follows:

![](media/image598.wmf){width="5.081944444444445in"
height="0.4826388888888889in"} (825)

> and

![](media/image599.wmf){width="2.4833333333333334in"
height="0.23333333333333334in"} (826)

In addition, when ![](media/image485.wmf){width="1.0in"
height="0.19166666666666668in"}*is TRUE*, the coder type is INACTIVE and
the transient hangover is equal to one, the flag is then set to 1, and
the time envelope is adjusted as follows

![](media/image600.wmf){width="3.167361111111111in"
height="0.4583333333333333in"} (827)

Finally, the values![](media/image601.wmf){width="2.207638888888889in"
height="0.20694444444444443in"} are further bounded in the range
\[0,\...,15\]: ![](media/image602.wmf){width="0.9in"
height="0.20694444444444443in"},![](media/image603.wmf){width="0.525in"
height="0.20069444444444445in"}.

The adjusted time
envelopes![](media/image604.wmf){width="0.43194444444444446in"
height="0.20694444444444443in"} are rounded and quantized with four bits
using uniform scalar quantization in the case of TRANSIENT frames.

##### 5.2.6.2.1.7 Bit allocation for FD BWE {#bit-allocation-for-fd-bwe .H6}

Table 73 illustrates the BWE bit allocation for TRANSIENT and
Non-TRANSIENT frames.

Table 74: SWB FD BWE bit allocation

  --------------- ----------------------------------------------------------------------------------------------------------- ------------------------------------------------------------------------------------------------------ ---------------------------------------------------------------------------------------------------------- ------------
  Signal class    Signal class bits (![](media/image605.wmf){width="0.35694444444444445in" height="0.20694444444444443in"})   Time envelope (![](media/image606.wmf){width="0.4409722222222222in" height="0.20694444444444443in"})   Spectral envelope (![](media/image607.wmf){width="0.4826388888888889in" height="0.20694444444444443in"})   Total bits
  TRANSIENT       2                                                                                                           16 (=4×4)                                                                                              13 (=7+6)                                                                                                  31
  NON-TRANSIENT   2                                                                                                           0                                                                                                      29 (=5+7+6+5+6)                                                                                            31
  --------------- ----------------------------------------------------------------------------------------------------------- ------------------------------------------------------------------------------------------------------ ---------------------------------------------------------------------------------------------------------- ------------

##### 5.2.6.2.2 WB Multi-mode FD Bandwidth Extension

At 13.2kbps, for frame declared as HARMONIC (HM) frame or NORMAL (NM), a
bit budget of 6 bits is allocated to the WB Multi-mode FD Bandwidth
Extension. One bit is allocated to the signal class and five bits are
allocated to encode two spectral envelopes which are calculated by the
80 MDCT coefficients of the higher band (HB) signal,
![](media/image608.wmf){width="1.5986111111111112in"
height="0.23333333333333334in"}.

At 7.2kbps or 8kbps, it is blind BWE and no bit budget is allocated. In
this case, a two-stage blind BWE is used. In the first stage, the high
band frequency generation is the same as the BWE in AMR-WB \[9\],
described in subclauses 6.3.1, 6.3.2.2 and 6.3.3 of \[9\], and it is
added to the ACELP core synthesis. Then the second stage BWE is
generated as described in the following sub-clauses, and it is added to
the core synthesis with the first stage BWE. At 5.9 kbps VBR coding and
CNG coding up to 8.0 kbps, the BWE is also blind with no bit budget
allocated, but only the first stage BWE is used.

##### 5.2.6.2.2.1 Windowing and time-to-frequency transformation {#windowing-and-time-to-frequency-transformation-1 .H6}

The input high-pass filtered
signal![](media/image441.wmf){width="0.44166666666666665in"
height="0.20833333333333334in"} is delayed
by![](media/image439.wmf){width="0.525in"
height="0.20833333333333334in"}samples and windowed to obtain the
windowed input signal![](media/image442.wmf){width="0.3in"
height="0.20833333333333334in"} as shown in figure 54, where
![](media/image609.wmf){width="0.7916666666666666in"
height="0.23333333333333334in"}.

320-point length MDCT on top of
![](media/image610.wmf){width="1.1666666666666667in"
height="0.20694444444444443in"} is used for WB FD BWE. Refer to
subclause 5.3.2.

##### 5.2.6.2.2.2 Frequency domain classification and coding {#frequency-domain-classification-and-coding-1 .H6}

At 13.2kbps, frequency domain classification is performed. A frequency
sharpness parameter is computed to reflect the spectral fluctuation of
the frequency coefficients in the higher band signal and those frames
are categorized in one of two classes:

a\) HARMONIC: when frequency sharpness is high.

b\) NORMAL: when frequency sharpness is moderate.

The 96 MDCT coefficients in the 5600-8000 Hz frequency range
![](media/image611.wmf){width="1.5833333333333333in"
height="0.23333333333333334in"} are split into three sharpness bands (32
coefficients per band). The frequency
sharpness,![](media/image491.wmf){width="0.2916666666666667in"
height="0.20833333333333334in"}, is then defined as the ratio of the
peak magnitude to the average magnitude in a sharpness band
![](media/image492.wmf){width="0.125in" height="0.19166666666666668in"}

![](media/image612.wmf){width="5.558333333333334in"
height="0.8159722222222222in"} (828)

where the maximum magnitude of spectral coefficients in a sharpness
band, denoted![](media/image494.wmf){width="0.5659722222222222in"
height="0.2326388888888889in"}, is given by

![](media/image613.wmf){width="3.623611111111111in"
height="0.3506944444444444in"} (829)

Then, another two sharpness parameters are determined: the maximum
sharpness, ![](media/image499.wmf){width="0.3333333333333333in"
height="0.20833333333333334in"} , and the sharpness band counter,
![](media/image500.wmf){width="0.375in" height="0.2326388888888889in"}.

The maximum
sharpness,![](media/image502.wmf){width="0.3333333333333333in"
height="0.20833333333333334in"}, in all sharpness bands is computed as:

![](media/image614.wmf){width="1.148611111111111in"
height="0.30833333333333335in"} (830)

The counter![](media/image504.wmf){width="0.375in"
height="0.2326388888888889in"}is computed from the three frequency
sharpness parameters,
![](media/image615.wmf){width="0.8069444444444445in"
height="0.20694444444444443in"}, and from the three maximum magnitudes,
![](media/image506.wmf){width="0.5659722222222222in"
height="0.2326388888888889in"}, as follows: Initialized to zero,
![](media/image507.wmf){width="0.375in" height="0.2326388888888889in"}
is incremented by one for each ![](media/image508.wmf){width="0.125in"
height="0.19166666666666668in"}
if![](media/image510.wmf){width="0.6076388888888888in"
height="0.20833333333333334in"}and![](media/image511.wmf){width="0.7743055555555556in"
height="0.2326388888888889in"}.

The class of HARMONIC frame is determined from these three sharpness
parameters, ![](media/image502.wmf){width="0.3333333333333333in"
height="0.20833333333333334in"},![](media/image517.wmf){width="0.375in"
height="0.2326388888888889in"} and the class of the previous frame,
![](media/image616.wmf){width="0.35694444444444445in"
height="0.26666666666666666in"}.

The threshold of the number of harmonics
![](media/image617.wmf){width="0.34930555555555554in"
height="0.2326388888888889in"} and the threshold of the maximum
sharpness ![](media/image618.wmf){width="0.34930555555555554in"
height="0.2326388888888889in"}are set according to the class of the
previous frame![](media/image619.wmf){width="0.35694444444444445in"
height="0.26666666666666666in"} and the mode of previous extension
layer![](media/image620.wmf){width="0.6076388888888888in"
height="0.2326388888888889in"}:

![](media/image621.wmf){width="2.558333333333333in"
height="0.5159722222222223in"} (831)

![](media/image622.wmf){width="2.792361111111111in"
height="0.7916666666666666in"} (832)

Initialize the signal class of the current frame as NORMAL frame
(![](media/image623.wmf){width="0.35694444444444445in"
height="0.27569444444444446in"}= NORMAL).

-- If![](media/image521.wmf){width="0.8159722222222222in"
height="0.2326388888888889in"} and
![](media/image624.wmf){width="0.7736111111111111in"
height="0.23333333333333334in"}, the current frame is classified as
HARMONIC frame (![](media/image625.wmf){width="0.35694444444444445in"
height="0.26666666666666666in"}= HARMONIC) and the counter for signal
class![](media/image524.wmf){width="0.35in"
height="0.20833333333333334in"}is initialized to 0, and incremented by
one when![](media/image525.wmf){width="0.35in"
height="0.20833333333333334in"}is less than twelve. Otherwise,
![](media/image525.wmf){width="0.35in" height="0.20833333333333334in"}is
decremented by one when![](media/image525.wmf){width="0.35in"
height="0.20833333333333334in"}is larger than zero.

-- If the counter for signal class![](media/image524.wmf){width="0.35in"
height="0.20833333333333334in"} is not less than 2, the current frame is
also classified as HARMONIC.

One bit is transmitted for HB signal class coding. Table 75 gives the
coded bit for each class.

Table 76: HB signal class coding

  ------------------------- -----------
  Signal class *F~class~*   Coded bit
  NORMAL                    0
  HARMONIC                  1
  ------------------------- -----------

The signal class ![](media/image533.wmf){width="0.3576388888888889in"
height="0.275in"} of the current frame is preserved as
![](media/image626.wmf){width="0.35694444444444445in"
height="0.26666666666666666in"} for the next frame.

##### 5.2.6.2.2.3 Spectral envelope calculation and quantization {#spectral-envelope-calculation-and-quantization-1 .H6}

The spectral envelopes are computed from each 40 samples of
frequency-domain HB signal. This results in two spectral envelopes per
frame.

![](media/image627.wmf){width="3.225in" height="0.5576388888888889in"}
(833)

Then envelope control is performed to prevent too much noise being
applied to the reconstructed spectrum. First a spectral copy is created
by mapping the frequencies, depending upon the bandwidth, the ACELP
coding modes and the FD BWE mode as defined in table **77**.

To generate the base excitationexcitation spectrum, the spectral copy is
normalized by the sum of its absolute spectral components. The parameter
of adaptive normalization length ![](media/image628.wmf){width="0.375in"
height="0.20694444444444443in"} is calculated depending on the original
WB MDCT coefficients:

-- The 256 WB MDCT coefficients in the 0-6400 Hz frequency range,
![](media/image629.wmf){width="1.4159722222222222in"
height="0.26666666666666666in"} are split into 16 sharpness bands (16
coefficients per band). In sharpness band *j*, if
![](media/image630.wmf){width="2.1416666666666666in" height="0.375in"}
and![](media/image631.wmf){width="0.8333333333333334in"
height="0.23333333333333334in"} , the counter
![](media/image632.wmf){width="0.375in"
height="0.20694444444444443in"}is incremented by one.

> where![](media/image633.wmf){width="0.6659722222222222in"
> height="0.19166666666666668in"}, and the maximum magnitude of the
> spectral coefficients in a sharpness band,
> denoted![](media/image634.wmf){width="0.5666666666666667in"
> height="0.23333333333333334in"}, is:

![](media/image635.wmf){width="3.332638888888889in"
height="0.3506944444444444in"} (834)

> Parameter![](media/image632.wmf){width="0.375in"
> height="0.20833333333333334in"}is initialized to 0 and calculated for
> every frame.

-- Then the normalization length
![](media/image636.wmf){width="0.35694444444444445in"
height="0.20694444444444443in"}is obtained:

![](media/image637.wmf){width="2.25in" height="0.23333333333333334in"}
(835)

where the current normalization length
![](media/image638.wmf){width="0.6083333333333333in"
height="0.23333333333333334in"} is calculated depending on the HB signal
class:

![](media/image639.wmf){width="3.6659722222222224in"
height="0.4583333333333333in"} (836)

and the current normalization length is preserved
as![](media/image640.wmf){width="0.6236111111111111in"
height="0.23333333333333334in"}for the next frame.

Then the base excitation spectrum is obtained by:

![](media/image641.wmf){width="2.123611111111111in" height="0.525in"}
(837)

where, ![](media/image642.wmf){width="1.898611111111111in"
height="0.30833333333333335in"}are the spectral copy coefficients, and
the normalized envelope is calculated by:

![](media/image643.wmf){width="4.457638888888889in"
height="1.148611111111111in"} (838)

The tonality measures used for the energy control are then calculated:

![](media/image644.wmf){width="4.725in" height="0.9in"} (843)

The ratio between the tonality of the original high frequency spectrum
(![](media/image645.wmf){width="0.7736111111111111in"
height="0.23333333333333334in"}) and the tonality of the base excitation
spectrum (![](media/image646.wmf){width="0.8333333333333334in"
height="0.23333333333333334in"}) is then calculated as follows:

Void (844)

![](media/image647.wmf){width="5.192361111111111in" height="0.9in"}
(845)

where ![](media/image648.wmf){width="0.6083333333333333in"
height="0.23333333333333334in"}is 0.35.

The envelope control factor
![](media/image554.wmf){width="0.8333333333333334in"
height="0.20833333333333334in"} is then applied to the
envelope![](media/image649.wmf){width="0.5159722222222223in"
height="0.23333333333333334in"}:

![](media/image650.wmf){width="3.098611111111111in"
height="0.26666666666666666in"} (839)

Then the spectral envelope of log-domain is obtained by:

![](media/image651.wmf){width="3.248611111111111in"
height="0.29097222222222224in"} (840)

Finally, the spectral envelopes ![](media/image652.wmf){width="0.975in"
height="0.26666666666666666in"}are quantized with a 64-dimentional array
![](media/image653.wmf){width="1.6916666666666667in"
height="0.19166666666666668in"} **described in** table 78.

The distance between the spectral envelopes and the codebook is
calculated by:

![](media/image654.wmf){width="5.267361111111111in"
height="0.30833333333333335in"} (841)

and the index ![](media/image655.wmf){width="1.4756944444444444in"
height="0.30833333333333335in"} is encoded with 5 bits.

Table 79: Codebook ![](media/image656.wmf){width="1.0673611111111112in"
height="0.20694444444444443in"}

  --------------------------------------------------------------------------------------- ------------ ------------ ------------ ------------ ----------- ------------
  ![](media/image657.wmf){width="0.12569444444444444in" height="0.19166666666666668in"}   0            1            2            3            4           5
  ![](media/image656.wmf){width="1.0659722222222223in" height="0.20833333333333334in"}    1.1606680    0.6594560    -4.9874350   -5.1700310   10.230799   -0.0125740
  ![](media/image657.wmf){width="0.125in" height="0.19166666666666668in"}                 6            7            8            9            10          11
  ![](media/image658.wmf){width="1.0673611111111112in" height="0.20694444444444443in"}    10.605126    9.7910260    -0.3739880   -0.6027910   6.2753817   0.3307670
  ![](media/image657.wmf){width="0.125in" height="0.19166666666666668in"}                 12           13           14           15           16          17
  ![](media/image658.wmf){width="1.0659722222222223in" height="0.20833333333333334in"}    9.4537100    8.8558020    2.9320890    2.1643160    3.1332030   2.9710870
  ![](media/image657.wmf){width="0.125in" height="0.19166666666666668in"}                 18           19           20           21           22          23
  ![](media/image658.wmf){width="1.0659722222222223in" height="0.20833333333333334in"}    8.061906     -0.5905290   15.754963    5.0496380    17.227070   18.329395
  ![](media/image657.wmf){width="0.125in" height="0.19166666666666668in"}                 24           25           26           27           28          29
  ![](media/image658.wmf){width="1.0659722222222223in" height="0.20833333333333334in"}    -2.4710190   -3.1725330   -1.4136470   -1.9457110   15.147771   14.506490
  ![](media/image657.wmf){width="0.125in" height="0.19166666666666668in"}                 30           31           32           33           34          35
  ![](media/image658.wmf){width="1.0659722222222223in" height="0.20833333333333334in"}    11.358370    11.714662    9.4275510    -0.1223030   7.0970160   -1.5805260
  ![](media/image657.wmf){width="0.125in" height="0.19166666666666668in"}                 36           37           38           39           40          41
  ![](media/image658.wmf){width="1.0659722222222223in" height="0.20833333333333334in"}    12.498663    3.1614850    10.349261    1.5185040    5.3809850   -1.7341900
  ![](media/image657.wmf){width="0.125in" height="0.19166666666666668in"}                 42           43           44           45           46          47
  ![](media/image658.wmf){width="1.0659722222222223in" height="0.20833333333333334in"}    1.1224600    -2.2397020   12.362551    12.133788    4.2788690   -1.7729040
  ![](media/image657.wmf){width="0.125in" height="0.19166666666666668in"}                 48           49           50           51           52          53
  ![](media/image658.wmf){width="1.0659722222222223in" height="0.20833333333333334in"}    6.1577130    5.4971410    3.3243130    -2.5710470   19.097071   9.3576920
  ![](media/image657.wmf){width="0.125in" height="0.19166666666666668in"}                 54           55           56           57           58          59
  ![](media/image658.wmf){width="1.0659722222222223in" height="0.20833333333333334in"}    7.6509204    7.4404626    0.5055090    -3.7073090   18.584702   11.302494
  ![](media/image657.wmf){width="0.125in" height="0.19166666666666668in"}                 60           61           62           63                       
  ![](media/image658.wmf){width="1.0659722222222223in" height="0.20833333333333334in"}    18.706564    18.308905    23.010420    22.915377                
  --------------------------------------------------------------------------------------- ------------ ------------ ------------ ------------ ----------- ------------

##### 5.2.6.2.2.4 Bit allocation for FD BWE {#bit-allocation-for-fd-bwe-1 .H6}

Table 80 illustrates the WB BWE bit allocation.

Table 81: WB FD BWE bit allocation

  -------------- ---------------------------------------------------------------------------------------------------------- ---------------------------------------------------------------------------------------------------------- ------------
  Signal class   Signal class bit (![](media/image659.wmf){width="0.35694444444444445in" height="0.20694444444444443in"})   Spectral envelope (![](media/image660.wmf){width="0.4736111111111111in" height="0.23333333333333334in"})   Total bits
  HARMONIC       1                                                                                                          5                                                                                                          6
  NORMAL         1                                                                                                          5                                                                                                          6
  -------------- ---------------------------------------------------------------------------------------------------------- ---------------------------------------------------------------------------------------------------------- ------------

#### 5.2.6.3 Coding of upper band at 64 kb/s

The SWB, resp. FB, signal at 64 kbps bit-rate is coded in two bands. The
lower band that covers 0-8kHz is coded using the LP-based coding at 16
kHz internal sampling rate as described earlier and the upper band that
extends the coded band-width up to 16 kHz, resp. 20 kHz, is coded using
a high-rate upper band coding. The same upper band coding with a fixed
16 kbps bit-budget is used in all GC, TC and IC frames. This bit-budget
can be eventually increased with unused bits coming from the AVQ within
the combined algebraic codebook.

The upper band coding is mostly done in the MDCT domain and has two
modes: normal and transient. While normal mode is used in most of
generic and voiced frames, the use of transient mode minimalizes the
pre-echo and post-echo in frames where the signal at the frame beginning
is significantly different from the signal at the frame end, e.g.
onsets. Detection of transient frames is done in time domain using a
detector described in .

First the input signal, filtered by the HP filter and sampled at 32 or
48 kHz, ![](media/image661.wmf){width="0.4409722222222222in"
height="0.24861111111111112in"} is transformed using MDCT and OLA
function. In normal mode, the whole frame is transformed at once while
in transient mode the frame is divided into four sub-frames and thus
four sets of spectral coefficients
![](media/image662.wmf){width="0.3506944444444444in"
height="0.19166666666666668in"} are present. In both modes only spectrum
coefficients between 7.6 kHz and 14.4 kHz are encoded. While the
spectrum between 7.6 kHz and 14.4 kHz is divided in normal mode into
four bands of 1.7 kHz width each, it is divided into two bands of 3.4
kHz each in transient mode. The other frequency coefficients are zeroed.
Consequently spectral
coefficients![](media/image662.wmf){width="0.34930555555555554in"
height="0.19166666666666668in"},
![](media/image663.wmf){width="0.8486111111111111in"
height="0.18263888888888888in"}, are encoded in normal mode frames and
spectral coefficients
![](media/image662.wmf){width="0.34930555555555554in"
height="0.19166666666666668in"},
![](media/image664.wmf){width="0.7736111111111111in"
height="0.18263888888888888in"}, are encoded in transient mode frames.

##### 5.2.6.3.1 Coding in normal mode

In normal mode frames, the global
gain![](media/image665.wmf){width="0.43194444444444446in"
height="0.23333333333333334in"} is computed on the spectrum 7.6 kHz --
14.4 kHz as follows

![](media/image666.wmf){width="1.898611111111111in"
height="0.7319444444444444in"} (842)

and quantized using a 5-bit log gain quantizer at the range of \[3.0;
500.0\].

The quantized global gain
![](media/image667.wmf){width="0.43194444444444446in"
height="0.23333333333333334in"} is further used to normalize the
spectrum ![](media/image668.wmf){width="0.4583333333333333in"
height="0.20694444444444443in"} resulting in a normalized spectrum by
the quantized global gain.

![](media/image669.wmf){width="3.8069444444444445in"
height="0.23333333333333334in"} (843)

where ![](media/image670.wmf){width="0.3326388888888889in"
height="0.20694444444444443in"} is the start frequency bin of spectrum
reconstruction and ![](media/image671.wmf){width="0.6923611111111111in"
height="0.20694444444444443in"} for normal frames.

Then the spectrum envelope is computed in four bands which results in 68
spectral coefficients per band.

![](media/image672.wmf){width="3.75in" height="0.6083333333333333in"}
(844)

The spectrum envelope is quantized using two two-dimensional VQs by
means of 6 bits
codebook![](media/image673.wmf){width="0.6416666666666667in"
height="0.20694444444444443in"} and 5 bits
codebook![](media/image674.wmf){width="0.6416666666666667in"
height="0.20694444444444443in"} in table 82 and table 83, respectively

Table 84: 6 bits spectral envelope VQ codebook

  --------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------- ------------------------------------------------------------------------- -------------------------------------------------------------------------------------- ---- ---------- ----------
  ![](media/image675.wmf){width="0.12569444444444444in" height="0.18263888888888888in"}   ![](media/image676.wmf){width="0.6416666666666667in" height="0.20694444444444443in"}   ![](media/image677.wmf){width="0.12569444444444444in" height="0.18263888888888888in"}   ![](media/image678.wmf){width="0.6416666666666667in" height="0.20694444444444443in"}   ![](media/image677.wmf){width="0.125in" height="0.18263888888888888in"}   ![](media/image678.wmf){width="0.6409722222222223in" height="0.20833333333333334in"}                   
  0                                                                                       0.044983                                                                               0.0417                                                                                  22                                                                                     8.919388                                                                  9.762914                                                                               44   15.26931   21.53914
  1                                                                                       0.524276                                                                               0.469365                                                                                23                                                                                     11.29932                                                                  11.7639                                                                                45   16.98352   24.69959
  2                                                                                       0.671757                                                                               0.605513                                                                                24                                                                                     11.78222                                                                  5.879754                                                                               46   19.59173   22.68968
  3                                                                                       0.983501                                                                               0.855093                                                                                25                                                                                     14.05046                                                                  9.665228                                                                               47   20.1462    25.88847
  4                                                                                       1.227874                                                                               1.1322                                                                                  26                                                                                     11.20153                                                                  9.001128                                                                               48   17.79742   19.45312
  5                                                                                       1.672212                                                                               1.432704                                                                                27                                                                                     14.43475                                                                  13.23657                                                                               49   21.29062   20.18658
  6                                                                                       2.548211                                                                               2.361091                                                                                28                                                                                     14.33726                                                                  3.904411                                                                               50   24.09732   19.08672
  7                                                                                       3.196961                                                                               3.306999                                                                                29                                                                                     20.07105                                                                  4.335061                                                                               51   23.61309   22.54586
  8                                                                                       2.580753                                                                               5.217478                                                                                30                                                                                     18.10581                                                                  8.223599                                                                               52   23.68201   16.32824
  9                                                                                       4.207751                                                                               7.243802                                                                                31                                                                                     22.35229                                                                  9.603263                                                                               53   26.88655   19.40244
  10                                                                                      3.517157                                                                               1.738487                                                                                32                                                                                     7.242756                                                                  16.56449                                                                               54   26.00977   15.63221
  11                                                                                      4.381567                                                                               2.753657                                                                                33                                                                                     11.77753                                                                  19.16765                                                                               55   28.93993   16.24062
  12                                                                                      4.758266                                                                               4.696094                                                                                34                                                                                     11.1218                                                                   15.45598                                                                               56   25.09448   12.36642
  13                                                                                      6.827988                                                                               6.106459                                                                                35                                                                                     14.56358                                                                  17.35957                                                                               57   27.71338   13.26328
  14                                                                                      4.450459                                                                               10.13121                                                                                36                                                                                     17.82122                                                                  11.89472                                                                               58   28.33095   10.32926
  15                                                                                      7.256045                                                                               12.48804                                                                                37                                                                                     17.46603                                                                  15.29606                                                                               59   30.63283   12.85128
  16                                                                                      6.70872                                                                                1.953339                                                                                38                                                                                     21.33696                                                                  13.45518                                                                               60   25.2738    6.138124
  17                                                                                      6.60403                                                                                3.69956                                                                                 39                                                                                     20.54434                                                                  17.12537                                                                               61   29.19534   7.222413
  18                                                                                      10.61273                                                                               2.537916                                                                                40                                                                                     9.056358                                                                  22.33831                                                                               62   32.17132   5.019567
  19                                                                                      9.387467                                                                               4.241173                                                                                41                                                                                     11.23842                                                                  28.83252                                                                               63   31.979     9.473855
  20                                                                                      7.119045                                                                               8.281485                                                                                42                                                                                     13.26273                                                                  25.14338                                                                                               
  21                                                                                      9.062854                                                                               7.086526                                                                                43                                                                                     16.24356                                                                  28.25685                                                                                               
  --------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------- ------------------------------------------------------------------------- -------------------------------------------------------------------------------------- ---- ---------- ----------

Table 85: 5 bits spectral envelope VQ codebook

  --------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------- ---------- ----------
  ![](media/image679.wmf){width="0.12569444444444444in" height="0.18263888888888888in"}   ![](media/image680.wmf){width="0.6416666666666667in" height="0.20694444444444443in"}   ![](media/image681.wmf){width="0.12569444444444444in" height="0.18263888888888888in"}   ![](media/image680.wmf){width="0.6409722222222223in" height="0.20833333333333334in"}              
  0                                                                                       0.512539                                                                               0.472507                                                                                16                                                                                     13.67263   5.457414
  1                                                                                       1.338963                                                                               1.108591                                                                                17                                                                                     16.47199   3.917684
  2                                                                                       2.544041                                                                               1.759765                                                                                18                                                                                     20.91033   6.43281
  3                                                                                       3.124053                                                                               3.045299                                                                                19                                                                                     25.45733   8.61722
  4                                                                                       4.892713                                                                               3.721097                                                                                20                                                                                     16.4107    7.574456
  5                                                                                       4.010297                                                                               5.750862                                                                                21                                                                                     18.57439   10.2915
  6                                                                                       5.111215                                                                               2.164709                                                                                22                                                                                     22.08876   12.51216
  7                                                                                       6.667518                                                                               3.893404                                                                                23                                                                                     21.17053   17.20871
  8                                                                                       8.454117                                                                               2.75143                                                                                 24                                                                                     5.276107   9.62247
  9                                                                                       11.12357                                                                               3.518174                                                                                25                                                                                     9.093585   11.27469
  10                                                                                      6.622948                                                                               5.960704                                                                                26                                                                                     11.94566   15.53814
  11                                                                                      8.562429                                                                               5.003579                                                                                27                                                                                     16.55041   15.04656
  12                                                                                      8.919363                                                                               7.784057                                                                                28                                                                                     6.358148   17.5474
  13                                                                                      10.75904                                                                               5.959438                                                                                29                                                                                     13.31662   21.76552
  14                                                                                      12.44919                                                                               8.359519                                                                                30                                                                                     7.646096   26.10672
  15                                                                                      13.67701                                                                               11.23058                                                                                31                                                                                     2.451297   31.9331
  --------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------- ---------- ----------

The quantized spectrum envelope
![](media/image682.wmf){width="0.7916666666666666in"
height="0.27569444444444446in"}is used to further normalize the spectrum
resulting in spectrum normalized per bands.

![](media/image683.wmf){width="5.5256944444444445in"
height="0.27569444444444446in"} (845)

Afterwards, the number of the bands to be quantized is calculated
according to the total bits and the saturated threshold, and the bands
are selected according to the quantized spectrum envelopes. Once the
bands are selected, the first stage encoding is processed by means of
AVQ. If there are at least 14 remaining bits after the first stage
encoding and the first stage quantized spectrum is non-zero, a second
stage encoding is employed also by means of AVQ.

Calculate the number of the bands to be quantized according to total
bits ![](media/image684.wmf){width="0.26666666666666666in"
height="0.20694444444444443in"} and the saturated
threshold![](media/image685.wmf){width="0.6506944444444445in"
height="0.1673611111111111in"}, and select the bands to be quantized
according to the quantized envelopes as follows:

-- If ![](media/image686.wmf){width="0.6236111111111111in"
height="0.20694444444444443in"}, the selected bands are by:

![](media/image687.wmf){width="2.9159722222222224in"
height="0.23333333333333334in"} (846)

-- Otherwise, the selected bands are by:

![](media/image688.wmf){width="4.067361111111111in"
height="0.4826388888888889in"} (847)

where the ![](media/image689.wmf){width="0.30833333333333335in"
height="0.20694444444444443in"}and
![](media/image690.wmf){width="0.3326388888888889in"
height="0.20694444444444443in"}are set as follows:

![](media/image691.wmf){width="2.432638888888889in"
height="0.23333333333333334in"} (848)

![](media/image692.wmf){width="3.0in" height="0.23333333333333334in"}
(849)

where ![](media/image693.wmf){width="0.6416666666666667in"
height="0.23333333333333334in"} is the sub-band index with the minimum
envelope , and it is calculated by:

![](media/image694.wmf){width="2.042361111111111in"
height="0.39861111111111114in"} (850)

The number of the sub-bands
![](media/image695.wmf){width="0.26666666666666666in"
height="0.20694444444444443in"}is obtained according to the number of
the total bits ![](media/image696.wmf){width="0.26666666666666666in"
height="0.20694444444444443in"} and the saturated threshold
![](media/image697.wmf){width="0.6506944444444445in"
height="0.1673611111111111in"} as follows:

![](media/image698.wmf){width="2.792361111111111in"
height="0.4583333333333333in"} (851)

Quantize the normalized coefficients of the selected bands
(![](media/image695.wmf){width="0.26666666666666666in"
height="0.20833333333333334in"}sub-bands) by AVQ to obtain the quantized
normalized coefficients.

The envelope of the spectrum between 14.4 kHz and 16 kHz in SWB is
predicted by:

![](media/image699.wmf){width="2.3069444444444445in"
height="0.27569444444444446in"} (852)

And the envelope of the spectrum between 14.4 kHz and 20 kHz in FB is
calculated and quantized as follows:

![](media/image700.wmf){width="3.1256944444444446in" height="0.6in"}
(853)

where ![](media/image701.wmf){width="0.29097222222222224in"
height="0.20694444444444443in"} is the start frequency bin of spectrum
reconstruction and ![](media/image702.wmf){width="0.6506944444444445in"
height="0.20694444444444443in"} for normal frames.
![](media/image703.wmf){width="0.5576388888888889in"
height="0.23333333333333334in"} is the width of the MDCT coefficients
between 14.4 kHz and 20 kHz in FB, and is set
by:![](media/image704.wmf){width="0.9416666666666667in"
height="0.23333333333333334in"}.

The ratio of the
envelopes![](media/image705.wmf){width="0.30833333333333335in"
height="0.20694444444444443in"} is refined:

![](media/image706.wmf){width="2.957638888888889in"
height="0.27569444444444446in"} (854)

And the index of attenuation factor
![](media/image707.wmf){width="0.23333333333333334in"
height="0.20694444444444443in"} is obtained according to the ratio of
the envelopes, and the envelope of the spectrum between 14.4 kHz and 20
kHz in FB is finally obtained according to the attenuation
factor![](media/image707.wmf){width="0.2326388888888889in"
height="0.20833333333333334in"}:

![](media/image708.wmf){width="2.015972222222222in"
height="0.8756944444444444in"} (855)

![](media/image709.wmf){width="3.6659722222222224in"
height="1.1006944444444444in"} (856)

Then the index ![](media/image710.wmf){width="0.23333333333333334in"
height="0.20694444444444443in"}is encoded with 2bits.

If the number of the remaining
bits![](media/image711.wmf){width="0.3173611111111111in"
height="0.20694444444444443in"} after the first stage encoding is larger
than 14, then the second stage encoding is needed. Select
![](media/image712.wmf){width="0.3173611111111111in"
height="0.20694444444444443in"} sub-bands from the first stage selected
![](media/image713.wmf){width="0.26666666666666666in"
height="0.20694444444444443in"}sub-bands to perform the second stage
encoding, and the number of the
sub-bands![](media/image712.wmf){width="0.3159722222222222in"
height="0.20833333333333334in"} is calculated according to the number of
remaining bits![](media/image711.wmf){width="0.3159722222222222in"
height="0.20833333333333334in"}and the saturated
threshold![](media/image714.wmf){width="0.6in"
height="0.18263888888888888in"} .

The input coefficients ![](media/image715.wmf){width="1.65in"
height="0.23333333333333334in"} of the second stage encoding are
obtained by reordering the differences between the original normalized
coefficients ![](media/image716.wmf){width="0.7673611111111112in"
height="0.23333333333333334in"} and the quantized normalized
coefficients ![](media/image717.wmf){width="0.6083333333333333in"
height="0.23333333333333334in"} as follows:

First, in the
sub-bands![](media/image718.wmf){width="0.12569444444444444in"
height="0.19166666666666668in"} with the AVQ codebook
index![](media/image719.wmf){width="0.5666666666666667in"
height="0.20694444444444443in"},

![](media/image720.wmf){width="3.4583333333333335in"
height="0.23333333333333334in"} (857)

where the index ![](media/image721.wmf){width="0.12569444444444444in"
height="0.18263888888888888in"}is initialized to 0, and is incremented
by 1 when![](media/image719.wmf){width="0.5659722222222222in"
height="0.20833333333333334in"}.

Then, in the sub-bands
![](media/image722.wmf){width="0.3326388888888889in"
height="0.19166666666666668in"}, if
![](media/image723.wmf){width="0.6in" height="0.19166666666666668in"},
![](media/image724.wmf){width="3.692361111111111in"
height="0.26666666666666666in"}, and the index
![](media/image721.wmf){width="0.125in" height="0.18263888888888888in"}
is incremented by 1.

The number of the sub-bands
![](media/image712.wmf){width="0.3159722222222222in"
height="0.20833333333333334in"} is calculated according to the number of
the remaining bits ![](media/image725.wmf){width="0.3173611111111111in"
height="0.20694444444444443in"} and the saturated
threshold![](media/image714.wmf){width="0.6in"
height="0.18263888888888888in"}:

![](media/image726.wmf){width="2.3069444444444445in"
height="0.4583333333333333in"} (858)

The coefficients of the first
![](media/image712.wmf){width="0.3159722222222222in"
height="0.20833333333333334in"} sub-bands in
![](media/image727.wmf){width="1.65in" height="0.23333333333333334in"}
are selected to perform the second stage encoding as follows:

The global gain of second stage
encoding![](media/image728.wmf){width="0.5006944444444444in"
height="0.23333333333333334in"}is calculated and quantized
as![](media/image729.wmf){width="0.5006944444444444in"
height="0.23333333333333334in"}.

![](media/image730.wmf){width="2.9159722222222224in"
height="0.5819444444444445in"} (859)

and the spectrum is normalized with
![](media/image731.wmf){width="0.5006944444444444in"
height="0.23333333333333334in"}as follows:

![](media/image732.wmf){width="3.473611111111111in"
height="0.43194444444444446in"} (860)

Then the normalized spectrum is quantized by AVQ.

##### 5.2.6.3.2 Coding in transient mode

In transient mode frames, a similar procedure as in normal mode frames
is employed and the following descriptions focus on the differences.

The total bit-budget is divided by four in order to obtain a bit-budget
for every sub-frame and the encoding is performed four times (once for
every sub-frame). In
sub-frame![](media/image733.wmf){width="0.12569444444444444in"
height="0.19166666666666668in"},![](media/image734.wmf){width="0.5423611111111111in"
height="0.19166666666666668in"},the global gain
![](media/image735.wmf){width="0.43194444444444446in"
height="0.23333333333333334in"}is computed on the spectrum 7.6 kHz --
14.4 kHz using equation (861) for
![](media/image736.wmf){width="0.7736111111111111in"
height="0.18263888888888888in"}and quantized using a 5-bit log gain
quantizer at the range of \[3.0, 500.0\].

![](media/image737.wmf){width="3.3569444444444443in"
height="0.5666666666666667in"} (862)

where ![](media/image738.wmf){width="0.3326388888888889in"
height="0.20694444444444443in"} is the start frequency bin of spectrum
reconstruction and ![](media/image739.wmf){width="0.6236111111111111in"
height="0.20694444444444443in"} for transient frames.
![](media/image740.wmf){width="0.23333333333333334in"
height="0.23333333333333334in"}is the frame length.
![](media/image741.wmf){width="0.6in" height="0.23333333333333334in"}for
SWB signal and ![](media/image742.wmf){width="0.5819444444444445in"
height="0.23333333333333334in"}for FB signal

The spectrum envelope is computed in two bands for each sub-frame, thus
each band contains 34 spectral coefficients.

Then, the spectral envelope of normalized spectrum is calculated:

![](media/image743.wmf){width="5.025in" height="0.5666666666666667in"}
(863)

where,

![](media/image744.wmf){width="4.898611111111111in"
height="0.4409722222222222in"} (864)

The total 8 spectral envelopes in 4 sub-frame are divided into 4
two-dimensional vectors, i.e.,
![](media/image745.wmf){width="0.8756944444444444in"
height="0.23333333333333334in"}, ![](media/image746.wmf){width="0.375in"
height="0.18263888888888888in"},
![](media/image747.wmf){width="0.6083333333333333in"
height="0.19166666666666668in"} in each sub-frame are combined as a
vector, and quantized using two-dimensional VQs. For the first vector,
the spectral envelopes in the first sub-frame
![](media/image748.wmf){width="0.8576388888888888in"
height="0.23333333333333334in"} are quantized using one two-dimensional
VQ by means of 4 bits codebook ![](media/image749.wmf){width="0.975in"
height="0.20694444444444443in"}defined in table 86.

Table 87: 4 bit spectral envelope VQ codebook

  -------------------------------------------------------------------------------------- ------------------------------------------------------------------------- ----------
  ![](media/image750.wmf){width="0.4583333333333333in" height="0.20694444444444443in"}   ![](media/image751.wmf){width="0.975in" height="0.20694444444444443in"}   
  0                                                                                      0.799219                                                                  0.677609
  1                                                                                      1.754571                                                                  1.215689
  2                                                                                      2.846222                                                                  2.017775
  3                                                                                      4.379336                                                                  1.975914
  4                                                                                      5.935472                                                                  2.945818
  5                                                                                      3.938621                                                                  4.220399
  6                                                                                      8.080808                                                                  2.632276
  7                                                                                      7.579771                                                                  4.986835
  8                                                                                      4.956485                                                                  10.36366
  9                                                                                      7.739148                                                                  8.652471
  10                                                                                     9.238397                                                                  7.051655
  11                                                                                     10.205707                                                                 5.619638
  12                                                                                     10.645117                                                                 4.374648
  13                                                                                     11.66018                                                                  3.474015
  14                                                                                     10.845836                                                                 2.664596
  15                                                                                     11.724073                                                                 1.637023
  -------------------------------------------------------------------------------------- ------------------------------------------------------------------------- ----------

The index of this VQs is noted as
![](media/image752.wmf){width="0.4409722222222222in"
height="0.20694444444444443in"}. This 4 bits codebook can be divided
into two 3 bits codebook. The first 3 bits codebook is
![](media/image753.wmf){width="0.8576388888888888in"
height="0.20694444444444443in"}, and the second is
![](media/image754.wmf){width="0.9173611111111111in"
height="0.20694444444444443in"} in the table 88. Then the first
quantized vector is determined one of the 3 bits codebook according to
the ![](media/image752.wmf){width="0.4409722222222222in"
height="0.20694444444444443in"}.

If ![](media/image755.wmf){width="0.6506944444444445in"
height="0.20694444444444443in"}, the first 3 bits codebook is selected
as new codebook;

if ![](media/image756.wmf){width="0.6416666666666667in"
height="0.20694444444444443in"}, the second 3 bits codebook is selected
as new codebook.

Then the following three vectors are quantized by using the 3 bits
codebook determined before.

The quantized spectral envelope
![](media/image757.wmf){width="0.7673611111111112in"
height="0.27569444444444446in"}is applied to the spectrum:

![](media/image758.wmf){width="4.667361111111111in"
height="0.4583333333333333in"} (865)

where ![](media/image759.wmf){width="0.39861111111111114in"
height="0.19166666666666668in"}, ![](media/image760.wmf){width="0.625in"
height="0.1909722222222222in"} and
![](media/image761.wmf){width="1.125in" height="0.20694444444444443in"}.

Then, the normalized spectrum is quantized by AVQ.

If ![](media/image762.wmf){width="2.015972222222222in"
height="0.20694444444444443in"}, the envelope of the spectrum between
14.4 kHz and 16 kHz in SWB is predicted by:

![](media/image763.wmf){width="2.8583333333333334in"
height="0.27569444444444446in"} (866)

If ![](media/image764.wmf){width="1.9166666666666667in"
height="0.20694444444444443in"}, the envelope of the spectrum between
14.4 kHz and 20 kHz in FB is calculated and quantized as follows:

![](media/image765.wmf){width="4.232638888888889in" height="0.6in"}
(867)

where, ![](media/image766.wmf){width="0.29097222222222224in"
height="0.20694444444444443in"} is the start frequency bin of spectrum
reconstruction and ![](media/image767.wmf){width="0.6416666666666667in"
height="0.20694444444444443in"} for transient frames.
![](media/image768.wmf){width="0.5583333333333333in"
height="0.2326388888888889in"} is the width of the MDCT coefficients
between 14.4 kHz and 20 kHz in FB, and is set
by![](media/image769.wmf){width="0.875in"
height="0.2326388888888889in"}.

The ratio of the envelopes![](media/image770.wmf){width="0.475in"
height="0.20833333333333334in"} is refined as:

![](media/image771.wmf){width="3.8333333333333335in" height="0.275in"}
(868)

And the index of attenuation factor
![](media/image772.wmf){width="0.4166666666666667in"
height="0.20833333333333334in"} is obtained according to the ratio of
the envelopes, and the envelope of the spectrum between 14.4 kHz and 20
kHz in FB is finally obtained according to the attenuation factor
![](media/image773.wmf){width="0.4166666666666667in"
height="0.20833333333333334in"}:

![](media/image774.wmf){width="2.7916666666666665in"
height="0.9333333333333333in"} (869)

![](media/image775.wmf){width="3.75in" height="1.0993055555555555in"}
(870)

where ![](media/image760.wmf){width="0.625in"
height="0.1909722222222222in"}. Then the index
![](media/image776.wmf){width="0.2326388888888889in"
height="0.20833333333333334in"}is encoded with 2bits.

Finally, the unused AVQ bits from the current sub-frame are employed in
the subsequent sub-frame within the same frame.
