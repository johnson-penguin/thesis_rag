5.3 MDCT Coding Mode
--------------------

### 5.3.1 General description

The decision algorithm for selecting the MDCT Coding mode, instead of
CELP, is described in subclause 5.1.16. In general, the MDCT coding mode
is selected whenever a signal is not speech or the bit rate for encoding
is high enough for the transform coder. It always operates on full input
signal independent of sample rate and selected audio bandwidth.

The EVS codec supports two major MDCT coding modes, the MDCT based TCX
(TCX) and the High Quality MDCT coder (HQ). Both operate with different
configurations depending on the bit rate for encoding. For some
operating points, the MDCT coders are switched for optimized efficiency.
The two MDCT selector algorithms are described in subclauses 5.1.14.2
and 5.1.14.3. The following table describes the used mode configurations
depending on bit rate and bandwidth.

Table 76: Overview of supported MDCT coding modes

+---------+----------------+------------------+------------------+
| Bitrate | Bandwidth      | MDCT Classifier  | MDCT mode        |
|         |                |                  |                  |
| (kbps)  |                |                  |                  |
+---------+----------------+------------------+------------------+
| 7.2, 8  | NB             |                  | HQ low-rate      |
+---------+----------------+------------------+------------------+
| 9.6     | NB, WB,SWB     |                  | TCX low-rate     |
+---------+----------------+------------------+------------------+
| 13.2    | NB, WB, SWB    | MDCT Selector    | Switching HQ     |
|         |                |                  | low-rate and TCX |
|         |                |                  | mid-rate         |
+---------+----------------+------------------+------------------+
| 16.4    | NB, WB, SWB FB |                  |                  |
+---------+----------------+------------------+------------------+
| 24.4    | NB, WB         |                  | TCX mid-rate     |
+---------+----------------+------------------+------------------+
| 32      | WB             |                  | HQ high-rate     |
+---------+----------------+------------------+------------------+
| 24.4    | SWB,FB         | MDCT Selector II | Switching HQ     |
|         |                |                  | high-rate and    |
|         |                |                  | TCX mid-rate     |
+---------+----------------+------------------+------------------+
| 32      | SWB,FB         |                  |                  |
+---------+----------------+------------------+------------------+
| 48      | WB,SWB,FB      |                  | TCX high-rate    |
+---------+----------------+------------------+------------------+
| 64      | WB,SWB,FB      |                  | HQ high-rate     |
+---------+----------------+------------------+------------------+
| 96,128  | WB,SWB,FB      |                  | TCX high-rate    |
+---------+----------------+------------------+------------------+

The next subclauses describe the common time-to-frequency transformation
for both major MDCT modes. In the following the TCX and the HQ coder are
described including their modules and configurations.

### 5.3.2 Time-to-frequency transformations

#### 5.3.2.1 Transform sizes and MDCT configurations

The MDCT encoder operates with a frame of length
![](media/image1.wmf){width="0.1375in" height="0.15555555555555556in"}
at the input sampling frequency
![](media/image2.wmf){width="0.18263888888888888in"
height="0.20972222222222223in"}.

#### 5.3.2.2 Long block transformation (ALDO window)

The window used in long block transformation is an asymmetrical low
delay optimized (ALDO) window. This ALDO window is stored in ROM in two
versions, one at 48 kHz and another at 25.6 kHz respectively; the ALDO
window at other input sampling frequencies (namely 8, 12.8, 16, 32 kHz)
is obtained by on-the-fly decimation in the folding process described in
subclause 5.3.2.2.1.

The ALDO window has a time support of 40 ms and its definition is the
same at 48 and 25.6 kHz. To simplify notations the sampling frequency
(48 or 25.6 kHz) associated with the ALDO window is not included in the
following text. This window,
![](media/image3.wmf){width="1.3229166666666667in"
height="0.20972222222222223in"} of length
![](media/image4.wmf){width="0.20972222222222223in"
height="0.15555555555555556in"}, is structured in 4 segments:

![](media/image5.wmf){width="3.2333333333333334in"
height="0.8784722222222222in"} (877)

where ![](media/image6.wmf){width="0.1375in"
height="0.15555555555555556in"}is the frame length (20 ms) and
![](media/image7.wmf){width="0.19166666666666668in"
height="0.20972222222222223in"} is the length of the last segment with a
weight of 0 (5.625 ms). The different segments consist of an increasing
segment ![](media/image8.wmf){width="0.38958333333333334in"
height="0.20972222222222223in"}, a constant segment
![](media/image9.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"} with a weight of 1, a decreasing segment
![](media/image10.wmf){width="0.39861111111111114in"
height="0.20972222222222223in"}, a constant segment
![](media/image11.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"} with a weight of 0, as illustrated in
figure 53. Note that in practice the parts corresponding to weights of 1
and 0 are not stored explicitly.

Figure 53 is also useful to illustrate the time alignment of input
signal frames at the MDCT encoder. As the fourth segment of the ALDO
window has by definition a weight of 0, the frame of new input samples,
![](media/image12.wmf){width="1.163888888888889in"
height="0.20972222222222223in"}, is time-aligned in such a way that its
end coincides with the end of the third ALDO window segment
![](media/image13.wmf){width="0.39861111111111114in"
height="0.20972222222222223in"}; this alignment allows to save
![](media/image14.wmf){width="0.19166666666666668in"
height="0.20972222222222223in"} samples of lookahead (5.625 ms); the
previous frame of input signal,
![](media/image15.wmf){width="1.4006944444444445in"
height="0.20972222222222223in"}, is partially weighted by the first ALDO
window segment, ![](media/image16.wmf){width="0.38958333333333334in"
height="0.20972222222222223in"}.

![](media/image17.wmf){width="4.915277777777778in"
height="1.9201388888888888in"}

Figure 53: ALDO window

The ALDO window was obtained at 48 and 25.6 kHz by a two-step process:
first an initial window
![](media/image18.wmf){width="1.3916666666666666in"
height="0.20972222222222223in"} was obtained, then this initial window
![](media/image19.wmf){width="0.48541666666666666in"
height="0.20972222222222223in"} was regularized in order to ensure
perfect reconstruction. The initial window
![](media/image20.wmf){width="0.48541666666666666in"
height="0.20972222222222223in"} is defined in 4 segments with an
increasing segment ![](media/image21.wmf){width="0.39861111111111114in"
height="0.20972222222222223in"}, a constant segment
![](media/image22.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"} with a weight of 1 identical to
![](media/image23.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"}, a decreasing segment
![](media/image24.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"}, a constant segment
![](media/image25.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"} with a weight of 0 identical to
![](media/image26.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"}. The ALDO window is therefore defined by
spelling out the initial window
![](media/image27.wmf){width="0.48541666666666666in"
height="0.20972222222222223in"}and the regularization term
![](media/image28.wmf){width="0.30277777777777776in"
height="0.20972222222222223in"}.

***ALDO window at 48 kHz***

At 48 kHz, the 20 ms frame has
![](media/image29.wmf){width="0.48541666666666666in"
height="0.16458333333333333in"} samples. The first segment
![](media/image30.wmf){width="0.38958333333333334in"
height="0.20972222222222223in"} of the ALDO window is given by

![](media/image31.wmf){width="1.8083333333333333in"
height="0.4166666666666667in"} (878)

where the first segment of the initial window is

![](media/image32.wmf){width="1.3229166666666667in"
height="0.5034722222222222in"} (879)

and the regularization factor is

![](media/image33.wmf){width="3.329861111111111in"
height="0.2604166666666667in"}, (880)

![](media/image34.wmf){width="0.6777777777777778in"
height="0.20972222222222223in"} is the length of the first segment (690
samples at 48 kHz), ![](media/image35.wmf){width="1.3333333333333333in"
height="0.19375in"}is a constant. The second segment of the ALDO window
is ![](media/image36.wmf){width="1.5298611111111111in"
height="0.20972222222222223in"}. The third segment
![](media/image37.wmf){width="0.39861111111111114in"
height="0.20972222222222223in"} of the ALDO window is given by

![](media/image38.wmf){width="1.8777777777777778in"
height="0.39861111111111114in"} (881)

where the third segment of the initial window is

![](media/image39.wmf){width="1.2958333333333334in"
height="0.49444444444444446in"} (882)

and the regularization factor is

![](media/image40.wmf){width="3.329861111111111in"
height="0.2604166666666667in"}, (883)

![](media/image41.wmf){width="0.7736111111111111in"
height="0.20972222222222223in"} is the length of the first segment (420
samples at 48 kHz), ![](media/image42.wmf){width="1.3611111111111112in"
height="0.19375in"}is a constant. The fourth segment of the ALDO window
is ![](media/image43.wmf){width="1.5027777777777778in"
height="0.20972222222222223in"} (270 sample at 48 kHz).

***ALDO window at 25.6 kHz***

The ALDO window at 25.6 kHz is defined as the ALDO window at 48 kHz,
except the following parameters are used:

-   ![](media/image44.wmf){width="0.48541666666666666in"
    height="0.16458333333333333in"}

-   ![](media/image45.wmf){width="0.5395833333333333in"
    height="0.20972222222222223in"}

-   ![](media/image46.wmf){width="1.1388888888888888in"
    height="0.19375in"}

-   ![](media/image47.wmf){width="0.9861111111111112in"
    height="0.19375in"}

It follows that ![](media/image48.wmf){width="0.5395833333333333in"
height="0.20972222222222223in"} and
![](media/image49.wmf){width="0.5638888888888889in"
height="0.20972222222222223in"}.

***ALDO window at other sampling frequencies***

The ALDO window at 48 kHz is used to derive on the fly the ALDO window
at 8, 16, and 32 kHz. Similarly, the ALDO window at 25.6 kHz is used to
derive on the fly the ALDO window at 12.8 kHz. Details on this
on-the-fly decimation are provided in subclause 5.3.2.2.1.

##### 5.3.2.2.1 Folding and on-the-fly window decimation

The folding operations and window decimation (when applicable) are
combined in the same process. To achieve perfect reconstruction ALDO
windows the 48 and 25.6 kHz are irregularly decimated. The decimation
consists in selecting a subset of coefficients from the initial window
(48 or 25.6 kHz) at specific indices
![](media/image50.png){width="1.8541666666666667in"
height="0.1597222222222222in"} to preserve perfect reconstruction; this
decimation is combined with the folding process for efficiency.

The folding process is illustrated in figure 54. The MDCT folding is
performed by dividing the 40 ms time support of the ALDO window in 4
sections delimited by dotted vertical lines.

![](media/image51.png){width="4.497916666666667in"
height="3.042361111111111in"}

Figure 54: Folding with ALDO window.

For each frame of new input samples, a block
![](media/image52.wmf){width="0.2513888888888889in"
height="0.20972222222222223in"} of length
![](media/image53.wmf){width="0.20972222222222223in"
height="0.15555555555555556in"} is folded into a block
![](media/image54.wmf){width="0.30277777777777776in"
height="0.20972222222222223in"},
![](media/image55.wmf){width="0.8159722222222222in"
height="0.18263888888888888in"}. The ALDO window at 48 or 25.6 kHz is
defined at a sampling frequency corresponding to two frames of length
![](media/image56.wmf){width="0.16458333333333333in"
height="0.16458333333333333in"}at 48 or 25.6 kHz
(![](media/image57.wmf){width="0.38958333333333334in"
height="0.16458333333333333in"}) . The ratio between
![](media/image58.wmf){width="0.16458333333333333in"
height="0.16458333333333333in"} and
![](media/image59.wmf){width="0.1375in" height="0.15555555555555556in"}
is called the decimation factor.

The folded frame is given for ![](media/image60.wmf){width="0.975in"
height="0.19166666666666668in"} by:

![](media/image61.wmf){width="3.0930555555555554in"
height="1.113888888888889in"}, (884)

![](media/image62.wmf){width="4.522916666666666in" height="0.5in"},
(885)

where the ratio ![](media/image63.wmf){width="0.3298611111111111in"
height="0.18263888888888888in"} is the decimation factor and
![](media/image64.wmf){width="0.1375in" height="0.18263888888888888in"}
is an offset that depends on the decimation factor. The ALDO window used
for decimation, decimation factor and offset are given in table 77.

Table 77: ALDO window used for decimation, decimation factor and offset
parameters.

  ------------------------------------ --------------------------------------- -------------------------------------------------------------------------------------------- --------------------------------------------------------------------------------
  MDCT core sampling frequency (kHz)   ALDO window used for decimation (kHz)   Decimation factor ![](media/image65.wmf){width="0.66875in" height="0.23333333333333334in"}   Offset ![](media/image66.wmf){width="0.1375in" height="0.18263888888888888in"}
  8                                    48                                      6                                                                                            2
  12.8                                 25.6                                    2                                                                                            0
  16                                   48                                      3                                                                                            1
  25.6                                 25.6                                    1                                                                                            0
  32                                   48                                      3                                                                                            1
  48                                   48                                      1                                                                                            0
  ------------------------------------ --------------------------------------- -------------------------------------------------------------------------------------------- --------------------------------------------------------------------------------

The 32 kHz sampling frequency is a special case, as the ratio between 48
and 32 kHz is not integer. For this 32 kHz case, in order to achieve
perfect reconstruction, the ALDO window
![](media/image67.wmf){width="0.38958333333333334in"
height="0.20972222222222223in"} decimated from 48 to 16 kHz is applied
to samples with even indices, the samples with odd indices are weighted
by a complementary window
![](media/image68.wmf){width="0.3659722222222222in"
height="0.23333333333333334in"}. For the 32 kHz case, the folded frame
is given for ![](media/image69.wmf){width="0.975in"
height="0.19166666666666668in"} by:

![](media/image70.wmf){width="4.833333333333333in" height="0.46875in"},
(886)

![](media/image71.wmf){width="3.7708333333333335in"
height="1.0305555555555554in"}, (887)

![](media/image72.wmf){width="4.684722222222222in" height="0.46875in"},
(888)

![](media/image73.wmf){width="4.708333333333333in" height="0.46875in"},
(889)

where ![](media/image74.wmf){width="0.25in" height="0.25in"} is the
frame length at 16kHz, ![](media/image75.wmf){width="0.1375in"
height="0.15555555555555556in"} is the length of MDCT core frame at
32kHz, ![](media/image76.wmf){width="0.43472222222222223in"
height="0.23333333333333334in"} is the decimation factor and
![](media/image77.wmf){width="0.32083333333333336in"
height="0.18263888888888888in"} is the offset.

The complementary window
![](media/image78.wmf){width="0.5638888888888889in"
height="0.23333333333333334in"}of size
![](media/image79.wmf){width="0.3229166666666667in" height="0.25in"}is
stored in ROM. To obtain the window
![](media/image80.wmf){width="0.5638888888888889in"
height="0.23333333333333334in"}, the ALDO window at 48 kHz is decimated
by 3 (with an offset of 1), the resulting decimated window at 16 kHz is
considered as if it was obtained from a 32 kHz window decimated by 2
(without any offset) so that half of the samples of the 32 kHz window is
known; the other half is obtained doing a linear interpolation between
known samples. The combination of the 16 kHz window obtained by
decimation and ![](media/image81.wmf){width="0.5638888888888889in"
height="0.23333333333333334in"}is such that perfect reconstruction is
ensured for the overall 32 kHz window.

##### 5.3.2.2.2 eDCT

The ![](media/image82.wmf){width="0.30277777777777776in"
height="0.20972222222222223in"},
![](media/image83.wmf){width="0.9027777777777778in"
height="0.18263888888888888in"} are transformed to frequency domain by
an eDCT, which is built upon a discrete cosine transform type IV
(DCT~IV~) but the eDCT requires less storage and has lower complexity.

The original L-point DCT~IV~ formula is:

![](media/image84.wmf){width="3.4166666666666665in"
height="0.5138888888888888in"} (890)

where ![](media/image85.wmf){width="0.30277777777777776in"
height="0.20972222222222223in"} is the windowed input signal of the
current audio frame
and![](media/image86.wmf){width="0.47638888888888886in"
height="0.2125in"} is the
![](media/image87.wmf){width="0.13194444444444445in"
height="0.18263888888888888in"}-th DCT spectral component. This formula
can be rewritten as:

![](media/image88.wmf){width="2.9027777777777777in"
height="0.4861111111111111in"} (891)

where the values ![](media/image89.wmf){width="0.30277777777777776in"
height="0.225in"} are given by

![](media/image90.wmf){width="3.8784722222222223in"
height="0.5638888888888889in"} (892)

**and** ![](media/image91.wmf){width="1.676388888888889in"
height="0.20972222222222223in"}**,**
![](media/image92.wmf){width="1.0673611111111112in"
height="0.19166666666666668in"}**, and**
![](media/image93.wmf){width="2.183333333333333in"
height="0.48541666666666666in"}.

Hence, the eDCT is computed using the following steps which lead to less
storage and lower complexity:

1\) Pre-processing

Apply the twiddle factors to the time domain data
![](media/image94.wmf){width="0.30277777777777776in"
height="0.20972222222222223in"}, so as to obtain twiddled signal
![](media/image95.wmf){width="0.31180555555555556in"
height="0.21597222222222223in"}:

![](media/image96.wmf){width="2.972916666666667in"
height="0.20972222222222223in"} (893)

Pre-rotate the twiddled signal
![](media/image97.wmf){width="0.31180555555555556in"
height="0.21597222222222223in"} by using a symmetric rotation factor:

![](media/image98.wmf){width="0.5638888888888889in"
height="0.2604166666666667in"},
![](media/image99.wmf){width="1.0673611111111112in"
height="0.19166666666666668in"}

where ![](media/image100.wmf){width="0.43472222222222223in"
height="0.2604166666666667in"} in the rotation factor may also be
expressed in the following form:

![](media/image101.wmf){width="3.3208333333333333in"
height="0.30277777777777776in"} (894)

which satisfies conditions of
![](media/image102.wmf){width="4.391666666666667in"
height="0.2423611111111111in"},
![](media/image103.wmf){width="1.04375in"
height="0.19166666666666668in"} and
![](media/image104.wmf){width="4.373611111111111in"
height="0.2423611111111111in"},
![](media/image105.wmf){width="1.04375in"
height="0.19166666666666668in"}, and therefore, in the implementation,
only one data table of cosine values covering
L/2-points![](media/image106.wmf){width="2.4868055555555557in"
height="0.30277777777777776in"},
![](media/image107.wmf){width="1.0673611111111112in"
height="0.20972222222222223in"} needs to be stored, and
![](media/image108.wmf){width="1.538888888888889in"
height="0.30277777777777776in"} is a constant..

2\) Fast Fourier Transform

Perform a Fast Fourier Transform (FFT) of L/2 points on the pre-rotated
data ![](media/image109.wmf){width="0.31180555555555556in"
height="0.21597222222222223in"}.

3\) Perform an in-place fixed rotate compensation

The FFT data ![](media/image110.wmf){width="0.3388888888888889in"
height="0.23333333333333334in"},
![](media/image111.wmf){width="1.0527777777777778in"
height="0.20972222222222223in"} of
![](media/image112.wmf){width="0.31180555555555556in"
height="0.21597222222222223in"} is rotated in-place by multiplying with
a fixed rotate compensation factor
![](media/image113.wmf){width="0.5034722222222222in" height="0.375in"}:

![](media/image114.wmf){width="2.5319444444444446in"
height="0.3659722222222222in"} (895)

4\) Post-processing

The data ![](media/image115.wmf){width="0.3388888888888889in"
height="0.2423611111111111in"},
![](media/image116.wmf){width="1.04375in"
height="0.19166666666666668in"} is finally post-rotation processed with
a symmetric rotation factor:

![](media/image117.wmf){width="0.5548611111111111in"
height="0.2604166666666667in"},
![](media/image118.wmf){width="1.04375in"
height="0.19166666666666668in"},

where ![](media/image119.wmf){width="0.4166666666666667in"
height="0.2604166666666667in"} in the rotation factor may also be
expressed in the following form:

![](media/image120.wmf){width="3.3027777777777776in"
height="0.30277777777777776in"} (896)

In the specific implementation, only one cosine data table of L/2-
values needs to be stored i.e.
![](media/image121.wmf){width="2.4868055555555557in"
height="0.30277777777777776in"},
![](media/image122.wmf){width="1.04375in"
height="0.19166666666666668in"} which is the same as the pre-processing,
and ![](media/image123.wmf){width="1.538888888888889in"
height="0.30277777777777776in"} is a constant.

5\) Obtain frequency domain data

Then the real parts of the post- rotated data are expressed
as![](media/image124.wmf){width="0.49583333333333335in"
height="0.19930555555555557in"},
![](media/image125.wmf){width="1.04375in"
height="0.19166666666666668in"}, which represent the odd number
frequency bins of the frequency domain data; and the frequency reversed
imaginary parts of the post-rotated data are expressed as
![](media/image126.wmf){width="0.9486111111111111in"
height="0.21458333333333332in"},
![](media/image127.wmf){width="1.04375in"
height="0.19166666666666668in"}, which represent the even number
frequency bins of the frequency domain data.

![](media/image128.wmf){width="2.9027777777777777in"
height="0.4861111111111111in"} (897)

where ![](media/image129.wmf){width="3.173611111111111in"
height="0.4076388888888889in"}*,*
![](media/image130.wmf){width="1.0527777777777778in"
height="0.20972222222222223in"}.

#### 5.3.2.3 Transient location dependent overlap and transform length

Beside ALDO window, 3 more overlap shapes are used for windowing:

-   FULL: 8.75 milliseconds overlap described in subclause 5.3.2.5, used
    for transition from transform with long ALDO window to short
    transform

-   HALF: 3.75 milliseconds symmetric sine overlap

-   MINIMAL: 1.25 milliseconds symmetric sine overlap

For long MDCT based TCX (TCX20) transformation, that is not after ACELP,
9 combinations of one overlap shape (ALDO, HALF, MINIMAL) on the left
side of the window and another overlap shape (ALDO, HALF, MINIMAL) on
the right side of the window is possible. For HQ MDCT 4 combinations of
one overlap shape (ALDO, FULL, HALF, MINIMAL) on the left side of the
window and ALDO on the right side of the window is possible.

For short MDCT based TCX transformation (TCX10 or TCX5), 7 of the 9
possible combinations of one symmetric overlap shape (FULL, HALF,
MINIMAL) on the left side of the window and another symmetric overlap
shape (FULL, HALF, MINIMAL) on the right side of the window are used
(see table 80).

The overlap length and the transform length of the TCX are dependent on
the existence of a transient and its location and are chosen so that a
transient is mostly contained in only one window as shown in table 78.

Table 78: Coding of the overlap and the transform length based on the
transient position

+-------------+-------------+-------------+-------------+-------------+
| Attack      | Overlap     | Short/Long  | Binary code | Overlap     |
| index       | with the    | Transform   | for the     | code        |
|             | first       | decision    | overlap     |             |
|             | window of   | (binary     | width       |             |
|             | the         | coded)      |             |             |
|             | following   |             |             |             |
|             | frame       | 0 -- Long,  |             |             |
|             |             | 1 - Short   |             |             |
+-------------+-------------+-------------+-------------+-------------+
| none        | ALDO        | 0           | 0           | 00          |
+-------------+-------------+-------------+-------------+-------------+
| -2          | FULL        | 1           | 0           | 10          |
+-------------+-------------+-------------+-------------+-------------+
| -1          | FULL        | 1           | 0           | 10          |
+-------------+-------------+-------------+-------------+-------------+
| 0           | FULL        | 1           | 0           | 10          |
+-------------+-------------+-------------+-------------+-------------+
| 1           | FULL        | 1           | 0           | 10          |
+-------------+-------------+-------------+-------------+-------------+
| 2           | MINIMAL     | 1           | 10          | 110         |
+-------------+-------------+-------------+-------------+-------------+
| 3           | HALF        | 1           | 11          | 111         |
+-------------+-------------+-------------+-------------+-------------+
| 4           | HALF        | 1           | 11          | 111         |
+-------------+-------------+-------------+-------------+-------------+
| 5           | MINIMAL     | 1           | 10          | 110         |
+-------------+-------------+-------------+-------------+-------------+
| 6           | MINIMAL     | 0           | 10          | 010         |
+-------------+-------------+-------------+-------------+-------------+
| 7           | HALF        | 0           | 11          | 011         |
+-------------+-------------+-------------+-------------+-------------+

If the transient detector described in the subclause 5.1.8 does not
detect a transient, but there is increase of energy at high frequencies
in the current frame relative to the previous frame
(![](media/image131.wmf){width="0.4527777777777778in"
height="0.20972222222222223in"} is the high frequency energy for the
current frame and ![](media/image132.wmf){width="0.6506944444444445in"
height="0.20972222222222223in"} is the high frequency energy for the
previous frame, as defined in subclause 5.1.2.2):

![](media/image133.wmf){width="1.226388888888889in"
height="0.20972222222222223in"} (898)

then the short transform is chosen and overlap is dependent on the
attack index set in the transient detector or half overlap is chosen if
the transient detector didn't set attack index. The transient detector
described in the subclause 5.1.8 basically returns the index of the last
attack with the restriction that if there are multiple transients then
MINIMAL overlap is preferred over HALF overlap which is preferred over
FULL overlap. If an attack at position 2 or 6 is not strong enough then
HALF overlap is chosen instead of the MINIMAL overlap.

For bitrates below 48 kbps the short transform length is not allowed and
thus the attack index lower than 6 would trigger ALDO window and the
overlap code 00.

If the previous frame was coded using ACELP a specific configuration is
used as described in subclause 5.4.2.2.

Depending on the right overlap (current overlap code) and the left
overlap (previous overlap code) in the current frame the configuration
of the transform lengths in the current frame is chosen as presented in
table 79.

Table 79: Transform lengths decision table

+-----------------------+---------+---------+---------+
| Previous overlap code | 00/10   | 111/011 | 110/010 |
|                       |         |         |         |
| Current overlap code  |         |         |         |
+-----------------------+---------+---------+---------+
| 00                    | TCX20   | TCX20   | TCX20   |
+-----------------------+---------+---------+---------+
| 10                    | 2xTCX5, | 2xTCX5, | 2xTCX5, |
|                       |         |         |         |
|                       | TCX10   | TCX10   | TCX10   |
+-----------------------+---------+---------+---------+
| 111                   | 2xTCX5, | 4xTCX5  | 4xTCX5  |
|                       |         |         |         |
|                       | TCX10   |         |         |
+-----------------------+---------+---------+---------+
| 110                   | 2xTCX5, | 4xTCX5  | 4xTCX5  |
|                       |         |         |         |
|                       | TCX10   |         |         |
+-----------------------+---------+---------+---------+
| 010                   | TCX20   | TCX20   | TCX20   |
+-----------------------+---------+---------+---------+
| 011                   | TCX20   | TCX20   | TCX20   |
+-----------------------+---------+---------+---------+

If the current frame is classified as the transition frame (current
overlap code is 10, 111 or 110) the detailed configuration of the
transform and overlap lengths is presented in table 80.

Table 80: Transform and overlap length configuration for transient frame

+----------------+----------------+----------------+----------------+
| **Prev. code** | 00/10          | 111/011        | 110/010        |
|                |                |                |                |
| Curr. code     |                |                |                |
+----------------+----------------+----------------+----------------+
| 10             | FULL,T         | HALF,T         | MIN.,T         |
|                | CX5,MIN.,TCX5, | CX5,MIN.,TCX5, | CX5,MIN.,TCX5, |
|                |                |                |                |
|                | M              | H              | M              |
|                | IN.,TCX10,FULL | ALF,TCX10,FULL | IN.,TCX10,FULL |
+----------------+----------------+----------------+----------------+
| 111            | FULL,TC        | HALF,TCX5,M    | MI             |
|                | X10,HALF,TCX5, | IN.,TCX5,HALF, | N.,TCX5,MIN.,T |
|                |                |                | CX5,MIN.,TCX5, |
|                | MIN.,TCX5,HALF | TCX5,          | MIN.,TCX5,HALF |
|                |                | MIN.,TCX5,HALF |                |
+----------------+----------------+----------------+----------------+
| 110            | FULL,TC        | HA             | MI             |
|                | X10,MIN.,TCX5, | LF,TCX5,MIN.,T | N.,TCX5,MIN.,T |
|                |                | CX5,MIN.,TCX5, | CX5,MIN.,TCX5, |
|                | MIN.,TCX5,MIN. | MIN.,TCX5,MIN. | MIN.,TCX5,MIN. |
+----------------+----------------+----------------+----------------+

In table 79 and table 80, the value 00/10 for previous overlap code
indicates that the same configuration is used if the previous overlap
code is 00 as well as when it is 10. The meaning of values 111/011 and
110/010 follows the same logic.

As example "HALF, TCX5, MIN., TCX5, HALF., TCX10, FULL" from Table 80
indicates that first TCX5 has HALF overlap on the left side and MINIMAL
overlap on the right side, followed by second TCX5 with MINIMAL overlap
on the left side and HALF overlap on the right side, followed by TCX10
with HALF overlap on the left side and FULL overlap on the right side.
The TCX10 with HALF overlap on the left side and FULL overlap on the
right is one example of the window described in subclause 5.3.2.5.2.

#### 5.3.2.4 Short block transformation

##### 5.3.2.4.1 Short window transform in TDA domain {#short-window-transform-in-tda-domain .H6}

##### 5.3.2.4.1.1 Transient detection {#transient-detection .H6}

![](media/image134.wmf){width="6.261111111111111in" height="1.5375in"}

Figure 55: Transient detection algorithm

The block diagram of the transient detection algorithm is shown in
figure 55. The input
signal![](media/image135.wmf){width="0.4618055555555556in"
height="0.20972222222222223in"}is first high-pass filtered; the
high-pass filter serves as a precaution against undesired low-frequency
components. A first order IIR filter is used, and it is given by:

![](media/image136.wmf){width="1.4875in" height="0.42569444444444443in"}
(899)

The same filter is used for all sampling frequencies.

The output of the high-pass filter
![](media/image137.wmf){width="0.43472222222222223in"
height="0.20972222222222223in"} is obtained according to:

![](media/image138.wmf){width="4.817361111111111in"
height="0.20972222222222223in"} (900)

where![](media/image139.wmf){width="0.1375in"
height="0.15555555555555556in"}denotes the 20-ms frame length. The
high-pass filtered
signal![](media/image140.wmf){width="0.43472222222222223in"
height="0.20972222222222223in"} is sectioned into four sub-frames, each
corresponding to 5 ms,
![](media/image141.wmf){width="0.27847222222222223in"
height="0.1736111111111111in"}samples each.

The energy of each
sub-frame,![](media/image142.wmf){width="0.5034722222222222in"
height="0.20972222222222223in"}, is computed according to:

![](media/image143.wmf){width="2.84375in" height="0.5729166666666666in"}
(901)

![](media/image144.wmf){width="0.125in"
height="0.2361111111111111in"}The signal\'s long-term energy
corresponding to each
sub-frame,![](media/image145.wmf){width="0.5034722222222222in"
height="0.23333333333333334in"}, is updated according to the following
equation:

![](media/image146.wmf){width="3.026388888888889in"
height="0.23333333333333334in"} (902)

In the above equation, the forgetting factor
![](media/image147.wmf){width="0.15555555555555556in" height="0.1375in"}
is set to 0.25, and the convention that
![](media/image148.wmf){width="1.0854166666666667in"
height="0.23333333333333334in"}from the previous frame is used. The
high-pass filter,![](media/image149.wmf){width="0.48541666666666666in"
height="0.20972222222222223in"}, states as well
as![](media/image150.wmf){width="0.4618055555555556in"
height="0.20972222222222223in"} are saved for processing in the next
frame.

During switching, when core has changed or extension layer has changed,
then ![](media/image151.wmf){width="0.4527777777777778in"
height="0.20972222222222223in"}is initialized with the energy
of![](media/image152.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"}.

For each sub-frame ![](media/image153.wmf){width="0.15555555555555556in"
height="0.1375in"}, a comparison between the short-term energy
![](media/image154.wmf){width="0.5034722222222222in"
height="0.20972222222222223in"} and the long-term energy
![](media/image155.wmf){width="0.5034722222222222in"
height="0.23333333333333334in"}is performed. A transient is detected
whenever the energy ratio is above a certain threshold. Formally, a
transient is detected whenever:

![](media/image156.wmf){width="1.26875in"
height="0.23333333333333334in"} (903)

where![](media/image157.wmf){width="0.15555555555555556in"
height="0.16458333333333333in"}is the energy ratio threshold and is set
according to table 81.

Table 81: Threshold table for transient detector

  ----------------- ------------------------------------------------------------------------------- -----------
  Extension layer   Condition                                                                       Threshold
  Generic Mode      Inactive                                                                        10
                    Not Inactive                                                                    13.5
  Otherwise         SWB, ![](media/image158.wmf){width="0.8875in" height="0.20069444444444445in"}   
                    Otherwise                                                                       6
  ----------------- ------------------------------------------------------------------------------- -----------

For the first coded frame with extension layer using the Generic mode
then the transient detection, after Equation 903, is set to 0.

In general, the time-frequency transform is applied on a 40-ms frame;
therefore, a transient will affect two consecutive frames. To overcome
this, a hangover for detected transient is used. A transient detected at
a certain frame will also trigger a transient at the next frame.

The output of the transient detector is a flag, denoted *IsTransient*.
The flag is set to the logical value *TRUE* if a transient is detected,
or *FALSE* otherwise.

If there is a change in extension layer, then the hangover and filter
memories are reset before the start of the transient detector.

![](media/image159.wmf){width="6.689583333333333in"
height="2.6180555555555554in"}

Figure 56: Transient detection algorithm for NB

The block diagram of the transient detection algorithm for NB is shown
in figure 56. Most of algorithm is same as that of WB and SWB. In the
*Compute block energy* block, the energy of each sub-frame for
![](media/image160.wmf){width="0.47638888888888886in"
height="0.20972222222222223in"},![](media/image161.wmf){width="0.5215277777777778in"
height="0.20972222222222223in"}, is computed according to:

![](media/image162.wmf){width="3.113888888888889in"
height="0.5729166666666666in"} (904)

where the *E~HP~(0)* is the energy of the 4^th^ sub-frame in the
previous frame.

The *Transient information refinement* block performs an additional
verification and checks whether the current frame that has been
determined as a transient frame is truly a transient frame. This is to
prevent a transient determination error occurring due to the high-pass
filtering block removing energy in a low frequency. The operation of the
*Transient information refinement* block is described for the case where
the current frame is detected to be transient.

![](media/image163.wmf){width="3.754861111111111in"
height="1.5215277777777778in"}

Figure 57: Transient information refinement for NB

The position which is detected as a transient is one of 4 sub-frames in
frame *n*. The number of blocks included in the region L and the number
of blocks included in the second region H will vary depending which of
these 4 sub-frames is detected as the transient, as represented in the
figure 57.

First, the ratio of the average of the short-term energy in the region H
(E\_high) to the average of the short-term energy in the region L
(E\_low) is calculated. Region H includes the block which was previously
detected to be transient and blocks existing thereafter. Region L
includes the blocks prior to region H.

Next, the ratio of the short-term energy of the frame *n* before the
high pass filtering (E\_in) to the short-term energy of the frame *n*
after the high pass filtering (E\_out) is calculated.

If these ratios meet the following conditions, frame *n* is determined
to the normal frame instead of a transient frame.

if( ((E\_high/E\_low\<2.0f)&&(E\_high/E\_low\>0.7f)) &&
((E\_in/E\_out)\>Thres) )

IsTransient = 0;

##### 5.3.2.4.1.2 Short window transform {#short-window-transform .H6}

When the flag IsTransient is set then the transform is switched from a
long transform to a series of short transforms as is depicted in figure
58. This subclause describes the short transform.

![](media/image164.wmf){width="6.114583333333333in"
height="2.9118055555555555in"}

Figure 58: Adaptive time-frequency transform

Windowing and time-domain aliasing are done as described in subclause
5.3.2.2. A reordering of the time-domain aliased signal is performed. In
order to keep the temporal coherence of the input signal, the output of
the time‑domain aliasing operation needs to be reordered before further
processing. The ordering operation is necessary, without ordering the
basis functions of the resulting filter-bank will have an incoherent
time and frequency responses. The reordering is done according to
equation 905, and consists of shuffling the upper and lower half of the
TDA output signal ![](media/image165.wmf){width="0.5125in"
height="0.20972222222222223in"}.

![](media/image166.wmf){width="2.4in" height="0.20972222222222223in"}
(905)

This reordering is only conceptual and in reality no computations are
involved. Higher time resolution is obtained by zero-padding the signal
![](media/image167.wmf){width="0.5125in"
height="0.20972222222222223in"}and dividing the resulting signal into
four overlapped equal length sub-frames. The amount of zero-padding is
equal to![](media/image168.wmf){width="0.2513888888888889in"
height="0.20972222222222223in"} on each side of the signal. The segments
are 50% overlapped and each segment has a length equal
to![](media/image169.wmf){width="0.26944444444444443in"
height="0.20972222222222223in"}. The two inner segments are
post-windowed using a sine window of
length![](media/image170.wmf){width="0.26944444444444443in"
height="0.20972222222222223in"}. The windows for outer segments are
constructed using half a sine window.

This operation is depicted in figure 59; each resulting post-windowed
segment is further processed by applying the modified discrete cosine
transform (MDCT) (i.e., time aliasing + DCT~IV~). The output of the MDCT
for each segment represents the signal spectrum at different time
instants, thus, in case of transients, a higher time resolution is used.

The length of the output of each of the four MDCTs is half the length of
the input segment,
i.e.,![](media/image171.wmf){width="0.26944444444444443in"
height="0.20972222222222223in"}, therefore this operation does not add
additional redundancy.

![](media/image172.wmf){width="5.674305555555556in"
height="3.0506944444444444in"}

Figure 59: Higher time resolution, division into four segments

##### 5.3.2.4.1.3 Interleaving {#interleaving .H6}

After the short transform described in subclause 5.3.2.4.1.2, then the
coefficients of the equivalent four 5-ms transforms are interleaved.
Table 82 shows the band lengths used for interleaving. Coefficients of
interleave band length are read from the first transform,
![](media/image173.wmf){width="0.4673611111111111in"
height="0.2604166666666667in"}, then the second transform,
![](media/image174.wmf){width="0.4673611111111111in"
height="0.2604166666666667in"}, and so on until the fourth transform.
This is then repeated for all interleave bands. The interleaved bands
are written to the vector
![](media/image175.wmf){width="0.4673611111111111in"
height="0.20972222222222223in"}.

Table 82: Band widths for transient mode interleaving

  ------ ---- ---- ---- ---- ---- ---- ---- ---- ----
  Band   0    1    2    3    4    5    6    7    8
  WB     16   16   16   16   16                  
  SWB    16   16   16   16   24   24   24   24   
  FB     16   16   16   16   24   24   24   32   32
  ------ ---- ---- ---- ---- ---- ---- ---- ---- ----

##### 5.3.2.4.2 Short window transform for MDCT based TCX

After choosing the transform and overlap length configuration for
transient frame as described in subclause 5.3.2.3 each sub-frame (TCX5
or TCX10) is windowed and transformed using the MDCT, which is
implemented using TDA and DCT~IV~.

After the TNS described in subclause 5.3.3.2.2, the MDCT bins of 2 TCX5
sub-frames are interleaved:

![](media/image176.wmf){width="2.1569444444444446in"
height="0.6444444444444445in"} (906)

#### 5.3.2.5 Special window transitions

The overlap mode FULL is used for transitions between long ALDO windows
and short symmetric windows (HALF, MINIMAL) for short block
configurations (TCX10, TCX5) described in subclause 5.3.2.3. The
transition window is derived from the ALDO and sine window overlaps.

##### 5.3.2.5.1 ALDO to short transition

The left overlap of the transition window has a length of 8.75ms (FULL
overlap) and is derived from the ALDO window. The left slope of the ALDO
analysis window (long slope) is first shortened to 8.75ms by removing
the first 5.625ms. Then the first 1.25ms of the remaining slope are
multiplied with the 1.25ms MINIMAL overlap slope to smooth the edge. The
resulting 8.75ms slope is depicted in figure 60.

For the right part of the transition window HALF or MINIMAL overlap is
used.

![](media/image177.jpeg){width="5.513888888888889in"
height="2.0340277777777778in"}

Figure 60: Window shape transition ADLO to Short

##### 5.3.2.5.2 Short to ALDO transition

HALF or MINIMAL overlap is used for the left part of the transition
window.

For the right part of the transition window the right slope of the ALDO
analysis window (short slope) is used, which has a length of 8.75ms (see
figure 61).

![](media/image178.jpeg){width="5.513888888888889in"
height="2.0340277777777778in"}

Figure 61: Window shape transition Short to ALDO

#### Modified Discrete Sine Transform

The MDST is computed in the same way as the MDCT defined in the previous
subclauses, with two exceptions:

-   The TDAC equation is described by:

![](media/image179.wmf){width="2.2527777777777778in" height="0.44375in"}
(907)

-   The DCT~IV~ given by equation (890) is replaced by a DST~IV~:

![](media/image180.wmf){width="3.209722222222222in" height="0.5125in"}
(908)

The MDST transformation always follows the MDCT parameters such as
transform size or windowing.

### 5.3.3 MDCT based TCX

#### 5.3.3.1 General description

##### 5.3.3.1.1 High level overview

The MDCT based TCX (TCX) mode codes the MDCT spectrum using an LPC
scheme for noise shaping. The LPC parameters are estimated in time
domain and applied in the MDCT domain. The basic mode consists of a 20ms
MDCT transformation (TCX20). For higher rates, smaller transform sizes
for 10ms (TCX10) and 5ms (TCX5) are supported as well. The TCX mode
provides several coding tools such as adaptive low frequency emphasis,
temporal noise shaping, intelligent gap filling or noise filling to
improve coding efficiency. The spectral data is finally quantized by a
uniform quantizer with dead-zone and noiseless codec by an arithmetic
coder module with several modes.

For the MDCT based TCX, the total length of the MDCT spectrum
![](media/image181.wmf){width="0.3659722222222222in"
height="0.2604166666666667in"} depends on the input sampling rate, the
TCX mode and the coding mode of the previous frame. Some of the coding
tools used in TCX only work on the lower MDCT bins corresponding to the
CELP frequency range, as LP analysis is performed on the CELP sampling
rate. This number of bins is designated
by![](media/image182.wmf){width="0.38333333333333336in"
height="0.2604166666666667in"}. The maximum number of bins
![](media/image183.wmf){width="0.34791666666666665in"
height="0.2604166666666667in"} encoded by TCX is determined by the
coding bandwidth. If
![](media/image184.wmf){width="0.3659722222222222in"
height="0.2604166666666667in"}
exceeds![](media/image185.wmf){width="0.34791666666666665in"
height="0.2604166666666667in"}, the remaining bins are filled with
zeroes.

The following table
defines![](media/image186.wmf){width="0.3659722222222222in"
height="0.2604166666666667in"},
![](media/image187.wmf){width="0.38333333333333336in"
height="0.2604166666666667in"}
and![](media/image188.wmf){width="0.34791666666666665in"
height="0.2604166666666667in"}:

Table 83: Overview frame sizes of MDCT-based TCX

  -------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------- -----
  TCX mode                                                                               TCX20                                                                                  TCX10/TCX5                                                                                                                                                                    
  Previous coding mode                                                                   MDCT                                                                                   CELP                                                                                                                                                                          
  ![](media/image189.wmf){width="0.3659722222222222in" height="0.2604166666666667in"}    ![](media/image190.wmf){width="0.4673611111111111in" height="0.34791666666666665in"}   ![](media/image191.wmf){width="0.6354166666666666in" height="0.38333333333333336in"}   ![](media/image192.wmf){width="0.5215277777777778in" height="0.34791666666666665in"}   
  ![](media/image193.wmf){width="0.38333333333333336in" height="0.2604166666666667in"}   ![](media/image194.wmf){width="0.5125in" height="0.34791666666666665in"}               ![](media/image195.wmf){width="0.7229166666666667in" height="0.44375in"}               ![](media/image196.wmf){width="0.5548611111111111in" height="0.34791666666666665in"}   
  ![](media/image197.wmf){width="0.34791666666666665in" height="0.2604166666666667in"}   NB                                                                                     160                                                                                    200                                                                                    80
                                                                                         WB                                                                                     320                                                                                    400                                                                                    160
                                                                                         SWB                                                                                    640                                                                                    800                                                                                    320
                                                                                         FB                                                                                     960                                                                                    1200                                                                                   480
  -------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------- -----

##### 5.3.3.1.2 Rate dependent configuration

The MDCT-based TCX contains different setups depending on the bit rate
for encoding. In general, the setup consists of three configurations:
Low-rate, mid-rate and high-rate configuration. The following table
lists the main tools used in the various configurations.

Table 84: Overview configurations MDCT-based TCX

+-----------------------+----------------+-------------------------+
| Bitrate               | Bandwidth      | Specific configurations |
|                       |                |                         |
| \[kbps\]              |                |                         |
+-----------------------+----------------+-------------------------+
| 9.6                   | NB,WB,SWB      | low-rate LPC, envelope  |
|                       |                | based arithmetic coder, |
| (Low-rate)            |                | ALFE 1, TCX20           |
+-----------------------+----------------+-------------------------+
| 13.2 - 32             | NB, WB, SWB,FB | mid-rate LPC, context   |
|                       |                | based arithmetic coder, |
| (Mid-rate)            |                | ALFE 2, TCX20           |
+-----------------------+----------------+-------------------------+
| 48 -- 128 (High-rate) | WB, SWB,FB     | high-rate LPC, context  |
|                       |                | based arithmetic coder, |
|                       |                | ALFE 1, TCX20/10/5      |
+-----------------------+----------------+-------------------------+

One additional bit rate dependent tool is temporal noise shaping (TNS).
TNS is activated only for bit rate 24.4 kbps and higher.

#### 5.3.3.2 General encoding procedure

##### 5.3.3.2.1 LPC parameter calculation

##### 5.3.3.2.1.1 Low rate LPC {#low-rate-lpc .H6}

MDCT based TCX relies on smoothed LPC spectral envelope. Analysis
methods are identical to that of ACELP. Quantization of LSF is also
common to ACELP except for 9.6 kbps (NB/WB/SWB). Quantization of
weighted LSF and conversion of LSF used for 9.6 kbps (NB/WB/SWB) are
described in the following subclauses.

##### 5.3.3.2.1.1.1 Quantization of weighted LSF {#quantization-of-weighted-lsf .H6}

For MDCT based TCX at 9.6 kbps (NB/WB), envelope based arithmetic coding
and low rate quantization of weighted LSF are used. After normal LPC
analysis and interpolation in LSP domain, perceptual weighting is
applied to the prediction coefficients to get weighted prediction
coefficients ![](media/image198.wmf){width="0.15555555555555556in"
height="0.20972222222222223in"} as

![](media/image199.wmf){width="1.4965277777777777in"
height="0.23333333333333334in"}. (909)

Weighted prediction coefficients
![](media/image200.wmf){width="0.27847222222222223in"
height="0.20972222222222223in"} are converted to LSF vector
![](media/image201.wmf){width="1.8958333333333333in"
height="0.27847222222222223in"}and the LSF vector is quantized with two
stage or three stage VQ. These VQ codebooks are used in two ways.

First and primary use of the quantization is intended to represent the
weighted LPC envelope to shape the MDCT coefficients with MA inter frame
prediction. Secondary use is to tell the estimate of envelope to the
arithmetic coding without depending on MA prediction.

In case of primary encoding, input weighted LSF vector
![](media/image202.wmf){width="0.19166666666666668in"
height="0.2513888888888889in"}is subtracted by the mean vector
![](media/image203.wmf){width="0.16458333333333333in"
height="0.13194444444444445in"} and the MA predicted contribution vector
![](media/image204.wmf){width="0.26944444444444443in"
height="0.21597222222222223in"} to generate the input of two stage VQ
![](media/image205.wmf){width="0.2513888888888889in"
height="0.23333333333333334in"}, .

![](media/image206.wmf){width="1.148611111111111in"
height="0.2513888888888889in"}. (910)

For the first stage VQ, 5 bits for 16 samples are allocated. For the
second stage VQ, 4 bits are assigned to the lower 6 LSF parameters and 4
bits for the higher 10 parameters. A quantization criterion is to
minimize the weighted distortion between input,
![](media/image207.wmf){width="0.2604166666666667in"
height="0.2604166666666667in"}and output of quantized LSF vectors,
![](media/image208.wmf){width="0.2604166666666667in"
height="0.2604166666666667in"}. The reconstructed LSF vector after
adding mean vector and the MA predicted contribution vector,
![](media/image209.wmf){width="1.2354166666666666in"
height="0.2513888888888889in"}can be converted to the weighted envelope
representing ![](media/image210.wmf){width="1.2083333333333333in"
height="0.20972222222222223in"}and used for noise shaping of MDCT domain
transform coefficients.

In the secondary encoding and decoding, the same LSF vector from the VQ
table at the primary encoding,
![](media/image211.wmf){width="0.2604166666666667in" height="0.225in"}
is retrieved and mean vector is added to reconstruct weighted LSF vector
without MA prediction
![](media/image212.wmf){width="0.8423611111111111in"
height="0.23333333333333334in"}. This can inform the shape of envelope
for the envelope base arithmetic coding even when the decoder cannot get
the information from the previous frame.

Envelope shape could be distorted due to the lack of MA prediction and a
third stage VQ is used to compensate the distortion only when necessary.
Compensation is preferable when large spectral envelope or large
distortion in spectral envelope is expected. In order to determine the
necessity of the third stage VQ, the first and the second lower values
of ![](media/image213.wmf){width="0.19166666666666668in"
height="0.23333333333333334in"}, namely,
![](media/image214.wmf){width="0.375in" height="0.2423611111111111in"}
and ![](media/image215.wmf){width="0.34791666666666665in"
height="0.2423611111111111in"} are checked.
If![](media/image214.wmf){width="0.375in"
height="0.2423611111111111in"}or
![](media/image216.wmf){width="0.8875in"
height="0.2423611111111111in"}have smaller values than the threshold,
namely expected envelope values and distortion are larger than
threshold, the third VQ with 2 bits is applied to
![](media/image214.wmf){width="0.375in" height="0.2423611111111111in"}
and ![](media/image215.wmf){width="0.34791666666666665in"
height="0.2423611111111111in"} for the purpose of corrections. The
criteria of the selection of the retrieved vector at the third stage VQ,
![](media/image217.wmf){width="0.2965277777777778in"
height="0.23333333333333334in"} is to minimize the weighted distortion
between input ![](media/image218.wmf){width="0.19166666666666668in"
height="0.23333333333333334in"}and a final reconstructed LSF vector
without MA prediction
![](media/image219.wmf){width="1.2354166666666666in"
height="0.23333333333333334in"}. If both
![](media/image214.wmf){width="0.375in"
height="0.2423611111111111in"}and
![](media/image216.wmf){width="0.8875in"
height="0.2423611111111111in"}values are equal to or larger than
threshold, the third VQ is skipped and
![](media/image220.wmf){width="0.19166666666666668in"
height="0.23333333333333334in"}is used as a final reconstruction LSF
vector.

Reconstructed LSF vector
![](media/image213.wmf){width="0.19166666666666668in"
height="0.23333333333333334in"}is corresponding to the weighted
envelope![](media/image221.wmf){width="0.7916666666666666in"
height="0.20972222222222223in"}without depending on MA prediction. In
envelope based arithmetic coding, unweighted LSF vector without
depending on MA prediction
![](media/image222.wmf){width="0.1736111111111111in"
height="0.20972222222222223in"}is also necessary to estimate the MDCT
envelope. This can be obtained by low-complex direct matrix conversion
described in the next subclause.

##### 5.3.3.2.1.1.2 Direct conversion of LSF {#direct-conversion-of-lsf .H6}

For the interpolation of LSF to the LSF in the possible ACELP at the
next frame, the reconstructed LSF vector
![](media/image223.wmf){width="0.19166666666666668in"
height="0.2513888888888889in"}with MA prediction needs to be converted
to unweighted domain LSF vector
![](media/image224.wmf){width="0.1736111111111111in"
height="0.20972222222222223in"}. Similarly, reconstructed LSF vector
without MA prediction
![](media/image225.wmf){width="0.19166666666666668in"
height="0.2513888888888889in"}needs to be converted to get unweighted
domain LSF ![](media/image226.wmf){width="0.1736111111111111in"
height="0.20972222222222223in"}to assist the envelope base arithmetic
coding.

In order to get unweighted LSF
![](media/image227.wmf){width="1.8597222222222223in"
height="0.2513888888888889in"}corresponding
to![](media/image228.wmf){width="0.43472222222222223in"
height="0.19166666666666668in"}, weighted LSF
![](media/image229.wmf){width="1.8958333333333333in"
height="0.27847222222222223in"} is converted by using
matrix![](media/image230.wmf){width="0.19166666666666668in"
height="0.1736111111111111in"}and equally spaced LSF
![](media/image231.wmf){width="2.495833333333333in"
height="0.2513888888888889in"}as follows.

![](media/image232.wmf){width="1.7395833333333333in"
height="0.2604166666666667in"} (911)

![](media/image233.wmf){width="2.798611111111111in" height="1.425in"}
(912)

![](media/image234.wmf){width="0.8604166666666667in"
height="0.20972222222222223in"} has non-zero elements only in the
diagonal position and the adjacent samples as follows and the non-zero
elements are shown in table 85.

![](media/image235.wmf){width="2.738888888888889in"
height="1.2958333333333334in"} (913)

Table 85: Non-zero elements of conversion matrices

+---------+---------+---------+---------+---------+---------+---------+
|         | from    | from    |         |         |         |         |
|         | ![](    | ![](    |         |         |         |         |
|         | media/i | media/i |         |         |         |         |
|         | mage236 | mage237 |         |         |         |         |
|         | .wmf){w | .wmf){w |         |         |         |         |
|         | idth="0 | idth="0 |         |         |         |         |
|         | .278472 | .278472 |         |         |         |         |
|         | 2222222 | 2222222 |         |         |         |         |
|         | 2223in" | 2223in" |         |         |         |         |
|         | he      | he      |         |         |         |         |
|         | ight="0 | ight="0 |         |         |         |         |
|         | .173611 | .173611 |         |         |         |         |
|         | 1111111 | 1111111 |         |         |         |         |
|         | 111in"} | 111in"} |         |         |         |         |
|         | 0.92 to | 0.94 to |         |         |         |         |
|         | 1.0     | 1.0     |         |         |         |         |
|         |         |         |         |         |         |         |
|         | (12.8   | (16 kHz |         |         |         |         |
|         | kHz     | sample) |         |         |         |         |
|         | sample) |         |         |         |         |         |
+---------+---------+---------+---------+---------+---------+---------+
| ![](m   | ![](    | ![]     | ![](    | ![](    | ![]     | ![](    |
| edia/im | media/i | (media/ | media/i | media/i | (media/ | media/i |
| age238. | mage239 | image24 | mage241 | mage239 | image24 | mage243 |
| wmf){wi | .wmf){w | 0.wmf){ | .wmf){w | .wmf){w | 2.wmf){ | .wmf){w |
| dth="9. | idth="0 | width=" | idth="0 | idth="0 | width=" | idth="0 |
| 5833333 | .356944 | 0.24236 | .356944 | .356944 | 0.24236 | .356944 |
| 3333333 | 4444444 | 1111111 | 4444444 | 4444444 | 1111111 | 4444444 |
| 4e-2in" | 4445in" | 1111in" | 4445in" | 4445in" | 1111in" | 4445in" |
| hei     | hei     | hei     | hei     | hei     | hei     | hei     |
| ght="0. | ght="0. | ght="0. | ght="0. | ght="0. | ght="0. | ght="0. |
| 1916666 | 2159722 | 2159722 | 2159722 | 2159722 | 2159722 | 2159722 |
| 6666666 | 2222222 | 2222222 | 2222222 | 2222222 | 2222222 | 2222222 |
| 668in"} | 223in"} | 223in"} | 223in"} | 223in"} | 223in"} | 223in"} |
+---------+---------+---------+---------+---------+---------+---------+
| 1       | \-      | 1.19764 | -       | \-      | 0.78925 | -       |
|         |         |         | 0.59173 |         |         | 0.38537 |
+---------+---------+---------+---------+---------+---------+---------+
| 2       | -       | 1.79182 | -       | -       | 1.19486 | -       |
|         | 0.91173 |         | 0.80921 | 0.57154 |         | 0.54136 |
+---------+---------+---------+---------+---------+---------+---------+
| 3       | -       | 1.44703 | -       | -       | 0.99096 | -       |
|         | 0.51779 |         | 0.81871 | 0.33642 |         | 0.56792 |
+---------+---------+---------+---------+---------+---------+---------+
| 4       | -       | 1.36777 | -       | -       | 0.93785 | -       |
|         | 0.44862 |         | 0.75103 | 0.29856 |         | 0.51255 |
+---------+---------+---------+---------+---------+---------+---------+
| 5       | -0.4515 | 1.30719 | -0.7422 | -       | 0.89303 | -       |
|         |         |         |         | 0.29716 |         | 0.50509 |
+---------+---------+---------+---------+---------+---------+---------+
| 6       | -       | 1.21326 | -       | -       | 0.81530 | -       |
|         | 0.43157 |         | 0.68538 | 0.28264 |         | 0.46020 |
+---------+---------+---------+---------+---------+---------+---------+
| 7       | -       | 1.21317 | -       | -       | 0.80997 | -       |
|         | 0.43606 |         | 0.69131 | 0.27926 |         | 0.46378 |
+---------+---------+---------+---------+---------+---------+---------+
| 8       | -0.392  | 1.04941 | -       | -       | 0.69596 | -       |
|         |         |         | 0.58674 | 0.25334 |         | 0.38969 |
+---------+---------+---------+---------+---------+---------+---------+
| 9       | -       | 1.10009 | -       | -       | 0.72916 | -       |
|         | 0.45208 |         | 0.59175 | 0.29656 |         | 0.38888 |
+---------+---------+---------+---------+---------+---------+---------+
| 10      | -       | 0.99725 | -       | -       | 0.65949 | -       |
|         | 0.42553 |         | 0.49992 | 0.27488 |         | 0.32999 |
+---------+---------+---------+---------+---------+---------+---------+
| 11      | -       | 1.07575 | -       | -       | 0.70913 | -       |
|         | 0.50168 |         | 0.51401 | 0.32630 |         | 0.33659 |
+---------+---------+---------+---------+---------+---------+---------+
| 12      | -0.498  | 1.06563 | -       | -       | 0.70668 | -       |
|         |         |         | 0.50592 | 0.33069 |         | 0.33105 |
+---------+---------+---------+---------+---------+---------+---------+
| 13      | -       | 1.16372 | -       | -       | 0.77582 | -       |
|         | 0.53101 |         | 0.58033 | 0.35437 |         | 0.38003 |
+---------+---------+---------+---------+---------+---------+---------+
| 14      | -       | 1.07596 | -       | -       | 0.70752 | -       |
|         | 0.48744 |         | 0.52531 | 0.31771 |         | 0.34216 |
+---------+---------+---------+---------+---------+---------+---------+
| 15      | -       | 1.04998 | -       | -       | 0.70177 | -       |
|         | 0.51899 |         | 0.49495 | 0.35066 |         | 0.31664 |
+---------+---------+---------+---------+---------+---------+---------+
| 16      | -0.4773 | 0.90959 | \-      | -       | 0.62528 | \-      |
|         |         |         |         | 0.33404 |         |         |
+---------+---------+---------+---------+---------+---------+---------+

##### 5.3.3.2.1.2 Mid-rate LPC {#mid-rate-lpc .H6}

For mid-rate bitrates (between 13.2 and 32 kbps) the LP analysis method
is the same as for ACELP. The quantizer used is also the same but
operated in AUDIO mode only (see subclause 5.2.2.1.2). However the
interpolation of quantized LSF coefficients is different. Here each
interpolated LSF coefficient
![](media/image244.wmf){width="9.583333333333334e-2in"
height="0.1736111111111111in"} is a weighted sum of the quantized LSF
coefficients referring to the current and previous frame:

![](media/image245.wmf){width="3.5909722222222222in"
height="0.2513888888888889in"} (914)

These interpolated coefficients are converted back to LPC domain in the
same way as done for ACELP frames.

##### 5.3.3.2.1.3 High-rate LPC {#high-rate-lpc .H6}

This subclause describes the LPC analysis and quantization scheme for
high-rate bitrates (48 kbps and higher). The description in the
following subclauses refers to the quantization of either a single set
of LPC parameters for the whole frame or two sets if the frame is
divided into sub-frames. As described in subclause 5.3.2.3 a frame can
be subdivided into TCX5 or TCX10 sub-frames. In this case the LPC
quantizer however treats two adjacent TCX5 sub-frames as a single TCX10
sub-frame.

The LP coefficients are obtained by calculating autocorrelation on a
windowed and pre-emphasized time domain signal with
![](media/image246.wmf){width="0.6263888888888889in"
height="0.2423611111111111in"} set to 0.9 for SWB and to 0.72 for WB and
the input signal to the pre-emphasis filter is
![](media/image247.wmf){width="0.39861111111111114in"
height="0.20972222222222223in"} for WB,
![](media/image248.wmf){width="0.5034722222222222in"
height="0.20972222222222223in"} for 48 kbps SWB
and![](media/image249.wmf){width="0.39861111111111114in"
height="0.20972222222222223in"} for 96 kbps and 128 kbps SWB (see
subclause 5.1.4). The window used here is the window used for the TCX
MDCT transformation (described in subclause 5.3.2.3) with the only
exception, the ALDO windows will be replaced by FULL overlap windows
(see subclause 5.3.2.5). After autocorrelation adaptive lag-windowing
(see subclause 5.1.9.3) is applied to the autocorrelation coefficients
which are finally converted to LP coefficients by Levinson recursion.
The sample rate used for adaptive lag-windowing is the TCX sample rate
(25.6 or 32 kHz) and the information of OL pitch estimation of current
frame is used. For quantization the LP coefficients are converted to LSF
domain.

The first set of LSF coefficients is always quantized without
inter-frame dependency. In case two sets of LSF coefficients are
quantized the second set may be quantized with or without dependency to
the first set. This dependency (explained below) is signalled with one
bit.

##### 5.3.3.2.1.3.1 General Principle {#general-principle .H6}

The general principle for the quantization of a given LPC filter is
represented in figure 62. A first-stage approximation is computed, and
then subtracted from the input LSF vector to produce a residual LSF
vector.

A LSF weighting function is derived from the first-stage approximation
and applied to the residual LSF vector. The purpose and calculation of
the weighting function are described in subclause 5.3.3.2.1.2.3.

The resulting weighted residual LSF vector is finally fed to the
algebraic VQ encoder described in subclause 5.3.3.2.1.2.4.

![](media/image250.png){width="4.79375in" height="1.8006944444444444in"}

Figure 62: Principle of weighted algebraic LPC quantizer

##### 5.3.3.2.1.3.2 First-stage approximation {#first-stage-approximation .H6}

The first stage approximation is a 16-dimensional, 8-bits stochastic
vector quantizer applied to the input LSF vector. The codebook search
uses a weighted Euclidian distance in which each component of the
squared difference between the input LSF vector and the codebook entry
is multiplied by:

![](media/image251.wmf){width="1.64375in" height="0.4166666666666667in"}
(915)

with:

![](media/image252.wmf){width="1.8868055555555556in"
height="0.6354166666666666in"} (916)

where LSF is the input LSF vector to be quantized and
![](media/image253.wmf){width="0.225in" height="0.1736111111111111in"}is
the internal sampling frequency of the TCX-based codec (25600 for 48
kbps and 32000 for 96 kbps and above).

The difference between the input LSF vector and the first-stage
approximation is called the residual LSF vector.

##### 5.3.3.2.1.3.3 LSF weighting {#lsf-weighting .H6}

Initially a weighted sum of the residual LSF vector is compared to a
threshold:

![](media/image254.wmf){width="1.8958333333333333in"
height="0.4527777777777778in"} (917)

where ![](media/image255.wmf){width="0.44375in"
height="0.23333333333333334in"} are the first stage approximation of the
LSF coefficients and
![](media/image256.wmf){width="0.3659722222222222in"
height="0.20972222222222223in"} are the weights according to equation
(918) with the factor
![](media/image257.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"} being
![](media/image258.wmf){width="0.19166666666666668in"
height="0.16458333333333333in"}. If the above relation is true, a
special codebook is selected and no further quantization done. Otherwise
the residual LSF vector is quantized with stochastic vector
quantization.

The principle of stochastic vector quantization is to search a codebook
of vectors for the nearest neighbour (in terms of Euclidian distance) of
the vector to be quantized. When quantizing LPC filters in the LSF (line
spectral frequency) domain, a weighted Euclidian distance is generally
used, each component of the vector being weighted differently depending
on its value and of the value of the other components. The purpose of
this weighting is to make the minimization of the Euclidian distance
behave as close as possible to a minimization of the spectral
distortion.

Unlike a stochastic quantizer, a uniform algebraic vector quantizer does
not perform an exhaustive search of the codebook. It is therefore very
complex to introduce a weighting function in the distance computation.

The solution used here is to warp the residual LSF vector (i.e. the
difference between the input LSF vector and a first stage approximation)
using a weighting function computed from the first-stage LSF
approximation. By warping we mean applying different weights to the
components of the LSF residual vector. Because the first-stage LSF
approximation is also available at the decoder, the inverse weighting
factors can also be computed at the decoder and the inverse warping can
be applied to the quantized residual LSF vector. Warping the residual
LSF vector according to a model that minimizes the spectral distortion
is especially useful when the quantizer is uniform.

The weights applied to the components of the residual LSF vector are:

![](media/image259.wmf){width="2.120833333333333in" height="0.44375in"}
(918)

with

![](media/image260.wmf){width="1.9319444444444445in"
height="0.6354166666666666in"} (919)

where ![](media/image261.wmf){width="0.225in"
height="0.1736111111111111in"} is the internal sampling frequency of the
TCX-based codec (25600 for 48 kbps and 32000 for 96 kbps and above). The
factor ![](media/image262.wmf){width="0.12291666666666666in"
height="0.18263888888888888in"} is always
![](media/image263.wmf){width="0.19166666666666668in"
height="0.16458333333333333in"} for the first set of LSF coefficients.

##### 5.3.3.2.1.3.4 Algebraic vector quantizer {#algebraic-vector-quantizer .H6}

The algebraic VQ used for quantizing the refinement is described in
subclause 5.2.3.1.6.9.

##### 5.3.3.2.1.3.5 Quantization of second set of LSF {#quantization-of-second-set-of-lsf .H6}

In case a second set of LSF coefficients needs to be quantized, the
quantization scheme for the second set may be dependent on the first set
or not. Two approaches are tried and the one with the lower bit
consumption will be chosen. The first approach is identical to the
quantization of the first set. In the second approach the first stage
approximation described in subclause 5.3.3.2.1.3.2 is replaced by the
quantized first set of LSF. The factor
![](media/image264.wmf){width="0.12291666666666666in"
height="0.18263888888888888in"}for calculating the weights is changed
to![](media/image265.wmf){width="0.18263888888888888in"
height="0.16458333333333333in"}. Finally the bit consumption of both
approaches is compared and the one yielding the lower amount of bits is
chosen and signalled with one bit.

##### 5.3.3.2.2 Temporal Noise Shaping

Temporal Noise Shaping (TNS) is used to control the temporal shape of
the quantization noise within each window of the transform.

If TNS is active in this encoder, up to two filters per MDCT-spectrum
will be applied. The steps in the TNS encoding are described below. TNS
is always calculated on a per subwindow basis, so in case of an 4 TCX5
window sequence these steps have to be applied once for each of the 4
subwindows.

Table 86: TNS configurations

+-----------+-----------+--------------+--------------+--------------+
| Bitrate   | Bandwidth | Number of    | Number of    | Number of    |
|           |           | TNS filters  | TNS filters  | TNS filters  |
| \[kbps\]  |           | for TCX20    | for TCX10    | for TCX5 and |
|           |           | and start    | and start    | start and    |
|           |           | and stop     | and stop     | stop         |
|           |           | frequency    | frequency    | frequency    |
+-----------+-----------+--------------+--------------+--------------+
| 24.4, 32  | SWB       | 1            | TCX10 not    | TCX5 not     |
|           |           | (60          | used         | used         |
|           |           | 0Hz-16000Hz) |              |              |
+-----------+-----------+--------------+--------------+--------------+
| 48,96,128 | WB        | 1            | 2            | 1            |
|           |           | (6           | (8           | (8           |
|           |           | 00Hz-8000Hz) | 00Hz-4400Hz, | 00Hz-8000Hz) |
|           |           |              | 4400-8000Hz) |              |
+-----------+-----------+--------------+--------------+--------------+
| 48,96,128 | SWB       | 2            | 2            | 1            |
|           |           | (6           | (8           | (80          |
|           |           | 00Hz-4500Hz, | 00Hz-8400Hz, | 0Hz-16000Hz) |
|           |           | 4            | 8            |              |
|           |           | 500-16000Hz) | 400-16000Hz) |              |
+-----------+-----------+--------------+--------------+--------------+
| 24.4,32   | FB        | 1            | TCX10 not    | TCX5 not     |
|           |           | (60          | used         | used         |
|           |           | 0Hz-20000Hz) |              |              |
+-----------+-----------+--------------+--------------+--------------+
| 48,96,128 | FB        | 2            | 2            | 1            |
|           |           | (6           | (80          | (80          |
|           |           | 00Hz-4500Hz, | 0Hz-10400Hz, | 0Hz-20000Hz) |
|           |           | 4            | 10           |              |
|           |           | 500-20000Hz) | 400-20000Hz) |              |
+-----------+-----------+--------------+--------------+--------------+

The number of filters for each configuration and the start and the stop
frequency of each filter are given in table 86.

The MDCT bins of 2 TCX5 sub-frames are rearranged prior to TNS
filtering:

![](media/image266.wmf){width="2.582638888888889in" height="1.26875in"}
(920)

For such rearanged and concatanated 2 TCX5 frames, special TNS
configuration with 2 filters is used, which effectively functions as one
filter per TCX5. The rearrangement is reverted after the filtering
described below, to again have 2 separated TCX5 subwindows.

##### 5.3.3.2.2.1 TNS detection {#tns-detection .H6}

The spectral coefficients
![](media/image267.wmf){width="0.4673611111111111in"
height="0.21597222222222223in"}between the start and stop frequency are
divided into ![](media/image268.wmf){width="0.4618055555555556in"
height="0.20972222222222223in"} equal consecutive portions and for each
portion the normalized autocorrelation function is calculated. The
values of the autocorrelation function of all portions are then summed
up and lag windowed. An exception is the first filter for 48/96/128 kbps
SWB from 600 Hz to 4500 Hz which has only one portion
(![](media/image269.wmf){width="0.2513888888888889in"
height="0.20972222222222223in"} = 1).

The next step is an LPC calculation using the Levinson-Durbin algorithm
(defined in the subclause 5.1.9.4). The filter oder
![](media/image270.wmf){width="0.2604166666666667in"
height="0.20972222222222223in"} is limited to 8 and to quarter of the
number of the bins that a TNS filter covers.. As a result so called
PARCOR or reflection coefficients
![](media/image271.wmf){width="0.6548611111111111in"
height="0.20833333333333334in"} (where
![](media/image272.wmf){width="0.16458333333333333in"
height="0.20972222222222223in"}is defined in subclause 5.1.9.4 and
![](media/image273.wmf){width="0.9756944444444444in"
height="0.20833333333333334in"}) and the prediction gain
![](media/image274.wmf){width="1.1125in" height="0.20972222222222223in"}
are available, where
![](media/image275.wmf){width="0.4527777777777778in"
height="0.20972222222222223in"} is the residual error energy as defined
in subclause 5.1.9.4.

The TNS parcor coefficients will be quantized with a resolution of 4
bits.

The filter order is reduced such that the last PARCOR coefficient is
non-zero.

TNS filter will be used only if the prediction gain is greater than a
given threshold, which is dependent on the filter and varies between
1.35 and 1.85, or if the average of the squared filter coefficients is
greater than a given threshold, which is dependent on the filter and
varies between 0.03 and 0.075. For configurations with 2 filters per
spectrum, each filter can be independently disabled or enabled.

##### 5.3.3.2.2.2 TNS filtering {#tns-filtering .H6}

The spectral coefficients
![](media/image276.wmf){width="0.4673611111111111in"
height="0.21597222222222223in"}will be replaced by the spectral
coefficients filtered with the TNS filter. In the following text
![](media/image277.wmf){width="0.4673611111111111in"
height="0.21597222222222223in"} refers to the TNS filtered or to the
non-filtered spectral coefficients, depending on the configuration,
where the configurations where TNS filtered spectral coefficients are
used are listed in table 86. The filtering is done with the help of a so
called lattice filter, no conversion from parcor coefficients
![](media/image278.wmf){width="0.20069444444444445in"
height="0.16458333333333333in"}to linear prediction coefficients is
required.

##### 5.3.3.2.2.3 Coding of the TNS parameters {#coding-of-the-tns-parameters .H6}

The TNS filter order and the quantized parcor coefficients are coded
using Huffman code. Which Huffman code will be used for the filter order
depends on the frame configuration (TCX20/TCX10/TCX5) and on the
bandwidth (SWB,WB). Which Huffman code will be used for a parcor
coefficient depends on the frame configuration (TCX20/TCX10/TCX5), on
the bandwidth (SWB,WB) and on the parcor coefficent's index.

##### 5.3.3.2.3 LPC shaping in MDCT domain

##### 5.3.3.2.3.1 General Principle {#general-principle-1 .H6}

LPC shaping is performed in the MDCT domain by applying gain factors
computed from weighted quantized LP filter coefficients to the MDCT
spectrum. The input sampling rate
![](media/image279.wmf){width="0.30277777777777776in"
height="0.23333333333333334in"}, on which the MDCT transform is based,
can be higher than the CELP sampling rate
![](media/image280.wmf){width="0.34791666666666665in"
height="0.2513888888888889in"}, for which LP coefficients are computed.
Therefore LPC shaping gains can only be computed for the part of the
MDCT spectrum corresponding to the CELP frequency range. For the
remaining part of the spectrum (if any) the shaping gain of the highest
frequency band is used.

##### 5.3.3.2.3.2 Computation of LPC shaping gains {#computation-of-lpc-shaping-gains .H6}

To compute the 64 LPC shaping gains the weighted LP filter coefficients
![](media/image281.wmf){width="0.14652777777777778in"
height="0.20069444444444445in"} are first transformed into the frequency
domain using an oddly stacked DFT of length 128:

![](media/image282.wmf){width="1.8173611111111112in"
height="0.5486111111111112in"} (921)

The LPC shaping gains
![](media/image283.wmf){width="0.3659722222222222in"
height="0.20972222222222223in"} are then computed as the reciprocal
absolute values of ![](media/image284.wmf){width="0.38333333333333336in"
height="0.20972222222222223in"}:

![](media/image285.wmf){width="2.0097222222222224in" height="0.44375in"}
(922)

##### 5.3.3.2.3.3 Applying LPC shaping gains to MDCT spectrum {#applying-lpc-shaping-gains-to-mdct-spectrum .H6}

The MDCT coefficients
![](media/image286.wmf){width="0.26944444444444443in"
height="0.20972222222222223in"} corresponding to the CELP frequency
range are grouped into 64 sub-bands. The coefficients of each sub-band
are multiplied by the reciprocal of the corresponding LPC shaping gain
to obtain the shaped spectrum
![](media/image287.wmf){width="0.26944444444444443in"
height="0.23333333333333334in"}. If the number of MDCT bins
corresponding to the CELP frequency range
![](media/image288.wmf){width="0.38333333333333336in"
height="0.2604166666666667in"} is not a multiple of 64, the width of
sub-bands varies by one bin as defined by the following pseudo-code:

![](media/image289.wmf){width="0.9118055555555555in"
height="0.2604166666666667in"},
![](media/image290.wmf){width="0.9569444444444445in"
height="0.2604166666666667in"}

if ![](media/image291.wmf){width="0.3298611111111111in"
height="0.16458333333333333in"} then

![](media/image292.wmf){width="0.30277777777777776in"
height="0.16458333333333333in"},
![](media/image293.wmf){width="0.7465277777777778in"
height="0.20972222222222223in"}

else if ![](media/image294.wmf){width="0.38958333333333334in"
height="0.16458333333333333in"} then

![](media/image295.wmf){width="0.6083333333333333in"
height="0.20972222222222223in"},
![](media/image296.wmf){width="0.43472222222222223in"
height="0.20972222222222223in"},
![](media/image297.wmf){width="0.6263888888888889in"
height="0.20972222222222223in"}

else

![](media/image298.wmf){width="0.9479166666666666in"
height="0.20972222222222223in"}, ![](media/image299.wmf){width="0.6in"
height="0.20972222222222223in"},
![](media/image300.wmf){width="0.4618055555555556in"
height="0.20972222222222223in"}

![](media/image301.wmf){width="0.30277777777777776in"
height="0.16458333333333333in"}

for ![](media/image302.wmf){width="0.6777777777777778in"
height="0.19166666666666668in"}

{

if ![](media/image303.wmf){width="0.66875in"
height="0.19166666666666668in"} then

![](media/image304.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"}

else

![](media/image305.wmf){width="0.43472222222222223in"
height="0.20972222222222223in"}

for ![](media/image306.wmf){width="1.5833333333333333in"
height="0.2604166666666667in"}

{

![](media/image307.wmf){width="1.4604166666666667in"
height="0.23333333333333334in"}

![](media/image308.wmf){width="0.44375in"
height="0.16458333333333333in"}

}

}

The remaining MDCT coefficients above the CELP frequency range (if any)
are multiplied by the reciprocal of the last LPC shaping gain:

![](media/image309.wmf){width="2.513888888888889in"
height="0.4166666666666667in"} (923)

For the configurations 9.6 kbit/s and 13.2 kbit/s SWB, the remaining
spectral coefficients above the CELP frequency range are postprocessed:

First, the highest amplitudes of the MDCT spectrum
![](media/image310.wmf){width="0.4722222222222222in"
height="0.2361111111111111in"}below and above
![](media/image311.wmf){width="0.3888888888888889in"
height="0.2638888888888889in"}are determined. The search procedure
returns the following values:\
a) max\_low\_pre: The maximum MDCT coefficient below
![](media/image312.wmf){width="0.3888888888888889in"
height="0.2638888888888889in"}, evaluated on the spectrum of absolute
values before the application of reciprocal LPC shaping gains\
b) max\_high\_pre: The maximum MDCT coefficient above
![](media/image312.wmf){width="0.3888888888888889in"
height="0.2638888888888889in"}, evaluated on the spectrum of absolute
values before the application of reciprocal LPC shaping gains

max\_low\_pre = 0;\
for(i=0; i\<![](media/image312.wmf){width="0.3888888888888889in"
height="0.2638888888888889in"}; i++)\
{\
tmp = fabs(![](media/image313.wmf){width="0.4722222222222222in"
height="0.2361111111111111in"});\
if(tmp \> max\_low\_pre)\
{\
max\_low\_pre = tmp;\
}\
}\
\
max\_high\_pre = 0;\
for(i=0; i\<![](media/image314.wmf){width="0.8611111111111112in"
height="0.2638888888888889in"}; i++)\
{\
tmp = fabs(![](media/image315.wmf){width="0.2916666666666667in"
height="0.2361111111111111in"}
(![](media/image316.wmf){width="0.3888888888888889in"
height="0.2638888888888889in"} + i));\
if(tmp \> max\_high\_pre)\
{\
max\_high\_pre = tmp;\
}\
}

Second, a peak-distance metric analyzes the impact of spectral peaks
above above ![](media/image317.wmf){width="0.375in"
height="0.2638888888888889in"} on the arithmetic coder. Thus, the
maximum amplitude of the MDCT spectrum below and above
![](media/image318.wmf){width="0.375in" height="0.2638888888888889in"}
are searched on the MDCT spectrum after the application of reciprocal
LPC shaping gains, i.e. in the domain where also the arithmetic coder is
applied. In addition to the maximum amplitude, also the distance from
![](media/image318.wmf){width="0.375in" height="0.2638888888888889in"}
is evaluated. The search procedure returns the following values:\
a) max\_low: The maximum MDCT coefficient below
![](media/image312.wmf){width="0.3888888888888889in"
height="0.2638888888888889in"}, evaluated on the spectrum of absolute
values after the application of reciprocal LPC shaping gains\
b) dist\_low: The distance of max\_low from
![](media/image318.wmf){width="0.375in" height="0.2638888888888889in"}\
c) max\_high: The maximum MDCT coefficient above
![](media/image312.wmf){width="0.3888888888888889in"
height="0.2638888888888889in"}, evaluated on the spectrum of absolute
values after the application of reciprocal LPC shaping gains\
d) dist\_high: The distance of max\_high from
![](media/image318.wmf){width="0.375in" height="0.2638888888888889in"}

max\_low = 0;\
dist\_low = 0;\
for(i=0; i\<![](media/image318.wmf){width="0.375in"
height="0.2638888888888889in"}; i++)\
{\
tmp = fabs( ![](media/image319.wmf){width="0.2916666666666667in"
height="0.2638888888888889in"}(![](media/image318.wmf){width="0.375in"
height="0.2638888888888889in"} -- 1 - i));\
if(tmp \> max\_low)\
{\
max\_low = tmp;\
dist\_low = i;\
}\
}\
\
max\_high = 0;\
dist\_high = 0;\
for(i=0; i\<![](media/image320.wmf){width="0.3333333333333333in"
height="0.2638888888888889in"} - ![](media/image318.wmf){width="0.375in"
height="0.2638888888888889in"}; i++)\
{\
tmp = fabs( ![](media/image321.wmf){width="0.2916666666666667in"
height="0.2638888888888889in"}(![](media/image318.wmf){width="0.375in"
height="0.2638888888888889in"} + i));\
if(tmp \> max\_high)\
{\
max\_high = tmp;\
dist\_high = i;\
}\
}

Third, the peak-amplitudes in psycho-acoustically similar spectral
regions are compared. Thus, the maximum amplitude of the MDCT spectrum
below and above ![](media/image318.wmf){width="0.375in"
height="0.2638888888888889in"} is searched on the MDCT spectrum after
the application of reciprocal LPC shaping gains. The maximum amplitude
of the MDCT spectrum below ![](media/image318.wmf){width="0.375in"
height="0.2638888888888889in"} is not searched for the full spectrum,
but only starting at
![](media/image322.wmf){width="0.7083333333333334in"
height="0.2638888888888889in"}. This is to discard the lowest
frequencies, which are psycho-acoustically most important and usually
have the highest amplitude after the application of reciprocal LPC
shaping gains, and to only compare components with a similar
psycho-acoustical importance. The search procedure returns the following
values:\
a) max\_low2: The maximum MDCT coefficient below
![](media/image318.wmf){width="0.375in" height="0.2638888888888889in"},
evaluated on the spectrum of absolute values after the application of
reciprocal LPC shaping gains starting from
![](media/image323.wmf){width="0.7083333333333334in"
height="0.2638888888888889in"}\
b) max\_high: The maximum MDCT coefficient above
![](media/image318.wmf){width="0.375in" height="0.2638888888888889in"},
evaluated on the spectrum of absolute values after the application of
reciprocal LPC shaping gains

max\_low2 = 0;\
for(i=![](media/image323.wmf){width="0.7083333333333334in"
height="0.2638888888888889in"};
i\<![](media/image318.wmf){width="0.375in"
height="0.2638888888888889in"}; i++)\
{\
tmp = fabs(![](media/image321.wmf){width="0.2916666666666667in"
height="0.2638888888888889in"} (i));\
if(tmp \> max\_low2)\
{\
max\_low2 = tmp;\
}\
}\
\
max\_high = 0;\
for(i=0; i\<![](media/image324.wmf){width="0.3333333333333333in"
height="0.2638888888888889in"} - ![](media/image318.wmf){width="0.375in"
height="0.2638888888888889in"}; i++)\
{\
tmp = fabs(![](media/image321.wmf){width="0.2916666666666667in"
height="0.2638888888888889in"} (![](media/image318.wmf){width="0.375in"
height="0.2638888888888889in"} + i));\
if(tmp \> max\_high)\
{\
max\_high = tmp;\
}\
}

Finally, the relation of max\_low, dist\_low, max\_high, dist\_high,
max\_low2, max\_high is evaluated and -- if applicaple -- a correction
factor for ![](media/image325.wmf){width="0.4722222222222222in"
height="0.2638888888888889in"}determined and applied:

if( (16.0 \* max\_low\_pre \> max\_high\_pre) &&\
(4.0 \* dist\_high \* max\_high \> dist\_low \* max\_low) &&\
(max\_high \> max\_fac \* max\_low2)\
)\
{\
fac = mac\_fac \* max\_low2 / max\_high;\
\
for(i = ![](media/image318.wmf){width="0.375in"
height="0.2638888888888889in"}; i\<
![](media/image326.wmf){width="0.3333333333333333in"
height="0.2638888888888889in"}; i++)\
{\
![](media/image321.wmf){width="0.2916666666666667in"
height="0.2638888888888889in"} (i) =
![](media/image321.wmf){width="0.2916666666666667in"
height="0.2638888888888889in"} (i) \* fac;\
}\
}

where max\_fac is set to 1.5 in case the Envelope based arithmetic coder
is used, or max\_fac is set to 3.0 for all other cases.

##### 5.3.3.2.4 Adaptive low frequency emphasis

##### 5.3.3.2.4.1 General Principle {#general-principle-2 .H6}

The purpose of the adaptive low-frequency emphasis and de-emphasis
(ALFE) processes is to improve the subjective performance of the
frequency-domain TCX codec at low frequencies. To this end, the
low-frequency MDCT spectral lines are amplified prior to quantization in
the encoder, thereby increasing their quantization SNR, and this
boosting is undone prior to the inverse MDCT process in the internal and
external decoders to prevent amplification artifacts.

There are two different ALFE algorithms which are selected consistently
in encoder and decoder based on the choice of arithmetic coding
algorithm and bit-rate. ALFE algorithm 1 is used at 9.6 kbps (envelope
based arithmetic coder) and at 48 kbps and above (context based
arithmetic coder). ALFE algorithm 2 is used from 13.2 up to incl. 32
kbps. In the encoder, the ALFE operates on the spectral lines in vector
x\[\] directly before (algorithm 1) or after (algorithm 2) every MDCT
quantization, which runs multiple times inside a rate-loop in case of
the context based arithmetic coder (see subclause 5.3.3.2.8.1).

##### 5.3.3.2.4.2 Adaptive emphasis algorithm 1 {#adaptive-emphasis-algorithm-1 .H6}

ALFE algorithm 1 operates based on the LPC frequency-band gains,
lpcGains\[\]. First, the minimum and maximum of the first nine gains --
the low-frequency (LF) gains -- are found using comparison operations
executed within a loop over the gain indices 0 to 8.

Then, if the ratio between the minimum and maximum exceeds a threshold
of 1/32, a gradual boosting of the lowest lines in x is performed such
that the first line (DC) is amplified by (32 min/max)^0.25^ and the
33^rd^ line is not amplified:

tmp = 32 \* min

if ((max \< tmp) && (max \> 0))

{

fac = tmp = pow(tmp / max, 1/128)

for (i = 31; i \>= 0; i\--)

{ /\* gradual boosting of lowest 32 lines \*/

x\[i\] \*= fac

fac \*= tmp

}

}

##### 5.3.3.2.4.3 Adaptive emphasis algorithm 2 {#adaptive-emphasis-algorithm-2 .H6}

ALFE algorithm 2, unlike algorithm 1, does not operate based on
transmitted LPC gains but is signaled by means of modifications to the
quantized low-frequency (LF) MDCT lines. The procedure is divided into
five consecutive steps:

-   Step 1: first find first magnitude maximum at index i\_max in lower
    spectral quarter (*k* = 0 ...
    ![](media/image327.wmf){width="0.34791666666666665in"
    height="0.2604166666666667in"}/ 4) utilizing invGain = 2/*g~TCX~*
    and modifying the maximum: xq\[i\_max\] += (xq\[i\_max\] \< 0) ? -2
    : 2

-   Step 2: then compress value range of all x\[i\] up to i\_max by
    requantizing all lines at *k* = 0 ... i\_max--1 as in the subclause
    describing the quantization, but utilizing invGain instead of
    *g~TCX~* as the global gain factor.

-   Step 3: find first magnitude maximum below i\_max (*k* = 0
    ...![](media/image197.wmf){width="0.34791666666666665in"
    height="0.2604166666666667in"}/ 4) which is half as high if
    i\_max \> --1 using invGain = 4/*g~TCX~* and modifying the maximum:
    xq\[i\_max\] += (xq\[i\_max\] \< 0) ? -2 : 2

-   Step 4: re-compress and quantize all x\[i\] up to the half-height
    i\_max found in the previous step, as in step 2

-   Step 5: finish and always compress two lines at the latest i\_max
    found, i.e. at *k* = i\_max+1, i\_max+2, again utilizing invGain =
    2/*g~TCX~* if the initial i\_max found in step 1 is greater than
    --1, or using invGain = 4/*g~TCX~* otherwise. All i\_max are
    initialized to --1. For details please see AdaptLowFreqEmph() in
    tcx\_utils\_enc.c.

##### 5.3.3.2.5 Spectrum noise measure in power spectrum

For guidance of quantization in the TXC encoding process, a noise
measure between 0 (tonal) and 1 (noise-like) is determined for each MDCT
spectral line above a specified frequency based on the current
transform's power spectrum. The power spectrum
![](media/image328.wmf){width="0.44375in"
height="0.20972222222222223in"} is computed from the MDCT
coefficients![](media/image329.wmf){width="0.4673611111111111in"
height="0.20972222222222223in"} and the
MDST![](media/image330.wmf){width="0.44375in"
height="0.20972222222222223in"}coefficients on the same time-domain
signal segment and with the same windowing operation:

![](media/image331.wmf){width="2.678472222222222in"
height="0.2604166666666667in"} (924)

Each noise measure in
![](media/image332.wmf){width="0.8333333333333334in"
height="0.20972222222222223in"} is then calculated as follows. First, if
the transform length changed (e.g. after a TCX transition transform
following an ACELP frame) or if the previous frame did not use TCX20
coding (e.g. in case a shorter transform length was used in the last
frame), all ![](media/image332.wmf){width="0.8333333333333334in"
height="0.20972222222222223in"} up to
![](media/image333.wmf){width="0.5305555555555556in"
height="0.2604166666666667in"} are reset to zero. The noise measure
start line ![](media/image334.wmf){width="0.3388888888888889in"
height="0.20972222222222223in"}is initialized according to the following
table 87.

Table 87: Initialization table of
![](media/image335.wmf){width="0.3388888888888889in"
height="0.20972222222222223in"}in noise measure

  ---------------- ----- ------ ------ ------ ----- ----- ----- -----
  Bitrate (kbps)   9.6   13.2   16.4   24.4   32    48    96    128
  bw= NB, WB       66    128    200    320    320   320   320   320
  bw=SWB,FB        44    96     160    320    320   256   640   640
  ---------------- ----- ------ ------ ------ ----- ----- ----- -----

For ACELP to TCX transitions,
![](media/image334.wmf){width="0.3388888888888889in"
height="0.20972222222222223in"}is scaled by 1.25. Then, if the noise
measure start line ![](media/image335.wmf){width="0.3388888888888889in"
height="0.20972222222222223in"}is less than
![](media/image336.wmf){width="0.5548611111111111in"
height="0.2604166666666667in"}, the
![](media/image332.wmf){width="0.8333333333333334in"
height="0.20972222222222223in"} at and above
![](media/image335.wmf){width="0.3388888888888889in"
height="0.20972222222222223in"} are derived recursively from running
sums of power spectral lines:

![](media/image337.wmf){width="2.198611111111111in" height="0.5125in"}
(925)

![](media/image338.wmf){width="4.8in" height="0.44375in"} (926)

Furthermore, every time
![](media/image332.wmf){width="0.8333333333333334in"
height="0.20972222222222223in"}is given the value zero in the above
loop, the variable *lastTone* is set to *k*. The upper 7 lines are
treated separately since ![](media/image339.wmf){width="0.2875in"
height="0.20972222222222223in"} cannot be updated any more
(![](media/image340.wmf){width="0.2875in"
height="0.20972222222222223in"}, however, is computed as above):

![](media/image341.wmf){width="5.435416666666667in" height="0.5125in"}
(927)

The uppermost line at
![](media/image342.wmf){width="0.7555555555555555in"
height="0.2604166666666667in"}is defined as being noise-like, hence
![](media/image343.wmf){width="1.425in" height="0.2604166666666667in"} .
Finally, if the above variable *lastTone* (which was initialized to
zero) is greater than zero, then
![](media/image344.wmf){width="1.6256944444444446in"
height="0.20972222222222223in"}. Note that this procedure is only
carried out in TCX20, not in other TCX modes
(![](media/image345.wmf){width="2.138888888888889in"
height="0.2604166666666667in"}).

##### 5.3.3.2.6 Low pass factor detector

A low pass factor ![](media/image346.wmf){width="0.26944444444444443in"
height="0.23333333333333334in"}is determined based on the power spectrum
for all bitrates below 32.0 kbps. Therefore, the power spectrum
![](media/image328.wmf){width="0.44375in"
height="0.20972222222222223in"} is compared iteratively against a
threshold ![](media/image347.wmf){width="0.23333333333333334in"
height="0.23333333333333334in"}for all
![](media/image348.wmf){width="1.3736111111111111in"
height="0.2604166666666667in"}, where
![](media/image349.wmf){width="0.6263888888888889in"
height="0.23333333333333334in"}for regular MDCT windows and
![](media/image350.wmf){width="0.6263888888888889in"
height="0.23333333333333334in"}for ACELP to MDCT transition windows. The
iteration stops as soon
as![](media/image351.wmf){width="0.7229166666666667in"
height="0.23333333333333334in"}.

The low pass factor
![](media/image352.wmf){width="0.26944444444444443in"
height="0.2513888888888889in"}determines as
![](media/image353.wmf){width="2.216666666666667in"
height="0.27847222222222223in"}, where
![](media/image354.wmf){width="0.5125in"
height="0.23333333333333334in"}is the last determined low pass factor.
At encoder startup, ![](media/image355.wmf){width="0.5125in"
height="0.23333333333333334in"}is set to 1.0. The low pass factor
![](media/image356.wmf){width="0.26944444444444443in"
height="0.23333333333333334in"}is used to determine the noise filling
stop bin (see subclause 5.3.3.2.10.2).

##### 5.3.3.2.7 Uniform quantizer with adaptive dead-zone

For uniform quantization of the MDCT spectrum
![](media/image357.wmf){width="0.27847222222222223in"
height="0.2423611111111111in"}after or before ALFE (depending on the
applied emphasis algorithm, see subclause 5.3.3.2.4.1), the coefficients
are first divided by the global gain
![](media/image358.wmf){width="0.34791666666666665in"
height="0.20972222222222223in"}(see subclause 5.3.3.2.8.1.1), which
controls the step-size of quantization. The results are then rounded
toward zero with a rounding offset which is adapted for each coefficient
based on the coefficient's magnitude (relative to
![](media/image359.wmf){width="0.34791666666666665in"
height="0.20972222222222223in"}) and tonality (as defined by
![](media/image360.wmf){width="0.8006944444444445in"
height="0.20972222222222223in"} in subclause 5.3.3.2.5). For
high-frequency spectral lines with low tonality and magnitude, a
rounding offset of zero is used, whereas for all other spectral lines,
an offset of 0.375 is employed. More specifically, the following
algorithm is executed.

Starting from the highest coded MDCT coefficient at index
![](media/image361.wmf){width="0.7555555555555555in"
height="0.2604166666666667in"}, we set
![](media/image362.wmf){width="0.6597222222222222in"
height="0.2423611111111111in"} and decrement
![](media/image363.wmf){width="0.13194444444444445in"
height="0.18263888888888888in"} by 1 as long as condition
![](media/image364.wmf){width="1.0618055555555554in"
height="0.21597222222222223in"} and
![](media/image365.wmf){width="1.0763888888888888in" height="0.2875in"}
evaluates to true. Then downward from the first line at index
![](media/image366.wmf){width="0.34791666666666665in"
height="0.1736111111111111in"} where this condition is not met (which is
guaranteed since ![](media/image367.wmf){width="1.0527777777777778in"
height="0.21597222222222223in"}), rounding toward zero with a rounding
offset of 0.375 and limiting of the resulting integer values to the
range --32768 to 32767 is performed:

![](media/image368.wmf){width="3.3895833333333334in"
height="0.9895833333333334in"} (928)

with ![](media/image369.wmf){width="0.5034722222222222in"
height="0.1736111111111111in"}. Finally, all quantized coefficients of
![](media/image370.wmf){width="0.4527777777777778in"
height="0.2423611111111111in"} at and above
![](media/image371.wmf){width="0.5638888888888889in"
height="0.2604166666666667in"} are set to zero.

##### 5.3.3.2.8 Arithmetic coder

The quantized spectral coefficients are noiselessly coded by an entropy
coding and more particularly by an arithmetic coding.

The arithmetic coding uses 14 bits precision probabilities for computing
its code. The alphabet probability distribution can be derived in
different ways. At low rates, it is derived from the LPC envelope, while
at high rates it is derived from the past context. In both cases, a
harmonic model can be added for refining the probability model.

The following pseudo-code describes the arithmetic encoding routine,
which is used for coding any symbol associated with a probability model.
The probability model is represented by a cumulative frequency table
*cum\_freq\[\].* The derivation of the probability model is described in
the following subclauses.

/\* global varibles \*/

low

high

bits\_to\_follow

ar\_encode(symbol, cum\_freq\[\])

{

if (ari\_first\_symbol()) {

low = 0;

high = 65535;

bits\_to\_follow = 0;

}

range = high-low+1;

if (symbol \> 0) {

high = low + ((range\*cum\_freq\[symbol-1\])\>\>14) - 1;

}

low += ((range\*cum\_freq\[symbol-1\])\>\>14) - 1;

for (;;) {

if (high \< 32768 ) {

write\_bit(0);

while ( bits\_to\_follow ) {

write\_bit(1);

bits\_to\_follow\--;

}

}

else if (low \>= 32768 ) {

write\_bit(1)

while ( bits\_to\_follow ) {

write\_bit(0);

bits\_to\_follow\--;

}

low -= 32768;

high -= 32768;

}

else if ( (low \>= 16384) && (high \< 49152) ) {

bits\_to\_follow += 1;

low -= 16384;

high -= 16384;

}

else break;

low += low;

high += high+1;

}

if (ari\_last\_symbol()) /\* flush bits \*/

if ( low \< 16384 ) {

write\_bit(0);

while ( bits\_to\_follow \> 0) {

write\_bit(1);

bits\_to\_follow\--;

}

} else {

write\_bit(1);

while ( bits\_to\_follow \> 0) {

write\_bit(0);

bits\_to\_follow\--;

}

}

}

}

The helper functions *ari\_first\_symbol()* and *ari\_last\_symbol()*
detect the first symbol and the last symbol of the generated codeword
respectively.

##### 5.3.3.2.8.1 Context based arithmetic codec {#context-based-arithmetic-codec .H6}

##### 5.3.3.2.8.1.1 Global gain estimator {#global-gain-estimator .H6}

The estimation of the global gain
![](media/image372.wmf){width="0.2875in" height="0.20972222222222223in"}
for the TCX frame is performed in two iterative steps. The first
estimate considers a SNR gain of 6dB per sample per bit from SQ. The
second estimate refines the estimate by taking into account the entropy
coding.

The energy of each block of 4 coefficients is first computed:

![](media/image373.wmf){width="1.2777777777777777in" height="0.5125in"}
(929)

A bisection search is performed with a final resolution of 0.125dB:

**Initialization:** Set *fac* = *offset = 12.8* and *target =
0.15(target\_bits -- L/16)*

**Iteration:** Do the following block of operations *10* times

1- *fac=fac/2*

2- *offset = offset -- fac*

2- ![](media/image374.wmf){width="3.5305555555555554in"
height="0.5125in"}

3- *if(ener\>target) then offset=offset+fac*

The first estimate of gain is then given by:

![](media/image375.wmf){width="1.2777777777777777in"
height="0.2513888888888889in"} (930)

##### 5.3.3.2.8.1.2 Rate-loop for constant bit rate and global gain {#rate-loop-for-constant-bit-rate-and-global-gain .H6}

In order to set the best gain
![](media/image376.wmf){width="0.34791666666666665in"
height="0.21597222222222223in"}within the constraints of
![](media/image377.wmf){width="1.4423611111111112in"
height="0.20069444444444445in"}, convergence process of
![](media/image378.wmf){width="0.34791666666666665in"
height="0.21597222222222223in"}and
![](media/image379.wmf){width="0.6354166666666666in"
height="0.21597222222222223in"}is carried out by using following
valuables and constants:

> ![](media/image380.wmf){width="0.27847222222222223in"
> height="0.20972222222222223in"} and
> ![](media/image381.wmf){width="0.27847222222222223in"
> height="0.20972222222222223in"} denote weights corresponding to the
> lower bound the upper bound,
>
> ![](media/image382.wmf){width="0.26944444444444443in"
> height="0.21597222222222223in"}and
> ![](media/image383.wmf){width="0.26944444444444443in"
> height="0.21597222222222223in"}denote gain corresponding to the lower
> bound the upper bound, and
>
> ![](media/image384.wmf){width="0.6958333333333333in"
> height="0.21597222222222223in"} and
> ![](media/image385.wmf){width="0.7048611111111112in"
> height="0.21597222222222223in"}denote flags indicating
> ![](media/image386.wmf){width="0.26944444444444443in"
> height="0.21597222222222223in"}and
> ![](media/image387.wmf){width="0.26944444444444443in"
> height="0.21597222222222223in"}is found, respectively.
>
> ![](media/image388.wmf){width="0.15555555555555556in"
> height="0.16458333333333333in"} and
> ![](media/image389.wmf){width="0.13194444444444445in"
> height="0.16458333333333333in"} are variables with
> ![](media/image390.wmf){width="2.1569444444444446in"
> height="0.21597222222222223in"} and
> ![](media/image391.wmf){width="0.5034722222222222in"
> height="0.21597222222222223in"}.
>
> ![](media/image392.wmf){width="0.1375in"
> height="0.1736111111111111in"} and
> ![](media/image393.wmf){width="0.12291666666666666in"
> height="0.1375in"}are constants, set as 10 and 0.96.

After the initial estimate of bit consumption by arithmetic coding,
![](media/image394.wmf){width="0.2965277777777778in"
height="0.18263888888888888in"} is set 0 when
![](media/image395.wmf){width="0.7229166666666667in"
height="0.21597222222222223in"}is larger
than![](media/image396.wmf){width="0.6506944444444445in"
height="0.21597222222222223in"}, while
![](media/image397.wmf){width="0.2965277777777778in"
height="0.18263888888888888in"}is set as
![](media/image398.wmf){width="0.6354166666666666in"
height="0.21597222222222223in"} when
![](media/image399.wmf){width="0.6354166666666666in"
height="0.21597222222222223in"} is larger than
![](media/image400.wmf){width="0.7375in"
height="0.21597222222222223in"}.

If ![](media/image401.wmf){width="0.2965277777777778in"
height="0.18263888888888888in"} is larger than 0, that means
![](media/image402.wmf){width="0.6354166666666666in"
height="0.21597222222222223in"}is larger than
![](media/image403.wmf){width="0.7229166666666667in"
height="0.20069444444444445in"},

> ![](media/image404.wmf){width="0.3659722222222222in"
> height="0.21597222222222223in"}needs to be modified to be larger than
> the previous one and
> ![](media/image405.wmf){width="0.6958333333333333in"
> height="0.20069444444444445in"}is set as TRUE,
> ![](media/image406.wmf){width="0.26944444444444443in"
> height="0.21597222222222223in"} is set as the
> previous![](media/image407.wmf){width="0.3659722222222222in"
> height="0.21597222222222223in"}.
> ![](media/image408.wmf){width="0.27847222222222223in"
> height="0.20972222222222223in"} is set as
>
> ![](media/image409.wmf){width="1.6854166666666666in"
> height="0.20972222222222223in"}, (931)
>
> When ![](media/image410.wmf){width="0.7048611111111112in"
> height="0.21597222222222223in"}was set, that means
> ![](media/image411.wmf){width="0.6354166666666666in"
> height="0.21597222222222223in"}was smaller than
> ![](media/image412.wmf){width="0.7229166666666667in"
> height="0.21597222222222223in"},
> ![](media/image413.wmf){width="0.3659722222222222in"
> height="0.21597222222222223in"}is updated as an interpolated value
> between upper bound and lower bound. ,
>
> ![](media/image414.wmf){width="2.6006944444444446in"
> height="0.20972222222222223in"}, (932)

Otherwise, that means
![](media/image415.wmf){width="0.7138888888888889in"
height="0.20069444444444445in"}is FALSE, gain is amplified as

> ![](media/image416.wmf){width="2.84375in"
> height="0.21597222222222223in"}, (933)
>
> with larger amplification ratio when the ratio of
> ![](media/image417.wmf){width="0.6173611111111111in"
> height="0.21597222222222223in"}(=![](media/image418.wmf){width="0.3298611111111111in"
> height="0.20972222222222223in"} and
> ![](media/image419.wmf){width="0.7229166666666667in"
> height="0.21597222222222223in"} is larger to accelerate to attain
> ![](media/image420.wmf){width="0.26944444444444443in"
> height="0.21597222222222223in"}.

If ![](media/image421.wmf){width="0.2965277777777778in"
height="0.18263888888888888in"} equals to 0, that means
![](media/image422.wmf){width="0.6354166666666666in"
height="0.20972222222222223in"}is smaller
than![](media/image423.wmf){width="0.7229166666666667in"
height="0.21597222222222223in"},

> ![](media/image424.wmf){width="0.34791666666666665in"
> height="0.21597222222222223in"} should be smaller than the previous
> one and ![](media/image425.wmf){width="0.7048611111111112in"
> height="0.21597222222222223in"}is set as 1,
> ![](media/image426.wmf){width="0.20972222222222223in"
> height="0.18263888888888888in"} is set as the previous
> ![](media/image427.wmf){width="0.3659722222222222in"
> height="0.21597222222222223in"}and
> ![](media/image428.wmf){width="0.27847222222222223in"
> height="0.20972222222222223in"} is set as
>
> ![](media/image429.wmf){width="2.033333333333333in"
> height="0.20972222222222223in"}, (934)
>
> If ![](media/image430.wmf){width="0.6958333333333333in"
> height="0.21597222222222223in"}has been already set, gain is
> calculated as
>
> ![](media/image431.wmf){width="2.6006944444444446in"
> height="0.20972222222222223in"}, (935)

otherwise, in order to accelerate to lower band gain
![](media/image432.wmf){width="0.2604166666666667in"
height="0.20972222222222223in"}, gain is reduced as,

> ![](media/image433.wmf){width="3.1375in"
> height="0.20972222222222223in"}, (936)
>
> with larger reduction rates of gain when the ratio of
> ![](media/image434.wmf){width="0.7375in"
> height="0.21597222222222223in"} and
> ![](media/image435.wmf){width="0.7229166666666667in"
> height="0.21597222222222223in"} is small.

After above correction of gain, quantization is performed and estimation
of ![](media/image436.wmf){width="0.6354166666666666in"
height="0.20972222222222223in"} by arithmetic coding is obtained. As a
result, ![](media/image437.wmf){width="0.2965277777777778in"
height="0.18263888888888888in"} is set 0 when
![](media/image438.wmf){width="0.7375in"
height="0.21597222222222223in"}is larger
than![](media/image439.wmf){width="0.6506944444444445in"
height="0.20972222222222223in"}, and is set as
![](media/image440.wmf){width="0.6506944444444445in"
height="0.20972222222222223in"} when it is larger than
![](media/image441.wmf){width="0.7375in"
height="0.21597222222222223in"}. If the loop count is less than 4,
either lower bound setting process or upper bound setting process is
carried out at the next loop depending on the value
![](media/image442.wmf){width="0.2965277777777778in"
height="0.18263888888888888in"}. If the loop count is 4, the final gain
![](media/image443.wmf){width="0.3659722222222222in"
height="0.21597222222222223in"}and the quantized MDCT
sequence![](media/image444.wmf){width="0.7555555555555555in"
height="0.2423611111111111in"} are obtained.

##### 5.3.3.2.8.1.3 Probability model derivation and coding {#probability-model-derivation-and-coding .H6}

The quantized spectral coefficients X are noiselessly encoded starting
from the lowest-frequency coefficient and progressing to the
highest-frequency coefficient. They are encoded by groups of two
coefficients a and b gathering in a so-called 2-tuple {a,b}.

Each 2-tuple {a,b} is split into three parts namely, MSB, LSB and the
sign. The sign is coded independently from the magnitude using uniform
probability distribution. The magnitude itself is further divided in two
parts, the two most significant bits (MSBs) and the remaining least
significant bitplanes (LSBs, if applicable). The 2-tuples for which the
magnitude of the two spectral coefficients is lower or equal to 3 are
coded directly by the MSB coding. Otherwise, an escape symbol is
transmitted first for signalling any additional bit plane.

The relation between 2-tuple, the individual spectral values *a* and *b*
of a 2-tuple, the most significant bit planes *m* and the remaining
least significant bit planes, *r,* are illustrated in the example in
figure 63. In this example three escape symbols are sent prior to the
actual value m, indicating three transmitted least significant bit
planes

![](media/image445.wmf){width="2.8777777777777778in"
height="2.033333333333333in"}
![](media/image446.wmf){width="2.451388888888889in"
height="1.8173611111111112in"}

Figure 63: Example of a coded pair (2-tuple) of spectral values *a* and
*b*\
and their representation as *m* and *r*.

The probability model is derived from the past context. The past context
is translated on a 12 bits-wise index and maps with the lookup table
*ari\_context\_lookup \[\]* to one of the 64 available probability
models stored in *ari\_cf\_m\[\]*.

The past context is derived from two 2-tuples already coded within the
same frame. The context can be derived from the direct neighbourhood or
located further in the past frequencies. Separate contexts are
maintained for the peak regions (coefficients belonging to the harmonic
peaks) and other (non-peak) regions according to the harmonic model. If
no harmonic model is used, only the other (non-peak) region context is
used.

The zeroed spectral values lying in the tail of spectrum are not
transmitted. It is achieved by transmitting the index of last non-zeroed
2-tuple. If harmonic model is used, the tail of the spectrum is defined
as the tail of spectrum consisting of the peak region coefficients,
followed by the other (non-peak) region coefficients, as this definition
tends to increase the number of trailing zeros and thus improves coding
efficiency. The number of samples to encode is computed as follows:

![](media/image447.wmf){width="3.095833333333333in"
height="0.2965277777777778in"} (937)

The following data are written into the bitstream with the following
order:

1.  *lastnz/2-1* is coded on
    ![](media/image448.wmf){width="0.6354166666666666in"
    height="0.43472222222222223in"} bits.

2.  The entropy-coded MSBs along with escape symbols.

3.  The signs with 1 bit-wise code-words

4.  The residual quantization bits described in section when the bit
    budget is not fully used.

5.  The LSBs are written backwardly from the end of the bitstream
    buffer.

The following pseudo-code describes how the context is derived and how
the bitstream data for the MSBs, signs and LSBs are computed. The input
arguments are the quantized spectral coefficients *X\[\]*, the size of
the considered spectrum *L*, the bit budget *target\_bits*, the harmonic
model parameters (*pi, hi)*, and the index of the last non zeroed symbol
*lastnz*.

ari\_context\_encode(X\[\], L,target\_bits,pi\[\],hi\[\],lastnz)

{

c\[0\]=c\[1\]=p1=p2=0;

for (k=0; k\<lastnz; k+=2) {

ari\_copy\_states();

(a1\_i,p1,idx1) = get\_next\_coeff(pi,hi,lastnz);

(b1\_i,p2,idx2) = get\_next\_coeff(pi,hi,lastnz);

t=get\_context(idx1,idx2,c,p1,p2);

esc\_nb = lev1 = 0;

a = a1 = abs(X\[a1\_i\]);

b = b1 = abs(X\[b1\_i\]);

/\* sign encoding\*/

if(a1\>0) save\_bit(X\[a1\_i\]\>0?0:1);

if(b1\>0) save\_bit(X\[b1\_i\]\>0?0:1);

/\* MSB encoding \*/

while (a1 \> 3 \|\| b1 \> 3) {

pki = ari\_context\_lookup\[t+1024\*esc\_nb\];

/\* write escape codeword \*/

ari\_encode(17, ari\_cf\_m\[pki\]);

a1\>\>=1; b1 \>\>=1; lev1++;

esc\_nb = min(lev1,3);

}

pki = ari\_context\_lookup\[t+1024\*esc\_nb\];

ari\_encode(a1+4\*b1, ari\_cf\_m\[pki\]);

/\* LSB encoding \*/

for(lev=0;lev\<lev1;lev++){

write\_bit\_end((a\>\>lev)&1);

write\_bit\_end((b\>\>lev)&1);

}

/\*check budget\*/

if(nbbits\>target\_bits){

ari\_restore\_states();

break;

}

c=update\_context(a,b,a1,b1,c,p1,p2);

}

write\_sign\_bits();

}

The helper functions *ari\_save\_states()* and *ari\_restore\_states()*
are used for saving and restoring the arithmetic coder states
respectively. It allows cancelling the encoding of the last symbols if
it violates the bit budget. Moreover and in case of bit budget overflow,
it is able to fill the remaining bits with zeros till reaching the end
of the bit budget or till processing *lastnz* samples in the spectrum.

The other helper functions are described in the following subclauses.

##### 5.3.3.2.8.1.4 Get next coefficient {#get-next-coefficient .H6}

(a,p,idx) = get\_next\_coeff(pi, hi, lastnz)

If ((ii\[0\] ≥ lastnz -- min(\#pi, lastnz)) or

(ii\[1\] \< min(\#pi, lastnz) and pi\[ii\[1\]\] \< hi\[ii\[0\]\])) then

{

p=1

idx=ii\[1\]

a=pi\[ii\[1\]\]

}

else

{

p=0

idx=ii\[0\] + \#pi

a=hi\[ii\[0\]\]

}

ii\[p\]=ii\[p\] + 1

The ii\[0\] and ii\[1\] counters are initialized to 0 at the beginning
of *ari\_context\_encode()* (and *ari\_context\_decode()* in the
decoder).

##### 5.3.3.2.8.1.5 Context update {#context-update .H6}

The context is updated as described by the following pseudo-code. It
consists of the concatenation of two 4 bit-wise context elements.

if (![](media/image449.wmf){width="0.5034722222222222in"
height="0.19166666666666668in"})

{

if (![](media/image450.wmf){width="0.975in"
height="0.20972222222222223in"})

{

![](media/image451.wmf){width="1.3916666666666666in"
height="0.20972222222222223in"}

If (![](media/image452.wmf){width="0.3659722222222222in"
height="0.16458333333333333in"})

![](media/image453.wmf){width="1.3319444444444444in"
height="0.20972222222222223in"}

![](media/image454.wmf){width="1.5118055555555556in"
height="0.2513888888888889in"}

}

if (![](media/image455.wmf){width="0.9986111111111111in"
height="0.20972222222222223in"})

{

![](media/image456.wmf){width="1.3319444444444444in"
height="0.20972222222222223in"}

if (![](media/image457.wmf){width="0.3659722222222222in"
height="0.16458333333333333in"})

![](media/image458.wmf){width="1.3319444444444444in"
height="0.20972222222222223in"}

![](media/image459.wmf){width="1.5298611111111111in"
height="0.2513888888888889in"}

}

}

else

{

![](media/image460.wmf){width="1.8868055555555556in"
height="0.20972222222222223in"}

if (![](media/image461.wmf){width="0.6506944444444445in"
height="0.20972222222222223in"})

![](media/image462.wmf){width="2.775in" height="0.20972222222222223in"}

else

![](media/image463.wmf){width="2.0965277777777778in"
height="0.19166666666666668in"}

}

##### 5.3.3.2.8.1.6 Get context {#get-context .H6}

The final context is amended in two ways:

![](media/image464.wmf){width="0.8097222222222222in"
height="0.19166666666666668in"}

if ![](media/image465.wmf){width="1.2506944444444446in"
height="0.20972222222222223in"}then

![](media/image466.wmf){width="0.6263888888888889in"
height="0.16458333333333333in"}

if ![](media/image467.wmf){width="0.9833333333333333in"
height="0.19166666666666668in"} then

![](media/image468.wmf){width="0.6083333333333333in"
height="0.16458333333333333in"}

The context *t* is an index from 0 to 1023.

##### 5.3.3.2.8.1.7 Bit consumption estimation {#bit-consumption-estimation .H6}

The bit consumption estimation of the context-based arithmetic coder is
needed for the rate-loop optimization of the quantization. The
estimation is done by computing the bit requirement without calling the
arithmetic coder. The generated bits can be accurately estimated by:

cum\_freq= arith\_cf\_m\[pki\]+m

proba\*= cum\_freq\[0\]- cum\_freq\[1\]

nlz=norm\_l(proba) /\*get the number of leading zero \*/

nbits=nlz

proba\>\>=14

where *proba* is an integer initialized to 16384 and *m* is a MSB
symbol.

##### 5.3.3.2.8.1.8 Harmonic model {#harmonic-model .H6}

For both context and envelope based arithmetic coding, a harmonic model
is used for more efficient coding of frames with harmonic content. The
model is disabled if any of the following conditions apply:

\- The bit-rate is not one of 9.6, 13.2, 16.4, 24.4, 32, 48 kbps.

\- The previous frame was coded by ACELP.

\- Envelope based arithmetic coding is used and the coder type is
neither Voiced nor Generic.

\- The single-bit harmonic model flag in the bit-stream in set to zero.

When the model is enabled, the frequency domain interval of harmonics is
a key parameter and is commonly analysed and encoded for both flavours
of arithmetic coders.

##### 5.3.3.2.8.1.8.1 Encoding of Interval of harmonics {#encoding-of-interval-of-harmonics .H6}

When pitch lag and gain are used for the post processing, the lag
parameter is utilized for representing the interval of harmonics in the
frequency domain. Otherwise, normal representation of interval is
applied.

##### 5.3.3.2.8.1.8.1.1 Encoding interval depending on time domain pitch lag {#encoding-interval-depending-on-time-domain-pitch-lag .H6}

If integer part of pitch lag in time domain
![](media/image469.wmf){width="0.26944444444444443in"
height="0.20972222222222223in"} is less than the frame size of MDCT
![](media/image470.wmf){width="0.31180555555555556in"
height="0.20972222222222223in"}, frequency domain interval unit (between
harmonic peaks corresponding to the pitch lag)
![](media/image471.wmf){width="0.38333333333333336in"
height="0.21597222222222223in"}with 7 bit fractional accuracy is given
by

![](media/image472.wmf){width="1.8958333333333333in"
height="0.4618055555555556in"} (938)

where ![](media/image473.wmf){width="0.225in"
height="0.23333333333333334in"} denotes the fractional part of pitch lag
in time domain,![](media/image474.wmf){width="0.5819444444444445in"
height="0.16458333333333333in"}denotes the max number of allowable
fractional values whose values are either 4 or 6 depending on the
conditions.

Since ![](media/image475.wmf){width="0.3298611111111111in"
height="0.2513888888888889in"} has limited range, the actual interval
between harmonic peaks in the frequency domain is coded relatively to
![](media/image476.wmf){width="0.3298611111111111in"
height="0.2513888888888889in"}using the bits specified in table 88.
Among candidate of multiplication factors,
![](media/image477.wmf){width="0.4618055555555556in"
height="0.19166666666666668in"}given in the table 89 or table 90, the
multiplication number is selected that gives the most suitable harmonic
interval of MDCT domain transform coefficients.

![](media/image478.wmf){width="1.7395833333333333in"
height="0.2423611111111111in"} (939)

![](media/image479.wmf){width="3.6958333333333333in"
height="0.20972222222222223in"} (940)

Table 88: Number of bits for specifying the multiplier depending on
![](media/image480.wmf){width="0.5034722222222222in"
height="0.2423611111111111in"}

  --------------------------------------------------------------------------- --- --- --- --- --- --- --- --- --- --- ---- ---- ---- ---- ---- ----
  ![](media/image481.wmf){width="0.44375in" height="0.20972222222222223in"}   0   1   2   3   4   5   6   7   8   9   10   11   12   13   14   15
  NB:                                                                         5   4   4   4   4   4   4   3   3   3   3    2    2    2    2    2
  WB:                                                                         5   5   5   5   5   5   4   4   4   4   4    4    4    2    2    2
  --------------------------------------------------------------------------- --- --- --- --- --- --- --- --- --- --- ---- ---- ---- ---- ---- ----

Table 89: Candidates of multiplier in the order of
![](media/image482.wmf){width="0.6083333333333333in"
height="0.20972222222222223in"} depending on
![](media/image483.wmf){width="0.44375in"
height="0.20972222222222223in"} (NB)

  --------------------------------------------------------------------------------------- ----- ----- ----- ----- ---- ----- ---- ----- ---- ---- ---- ---- ---- ---- ---- ----
  ![](media/image484.wmf){width="0.38958333333333334in" height="0.20972222222222223in"}                                                                                    
  0                                                                                       3     4     5     6     7    8     9    10    11   12   13   14   15   16   17   18
                                                                                          19    20    21    22    23   24    25   26    27   28   30   32   34   36   38   40
  1                                                                                       0.5   1     2     3     4    5     6    7     8    9    10   12   16   20   24   30
  2                                                                                       2     3     4     5     6    7     8    9     10   12   14   16   18   20   24   30
  3                                                                                       2     3     4     5     6    7     8    9     10   12   14   16   18   20   24   30
  4                                                                                       2     3     4     5     6    7     8    9     10   12   14   16   18   20   24   30
  5                                                                                       1     2     2.5   3     4    5     6    7     8    9    10   12   14   16   18   20
  6                                                                                       1     1.5   2     2.5   3    3.5   4    4.5   5    6    7    8    9    10   12   16
  7                                                                                       1     2     3     4     5    6     8    10    \-   \-   \-   \-   \-   \-   \-   \-
  8                                                                                       1     2     3     4     5    6     8    10    \-   \-   \-   \-   \-   \-   \-   \-
  9                                                                                       1     1.5   2     3     4    5     6    8     \-   \-   \-   \-   \-   \-   \-   \-
  10                                                                                      1     2     2.5   3     4    5     6    8     \-   \-   \-   \-   \-   \-   \-   \-
  11                                                                                      1     2     3     4     \-   \-    \-   \-    \-   \-   \-   \-   \-   \-   \-   \-
  12                                                                                      1     2     4     6     \-   \-    \-   \-    \-   \-   \-   \-   \-   \-   \-   \-
  13                                                                                      1     2     3     4     \-   \-    \-   \-    \-   \-   \-   \-   \-   \-   \-   \-
  14                                                                                      1     1.5   2     4     \-   \-    \-   \-    \-   \-   \-   \-   \-   \-   \-   \-
  15                                                                                      1     1.5   2     3     \-   \-    \-   \-    \-   \-   \-   \-   \-   \-   \-   \-
  16                                                                                      0.5   1     2     3     \-   \-    \-   \-    \-   \-   \-   \-   \-   \-   \-   \-
  --------------------------------------------------------------------------------------- ----- ----- ----- ----- ---- ----- ---- ----- ---- ---- ---- ---- ---- ---- ---- ----

Table 90: Candidates of multiplier in the order of depending
on![](media/image485.wmf){width="0.5034722222222222in"
height="0.2423611111111111in"} (WB)

  --------------------------------------------------------------------------- ----- ----- ------ ----- ------ ----- ----- ----- ----- ------ ----- ----- ---- ------ ---- ----
  ![](media/image486.wmf){width="0.44375in" height="0.20972222222222223in"}                                                                                               
  0                                                                           3     4     5      6     7      8     9     10    11    12     13    14    15   16     17   18
                                                                              19    20    21     22    23     24    25    26    27    28     30    32    34   36     38   40
  1                                                                           1     2     3      4     5      6     7     8     9     10     12    14    16   18     20   22
                                                                              24    26    28     30    32     34    36    38    40    44     48    54    60   68     78   80
  2                                                                           1.5   2     2.5    3     4      5     6     7     8     9      10    12    14   16     18   20
                                                                              22    24    26     28    30     32    34    36    38    40     42    44    48   52     54   68
  3                                                                           1     1.5   2      2.5   3      4     5     6     7     8      9     10    11   12     13   14
                                                                              15    16    18     20    22     24    26    28    30    32     34    36    40   44     48   54
  4                                                                           1     1.5   2      2.5   3      3.5   4     4.5   5     5.5    6     6.5   7    7.5    8    9
                                                                              10    11    12     13    14     15    16    18    20    22     24    26    28   34     40   41
  5                                                                           1     1.5   2      2.5   3      3.5   4     4.5   5     6      7     8     9    10     11   12
                                                                              13    14    15     16    17     18    19    20    21    22.5   24    25    27   28     30   35
  6                                                                           0.5   1     1.5    2     2.5    3     3.5   4     4.5   5      5.5   6     7    8      9    10
  7                                                                           1     2     2.5    3     4      5     6     7     8     9      10    12    15   16     18   27
  8                                                                           1     1.5   2      2.5   3      3.5   4     5     6     8      10    15    18   22     24   26
  9                                                                           1     1.5   2      2.5   3      3.5   4     5     6     8      10    12    13   14     18   21
  10                                                                          0.5   1     1.5    2     2.5    3     4     5     6     8      9     11    12   13.5   16   20
  11                                                                          0.5   1     1.5    2     2.5    3     4     5     6     7      8     10    11   12     14   20
  12                                                                          0.5   1     1.5    2     2.5    3     4     4.5   6     7.5    9     10    12   14     15   18
  13                                                                          0.5   1     1.25   1.5   1.75   2     2.5   3     3.5   4      4.5   5     6    8      9    14
  14                                                                          0.5   1     2      4     \-     \-    \-    \-    \-    \-     \-    \-    \-   \-     \-   \-
  15                                                                          1     1.5   2      4     \-     \-    \-    \-    \-    \-     \-    \-    \-   \-     \-   \-
  16                                                                          1     2     3      4     \-     \-    \-    \-    \-    \-     \-    \-    \-   \-     \-   \-
  --------------------------------------------------------------------------- ----- ----- ------ ----- ------ ----- ----- ----- ----- ------ ----- ----- ---- ------ ---- ----

##### 5.3.3.2.8.1.8.1.2 Encoding interval without depending on time domain pitch lag {#encoding-interval-without-depending-on-time-domain-pitch-lag .H6}

When pitch lag and gain in the time domain is not used or the pitch gain
is less than or equals to 0.46, normal encoding of the interval with
un-equal resolution is used.

Unit interval of spectral peaks
![](media/image487.wmf){width="0.38333333333333336in"
height="0.20069444444444445in"} is coded as

![](media/image488.wmf){width="1.9229166666666666in"
height="0.2513888888888889in"}, (941)

and actual interval ![](media/image489.wmf){width="0.44375in"
height="0.20972222222222223in"} is represented with fractional
resolution of ![](media/image490.wmf){width="0.27847222222222223in"
height="0.1736111111111111in"} as

![](media/image491.wmf){width="1.2958333333333334in"
height="0.2423611111111111in"}. (942)

Each paramter is shown in table 91, where "small size" means when frame
size is smaller than 256 of the target bit rates is less than or equal
to 150.

Table 91: Un-equal resolution for coding of (0\<= index \< 256)

  ------------------------------------------------------------------------------------------------------ ------- -------- --------
                                                                                                         *Res*   *base*   *bias*
  ![](media/image492.wmf){width="0.6263888888888889in" height="0.16458333333333333in"}                   3       6        0
  ![](media/image493.wmf){width="0.9027777777777778in" height="0.16458333333333333in"}                   4       8        16
  ![](media/image494.wmf){width="0.9833333333333333in" height="0.16458333333333333in"}                   3       12       80
  "small size" or ![](media/image495.wmf){width="1.0527777777777778in" height="0.16458333333333333in"}   1       28       208
  ![](media/image496.wmf){width="1.0527777777777778in" height="0.16458333333333333in"}                   0       188      224
  ------------------------------------------------------------------------------------------------------ ------- -------- --------

##### 5.3.3.2.8.1.8.2 Void {#void .H6}

##### 5.3.3.2.8.1.8.3 Search for interval of harmonics {#search-for-interval-of-harmonics .H6}

In search of the best interval of harmonics, encoder tries to find the
index which can maximize the weighted sum
![](media/image497.wmf){width="0.5548611111111111in"
height="0.20972222222222223in"} of the peak part of absolute MDCT
coefficients. ![](media/image498.wmf){width="0.6597222222222222in"
height="0.20972222222222223in"}denotes sum of 3 samples of absolute
value of MDCT domain transform coefficients as

![](media/image499.wmf){width="2.0006944444444446in"
height="0.49444444444444446in"} (943)

![](media/image500.wmf){width="4.26875in"
height="0.49444444444444446in"} (944)

where *num\_peak* is the maximum number that
![](media/image501.wmf){width="0.7319444444444444in"
height="0.20972222222222223in"} reaches the limit of samples in the
frequency domain.

In case interval does not rely on the pitch lag in time domain,
hierarchical search is used to save computational cost. If the index of
the interval is less than 80, periodicity is checked by a coarse step of
4. After getting the best interval, finer periodicity is searched around
the best interval from -2 to +2. If index is equal to or larger than 80,
periodicity is searched for each index.

##### 5.3.3.2.8.1.8.4 Decision of harmonic model {#decision-of-harmonic-model .H6}

At the initial estimation, number of used bits without harmonic model,
![](media/image502.wmf){width="0.6326388888888889in"
height="0.20833333333333334in"}, and one with harmonic model,
![](media/image503.wmf){width="0.7743055555555556in"
height="0.20833333333333334in"}is obtained and the indicator of consumed
bits ![](media/image504.wmf){width="0.625in"
height="0.20833333333333334in"}is defined as

![](media/image505.wmf){width="1.6076388888888888in"
height="0.2326388888888889in"}, (945)

![](media/image506.wmf){width="1.8243055555555556in"
height="0.24166666666666667in"}, (946)

![](media/image507.wmf){width="2.7416666666666667in"
height="0.20833333333333334in"}, (947)

where ![](media/image508.wmf){width="0.825in"
height="0.20833333333333334in"}denotes the additional bits for model
parameters of periodic harmonic structure,
and![](media/image509.wmf){width="0.29930555555555555in"
height="0.19166666666666668in"} and
![](media/image510.wmf){width="0.42430555555555555in"
height="0.20833333333333334in"}indicate the consumed bits when they are
larger than the target bits. Thus, the
larger![](media/image511.wmf){width="0.625in"
height="0.20833333333333334in"}, the more preferable to use harmonic
model. Relative periodicity ![](media/image512.wmf){width="0.675in"
height="0.20833333333333334in"}is defined as the normalized sum of
absolute values for peak regions of the shaped MDCT coefficients as

![](media/image513.wmf){width="3.035416666666667in"
height="0.49444444444444446in"}, (948)

where ![](media/image514.wmf){width="0.7229166666666667in"
height="0.2423611111111111in"}is the harmonic interval that attain the
max value of![](media/image515.wmf){width="0.5548611111111111in"
height="0.20972222222222223in"}. When the score of periodicity of this
frame is larger than the threshold as

![](media/image516.wmf){width="3.7736111111111112in" height="0.2875in"},
(949)

this frame is considered to be coded by the harmonic model. The shaped
MDCT coefficients divided by gain
![](media/image517.wmf){width="0.35694444444444445in"
height="0.20972222222222223in"}are quantized to produce a sequence of
integer values of MDCT coefficients,
![](media/image518.wmf){width="0.6083333333333333in"
height="0.26944444444444443in"}, and compressed by arithmetic coding
with harmonic model. This process needs iterative convergence process
(rate loop) to get ![](media/image519.wmf){width="0.35694444444444445in"
height="0.20972222222222223in"} and
![](media/image520.wmf){width="0.5486111111111112in"
height="0.2513888888888889in"}with consumed bits
![](media/image521.wmf){width="0.27847222222222223in"
height="0.20972222222222223in"}. At the end of convergence, in order to
validate harmonic model, the consumed bits
![](media/image522.wmf){width="0.5034722222222222in"
height="0.2423611111111111in"}by arithmetic coding with normal
(non-harmonic) model for
![](media/image523.wmf){width="0.5486111111111112in"
height="0.2513888888888889in"} is additionally calculated and compared
with ![](media/image524.wmf){width="0.2965277777777778in"
height="0.20972222222222223in"}. If
![](media/image525.wmf){width="0.27847222222222223in"
height="0.20972222222222223in"} is larger
than![](media/image526.wmf){width="0.44375in" height="0.225in"},
arithmetic coding of
![](media/image527.wmf){width="0.5486111111111112in"
height="0.2513888888888889in"}is revert to use normal model.
![](media/image528.wmf){width="0.7465277777777778in" height="0.225in"}
can be used for residual quantization for further enhancements.
Otherwise, harmonic model is used in arithmetic coding.

In contrast, if the indicator of periodicity of this frame is smaller
than or the same as the threshold, quantization and arithmetic coding
are carried out assuming the normal model to produce a sequence of
integer values of the shaped MDCT coefficients,
![](media/image529.wmf){width="0.7319444444444444in"
height="0.2513888888888889in"} with consumed bits
![](media/image530.wmf){width="0.5034722222222222in"
height="0.2423611111111111in"}. After convergence of rate loop, consumed
bits ![](media/image531.wmf){width="0.27847222222222223in"
height="0.20972222222222223in"}by arithmetic coding with harmonic model
for ![](media/image532.wmf){width="0.7319444444444444in"
height="0.2513888888888889in"}is calculated. If
![](media/image533.wmf){width="0.4618055555555556in" height="0.225in"}
is larger than ![](media/image534.wmf){width="0.27847222222222223in"
height="0.20972222222222223in"}, arithmetic coding of
![](media/image535.wmf){width="0.6506944444444445in"
height="0.2513888888888889in"} is switched to use harmonic model.
Otherwise, normal model is used in arithmetic coding.

##### 5.3.3.2.8.1.9 Use of harmonic information in Context based arithmetic coding {#use-of-harmonic-information-in-context-based-arithmetic-coding .H6}

For context based arithmetic coding, all regions are classified into two
categories. One is peak part and consists of 3 consecutive samples
centered at ![](media/image536.wmf){width="0.2423611111111111in"
height="0.21597222222222223in"}
(![](media/image537.wmf){width="0.13194444444444445in"
height="0.1736111111111111in"} is a positive integer up to the limit)
peak of harmonic peak
of![](media/image538.wmf){width="0.19166666666666668in"
height="0.20972222222222223in"},

![](media/image539.wmf){width="0.9833333333333333in"
height="0.20972222222222223in"}. (950)

The other samples belong to normal or valley part. Harmonic peak part
can be specified by the interval of harmonics and integer multiples of
the interval. Arithmetic coding uses different contexts for peak and
valley regions.

For ease of description and implementation, the harmonic model uses the
following index sequences:

![](media/image540.wmf){width="2.513888888888889in"
height="0.20972222222222223in"}, (951)

![](media/image541.wmf){width="1.5569444444444445in"
height="0.20972222222222223in"}, (952)

![](media/image542.wmf){width="0.6777777777777778in"
height="0.20972222222222223in"}, the concatenation of
![](media/image543.wmf){width="0.18263888888888888in"
height="0.20069444444444445in"} and
![](media/image544.wmf){width="0.16458333333333333in"
height="0.16458333333333333in"}. (953)

In case of disabled harmonic model, these sequences are
![](media/image545.wmf){width="0.4673611111111111in"
height="0.20972222222222223in"}, and
![](media/image546.wmf){width="1.2958333333333334in"
height="0.20972222222222223in"}.

##### 5.3.3.2.8.2 Envelope based arithmetic coder {#envelope-based-arithmetic-coder .H6}

In the MDCT domain, spectral lines are weighted with the perceptual
model ![](media/image547.wmf){width="0.31180555555555556in"
height="0.20972222222222223in"} such that each line can be quantized
with the same accuracy. The variance of individual spectral lines follow
the shape of the linear predictor
![](media/image548.wmf){width="0.43472222222222223in"
height="0.2513888888888889in"} weighted by the perceptual model, whereby
the weighted shape is
![](media/image549.wmf){width="1.0854166666666667in"
height="0.2513888888888889in"}.
![](media/image547.wmf){width="0.31180555555555556in"
height="0.20972222222222223in"} is calculated by transforming
![](media/image550.wmf){width="0.19166666666666668in"
height="0.2513888888888889in"} to frequency domain LPC gains as detailed
in subclauses 5.3.3.2.4.1 and
5.3.3.2.4.2.![](media/image548.wmf){width="0.43472222222222223in"
height="0.2513888888888889in"} is derived from
![](media/image551.wmf){width="0.16458333333333333in"
height="0.21597222222222223in"} after conversion to direct-form
coefficients, and applying tilt compensation
![](media/image552.wmf){width="0.44375in"
height="0.2513888888888889in"}, and finally transforming to frequency
domain LPC gains. All other frequency-shaping tools, as well as the
contribution from the harmonic model, shall be also included in this
envelope shape ![](media/image553.wmf){width="0.2875in"
height="0.20972222222222223in"}. Observe that this gives only the
relative variances of spectral lines, while the overall envelope has
arbitrary scaling, whereby we must begin by scaling the envelope.

##### 5.3.3.2.8.2.1 Envelope scaling {#envelope-scaling .H6}

We will assume that spectral lines
![](media/image554.wmf){width="0.18263888888888888in"
height="0.20972222222222223in"} are zero-mean and distributed according
to the Laplace-distribution, whereby the probability distribution
function is

![](media/image555.wmf){width="1.425in" height="0.48541666666666666in"}
(954)

The entropy and thus the bit-consumption of such a spectral line is
![](media/image556.wmf){width="1.1819444444444445in"
height="0.20972222222222223in"}. However, this formula assumes that the
sign is encoded also for those spectral lines which are quantized to
zero. To compensate for this discrepancy, we use instead the
approximation

![](media/image557.wmf){width="2.0006944444444446in"
height="0.4618055555555556in"} (955)

which is accurate for
![](media/image558.wmf){width="0.5729166666666666in"
height="0.20972222222222223in"}. We will assume that the bit-consumption
of lines with ![](media/image559.wmf){width="0.5729166666666666in"
height="0.20972222222222223in"} is
![](media/image560.wmf){width="1.1819444444444445in"
height="0.20972222222222223in"} which matches the bit-consumption at
![](media/image561.wmf){width="0.5729166666666666in"
height="0.20972222222222223in"}. For large
![](media/image562.wmf){width="0.5395833333333333in"
height="0.20972222222222223in"} we use the true entropy
![](media/image563.wmf){width="1.0763888888888888in"
height="0.20972222222222223in"} for simplicity.

The variance of spectral lines is then
![](media/image564.wmf){width="0.6263888888888889in"
height="0.2423611111111111in"}If
![](media/image565.wmf){width="0.18263888888888888in"
height="0.2423611111111111in"} is the
![](media/image566.wmf){width="0.13194444444444445in"
height="0.18263888888888888in"}th element of the power of the envelope
shape ![](media/image567.wmf){width="0.38958333333333334in"
height="0.27847222222222223in"} then
![](media/image568.wmf){width="0.18263888888888888in"
height="0.2423611111111111in"} describes the relative energy of spectral
lines such that ![](media/image569.wmf){width="0.6506944444444445in"
height="0.2423611111111111in"} where
![](media/image570.wmf){width="0.13194444444444445in"
height="0.16458333333333333in"} is scaling coefficient. In other words,
![](media/image571.wmf){width="0.18263888888888888in"
height="0.2423611111111111in"} describes only the shape of the spectrum
without any meaningful magnitude and
![](media/image572.wmf){width="0.13194444444444445in"
height="0.16458333333333333in"} is used to scale that shape to obtain
the actual variance
![](media/image573.wmf){width="0.20972222222222223in"
height="0.2423611111111111in"}.

Our objective is that when we encode all lines of the spectrum with an
arithmetic coder, then the bit-consumption matches a pre-defined level
![](media/image574.wmf){width="0.14652777777777778in"
height="0.14652777777777778in"}, that is,
![](media/image575.wmf){width="0.7645833333333333in"
height="0.5395833333333333in"}. We can then use a bi-section algorithm
to determine the appropriate scaling factor
![](media/image576.wmf){width="0.13194444444444445in"
height="0.16458333333333333in"} such that the target bit-rate
![](media/image577.wmf){width="0.14652777777777778in"
height="0.14652777777777778in"} is reached.

Once the envelope shape
![](media/image578.wmf){width="0.18263888888888888in"
height="0.20972222222222223in"} has been scaled such that the expected
bit-consumption of signals matching that shape yield the target
bit-rate, we can proceed to quantizing the spectral lines.

##### 5.3.3.2.8.2.2 Quantization rate loop {#quantization-rate-loop .H6}

Assume that ![](media/image579.wmf){width="0.18263888888888888in"
height="0.20972222222222223in"} is quantized to an integer
![](media/image580.wmf){width="0.18263888888888888in"
height="0.20972222222222223in"} such that the quantization interval is
![](media/image581.wmf){width="1.0618055555555554in"
height="0.20972222222222223in"} then the probability of a spectral line
occurring in that interval is for
![](media/image582.wmf){width="0.42569444444444443in"
height="0.23333333333333334in"}

![](media/image583.wmf){width="4.667361111111111in" height="0.5125in"}
(956)

and for ![](media/image584.wmf){width="0.4618055555555556in"
height="0.23333333333333334in"}

![](media/image585.wmf){width="1.4604166666666667in"
height="0.48541666666666666in"} (957)

It follows that the bit-consumption for these two cases is in the ideal
case

![](media/image586.wmf){width="3.365972222222222in"
height="0.9569444444444445in"} (958)

By pre-computing the terms
![](media/image587.wmf){width="1.2083333333333333in"
height="0.48541666666666666in"} and
![](media/image588.wmf){width="1.2354166666666666in"
height="0.48541666666666666in"}, we can efficiently calculate the
bit-consumption of the whole spectrum.

The rate-loop can then be applied with a bi-section search, where we
adjust the scaling of the spectral lines by a factor
![](media/image589.wmf){width="0.14652777777777778in"
height="0.16458333333333333in"}, and calculate the bit-consumption of
the spectrum ![](media/image590.wmf){width="0.2604166666666667in"
height="0.20972222222222223in"}, until we are sufficiently close to the
desired bit-rate. Note that the above ideal-case values for the
bit-consumption do not necessarily perfectly coincide with the final
bit-consumption, since the arithmetic codec works with a
finite-precision approximation. This rate-loop thus relies on an
approximation of the bit-consumption, but with the benefit of a
computationally efficient implementation.

When the optimal scaling
![](media/image591.wmf){width="0.14652777777777778in" height="0.1375in"}
has been determined, the spectrum can be encoded with a standard
arithmetic coder. A spectral line which is quantized to a value
![](media/image592.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"} is encoded to the interval

![](media/image593.wmf){width="2.120833333333333in" height="0.5125in"}
(959)

and ![](media/image594.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"} is encoded onto the interval

![](media/image595.wmf){width="1.2506944444444446in" height="0.5125in"}
(960)

The sign of ![](media/image596.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"} will be encoded with one further bit.

Observe that the arithmetic coder must operate with a fixed-point
implementation such that the above intervals are bit-exact across all
platforms. Therefore all inputs to the arithmetic coder, including the
linear predictive model and the weighting filter, must be implemented in
fixed-point throughout the system

##### 5.3.3.2.8.2.3 Probability model derivation and coding {#probability-model-derivation-and-coding-1 .H6}

When the optimal scaling
![](media/image597.wmf){width="0.14652777777777778in" height="0.1375in"}
has been determined, the spectrum can be encoded with a standard
arithmetic coder. A spectral line which is quantized to a value
![](media/image598.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"} is encoded to the interval

![](media/image599.wmf){width="2.120833333333333in" height="0.5125in"}
(961)

and ![](media/image600.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"} is encoded onto the interval

![](media/image601.wmf){width="1.2506944444444446in" height="0.5125in"}
(962)

The sign of ![](media/image602.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"} will be encoded with one further bit.

##### 5.3.3.2.8.2.4 Harmonic model in envelope based arithmetic coding {#harmonic-model-in-envelope-based-arithmetic-coding .H6}

In case of envelope base arithmetic coding, harmonic model can be used
to enhance the arithmetic coding. The similar search procedure as in the
context based arithmetic coding is used for estimating the interval
between harmonics in the MDCT domain. However, the harmonic model is
used in combination of the LPC envelope as shown in figure 64. The shape
of the envelope is rendered according to the information of the harmonic
analysis.

Harmonic shape at ![](media/image603.wmf){width="0.12291666666666666in"
height="0.18263888888888888in"} in the frequency data sample is defined
as

![](media/image604.wmf){width="1.5298611111111111in"
height="0.48541666666666666in"}, (963)

![](media/image605.wmf){width="1.304861111111111in"
height="0.18263888888888888in"}, otherwise
![](media/image606.wmf){width="0.6263888888888889in"
height="0.20972222222222223in"}, where
![](media/image607.wmf){width="0.12291666666666666in" height="0.1375in"}
denotes center position of
![](media/image608.wmf){width="0.2423611111111111in"
height="0.20972222222222223in"} harmonics.

![](media/image609.wmf){width="0.9027777777777778in"
height="0.20972222222222223in"} (964)

![](media/image610.wmf){width="0.12291666666666666in"
height="0.18263888888888888in"} and
![](media/image611.wmf){width="0.15555555555555556in"
height="0.1375in"}are height and width of each harmonics depending on
the unit interval as shown,

![](media/image612.wmf){width="2.390972222222222in"
height="0.23333333333333334in"} (965)

![](media/image613.wmf){width="2.198611111111111in"
height="0.23333333333333334in"} (966)

Height and width get larger when interval gets larger.

The spectral
envelope![](media/image614.wmf){width="0.30277777777777776in"
height="0.19166666666666668in"}is modified by the harmonic shape
![](media/image615.wmf){width="0.3298611111111111in"
height="0.19166666666666668in"}at
![](media/image616.wmf){width="0.12291666666666666in"
height="0.18263888888888888in"} as

![](media/image617.wmf){width="1.7034722222222223in"
height="0.20972222222222223in"}**,** (967)

where gain for the harmonic components
![](media/image618.wmf){width="0.375in" height="0.20972222222222223in"}
is always set as 0.75 for Generic mode, and
![](media/image619.wmf){width="0.34791666666666665in"
height="0.20972222222222223in"} is selected from {0.6, 1.4, 4.5, 10.0}
that minimizes![](media/image620.wmf){width="0.34791666666666665in"
height="0.20069444444444445in"} for Voiced mode using 2 bits,

![](media/image621.wmf){width="1.8354166666666667in"
height="0.5305555555555556in"}, (968)

![](media/image622.wmf){width="2.321527777777778in"
height="0.5305555555555556in"}. (969)

![](media/image623.wmf){width="4.241666666666666in" height="2.7125in"}

Figure 64: Example of harmonic envelope combined with LPC envelope used
in envelope based arithmetic coding.

##### 5.3.3.2.9 Global gain coding

##### 5.3.3.2.9.1 Optimizing global gain {#optimizing-global-gain .H6}

The optimum global gain ![](media/image624.wmf){width="0.2875in"
height="0.23333333333333334in"} is computed from the quantized and
unquantized MDCT coefficients. For bit rates up to 32 kbps, the adaptive
low frequency de-emphasis (see subclause 6.2.2.3.2) is applied to the
quantized MDCT coefficients before this step. In case the computation
results in an optimum gain less than or equal to zero, the global gain
![](media/image625.wmf){width="0.34791666666666665in"
height="0.20972222222222223in"} determined before (by estimate and rate
loop) is used.

![](media/image626.wmf){width="1.5986111111111112in"
height="1.1305555555555555in"} (970)

![](media/image627.wmf){width="1.6944444444444444in"
height="0.4527777777777778in"} (971)

##### 5.3.3.2.9.2 Quantization of global gain {#quantization-of-global-gain .H6}

For transmission to the decoder the optimum global gain
![](media/image628.wmf){width="0.2875in" height="0.23333333333333334in"}
is quantized to a 7 bit index
![](media/image629.wmf){width="0.5638888888888889in"
height="0.23333333333333334in"}:

![](media/image630.wmf){width="2.720833333333333in"
height="0.5909722222222222in"} (972)

The dequantized global gain
![](media/image631.wmf){width="0.34791666666666665in"
height="0.20972222222222223in"} is obtained as defined in subclause
6.2.2.3.3).

##### 5.3.3.2.9.3 Residual coding {#residual-coding .H6}

The residual quantization is a refinement quantization layer refining
the first SQ stage. It exploits eventual unused bits
*target\_bits-nbbits*, where *nbbits* is the number of bits consumed by
the entropy coder. The residual quantization adopts a greedy strategy
and no entropy coding in order to stop the coding whenever the
bit-stream reaches the desired size.

The residual quantization can refine the first quantization by two
means. The first mean is the refinement of the global gain quantization.
The global gain refinement is only done for rates at and above 13.2kbps.
At most three additional bits is allocated to it. The quantized gain
![](media/image632.wmf){width="0.34791666666666665in"
height="0.20972222222222223in"} is refined sequentially starting from
*n=0* and incrementing *n* by one after each following iteration:

![](media/image633.wmf){width="1.6256944444444446in" height="1.425in"}

The second mean of refinement consists of re-quantizing the quantized
spectrum line per line. First, the non-zeroed quantized lines are
processed with a 1 bit residual quantizer:

![](media/image634.wmf){width="1.2444444444444445in"
height="0.8604166666666667in"}

Finally, if bits remain, the zeroed lines are considered and quantized
with on 3 levels. The rounding offset of the SQ with deadzone was taken
into account in the residual quantizer design:

![](media/image635.wmf){width="1.7548611111111112in"
height="1.2597222222222222in"}

##### 5.3.3.2.10 Noise Filling

On the decoder side noise filling is applied to fill gaps in the MDCT
spectrum where coefficients have been quantized to zero. Noise filling
inserts pseudo-random noise into the gaps, starting at bin
![](media/image636.wmf){width="0.48541666666666666in"
height="0.20972222222222223in"} up to bin
![](media/image637.wmf){width="0.6506944444444445in"
height="0.23333333333333334in"}. To control the amount of noise inserted
in the decoder, a noise factor is computed on encoder side and
transmitted to the decoder.

##### 5.3.3.2.10.1 Noise Filling Tilt {#noise-filling-tilt .H6}

To compensate for LPC tilt, a tilt compensation factor is computed. For
bitrates below 13.2 kbps the tilt compensation is computed from the
direct form quantized LP coefficients
![](media/image638.wmf){width="0.13194444444444445in"
height="0.1736111111111111in"}, while for higher bitrates a constant
value is used:

![](media/image639.wmf){width="3.6083333333333334in"
height="1.2444444444444445in"} (973)

![](media/image640.wmf){width="1.676388888888889in"
height="0.3659722222222222in"} (974)

##### 5.3.3.2.10.2 Noise Filling Start and Stop Bins {#noise-filling-start-and-stop-bins .H6}

The noise filling start and stop bins are computed as follows:

![](media/image641.wmf){width="2.4868055555555557in"
height="1.2354166666666666in"} (975)

![](media/image642.wmf){width="3.4763888888888888in"
height="0.5486111111111112in"} (976)

##### 5.3.3.2.10.3 Noise Transition Width {#noise-transition-width .H6}

At each side of a noise filling segment a transition fadeout is applied
to the inserted noise. The width of the transitions (number of bins) is
defined as:

![](media/image643.wmf){width="5.894444444444445in"
height="0.8423611111111111in"} (977)

where ![](media/image644.wmf){width="0.2965277777777778in"
height="0.15555555555555556in"}denotes that the harmonic model is used
for the arithmetic codec and
![](media/image645.wmf){width="0.5548611111111111in"
height="0.19166666666666668in"}denotes the previous codec mode.

##### 5.3.3.2.10.4 Computation of Noise Segments {#computation-of-noise-segments .H6}

The noise filling segments are determined, which are the segments of
successive bins of the MDCT spectrum between
![](media/image646.wmf){width="0.48541666666666666in"
height="0.20972222222222223in"} and
![](media/image647.wmf){width="0.6263888888888889in"
height="0.23333333333333334in"} for which all coefficients are quantized
to zero. The segments are determined as defined by the following
pseudo-code:

![](media/image648.wmf){width="3.0444444444444443in"
height="3.5548611111111112in"}

where ![](media/image649.wmf){width="0.5125in"
height="0.20972222222222223in"} and
![](media/image650.wmf){width="0.48541666666666666in"
height="0.20972222222222223in"} are the start and stop bins of noise
filling segment *j*, and ![](media/image651.wmf){width="0.2875in"
height="0.20972222222222223in"} is the number of segments.

##### 5.3.3.2.10.5 Computation of Noise Factor {#computation-of-noise-factor .H6}

The noise factor is computed from the unquantized MDCT coefficients of
the bins for which noise filling is applied.

If the noise transition width
![](media/image652.wmf){width="0.30277777777777776in"
height="0.20972222222222223in"} is 3 or less bins, an attenuation factor
is computed based on the energy of even and odd MDCT bins:

![](media/image653.wmf){width="3.347916666666667in"
height="0.7229166666666667in"} (978)

![](media/image654.wmf){width="3.5034722222222223in"
height="0.7229166666666667in"} (979)

![](media/image655.wmf){width="2.6694444444444443in"
height="0.6506944444444445in"} (980)

For each segment an error value is computed from the unquantized MDCT
coefficients, applying global gain, tilt compensation and transitions:

![](media/image656.wmf){width="5.025in" height="0.5548611111111111in"}
(981)

A weight for each segment is computed based on the width of the segment:

![](media/image657.wmf){width="5.261805555555555in"
height="0.9895833333333334in"} (982)

The noise factor is then computed as follows:

![](media/image658.wmf){width="2.696527777777778in"
height="1.2444444444444445in"} (983)

##### 5.3.3.2.10.6 Quantization of Noise Factor {#quantization-of-noise-factor .H6}

For transmission the noise factor is quantized to obtain a 3 bit index:

![](media/image659.wmf){width="1.8in" height="0.20972222222222223in"}
(984)

##### 5.3.3.2.11 Intelligent Gap Filling

The *Intelligent Gap Filling* (IGF) tool is an enhanced noise filling
technique to fill gaps (regions of zero values) in spectra. These gaps
may occur due to coarse quantization in the encoding process where large
portions of a given spectrum might be set to zero to meet bit
constraints. However, with the IGF tool these missing signal portions
are reconstructed on the receiver side (RX) with parametric information
calculated on the transmission side (TX). IGF is used only if TCX mode
is active.

See table 92 below for all IGF operating points:

Table 92: IGF application modes

  ------------ ------
  Bitrate      Mode
  9.6 kbps     WB
  9.6 kbps     SWB
  13.2 kbps    SWB
  16.4 kbps    SWB
  24.4 kbps    SWB
  32.2 kbps    SWB
  48.0 kbps    SWB
  16.4 kbps    FB
  24.4 kbps    FB
  32.0 kbps    FB
  48.0 kbps    FB
  96.0 kbps    FB
  128.0 kbps   FB
  ------------ ------

On transmission side, IGF calculates levels on scale factor bands, using
a complex or real valued TCX spectrum. Additionally spectral whitening
indices are calculated using a spectral flatness measurement and a
crest-factor. An arithmetic coder is used for noiseless coding and
efficient transmission to receiver (RX) side.

##### 5.3.3.2.11.1 IGF helper functions {#igf-helper-functions .H6}

##### 5.3.3.2.11.1.1 Mapping values with the transition factor {#mapping-values-with-the-transition-factor .H6}

If there is a transition from CELP to TCX coding
(![](media/image660.wmf){width="1.1909722222222223in"
height="0.20972222222222223in"}) or a TCX 10 frame is signalled
(![](media/image661.wmf){width="0.9027777777777778in"
height="0.16458333333333333in"}), the TCX frame length may change. In
case of frame length change, all values which are related to the frame
length are mapped with the function
![](media/image662.wmf){width="0.20069444444444445in"
height="0.16458333333333333in"}:

![](media/image663.wmf){width="0.9388888888888889in"
height="0.20069444444444445in"}

![](media/image664.wmf){width="3.173611111111111in"
height="0.9388888888888889in"} (985)

where ![](media/image665.wmf){width="0.14652777777777778in"
height="0.14652777777777778in"} is a natural number, for example a scale
factor band offset, and
![](media/image666.wmf){width="0.14652777777777778in"
height="0.20972222222222223in"} is a transition factor, see table 97.

##### 5.3.3.2.11.1.2 TCX power spectrum {#tcx-power-spectrum .H6}

The power spectrum![](media/image667.wmf){width="0.4673611111111111in"
height="0.21597222222222223in"} of the current TCX frame is calculated
with:

![](media/image668.wmf){width="2.4506944444444443in"
height="0.2513888888888889in"} (986)

where ![](media/image669.wmf){width="0.14652777777777778in"
height="0.14652777777777778in"} is the actual TCX window length,
![](media/image670.wmf){width="0.44375in"
height="0.20972222222222223in"} is the vector containing the real valued
part (cos-transformed) of the current TCX spectrum, and
![](media/image671.wmf){width="0.44375in"
height="0.20972222222222223in"} is the vector containing the imaginary
(sin-transformed) part of the current TCX spectrum.

##### 5.3.3.2.11.1.3 The spectral flatness measurement function ![](media/image672.wmf){width="0.34791666666666665in" height="0.16458333333333333in"} {#the-spectral-flatness-measurement-function .H6}

Let ![](media/image673.wmf){width="0.44375in"
height="0.20972222222222223in"} be the TCX power spectrum as calculated
according to subclause 5.3.3.2.11.1.2 and
![](media/image674.wmf){width="0.13194444444444445in"
height="0.1736111111111111in"} the start line and
![](media/image675.wmf){width="0.11388888888888889in"
height="0.14652777777777778in"} the stop line of the SFM measurement
range.

The![](media/image676.wmf){width="0.34791666666666665in"
height="0.16458333333333333in"}function, applied with IGF, is defined
with:

![](media/image677.wmf){width="1.4097222222222223in"
height="0.2513888888888889in"}

![](media/image678.wmf){width="2.783333333333333in"
height="0.6354166666666666in"} (987)

where ![](media/image679.wmf){width="0.14652777777777778in"
height="0.14652777777777778in"} is the actual TCX window length and
![](media/image680.wmf){width="0.14652777777777778in"
height="0.16458333333333333in"} is defined with:

![](media/image681.wmf){width="2.042361111111111in"
height="0.5486111111111112in"} (988)

##### 5.3.3.2.11.1.4 The crest factor function ![](media/image682.wmf){width="0.4673611111111111in" height="0.16458333333333333in"} {#the-crest-factor-function .H6}

Let ![](media/image683.wmf){width="0.44375in"
height="0.20972222222222223in"} be the TCX power spectrum as calculated
according to subclause 5.3.3.2.11.1.2 and
![](media/image684.wmf){width="0.14652777777777778in"
height="0.20069444444444445in"}the start line and
![](media/image685.wmf){width="0.11388888888888889in"
height="0.14652777777777778in"} the stop line of the crest factor
measurement range.

The ![](media/image686.wmf){width="0.4673611111111111in"
height="0.16458333333333333in"} function, applied with IGF, is defined
with:

![](media/image687.wmf){width="1.5118055555555556in"
height="0.2513888888888889in"}

![](media/image688.wmf){width="3.9027777777777777in"
height="0.8006944444444445in"} (989)

where ![](media/image689.wmf){width="0.14652777777777778in"
height="0.14652777777777778in"} is the actual TCX window length and
![](media/image690.wmf){width="0.34791666666666665in"
height="0.20972222222222223in"} is defined with:

![](media/image691.wmf){width="2.078472222222222in"
height="0.42569444444444443in"} (990)

##### 5.3.3.2.11.1.5 The mapping function ![](media/image692.wmf){width="0.21597222222222223in" height="0.1736111111111111in"} {#the-mapping-function .H6}

The ![](media/image693.wmf){width="0.21597222222222223in"
height="0.20069444444444445in"}mapping function is defined with:

![](media/image694.wmf){width="1.2in" height="0.20972222222222223in"}

![](media/image695.wmf){width="2.198611111111111in"
height="0.6506944444444445in"} (991)

where ![](media/image696.wmf){width="0.11388888888888889in"
height="0.14652777777777778in"} is a calculated spectral flatness value
and ![](media/image697.wmf){width="0.14652777777777778in"
height="0.20069444444444445in"}is the noise band in scope. For threshold
values ![](media/image698.wmf){width="0.4076388888888889in"
height="0.20972222222222223in"},
![](media/image699.wmf){width="0.3388888888888889in"
height="0.20972222222222223in"} refer to table 93 below.

Table 93: Thresholds for whitening for
![](media/image700.wmf){width="0.225in" height="0.16458333333333333in"},
![](media/image701.wmf){width="0.3388888888888889in"
height="0.18263888888888888in"}and
![](media/image702.wmf){width="0.27847222222222223in"
height="0.18263888888888888in"}

  ------------ ------ ---- ------------------------ ------------------------
  Bitrate      Mode   nT   ThM                      ThS
  9.6 kbps     WB     2    0.36, 0.36               1.41, 1.41
  9.6 kbps     SWB    3    0.84, 0.89, 0.89         1.30, 1.25, 1.25
  13.2 kbps    SWB    2    0.84, 0.89               1.30, 1.25
  16.4 kbps    SWB    3    0.83, 0.89, 0.89         1.31, 1.19, 1.19
  24.4 kbps    SWB    3    0.81, 0.85, 0.85         1.35, 1.23, 1.23
  32.2 kbps    SWB    3    0.91, 0.85, 0.85         1.34, 1.35, 1.35
  48.0 kbps    SWB    1    1.15                     1.19
  16.4 kbps    FB     3    0.63, 0.27, 0.36         1.53, 1.32, 0.67
  24.4 kbps    FB     4    0.78, 0.31, 0.34, 0.34   1.49, 1.38, 0.65, 0.65
  32.0 kbps    FB     4    0.78, 0.31, 0.34, 0.34   1.49, 1.38, 0.65, 0.65
  48.0 kbps    FB     1    0.80                     1.0
  96.0 kbps    FB     1    0                        2.82
  128.0 kbps   FB     1    0                        2.82
  ------------ ------ ---- ------------------------ ------------------------

##### 5.3.3.2.11.1.6 Void {#void-1 .H6}

##### 5.3.3.2.11.1.7 IGF scale factor tables {#igf-scale-factor-tables .H6}

IGF scale factor tables are available for all modes where IGF is
applied.

Table 94: Scale factor band offset table

  ------------ ------ ---------------------- -------------------------------------------------------
  Bitrate      Mode   Number of bands (nB)   Scale factor band offsets (t\[0\],t\[1\],...,t\[nB\])
  9.6 kbps     WB     3                      164, 186, 242, 320
  9.6 kbps     SWB    3                      200, 322, 444, 566
  13.2 kbps    SWB    6                      256, 288, 328, 376, 432, 496, 566
  16.4 kbps    SWB    7                      256, 288, 328, 376, 432, 496, 576, 640
  24.4 kbps    SWB    8                      256, 284, 318, 358, 402, 450, 508, 576, 640
  32.2 kbps    SWB    8                      256, 284, 318, 358, 402, 450, 508, 576, 640
  48.0 kbps    SWB    3                      512, 534, 576, 640
  16.4 kbps    FB     9                      256, 288, 328, 376, 432, 496, 576, 640, 720, 800
  24.4 kbps    FB     10                     256, 284, 318, 358, 402, 450, 508, 576, 640, 720, 800
  32.0 kbps    FB     10                     256, 284, 318, 358, 402, 450, 508, 576, 640, 720, 800
  48.0 kbps    FB     4                      512, 584, 656, 728, 800
  96.0 kbps    FB     2                      640, 720, 800
  128.0 kbps   FB     2                      640, 720, 800
  ------------ ------ ---------------------- -------------------------------------------------------

The table 94 above refers to the TCX 20 window length and a transition
factor 1.00.

For all window lengths apply the following remapping

![](media/image703.wmf){width="1.9229166666666666in"
height="0.20972222222222223in"} (992)

where ![](media/image704.wmf){width="0.20069444444444445in"
height="0.16458333333333333in"}is the transition factor mapping function
described in subclause 5.3.3.2.11.1.1.

##### 5.3.3.2.11.1.8 The mapping function ![](media/image705.wmf){width="0.20069444444444445in" height="0.14652777777777778in"} {#the-mapping-function-1 .H6}

Table 95: IGF minimal source subband,
![](media/image706.wmf){width="0.44375in"
height="0.16458333333333333in"}

  ------------ ------ ---------------------------------------------------------------------------
  Bitrate      mode   ![](media/image707.wmf){width="0.44375in" height="0.16458333333333333in"}
  9.6 kbps     WB     30
  9.6 kbps     SWB    32
  13.2 kbps    SWB    32
  16.4 kbps    SWB    32
  24.4 kbps    SWB    32
  32.2 kbps    SWB    32
  48.0 kbps    SWB    64
  16.4 kbps    FB     32
  24.4 kbps    FB     32
  32.0 kbps    FB     32
  48.0 kbps    FB     64
  96.0 kbps    FB     64
  128.0 kbps   FB     64
  ------------ ------ ---------------------------------------------------------------------------

For every mode a mapping function is defined in order to access source
lines from a given target line in IGF range.

Table 96: Mapping functions for every mode

  ------------ ------ ---- ---------------------------------------------------------------------------------------
  Bitrate      Mode   nT   mapping Function
  9.6 kbps     WB     2    ![](media/image708.wmf){width="0.27847222222222223in" height="0.14652777777777778in"}
  9.6 kbps     SWB    3    ![](media/image709.wmf){width="0.27847222222222223in" height="0.14652777777777778in"}
  13.2 1kbps   SWB    2    ![](media/image710.wmf){width="0.27847222222222223in" height="0.14652777777777778in"}
  16.4 kbps    SWB    3    ![](media/image711.wmf){width="0.26944444444444443in" height="0.14652777777777778in"}
  24.4 kbps    SWB    3    ![](media/image712.wmf){width="0.26944444444444443in" height="0.14652777777777778in"}
  32.2 kbps    SWB    3    ![](media/image713.wmf){width="0.26944444444444443in" height="0.14652777777777778in"}
  48.0 kbps    SWB    1    ![](media/image714.wmf){width="0.18263888888888888in" height="0.14652777777777778in"}
  16.4 kbps    FB     3    ![](media/image715.wmf){width="0.27847222222222223in" height="0.14652777777777778in"}
  24.4 kbps    FB     4    ![](media/image716.wmf){width="0.21597222222222223in" height="0.14652777777777778in"}
  32.0 kbps    FB     4    ![](media/image717.wmf){width="0.21597222222222223in" height="0.14652777777777778in"}
  48.0 kbps    FB     1    ![](media/image718.wmf){width="0.18263888888888888in" height="0.14652777777777778in"}
  96.0 kbps    FB     1    ![](media/image718.wmf){width="0.18263888888888888in" height="0.14652777777777778in"}
  128.0 kbps   FB     1    ![](media/image718.wmf){width="0.18263888888888888in" height="0.14652777777777778in"}
  ------------ ------ ---- ---------------------------------------------------------------------------------------

The mapping function
![](media/image718.wmf){width="0.18263888888888888in"
height="0.14652777777777778in"} is defined with:

![](media/image719.wmf){width="2.9125in" height="0.1736111111111111in"}
(993)

The mapping function
![](media/image720.wmf){width="0.27847222222222223in"
height="0.14652777777777778in"} is defined with:

![](media/image721.wmf){width="2.477777777777778in" height="0.375in"}
(994)

The mapping function
![](media/image722.wmf){width="0.27847222222222223in"
height="0.14652777777777778in"} is defined with:

![](media/image723.wmf){width="3.026388888888889in" height="0.375in"}
(995)

The mapping function
![](media/image724.wmf){width="0.27847222222222223in"
height="0.14652777777777778in"} is defined with:

![](media/image725.wmf){width="3.035416666666667in"
height="0.5486111111111112in"} (996)

The mapping function
![](media/image726.wmf){width="0.26944444444444443in"
height="0.14652777777777778in"} is defined with:

![](media/image727.wmf){width="3.026388888888889in"
height="0.5486111111111112in"} (997)

The mapping function
![](media/image728.wmf){width="0.26944444444444443in"
height="0.14652777777777778in"} is defined with:

![](media/image729.wmf){width="3.026388888888889in"
height="0.5486111111111112in"} (998)

The mapping function
![](media/image730.wmf){width="0.2423611111111111in" height="0.1375in"}
is defined with:

![](media/image731.wmf){width="2.5319444444444446in"
height="0.5486111111111112in"} (999)

The mapping function
![](media/image732.wmf){width="0.18263888888888888in"
height="0.13194444444444445in"} is defined with:

![](media/image733.wmf){width="3.0597222222222222in"
height="0.7138888888888889in"} (1000)

The value![](media/image734.wmf){width="0.14652777777777778in"
height="0.20972222222222223in"} is the appropriate transition factor,
see table 97 and ![](media/image735.wmf){width="0.18263888888888888in"
height="0.16458333333333333in"}is described in subclause 5.3.3.2.11.1.1.

Please note, that all values
![](media/image736.wmf){width="0.9569444444444445in"
height="0.20972222222222223in"} shall be already mapped with the
function ![](media/image737.wmf){width="0.2513888888888889in"
height="0.20069444444444445in"}as described in subclause 5.3.3.2.11.1.1.
Values for ![](media/image738.wmf){width="0.20972222222222223in"
height="0.16458333333333333in"} are defined in table 94.

The here described mapping functions will be referenced in the text as
"mapping function m" assuming, that the proper function for the current
mode is selected.

##### 5.3.3.2.11.2 IGF input elements (TX) {#igf-input-elements-tx .H6}

The IGF encoder module expects the following vectors and flags as an
input:

![](media/image739.wmf){width="0.15555555555555556in"
height="0.16458333333333333in"}: vector with real part of the current
TCX spectrum ![](media/image740.wmf){width="0.27847222222222223in"
height="0.23333333333333334in"}

![](media/image741.wmf){width="0.13194444444444445in"
height="0.16458333333333333in"}: vector with imaginary part of the
current TCX spectrum
![](media/image742.wmf){width="0.2513888888888889in"
height="0.23333333333333334in"}

![](media/image743.wmf){width="0.15555555555555556in"
height="0.16458333333333333in"}: vector with values of the TCX power
spectrum ![](media/image744.wmf){width="0.2513888888888889in"
height="0.23333333333333334in"}

![](media/image745.wmf){width="0.6777777777777778in"
height="0.16458333333333333in"}: flag, signalling if the current frame
contains a transient, see subclause 5.3.2.4.1.1

![](media/image746.wmf){width="0.5486111111111112in"
height="0.16458333333333333in"}: flag, signalling a TCX 10 frame

![](media/image747.wmf){width="0.5548611111111111in"
height="0.16458333333333333in"}: flag, signalling a TCX 20 frame

![](media/image748.wmf){width="0.8333333333333334in"
height="0.20972222222222223in"}: flag, signalling CELP to TCX
transition; generate flag by test whether last frame was CELP

![](media/image749.wmf){width="0.8097222222222222in"
height="0.20972222222222223in"}: flag, signalling that the current frame
is independent from the previous frame

Listed in table 97, the following combinations signalled through flags
![](media/image750.wmf){width="0.5486111111111112in"
height="0.16458333333333333in"},
![](media/image751.wmf){width="0.5548611111111111in"
height="0.16458333333333333in"} and
![](media/image752.wmf){width="0.8333333333333334in"
height="0.20972222222222223in"} are allowed with IGF:

Table 97: TCX transitions, transition factor
![](media/image753.wmf){width="0.16458333333333333in"
height="0.19166666666666668in"}, window
length![](media/image754.wmf){width="0.13194444444444445in"
height="0.13194444444444445in"}

  ----------------- -------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------------------------- -----------------------------------------------------------------------------------------------------
  Bitrate / Mode    ![](media/image755.wmf){width="0.5548611111111111in" height="0.16458333333333333in"}   ![](media/image756.wmf){width="0.5819444444444445in" height="0.16458333333333333in"}   ![](media/image757.wmf){width="0.8513888888888889in" height="0.20069444444444445in"}   Transition factor ![](media/image758.wmf){width="0.16458333333333333in" height="0.20069444444444445in"}   Window length ![](media/image759.wmf){width="0.14652777777777778in" height="0.14652777777777778in"}
  9.6 kbps / WB     false                                                                                  true                                                                                   false                                                                                  1.00                                                                                                      320
                    false                                                                                  true                                                                                   true                                                                                   1.25                                                                                                      400
  9.6 kbps / SWB    false                                                                                  true                                                                                   false                                                                                  1.00                                                                                                      640
                    false                                                                                  true                                                                                   true                                                                                   1.25                                                                                                      800
  13.2 kbps / SWB   false                                                                                  true                                                                                   false                                                                                  1.00                                                                                                      640
                    false                                                                                  true                                                                                   true                                                                                   1.25                                                                                                      800
  16.4 kbps / SWB   false                                                                                  true                                                                                   false                                                                                  1.00                                                                                                      640
                    false                                                                                  true                                                                                   true                                                                                   1.25                                                                                                      800
  24.4 kbps / SWB   false                                                                                  true                                                                                   false                                                                                  1.00                                                                                                      640
                    false                                                                                  true                                                                                   true                                                                                   1.25                                                                                                      800
  32.0 kbps / SWB   false                                                                                  true                                                                                   false                                                                                  1.00                                                                                                      640
                    false                                                                                  true                                                                                   true                                                                                   1.25                                                                                                      800
  48.0 kbps / SWB   false                                                                                  true                                                                                   false                                                                                  1.00                                                                                                      640
                    false                                                                                  true                                                                                   true                                                                                   1.00                                                                                                      640
                    true                                                                                   false                                                                                  false                                                                                  0.50                                                                                                      320
  16.4 kbps / FB    false                                                                                  true                                                                                   false                                                                                  1.00                                                                                                      960
                    false                                                                                  true                                                                                   true                                                                                   1.25                                                                                                      1200
  24.4 kbps / FB    false                                                                                  true                                                                                   false                                                                                  1.00                                                                                                      960
                    false                                                                                  true                                                                                   true                                                                                   1.25                                                                                                      1200
  32.0 kbps / FB    false                                                                                  true                                                                                   false                                                                                  1.00                                                                                                      960
                    false                                                                                  true                                                                                   true                                                                                   1.25                                                                                                      1200
  48.0 kbps / FB    false                                                                                  true                                                                                   false                                                                                  1.00                                                                                                      960
                    false                                                                                  true                                                                                   true                                                                                   1.00                                                                                                      960
                    true                                                                                   false                                                                                  false                                                                                  0.50                                                                                                      480
  96.0 kbps / FB    false                                                                                  true                                                                                   false                                                                                  1.00                                                                                                      960
                    false                                                                                  true                                                                                   true                                                                                   1.00                                                                                                      960
                    true                                                                                   false                                                                                  false                                                                                  0.50                                                                                                      480
  128.0 kbps / FB   false                                                                                  true                                                                                   false                                                                                  1.00                                                                                                      960
                    false                                                                                  true                                                                                   true                                                                                   1.00                                                                                                      960
                    true                                                                                   false                                                                                  false                                                                                  0.50                                                                                                      480
  ----------------- -------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------------------------- -----------------------------------------------------------------------------------------------------

##### 5.3.3.2.11.3 IGF functions on transmission (TX) side {#igf-functions-on-transmission-tx-side .H6}

All function declaration assumes that input elements are provided by a
frame by frame basis. The only exceptions are two consecutive TCX 10
frames, where the second frame is encoded dependent on the first frame.

##### 5.3.3.2.11.4 IGF scale factor calculation {#igf-scale-factor-calculation .H6}

This subclause describes how the IGF scale factor vector
![](media/image760.wmf){width="1.2958333333333334in"
height="0.20972222222222223in"} is calculated on transmission (TX) side.

##### 5.3.3.2.11.4.1 Complex valued calculation {#complex-valued-calculation .H6}

In case the TCX power spectrum
![](media/image761.wmf){width="0.14652777777777778in"
height="0.14652777777777778in"} is available the IGF scale factor values
![](media/image762.wmf){width="0.14652777777777778in"
height="0.16458333333333333in"} are calculated using
![](media/image763.wmf){width="0.14652777777777778in"
height="0.14652777777777778in"}:

![](media/image764.wmf){width="3.3208333333333333in"
height="0.6263888888888889in"} (1001)

and let ![](media/image765.wmf){width="0.6506944444444445in"
height="0.16458333333333333in"}be the mapping function which maps the
IGF target range into the IGF source range described in subclause
5.3.3.2.11.1.8, calculate:

![](media/image766.wmf){width="3.5305555555555554in"
height="0.6263888888888889in"} (1002)

![](media/image767.wmf){width="3.6354166666666665in"
height="0.6263888888888889in"} (1003)

where ![](media/image768.wmf){width="0.9569444444444445in"
height="0.20972222222222223in"} shall be already mapped with the
function ![](media/image769.wmf){width="0.2513888888888889in"
height="0.20069444444444445in"}see subclause 5.3.3.2.11.1.1, and
![](media/image770.wmf){width="0.20972222222222223in"
height="0.16458333333333333in"} are the number of IGF scale factor
bands, see table 94.

Calculate ![](media/image771.wmf){width="0.27847222222222223in"
height="0.20972222222222223in"} with:

![](media/image772.wmf){width="4.235416666666667in"
height="0.7826388888888889in"} (1004)

and limit ![](media/image773.wmf){width="0.30277777777777776in"
height="0.20972222222222223in"} to the range
![](media/image774.wmf){width="0.5909722222222222in"
height="0.20069444444444445in"} with

![](media/image775.wmf){width="1.1395833333333334in"
height="0.20972222222222223in"} (1005)

The values ![](media/image776.wmf){width="1.3229166666666667in"
height="0.20972222222222223in"} will be transmitted to the receiver (RX)
side after further lossless compression with an arithmetic coder
described in subclause 5.3.3.2.11.8.

##### 5.3.3.2.11.4.2 Real valued calculation {#real-valued-calculation .H6}

If the TCX power spectrum is not available calculate:

![](media/image777.wmf){width="3.113888888888889in"
height="0.6173611111111111in"} (1006)

where ![](media/image778.wmf){width="0.9569444444444445in"
height="0.20972222222222223in"} shall be already mapped with the
function ![](media/image779.wmf){width="0.2513888888888889in"
height="0.20069444444444445in"}see subclause 5.3.3.2.11.1.1, and
![](media/image780.wmf){width="0.20972222222222223in"
height="0.16458333333333333in"} are the number of bands, see table 94.

Calculate ![](media/image781.wmf){width="0.27847222222222223in"
height="0.20972222222222223in"} with:

![](media/image782.wmf){width="3.2423611111111112in" height="0.5125in"}
(1007)

and limit ![](media/image783.wmf){width="0.30277777777777776in"
height="0.20972222222222223in"} to the range
![](media/image784.wmf){width="0.5909722222222222in"
height="0.20069444444444445in"} with

![](media/image785.wmf){width="1.163888888888889in"
height="0.4076388888888889in"} (1008)

The values ![](media/image786.wmf){width="1.3229166666666667in"
height="0.20972222222222223in"} will be transmitted to the receiver (RX)
side after further lossless compression with an arithmetic coder
described in subclause 5.3.3.2.11.8.

##### 5.3.3.2.11.5 IGF tonal mask {#igf-tonal-mask .H6}

In order to determine which spectral components should be transmitted
with the core coder, a tonal mask is calculated. Therefore all
significant spectral content is identified whereas content that is well
suited for parametric coding through IGF is quantized to zero.

##### 5.3.3.2.11.5.1 IGF tonal mask calculation {#igf-tonal-mask-calculation .H6}

In case the TCX power spectrum
![](media/image787.wmf){width="0.14583333333333334in"
height="0.14583333333333334in"} is not available, all spectral content
above ![](media/image788.wmf){width="0.25in"
height="0.20833333333333334in"} is deleted:

![](media/image789.wmf){width="1.5104166666666667in"
height="0.20833333333333334in"} (1009)

where ![](media/image790.wmf){width="0.14583333333333334in"
height="0.14583333333333334in"} is the real valued TCX spectrum after
applying TNS and ![](media/image791.wmf){width="0.125in"
height="0.13541666666666666in"} is the current TCX window length.

In case the TCX power spectrum
![](media/image792.wmf){width="0.14583333333333334in"
height="0.14583333333333334in"} is available, calculate:

![](media/image793.wmf){width="1.5694444444444444in" height="0.5in"}
(1010)

where ![](media/image794.wmf){width="0.25in"
height="0.20833333333333334in"} is the first spectral line in IGF range
and ![](media/image795.wmf){width="0.2638888888888889in"
height="0.2361111111111111in"} is 1.0 for 9.6 and 13.2 kbit/s SWB and
2.0 for all other configurations.

Given ![](media/image796.wmf){width="0.2875in"
height="0.20972222222222223in"}, apply the following algorithm:

Initialize ![](media/image797.wmf){width="0.225in"
height="0.1736111111111111in"} and
![](media/image798.wmf){width="0.30277777777777776in"
height="0.14652777777777778in"}:

![](media/image799.wmf){width="0.8694444444444445in"
height="0.19166666666666668in"}

![](media/image800.wmf){width="1.9555555555555555in"
height="0.4076388888888889in"}

for (i = ![](media/image801.wmf){width="0.21597222222222223in"
height="0.16458333333333333in"}; i \<
![](media/image802.wmf){width="0.4618055555555556in"
height="0.18263888888888888in"} ; i++) {

if (![](media/image803.wmf){width="0.5819444444444445in"
height="0.19166666666666668in"}) {

![](media/image804.wmf){width="0.6263888888888889in"
height="0.20972222222222223in"}

![](media/image805.wmf){width="0.6506944444444445in"
height="0.20972222222222223in"}

![](media/image806.wmf){width="0.5125in" height="0.16458333333333333in"}

} else if(![](media/image807.wmf){width="0.6506944444444445in"
height="0.20972222222222223in"}) {

![](media/image808.wmf){width="0.8006944444444445in"
height="0.20972222222222223in"}

![](media/image809.wmf){width="0.6506944444444445in"
height="0.20972222222222223in"}

![](media/image810.wmf){width="0.8006944444444445in"
height="0.20972222222222223in"}

}

}

if ![](media/image811.wmf){width="1.0944444444444446in"
height="0.20972222222222223in"}, set
![](media/image812.wmf){width="0.9027777777777778in"
height="0.20972222222222223in"}

##### 5.3.3.2.11.6 IGF spectral flatness calculation {#igf-spectral-flatness-calculation .H6}

Table 98: Number of tiles
![](media/image813.wmf){width="0.2604166666666667in"
height="0.20069444444444445in"} and tile width
![](media/image814.wmf){width="0.30277777777777776in"
height="0.20069444444444445in"}

  ------------ ------ -------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------
  Bitrate      Mode   ![](media/image815.wmf){width="0.2513888888888889in" height="0.16458333333333333in"}   ![](media/image816.wmf){width="0.2513888888888889in" height="0.16458333333333333in"}
  9.6 kbps     WB     2                                                                                      ![](media/image817.wmf){width="1.2083333333333333in" height="0.20972222222222223in"}
  9.6 kbps     SWB    3                                                                                      ![](media/image818.wmf){width="1.7486111111111111in" height="0.19166666666666668in"}
  13.2 kbps    SWB    2                                                                                      ![](media/image819.wmf){width="1.2083333333333333in" height="0.20972222222222223in"}
  16.4 kbps    SWB    3                                                                                      ![](media/image820.wmf){width="1.7638888888888888in" height="0.20972222222222223in"}
  24.4 kbps    SWB    3                                                                                      ![](media/image821.wmf){width="1.7638888888888888in" height="0.20972222222222223in"}
  32.2 kbps    SWB    3                                                                                      ![](media/image822.wmf){width="1.7638888888888888in" height="0.20972222222222223in"}
  48.0 kbps    SWB    1                                                                                      ![](media/image823.wmf){width="0.6506944444444445in" height="0.20972222222222223in"}
  16.4 kbps    FB     3                                                                                      ![](media/image824.wmf){width="1.7638888888888888in" height="0.20972222222222223in"}
  24.4 kbps    FB     4                                                                                      ![](media/image825.wmf){width="2.321527777777778in" height="0.20972222222222223in"}
  32.0 kbps    FB     4                                                                                      ![](media/image826.wmf){width="2.321527777777778in" height="0.20972222222222223in"}
  48.0 kbps    FB     1                                                                                      ![](media/image827.wmf){width="0.6506944444444445in" height="0.20972222222222223in"}
  96.0 kbps    FB     1                                                                                      ![](media/image828.wmf){width="0.6506944444444445in" height="0.20972222222222223in"}
  128.0 kbps   FB     1                                                                                      ![](media/image829.wmf){width="0.6506944444444445in" height="0.20972222222222223in"}
  ------------ ------ -------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------

For the IGF spectral flatness calculation two static
arrays,![](media/image830.wmf){width="0.5486111111111112in"
height="0.20069444444444445in"} and
![](media/image831.wmf){width="0.5125in"
height="0.20069444444444445in"}, both of size
![](media/image832.wmf){width="0.21597222222222223in"
height="0.16458333333333333in"}are needed to hold filter-states over
frames. Additionally a static flag
![](media/image833.wmf){width="0.8006944444444445in"
height="0.16458333333333333in"}is needed to save the information of the
input flag ![](media/image834.wmf){width="0.6777777777777778in"
height="0.16458333333333333in"} from the previous frame.

##### 5.3.3.2.11.6.1 Resetting filter states {#resetting-filter-states .H6}

The vectors ![](media/image835.wmf){width="0.5486111111111112in"
height="0.19166666666666668in"} and
![](media/image836.wmf){width="0.5034722222222222in"
height="0.19166666666666668in"} are both static arrays of size
![](media/image837.wmf){width="0.225in" height="0.14652777777777778in"}
in the IGF module and both arrays are initialised with zeroes:

![](media/image838.wmf){width="2.1479166666666667in"
height="0.43472222222222223in"} (1011)

This initialisation shall be done

-   with codec start up

-   with any bitrate switch

-   with any codec type switch

-   with a transition from CELP to TCX, e.g.
    ![](media/image839.wmf){width="1.1909722222222223in"
    height="0.20972222222222223in"}

-   if the current frame has transient properties,
    e.g.![](media/image840.wmf){width="1.0618055555555554in"
    height="0.16458333333333333in"}

##### 5.3.3.2.11.6.2 Resetting current whitening levels {#resetting-current-whitening-levels .H6}

The vector ![](media/image841.wmf){width="0.7319444444444444in"
height="0.16458333333333333in"} shall be initialised with zero for all
tiles,

![](media/image842.wmf){width="2.0875in" height="0.20972222222222223in"}
(1012)

-   with codec start up

-   with any bitrate switch

-   with any codec type switch

-   with a transition from CELP to TCX, e.g.
    ![](media/image839.wmf){width="1.1909722222222223in"
    height="0.20972222222222223in"}

##### 5.3.3.2.11.6.3 Calculation of spectral flatness indices {#calculation-of-spectral-flatness-indices .H6}

The following steps 1) to 4) shall be executed consecutive:

1)  Update previous level buffers and initialize current levels:

![](media/image843.wmf){width="2.6006944444444446in"
height="0.35694444444444445in"} (1013)

> In case ![](media/image844.wmf){width="0.9569444444444445in"
> height="0.19166666666666668in"} or
> ![](media/image845.wmf){width="0.6777777777777778in"
> height="0.15555555555555556in"} is true, apply

![](media/image846.wmf){width="2.189583333333333in"
height="0.20972222222222223in"} (1014)

> else, if the power spectrum
> ![](media/image847.wmf){width="0.14652777777777778in"
> height="0.14652777777777778in"} is available, calculate

![](media/image848.wmf){width="3.191666666666667in"
height="0.4166666666666667in"} (1015)

> with

![](media/image849.wmf){width="2.303472222222222in"
height="0.4166666666666667in"} (1016)

> where ![](media/image850.wmf){width="0.34791666666666665in"
> height="0.16458333333333333in"} is a spectral flatness measurement
> function, described in subclause 5.3.3.2.11.1.3 and
> ![](media/image851.wmf){width="0.48541666666666666in"
> height="0.16458333333333333in"} is a crest-factor function described
> in subclause 5.3.3.2.11.1.4.
>
> Calculate:

![](media/image852.wmf){width="2.9819444444444443in"
height="0.42569444444444443in"} (1017)

> After calculation of the vector
> ![](media/image853.wmf){width="0.2604166666666667in"
> height="0.20972222222222223in"}, the filter states are updated with:

![](media/image854.wmf){width="2.189583333333333in"
height="0.6263888888888889in"} (1018)

2)  A mapping function
    ![](media/image855.wmf){width="0.9388888888888889in"
    height="0.19166666666666668in"} is applied to the calculated values
    to obtain a whitening level index vector
    ![](media/image856.wmf){width="0.7229166666666667in"
    height="0.19166666666666668in"} The mapping function
    ![](media/image857.wmf){width="0.9388888888888889in"
    height="0.20069444444444445in"} is described in subclause
    5.3.3.2.11.1.5.

![](media/image858.wmf){width="2.6006944444444446in"
height="0.20972222222222223in"} (1019)

3)  With selected modes, see table 99, apply the following final
    mapping:

![](media/image859.wmf){width="2.339583333333333in"
height="0.20069444444444445in"} (1020)

Table 99: modes for step 4) mapping

  ------------ ------ ---------
  Bitrate      mode   mapping
  9.6 kbps     WB     apply
  9.6 kbps     SWB    apply
  13.2 kbps    SWB    NOP
  16.4 kbps    SWB    apply
  24.4 kbps    SWB    apply
  32.2 kbps    SWB    apply
  48.0 kbps    SWB    NOP
  16.4 kbps    FB     apply
  24.4 kbps    FB     apply
  32.0 kbps    FB     apply
  48.0 kbps    FB     NOP
  96.0 kbps    FB     NOP
  128.0 kbps   FB     NOP
  ------------ ------ ---------

After executing step 4) the whitening level index vector
![](media/image860.wmf){width="0.7229166666666667in"
height="0.19166666666666668in"} is ready for transmission.

##### 5.3.3.2.11.6.4 Coding of IGF whitening levels {#coding-of-igf-whitening-levels .H6}

IGF whitening levels, defined in the vector
![](media/image861.wmf){width="0.7048611111111112in"
height="0.19166666666666668in"}, are transmitted using 1 or 2 bits per
tile. The exact number of total bits required depends on the actual
values contained in ![](media/image862.wmf){width="0.7048611111111112in"
height="0.19166666666666668in"} and the value of the
![](media/image863.wmf){width="0.4618055555555556in"
height="0.20972222222222223in"} flag. The detailed processing is
described in the pseudo code below:

![](media/image864.wmf){width="0.44375in"
height="0.16458333333333333in"} = 1;

nTiles = ![](media/image865.wmf){width="0.21597222222222223in"
height="0.16458333333333333in"};

k = 0;

if (![](media/image866.wmf){width="0.5909722222222222in"
height="0.20972222222222223in"}

![](media/image867.wmf){width="0.44375in"
height="0.16458333333333333in"} = 0;

} else {

for (k = 0; k \< nTiles ; k++) {

if (![](media/image868.wmf){width="0.8604166666666667in"
height="0.20972222222222223in"} !=
![](media/image869.wmf){width="0.8875in"
height="0.20972222222222223in"}) {

![](media/image870.wmf){width="0.44375in"
height="0.16458333333333333in"} = 0;

break;

}

}

}

if (![](media/image871.wmf){width="0.44375in"
height="0.16458333333333333in"}) {

write\_bit(1);

} else {

if (!![](media/image872.wmf){width="0.4527777777777778in"
height="0.20972222222222223in"}) {

write\_bit(0);

}

encode\_whitening\_level(![](media/image873.wmf){width="0.8513888888888889in"
height="0.20972222222222223in"});

for (k = 1; k \< nTiles ; k++) {

![](media/image874.wmf){width="0.44375in"
height="0.16458333333333333in"} = 1;

if (![](media/image875.wmf){width="0.8604166666666667in"
height="0.20972222222222223in"} !=
![](media/image876.wmf){width="1.0527777777777778in"
height="0.20972222222222223in"}) {

![](media/image877.wmf){width="0.44375in"
height="0.16458333333333333in"} = 0;

break;

}

}

if (!![](media/image878.wmf){width="0.5125in"
height="0.19166666666666668in"}) {

write\_bit(1);

for (k = 1; k \< nTiles ; k++) {

encode\_whitening\_level(![](media/image879.wmf){width="0.8604166666666667in"
height="0.20972222222222223in"});

}

} else {

write\_bit(0);

}

}

wherein the vector ![](media/image880.wmf){width="0.7319444444444444in"
height="0.20972222222222223in"} contains the whitening
levels![](media/image881.wmf){width="5.9722222222222225e-2in"
height="5.9722222222222225e-2in"}from the previous frame and the
function encode\_whitening\_level takes care of the actual mapping of
the whitening level ![](media/image882.wmf){width="0.8604166666666667in"
height="0.20972222222222223in"}to a binary code. The function is
implemented according to the pseudo code below:

if (![](media/image883.wmf){width="1.304861111111111in"
height="0.20972222222222223in"}

write\_bit(0);

} else {

write\_bit(1);

if (![](media/image884.wmf){width="1.3465277777777778in"
height="0.20972222222222223in"}

write\_bit(0);

} else {

write\_bit(1);

}

}

##### 5.3.3.2.11.7 IGF temporal flatness indicator {#igf-temporal-flatness-indicator .H6}

The temporal envelope of the reconstructed signal by the IGF is
flattened on the receiver (RX) side according to the transmitted
information on the temporal envelope flatness, which is an IGF flatness
indicator.

The temporal flatness is measured as the linear prediction gain in the
frequency domain. Firstly, the linear prediction of the real part of the
current TCX spectrum is performed and then the prediction gain
![](media/image885.wmf){width="0.2604166666666667in"
height="0.2513888888888889in"} is calculated:

![](media/image886.wmf){width="1.0944444444444446in"
height="0.6958333333333333in"} (1021)

where ![](media/image887.wmf){width="0.14652777777777778in"
height="0.20972222222222223in"} = *i*-th PARCOR coefficient obtained by
the linear prediction.

From the prediction gain
![](media/image888.wmf){width="0.2604166666666667in"
height="0.2513888888888889in"} and the prediction gain
![](media/image889.wmf){width="0.2604166666666667in"
height="0.20972222222222223in"} described in subclause 5.3.3.2.2.3, the
IGF temporal flatness indicator flag
![](media/image890.wmf){width="0.7826388888888889in"
height="0.20972222222222223in"} is defined as

![](media/image891.wmf){width="2.625in" height="0.44375in"} (1022)

##### 5.3.3.2.11.8 IGF noiseless coding {#igf-noiseless-coding .H6}

The IGF scale factor vector
![](media/image892.wmf){width="0.14652777777777778in"
height="0.16458333333333333in"} is noiseless encoded with an arithmetic
coder in order to write an efficient representation of the vector to the
bit stream.

The module uses the common raw arithmetic encoder functions from the
infrastructure, which are provided by the core encoder. The functions
used are ![](media/image893.wmf){width="1.7486111111111111in"
height="0.20972222222222223in"}, which encodes the value
![](media/image894.wmf){width="0.20972222222222223in"
height="0.20069444444444445in"},
![](media/image895.wmf){width="3.3986111111111112in"
height="0.20972222222222223in"}, which encodes
![](media/image896.wmf){width="0.4166666666666667in"
height="0.20069444444444445in"} from an alphabet of 27 symbols
(![](media/image897.wmf){width="1.4604166666666667in"
height="0.20069444444444445in"}) using the cumulative frequency table
![](media/image898.wmf){width="1.575in" height="0.20972222222222223in"},
![](media/image899.wmf){width="1.7638888888888888in"
height="0.20972222222222223in"}, which initializes the arithmetic
encoder, and ![](media/image900.wmf){width="1.8444444444444446in"
height="0.20972222222222223in"}, which finalizes the arithmetic encoder.

##### 5.3.3.2.11.8.1 IGF independency flag {#igf-independency-flag .H6}

The internal state of the arithmetic encoder is reset in case the
![](media/image901.wmf){width="0.7319444444444444in"
height="0.20972222222222223in"} flag has the value
![](media/image902.wmf){width="0.27847222222222223in"
height="0.14652777777777778in"}. This flag may be set to
![](media/image903.wmf){width="0.34791666666666665in"
height="0.20972222222222223in"} only in modes where TCX10 windows (see
table 97) are used for the second frame of two consecutive TCX 10
frames.

##### 5.3.3.2.11.8.2 IGF all-Zero flag {#igf-all-zero-flag .H6}

The IGF all-Zero flag signals that all of the IGF scale factors are
zero:

![](media/image904.wmf){width="2.408333333333333in" height="0.44375in"}
(1023)

The ![](media/image905.wmf){width="0.47638888888888886in"
height="0.20069444444444445in"} flag is written to the bit stream first.
In case the flag is
![](media/image906.wmf){width="0.27847222222222223in"
height="0.14652777777777778in"}, the encoder state is reset and no
further data is written to the bit stream, otherwise the arithmetic
coded scale factor vector
![](media/image907.wmf){width="0.14652777777777778in"
height="0.20069444444444445in"} follows in the bit stream.

##### 5.3.3.2.11.8.3 IGF arithmetic encoding helper functions {#igf-arithmetic-encoding-helper-functions .H6}

##### 5.3.3.2.11.8.3.1 The reset function {#the-reset-function .H6}

The arithmetic encoder states consist of
![](media/image908.wmf){width="0.4673611111111111in"
height="0.20972222222222223in"}, and the
![](media/image909.wmf){width="0.32083333333333336in"
height="0.16458333333333333in"} vector, which represents the value of
the vector ![](media/image910.wmf){width="0.14652777777777778in"
height="0.16458333333333333in"} preserved from the previous frame. When
encoding the vector
![](media/image911.wmf){width="0.14652777777777778in"
height="0.16458333333333333in"}, the value 0 for
![](media/image912.wmf){width="9.583333333333334e-2in"
height="0.14652777777777778in"} means that there is no previous frame
available, therefore
![](media/image913.wmf){width="0.32083333333333336in"
height="0.16458333333333333in"} is undefined and not used. The value 1
for ![](media/image914.wmf){width="9.583333333333334e-2in"
height="0.14652777777777778in"} means that there is a previous frame
available therefore
![](media/image915.wmf){width="0.32083333333333336in"
height="0.16458333333333333in"} has valid data and it is used, this
being the case only in modes where TCX10 windows (see table 97) are used
for the second frame of two consecutive TCX 10 frames. For resetting the
arithmetic encoder state, it is enough to set
![](media/image916.wmf){width="0.30277777777777776in"
height="0.16458333333333333in"}.

If a frame has ![](media/image917.wmf){width="0.7319444444444444in"
height="0.20972222222222223in"} set, the encoder state is reset before
encoding the scale factor vector
![](media/image918.wmf){width="0.14652777777777778in"
height="0.16458333333333333in"}. Note that the combination
![](media/image919.wmf){width="0.30277777777777776in"
height="0.16458333333333333in"} and
![](media/image920.wmf){width="1.163888888888889in"
height="0.20972222222222223in"} is valid, and may happen for the second
frame of two consecutive TCX 10 frames, when the first frame had
![](media/image921.wmf){width="0.6506944444444445in"
height="0.20069444444444445in"}. In this particular case, the frame uses
no context information from the previous frame (the
![](media/image922.wmf){width="0.32083333333333336in"
height="0.16458333333333333in"} vector), because
![](media/image923.wmf){width="0.30277777777777776in"
height="0.16458333333333333in"}, and it is actually encoded as an
independent frame.

##### 5.3.3.2.11.8.3.2 The arith\_encode\_bits function {#the-arith_encode_bits-function .H6}

The ![](media/image924.wmf){width="1.148611111111111in"
height="0.20972222222222223in"} function encodes an unsigned integer
![](media/image925.wmf){width="0.14652777777777778in"
height="0.14652777777777778in"}, of length
![](media/image926.wmf){width="0.34791666666666665in"
height="0.16458333333333333in"} bits, by writing one bit at a time.

arith\_encode\_bits(x, nBits)

{

for (i = nBits - 1; i \>= 0; \--i) {

bit = (x \>\> i) & 1;

ari\_encode\_14bits\_sign(bit);

}

}

##### 5.3.3.2.11.8.3.2 The save and restore encoder state functions {#the-save-and-restore-encoder-state-functions .H6}

Saving the encoder state is achieved using the function
![](media/image927.wmf){width="2.4in" height="0.20069444444444445in"},
which copies ![](media/image928.wmf){width="9.583333333333334e-2in"
height="0.14652777777777778in"} and
![](media/image929.wmf){width="0.32083333333333336in"
height="0.16458333333333333in"} vector into
![](media/image930.wmf){width="0.34791666666666665in"
height="0.16458333333333333in"} and
![](media/image931.wmf){width="0.5819444444444445in"
height="0.20069444444444445in"} vector, respectively. Restoring the
encoder state is done using the complementary function
![](media/image932.wmf){width="2.615972222222222in"
height="0.20069444444444445in"}, which copies back
![](media/image933.wmf){width="0.34791666666666665in"
height="0.16458333333333333in"} and
![](media/image934.wmf){width="0.5819444444444445in"
height="0.20069444444444445in"} vector into
![](media/image935.wmf){width="9.583333333333334e-2in"
height="0.14652777777777778in"} and
![](media/image936.wmf){width="0.32083333333333336in"
height="0.16458333333333333in"} vector, respectively.

##### 5.3.3.2.11.8.4 IGF arithmetic encoding {#igf-arithmetic-encoding .H6}

Please note that the arithmetic encoder should be capable of counting
bits only, e.g., performing arithmetic encoding without writing bits to
the bit stream. If the arithmetic encoder is called with a counting
request, by using the parameter
![](media/image937.wmf){width="0.9895833333333334in"
height="0.20972222222222223in"} set to
![](media/image938.wmf){width="0.34791666666666665in"
height="0.20972222222222223in"}, the internal state of the arithmetic
encoder shall be saved before the call to the top level function
![](media/image939.wmf){width="1.7638888888888888in"
height="0.20069444444444445in"} and restored and after the call, by the
caller. In this particular case, the bits internally generated by the
arithmetic encoder are not written to the bit stream.

The ![](media/image940.wmf){width="1.4159722222222222in"
height="0.20972222222222223in"} function encodes the integer valued
prediction residual
![](media/image941.wmf){width="0.14652777777777778in"
height="0.14652777777777778in"}, using the cumulative frequency table
![](media/image942.wmf){width="1.575in" height="0.20972222222222223in"},
and the table offset
![](media/image943.wmf){width="0.6506944444444445in"
height="0.20972222222222223in"}. The table offset
![](media/image944.wmf){width="0.6506944444444445in"
height="0.20972222222222223in"} is used to adjust the value
![](media/image945.wmf){width="0.14652777777777778in"
height="0.14652777777777778in"} before encoding, in order to minimize
the total probability that a very small or a very large value will be
encoded using escape coding, which slightly is less efficient. The
values which are between
![](media/image946.wmf){width="1.8868055555555556in"
height="0.20069444444444445in"} and
![](media/image947.wmf){width="1.8in" height="0.20069444444444445in"},
inclusive, are encoded directly using the cumulative frequency table
![](media/image948.wmf){width="1.575in" height="0.20972222222222223in"},
and an alphabet size of
![](media/image949.wmf){width="1.7215277777777778in"
height="0.20069444444444445in"}.

For the above alphabet of SYMBOLS\_IN\_TABLE symbols, the values 0 and
![](media/image950.wmf){width="1.6166666666666667in"
height="0.20069444444444445in"} are reserved as escape codes to indicate
that a value is too small or too large to fit in the default interval.
In these cases, the value
![](media/image951.wmf){width="0.4076388888888889in"
height="0.16458333333333333in"} indicates the position of the value in
one of the tails of the distribution. The value
![](media/image952.wmf){width="0.34791666666666665in"
height="0.14652777777777778in"} is encoded using 4 bits if it is in the
range ![](media/image953.wmf){width="0.5548611111111111in"
height="0.20972222222222223in"}, or using 4 bits with value 15 followed
by extra 6 bits if it is in the range
{15![](media/image954.wmf){width="0.6958333333333333in"
height="0.20972222222222223in"}, or using 4 bits with value 15 followed
by extra 6 bits with value 63 followed by extra 7 bits if it is larger
or equal than ![](media/image955.wmf){width="0.44375in"
height="0.16458333333333333in"}. The last of the three cases is mainly
useful to avoid the rare situation where a purposely constructed
artificial signal may produce an unexpectedly large residual value
condition in the encoder.

arith\_encode\_residual(x, cumulativeFrequencyTable, tableOffset)

{

x += tableOffset;

if ((x \>= MIN\_ENC\_SEPARATE) && (x \<= MAX\_ENC\_SEPARATE)) {

ari\_encode\_14bits\_ext((x - MIN\_ENC\_SEPARATE) + 1,
cumulativeFrequencyTable);

return;

} else if (x \< MIN\_ENC\_SEPARATE) {

extra = (MIN\_ENC\_SEPARATE - 1) - x;

ari\_encode\_14bits\_ext(0, cumulativeFrequencyTable);

} else { /\* x \> MAX\_ENC\_SEPARATE \*/

extra = x - (MAX\_ENC\_SEPARATE + 1);

ari\_encode\_14bits\_ext(SYMBOLS\_IN\_TABLE - 1,
cumulativeFrequencyTable);

}

if (extra \< 15) {

arith\_encode\_bits(extra, 4);

} else { /\* extra \>= 15 \*/

arith\_encode\_bits(15, 4);

extra -= 15;

if (extra \< 63) {

arith\_encode\_bits(extra, 6);

} else { /\* extra \>= 63 \*/

arith\_encode\_bits(63, 6);

extra -= 63;

arith\_encode\_bits(extra, 7);

}

}

}

The function ![](media/image956.wmf){width="1.1909722222222223in"
height="0.20972222222222223in"} encodes the scale factor vector
![](media/image957.wmf){width="0.14652777777777778in"
height="0.16458333333333333in"}, which consists of
![](media/image958.wmf){width="0.20972222222222223in"
height="0.16458333333333333in"} integer values. The value
![](media/image959.wmf){width="9.583333333333334e-2in"
height="0.14652777777777778in"} and the
![](media/image960.wmf){width="0.32083333333333336in"
height="0.16458333333333333in"} vector, which constitute the encoder
state, are used as additional parameters for the function. Note that the
top level function ![](media/image961.wmf){width="1.7548611111111112in"
height="0.20069444444444445in"} must call the common arithmetic encoder
initialization function
![](media/image962.wmf){width="1.676388888888889in"
height="0.20972222222222223in"} before calling the function
![](media/image963.wmf){width="1.1909722222222223in"
height="0.20972222222222223in"}, and also call the arithmetic encoder
finalization function
![](media/image964.wmf){width="1.6944444444444444in"
height="0.20972222222222223in"} afterwards.

The function ![](media/image965.wmf){width="0.6506944444444445in"
height="0.20069444444444445in"} is used to quantize a context value
![](media/image966.wmf){width="0.21597222222222223in"
height="0.14652777777777778in"}, by limiting it to
![](media/image967.wmf){width="0.5548611111111111in"
height="0.20972222222222223in"}, and it is defined as:

quant\_ctx(ctx)

{

if (abs(ctx) \<= 3) {

return ctx;

} else if (ctx \> 3) {

return 3;

} else { /\* ctx \< -3 \*/

return -3;

}

}

The definitions of the symbolic names indicated in the comments from the
pseudo code, used for computing the context values, are listed in the
following table 100:

Table 100: Definition of symbolic names

  -------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------------------------------
  the previous frame (when available)                                                    the current frame
  ![](media/image968.wmf){width="0.6958333333333333in" height="0.20972222222222223in"}   ![](media/image969.wmf){width="0.5486111111111112in" height="0.20972222222222223in"} (the value to be coded)
  ![](media/image970.wmf){width="0.8513888888888889in" height="0.20972222222222223in"}   ![](media/image971.wmf){width="0.6777777777777778in" height="0.20972222222222223in"} (when available)
                                                                                         ![](media/image972.wmf){width="0.6958333333333333in" height="0.20972222222222223in"} (when available)
  -------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------------------------------

encode\_sfe\_vector(t, prev, g, nB)

for (f = 0; f \< nB; f++) {

if (t == 0) {

if (f == 0) {

ari\_encode\_14bits\_ext(g\[f\] \>\> 2, cf\_se00);

arith\_encode\_bits(g\[f\] & 3, 2); /\* LSBs as 2 bit raw \*/

}

else if (f == 1) {

pred = g\[f - 1\]; /\* pred = b \*/

arith\_encode\_residual(g\[f\] - pred, cf\_se01, cf\_off\_se01);

} else { /\* f \>= 2 \*/

pred = g\[f - 1\]; /\* pred = b \*/

ctx = quant\_ctx(g\[f - 1\] - g\[f - 2\]); /\* Q(b - e) \*/

arith\_encode\_residual(g\[f\] - pred, cf\_se02\[CTX\_OFFSET + ctx)\],

cf\_off\_se02\[IGF\_CTX\_OFFSET + ctx\]);

}

}

else { /\* t == 1 \*/

if (f == 0) {

pred = prev\[f\]; /\* pred = a \*/

arith\_encode\_residual(x\[f\] - pred, cf\_se10, cf\_off\_se10);

} else { /\* (t == 1) && (f \>= 1) \*/

pred = prev\[f\] + g\[f - 1\] - prev\[f - 1\]; /\* pred = a + b - c \*/

ctx\_f = quant\_ctx(prev\[f\] - prev\[f - 1\]); /\* Q(a - c) \*/

ctx\_t = quant\_ctx(g\[f - 1\] - prev\[f - 1\]); /\* Q(b - c) \*/

arith\_encode\_residual(g\[f\] - pred,

cf\_se11\[CTX\_OFFSET + ctx\_t\]\[CTX\_OFFSET + ctx\_f)\],

cf\_off\_se11\[CTX\_OFFSET + ctx\_t\]\[CTX\_OFFSET + ctx\_f\]);

}

}

}

}

There are five cases in the above function, depending on the value of
![](media/image973.wmf){width="9.583333333333334e-2in"
height="0.16458333333333333in"} and also on the position
![](media/image974.wmf){width="0.14652777777777778in"
height="0.20972222222222223in"} of a value in the vector
![](media/image975.wmf){width="0.14652777777777778in"
height="0.16458333333333333in"}:

-   when ![](media/image976.wmf){width="0.30277777777777776in"
    height="0.16458333333333333in"} and
    ![](media/image977.wmf){width="0.3659722222222222in"
    height="0.20972222222222223in"}, the first scalefactor of an
    independent frame is coded, by splitting it into the most
    significant bits which are coded using the cumulative frequency
    table ![](media/image978.wmf){width="0.5548611111111111in"
    height="0.20972222222222223in"}, and the least two significant bits
    coded directly.

-   when ![](media/image979.wmf){width="0.30277777777777776in"
    height="0.16458333333333333in"} and
    ![](media/image980.wmf){width="0.34791666666666665in"
    height="0.20972222222222223in"}, the second scale factor of an
    independent frame is coded (as a prediction residual) using the
    cumulative frequency table
    ![](media/image981.wmf){width="0.5486111111111112in"
    height="0.20972222222222223in"}.

-   when ![](media/image982.wmf){width="0.30277777777777776in"
    height="0.16458333333333333in"} and
    ![](media/image983.wmf){width="0.3659722222222222in"
    height="0.20972222222222223in"}, the third and following scale
    factors of an independent frame are coded (as prediction residuals)
    using the cumulative frequency table
    ![](media/image984.wmf){width="1.8in"
    height="0.20972222222222223in"}, determined by the quantized context
    value ![](media/image985.wmf){width="0.21597222222222223in"
    height="0.14652777777777778in"}.

-   when ![](media/image986.wmf){width="0.27847222222222223in"
    height="0.16458333333333333in"} and
    ![](media/image987.wmf){width="0.3659722222222222in"
    height="0.20972222222222223in"}, the first scalefactor of a
    dependent frame is coded (as a prediction residual) using the
    cumulative frequency table
    ![](media/image988.wmf){width="0.5486111111111112in"
    height="0.20972222222222223in"}.

-   when ![](media/image989.wmf){width="0.27847222222222223in"
    height="0.16458333333333333in"} and
    ![](media/image990.wmf){width="0.34791666666666665in"
    height="0.20972222222222223in"}, the second and following scale
    factors of a dependent frame are coded (as prediction residuals)
    using the cumulative frequency table
    ![](media/image991.wmf){width="3.4763888888888888in"
    height="0.20972222222222223in"} determined by the quantized context
    values ![](media/image992.wmf){width="0.375in"
    height="0.20069444444444445in"} and
    ![](media/image993.wmf){width="0.44375in"
    height="0.20972222222222223in"}.

Please note that the predefined cumulative frequency tables
![](media/image994.wmf){width="0.5486111111111112in"
height="0.20972222222222223in"},
![](media/image995.wmf){width="0.5548611111111111in"
height="0.20972222222222223in"}, and the table offsets
![](media/image996.wmf){width="0.8423611111111111in"
height="0.20972222222222223in"},
![](media/image997.wmf){width="0.8513888888888889in"
height="0.20972222222222223in"} depend on the current operating point
and implicitly on the bitrate, and are selected from the set of
available options during initialization of the encoder for each given
operating point. The cumulative frequency table
![](media/image998.wmf){width="0.5548611111111111in"
height="0.20972222222222223in"} is common for all operating points, and
cumulative frequency tables
![](media/image999.wmf){width="0.5486111111111112in"
height="0.20972222222222223in"} and
![](media/image1000.wmf){width="0.5486111111111112in"
height="0.20972222222222223in"}, and the corresponding table offsets
![](media/image1001.wmf){width="0.8423611111111111in"
height="0.20972222222222223in"} and
![](media/image1002.wmf){width="0.8333333333333334in"
height="0.20972222222222223in"} are also common, but they are used only
for operating points corresponding to bitrates larger or equal than 48
kbps, in case of dependent TCX 10 frames (when
![](media/image1003.wmf){width="0.27847222222222223in"
height="0.16458333333333333in"}).

##### 5.3.3.2.11.9 IGF bit stream writer {#igf-bit-stream-writer .H6}

The arithmetic coded IGF scale factors, the IGF whitening levels and the
IGF temporal flatness indicator are consecutively transmitted to the
decoder side via bit stream. The coding of the IGF scale factors is
described in subclause 5.3.3.2.11.8.4. The IGF whitening levels are
encoded as presented in subclause 5.3.3.2.11.6.4. Finally the IGF
temporal flatness indicator flag, represented as one bit, is written to
the bit stream.

In case of a TCX20 frame, i.e.
(![](media/image1004.wmf){width="0.9388888888888889in"
height="0.16458333333333333in"}), and no counting request is signalled
to the bit stream writer, the output of the bit stream writer is fed
directly to the bit stream. In case of a TCX10 frame
(![](media/image1005.wmf){width="0.9027777777777778in"
height="0.16458333333333333in"}), where two sub-frames are coded
dependently within one 20ms frame, the output of the bit stream writer
for each sub-frame is written to a temporary buffer, resulting in a bit
stream containing the output of the bit stream writer for the individual
sub-frames. The content of this temporary buffer is finally written to
the bit stream.

##### 5.3.3.2.12 Memory updates

##### 5.3.3.2.12.1 Internal decoder {#internal-decoder .H6}

Subsequent to the MDCT based TCX encoding, a simplified decoding at
![](media/image1006.wmf){width="0.3388888888888889in"
height="0.2604166666666667in"} is performed to enable and update the
filter memories for CELP coding. Based on the quantized MDCT spectral
coefficients, the following decoding steps are performed:

-   Adaptive low frequency deemphasis (subclause 6.2.2.3.2)

-   Global gain decoding (subclause 6.2.2.3.3)

-   Residual dequantizer (subclause 6.2.2.3.4)

-   Formant enhancement (subclause 6.2.2.3.5)

-   Noise filling (subclause 6.2.2.3.6)

-   Application of global gain and LPC shaping in MDCT domain (subclause
    6.2.2.3.7)

-   Inverse window grouping (subclause 6.2.2.3.9)

-   Temporal noise shaping (subclause 6.2.2.3.10)

The resulting MDCT spectrum is transformed to a time-domain signal at
![](media/image1007.wmf){width="0.34791666666666665in"
height="0.23333333333333334in"} using the corresponding
frequency-to-time transformation, as described in subclause 6.2.4,
resulting in the synthesized TCX decoder output
![](media/image1008.wmf){width="0.7229166666666667in"
height="0.21597222222222223in"}.

##### 5.3.3.2.12.2 Update of filter memories {#update-of-filter-memories .H6}

The updating of the states of the
filter![](media/image1009.wmf){width="1.1729166666666666in"
height="0.23333333333333334in"} is performed by applying the
perceptually weighted LPC coefficients on the synthesized TCX decoder
output ![](media/image1010.wmf){width="0.7229166666666667in"
height="0.21597222222222223in"} and subtract this from the perceptually
weighted speech signal
![](media/image1011.wmf){width="0.38958333333333334in"
height="0.20972222222222223in"} The LPC coefficients
![](media/image1012.wmf){width="0.16458333333333333in"
height="0.2513888888888889in"}correspond to the 4^th^ subframe for
![](media/image1013.wmf){width="0.9388888888888889in"
height="0.23333333333333334in"}and to the 5^th^ subframe for
![](media/image1014.wmf){width="0.9569444444444445in"
height="0.23333333333333334in"}

![](media/image1015.wmf){width="4.322916666666667in"
height="0.5034722222222222in"} (1024)

The pre-emphasis-filter ![](media/image1016.wmf){width="1.425in"
height="0.27847222222222223in"} is applied to
![](media/image1017.wmf){width="0.7229166666666667in"
height="0.21597222222222223in"} for updating the synthesis buffers used
in the target signal computation to calculate the residual signal
![](media/image1018.wmf){width="0.2875in"
height="0.20972222222222223in"}( subclause 5.2.3.1.2), and for LPC
synthesis filter states used in the CELP encoder. For updating the
filter states of LP residual signal computation, the pre-emphasized
synthesis buffer is filtered by the quantized LPC coefficients (see
subclause 5.2.3.1.1).

##### 5.3.3.2.13 Global Gain Adjuster

For bitrates less than 13.2 kbps the optimum global gain
![](media/image1019.wmf){width="0.2875in"
height="0.23333333333333334in"} is partially recomputed after noise
filling and formant enhancement have been applied in the internal
decoder:

![](media/image1020.wmf){width="1.7395833333333333in"
height="1.163888888888889in"} (1025)

The new global gain ![](media/image1021.wmf){width="0.2875in"
height="0.23333333333333334in"} is quantized again for transmission in
the bit stream to an index
![](media/image1022.wmf){width="0.2604166666666667in"
height="0.23333333333333334in"}, replacing the previously computed one.

### 5.3.4 High Quality MDCT coder (HQ)

#### 5.3.4.1 Low-rate HQ coder

The structure of the Low-rate HQ MDCT core coder is presented in figure
65. Encoding is performed in the MDCT domain. Based on the input signal
bandwidth, operational bitrates and signal characteristics the coding
modes are decided. For example, an input signal with the sampling
frequency of 32 kHz or 48 kHz with operational bitrates of 13.2 kbps and
16.4 kbps will be encoded using any one of the three alternative modes:
Transient mode, Normal mode, and Harmonic mode. For an input signal with
sampling frequency of 8 kHz or 16 kHz, the tonality estimation block is
not used, so the input signal is either encoded under Transient or
Normal mode. The mode classification decision is described in subclause
5.3.4.1.1. The following table 101 summarizes the supported modes per
bit rate and bandwidth. Mode information (one bit for
Transient/non-Transient, and one bit for Normal/Harmonic) is encoded and
transmitted to the decoder side.

Table 101: Supported modes for low-rate HQ coder

  ------------------ ----------- -----------------------------
  Bitrate \[kbps\]   Bandwidth   Supported modes
  7.2, 8             NB          Normal, Transient
  13.2, 16.4         NB, WB      Normal, Transient
                     SWB         Normal, Transient, Harmonic
  ------------------ ----------- -----------------------------

Based on the mode, the obtained spectral coefficients are grouped into
bands of unequal lengths. The energy of each band is estimated and the
resulting spectral envelope consisting of the energies of all bands is
quantized and encoded using Huffman coding. The quantized energies are
used as input for bit allocation. The spectral coefficients are
quantized using TCQ and USQ and encoded based on the allocated bits for
each frequency band. The encoded spectral coefficients are adjusted
using the quantized energies. The level of the most significant spectral
coefficients is adjusted using an estimated gain which is coded and
transmitted to the decoder. The spectral bands which are not quantized
in the HF region are identified and coded with relatively few bits using
the quantized spectral coefficients information.

The parameters transmitted from encoder to decoder are the mode
selection, energy envelope information, the quanitzed spectral
coefficients, LF and the HF parameters.

![](media/image1023.png){width="5.697916666666667in"
height="2.0277777777777777in"}

Figure 65: Structural block diagram of the Low-rate HQ coder

##### 5.3.4.1.1 Tonality Estimation

Non transient mode is referred as Normal mode for NB and WB inputs,
whereas for SWB and FB inputs at 13.2 and 16.4 kbps, Non-transient
signals are further classified as Normal and Harmonic mode. The detailed
description for Normal and Harmonic mode classification is as follows,

448 MDCT coefficients in the 2400-13600 Hz frequency range are used in
order to perform this classification. 14 sub-bands are split, which is
equally 32 coefficients per sub-band. The frequency sharpness
![](media/image1024.wmf){width="0.5548611111111111in"
height="0.19166666666666668in"} is defined as the ratio between the peak
and the average magnitudes in each sharpness band:

![](media/image1025.wmf){width="3.6444444444444444in"
height="1.0527777777777778in"} (1026)

where the peak magnitude of spectral coefficients in a sharpness band,
denoted![](media/image1026.wmf){width="0.5395833333333333in"
height="0.20972222222222223in"}, is:

![](media/image1027.wmf){width="2.834722222222222in"
height="0.32083333333333336in"} (1027)

The counter ![](media/image1028.wmf){width="0.5125in"
height="0.23333333333333334in"} denotes the number of sub-bands which
have harmonic characteristics corresponding to the first 5 sub-bands.
![](media/image1029.wmf){width="0.5125in"
height="0.23333333333333334in"} is initialized to zero and increased by
one if ![](media/image1030.wmf){width="1.5833333333333333in"
height="0.19166666666666668in"}. The counter
![](media/image1031.wmf){width="0.5305555555555556in"
height="0.23333333333333334in"} denotes the number of sub-band which
have harmonic characteristics corresponding to the remaining 9
sub-bands. ![](media/image1032.wmf){width="0.48541666666666666in"
height="0.2604166666666667in"} is initialized to zero and increased by
one if ![](media/image1033.wmf){width="0.8784722222222222in"
height="0.20972222222222223in"} and
![](media/image1034.wmf){width="1.5208333333333333in"
height="0.20972222222222223in"}.

The mode counters ![](media/image1035.wmf){width="0.7229166666666667in"
height="0.19166666666666668in"} and
![](media/image1036.wmf){width="0.7736111111111111in"
height="0.19166666666666668in"} are introduced for harmonic mode
detection and are initialized to zero.
![](media/image1037.wmf){width="0.7229166666666667in"
height="0.20972222222222223in"} is increased by one and
![](media/image1036.wmf){width="0.7736111111111111in"
height="0.19166666666666668in"} is decreased by one if
![](media/image1038.wmf){width="1.3319444444444444in"
height="0.23333333333333334in"} and
![](media/image1039.wmf){width="0.7229166666666667in"
height="0.23333333333333334in"}. Otherwise, the mode counter
![](media/image1040.wmf){width="0.7229166666666667in"
height="0.20972222222222223in"} is decreased by one and
![](media/image1041.wmf){width="0.7736111111111111in"
height="0.19166666666666668in"} is increased by one.
![](media/image1037.wmf){width="0.7229166666666667in"
height="0.20972222222222223in"} and
![](media/image1036.wmf){width="0.7736111111111111in"
height="0.19166666666666668in"} are constrained to only hold values
between 0 and 8. The calculations of
![](media/image1037.wmf){width="0.7229166666666667in"
height="0.20972222222222223in"} and
![](media/image1036.wmf){width="0.7736111111111111in"
height="0.19166666666666668in"} are summarized as follows,

![](media/image1042.wmf){width="6.035416666666666in"
height="0.9118055555555555in"} (1028)

The current frame mode is classified as harmonic if
![](media/image1043.wmf){width="0.9659722222222222in"
height="0.20972222222222223in"},
![](media/image1044.wmf){width="1.3319444444444444in"
height="0.23333333333333334in"} and
![](media/image1045.wmf){width="0.7229166666666667in"
height="0.23333333333333334in"}; or if
![](media/image1046.wmf){width="0.9298611111111111in"
height="0.20972222222222223in"}.

##### 5.3.4.1.2 Grouping of spectral coefficients

The spectral coefficients are divided to obtain bands of variable
lengths; the total number of bands varies depending on the signal
bandwidth (NB, WB, SWB, and FB), operational bitrates and the
classifier. Tables 103 to 108 describe the band structure for different
signal bandwidths and operational bitrates. The NB band structure is
used for NB signals, the WB band structure is used for WB signals, and
the SWB band structure is used for SWB and FB signals.

The total number of bands and the corresponding bandwidth used for NB,
WB and SWB is presented in table 102. The band structure and the number
of bands for FB are same as SWB for 13.2 and 16.4 kbps.

In case of the Transient mode, the coefficients of the equivalent four
5-ms transforms are consecutively joined, and the bandwidth varies based
on signal bandwidth. table 103, 104, 105 shows the detailed band
structure for the NB, WB, and SWB (and FB) Transient frames based on the
operational bitrates. In each table, *b* denotes the index of the band,
*k~width~*(*b*) is the corresponding band length, and *k~start~*(*b*)
and *k~end~*(*b*) denote the start and end index of the spectral
coefficients forming the band.

Table 102: Number of bands and its corresponding bandwidth

  --------- ---------------- ----------- ----------------- -----
            Bitrate (kbps)   Nbands      Bandwidth         
                             Transient   Normal/Harmonic   
  NB        7.2, 8           16 (4\*4)   13                160
            13.2             20(4\*5)    19                
  WB        13.2             28(4\*7)    18                320
            16.4                         20                
  SWB, FB   13.2 ,16.4       32(4\*8)    22                568
                                         24                640
  --------- ---------------- ----------- ----------------- -----

Table 103: Band structure for NB Transient frames

  ---- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- ---------------------------------------------------------------------------------------
       Transient mode                                                                                                                                                                                                                                                                                                                                                                                                                              
       7.2,8 kbps                                                                              13.2 kbps                                                                                                                                                                                                                                                                                                                                           
  b    ![](media/image1047.wmf){width="0.5548611111111111in" height="0.20972222222222223in"}   ![](media/image1048.wmf){width="0.5125in" height="0.20972222222222223in"}   ![](media/image1049.wmf){width="0.4527777777777778in" height="0.20972222222222223in"}   ![](media/image1047.wmf){width="0.5548611111111111in" height="0.20972222222222223in"}   ![](media/image1049.wmf){width="0.4527777777777778in" height="0.20972222222222223in"}   ![](media/image1049.wmf){width="0.4527777777777778in" height="0.20972222222222223in"}
  0    6                                                                                       0                                                                           5                                                                                       6                                                                                       0                                                                                       5
  1    8                                                                                       6                                                                           13                                                                                      7                                                                                       6                                                                                       12
  2    11                                                                                      14                                                                          24                                                                                      7                                                                                       13                                                                                      19
  3    15                                                                                      25                                                                          39                                                                                      9                                                                                       20                                                                                      28
  4    6                                                                                       40                                                                          45                                                                                      11                                                                                      29                                                                                      39
  5    8                                                                                       46                                                                          53                                                                                      6                                                                                       40                                                                                      45
  6    11                                                                                      54                                                                          64                                                                                      7                                                                                       46                                                                                      52
  7    15                                                                                      65                                                                          79                                                                                      7                                                                                       53                                                                                      59
  8    6                                                                                       80                                                                          85                                                                                      9                                                                                       60                                                                                      68
  9    8                                                                                       86                                                                          93                                                                                      11                                                                                      69                                                                                      79
  10   11                                                                                      94                                                                          104                                                                                     6                                                                                       80                                                                                      85
  11   15                                                                                      105                                                                         119                                                                                     7                                                                                       86                                                                                      92
  12   6                                                                                       120                                                                         125                                                                                     7                                                                                       93                                                                                      99
  13   8                                                                                       126                                                                         133                                                                                     9                                                                                       100                                                                                     108
  14   11                                                                                      134                                                                         144                                                                                     11                                                                                      109                                                                                     119
  15   15                                                                                      145                                                                         159                                                                                     6                                                                                       120                                                                                     125
  16   \-                                                                                      \-                                                                          \-                                                                                      7                                                                                       126                                                                                     132
  17   \-                                                                                      \-                                                                          \-                                                                                      7                                                                                       133                                                                                     139
  18   \-                                                                                      \-                                                                          \-                                                                                      9                                                                                       140                                                                                     148
  19   \-                                                                                      \-                                                                          \-                                                                                      11                                                                                      149                                                                                     159
  ---- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- ---------------------------------------------------------------------------------------

Table 104: Band structure for WB Transient frames

  ----- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------- ---------------------------------------------------------------------------------------
        Transient mode                                                                                                                                                      
        13.2, 16.4 kbps                                                                                                                                                     
  *b*   ![](media/image1050.wmf){width="0.5548611111111111in" height="0.20972222222222223in"}   ![](media/image1048.wmf){width="0.5125in" height="0.20972222222222223in"}   ![](media/image1049.wmf){width="0.4527777777777778in" height="0.20972222222222223in"}
  0     6                                                                                       0                                                                           5
  1     7                                                                                       6                                                                           12
  2     8                                                                                       13                                                                          20
  3     10                                                                                      21                                                                          30
  4     12                                                                                      31                                                                          42
  5     16                                                                                      43                                                                          58
  6     21                                                                                      59                                                                          79
  7     6                                                                                       80                                                                          85
  8     7                                                                                       86                                                                          92
  9     8                                                                                       93                                                                          100
  10    10                                                                                      101                                                                         110
  11    12                                                                                      111                                                                         122
  12    16                                                                                      123                                                                         138
  13    21                                                                                      139                                                                         159
  14    6                                                                                       160                                                                         165
  15    7                                                                                       166                                                                         172
  16    8                                                                                       173                                                                         180
  17    10                                                                                      181                                                                         190
  18    12                                                                                      191                                                                         202
  19    16                                                                                      203                                                                         218
  20    21                                                                                      219                                                                         239
  21    6                                                                                       240                                                                         245
  22    7                                                                                       246                                                                         252
  23    8                                                                                       253                                                                         260
  24    10                                                                                      261                                                                         270
  25    12                                                                                      271                                                                         282
  26    16                                                                                      283                                                                         298
  27    21                                                                                      299                                                                         319
  ----- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------- ---------------------------------------------------------------------------------------

Table 105: Band structure for SWB, FB Transient frames

  ---------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------- ---------------------------------------------------------------------------------------
  Transient mode                                                                                                                                                                                                                                                                                                                                                                                                                                   
                   13.2 kbps                                                                               16.4 kbps                                                                                                                                                                                                                                                                                                                               
  *b*              ![](media/image1047.wmf){width="0.5548611111111111in" height="0.20972222222222223in"}   ![](media/image1048.wmf){width="0.5125in" height="0.20972222222222223in"}   ![](media/image1049.wmf){width="0.4527777777777778in" height="0.20972222222222223in"}   ![](media/image1047.wmf){width="0.5548611111111111in" height="0.20972222222222223in"}   ![](media/image1048.wmf){width="0.5125in" height="0.20972222222222223in"}   ![](media/image1049.wmf){width="0.4527777777777778in" height="0.20972222222222223in"}
  0                7                                                                                       0                                                                           6                                                                                       8                                                                                       0                                                                           7
  1                8                                                                                       7                                                                           14                                                                                      9                                                                                       15                                                                          8
  2                10                                                                                      15                                                                          24                                                                                      11                                                                                      25                                                                          17
  3                11                                                                                      25                                                                          35                                                                                      13                                                                                      36                                                                          28
  4                15                                                                                      36                                                                          50                                                                                      17                                                                                      51                                                                          41
  5                21                                                                                      51                                                                          71                                                                                      23                                                                                      71                                                                          58
  6                29                                                                                      72                                                                          100                                                                                     32                                                                                      99                                                                          81
  7                41                                                                                      101                                                                         141                                                                                     47                                                                                      140                                                                         113
  8                7                                                                                       142                                                                         148                                                                                     8                                                                                       160                                                                         167
  9                8                                                                                       149                                                                         156                                                                                     9                                                                                       168                                                                         176
  10               10                                                                                      157                                                                         166                                                                                     11                                                                                      177                                                                         187
  11               11                                                                                      167                                                                         177                                                                                     13                                                                                      188                                                                         200
  12               15                                                                                      178                                                                         192                                                                                     17                                                                                      201                                                                         217
  13               21                                                                                      193                                                                         213                                                                                     23                                                                                      218                                                                         240
  14               29                                                                                      214                                                                         242                                                                                     32                                                                                      241                                                                         272
  15               41                                                                                      243                                                                         283                                                                                     47                                                                                      273                                                                         319
  16               7                                                                                       284                                                                         290                                                                                     8                                                                                       320                                                                         327
  17               8                                                                                       291                                                                         298                                                                                     9                                                                                       328                                                                         336
  18               10                                                                                      299                                                                         308                                                                                     11                                                                                      337                                                                         347
  19               11                                                                                      309                                                                         319                                                                                     13                                                                                      348                                                                         360
  20               15                                                                                      320                                                                         334                                                                                     17                                                                                      361                                                                         377
  21               21                                                                                      335                                                                         355                                                                                     23                                                                                      378                                                                         400
  22               29                                                                                      356                                                                         384                                                                                     32                                                                                      401                                                                         432
  23               41                                                                                      385                                                                         425                                                                                     47                                                                                      433                                                                         479
  24               7                                                                                       426                                                                         432                                                                                     8                                                                                       480                                                                         487
  25               8                                                                                       433                                                                         440                                                                                     9                                                                                       488                                                                         496
  26               10                                                                                      441                                                                         450                                                                                     11                                                                                      497                                                                         507
  27               11                                                                                      451                                                                         461                                                                                     13                                                                                      508                                                                         520
  28               15                                                                                      462                                                                         476                                                                                     17                                                                                      521                                                                         537
  29               21                                                                                      477                                                                         497                                                                                     23                                                                                      538                                                                         560
  30               29                                                                                      498                                                                         526                                                                                     32                                                                                      561                                                                         592
  31               41                                                                                      527                                                                         567                                                                                     47                                                                                      593                                                                         639
  ---------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------- ---------------------------------------------------------------------------------------

In the Normal mode of operation, the bands have different sizes that
increase with increasing frequency. This subdivision allows a consistent
representation of the spectrum which closely resembles that of the human
ear. Higher frequency resolution is used for low frequencies, while
lower frequency resolution is used for high frequencies. The detailed
allocation of spectral coefficients to bands for NB, WB, SWB and FB
signals are presented in tables 106, 107, 108

Table 106: Band structure for NB Normal mode frames

  ------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------- ---------------------------------------------------------------------------------------
  Normal mode                                                                                                                                                                                                                                                                                                                                                                                                                                   
                7.2,8 kbps                                                                              13.2 kbps                                                                                                                                                                                                                                                                                                                               
  *b*           ![](media/image1047.wmf){width="0.5548611111111111in" height="0.20972222222222223in"}   ![](media/image1048.wmf){width="0.5125in" height="0.20972222222222223in"}   ![](media/image1049.wmf){width="0.4527777777777778in" height="0.20972222222222223in"}   ![](media/image1047.wmf){width="0.5548611111111111in" height="0.20972222222222223in"}   ![](media/image1048.wmf){width="0.5125in" height="0.20972222222222223in"}   ![](media/image1049.wmf){width="0.4527777777777778in" height="0.20972222222222223in"}
  0             6                                                                                       0                                                                           5                                                                                       6                                                                                       0                                                                           5
  1             6                                                                                       6                                                                           11                                                                                      6                                                                                       6                                                                           11
  2             6                                                                                       12                                                                          17                                                                                      6                                                                                       12                                                                          17
  3             6                                                                                       18                                                                          23                                                                                      6                                                                                       18                                                                          23
  4             7                                                                                       24                                                                          30                                                                                      6                                                                                       24                                                                          29
  5             8                                                                                       31                                                                          38                                                                                      6                                                                                       30                                                                          35
  6             9                                                                                       39                                                                          47                                                                                      7                                                                                       36                                                                          42
  7             10                                                                                      48                                                                          57                                                                                      7                                                                                       43                                                                          49
  8             13                                                                                      58                                                                          70                                                                                      8                                                                                       50                                                                          57
  9             15                                                                                      71                                                                          85                                                                                      8                                                                                       58                                                                          65
  10            19                                                                                      86                                                                          104                                                                                     9                                                                                       66                                                                          74
  11            24                                                                                      105                                                                         128                                                                                     10                                                                                      75                                                                          84
  12            31                                                                                      129                                                                         159                                                                                     11                                                                                      85                                                                          95
  13            \-                                                                                      \-                                                                          \-                                                                                      13                                                                                      96                                                                          108
  14            \-                                                                                      \-                                                                          \-                                                                                      15                                                                                      109                                                                         123
  15            \-                                                                                      \-                                                                          \-                                                                                      17                                                                                      124                                                                         140
  16            \-                                                                                      \-                                                                          \-                                                                                      19                                                                                      141                                                                         159
  ------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------- ---------------------------------------------------------------------------------------

Table 107: Band structure for WB Normal mode frames

  ------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------- ---------------------------------------------------------------------------------------
  Normal mode                                                                                                                                                                                                                                                                                                                                                                                                                                   
                13.2 kbps                                                                               16.4 kbps                                                                                                                                                                                                                                                                                                                               
  *b*           ![](media/image1047.wmf){width="0.5548611111111111in" height="0.20972222222222223in"}   ![](media/image1048.wmf){width="0.5125in" height="0.20972222222222223in"}   ![](media/image1049.wmf){width="0.4527777777777778in" height="0.20972222222222223in"}   ![](media/image1047.wmf){width="0.5548611111111111in" height="0.20972222222222223in"}   ![](media/image1048.wmf){width="0.5125in" height="0.20972222222222223in"}   ![](media/image1049.wmf){width="0.4527777777777778in" height="0.20972222222222223in"}
  0             6                                                                                       0                                                                           5                                                                                       6                                                                                       0                                                                           5
  1             6                                                                                       6                                                                           11                                                                                      6                                                                                       6                                                                           11
  2             6                                                                                       12                                                                          17                                                                                      6                                                                                       12                                                                          17
  3             6                                                                                       18                                                                          23                                                                                      6                                                                                       18                                                                          23
  4             6                                                                                       24                                                                          29                                                                                      6                                                                                       24                                                                          29
  5             7                                                                                       30                                                                          36                                                                                      6                                                                                       30                                                                          35
  6             7                                                                                       37                                                                          43                                                                                      7                                                                                       36                                                                          42
  7             8                                                                                       44                                                                          51                                                                                      8                                                                                       43                                                                          50
  8             10                                                                                      52                                                                          61                                                                                      8                                                                                       51                                                                          58
  9             11                                                                                      62                                                                          72                                                                                      9                                                                                       59                                                                          67
  10            13                                                                                      73                                                                          85                                                                                      11                                                                                      68                                                                          78
  11            16                                                                                      86                                                                          101                                                                                     12                                                                                      79                                                                          90
  12            19                                                                                      102                                                                         120                                                                                     14                                                                                      91                                                                          104
  13            24                                                                                      121                                                                         144                                                                                     17                                                                                      105                                                                         121
  14            30                                                                                      145                                                                         174                                                                                     20                                                                                      122                                                                         141
  15            37                                                                                      175                                                                         211                                                                                     23                                                                                      142                                                                         164
  16            47                                                                                      212                                                                         258                                                                                     28                                                                                      165                                                                         192
  17            61                                                                                      259                                                                         319                                                                                     34                                                                                      193                                                                         226
  18            \-                                                                                      \-                                                                          \-                                                                                      42                                                                                      227                                                                         268
  19            \-                                                                                      \-                                                                          \-                                                                                      51                                                                                      269                                                                         319
  ------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------- ---------------------------------------------------------------------------------------

Table 108: Band structure for SWB and FB Normal and Harmonic frames

  -------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------- ---------------------------------------------------------------------------------------
  Normal and Harmonic mode                                                                                                                                                                                                                                                                                                                                                                                                                                   
                             13.2 kbps                                                                               16.4 kbps                                                                                                                                                                                                                                                                                                                               
  *b*                        ![](media/image1047.wmf){width="0.5548611111111111in" height="0.20972222222222223in"}   ![](media/image1048.wmf){width="0.5125in" height="0.20972222222222223in"}   ![](media/image1049.wmf){width="0.4527777777777778in" height="0.20972222222222223in"}   ![](media/image1047.wmf){width="0.5548611111111111in" height="0.20972222222222223in"}   ![](media/image1048.wmf){width="0.5125in" height="0.20972222222222223in"}   ![](media/image1049.wmf){width="0.4527777777777778in" height="0.20972222222222223in"}
  0                          6                                                                                       0                                                                           5                                                                                       6                                                                                       0                                                                           5
  1                          6                                                                                       6                                                                           11                                                                                      6                                                                                       6                                                                           11
  2                          6                                                                                       12                                                                          17                                                                                      6                                                                                       12                                                                          17
  3                          6                                                                                       18                                                                          23                                                                                      6                                                                                       18                                                                          23
  4                          6                                                                                       24                                                                          29                                                                                      6                                                                                       24                                                                          29
  5                          6                                                                                       30                                                                          35                                                                                      6                                                                                       30                                                                          35
  6                          7                                                                                       36                                                                          42                                                                                      7                                                                                       36                                                                          42
  7                          8                                                                                       43                                                                          50                                                                                      7                                                                                       43                                                                          49
  8                          9                                                                                       51                                                                          59                                                                                      8                                                                                       50                                                                          57
  9                          10                                                                                      60                                                                          69                                                                                      9                                                                                       58                                                                          66
  10                         11                                                                                      70                                                                          80                                                                                      10                                                                                      67                                                                          76
  11                         13                                                                                      81                                                                          93                                                                                      11                                                                                      77                                                                          87
  12                         16                                                                                      94                                                                          109                                                                                     13                                                                                      88                                                                          100
  13                         19                                                                                      110                                                                         128                                                                                     15                                                                                      101                                                                         115
  14                         23                                                                                      129                                                                         151                                                                                     18                                                                                      116                                                                         133
  15                         28                                                                                      152                                                                         179                                                                                     21                                                                                      134                                                                         154
  16                         34                                                                                      180                                                                         213                                                                                     26                                                                                      155                                                                         180
  17                         42                                                                                      214                                                                         255                                                                                     32                                                                                      181                                                                         212
  18                         55                                                                                      256                                                                         310                                                                                     39                                                                                      213                                                                         251
  19                         68                                                                                      311                                                                         378                                                                                     48                                                                                      252                                                                         299
  20                         84                                                                                      379                                                                         462                                                                                     59                                                                                      300                                                                         358
  21                         105                                                                                     463                                                                         567                                                                                     74                                                                                      359                                                                         432
  22                         \-                                                                                      \-                                                                          \-                                                                                      92                                                                                      433                                                                         524
  23                         \-                                                                                      \-                                                                          \-                                                                                      115                                                                                     525                                                                         639
  -------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------- ---------------------------------------------------------------------------------------

##### 5.3.4.1.3 Energy Envelope coding

Energy envelope coding module is applied for all types of signal i.e.,
from NB, WB, SWB and FB for various bitrates as described in table 101.
In this module, the spectrum energy of a band is computed the
differential indices of scalar quantized band energies are encoded using
either a Large symbol coding method or a Small symbol coding method. The
coding method is selected according to the range required to represent
all the differential indices and the bit consumption. The encoding of
band energies is detailed below.

The spectrum energy of a band, *E~M~(b)* is computed as follows:

![](media/image1051.wmf){width="3.5729166666666665in"
height="0.6506944444444445in"} (1029)

In case of transient mode, the energies to be quantized are first
reordered such that energy corresponding to even sub-frame index *m* =
0, 2 are in frequency-increasing order while the energy of odd sub-frame
index *m* = 1, 3 are in frequency decreasing order which allows for an
efficient differential energy encoding

In each frame, the energies are scalar quantized with a uniform scalar
quantizer *qint*. The value of *qint* varies and it is selected based on
table 109.The index of the quantized energy, *I~M ~*(*b*), can easily be
obtained as:

![](media/image1052.wmf){width="2.5555555555555554in"
height="0.4166666666666667in"} (1030)

Table 109: Scalar quantizer values for NB, WB, SWB, FB modes

  --------- ------------------ ---------- -------- ----------- ----------
  BW        Mode               7.2 kbps   8 kbps   13.2 kbps   16.4kbps
  NB        Transient          1.8        2.2      1.4         \-
            Normal             1          1        0.8         \-
  WB        Transient          \-         \-       1.8         1.8
            Normal             \-         \-       0.8         0.8
  SWB, FB   Transient          \-         \-       3           1.2
            Normal, Harmonic   \-         \-       0.6         0.6
  --------- ------------------ ---------- -------- ----------- ----------

The quantized indices of the band energies are differentially coded by
computing

![](media/image1053.wmf){width="2.948611111111111in"
height="0.6777777777777778in"} (1031)

where lowest frequency band quantized index is differentially coded
using a reference band energy ![](media/image1054.wmf){width="0.5125in"
height="0.21597222222222223in"}.

The differential indices ∆*I~M ~*(*b*) are constrained into the range of
\[--256, 255\]. This is performed by first adjusting the negative
differential indices and then adjusting the positive differential
indices as follows:

![](media/image1055.wmf){width="3.017361111111111in"
height="1.2597222222222222in"} (1032)

The constrained differential indices are used for selecting the more
efficient mode from either the Small symbol coding method or the Large
symbol coding method. The method selection between the Small symbol
coding mode and the Large symbol coding mode is described in subclause
5.3.4.1.3.2.

Using the coding method information obtained from subclause 5.3.4.1.3.2
differential indices are coded using the respective modes as indicated
below.

A flag bit DENG\_CMODE which was obtained from subclause 5.3.4.1.3.2
used to indicate the type of encoding method between the Small symbol
coding method and the Large symbol coding method and transmitted as side
information to the decoder. The flag DENG\_CMODE is set to 1 when the
Small coding method is used and it is set to zero for the Large symbol
coding method and it is described in table 110.

If the flag DENG\_CMODE is set to 1, in the Small symbol coding the band
energies are either coded by resized or context based Huffman coding. A
flag bit LC\_MODE is used to indicate the mode selection between resized
or context based Huffman coding and it is transmitted as side
information to the decoder. The mode selection between resized and
context based coding is done based on the estimated number of bits
consumed by the respective coding modes. The resized Huffman coding
described in subclause 5.3.4.1.3.3.2 is used for coding the differential
indices when LC\_MODE is set to 1 and LC\_MODE is set to 0 for coding
the differential indices using context based coding which is described
in subclause 5.3.4.1.3.3.1.

##### 5.3.4.1.3.1 Reconstruction of quantized energies {#reconstruction-of-quantized-energies .H6}

The quantized differential indices are reconstructed according to

![](media/image1056.wmf){width="2.720833333333333in"
height="0.4618055555555556in"} (1033)

where ![](media/image1057.wmf){width="0.5395833333333333in"
height="0.21597222222222223in"}is the reference band energy The final
resulting reconstructed quantized energies are obtained as follows

![](media/image1058.wmf){width="2.276388888888889in"
height="0.23333333333333334in"} (1034)

where the value of *qint* varies and it is selected based on table 109.

If band energies are quantized under transient mode i.e., *IsTransient*
is True, the energies are reordered back to original.

##### 5.3.4.1.3.2 Energy envelope coding mode selection {#energy-envelope-coding-mode-selection .H6}

The differential quantization indices are encoded by one of two coding
methods. The coding method is selected according to the range required
to represent all the differential indices and the bit consumption. The
range of the large symbol coding method enables it to represent larger
number of bits. The large symbol coding method consists of a scale mode
and a pulse mode. The small symbol coding method uses an upper bit
coding method which consists of a context based Huffman coding mode and
a re-sized Huffman coding mode as well as bit packing for the lower bit.

Table 110: Low-rate HQ envelope coding modes

+----------------+----------------+----------------+----------------+
| Coding Method  | Coding Method  | Coding Mode    | Description    |
| index          |                | index          |                |
|                |                |                |                |
| *DENG\_CMODE*  |                | (1bit)         |                |
|                |                |                |                |
| (1bit)         |                |                |                |
+----------------+----------------+----------------+----------------+
| 0              | Large symbol   | 0              | Pulse mode     |
|                | method         |                |                |
+----------------+----------------+----------------+----------------+
|                |                | 1              | Scale mode     |
+----------------+----------------+----------------+----------------+
| 1              | Small symbol   | 0              | Context based  |
|                | method         |                | Huffman coding |
|                |                |                | mode           |
+----------------+----------------+----------------+----------------+
|                |                | 1              | Re-sized       |
|                |                |                | Huffman coding |
|                |                |                | mode           |
+----------------+----------------+----------------+----------------+

If at least one of the differential quantization indices in all the
bands of a frame cannot be represented in \[-32, 31\](\[-46,17\] for the
first index), the large symbol coding method is always used. If this
larger range is not required the bits consumption for both large and
small symbol coding modes are compared and the coding mode with the
least bits is selected. The corresponding coding method information is
transmitted for each frame.

The Small symbol coding method and the large symbol method are used for
estimating the bits consumption for coding the differential indices
which are obtained in equation (1031). The detailed descriptions of the
respective coding modes are given in the following subclause
5.3.4.1.3.3.

The number of estimated bits hcode1 and flag LCmode information obtained
from subclause 5.3.4.1.3.3. is used for selecting the best mode with the
Large symbol coding method bits ULbits obtained from subclause
5.3.4.1.3.4, as shown below.

![](media/image1059.wmf){width="1.8868055555555556in"
height="0.8513888888888889in"}

##### 5.3.4.1.3.3 Small symbol coding method {#small-symbol-coding-method .H6}

If *IsTransient* is *True*,

In this module, the quantized indices obtained from equation (1030) are
constrained into the range of \[--15, 16\] by calculating the
differences as in equation (1031) and constraining the range. This is
performed by first adjusting the negative differential indices and then
adjusting the positive differential indices as follows:

1.  Compute the differential indices for lowest frequency band using
    reference band energy as in equation (1031)

2.  For b = 0, if ![](media/image1060.wmf){width="1.75in"
    height="0.23958333333333334in"} and
    ![](media/image1061.wmf){width="1.8333333333333333in"
    height="0.23958333333333334in"}

3.  For the rest of the bands, compute the differential indices defined
    in equation (**1031**) in order from the highest-frequency band to
    the lowest-frequency band.

4.  If ![](media/image1062.wmf){width="3.2291666666666665in"
    height="0.20833333333333334in"}

5.  Re-compute the differential indices in order from the
    lowest-frequency sub-vector from band b=1 to the highest-frequency
    sub-vector.

6.  If ![](media/image1063.wmf){width="4.072916666666667in"
    height="0.20833333333333334in"}

7.  The adjusted differential indices in the range \[0, 31\] are
    obtained by adding an offset of 15 to *∆I~M~*(*b*).

Context based Huffman coding mode is used for estimating the bit
consumption, if the range of differential indices lies in between \[10,
22\] resized Huffman coding \[b-Huffman\] mode is enabled for estimating
the bits consumption. The Huffman codes for the differential indices for
resized Huffman coding mode when *IsTransient* is *True* are given in
table 111. In the table 111, *H~i~* denotes the index of the Huffman
code, *H~c~* is the Huffman code corresponding to index *H~i~* and
*H~b~* denotes the bits required for representing the Huffman code
corresponding to index *H~i~*.

Table 111: Huffman code for Transient frames

  ------ ------ ------ ------ --------- ------ ------ ----------- ------ ------ ------ ------
  H~i~   H~c~   H~b~   H~i~   H~c~      H~b~   H~i~   H~c~        H~b~   H~i~   H~c~   H~b~
  0      0      0      8      0         0      16     11          2      24     0      0
  1      0      0      9      0         0      17     0010        4      25     0      0
  2      0      0      10     0         0      18     011010      6      26     0      0
  3      0      0      11     1111010   7      19     00111010    8      27     0      0
  4      0      0      12     01010     5      20     010111010   9      28     0      0
  5      0      0      13     110       3      21     110111010   9      29     0      0
  6      0      0      14     01        2      22     0           0      30     0      0
  7      0      0      15     00        2      23     0           0      31     0      0
  ------ ------ ------ ------ --------- ------ ------ ----------- ------ ------ ------ ------

The estimated bits for context based coding which was obtained from
subclause 5.3.4.1.3.3.1 is represented as
![](media/image1064.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"}*~,~*while for resized coding it is
represented as![](media/image1065.wmf){width="0.44375in"
height="0.20972222222222223in"}, a best coding mode is selected based on

![](media/image1066.wmf){width="2.120833333333333in"
height="0.8159722222222222in"} .

If *IsTransient* is *False*,

The differential quantization indices are adjusted to have positive
values by adding 46 in the first band and 32 in the other bands. The
differential quantization indices are split into 5 upper bits and 1
lower bit. The 5 upper bits are encoded by either a context based
Huffman coding mode described in subclause 5.3.4.1.3.3.1 or a re-sized
Huffman coding mode described in subclause 5.3.4.1.3.3.2 and the 1 lower
bit is packed.

In more detail, the context based coding mode or the resized Huffman
coding is used for estimating the bits. The differential indices which
are obtained in equation (1031) ∆*I~M ~*(*b*) are constrained into the
range of \[0, 63\] by adding an offset of 32 to *∆I~M~*(*b*) for *b* =
1,....,*N~bands~*-1 and for *b*=0 an offset of 46 is used for
*∆I~M~*(*0*).If the constrained differential indices exceed \[0 63\]
when *IsTransient* is *False* and \[0 31\] when *IsTransient* is *True,
hcode~1\ ~*is set to -1 and the differential indices are coded using the
Large symbol coding method.

The least significant bit is extracted from the constrained differential
indices *∆I~M~*(*b*) for *b* = 0,....,*N~bands~*-1 using

![](media/image1067.wmf){width="2.504861111111111in"
height="0.5909722222222222in"} (1035)

The updated differential indices are used for estimating the bits
consumed by the two different coding modes. Based on the estimated bits
obtained from context based coding,
![](media/image1068.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"}, and resized Huffman coding mode,
![](media/image1069.wmf){width="0.44375in"
height="0.20972222222222223in"} , the best coding mode is selected as
shown below.

![](media/image1070.wmf){width="2.102777777777778in"
height="0.8159722222222222in"}

The differential index ∆*I~M ~*(*0*) is usually transmitted as is for
both *IsTransient* is *True* or *False*, i.e., 5 bits per norm index is
required and these bits are updated to the estimated bits
![](media/image1064.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"}which was shown below.

![](media/image1071.wmf){width="1.1125in"
height="0.20972222222222223in"} (1036)

The least significant bit extracted from the constrained differential
indices is transmitted as is, if the Small symbol coding method is
selected and ![](media/image1072.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"} is updated as shown below.

![](media/image1073.wmf){width="1.3465277777777778in"
height="0.20972222222222223in"} (1037)

By default flag LCmode is set to 0 and represents context based coding,
while if flag LCmode is reset to 1, it indicates resized Huffman coding
mode consumes less bits compared to context based coding, and the
estimated bits ![](media/image1064.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"}is used for selecting the best mode with
the Large symbol coding method bits ULbits.

##### 5.3.4.1.3.3.1 Context based Huffman coding mode {#context-based-huffman-coding-mode .H6}

If the this coding mode is selected for the current frame, the context
based Huffman coding is applied to the adjusted differential indices.
These indices are encoded using a context model which corresponds to the
adjusted differential index in a previous band. The first band must be
handled separately, so the context for encoding
![](media/image1074.wmf){width="0.5034722222222222in"
height="0.20972222222222223in"}is adjusted by subtracting
![](media/image1075.wmf){width="1.0854166666666667in"
height="0.23333333333333334in"}

![](media/image1076.wmf){width="4.148611111111111in"
height="0.49444444444444446in"} (1038)

There are three groups depending on the
![](media/image1077.wmf){width="1.2in" height="0.2423611111111111in"}and
two probability models as shown in table 112,
![](media/image1078.wmf){width="0.44375in"
height="0.20972222222222223in"} and
![](media/image1079.wmf){width="0.4618055555555556in"
height="0.20972222222222223in"}share the Huffman tables depending on the
probability model.

Table 112: The groups and the probability models

  ------------- ------------- ------------- -------------------
  Group index   Lower bound   Upper bound   Probability model
  0             \-            12            0
  1             13            17            1
  2             18            \-            0
  ------------- ------------- ------------- -------------------

A Huffman table for ![](media/image1078.wmf){width="0.44375in"
height="0.20972222222222223in"} and
![](media/image1080.wmf){width="0.4618055555555556in"
height="0.20972222222222223in"}is defined in table 113 and a Huffman
table for ![](media/image1081.wmf){width="0.43472222222222223in"
height="0.20972222222222223in"}is defined in table 114.

If ![](media/image1082.wmf){width="1.2083333333333333in"
height="0.2423611111111111in"}is located
in![](media/image1080.wmf){width="0.4618055555555556in"
height="0.20972222222222223in"},
![](media/image1083.wmf){width="0.48541666666666666in"
height="0.20972222222222223in"}is reversed
to![](media/image1084.wmf){width="0.7465277777777778in"
height="0.20972222222222223in"}and then the reversed value is encoded.

Table 113: Huffman coefficient table for the group0 Huffman coding
(group0,group2)

  ------- ---------------- ------- ---------- ------- -------- ------- -------------
  Index   Code             Index   Code       Index   Code     Index   Code
  0       11100111101111   8       11100110   16      000      24      111011
  1       11100111101110   9       1110100    17      010      25      0110011
  2       1110011110110    10      0110010    18      110      26      1110010
  3       111001111010     11      100100     19      0111     27      1110101
  4       1001010001       12      01101      20      1111     28      1001011
  5       1110011111       13      1000       21      10011    29      10010101
  6       111001110        14      101        22      011000   30      1001010000
  7       100101001        15      001        23      111000   31      11100111100
  ------- ---------------- ------- ---------- ------- -------- ------- -------------

Table 114: Huffman coefficient table for the context based Huffman
coding (group1)

  ------- --------------- ------- ----------- ------- ----------- ------- -----------------
  Index   Code            Index   Code        Index   Code        Index   Code
  0       0010000100110   8       001000101   16      11          24      0010000101
  1       001000100110    9       00100110    17      100         25      00100001000
  2       00100111010     10      0010010     18      1011        26      001000010010
  3       00100010010     11      101000      19      10101       27      00100111011
  4       00100010001     12      00101       20      101001      28      001000100111
  5       00100010000     13      0011        21      00100000    29      00100001001110
  6       0010011100      14      000         22      00100011    30      001000010011110
  7       001001111       15      01          23      001000011   31      001000010011111
  ------- --------------- ------- ----------- ------- ----------- ------- -----------------

##### 5.3.4.1.3.3.2 Resized Huffman coding mode {#resized-huffman-coding-mode .H6}

Resized Huffman coding is applied to the adjusted differential indices.
In this method, the span of the differential indices is reduced while
being able to perfectly reconstruct the differential indices. Based on
the newly modified differential indices obtained from equation (1040),
number of bits consumed for coding the new differential indices
![](media/image1085.wmf){width="0.5034722222222222in"
height="0.20972222222222223in"} is estimated as shown below.

![](media/image1086.wmf){width="1.6076388888888888in"
height="0.5215277777777778in"} (1039)

##### 5.3.4.1.3.3.3 Differential Indices Modification {#differential-indices-modification .H6}

The modification of differential indices is done according to the value
of the differential index for the preceding sub band and a threshold.
Equation (1040) is used for modifying the span of differential indices.
It should be noted that this modification is not applied to the first
differential index, i.e. the case of \"b = 1\" and the differential
indices which are not true for the both of the "if" conditions.

![](media/image1087.wmf){width="4.488194444444445in"
height="1.75in"}(1040)

![](media/image1088.wmf){width="2.6805555555555554in" height="0.75in"}

Based on the new differential indices obtained from equation (1040),
resized Huffman coding is applied, if any of the new differential
indices lies outside \[0 31\] range, resized Huffman coding is not used
for coding the differential indices.

The range of the new differential indices for Huffman coding is
identified as shown below.

![](media/image1089.wmf){width="3.6in" height="0.21597222222222223in"}
(1041)

where *b* = 1, \... *N~bands~*-1

Based on the range obtained from equation (1041), range difference is
calculated as shown below.

![](media/image1090.wmf){width="2.816666666666667in"
height="0.21597222222222223in"} (1042)

Resized Huffman coding is used for coding the new differential indices
if the *Range~Diff~* values lies below 11, otherwise resized Huffman
coding is not used. The Huffman codes and its corresponding bits
consumption for coding of the new differential indices are given in
table 115.

Table 115: Huffman code for Non-Transient frames

  ------ ------------- ------ ------ ----------- ------ ------ ----------- ------ ------ ------------ ------
  H~i~   H~c~          H~b~   H~i~   H~c~        H~b~   H~i~   H~c~        H~b~   H~i~   H~c~         H~b~
  0      0             0      8      001111111   9      16     10          2      24     1011111111   10
  1      0             0      9      00111111    8      17     101         3      25     1111111111   11
  2      0             0      10     0011111     7      18     1011        4      26     0            0
  3      0             0      11     001111      6      19     10111       5      27     0            0
  4      0             0      12     00111       5      20     101111      6      28     0            0
  5      01111111111   11     13     0011        4      21     1011111     7      29     0            0
  6      0111111111    10     14     001         3      22     10111111    8      30     0            0
  7      0011111111    10     15     00          2      23     101111111   9      31     0            0
  ------ ------------- ------ ------ ----------- ------ ------ ----------- ------ ------ ------------ ------

##### 5.3.4.1.3.4 Large symbol coding method {#large-symbol-coding-method .H6}

If the large symbol coding method is used then either the pulse mode or
the scale mode is selected to encode the differential quantization
indices. The pulse mode is adequate when no differential quantization
index is over \[-4,3\]. If this range is exceeded, the pulse mode cannot
be used, and instead the scale mode is always used. Additionally, if the
first quantization differential index is over \[-64,63\], the scale mode
is always used. In the large symbol coding method a Huffman coding with
8 symbols shown in table 116 is used.

Table 116: Huffman coefficient table in the large symbol coding method

  ------- ---------
  Index   Code
  -4      0001011
  -3      00011
  -2      001
  -1      01
  0       1
  1       0000
  2       000100
  3       0001010
  ------- ---------

##### 5.3.4.1.3.4.1 Pulse mode {#pulse-mode .H6}

In the pulse mode, there are two indicators; an indicator
![](media/image1091.wmf){width="0.34791666666666665in"
height="0.23333333333333334in"}to show whether the first index is
transmitted separately and an indicator
![](media/image1092.wmf){width="0.38958333333333334in"
height="0.23333333333333334in"} to show if there is a differential
quantization index exceeding the range \[-4,3\].

If the first index is within \[-4,3\],
![](media/image1091.wmf){width="0.34791666666666665in"
height="0.23333333333333334in"}is set to 0 and the first index is then
encoded by the Huffman coding defined in table 116 with the other
indices. Otherwise,
![](media/image1091.wmf){width="0.34791666666666665in"
height="0.23333333333333334in"}is set to 1 and the first index is then
packed using 7 bits after adding 64.

If a pulse exists in the current frame,
![](media/image1092.wmf){width="0.38958333333333334in"
height="0.23333333333333334in"}is set to 1 and the pulse position
![](media/image1093.wmf){width="0.39861111111111114in"
height="0.23333333333333334in"}and
amplitude![](media/image1094.wmf){width="0.43472222222222223in"
height="0.23333333333333334in"} are transmitted using 5 bits and 7 bits
respectively. All the other indices are then encoded by the Huffman
coding in table 116. If no pulse exists, all indices are encoded by the
Huffman coding in table 116.

Table 117: bit allocation for the scale mode

  ------ ---------------------------------------------------------------------------------------- ---------------------------------------------------------------------------------------- ---------------------------------------------------------------------------------------- ---------------------------------------------------------------------------------------- ---------------------------------------------------------------------------------------- ---------------------------------------------------------------------------------------- ---------------------------------------------------------------------------------------- --------------
         ![](media/image1095.wmf){width="0.34791666666666665in" height="0.20972222222222223in"}   ![](media/image1096.wmf){width="0.32083333333333336in" height="0.20972222222222223in"}   ![](media/image1097.wmf){width="0.34791666666666665in" height="0.23333333333333334in"}   ![](media/image1098.wmf){width="0.38958333333333334in" height="0.23333333333333334in"}   ![](media/image1099.wmf){width="0.48541666666666666in" height="0.20972222222222223in"}   ![](media/image1100.wmf){width="0.39861111111111114in" height="0.23333333333333334in"}   ![](media/image1094.wmf){width="0.43472222222222223in" height="0.23333333333333334in"}   Huffman bits
  bits   1                                                                                        1                                                                                        1                                                                                        1                                                                                        7                                                                                        5                                                                                        7                                                                                        \-
  ------ ---------------------------------------------------------------------------------------- ---------------------------------------------------------------------------------------- ---------------------------------------------------------------------------------------- ---------------------------------------------------------------------------------------- ---------------------------------------------------------------------------------------- ---------------------------------------------------------------------------------------- ---------------------------------------------------------------------------------------- --------------

##### 5.3.4.1.3.4.2 Scale mode {#scale-mode .H6}

In the scale mode, all the indices are split into 3 upper bits and a few
lower bits depending on the minimum and maximum of all the indices. The
3 upper bits are encoded by the Huffman coding in table 116 and the
lower bits are packed. The number of lower bits is defined as
![](media/image1101.wmf){width="0.39861111111111114in"
height="0.23333333333333334in"}.
The![](media/image1101.wmf){width="0.39861111111111114in"
height="0.23333333333333334in"}is calculated to make all the
differential quantization indices fit within the range \[-4,3\] by
scaling down the indices, and is represented by three bits.

##### 5.3.4.1.4 MDCT coefficients quantization

##### 5.3.4.1.4.1 Normal Mode {#normal-mode .H6}

##### 5.3.4.1.4.1.1 Overview {#overview .H6}

The figure below shows the overview of the normal mode encoder.

![](media/image1102.png){width="5.127777777777778in"
height="3.8201388888888888in"}

Figure 66: Block diagram of the Normal mode encoder overview

##### 5.3.4.1.4.1.2 Energy envelope coding {#energy-envelope-coding-1 .H6}

Details are described in subclause 5.3.4.1.3.

##### 5.3.4.1.4.1.3 Tonality flag calculation {#tonality-flag-calculation .H6}

Tonality flags are calculated for the high bands *b*= *N~bands~*-
*h~b~*, ..,*N~bands~*-1 as described in table 118. For example, for the
last (highest) five bands, i.e. b=17 to 21 for 13.2 kbps and b=19 to 23
for 16.4kbps in table 108, and the last three bands b=15 to 17 for 13.2
kbps and b=17 to 19 for 16.4kbps in case of WB as in table 107 and last
two bands b=15 to 16 for 13.2 kbps for NB inputs as in table 106,
peak-to-average ratios are calculated and compared with a threshold.
Flags indicating whether the peak-to-average ratios are greater than the
threshold are sent to the decoder side using one bit per band. If the
peak-to-average ratio is greater than the threshold, the tonality flag
is set to "1", otherwise it is set to "0". For the SWB and FB case, a
limited-band mode flag is further sent to the decoder side as described
in subclause 5.3.4.1.4.1.4.4.2, if the tonality flag is set to "1".

Table 118: Total number of high bands for tonality calculation

  ----------- ---------------- ---------------------
  Bandwidth   Bitrate (kbps)   High bands , *h~b~*
  NB          13.2             2
  WB          13.2,16.4        3
  SWB, FB     13.2,16.4        5
  ----------- ---------------- ---------------------

##### 5.3.4.1.4.1.4 Bit allocation {#bit-allocation .H6}

##### 5.3.4.1.4.1.4.1 Bit allocation overview {#bit-allocation-overview .H6}

In the Normal Mode, band spectra are encoded by either Trellis Coding
Quantization (TCQ) or Pitch Filtering Spectrum Coding (PFSC) with
assigned bits for the bands. TCQ is used for encoding peaky/tonal
spectrum bands for NB, WB, SWB and FB, while PFSC is mainly applied for
encoding other spectrum bands in a high-frequency region other than NB.
This switching principle is analogous to the coding mode switching
between Generic mode and Sinusoidal mode in G.718 Annex B \[25\].

Bit-allocation process is performed in the following manner. Firstly,
bands encoded using PFSC are identified based on the tonality flags
among the four highest bands in case of SWB ,FB and peak-to-average
ratio is calculated for last band in the WB and necessary bits (1 or 2
bits) are allocated to each of the identified bands. Secondly, remaining
bits are allocated to other bands based on perceptual importance. When
there is any band whose assigned bit results is zero in the four bands
for SWB and FB signals, such band is re-identified as a PFSC encoding
band and the bit allocations are re-calculated.

![](media/image1103.png){width="3.0118055555555556in"
height="3.0284722222222222in"}

Figure 67: A flowchart of bit allocation processing for LR-HQ Normal
mode.

##### 5.3.4.1.4.1.4.2 The adjustment of quantized energy envelope prior to bit allocation {#the-adjustment-of-quantized-energy-envelope-prior-to-bit-allocation .H6}

For the Non-Transient mode of NB (the bit rate is less than or equal to
13.2kbps) and WB cases, in order to make the inter-frame reconstruction
more continuous and allocate more bits to perceptual important bands,
the quantized energy envelopes of the highest
![](media/image1104.wmf){width="0.18263888888888888in"
height="0.20972222222222223in"} bands are adjusted prior to bit
allocation. Some of the quantized energy envelopes of the high frequency
bands and low frequency bands are adjusted. Then perform the bit
allocation to bands according to the adjusted energy envelopes. Finally,
the coefficients of the bit allocated bands are quantized and written to
the bit-stream.

To adjust the quantized energy envelope of high frequency bands at NB,
the following steps are performed:

a)  Two bits are encoded to indicate whether the highest two bands of
    the previous frame is encoded. Initialize a band boundary
    ![](media/image1105.wmf){width="0.39861111111111114in"
    height="0.20972222222222223in"} to 6 and initialize adjustment
    factors ![](media/image1106.wmf){width="0.15555555555555556in"
    height="0.1375in"},![](media/image1107.wmf){width="0.15555555555555556in"
    height="0.18263888888888888in"} respectively:

> ![](media/image1108.wmf){width="2.207638888888889in"
> height="1.0944444444444446in"} (1043)

b)  For each band, calculate the magnitude envelope:

![](media/image1109.wmf){width="2.775in" height="0.48541666666666666in"}
(1044)

where ![](media/image1110.wmf){width="0.5548611111111111in"
height="0.20972222222222223in"} denotes the bandwidth of each band, and
![](media/image1111.wmf){width="0.44375in"
height="0.23333333333333334in"}is computed as follows:

![](media/image1112.wmf){width="0.9479166666666666in"
height="0.27847222222222223in"} (1045)

where ![](media/image1113.wmf){width="0.4166666666666667in"
height="0.23333333333333334in"} denotes the quantized energy envelope of
each band.

c)  Then, calculate the sum of the differences between the consecutive
    two magnitude envelopes and the sum of the magnitude envelopes for
    high frequency bands:

![](media/image1114.wmf){width="2.2618055555555556in"
height="0.5638888888888889in"} (1046)

![](media/image1115.wmf){width="1.5569444444444445in"
height="0.5638888888888889in"} (1047)

d)  Search the peak of magnitude envelopes and calculate the sum of the
    magnitude envelopes for low frequency bands:

![](media/image1116.wmf){width="3.06875in"
height="0.2513888888888889in"} (1048)

![](media/image1117.wmf){width="1.5027777777777778in"
height="0.5395833333333333in"} (1049)

e)  Initialize an adjustment factor
    ![](media/image1118.wmf){width="0.4166666666666667in"
    height="0.19166666666666668in"} for each band to 1, and then adjust
    the quantized energy envelopes of high frequency bands as follows:

```{=html}
<!-- -->
```
1)  if![](media/image1119.wmf){width="5.633333333333334in"
    > height="0.2513888888888889in"} is satisfied at the bit-rates below
    > 13.2kbps or

> ![](media/image1120.wmf){width="5.633333333333334in"
> height="0.5125in"}is satisfied at 13.2kbps,
>
> the quantized energy envelopes of the last
> ![](media/image1121.wmf){width="0.9118055555555555in"
> height="0.20972222222222223in"} bands are adjusted as follows:

![](media/image1122.wmf){width="5.738888888888889in"
height="0.48541666666666666in"} (1050)

2)  Otherwise, the adjustment factors of the last 2 bands are
    > calculated:

![](media/image1123.wmf){width="5.111805555555556in"
height="0.48541666666666666in"} (1051)

Then, the adjustment factors of the last 2 bands are updated further
according to ![](media/image1124.wmf){width="0.5305555555555556in"
height="0.23333333333333334in"}:

![](media/image1125.wmf){width="4.904861111111111in"
height="0.9027777777777778in"} (1052)

> Finally, the quantized energy envelopes of the last 2 bands are
> adjusted: ![](media/image1126.wmf){width="1.4159722222222222in"
> height="0.23333333333333334in"},
>
> where ![](media/image1127.wmf){width="0.5034722222222222in"
> height="0.23333333333333334in"} is the tonality flag which is
> calculated in subclause 5.3.4.1.4.1.3, i.e. the classification mode of
> the band, and ![](media/image1128.wmf){width="0.5305555555555556in"
> height="0.23333333333333334in"}is obtained from the previous frame and
> indicates whether the bits are allocated to the highest two bands of
> the previous frame or not. If
> ![](media/image1129.wmf){width="0.5305555555555556in"
> height="0.23333333333333334in"}is equal to 1, the band
> ![](media/image1130.wmf){width="0.12291666666666666in"
> height="0.16458333333333333in"}of the previous frame is allocated
> bits; Otherwise, if
> ![](media/image1129.wmf){width="0.5305555555555556in"
> height="0.23333333333333334in"}is equal to 0, the -band
> ![](media/image1131.wmf){width="0.12291666666666666in"
> height="0.16458333333333333in"}of the previous frame is not allocated
> bits -. After bit allocation, the flag
> ![](media/image1128.wmf){width="0.5305555555555556in"
> height="0.23333333333333334in"}of the current frame is preserved for
> the next frame.

To adjust the quantized energy envelops of low frequency bands at NB,
the following steps are performed:

a)  Initialize ![](media/image1132.wmf){width="0.39861111111111114in"
    height="0.20972222222222223in"} to 3, select
    ![](media/image1132.wmf){width="0.39861111111111114in"
    height="0.20972222222222223in"} low frequency bands from
    ![](media/image1133.wmf){width="0.43472222222222223in"
    height="0.20972222222222223in"} bands. For each band, calculate the
    magnitude envelope:

![](media/image1134.wmf){width="2.775in" height="0.48541666666666666in"}
(1053)

b)  Then, calculate the sum of the magnitude envelopes for high
    frequency bands:

![](media/image1115.wmf){width="1.5569444444444445in"
height="0.5638888888888889in"} (1054)

the variable![](media/image1133.wmf){width="0.43472222222222223in"
height="0.20972222222222223in"} is assigned to different value for
different bit rates, specifically it is assigned to 13,14,15,17 for
7.2kbps, 8kbps, 9.6kbps and 13.2kbps respectively.

c)  Search the peak of magnitude envelopes and calculate the sum of the
    magnitude envelops for low frequency bands:

![](media/image1116.wmf){width="3.06875in"
height="0.2513888888888889in"} (1055)

![](media/image1117.wmf){width="1.5027777777777778in"
height="0.5395833333333333in"} (1056)

d)  Initialize a flag ![](media/image1135.wmf){width="0.5125in"
    height="0.23333333333333334in"} to 0.
    ![](media/image1136.wmf){width="0.5125in"
    height="0.23333333333333334in"} is a flag to indicate whether second
    stage bit allocation algorithm is used in TCQ module. When
    ![](media/image1136.wmf){width="0.5125in"
    height="0.23333333333333334in"} is equal to 0, second stage bit
    allocation algorithm will be used. When
    ![](media/image1136.wmf){width="0.5125in"
    height="0.23333333333333334in"} is equal to 1, the second stage bit
    allocation algorithm will not be used. The flag is utilized in
    subclause 5.3.4.1.4.1.5.1.2.

e)  Determining whether to modify the quantized energy envelops of the
    six low frequency band according to their energy characteristics and
    spectral characteristics. The energy characteristics denote the
    ratio between the energy of six low frequency bands and the energy
    of the other bands which are determined by
    ![](media/image1137.wmf){width="0.5548611111111111in"
    height="0.2513888888888889in"} and
    ![](media/image1138.wmf){width="0.5305555555555556in"
    height="0.2513888888888889in"}; The spectral characteristics denote
    the degree of spectrum fluctuation which are determined
    by![](media/image1139.wmf){width="0.5638888888888889in"
    height="0.2513888888888889in"}.

f)  If the following conditions are satisfied,

![](media/image1140.wmf){width="3.1805555555555554in"
height="0.4861111111111111in"}, the flag
![](media/image1141.wmf){width="0.5138888888888888in"
height="0.2361111111111111in"} is set to 1, and the quantized energy
envelops of the three low frequency bands are adjusted as follows:

![](media/image1142.wmf){width="4.226388888888889in"
height="0.48541666666666666in"} (1057)

To adjust the quantized energy envelopes of high frequency bands at WB,
the following steps are performed:

a)  Encode two bits to indicate whether the highest two bands of the
    previous frame is encoded. Define two band boundaries
    ![](media/image1105.wmf){width="0.39861111111111114in"
    height="0.20972222222222223in"}and![](media/image1143.wmf){width="0.44375in"
    height="0.20972222222222223in"}. If the bit rate is 13.2kbps, set
    ![](media/image1105.wmf){width="0.39861111111111114in"
    height="0.20972222222222223in"}and![](media/image1143.wmf){width="0.44375in"
    height="0.20972222222222223in"} to 8 and 15, respectively;
    Otherwise, set
    ![](media/image1105.wmf){width="0.39861111111111114in"
    height="0.20972222222222223in"}and![](media/image1143.wmf){width="0.44375in"
    height="0.20972222222222223in"} to 8 and 16, respectively. The
    bandwidths of low frequency bands and high frequency bands are
    obtained as follows:

![](media/image1144.wmf){width="1.304861111111111in"
height="1.1215277777777777in"} (1058)

b)  For each band, calculate the magnitude envelope:

![](media/image1145.wmf){width="2.775in" height="0.48541666666666666in"}
(1059)

Then, calculate the sum of the differences between the consecutive 2
magnitude envelopes and the sum of the magnitude envelopes for part of
the high frequency bands:

![](media/image1146.wmf){width="2.4444444444444446in"
height="0.5638888888888889in"} (1060)

![](media/image1147.wmf){width="1.7215277777777778in"
height="0.5638888888888889in"} (1061)

c)  The energies of low frequency bands and high frequency bands are
    computed as follows:

![](media/image1148.wmf){width="1.2597222222222222in"
height="1.1215277777777777in"} (1062)

d)  Obtain adjustment factors
    ![](media/image1118.wmf){width="0.4166666666666667in"
    height="0.19166666666666668in"} for the highest
    ![](media/image1104.wmf){width="0.18263888888888888in"
    height="0.20972222222222223in"} bands according to the tonality flag
    ![](media/image1127.wmf){width="0.5034722222222222in"
    height="0.23333333333333334in"}and the energies of low frequency
    bands and high frequency bands:

![](media/image1149.wmf){width="6.164583333333334in"
height="0.9027777777777778in"} (1063)

and for the highest
![](media/image1150.wmf){width="0.3659722222222222in"
height="0.20972222222222223in"} bands, update the adjustment factors
![](media/image1118.wmf){width="0.4166666666666667in"
height="0.19166666666666668in"} according to
![](media/image1151.wmf){width="0.5305555555555556in"
height="0.23333333333333334in"}:

![](media/image1152.wmf){width="5.000694444444444in"
height="0.9027777777777778in"} (1064)

and then adjust the quantized energy envelopes of the highest
![](media/image1153.wmf){width="0.18263888888888888in"
height="0.20972222222222223in"} bands
![](media/image1154.wmf){width="1.3736111111111111in"
height="0.23333333333333334in"}.

To adjust the quantized energy envelopes of low frequency bands at WB,
the following steps are performed:

a)  Initialize a low frequency band boundary
    ![](media/image1155.wmf){width="0.39861111111111114in"
    height="0.20972222222222223in"} to 6. For each band, calculate the
    magnitude envelope:

![](media/image1156.wmf){width="2.775in" height="0.48541666666666666in"}
(1065)

b)  Then, calculate the sum of the magnitude envelopes for high
    frequency bands:

![](media/image1115.wmf){width="1.5569444444444445in"
height="0.5638888888888889in"} (1066)

the variable![](media/image1157.wmf){width="0.43472222222222223in"
height="0.20972222222222223in"}is assigned to different value for
different bit rate, specifically it is assigned to 18, 20 for 13.2kbps
and 16.4kbps respectively.

c)  Search the peak of magnitude envelopes and calculate the sum of the
    magnitude envelops for low frequency bands:

![](media/image1116.wmf){width="3.06875in"
height="0.2513888888888889in"} (1067)

![](media/image1117.wmf){width="1.5027777777777778in"
height="0.5395833333333333in"} (1068)

d)  Determining whether to modify the quantized energy envelops of the
    six low frequency band according to their energy characteristics and
    spectral characteristics. The energy characteristics denote the
    ratio between the energy of six low frequency bands and the energy
    of the other bands which are determined by
    ![](media/image1137.wmf){width="0.5548611111111111in"
    height="0.2513888888888889in"} and
    ![](media/image1138.wmf){width="0.5305555555555556in"
    height="0.2513888888888889in"}; The spectral characteristics denote
    the degree of spectrum fluctuation which are determined
    by![](media/image1139.wmf){width="0.5638888888888889in"
    height="0.2513888888888889in"} .

If the conditions ![](media/image1158.wmf){width="5.486805555555556in"
height="0.2513888888888889in"} or
![](media/image1159.wmf){width="5.600694444444445in"
height="0.2513888888888889in"}are satisfied, the
flag![](media/image1160.wmf){width="0.7048611111111112in"
height="0.23333333333333334in"}, and the quantized energy envelops of
the six low frequency bands are adjusted as follows:

![](media/image1161.wmf){width="4.139583333333333in"
height="0.48541666666666666in"} (1069)

Finally, the adjusted quantized energy envelopes
![](media/image1162.wmf){width="0.23333333333333334in"
height="0.23333333333333334in"}and the initial quantized energy
envelopes ![](media/image1163.wmf){width="1.7777777777777777in"
height="0.2361111111111111in"}are used in the first bit allocation
module.

##### 5.3.4.1.4.1.4.3 Bit allocation for PFSC {#bit-allocation-for-pfsc .H6}

Based on the tonality flags, whether TCQ is used for encoding the band
in the high frequency region is determined. When the tonality flag is
set to "0", such band is excluded from target bands of the TCQ, i.e. no
bit is assigned to the band for TCQ.

In the Normal Mode, the four bands in the high-frequency region for
SWB/FB and one band for WB are assumed to be quantized by TCQ in default
operation. However, when the tonality flag is set to "0", such band is
quantized with the PFSC scheme using a similar procedure with the
"sub-band search" (called as "band search" in this specification) in
\[25\], whereas for WB cases such band is filled with noise. This means
the peaky/tonal bands are encoded by the TCQ while the PFSC scheme is
used for other bands.

In Figure 66, whether the PFSC is used for quantizing the high-frequency
bands is indicated by 'Quantizing mode'.

In the PFSC scheme, the band search is based on a pitch filter based
prediction (![](media/image1164.wmf){width="0.8965277777777778in"
height="0.23333333333333334in"}, where *T* is a pitch coefficient, and
low-frequency spectrum is used as its filter state (filter memory)), and
the pitch coefficient (i.e. lag information as a filter parameter) is
encoded. The lag information is encoded with 2 bits or 1 bit. Lower two
bands among the four bands are encoded with 2 bits, while higher two
bands among the four are encoded with 1 bit. When the PFSC is selected
for encoding some of the four bands, necessary bits for encoding those
bands are reserved and assigned for the bands before starting the
bit-allocation process for TCQ encoding bands.

##### 5.3.4.1.4.1.4.4 Bit allocation for TCQ {#bit-allocation-for-tcq .H6}

##### 5.3.4.1.4.1.4.4.1 Allocating bits for fine gain adjustment {#allocating-bits-for-fine-gain-adjustment .H6}

In the TCQ based MDCT coefficients quantization, fine gain adjustment is
applied to several bands whose energies are larger than the others. The
number of those bands is configured based on encoding bit-rate and
signal bandwidth as shown in table 119.

Table 119: Bits reserved for fine gain adjustments

  ----- ------------------------------------------------------------------------------------------------ ------------------------------------------------------------------------------------------------ ------------------------------------------------------------------------------------------------ ------------------------------------------------------------------------------------------------
        **7.2 kbit/s**                                                                                   **8.0 kbit/s**                                                                                   **13.2 kbit/s**                                                                                  **16.4 kbit/s**
  NB    2 bands, ![](media/image1165.wmf){width="0.5215277777777778in" height="0.20972222222222223in"}   2 bands, ![](media/image1166.wmf){width="0.5215277777777778in" height="0.20972222222222223in"}   4 bands, ![](media/image1167.wmf){width="0.5305555555555556in" height="0.20972222222222223in"}   2 bands, ![](media/image1168.wmf){width="0.5215277777777778in" height="0.20972222222222223in"}
  WB    \-                                                                                               \-                                                                                               6 bands, ![](media/image1169.wmf){width="0.5305555555555556in" height="0.20972222222222223in"}   6 bands, ![](media/image1170.wmf){width="0.5305555555555556in" height="0.20972222222222223in"}
  SWB   \-                                                                                               \-                                                                                               4 bands, ![](media/image1171.wmf){width="0.5305555555555556in" height="0.20972222222222223in"}   4 bands, ![](media/image1172.wmf){width="0.5305555555555556in" height="0.20972222222222223in"}
  ----- ------------------------------------------------------------------------------------------------ ------------------------------------------------------------------------------------------------ ------------------------------------------------------------------------------------------------ ------------------------------------------------------------------------------------------------

One-bit scalar quantization is used for the fine gain adjustment.
Therefore the number of reserved bits
![](media/image1173.wmf){width="0.2965277777777778in"
height="0.20972222222222223in"} for NB, WB, SWB, and FB is shown in the
table 119. The bits for the TCQ are obtained by subtracting the fine
gain bits, and expressed by![](media/image1174.wmf){width="1.1125in"
height="0.20972222222222223in"}, where
![](media/image1175.wmf){width="0.15555555555555556in"
height="0.16458333333333333in"}is the available bit budget for spectrum
coding, *e~bits~* is the bits consumed for quantizing the band energies
which is obtained from subclause 5.3.4.1.3, and *R* is the total bits.
It should be noted that the mode bits for switching
Transient/non-Transient and Normal/Harmonic are included in the
available bit budget. Therefore the necessary bits (1 or 2) are
subtracted from the available bit budget in the following subclauses,\
i.e. ![](media/image1176.wmf){width="0.5395833333333333in"
height="0.18263888888888888in"} (NB and WB cases) or
![](media/image1177.wmf){width="0.5486111111111112in"
height="0.19166666666666668in"} (SWB and FB cases).

##### 5.3.4.1.4.1.4.4.2 Limited-band mode {#limited-band-mode .H6}

For the SWB case, bandwidth, $k_{\text{width}}(b)$, is more than 50 bins
for the last four bands (i.e. *b*=18 to 21 in 13.2 kbps and *b*=20 to 23
in 16.4 kbps). At low bit-rates, such wide bandwidth would result in
insufficient quantization performance. Therefore, a limited-band mode is
introduced for achieving efficient encoding. In the limited-band mode,
only the vicinity of a perceptually important spectrum in each band is
targeted to be quantized, i.e., outside the vicinity in each band is not
targeted to be quantized. This is realized by the following principle. A
bandwidth is adaptively shortened if the maximum amplitude spectrum
frequency falls into a range of frequencies around the maximum amplitude
spectrum frequency in the previous frame. The difference between the
maximum amplitude spectrum frequencies for the current and previous
frame is calculated. When it is smaller than a threshold, the
limited-band mode is used for such band. The frequency position of the
maximum amplitude spectrum is searched for each of the four bands. The
position for the previous frame is stored in a memory, which was
searched using the quantized MDCT spectrum (i.e. decoded MDCT spectrum)
in the previous frame. The position for the current frame is searched
using the MDCT spectrum calculated from the input signal in the current
frame. When the limited-band mode is selected, the targeted band is
limited to the vicinity of the maximum amplitude spectrum frequency of
the previous frame. The range of the vicinity is 15 or 31 spectrum bins
depending on coding bit-rate and band index. One bit is used for
indicating whether the limited band mode is used when tonality flag is
set to "1".

The limited-band mode can be used only in the case where the
corresponding previous band was quantized by TCQ.

##### 5.3.4.1.4.1.4.4.3 Final bit allocation for TCQ and PFSC {#final-bit-allocation-for-tcq-and-pfsc .H6}

Band widths and quantized band energies are used for bit allocation. The
band widths are basically configured by Table 108. When the limited-band
mode is selected, corresponding band widths are shortened. Bit
allocation for TCQ is as follows. Firstly, bits are distributed
according to the quantized band energy. Secondly, if there is a band
whose assigned bits are less than a minimum number of bits, no bit is
assigned to the band and the assigned bits will be re-allocated to the
other bands. Thirdly, if there is a noise-like band whose assigned bits
are not sufficient in comparison with its bandwidth, no bit is assigned
to the band and the assigned bits will be re-allocated to the other
bands. Furthermore, assigned bits are compared with predefined
band-based threshold, and no bit is re-assigned if the assigned bits are
less than the threshold for the band.

In case no bit is assigned to any band among the highest four bands for
a SWB and FB signals, PFSC is used for quantizing such band. This case
can happen when the tonality flag is set to "1" but assigned bit results
in zero. In this case, necessary bits for the PFSC encoding for the band
is extracted from the bit budget for TCQ,
![](media/image1178.wmf){width="0.15555555555555556in"
height="0.16458333333333333in"} . Therefore
![](media/image1179.wmf){width="0.15555555555555556in"
height="0.16458333333333333in"} is updated by subtracting the necessary
bits, and the bit-allocation is re-calculated.

##### 5.3.4.1.4.1.5 Fine structure encoding {#fine-structure-encoding .H6}

##### 5.3.4.1.4.1.5.1 Trellis Coding Quantization (TCQ) {#trellis-coding-quantization-tcq .H6}

##### 5.3.4.1.4.1.5.1.1 Joint USQ and TCQ {#joint-usq-and-tcq .H6}

Trellis Coded Quantization (TCQ) quantizes the fine structure of
normalized spectrum, selecting the Important Spectral Components (ISCs).
The information for the selected ISCs in each band is coded as the
position, number, sign and magnitude of the ISCs. The magnitude
information is quantized by the joint Uniform Scalar Quantization (USQ)
and TCQ with arithmetic coding, while the information on position,
number and sign is coded by arithmetic coding. A block diagram of the
fine structure encoding using TCQ is depicted by the figure 68.

![](media/image1180.wmf){width="5.361805555555556in"
height="5.374305555555556in"}

Figure 68: Block diagram of fine structure encoding using TCQ

The encoding method is selected at the Selecting Encoding Method block
by the bit allocation and the information for each band. If a bit
allocated for a band is zero, all the samples in that band are coded to
zero by the zero encoding block. Otherwise, each band is quantized by
the selected quantizer.

The quantizer selection information selects the most efficient quantizer
between the USQ and TCQ by considering the input signal characteristics,
i.e. the bit allocation and the length of each band. If the average
number of bits for each sample in a band is greater or equal to 0.75,
the band is of high importance and USQ is used; for all other bands TCQ
is used. The quantizer selection flag, USQ\_TCQ\[i\], is set to 1 when
USQ is used.

The Scaling Bands block performs scaling at each band to control the bit
rate, using the bit allocations and the normalized spectrum for each
band. The scaling is done by considering the average bit allocation for
each spectral component in the band. If the average bit allocation is
bigger than the number specified by the bit allocation, then more
scaling is done.

The detailed scaling process is as follows. First the estimation of the
number of pulses for the current band is obtained using the length and
the bit allocation information for each band. Then the number of nonzero
positions is obtained by the following equation, which is based on the
probabilities.

![](media/image1181.wmf){width="2.6333333333333333in"
height="0.27847222222222223in"} (1070)

where *b* is the number of bits and calculated as:

![](media/image1182.wmf){width="2.46875in"
height="0.5638888888888889in"} (1071)

and the number of required bits for the positions is estimated as:

![](media/image1183.wmf){width="1.2506944444444446in"
height="0.23333333333333334in"} (1072)

where *n* is the band length, *m* is the number of pulses, *i* is number
of non-zero positions which have an ISC, and *b* is the number of bits
required for the given size of band and number of pulses. Finally the
number of pulses is selected by the *b* value which is the closest to
the value of the allocated bits for the band.

The initial scaling factor is decided by the estimation of the number of
pulses and the absolute value of the input signal. The input signal for
each band is scaled by this factor. If the estimated number of pulses is
not the same as the summation of the number of pulses for the quantized
signal after scaling, a pulse redistribution process will be performed
using the updated scaling coefficient. The redistribution process is as
follows: if the number of selected pulses is smaller than the number of
estimated pulses, the scaling coefficient will be decreased, otherwise
the scaling coefficient will be increased.

The distortion function for the TCQ is sum of squared distance of each
quantized and un-quantized value in each band. It is similar to the
Euclidean distance but avoids the square root, since only the relative
magnitudes of the values are needed rather than the exact distance.

![](media/image1184.wmf){width="1.1548611111111111in" height="0.5125in"}
(1073)

where ![](media/image1185.wmf){width="0.19166666666666668in"
height="0.2513888888888889in"} is actual value and
![](media/image1186.wmf){width="0.16458333333333333in"
height="0.2513888888888889in"} is quantized value.

For the USQ module the Euclidean distance is used to determine the best
quantized values. To minimize the computational complexity, the modified
equation including the scaling factor is used, which is done by
calculating the *d~1~* as:

![](media/image1187.wmf){width="1.3645833333333333in"
height="0.5638888888888889in"} (1074)

If the number of pulses per band does not match the required value, it
is necessary to add or delete some pulses while preserving the minimal
metric. This procedure is done in an iterative manner by adding or
deleting a single pulse, and then repeating until the number of pulses
reaches the required value.

To add or delete one pulse it is necessary to calculate *n* values of
distortions in order to select best one For example, the distortion
value *j* corresponds to adding pulse at *j*-th position in a band:

![](media/image1188.wmf){width="1.9048611111111111in"
height="0.5638888888888889in"} (1075)

To avoid the full calculation of this formula *n* times, the following
derivation can be used:

![](media/image1189.wmf){width="5.025in" height="1.7215277777777778in"}
(1076)

where values ![](media/image1190.wmf){width="1.3916666666666666in"
height="0.4673611111111111in"}can be calculated just once, *n* is the
band length (number of coefficients in a band), *p* is the input signal
of the quantizer , *q* is the quantized signal, and *g* is the scaling
factor. Finally the position *j*, which minimized the distortion *d*, is
selected and *q~j~* is updated.

To control the bit rate, an appropriate ISC has to be selected using the
scaled spectral coefficients at the Selecting Important Spectral
Components (ISCs) block. The spectral component to quantize is selected
by using the bit allocations for each band. This selection can have
various combinations which depend on the distribution and variance of
the spectral component. The actual non-zero position is then calculated.
The non-zero position is obtained by analyzing the amount of scaling and
redistribution operations. The non-zero position will be the ISC.

If the number of pulses is not controlled by the scaling and the
redistribution operations, the selected pulse will be quantized by TCQ
and the surplus adjusted with the results of the quantization. Hence, if
the number of non-zero position is greater than 1, and not equal to the
estimated number of the pulse, and the quantizer selection information
indicates the TCQ, the surplus redistribution process will be used. If
this condition is satisfied, the surplus will be redistributed by the
TCQ quantization operation in advance. If the real number of the pulses
from the TCQ quantization is smaller than the estimated number of pulses
which was derived for each band in advance, the scale factor will be
multiplied by 1.1. However, if the number of pulses from the TCQ
quantization is bigger than the estimated number of pulses, the scale
factor will be multiplied by 0.9.

The final selected non-zero position is called by ISC whose information
is encoded at the Encoding Position Info block. The information consists
of the number of the selected ISC and the non-zero positions. In order
to enhance the efficiency of the information encoding arithmetic coding
is used.

Given a stream of symbols and their probabilities, the arithmetic coder
produces a space efficient bit-stream to represent these symbols and,
given the bit stream and the probabilities, the arithmetic decoder
reverses the process.

In the arithmetic coding algorithm two 16 bits integers are taken as the
numerators of fractions called "low" and "high".  These fractions have a
common denominator equal
to![](media/image1191.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"}, such that all the fractions fall in the
range ![](media/image1192.wmf){width="0.2965277777777778in"
height="0.20972222222222223in"}. These integers define a range so that a
single number stores all the symbols of the message. This number is
saved bit by bit to the bit stream during the arithmetic coding process.
To avoid precision loss, at each step of coding process renormalization
is performed when difference between 'low' and 'high' is less than 0.5.

In the decoder, 16 bits will first be read and stored in the arithmetic
decoder accumulator. The decoder can then replicate the coding process,
but instead of encoding the values, it uses the bit-stream to produce
symbols. These symbols will be reconstructed correctly, if their
probabilities are the same in both the encoder and decoder.

In the Gathering ISCs block, the new buffer is constructed by the
selected ISCs, as shown in figure 69. The zero-band and the position
which is not selected are both excluded from this buffer.

In the Joint USQ and TCQ Coding block, the magnitudes of the gathered
ISCs are quantized by the joint USQ and TCQ, and the quantized
information is additionally coded by arithmetic coding. In order to
enhance the efficiency of the arithmetic coding, the non-zero position
and the number of ISCs is utilized for the arithmetic coding. The joint
USQ and TCQ have two types of coding methods. One is TCQ and USQ with
2^nd^ bit allocation for the NB and WB, and the other one is the LSB TCQ
for USQ for the SWB and FB. These methods are described in subclause
5.3.4.1.4.1.5.1.2 TCQ and USQ with second bit allocation and subclause
5.3.4.1.4.1.5.1.3 LSB TCQ for USQ.

![](media/image1193.wmf){width="5.584722222222222in"
height="2.0520833333333335in"}

Figure 69: Concept for the g**athering ISCs**

In the Encode Signs block, the sign information of the selected ISC is
coded by the arithmetic coding. In order to recover the quantized
components, the position, sign and magnitude information is added to the
quantized components to recover the real components at the Recovering
Quantized Coefficients block. In this block, the zero is allocated to
the zero positions.

In the Inverse Scaling Bands block, the inverse scaling of the quantized
components is performed. The inverse scaling factor can be extracted by
using the scaling factor in the Scaling Bands block. The inverse scaled
signal is same level as that of the normalized input signal and the
signal is the output of the TCQ quantization.

##### 5.3.4.1.4.1.5.1.2 TCQ and USQ with second bit allocation {#tcq-and-usq-with-second-bit-allocation .H6}

The following information is needed for TCQ and USQ with second bit
allocation:

(a) Determine the total number of bits which will be allocated to the
    corresponding bands to be processed in current frame in subclause
    5.3.4.1.4.1.4.4.1.

(b) In order to obtain the number of bits for each band by first bit
    allocation, implement the first bit allocation to the bands based on
    the total number of bits to be allocated in subclause
    5.3.4.1.4.1.4.4.3.

(c) Based on the number of bits for each band by first bit allocation,
    the first detailed scaling process in subclause 5.3.4.1.4.1.5.1.1 is
    implemented on each band which is allocated bits by first bit
    allocation. Then, the total number of redundant bits of the current
    frame and the number of pulses of each band are obtained.

The general quantization and coding scheme of the TCQ and USQ with
second bit allocation consists of several main blocks: quantizer
decision, TCQ quantizer, USQ quantizer, lossless coder, and second bit
allocation. In the quantizer decision module the quantization mode of
the current band is selected by using the results of the Selecting
Encoding Method block. Then the selected quantizer quantizes the current
band, and the lossless encoder based on the arithmetic coding transmits
the data to the bit stream. The second bit allocation block distributes
surplus bits from the previously coded bands. The second bit allocation
procedure detects two bands that will be encoded separately.

![](media/image1194.wmf){width="6.690277777777778in"
height="2.129166666666667in"}

Figure 70: Block diagram of **TCQ and USQ encoding with second bit
allocation**

Based on the second bit allocation parameters, two bands are selected
from those bands allocated bits during the first bit allocation that
will be allocated more bits. The second bit allocation parameters
include at least one of the total number of redundant bits and the
characteristics of each band. The characteristics of each band include
the harmonic characteristics and the bit allocation state of each band.
The tonality flags for the bands of current frame which are calculated
in subclause 5.3.4.1.4.1.3 represent the harmonic characteristics of
each band, and whether the highest two bands of the previous frame is
quantized represents the bit allocation state of each band. If the
tonality flag is equal to one, the signal type of corresponding band is
harmonic. Otherwise, the signal type of corresponding band is not
harmonic. If the tonality flags are not all zero or any one of the
highest two bands of the previous frame is quantized, the two bands to
be quantized last will be finally selected in the highest few bands.
Otherwise, they will be selected in other bands than the highest few
ones.

The first of these two bands is selected using the analysis of the
average number of bits per bin in the band by the first bit allocation:

For each band, calculate the average number of bits per bin as follows:

![](media/image1195.wmf){width="2.46875in"
height="0.39861111111111114in"} (1077)

where *R(b)* is the number of bits allocated to each band by the first
bit allocation based on the total number of bits in the subclause
5.3.4.1.4.1.4.4.3, and
![](media/image1196.wmf){width="0.5548611111111111in"
height="0.20972222222222223in"} is the bandwidth of each band.

In order to determine the first band, the average number of bits per bin
of each band will be compared. And the bands should satisfy the
following conditions:

![](media/image1197.wmf){width="4.763888888888889in"
height="0.23333333333333334in"} (1078)

where ![](media/image1198.wmf){width="0.5034722222222222in"
height="0.23333333333333334in"} is the tonality flag, and
![](media/image1199.wmf){width="0.5305555555555556in"
height="0.23333333333333334in"} indicates whether the highest two bands
of the previous frame is quantized. If
![](media/image1200.wmf){width="0.5305555555555556in"
height="0.23333333333333334in"}is equal to 1, the band
![](media/image1130.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"}of the previous frame is quantized, else
if ![](media/image1200.wmf){width="0.5305555555555556in"
height="0.23333333333333334in"}is equal to 0, the band
![](media/image1131.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"}of the previous frame is not quantized.

If the average number of bits per bin in band
![](media/image1131.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"} is the least one in the bands which
satisfy the above conditions, the band
![](media/image1131.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"} will be determined as the first band for
a second bit allocation.

When there are no bands satisfy the above conditions or the encoded
bandwidth is NB, the first band for a second bit allocation will be
selected during the bands which satisfy the following conditions:

![](media/image1201.wmf){width="2.120833333333333in"
height="0.20972222222222223in"} (1079)

If the average number of bits per bin in band
![](media/image1131.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"} is the least one in the bands which
satisfy the above conditions, the band
![](media/image1131.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"} will be determined as the first band for
a second bit allocation.

For the first band
![](media/image1131.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"} for a second bit allocation, if
![](media/image1202.wmf){width="0.32083333333333336in"
height="0.16458333333333333in"}
or![](media/image1203.wmf){width="0.8159722222222222in"
height="0.20972222222222223in"}, then the band
![](media/image1204.wmf){width="0.2965277777777778in"
height="0.16458333333333333in"} or the band
![](media/image1205.wmf){width="0.2513888888888889in"
height="0.16458333333333333in"} will be selected as the second band for
a second bit allocation. Otherwise, for the band
![](media/image1204.wmf){width="0.2965277777777778in"
height="0.16458333333333333in"} and the
band![](media/image1205.wmf){width="0.2513888888888889in"
height="0.16458333333333333in"}, if the average number of bits per bin
of the band ![](media/image1204.wmf){width="0.2965277777777778in"
height="0.16458333333333333in"} is less than the
band![](media/image1205.wmf){width="0.2513888888888889in"
height="0.16458333333333333in"}, the band
![](media/image1204.wmf){width="0.2965277777777778in"
height="0.16458333333333333in"} will be selected as the second band for
a second bit allocation, if not, the band
![](media/image1205.wmf){width="0.2513888888888889in"
height="0.16458333333333333in"} will be selected as the second band for
a second bit allocation.

Thus implement the second bit allocation on the two selected bands to be
allocated bits once again. When the total number of redundant bits is
replenished, the redundant bits are allocated to the two bands selected
above, with the first one being allocated the majority, or all, of the
surplus. The number of bits allocated to the two bands is obtained
respectively and the proportion of the surplus allocated to each band is
shown in the following:

When the encoded bandwidth is NB:

![](media/image1206.wmf){width="1.5986111111111112in"
height="1.538888888888889in"} (1080)

When the encoded bandwidth is WB:

![](media/image1207.wmf){width="1.5833333333333333in"
height="1.538888888888889in"} (1081)

where ![](media/image1208.wmf){width="0.4673611111111111in"
height="0.23333333333333334in"} denotes the bit surplus,
![](media/image1209.wmf){width="0.4618055555555556in"
height="0.20972222222222223in"} and
![](media/image1210.wmf){width="0.44375in"
height="0.20972222222222223in"} denotes the number of bits allocated to
the first and the second band for a second bit allocation respectively.

At last, based on the number of bits allocated to the two selected bands
by the first bit allocation and the number of bits allocated to the two
selected bands by the second bit allocation, implement the second
detailed scaling process on each of the two selected bands same as the
first detailed scaling process in subclause 5.3.4.1.4.1.5.1.1. So, the
number of pulses for each of the two selected bands is obtained again.

In the TCQ quantization module a trellis is used with 8 states, 4-coset
(subsets) with 2 zero levels. The quantization indexes are derived from
the TCQ codebook, which consists of the branch information of a trellis
state (path information) and the information for quantization level
allocated to the selected coset (subset). The quantization indexes are
always positive integers and are coded by arithmetic coding. The
detailed magnitude encoding is as follows.

![](media/image1211.wmf){width="6.5in" height="2.6777777777777776in"}

Figure 71: **Trellis structure with 8 states 4-coset with 2 zero
levels**

Each quantized band starts from state (0), because in other cases it is
required to transmit two additional bits per band. Then, by using the
Viterbi algorithm, the optimal path through trellis is selected, in
order to have best possible SNR when comparing the original and
quantized sequences. To calculate the SNR, it is necessary to have
quantization scale before starting TCQ quantization, so the band is
initially quantized by USQ and the optimal scale is calculated. After
the lossless encoding the bit surplus is accumulated.

The accumulated surplus is used as an additional resource for the
encoding of the last two bands determined by the second bit allocation
procedure. Depending on the coding mode and surplus value, the surplus
is shared between these two bands in different proportions. Then the
encoding of these two bands is performed in the same way as described
above.

The magnitude coding based on binary arithmetic coding is carried out as
follows. First the probability of a symbol is calculated as

![](media/image1212.wmf){width="1.8777777777777778in"
height="0.6263888888888889in"} (1082)

![](media/image1213.wmf){width="0.7645833333333333in"
height="0.2513888888888889in"} (1083)

where ![](media/image1214.wmf){width="0.11388888888888889in"
height="0.23333333333333334in"} is the number of magnitudes left to
transmit in the band,
![](media/image1215.wmf){width="0.18263888888888888in"
height="0.19166666666666668in"} is the number of pulses left to transmit
in the band, ![](media/image1216.wmf){width="0.1375in"
height="0.20972222222222223in"} is the current coded pulse in magnitude
and ![](media/image1217.wmf){width="0.2604166666666667in"
height="0.2513888888888889in"} is the set of existing magnitudes at
trellis state ![](media/image1218.wmf){width="0.12291666666666666in"
height="0.14652777777777778in"}.

Each magnitude pulse is encoded by using probabilities
![](media/image1219.wmf){width="0.19166666666666668in"
height="0.23333333333333334in"} and
![](media/image1220.wmf){width="0.20972222222222223in"
height="0.2513888888888889in"}, where
![](media/image1221.wmf){width="0.19166666666666668in"
height="0.23333333333333334in"}corresponds to last pulse in magnitude
and ![](media/image1222.wmf){width="0.20972222222222223in"
height="0.2513888888888889in"} to all other pulses.

The magnitude pulse probabilities are modified after this calculation
with respect to the trellis code limitation. This information is
determined by the trellis structure and is available to both the encoder
and decoder. Thus any magnitude values that are impossible are encoded
using zero probability and hence do not require any bits.

The encoding algorithm was modified to save complexity for bands with a
large number of pulses. The idea is to introduce a non-binary arithmetic
coder, where the probabilities of a coded symbol are calculated as the
mutual probability of the binary symbols for the current magnitude. To
avoid very low probabilities and hence loss of precision, escape symbols
are utilized. After an escape symbol transmitted, the rest of the
magnitude pulses transmitted are started from initial probabilities
condition.

The location coding is carried out based on same algorithm as used for
the magnitude coding and uses the same complexity reduction technique.
The signs and LSB path vector are transmitted as is, because the
distributions are random.

##### 5.3.4.1.4.1.5.1.3 LSB TCQ for USQ {#lsb-tcq-for-usq .H6}

The aim of the LSB TCQ for USQ is to use the advantages of both
quantizers (USQ and TCQ) in one scheme and exclude the path limitation
from the TCQ. Conceptually the LSB coding of the quantized data is shown
in figure 72.

![](media/image1223.wmf){width="5.426388888888889in"
height="2.451388888888889in"}

Figure 72: **Concept of LSB coding**

Each quantized value that is greater than one contains an LSB which can
be zero or one. The sequence of LSBs can then be quantized by TCQ to
find the best match between that sequence and the available trellis
paths. In terms of the SNR criteria, it does not matter where the error
occurs. Thus at the cost of some errors in the quantized sequence, the
length of the sequence is decreased.

The encoding of the spectral data is done by the TCQ and USQ quantizers
and lossless coding based on the binary arithmetic coder. Before
processing the norms, the extraction and spectrum normalization are
done. The combined quantizer scheme is presented at figure 73.

![](media/image1224.wmf){width="6.361805555555556in"
height="3.182638888888889in"}

Figure 73: **Block diagram for LSB TCQ for USQ encoding**

The spectral data in each band are quantized by the USQ quantizer with
the number on bits *R\[\]* determined by the bit allocation module. In
order to fit the bit requirement, the number of bits which will be used
for TCQ data is extracted from each non-zero band evenly, and then the
bands are quantized by the USQ. The quantization procedure is the same
as described above for the TCQ and USQ algorithm. All bands that have
non-zero data after quantization are collected as the difference between
the quantized and un-quantized data and are called the residual. If some
frequencies are quantized as zero in a nonzero band, they are not
included into residual.

![](media/image1225.wmf){width="6.205555555555556in" height="1.8in"}

Figure 74: Concept for constructing the residual array

The residual array is quantized by TCQ with code rate ½ known (7,5)~8~
code:

![](media/image1226.png){width="2.295138888888889in"
height="1.417361111111111in"}

Figure 75: **Trellis structure for the 4 states TCQ**

Quantization using TCQ is performed for the first
![](media/image1227.wmf){width="0.8159722222222222in"
height="0.1736111111111111in"} magnitudes. After quantization the path
metrics are checked and the best one selected. For lossless coding the
data for the best trellis path is stored in separate array while the
trace back procedure is performed. The constant
![](media/image1228.wmf){width="0.6958333333333333in"
height="0.18263888888888888in"} was defined as 10, which allows up to 20
magnitudes per frame to be encoded.

The trellis path data is encoded by the arithmetic encoder as
equi-probable symbols. The path data is binary sequence which is encoded
using an arithmetic encoder with a uniform probability model.

The quantized spectral data produced by the USQ are encoded by the same
method as described in subclause 5.3.4.1.4.1.5.1.2

The quantized MDCT coefficients are de-normalized using the quantized
band energies.

Finally, as described in subclause 5.3.4.1.4.1.4.4.1, quantization of
fine gain adjustment is performed on the dominant bands. The inner
product between target MDCT coefficients and the de-normalized quantized
MDCT coefficients is calculated, and fine gain adjustment factor is
calculated by dividing the inner product by the energy of the
de-normalized quantized MDCT coefficients. The fine gain adjustment
factor is quantized by a 1-bit scalar quantizer.

##### 5.3.4.1.4.1.5.2 Noise-filling for 0-bit assigned sub-bands {#noise-filling-for-0-bit-assigned-sub-bands .H6}

Decode the MDCT coefficients of each sub-band from the received bit
stream. In order to reconstruct the un-decoded MDCT coefficients, the
sub-bands are classified into the bit allocation saturated sub-bands and
the bit allocation un-saturated sub-bands according to the average
number of bit allocation to a coefficient in a sub-band. The noise
filling module is applied to the un-saturated sub-bands. Firstly the
noise gain for noise filling of each sub-band is calculated. Then, fill
the appropriate noise into the un-decoded MDCT coefficients of each
sub-band, and the un-decoded MDCT coefficients are reconstructed. At
last, the whole frequency domain signal is obtained based on the decoded
MDCT coefficients and the reconstructed MDCT coefficients.

##### 5.3.4.1.4.1.5.2.1 Parameters calculation for noise gain {#parameters-calculation-for-noise-gain .H6}

Initialize a critical number of the sub-band
![](media/image1229.wmf){width="0.2604166666666667in"
height="0.20972222222222223in"}
to![](media/image1230.wmf){width="0.43472222222222223in"
height="0.20972222222222223in"}. If the encoded bandwidth is SWB and the
encoding mode is harmonic or normal,
![](media/image1231.wmf){width="0.2604166666666667in"
height="0.20972222222222223in"} is updated to 19 at 16.4kbps and
![](media/image1232.wmf){width="0.2604166666666667in"
height="0.20972222222222223in"} is updated to 17 at 13.2kbps.

Calculate the average number of allocated bits for each coefficient in
each sub-band:

![](media/image1233.wmf){width="2.5375in"
height="0.39861111111111114in"} (1084)

where ![](media/image1234.wmf){width="0.30277777777777776in"
height="0.20972222222222223in"} denotes the number of bits allocated to
each sub-band, and ![](media/image1235.wmf){width="0.5548611111111111in"
height="0.20972222222222223in"} denotes the bandwidth of each sub-band.

Calculate the average envelope of each sub-band:

![](media/image1236.wmf){width="2.775in" height="0.48541666666666666in"}
(1085)

where ![](media/image1237.wmf){width="0.4166666666666667in"
height="0.23333333333333334in"} denotes the quantized energy of each
sub-band.

The maximum magnitude of the decoded coefficients in each sub-band
![](media/image1238.wmf){width="0.5395833333333333in"
height="0.23333333333333334in"} and the number of the non-zero decoded
coefficients in each sub-band
![](media/image1239.wmf){width="0.43472222222222223in"
height="0.20972222222222223in"} are determined by the decoded
coefficients.

Suppose ![](media/image1240.wmf){width="0.5819444444444445in"
height="0.20972222222222223in"} denotes the number of the encoded pulses
of each sub-band and
![](media/image1241.wmf){width="0.8097222222222222in"
height="0.20972222222222223in"} means the average number of bit
allocation to a coefficient in a sub-band is larger than 0. And the
energy difference ![](media/image1242.wmf){width="0.5034722222222222in"
height="0.23333333333333334in"} is obtained as follows:

![](media/image1243.wmf){width="1.9826388888888888in"
height="0.5638888888888889in"} (1086)

If ![](media/image1241.wmf){width="0.8097222222222222in"
height="0.20972222222222223in"}, compute the initial noise gain of each
sub-band ![](media/image1244.wmf){width="0.4166666666666667in"
height="0.2604166666666667in"} by the energy difference
![](media/image1245.wmf){width="0.5034722222222222in"
height="0.23333333333333334in"} and sub-band bandwidth
![](media/image1246.wmf){width="0.6083333333333333in"
height="0.23333333333333334in"}:

![](media/image1247.wmf){width="2.504861111111111in"
height="0.8159722222222222in"} (1087)

Otherwise, ![](media/image1248.wmf){width="1.0854166666666667in"
height="0.2604166666666667in"}.

And, if ![](media/image1241.wmf){width="0.8097222222222222in"
height="0.20972222222222223in"}, compute the parameter of harmonic
character ![](media/image1249.wmf){width="1.1395833333333334in"
height="0.23333333333333334in"}. The parameter of harmonic character
![](media/image1249.wmf){width="1.1395833333333334in"
height="0.23333333333333334in"} is used to calculate the noise gain,
then fill noise to the not decoded coefficients of bit allocation
un-saturated sub-band.

##### 5.3.4.1.4.1.5.2.2 Noise gain calculation {#noise-gain-calculation .H6}

If the average number of bit allocation to a coefficient in a sub-band
![](media/image1250.wmf){width="0.43472222222222223in"
height="0.20972222222222223in"} is not less than 0.8, the bit allocation
of the sub-band is defined as saturated; otherwise, the bit allocation
of the sub-band is defined as un-saturated.

When the bit allocation of sub-band
![](media/image1251.wmf){width="0.12291666666666666in"
height="0.18263888888888888in"} is un-saturated and
![](media/image1252.wmf){width="0.6083333333333333in"
height="0.2604166666666667in"}, based on the envelope and decoded
coefficients the noise gain
![](media/image1253.wmf){width="0.4166666666666667in"
height="0.2604166666666667in"} is calculated as follows:

\(a\) First estimate the overall noise factors
![](media/image1254.wmf){width="0.2513888888888889in"
height="0.20972222222222223in"}under different conditions:

> (a1) When ![](media/image1255.wmf){width="0.7916666666666666in"
> height="0.19166666666666668in"} and the encoded bandwidth is SWB:
>
> If the encoding mode is harmonic and
> ![](media/image1256.wmf){width="0.48541666666666666in"
> height="0.20972222222222223in"} :

![](media/image1257.wmf){width="2.4868055555555557in"
height="0.5034722222222222in"} (1088)

> If the encoding mode is harmonic and
> ![](media/image1258.wmf){width="0.4673611111111111in"
> height="0.20972222222222223in"} :

![](media/image1259.wmf){width="1.0256944444444445in"
height="0.48541666666666666in"} (1089)

> If the encoding mode is normal and
> ![](media/image1260.wmf){width="0.4673611111111111in"
> height="0.20972222222222223in"} :

![](media/image1261.wmf){width="1.8173611111111112in"
height="0.48541666666666666in"} (1090)

> If the encoding mode is normal and
> ![](media/image1262.wmf){width="0.4673611111111111in"
> height="0.20972222222222223in"} :

![](media/image1263.wmf){width="0.975in" height="0.48541666666666666in"}
(1091)

> If the encoding mode is transient:

![](media/image1264.wmf){width="0.5395833333333333in"
height="0.19166666666666668in"} (1092)

> (a2) When ![](media/image1265.wmf){width="0.7916666666666666in"
> height="0.19166666666666668in"} and the encoded bandwidth is WB or NB:
>
> Initialize ![](media/image1266.wmf){width="0.2513888888888889in"
> height="0.20972222222222223in"} as:

![](media/image1267.wmf){width="2.9305555555555554in"
height="0.5034722222222222in"} (1093)

> While ![](media/image1268.wmf){width="0.30277777777777776in"
> height="0.16458333333333333in"}
> and![](media/image1269.wmf){width="0.8159722222222222in"
> height="0.20972222222222223in"},
> ![](media/image1270.wmf){width="0.2513888888888889in"
> height="0.20972222222222223in"} is updated as follows:

![](media/image1271.wmf){width="4.886805555555555in"
height="1.4604166666666667in"} (1094)

> While ![](media/image1272.wmf){width="1.3645833333333333in"
> height="0.23333333333333334in"} and the encoded bandwidth is WB,
> ![](media/image1273.wmf){width="0.2513888888888889in"
> height="0.20972222222222223in"} is updated as follows. Where
> ![](media/image1274.wmf){width="0.6354166666666666in"
> height="0.23333333333333334in"} is a number of sub-bands at the
> highest frequency which have a flag
> ![](media/image1275.wmf){width="0.7375in"
> height="0.20972222222222223in"} to indicate whether the sub-band is
> harmonic or not. If ![](media/image1276.wmf){width="0.7375in"
> height="0.20972222222222223in"} is equal to 1, the sub-band
> ![](media/image1277.wmf){width="0.12291666666666666in"
> height="0.18263888888888888in"}have harmonic character; otherwise, the
> sub-band ![](media/image1278.wmf){width="0.12291666666666666in"
> height="0.18263888888888888in"} do not have harmonic character.

![](media/image1279.wmf){width="2.8618055555555557in"
height="1.9319444444444445in"} (1095)

> where ![](media/image1280.wmf){width="0.38958333333333334in"
> height="0.20972222222222223in"} and
> ![](media/image1281.wmf){width="0.3659722222222222in"
> height="0.20972222222222223in"} denote the energy of high frequency
> bands and low frequency bands, respectively.
> ![](media/image1282.wmf){width="0.30277777777777776in"
> height="0.20972222222222223in"} and
> ![](media/image1283.wmf){width="0.30277777777777776in"
> height="0.20972222222222223in"} denote the numbers of correspond high
> frequency coefficients and correspond low frequency coefficients
> respectively.
>
> (a3) When![](media/image1284.wmf){width="0.7916666666666666in"
> height="0.19166666666666668in"},
> ![](media/image1285.wmf){width="0.2513888888888889in"
> height="0.20972222222222223in"} is determined as follows:
>
> If the encoded bandwidth is SWB and the encoding mode is
> harmonic![](media/image1286.wmf){width="0.5548611111111111in"
> height="0.19166666666666668in"}; Otherwise,
> ![](media/image1287.wmf){width="0.5548611111111111in"
> height="0.20972222222222223in"}.

\(b\) Based on the overall noise
factor![](media/image1288.wmf){width="0.2513888888888889in"
height="0.20972222222222223in"}, the noise gain is calculated:

![](media/image1289.wmf){width="1.2083333333333333in"
height="0.2604166666666667in"} (1096)

> When the sub-band
> ![](media/image1290.wmf){width="0.12291666666666666in"
> height="0.18263888888888888in"} is a bit allocation saturated sub-band
> or ![](media/image1291.wmf){width="0.39861111111111114in"
> height="0.2604166666666667in"} is less than zero, the noise gain
> ![](media/image1292.wmf){width="0.39861111111111114in"
> height="0.2604166666666667in"} is set to zero.

\(c\) In order to smooth the noise gain between the current frame and
the previous frame, a sub-band boundary
![](media/image1293.wmf){width="0.3298611111111111in"
height="0.23333333333333334in"} is defined. If the encoded bandwidth is
SWB, ![](media/image1294.wmf){width="1.0527777777777778in"
height="0.23333333333333334in"}. Otherwise,
![](media/image1295.wmf){width="1.6347222222222222in"
height="0.2965277777777778in"}. Here
![](media/image1296.wmf){width="0.4166666666666667in"
height="0.23333333333333334in"} denotes the last sub-band with encoded
pulses in current frame,
![](media/image1297.wmf){width="0.4166666666666667in"
height="0.2965277777777778in"} denotes the last sub-band with encoded
pulses in previous frame.

> For the sub-band![](media/image1298.wmf){width="0.12291666666666666in"
> height="0.18263888888888888in"},
> if![](media/image1299.wmf){width="0.7645833333333333in"
> height="0.23333333333333334in"}, then the noise gain
> ![](media/image1300.wmf){width="0.39861111111111114in"
> height="0.2604166666666667in"} is smoothed as follows:
>
> When ![](media/image1301.wmf){width="0.12291666666666666in"
> height="0.18263888888888888in"} is less
> than![](media/image1302.wmf){width="0.6083333333333333in"
> height="0.20972222222222223in"}:

![](media/image1303.wmf){width="5.417361111111111in"
height="2.234722222222222in"} (1097)

> When ![](media/image1304.wmf){width="0.12291666666666666in"
> height="0.18263888888888888in"} is equal
> to![](media/image1305.wmf){width="0.6083333333333333in"
> height="0.20972222222222223in"}:

![](media/image1306.wmf){width="3.842361111111111in"
height="2.234722222222222in"} (1098)

> where ![](media/image1307.wmf){width="0.6354166666666666in"
> height="0.2513888888888889in"} denotes the average envelope of the
> previous frame, ![](media/image1308.wmf){width="0.48541666666666666in"
> height="0.2965277777777778in"} denotes the noise gain of the previous
> frame.

##### 5.3.4.1.4.1.5.2.3 Noise filling {#noise-filling-1 .H6}

First, if the encoded bandwidth is not SWB
and![](media/image1309.wmf){width="2.609722222222222in"
height="0.23333333333333334in"}, modify the decoded coefficients:

![](media/image1310.wmf){width="4.322916666666667in"
height="0.2604166666666667in"} (1099)

For sub-band![](media/image1251.wmf){width="0.12291666666666666in"
height="0.18263888888888888in"}, if the conditions: bit allocation is
unsaturated, the encoded bandwidth is not SWB,
![](media/image1311.wmf){width="0.6263888888888889in"
height="0.23333333333333334in"},![](media/image1312.wmf){width="1.3645833333333333in"
height="0.23333333333333334in"} are all satisfied, the decoded
coefficients is filled noise as follows:

Initialize a counter
![](media/image1313.wmf){width="0.16458333333333333in"
height="0.23333333333333334in"} to zero. Based on the smoothed noise
gain, calculate a noise filling factor:

![](media/image1314.wmf){width="1.4423611111111112in" height="0.5125in"}
(1100)

If the decoded coefficient
![](media/image1315.wmf){width="0.4673611111111111in"
height="0.23333333333333334in"}is equal to zero,

![](media/image1316.wmf){width="2.948611111111111in"
height="0.43472222222222223in"} (1101)

where ![](media/image1317.wmf){width="0.3659722222222222in"
height="0.18263888888888888in"} is generated by random noise,
![](media/image1313.wmf){width="0.16458333333333333in"
height="0.23333333333333334in"} is increased by 1.

Otherwise, the noise filling of the decoded coefficients is described as
follows:

![](media/image1318.wmf){width="1.913888888888889in"
height="0.2604166666666667in"} (1102)

Finally, update the memories as follows:

![](media/image1319.wmf){width="1.2958333333333334in"
height="0.2513888888888889in"},![](media/image1320.wmf){width="0.9833333333333333in"
height="0.2965277777777778in"},![](media/image1321.wmf){width="0.9298611111111111in"
height="0.30277777777777776in"} (1103)

##### 5.3.4.1.4.1.5.3 Pitch filtering spectrum coding (PFSC) {#pitch-filtering-spectrum-coding-pfsc .H6}

##### 5.3.4.1.4.1.5.3.1 PFSC overview {#pfsc-overview .H6}

Pitch filtering spectrum coding is applied only for the SWB and FB
signals.

To encode and decode high frequency MDCT coefficients, PFSC utilizes
both decoded MDCT coefficients which is the output of "TCQ", "De-norm
and Fine gain SQ" blocks in Figure 66 and noise-filled low-frequency
decoded MDCT coefficients. The band which is encoded by PFSC is
determined through the bit-allocation process described in the previous
subclauses. In the PFSC, the four highest bands are the high-frequency
bands, and the other bands lower than the high-frequency bands are the
low-frequency bands. For example, in Table 108, the low-frequency bands
are $b$=0 to 17, and the high-frequency bands are $b$=18 to 21, for the
13.2 kbps.

For each band, the most similar match with the selected similarity
criteria is searched from the TCQ-quantized and envelope normalized
low-frequency content (i.e., the envelope normalized version of the
decoded MDCT coefficients in the low-frequency bands). The most similar
match is scaled with a scaling factor calculated using the quantized
band energy to obtain the synthesized high frequency content.

##### 5.3.4.1.4.1.5.3.2 Envelope normalization {#envelope-normalization .H6}

In a manner similar to G.718 Annex B, quantized low-frequency content is
normalized with its envelope. However, the TCQ-quantized low-frequency
content (which is the decoded low-frequency content before the noise
filling) is a sparse pulse sequence, and a normalization process is
therefore used to flatten the low-frequency content.

The low-frequency content is normalized by dividing it by the maximum
amplitude value in each sub-band. Here, the sub-band configuration is
special and used only for this normalization. Each sub-band consists of
12 MDCT coefficients. By performing this process, each sub-band will
have the same maximum amplitude value, and the low-frequency content can
therefore be converted to an MDCT coefficient sequence whose spectral
characteristic is flat and smoothed.

The envelope normalization (or smoothing) process is separately
performed on the TCQ-quantized low-frequency content and the filled
low-frequency noise content, respectively. And the amplitude of the
normalized noise content is adaptively scaled according to the
sparseness of the TCQ-quantized low-frequency content. The sparseness is
calculated by dividing the number of non-zero spectrum in the
TCQ-quantized low-frequency content by the bandwidth of the
low-frequency content. A threshold is calculated using the sparseness
and used for removing low amplitude TCQ-quantized low-frequency content
and for scaling the maximum amplitude of the noise content. The
normalized TCQ-quantized low-frequency content is further modified so
that its non-zero content has larger amplitude than the maximum
amplitude of the normalized noise content thus dynamic range of the
normalized TCQ-quantized low-frequency content is modified for better
matching with a targeted high-frequency spectrum. Finally, the scaled
low-frequency noise content and the modified TCQ-quantized low-frequency
content are added for generating envelope normalized spectrum (MDCT
coefficients). If the generated spectrum becomes zero, such spectrum
component is replaced with a randomly generated noise whose maximum
amplitude is limited to the half of the maximum amplitude of the scaled
noise component.

A block diagram of this envelope normalization is shown in Figure 98 of
subclause 6.2.3.1.3.1.4.3.3. In Figure 98, all processing blocks except
'Lag info. decoding' are common to the both sides of encoder and
decoder.

##### 5.3.4.1.4.1.5.3.3 Band search {#band-search .H6}

##### 5.3.4.1.4.1.5.3.3.1 Selection of representative MDCT coefficients {#selection-of-representative-mdct-coefficients .H6}

Similarly to G.718 Annex B, a band search approach is used. The last
four bands (i.e. *b*=18 to 21 in 13.2 kbps and *b*=20 to 23 in 16.4
kbps) are then subject to be encoded with PFSC. As shown in the table
108, the widths of the bands are 55, 68, 84, and 105 for 13.2 kbps, and
59, 74, 92, and 115 for 16.4 kbps.

To reduce computational load for calculating correlation, only limited
number of input (target) MDCT coefficients are selected as
representative MDCT coefficients and used for correlation calculation.
The selection of the MDCT coefficients is performed by amplitude
threshold process, i.e. an MDCT coefficient is selected if its absolute
value is greater than a threshold. The threshold is determined using the
average and standard deviation of the absolute values of the MDCT
coefficients in a subjected high-frequency band.

![](media/image1322.wmf){width="1.148611111111111in"
height="0.20972222222222223in"} (1104)

Here ![](media/image1323.wmf){width="0.24166666666666667in"
height="0.20833333333333334in"}is the initial threshold for the *i*-th
high-frequency band, ![](media/image1324.wmf){width="0.3in"
height="0.20833333333333334in"} is the average of the absolute values of
the MDCT coefficients in the *i*-th high-frequency band,
![](media/image1325.wmf){width="0.17430555555555555in"
height="0.20833333333333334in"} is the standard deviation of the
absolute values of the MDCT coefficients in the *i*-th high-frequency
band, and ![](media/image1326.wmf){width="0.15in" height="0.175in"} is a
factor for controlling the selected number of the MDCT coefficients.
![](media/image1326.wmf){width="0.15in" height="0.175in"}is chosen so
that a calculated threshold becomes higher than a threshold which is
expected to be appropriate for selecting the limited number of the MDCT
coefficients.

If the number of selected MDCT coefficients is less than a
pre-determined number, the threshold is updated by the following
equation, and an additional selection process is performed.

![](media/image1327.wmf){width="1.9736111111111112in"
height="0.38958333333333334in"} (1105)

Here, ![](media/image1328.wmf){width="0.11388888888888889in"
height="0.1375in"} is the weakest attenuation factor and
![](media/image1329.wmf){width="0.11388888888888889in"
height="0.18263888888888888in"}is the strongest attenuation factor, and
![](media/image1330.wmf){width="0.975in"
height="0.18263888888888888in"}.
![](media/image1331.wmf){width="0.30277777777777776in"
height="0.20972222222222223in"} is the pre-determined number of the MDCT
coefficients to be selected in the end, and
![](media/image1332.wmf){width="0.38958333333333334in"
height="0.20972222222222223in"} is remaining number of MDCT coefficients
to be selected. ![](media/image1333.wmf){width="0.27847222222222223in"
height="0.2423611111111111in"} is the updated threshold. By using this
equation, the threshold is calculated according to the number of
non-selected MDCT coefficients, i.e. the larger the number of
non-selected MDCT coefficients is, the lower the threshold become. The
above equation is equivalent to the following equation.
![](media/image1334.wmf){width="0.34791666666666665in"
height="0.20972222222222223in"} is the number of already selected MDCT
coefficients.

![](media/image1335.wmf){width="1.8444444444444446in"
height="0.38958333333333334in"} (1106)

This threshold update is performed twice using a different set of
![](media/image1328.wmf){width="0.11597222222222223in"
height="0.14166666666666666in"} and
![](media/image1329.wmf){width="0.11597222222222223in"
height="0.18263888888888888in"} unless the number of selected MDCT
coefficients does not reach the pre-determined number.

The selected MDCT coefficients (target MDCT coefficients for the band
search) are stored in a memory as their frequency positions and used for
the band search process.

##### 5.3.4.1.4.1.5.3.3.2 Matching process {#matching-process .H6}

Once the representative MDCT coefficients are selected from the j-th
band input MDCT coefficients $X^{j}()$, a matching process is performed
by calculating the correlation between the representative MDCT
coefficients and normalized low-frequency MDCT coefficients derived from
the envelope normalized MDCT coefficients $\overset{\sim}{X}()$
calculated in subclause 5.3.4.1.4.1.5.3.2. Since the correlation is
calculated only using the selected MDCT coefficients, required
computational complexity can be saved.

The task of the matching process is to find *k\'* which maximizes
*S*(*k\'*).

![](media/image1336.wmf){width="2.2527777777777778in"
height="0.43472222222222223in"} (1107)

where ![](media/image1337.wmf){width="0.5215277777777778in"
height="0.20972222222222223in"},
![](media/image1338.wmf){width="0.48541666666666666in"
height="0.20069444444444445in"}and
![](media/image1339.wmf){width="0.4076388888888889in"
height="0.2513888888888889in"} denote the following.

![](media/image1340.wmf){width="0.5215277777777778in"
height="0.20972222222222223in"} : correlation between representative
MDCT coefficients and normalized low-frequency MDCT coefficients for the
*k*'-th lag candidate,

![](media/image1341.wmf){width="0.48541666666666666in"
height="0.20069444444444445in"} : energy of normalized low-frequency
MDCT coefficients for the *k'*-th lag candidate\
![](media/image1342.wmf){width="0.4076388888888889in"
height="0.2513888888888889in"} : number of lag candidates for the *j*-th
band.

![](media/image1343.wmf){width="0.5125in"
height="0.20972222222222223in"} and
![](media/image1344.wmf){width="0.48541666666666666in"
height="0.20972222222222223in"} are calculated by the following
equations.

$\text{corr}(k') = \sum_{k = 0}^{k = \text{Ncnt}^{j} - 1}{X^{j}(\text{Idx}^{j}\lbrack k\rbrack)\overset{\sim}{X}M(k^{j} + \text{lag}^{j}\lbrack k'\rbrack + \text{Idx}^{j}\lbrack k\rbrack)}$
(1108)

$\text{Ene}(k') = \sum_{k = 0}^{k = \text{Ncnt}^{j} - 1}{\overset{\sim}{X}M(k^{j} + \text{lag}^{j}\lbrack k'\rbrack + \text{Idx}^{j}\lbrack k\rbrack)^{2}}$
(1109)

![](media/image1345.wmf){width="0.39861111111111114in"
height="0.23333333333333334in"},
![](media/image1346.wmf){width="0.48541666666666666in"
height="0.2513888888888889in"},
![](media/image1347.wmf){width="0.5125in" height="0.2513888888888889in"}
and ![](media/image1348.wmf){width="0.19166666666666668in"
height="0.23333333333333334in"} denote the followings.

![](media/image1349.wmf){width="0.4076388888888889in" height="0.225in"}:
selected number of representative MDCT coefficients in the *j*-th band,\
![](media/image1350.wmf){width="0.48541666666666666in"
height="0.2513888888888889in"}: frequency position of the *k*-th
representative MDCT coefficient in the *j*-th band,\
![](media/image1351.wmf){width="0.5125in"
height="0.2513888888888889in"}: the *k*'-th lag candidate for the *j*-th
band,\
![](media/image1352.wmf){width="0.20069444444444445in"
height="0.225in"}: starting frequency position of normalized
low-frequency MDCT coefficients for the *j*-th band.

The lag candidates are defined as the frequency positions of non-zero
normalized low-frequency spectrum. Therefore
![](media/image1353.wmf){width="0.5125in" height="0.2513888888888889in"}
means the *k*'-th non-zero normalized low-frequency MDCT coefficients
frequency position in the *j*-th band search range. The *j*-th sub-band
search range is started
at![](media/image1354.wmf){width="0.20069444444444445in"
height="0.225in"}, which is defined as offsets from the zero frequency
point of the low-frequency spectrum.
![](media/image1355.wmf){width="0.20069444444444445in"
height="0.225in"}= {0, 0, 64, 64}

By using this lag candidate representation, even when the bit budget for
the lag information is small, actual lag search range can be wide, and
it enables to guarantee to generate candidate spectra which have at
least one non-zero spectrum.

Figure 76 shows a conceptual block diagram of the matching process. For
the lag search, only the TCQ quantized component is used as the
low-frequency MDCT coefficients while both of the TCQ-quantized and
noise-filled low-frequency MDCT coefficients are used for generating
high-frequency spectrum and calculating the scaling factors.

The best *k\'*, which maximizes *S*(*k\'*), is packed into the bit
stream as an encoded parameter of the best lag candidate.

![](media/image1356.png){width="4.368055555555555in"
height="3.640972222222222in"}

Figure 76: Conceptual block diagram of the matching process

##### 5.3.4.1.4.1.5.3.3.3 Scaling and noise smoothing {#scaling-and-noise-smoothing .H6}

Once the best match has been found through the matching process, scaling
factors are calculated for the searched bands using the quantized band
energies. Each scaling factor is calculated as the square root of the
quotient of each quantized band energy divided by its corresponding band
enegy of a generated high-frequency spectrum. The band energy of the
generated high-frequency spectrum is equal to
![](media/image1357.wmf){width="0.4305555555555556in"
height="0.18055555555555555in"} for the selected
![](media/image1358.wmf){width="0.1527777777777778in"
height="0.16666666666666666in"} and is calculated according to equation
(1109). The calculated scaling factors are attenuated by the scaling
factor of 0.9.

Inter-frame smoothing process is applied on the generated high-frequency
noise components. The generated MDCT coefficients whose amplitudes are
below a threshold calculated using the sparseness of the TCQ-quantized
low-frequency components are targeted for the smoothing process. When
the energy of the targeted components in the previous frame is
sufficiently less than current band energy, relatively strong smoothing
is applied, while relatively weak smoothing is applied in other cases
(i.e. current band energy is not sufficiently larger than the noise
energy in the previous frame). The smoothing is performed on the energy
of the targeted (noise) components.Then the smoothened energy of the
noise components is divided by the energy of the noise components for
calculating the final scaling factor in the smoothing process. The final
scaling factor is applied to the noise components to obtain smoothened
MDCT coefficients for the noise components.

Local decoding at the encoder side is necessary for switching to
non-MDCT-based modes. For the local decoding, the noise-filling process
is performed between the "De-norm. & Fine gain SQ" and the "PFSC" blocks
in Figure 66.

##### 5.3.4.1.4.2 Transient mode {#transient-mode .H6}

##### 5.3.4.1.4.2.1 Energy envelope coding {#energy-envelope-coding-2 .H6}

The energy envelope coding is performed as described in subclause
5.3.4.1.3.

##### 5.3.4.1.4.2.2 Bit allocation {#bit-allocation-1 .H6}

The bit allocation to bands based on quantized band energies is
performed as described in subclause 5.3.4.1.4.1.4.4. However, for
transient frames the Limited band mode described in subclause
5.3.4.1.4.1.4.4.2 is not used. For SWB, no bits are allocated at the
6^th^ and 7^th^ bands.

##### 5.3.4.1.4.2.3 Fine structure encoding {#fine-structure-encoding-1 .H6}

##### 5.3.4.1.4.2.3.1 Trellis Coding Quantization (TCQ) {#trellis-coding-quantization-tcq-1 .H6}

The spectral coefficient quantization is done as is described in
subclause 5.3.4.1.4.1.5.1.

##### 5.3.4.1.4.2.4 Noise-filling for 0-bit assigned bands {#noise-filling-for-0-bit-assigned-bands .H6}

The noise filling is done as is described in subclause 5.3.4.1.4.1.5.2.

##### 5.3.4.1.4.3 Harmonic Mode {#harmonic-mode .H6}

##### 5.3.4.1.4.3.1 Energy envelope coding {#energy-envelope-coding-3 .H6}

Overall framework of the Harmonic mode is the same as the Normal mode as
shown in Figure 66, but the PFSC block is called as PFSC-based gap
filling in the Harmonic mode.

The energy envelope coding is performed as described in subclause
5.3.4.1.3.

##### 5.3.4.1.4.3.2 Bit allocation {#bit-allocation-2 .H6}

##### 5.3.4.1.4.3.2.1 Allocating bits for fine gain adjustment {#allocating-bits-for-fine-gain-adjustment-1 .H6}

Bit-allocation process is performed in the following manner when the
signal is classified as harmonic. Firstly, two bits are reserved for
transmitting the noise factor information (cf. Sec. 5.3.4.1.4.3.3.3.6)
followed by four bits are allocated for performing gap filling using
PFSC based approach. Then some bits are reserved for applying fine gain
quantization to the band energies that are larger than the others.

The bit budget used for the spectrum quantization is obtained using

![](media/image1359.wmf){width="1.3465277777777778in"
height="0.20972222222222223in"} (1110)

where *e~bits~* is the bits consumed for quantizing the band energies
which is obtained from subclause 5.3.4.1.3,
![](media/image1360.wmf){width="0.15555555555555556in"
height="0.16458333333333333in"} is the available bit budget for spectrum
quantization. ![](media/image1173.wmf){width="0.2965277777777778in"
height="0.20972222222222223in"} is the number of bits reserved for fine
gain quantization and described in table 119. For SWB and FB at the bit
rates 13.2 and 16.4 kbps,
![](media/image1361.wmf){width="0.5395833333333333in"
height="0.20972222222222223in"}.

##### 5.3.4.1.4.3.2.2 Adaptive bit allocation to bands {#adaptive-bit-allocation-to-bands .H6}

Based on the available bit
budget![](media/image1360.wmf){width="0.15555555555555556in"
height="0.16458333333333333in"}, bits are allocated to the bands using
the adaptive bit allocation. The adaptive bit-allocation scheme uses the
quantized band
energies![](media/image1362.wmf){width="1.6944444444444444in"
height="0.23333333333333334in"}to allocate the available bits in a frame
among the bands. In this scheme, bits are allocated by adaptively
grouping the band energies into a number of groups; each group is
allocated variable number of bits based on characteristics between the
groups followed by bits allocation to bands within groups based on the
available bit budget to the groups. Figure 77 illustrates the overview
of the adaptive bit allocation. The detailed procedure is described in
the following subclause.

![](media/image1363.png){width="5.372916666666667in"
height="1.0729166666666667in"}

Figure 77: Overview of the Adaptive bit allocation scheme

##### 5.3.4.1.4.3.2.2.1 Bits allocation to groups. {#bits-allocation-to-groups. .H6}

The adaptive bit-allocation scheme uses the quantized band energies,
![](media/image1364.wmf){width="1.6944444444444444in"
height="0.23333333333333334in"} to allocate the available bits
![](media/image1365.wmf){width="0.14652777777777778in"
height="0.16458333333333333in"} in a frame among the bands.

First, the bit-allocation vector entries, i.e., bit allocation of each
bands in bits per sample, are set to one, and followed by temporary
storage of band energies in a buffer. This is done according to:

> ![](media/image1366.wmf){width="2.339583333333333in"
> height="0.48541666666666666in"} (1111)

In order to allocate bits to bands using band energies, firstly bands
are adaptively grouped and each group contains variable number of bands,
the grouping is to separate the dominant frequency band from
non-dominant frequency band. In total, four groups are formed, while the
widths of the first three groups are adaptively varied and the last
group has a fixed width which has last four bands. The maximum variable
width ![](media/image1367.wmf){width="0.8694444444444445in"
height="0.23333333333333334in"} of each adaptive group is thresholded
and it is given in table 120

Table 120: Maximum widths of the groups

  ---------------------------------------------------------------------------------------- ---------- ----------
                                                                                           13.2kbps   16.4kbps
  ![](media/image1368.wmf){width="0.375in" height="0.23333333333333334in"}                 7          7
  ![](media/image1369.wmf){width="0.34791666666666665in" height="0.23333333333333334in"}   9          10
  ![](media/image1370.wmf){width="0.375in" height="0.23333333333333334in"}                 2          3
  ---------------------------------------------------------------------------------------- ---------- ----------

The grouping of bands is done by identifying the dominant frequency
vectors (the frequency bands with large and local maximum energy factor
values in the spectrum). Using the dominant frequency band as center,
include the descending slope at both sides to one group; the group width
is adaptively determined corresponding to the input signal
characteristic. If the dominant frequency band is at the edge, only one
side of the descending slope would be included in the group. In order to
reduce the complexity sensitive ness of human ear is considered when
searching

Once width of each group
![](media/image1371.wmf){width="1.0944444444444446in"
height="0.20972222222222223in"} is decided, bits are allocated to each
group and it is done in the following steps.

a)  Calculate the energy of each group according to

![](media/image1372.wmf){width="2.234722222222222in"
height="0.5548611111111111in"} (1112)

where ![](media/image1373.wmf){width="1.86875in"
height="0.20972222222222223in"} is the start and end of each group and
width of each group is defined according to

![](media/image1374.wmf){width="2.615972222222222in"
height="0.20972222222222223in"}. (1113)

b)  Allocate bits to the last group which has a fixed width based on the
    following steps.

    i.  Calculate average number of bits that can be allocated for a
        group

![](media/image1375.wmf){width="0.6263888888888889in"
height="0.34791666666666665in"} (1114)

ii. Calculate mean for the group energies according to

![](media/image1376.wmf){width="1.2354166666666666in"
height="0.5486111111111112in"} (1115)

iii. Calculate energy difference for last group according to

![](media/image1377.wmf){width="1.3229166666666667in" height="0.375in"}
(1116)

iv. Calculate group energy ratio between the last group and average
    group energy of the remaining groups according to

![](media/image1378.wmf){width="1.3916666666666666in"
height="1.007638888888889in"} (1117)

v.  Calculate the energy difference between maximum energy of a
    subvector in the last group and with average sub vector energy of
    the rest of the groups.

![](media/image1379.wmf){width="1.3229166666666667in"
height="0.2513888888888889in"} (1118)

where ![](media/image1380.wmf){width="0.30277777777777776in"
height="0.20972222222222223in"} is the maximum energy in the last group
according to equation (1119) and
![](media/image1381.wmf){width="0.3659722222222222in"
height="0.23333333333333334in"} is the average energy of the rest of the
groups band and it is calculated according to .

![](media/image1382.wmf){width="2.2256944444444446in"
height="0.31180555555555556in"} (1119)

![](media/image1383.wmf){width="2.015972222222222in"
height="0.6777777777777778in"} (1120)

vi. Allocate bits to the last group according to

![](media/image1384.wmf){width="3.6in" height="0.6506944444444445in"}
(1121)

where *bw~1~* is the bit allocation weight, which takes value based on

![](media/image1385.wmf){width="1.8868055555555556in"
height="0.48541666666666666in"}

c)  Once bits are allocated to last group, remaining bits are calculated
    according to

![](media/image1386.wmf){width="0.9388888888888889in"
height="0.20972222222222223in"} (1122)

d)  Based on the remaining bits obtained from c), bits are allocated to
    the rest of the groups using following steps.

    i.  Calculate the band energy difference between bands.

![](media/image1387.wmf){width="3.3833333333333333in"
height="0.2513888888888889in"} (1123)

ii. Identify the maximum band energy difference according to

![](media/image1388.wmf){width="1.8868055555555556in"
height="0.32083333333333336in"} (1124)

iii. Identify the group which has maximum band energy difference
     ![](media/image1389.wmf){width="0.44375in"
     height="0.23333333333333334in"} and allocate more bits to the group
     .

> If![](media/image1390.wmf){width="0.4618055555555556in"
> height="0.23333333333333334in"}belongs to group *g*=1, bits allocation
> to the groups will be according to

![](media/image1391.wmf){width="1.676388888888889in" height="1.1125in"}
(1125)

If ![](media/image1392.wmf){width="0.44375in"
height="0.23333333333333334in"}belongs to group *g*=0 or group *g*=2,
bits allocation to the groups will be according to

> ![](media/image1393.wmf){width="1.676388888888889in"
> height="1.1125in"} (1126)

where *Scale~1~* and *Scale~2~* values are based on table 121

Table 121: Scale factors for groups

  --------------------------------------------------------------------------------------- ------------ ----------- -----------
                                                                                                       13.2 kbps   16.4 kbps
  ![](media/image1394.wmf){width="1.3229166666666667in" height="0.23333333333333334in"}   *Scale~1~*   1.05        1.1
                                                                                          *Scale~2~*   0.97        0.92
  ![](media/image1395.wmf){width="1.0944444444444446in" height="0.23333333333333334in"}   *Scale~1~*   0.92        0.97
                                                                                          *Scale~2~*   1.0         1
  --------------------------------------------------------------------------------------- ------------ ----------- -----------

Bits are allocated to individual bands in a group based on the available
bit budget for the groups ![](media/image1396.wmf){width="1.04375in"
height="0.20972222222222223in"}and it is done according to subclause
5.3.4.1.4.3.2.2.2. If 0 bits are available to any of the groups
![](media/image1397.wmf){width="1.0618055555555554in"
height="0.20972222222222223in"}the corresponding bands in the group are
allocated 0 bits.

##### 5.3.4.1.4.3.2.2.2 Bits allocation to bands in a group {#bits-allocation-to-bands-in-a-group .H6}

The bits allocation to individual bands in a group is applied using the
steps given below

a)  Calculate sum of band energies in a group

> ![](media/image1398.wmf){width="2.183333333333333in"
> height="0.5548611111111111in"} (1127)

b)  Calculate Mean energy for the group

> ![](media/image1399.wmf){width="1.0944444444444446in"
> height="0.4166666666666667in"} (1128)

c)  Set *scale~3~* value according to

![](media/image1400.wmf){width="2.1569444444444446in" height="0.5125in"}
(1129)

where ![](media/image1401.wmf){width="0.39861111111111114in"
height="0.20972222222222223in"} is a bitallocation weight constant which
is used for controlling the amount of bits being allocated to the bands.

![](media/image1402.wmf){width="0.5305555555555556in"
height="0.2423611111111111in"} is the number of bands whose difference
between the Mean energy for the group and band energy of the sub band
exceeds 5 dB.

d)  For each iteration in a group,

    i.  Calculate Mean energy for the group

![](media/image1403.wmf){width="1.1125in" height="0.4166666666666667in"}
(1130)

ii. Allocate bits to the individual subvectros in a group according to .

![](media/image1404.wmf){width="5.4in" height="0.4527777777777778in"}
(1131)

iii. Once the bits are allocated to indvidual bands in a group *g*,
     > identify the band which has least energy in the group and verify
     > whether bits allocated to the identfied band has under allocation
     > using a threshold, if the band has under allocation. update the
     > sum of energies using

![](media/image1405.wmf){width="1.9736111111111112in"
height="1.6256944444444446in"}

where *G~min~* is the index corresponding to minimum energy *R~min\ ~*of
a band in the group *g*

iv. Repeat Step g, until there is no under allocation.

The process described in subclause 5.3.4.1.4.3.2.2.2, is used for
allocating bits to individual bands for groups *g=0,1,2,3.*

##### 5.3.4.1.4.3.3 Fine structure encoding {#fine-structure-encoding-2 .H6}

##### 5.3.4.1.4.3.3.1 Trellis Coding Quantization (TCQ) {#trellis-coding-quantization-tcq-2 .H6}

The spectral coefficient quantization is done as is described in
subclause 5.3.4.1.4.1.5.1.

##### 5.3.4.1.4.3.3.2 Noise-filling for 0-bit assigned bands: {#noise-filling-for-0-bit-assigned-bands-1 .H6}

This subclause gives a technical overview of the noise filling
processing. Noise filling consists of two algorithms. The first
algorithm described in this subclause 5.3.4.1.4.1.5.2 fills the gaps in
the quantized spectrum where coefficients have been quantized to zero
when the bit allocation clause allocates non zero bits to the bands and
fills the un quantized bands up to the transition
frequency![](media/image1406.wmf){width="0.16458333333333333in"
height="0.20972222222222223in"} where the transition
frequency![](media/image1407.wmf){width="0.16458333333333333in"
height="0.20972222222222223in"}is estimated based on the received bit
allocation. The second algorithm is described as follows

##### 5.3.4.1.4.3.3.3 PFSC-based gap filling {#pfsc-based-gap-filling .H6}

##### 5.3.4.1.4.3.3.3.1 Overview {#overview-1 .H6}

This subclause is only applied to SWB and FB input signals. The spectral
coefficients which belong to bands which are assigned zero bits from the
bit‑allocation clause are not quantized. This means that not all
transform coefficients are transmitted to the decoder. From the noise
filled quantized spectrum, the gaps in the high frequency region
![](media/image1408.wmf){width="1.6166666666666667in"
height="0.20972222222222223in"} which has zero bit allocation are
identified and a predicted spectrum information is generated and the
missing frequency bands (gaps) are filled with the predicted spectrum
information.

In order to perform gap filling, the most similar match with the
selected similarity criteria is searched from the coded and envelope
normalized content and encodes the lag index
![](media/image1409.wmf){width="0.6263888888888889in"
height="0.2513888888888889in"}parameter followed by encoding of the
noise factor. The lag index
![](media/image1409.wmf){width="0.6263888888888889in"
height="0.2513888888888889in"}and noise factor parameters are used in
the decoder for generating the predicted spectrum, which will be used
for filling the gaps. Figure 78 illustrates the overview of PFSC based
gap filling for Harmonic mode.

![](media/image1410.wmf){width="5.776388888888889in" height="3.9875in"}

Figure 78: Overview of the Harmonic mode PFSC based gap filling

##### 5.3.4.1.4.3.3.3.2 Envelope Normalization {#envelope-normalization-1 .H6}

Low frequency content is extracted from the quantized noise filled
spectrum, which is stored temporarily in a buffer and supplies the
buffer information to noise separator, which separates noise
![](media/image1411.wmf){width="0.47638888888888886in"
height="0.20972222222222223in"}and quantized
content![](media/image1412.wmf){width="0.47638888888888886in"
height="0.23333333333333334in"}. The envelope of the quantized and noise
contents is normalized before further processing. The normalization is
performed in logarithmic domain and it is according to

Peak to average information is calculated in log domain for the
quantized content![](media/image1412.wmf){width="0.47638888888888886in"
height="0.23333333333333334in"}.

![](media/image1413.wmf){width="1.2354166666666666in"
height="0.48541666666666666in"} (1132)

where ![](media/image1414.wmf){width="0.34791666666666665in"
height="0.23333333333333334in"} is the maximum absolute amplitude of the
quantized spectrum and
![](media/image1415.wmf){width="0.3388888888888889in"
height="0.26944444444444443in"} is the mean of the absolute amplitude of
the quantized spectrum.

The quantized content
![](media/image1412.wmf){width="0.47638888888888886in"
height="0.23333333333333334in"} is divided into
![](media/image1416.wmf){width="0.26944444444444443in"
height="0.20972222222222223in"} sub-vectors and the total number of the
sub-vectors is based on the table 122. Each sub-vector
![](media/image1417.wmf){width="0.4076388888888889in"
height="0.20972222222222223in"} consists of eight spectral coefficients:
This sub-vector division is only available for envelope normalization.

![](media/image1418.wmf){width="1.9555555555555555in"
height="0.23333333333333334in"} (1133)

The arithmetic means of the 1^st^ and 2^nd^ half of each sub-band
![](media/image1419.wmf){width="0.4076388888888889in"
height="0.2513888888888889in"} and
![](media/image1420.wmf){width="0.4166666666666667in"
height="0.2513888888888889in"} are calculated as follows:

![](media/image1421.wmf){width="2.3125in" height="0.6868055555555556in"}
(1134)

![](media/image1422.wmf){width="2.339583333333333in"
height="0.6868055555555556in"} (1135)

Next, the geometric mean of
![](media/image1423.wmf){width="0.4076388888888889in"
height="0.2513888888888889in"} and
![](media/image1424.wmf){width="0.4166666666666667in"
height="0.2513888888888889in"} in logarithmic domain of each sub-band,
![](media/image1425.wmf){width="0.27847222222222223in"
height="0.18263888888888888in"} is obtained as:

![](media/image1426.wmf){width="3.3833333333333333in"
height="0.31180555555555556in"} (1136)

Here, the square root calculation in linear domain is performed by
multiplying 0.5.

The ![](media/image1427.wmf){width="0.27847222222222223in"
height="0.18263888888888888in"}, *l* = 0, ..., *N~sv~*, is smoothed
using moving average method with a span of seven samples. The envelope
smoothed values ![](media/image1428.wmf){width="0.2875in"
height="0.2423611111111111in"} are obtained as:

![](media/image1429.wmf){width="2.9034722222222222in"
height="2.033333333333333in"} (1137)

The smoothed envelope
![](media/image1430.wmf){width="0.31180555555555556in"
height="0.2423611111111111in"} is transformed from logarithmic domain to
linear domain as follows:

![](media/image1431.wmf){width="2.372916666666667in"
height="0.27847222222222223in"} (1138)

The quantized contents are normalized by multiplying the smoothed
envelope ![](media/image1432.wmf){width="0.34791666666666665in"
height="0.2423611111111111in"} in order to obtain the normalized
contents:

![](media/image1433.wmf){width="3.296527777777778in"
height="0.23333333333333334in"} (1139)

Table 122: Number of sub-vectors for energy normalization

  ----------------- ---------
  Bitrate in kbps   *N~sv~*
  13.2              32
  16.4              38
  ----------------- ---------

From the normalized content, thresholds are calculated according to

![](media/image1434.wmf){width="1.304861111111111in" height="0.5125in"}
(1140)

where ![](media/image1435.wmf){width="0.47638888888888886in"
height="0.23333333333333334in"} value is according to.

![](media/image1436.wmf){width="1.9916666666666667in"
height="0.44375in"} (1141)

![](media/image1437.wmf){width="0.34791666666666665in"
height="0.26944444444444443in"}is calculated according to

![](media/image1438.wmf){width="1.5833333333333333in"
height="0.5305555555555556in"} (1142)

Absolute values of the normalized
coefficients![](media/image1439.wmf){width="0.3472222222222222in"
height="0.2861111111111111in"} are compared to the
thresholds![](media/image1440.wmf){width="0.44305555555555554in"
height="0.20833333333333334in"}and
![](media/image1441.wmf){width="0.42986111111111114in"
height="0.20833333333333334in"}, which are adaptively calculated by
equation (1140). The normalized coefficients with absolute amplitudes
above ![](media/image1440.wmf){width="0.44305555555555554in"
height="0.20833333333333334in"} are clipped to
![](media/image1442.wmf){width="0.44305555555555554in"
height="0.20833333333333334in"}to avoid excessive spectral peaks, and
the normalized coefficients with absolute amplitudes below
![](media/image1441.wmf){width="0.42986111111111114in"
height="0.20833333333333334in"} are suppressed to 0 to enhance the
harmonic structure, according to

![](media/image1443.wmf){width="1.382638888888889in"
height="2.7569444444444446in"}

Above process i.e., normalization and clipping of the normalized
contents is also applied for normalizing the low frequency noise
contents and the obtained normalized noise contents is represented as
![](media/image1444.wmf){width="0.47638888888888886in"
height="0.23333333333333334in"} the normalized noise contents are
further adjusted according to

![](media/image1445.wmf){width="2.4868055555555557in"
height="0.23333333333333334in"} (1143)

where ![](media/image1446.wmf){width="0.38333333333333336in"
height="0.20972222222222223in"} is the sparseness ratio and it is
calculated according to

![](media/image1447.wmf){width="1.1819444444444445in"
height="0.4166666666666667in"} (1144)

![](media/image1448.wmf){width="0.5034722222222222in"
height="0.20972222222222223in"}is the number of non-zero spectrum in the
TCQ-quantized low-frequency content.

The normalized low frequency quantized noise filled spectrum is obtained
according to

![](media/image1449.wmf){width="1.5986111111111112in"
height="0.23333333333333334in"} (1145)

##### 5.3.4.1.4.3.3.3.3 Band Search {#band-search-1 .H6}

The high-frequency region of
![](media/image1450.wmf){width="0.47638888888888886in"
height="0.20972222222222223in"}with width *hf~w~* is divided into four
bands as follows

![](media/image1451.wmf){width="2.990972222222222in"
height="0.26944444444444443in"} (1146)

where ![](media/image1450.wmf){width="0.47638888888888886in"
height="0.20972222222222223in"} is the input MDCT spectrum,
![](media/image1452.wmf){width="0.38333333333333336in"
height="0.20972222222222223in"} is the starting position of high
frequency, high frequency width is represented as
![](media/image1453.wmf){width="0.44375in"
height="0.20972222222222223in"} and its corresponding values are
according to table 123. The values of band widths
![](media/image1454.wmf){width="0.44375in"
height="0.2513888888888889in"} corresponding to index *i* and offsets
![](media/image1455.wmf){width="0.18263888888888888in"
height="0.21597222222222223in"} are according to tables 124 and 125.

Table 123: High frequency width and starting position

  ----------------- ---------------------------------------------------------------------------------------- ----------------------------------------------------------------------------
  Bitrate in kbps   ![](media/image1456.wmf){width="0.38333333333333336in" height="0.20972222222222223in"}   ![](media/image1453.wmf){width="0.44375in" height="0.20972222222222223in"}
  13.2              256                                                                                      312
  16.4              300                                                                                      340
  ----------------- ---------------------------------------------------------------------------------------- ----------------------------------------------------------------------------

Table 124: High frequency band width and offsets for 13.2 kbps

  ----------- --------------------------------------------------------------------------- ----------------------------------------------------------------------------------------
  Index *i*   ![](media/image1457.wmf){width="0.44375in" height="0.2513888888888889in"}   ![](media/image1455.wmf){width="0.18263888888888888in" height="0.21597222222222223in"}
  0           56                                                                          0
  1           100                                                                         56
  2           100                                                                         156
  3           56                                                                          256
  ----------- --------------------------------------------------------------------------- ----------------------------------------------------------------------------------------

Table 125: High frequency band width and offsets for 16.4 kbps

  ----------- --------------------------------------------------------------------------- ----------------------------------------------------------------------------------------
  Index *i*   ![](media/image1457.wmf){width="0.44375in" height="0.2513888888888889in"}   ![](media/image1455.wmf){width="0.18263888888888888in" height="0.21597222222222223in"}
  0           60                                                                          0
  1           110                                                                         60
  2           110                                                                         170
  3           60                                                                          280
  ----------- --------------------------------------------------------------------------- ----------------------------------------------------------------------------------------

For sub-band![](media/image1458.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"} , *i*=0,1there is a search band
![](media/image1459.wmf){width="1.9555555555555555in"
height="0.2513888888888889in"} which defines from where the best match
is searched.

The start position
![](media/image1460.wmf){width="0.16458333333333333in"
height="0.21597222222222223in"} and the width
![](media/image1461.wmf){width="0.18263888888888888in"
height="0.21597222222222223in"} of each sub-band are set as follows:

![](media/image1462.wmf){width="1.4722222222222223in"
height="0.8166666666666667in"} (1147)

![](media/image1463.wmf){width="2.0236111111111112in"
height="1.2902777777777779in"} (1148)

where ![](media/image1464.wmf){width="0.7048611111111112in"
height="0.2513888888888889in"}is the number of search positions and it
is calculated according to

![](media/image1465.wmf){width="0.11388888888888889in"
height="0.20972222222222223in"}![](media/image1466.wmf){width="0.8333333333333334in"
height="0.30277777777777776in"} (1149)

where the number of bits
![](media/image1467.wmf){width="0.7826388888888889in" height="0.2875in"}
is reserved for the band search for index *i.*

The best match is searched for every band *i* ,in order to reduce
computational load for calculating correlation, only limited number of
input spectral coefficients are selected and used for the calculation of
correlation. The selection of the MDCT coefficients is described in
subclause 5.3.4.1.4.1.5.3.3.1.

Once the input spectral coefficients are selected, searching process is
performed by calculating the correlation between the input spectral
coefficients and normalized low-frequency coefficients derived from the
envelope normalized coefficients calculated in subclause
5.3.4.1.4.3.3.3.2. Since the correlation is calculated only using the
selected coefficients, required computational complexity can be reduced.

The best match is searched for every band *i* as follows. The
correlation for index *k'* is computed as

![](media/image1468.wmf){width="3.4166666666666665in"
height="0.5729166666666666in"} (1150)

where ![](media/image1469.wmf){width="0.5034722222222222in"
height="0.20972222222222223in"},![](media/image1470.wmf){width="0.30277777777777776in"
height="0.2513888888888889in"},
![](media/image1471.wmf){width="0.4527777777777778in"
height="0.2513888888888889in"} and
![](media/image1472.wmf){width="0.44375in"
height="0.21597222222222223in"} denote the following

![](media/image1469.wmf){width="0.5034722222222222in"
height="0.20972222222222223in"} is the correlation between input
spectral coefficients
![](media/image1473.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"} and search band
![](media/image1474.wmf){width="0.4673611111111111in"
height="0.2513888888888889in"} for the *k'-th* lag candidate,

![](media/image1470.wmf){width="0.30277777777777776in"
height="0.2513888888888889in"} selected number of representative
spectral coefficients in the *i*-th
band.![](media/image1471.wmf){width="0.4527777777777778in"
height="0.2513888888888889in"}: frequency position of the *k*-th
representative spectral coefficient in the *i*-th sub-band,\
![](media/image1472.wmf){width="0.44375in"
height="0.21597222222222223in"}: is the start and end position of search
lag and its values are calculated according to

![](media/image1475.wmf){width="3.3895833333333334in"
height="1.0763888888888888in"} (1151)

where ![](media/image1476.wmf){width="0.6777777777777778in"
height="0.27847222222222223in"}is the previous frame best match position
for band *i*\
similarly, the energy for index *k'* is obtained as

![](media/image1477.wmf){width="2.798611111111111in"
height="0.5729166666666666in"} (1152)

where ![](media/image1341.wmf){width="0.48541666666666666in"
height="0.19166666666666668in"} is the energy of the search band
![](media/image1478.wmf){width="0.4673611111111111in"
height="0.2513888888888889in"}for the k'-th lag candidate

The actual similarity measure used is of the form

![](media/image1479.wmf){width="1.1034722222222222in" height="0.5125in"}
(1153)

The task is to find *k'* which maximizes *S'*(*k'*). The complexity of
the implementation can be reduced by squaring *S'*(*k*'), which removes
the absolute value signs as well as square root from the denominator as
equation (1107). The best match is now searched efficiently for band *i*
using

![](media/image1480.wmf){width="2.8673611111111112in"
height="2.6006944444444446in"}

where ![](media/image1481.wmf){width="0.5125in"
height="0.21597222222222223in"} is the best match position for band *i*
and if there is no spectral coefficients in the search band then
![](media/image1482.wmf){width="0.5125in"
height="0.21597222222222223in"} value takes according to

![](media/image1483.wmf){width="3.44375in"
height="0.5486111111111112in"} (1154)

The best match index ![](media/image1481.wmf){width="0.5125in"
height="0.21597222222222223in"} is packed into the bit stream as the
parameter![](media/image1409.wmf){width="0.6263888888888889in"
height="0.2513888888888889in"}. Once the best match index
![](media/image1484.wmf){width="0.5125in"
height="0.21597222222222223in"}is obtained, past frame best match index
![](media/image1485.wmf){width="0.6777777777777778in"
height="0.27847222222222223in"} is updated with current frame best match
index according to

![](media/image1486.wmf){width="1.3229166666666667in"
height="0.27847222222222223in"} (1155)

##### 5.3.4.1.4.3.3.3.4 Structure analysis for Harmonics {#structure-analysis-for-harmonics .H6}

This subclause gives a technical overview of the structure analysis for
harmonics which is applied for SWB and FB Harmonic signals. The purpose
of this subclause is to estimate the harmonics from the quantized
spectrum and the estimated harmonic is used for generating the new tonal
spectrum for the HF region at the decoder, where the HF region is
calculated using the frequency
transition![](media/image1406.wmf){width="0.16458333333333333in"
height="0.20972222222222223in"} which is estimated based on the received
bit allocation.

The first step of the structure analysis is to extract a portion from
the quantized spectrum. A portion from 2 kHz to 6.4 kHz for 13.2 kbps
and from 2- 7.5 kHz for 16.4 kbps is used for structure analysis.

From the extracted portion, structure for harmonics is analysed. The
detail procedure of this subclause comprises the following steps:

1)  Grouping of spectral coefficients into a number of blocks of equal
    length; in total 16 and 19 blocks (*N~block~*) are formed for 13.2
    and 16.4. Kbps with a length of 16 coefficients per block.

2)  Extract the spectral peak magnitude
    ![](media/image1487.wmf){width="0.5395833333333333in"
    height="0.20972222222222223in"} and their corresponding positions
    ![](media/image1488.wmf){width="0.6506944444444445in"
    height="0.20972222222222223in"} within each block; as shown

![](media/image1489.wmf){width="3.251388888888889in"
height="0.7138888888888889in"} (1156)

3)  From the extracted spectral peaks identify the spectral peaks whose
    spacing lie closely and discard the spectral peak from analysis
    which is not perceptually important.

4)  Split the extracted portion into regions with cut-off at 140, 200,
    16*N~block~*-1 spectral coefficients and count the peaks in each
    region according to

![](media/image1490.wmf){width="3.3833333333333333in"
height="0.7138888888888889in"} (1157)

> Before the process
> counter![](media/image1491.wmf){width="1.5569444444444445in"
> height="0.23333333333333334in"}is set to zero.

5)  Calculate the spacing between the identified peak positions and
    identify the minimum and maximum spacing between spectral peaks.

![](media/image1492.wmf){width="3.8604166666666666in"
height="0.8604166666666667in"} (1158)

> 6\) Calculate sum of spacing according to

![](media/image1465.wmf){width="0.11458333333333333in"
height="0.20833333333333334in"}![](media/image1465.wmf){width="0.11388888888888889in"
height="0.20972222222222223in"}
![](media/image1465.wmf){width="0.11388888888888889in"
height="0.20972222222222223in"}![](media/image1493.wmf){width="3.125in"
height="3.125in"}

> where ![](media/image1494.wmf){width="2.8645833333333335in"
> height="0.22916666666666666in"}are the sum of spacing and the
> counter![](media/image1495.wmf){width="3.0104166666666665in"
> height="0.22916666666666666in"} increments when the respective
> conditions are satisfied.
>
> 7\) Estimate the harmonic frequency based on the spacing between the
> identified peak positions according to the following.

![](media/image1496.wmf){width="5.051388888888889in"
height="2.9305555555555554in"}

where ![](media/image1497.wmf){width="1.2506944444444446in"
height="0.23333333333333334in"}are the estimated harmonic frequencies,
which can be used for generating the missing bands.

In order to improve the stability of present frame, previous frame
estimated frequency
![](media/image1498.wmf){width="0.6083333333333333in"
height="0.23333333333333334in"} information is used.

if ![](media/image1499.wmf){width="4.052777777777778in"
height="0.23333333333333334in"} and the calculated estimated frequencies
![](media/image1500.wmf){width="1.2173611111111111in"
height="0.23333333333333334in"} has a zero value it indicates that there
is no harmonics extracted from *0* to *N~block~ -1.*usually this happens
when decoded spectrum is sparse. For this case,
![](media/image1501.wmf){width="0.6506944444444445in"
height="0.23333333333333334in"}is set to previous frame estimated
frequencies if it not equal to zero or it is set to a default value of
80. In the encoder, estimated harmonic
![](media/image1501.wmf){width="0.6506944444444445in"
height="0.23333333333333334in"} is used for generating the noise
spectrum for the HF region. As the estimated harmonic
![](media/image1501.wmf){width="0.6506944444444445in"
height="0.23333333333333334in"} is determined using the quantized
spectrum, there is no need to transmit the
![](media/image1501.wmf){width="0.6506944444444445in"
height="0.23333333333333334in"} parameter to the decoder. Under rate
switching conditions this structure analysis for harmonics is also used
for bitrates above 16.4 kbps for extracting the harmonics.

##### 5.3.4.1.4.3.3.3.5 Noise filling for the predicted spectrum {#noise-filling-for-the-predicted-spectrum .H6}

First high-frequency region
![](media/image1502.wmf){width="0.4673611111111111in"
height="0.23333333333333334in"} with width *hf~w~* is divided into four
bands ![](media/image1503.wmf){width="1.1305555555555555in"
height="0.2513888888888889in"}with same band configuration described in
subclause 5.3.4.1.4.3.3.3.3

From the envelope normalized noise
spectrum![](media/image1504.wmf){width="0.4673611111111111in"
height="0.23333333333333334in"}, a desired portion of noise spectrum is
extracted. The start position
![](media/image1460.wmf){width="0.16458333333333333in"
height="0.21597222222222223in"} and the end
![](media/image1505.wmf){width="0.27847222222222223in"
height="0.2423611111111111in"} of each desired portion in the normalized
noise spectrum ![](media/image1506.wmf){width="1.382638888888889in"
height="0.2513888888888889in"} are set as follows:

![](media/image1507.wmf){width="2.1430555555555557in"
height="0.7888888888888889in"} (1159)

![](media/image1508.wmf){width="1.5354166666666667in" height="1.0125in"}
(1160)

here *lags^i^* is the number of search positions and it is according to
equation (1149), lag index value
![](media/image1509.wmf){width="0.5451388888888888in"
height="0.20416666666666666in"}is obtained from subclause
5.3.4.1.4.3.3.3.3.

Estimate the position of harmonics for band *i* =0, 1 in the predicted
spectrum, according to

![](media/image1510.wmf){width="2.5833333333333335in" height="2.5in"}
(1161)

where ![](media/image1511.wmf){width="0.6527777777777778in"
height="0.23333333333333334in"} represents the first tonal position of
the HF spectrum estimated based on the end tonal frequency position in
the low frequency spectrum.
![](media/image1512.wmf){width="0.3298611111111111in"
height="0.20972222222222223in"} represents pulse resolution for
predicted spectrum and
![](media/image1501.wmf){width="0.6298611111111111in"
height="0.20972222222222223in"} is obtained from subclause
5.3.4.1.4.3.3.3.4.

Fill the bands![](media/image1513.wmf){width="0.4673611111111111in"
height="0.2513888888888889in"},*i*=0,1 using extracted noise from the
normalized spectrum
![](media/image1514.wmf){width="1.5659722222222223in"
height="0.2513888888888889in"} except in the positions obtained in
equation (1161) and fill the remaining
bands![](media/image1515.wmf){width="0.4673611111111111in"
height="0.2513888888888889in"},*i*=2,3 by copying the information
obtained from the lower bands *i*=0,1 reversely.

##### 5.3.4.1.4.3.3.3.6 Noise factor {#noise-factor .H6}

On the decoder side a predicted spectrum
![](media/image1516.wmf){width="0.4673611111111111in"
height="0.23333333333333334in"} is generated for the high frequency
region by using the envelope normalized noise-filled quantized
spectrum![](media/image1517.wmf){width="0.9388888888888889in"
height="0.23333333333333334in"}, which is obtained from subclause
5.3.4.1.4.3.3.3.5. The predicted spectrum is generated for the high
frequency region, first by extracting the desired noise components from
the ${\overset{\sim}{N}}_{M}(k)$ described in subclause
5.3.4.1.4.3.3.3.5 followed by tonal generation using the envelope
normalized quantized spectrum ${\overset{\sim}{X}}_{M}(k)$. To control
the amount of noise inserted in the predicted spectrum at the decoder, a
noise factor is computed on the encoder side and quantized using a 2-bit
scalar quantizer. The procedure for noise factor calculation is
described in this subclause.

From the input spectral coefficients
![](media/image1450.wmf){width="0.47638888888888886in"
height="0.20972222222222223in"}, extract the high-frequency region
![](media/image1518.wmf){width="0.4673611111111111in"
height="0.20972222222222223in"} according to

$H_{M}(k) = X_{M}(k + \text{hf}_{\text{start}})\ldots k = 0,\text{.}\text{.}\text{.}\text{.}\text{.}\text{.}\text{.},\text{hf}_{\text{width}} - 1$
(1162)

where the starting position of high frequency is represented
as![](media/image1452.wmf){width="0.38333333333333336in"
height="0.20972222222222223in"} and high frequency width is represented
as![](media/image1519.wmf){width="0.44375in"
height="0.20972222222222223in"}. The corresponding values of
![](media/image1520.wmf){width="0.8159722222222222in"
height="0.20972222222222223in"} is same as in table 123.

Tonal components in the
![](media/image1518.wmf){width="0.4673611111111111in"
height="0.20972222222222223in"} are selected using the values
![](media/image1521.wmf){width="1.4604166666666667in"
height="0.20972222222222223in"} obtained in subclause 5.3.4.1.4.3.3.3.3.
Calculate energy of the selected coefficients according to

![](media/image1522.wmf){width="1.6166666666666667in"
height="0.5638888888888889in"} (1162a)

Calculate noise factor using
![](media/image1502.wmf){width="0.4673611111111111in"
height="0.23333333333333334in"} and
![](media/image1518.wmf){width="0.4673611111111111in"
height="0.20972222222222223in"} according to

![](media/image1523.wmf){width="1.7215277777777778in"
height="0.43472222222222223in"} (1163)

where ![](media/image1524.wmf){width="0.7555555555555555in"
height="0.23333333333333334in"} is the energies obtained
using![](media/image1518.wmf){width="0.4673611111111111in"
height="0.20972222222222223in"},
![](media/image1502.wmf){width="0.4673611111111111in"
height="0.23333333333333334in"} according to

![](media/image1525.wmf){width="1.425in" height="1.04375in"} (1164)

The calculated noise factor *N~fac~* is encoded using a two bit scalar
quantizer.

#### 5.3.4.2 High-rate HQ coder

Table 126: High rate HQ supported modes

  ------------------ ----------- -----------------------------------
  Bitrate \[kbps\]   Bandwidth   Supported modes
  32                 WB          Normal, Transient
  24.4, 32           SWB         Transient, Harmonic, HVQ, Generic
  24.4, 32           FB          Transient, Generic
  64                 SWB, FB     Normal, Transient
  ------------------ ----------- -----------------------------------

The high level structure of the high-rate HQ coder is in figure **79**.
The different operating modes of the high-rate HQ coder are outlined in
table 126, the high-rate HQ is used at WB, SWB, and FB, at bit-rates
24.4, 32, and 64 kb/s. The coding is done in the MDCT domain. There are
5 different modes: Transient mode handles transient signals by using
shorter transforms, Harmonic mode handles harmonic signals and HVQ takes
care of strongly harmonic signals. Normal and Generic mode are used for
all other signals.

![](media/image1526.wmf){width="6.692361111111111in"
height="2.870138888888889in"}

Figure 79: High level structure of the high-rate HQ encoder

The whole frequency spectrum is divided into bands, there are 3
different band structures used: Default, harmonic, and wideband, see
tables 127, 128, and 129. Harmonic band structure is used for HVQ and
Harmonic mode, wideband band structure is used for WB. Otherwise the
default band structure is used.

Table 127: Normal band structure used in high rate HQ

  --------------------------------------------------------------------------------------- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- -----
  ![](media/image1527.wmf){width="0.1375in" height="0.19166666666666668in"}               0     1     2     3     4     5     6     7     8     9     10    11    12
  ![](media/image1048.wmf){width="0.5125in" height="0.20972222222222223in"}               0     8     16    24    32    40    48    56    64    72    80    88    96
  ![](media/image1049.wmf){width="0.4673611111111111in" height="0.20972222222222223in"}   7     15    23    31    39    47    55    63    71    79    87    95    103
  ![](media/image1527.wmf){width="0.1375in" height="0.19166666666666668in"}               13    14    15    16    17    18    19    20    21    22    23    24    25
  ![](media/image1528.wmf){width="0.5125in" height="0.20972222222222223in"}               104   112   120   128   144   160   176   192   208   224   240   256   280
  ![](media/image1529.wmf){width="0.4673611111111111in" height="0.20972222222222223in"}   111   119   127   143   159   175   191   207   223   239   255   279   303
  ![](media/image1527.wmf){width="0.1375in" height="0.19166666666666668in"}               26    27    28    29    30    31    32    33    34    35    36    37    38
  ![](media/image1528.wmf){width="0.5125in" height="0.20972222222222223in"}               304   328   352   376   400   424   448   472   496   520   554   576   608
  ![](media/image1529.wmf){width="0.4673611111111111in" height="0.20972222222222223in"}   327   351   375   399   423   447   471   495   519   553   575   607   639
  ![](media/image1527.wmf){width="0.1375in" height="0.19166666666666668in"}               39    40    41    42    43                                              
  ![](media/image1528.wmf){width="0.5125in" height="0.20972222222222223in"}               640   672   704   736   768                                             
  ![](media/image1529.wmf){width="0.4673611111111111in" height="0.20972222222222223in"}   671   703   735   767   799                                             
  --------------------------------------------------------------------------------------- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- -----

Table 128: Wideband band structure used in high rate HQ

  --------------------------------------------------------------------------------------- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- -----
  ![](media/image1527.wmf){width="0.1375in" height="0.19166666666666668in"}               0     1     2     3     4     5     6     7     8     9     10    11    12
  ![](media/image1048.wmf){width="0.5125in" height="0.20972222222222223in"}               0     8     16    24    32    40    48    56    64    72    80    88    96
  ![](media/image1049.wmf){width="0.4673611111111111in" height="0.20972222222222223in"}   7     15    23    31    39    47    55    63    71    79    87    95    103
  ![](media/image1527.wmf){width="0.1375in" height="0.19166666666666668in"}               13    14    15    16    17    18    19    20    21    22    23    24    25
  ![](media/image1528.wmf){width="0.5125in" height="0.20972222222222223in"}               104   112   120   128   144   160   176   192   208   224   240   256   288
  ![](media/image1529.wmf){width="0.4673611111111111in" height="0.20972222222222223in"}   111   119   127   143   159   175   191   207   223   239   255   287   319
  --------------------------------------------------------------------------------------- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- -----

Table 129: Harmonic band structure used in high rate HQ

  --------------------------------------------------------------------------------------- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- -----
  ![](media/image1527.wmf){width="0.1375in" height="0.19166666666666668in"}               0     1     2     3     4     5     6     7     8     9     10    11    12
  ![](media/image1048.wmf){width="0.5125in" height="0.20972222222222223in"}               0     8     16    24    32    40    48    56    64    72    80    88    96
  ![](media/image1049.wmf){width="0.4673611111111111in" height="0.20972222222222223in"}   7     15    23    31    39    47    55    63    71    79    87    95    103
  ![](media/image1527.wmf){width="0.1375in" height="0.19166666666666668in"}               13    14    15    16    17    18    19    20    21    22    23    24    25
  ![](media/image1528.wmf){width="0.5125in" height="0.20972222222222223in"}               104   112   120   128   144   160   176   192   208   224   256   288   320
  ![](media/image1529.wmf){width="0.4673611111111111in" height="0.20972222222222223in"}   111   119   127   143   159   175   191   207   223   255   287   319   367
  ![](media/image1527.wmf){width="0.1375in" height="0.19166666666666668in"}               26    27    28    29    30    31    32    33    34    35    36    37    38
  ![](media/image1528.wmf){width="0.5125in" height="0.20972222222222223in"}               368   416   464   512   576                                             
  ![](media/image1529.wmf){width="0.4673611111111111in" height="0.20972222222222223in"}   415   463   511   575   639                                             
  --------------------------------------------------------------------------------------- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- -----

The number of bands used in WB is 26, and for FB it is 44. For SWB 39
bands are used, except if Harmonic or HVQ is used. For Harmonic mode 31
bands are used. The HVQ will use bands 21-30 for 24.4 kb/s, or 24-30 for
32 kb/s.

Based on the different modes, the low frequency band signal is encoded
with the different bandwidths. In addition, the envelopes of the higher
frequency band are encoded differently according to the different modes.

Then, the mode information, the indices of the low frequency band signal
and the envelopes of the higher frequency band signal are written to the
bitstream.

##### 5.3.4.2.1 Normal Mode

##### 5.3.4.2.1.1 Envelope calculation and quantization {#envelope-calculation-and-quantization .H6}

The *norm* or spectrum energy ![](media/image1530.wmf){width="0.44375in"
height="0.20972222222222223in"}of a band
![](media/image1531.wmf){width="0.12291666666666666in"
height="0.18263888888888888in"}is defined as the root-mean-square
(*rms*) value of the band and computed as follows:

![](media/image1532.wmf){width="3.191666666666667in"
height="0.6083333333333333in"} (1165)

where ![](media/image1533.wmf){width="1.7215277777777778in"
height="0.23333333333333334in"}is the length of the band
![](media/image1534.wmf){width="0.12291666666666666in"
height="0.18263888888888888in"}.

Table 130: Envelope quantization table

  ------- ---------------------------------------------------------------------------------------- ------- ---------------------------------------------------------------------------------------- ------- --------------------------------------------------------------------------------------- ------- ---------------------------------------------------------------------------------------
  Index   Code                                                                                     Index   Code                                                                                     Index   Code                                                                                    Index   Code
  0       ![](media/image1535.wmf){width="0.32083333333333336in" height="0.20972222222222223in"}   10      ![](media/image1536.wmf){width="0.32083333333333336in" height="0.20972222222222223in"}   20      ![](media/image1537.wmf){width="0.2604166666666667in" height="0.20972222222222223in"}   30      ![](media/image1538.wmf){width="0.2604166666666667in" height="0.20972222222222223in"}
  1       ![](media/image1539.wmf){width="0.30277777777777776in" height="0.20972222222222223in"}   11      ![](media/image1540.wmf){width="0.30277777777777776in" height="0.20972222222222223in"}   21      ![](media/image1541.wmf){width="0.2604166666666667in" height="0.20972222222222223in"}   31      ![](media/image1542.wmf){width="0.2513888888888889in" height="0.20972222222222223in"}
  2       ![](media/image1543.wmf){width="0.32083333333333336in" height="0.20972222222222223in"}   12      ![](media/image1544.wmf){width="0.30277777777777776in" height="0.20972222222222223in"}   22      ![](media/image1545.wmf){width="0.2604166666666667in" height="0.20972222222222223in"}   32      ![](media/image1546.wmf){width="0.2604166666666667in" height="0.20972222222222223in"}
  3       ![](media/image1547.wmf){width="0.30277777777777776in" height="0.20972222222222223in"}   13      ![](media/image1548.wmf){width="0.30277777777777776in" height="0.20972222222222223in"}   23      ![](media/image1549.wmf){width="0.2604166666666667in" height="0.20972222222222223in"}   33      ![](media/image1550.wmf){width="0.2604166666666667in" height="0.20972222222222223in"}
  4       ![](media/image1551.wmf){width="0.225in" height="0.20972222222222223in"}                 14      ![](media/image1552.wmf){width="0.32083333333333336in" height="0.20972222222222223in"}   24      ![](media/image1553.wmf){width="0.2604166666666667in" height="0.20972222222222223in"}   34      ![](media/image1554.wmf){width="0.2604166666666667in" height="0.20972222222222223in"}
  5       ![](media/image1555.wmf){width="0.30277777777777776in" height="0.20972222222222223in"}   15      ![](media/image1556.wmf){width="0.2604166666666667in" height="0.20972222222222223in"}    25      ![](media/image1557.wmf){width="0.2604166666666667in" height="0.20972222222222223in"}   35      ![](media/image1558.wmf){width="0.3298611111111111in" height="0.20972222222222223in"}
  6       ![](media/image1559.wmf){width="0.32083333333333336in" height="0.20972222222222223in"}   16      ![](media/image1560.wmf){width="0.2604166666666667in" height="0.20972222222222223in"}    26      ![](media/image1561.wmf){width="0.2604166666666667in" height="0.20972222222222223in"}   36      ![](media/image1562.wmf){width="0.3298611111111111in" height="0.20972222222222223in"}
  7       ![](media/image1563.wmf){width="0.30277777777777776in" height="0.20972222222222223in"}   17      ![](media/image1564.wmf){width="0.2604166666666667in" height="0.20972222222222223in"}    27      ![](media/image1565.wmf){width="0.2604166666666667in" height="0.20972222222222223in"}   37      ![](media/image1566.wmf){width="0.3298611111111111in" height="0.20972222222222223in"}
  8       ![](media/image1567.wmf){width="0.32083333333333336in" height="0.20972222222222223in"}   18      ![](media/image1568.wmf){width="0.2604166666666667in" height="0.20972222222222223in"}    28      ![](media/image1569.wmf){width="0.2604166666666667in" height="0.20972222222222223in"}   38      ![](media/image1570.wmf){width="0.3298611111111111in" height="0.20972222222222223in"}
  9       ![](media/image1571.wmf){width="0.30277777777777776in" height="0.20972222222222223in"}   19      ![](media/image1572.wmf){width="0.2604166666666667in" height="0.20972222222222223in"}    29      ![](media/image1573.wmf){width="0.2604166666666667in" height="0.20972222222222223in"}   39      ![](media/image1574.wmf){width="0.3298611111111111in" height="0.20972222222222223in"}
  ------- ---------------------------------------------------------------------------------------- ------- ---------------------------------------------------------------------------------------- ------- --------------------------------------------------------------------------------------- ------- ---------------------------------------------------------------------------------------

In each frame, the norms are scalar quantized with a uniform logarithmic
scalar quantizer with 40 steps of 3 dB.

The index of the quantized
norm,![](media/image1575.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"}, can easily be obtained as:

![](media/image1576.wmf){width="2.8944444444444444in"
height="0.20972222222222223in"} (1166)

and is saturated such that it is limited to the range of \[0,31\] for 0
and \[0, 39\] for the others.

The quantization index of the lowest-frequency band, i.e.,
![](media/image1577.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"}, is directly transmitted to the decoder.
The quantization indices of the norms in the remaining
![](media/image1578.wmf){width="0.6263888888888889in"
height="0.20972222222222223in"}bands are differentially coded by
computing

![](media/image1579.wmf){width="2.921527777777778in"
height="0.20972222222222223in"} (1167)

The differential indices
![](media/image1580.wmf){width="0.48541666666666666in"
height="0.20972222222222223in"} are constrained into the range of
\[--15, 16\]. This is performed by first adjusting negative differential
indices and then adjusting positive differential indices as follows:

1\) Compute the differential indices defined in equation (1167) in order
from the highest-frequency band to the lowest-frequency.

2\) ![](media/image1581.wmf){width="3.44375in"
height="0.20972222222222223in"}

3\) Recompute the differential indices
![](media/image1582.wmf){width="0.48541666666666666in"
height="0.20972222222222223in"}in order from the lowest-frequency band
to the highest-frequency.

4\) ![](media/image1583.wmf){width="4.7034722222222225in"
height="0.20972222222222223in"}

5\) The adjusted differential indices in the range \[0, 31\] are
obtained by adding an offset of 15
to![](media/image1584.wmf){width="0.48541666666666666in"
height="0.20972222222222223in"}.

##### 5.3.4.2.1.2 Envelope coding {#envelope-coding .H6}

The first index of the quantized norm
![](media/image1585.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"} is transmitted by packing the bits
directly using 5 bits. The adjusted quantization differential indices
are coded by one of four high-rate HQ norm coding modes shown in table
131. The mode requiring the least bits is selected and used for
high-rate HQ norm coding. This HQ norm coding mode information is
signalled with 2 bits. The final resulting reconstructed quantized norms
are denoted by![](media/image1586.wmf){width="0.42569444444444443in"
height="0.23333333333333334in"},
![](media/image1587.wmf){width="1.1125in"
height="0.20972222222222223in"}.

Table 131: High-rate HQ norm coding modes

  ------------ ------------------------------
  Mode index   Description
  0            Context based Huffman coding
  1            Resized Huffman coding
  2            Normal Huffman coding
  3            Bit-packing
  ------------ ------------------------------

##### 5.3.4.2.1.2.1 Context based Huffman coding mode {#context-based-huffman-coding-mode-1 .H6}

If this coding mode is selected for the current frame, the context based
Huffman coding is applied to the quantization differential indices
described in subclause 5.3.4.1.3.3.1. In this case equation (1038) shall
be replaced with

![](media/image1588.wmf){width="4.052777777777778in"
height="0.49444444444444446in"} (1168)

When the bit-packing mode is selected the adjusted differential rates
are packed directly with 5 bits.

##### 5.3.4.2.1.2.2 Re-sized Huffman coding mode {#re-sized-huffman-coding-mode .H6}

If this coding mode is selected for the current frame, the Re-sized
Huffman coding is applied to the adjusted differential indices as same
as the low-rate HQ coder. Details are described in subclause
5.3.4.1.3.3.2. The Huffman codes for the differential indices are given
in table 115. When the bit-packing mode is selected the adjusted
differential rates are packed directly with 5 bits.

##### 5.3.4.2.1.2.3 Normal Huffman coding and bit-packing mode {#normal-huffman-coding-and-bit-packing-mode .H6}

If this coding mode is selected for the current frame, the Normal
Huffman coding is then applied to the adjusted differential indices. The
Huffman codes for the differential indices are given in table 132.

Table 132: Huffman coefficient table

  ------- --------- ------- -------- ------- -------- ------- ---------
  Index   Code      Index   Code     Index   Code     Index   Code
  0       0011010   8       001100   16      000      24      0011110
  1       0111010   9       011100   17      010      25      0111110
  2       1011010   10      101100   18      1010     26      1011110
  3       1111010   11      111100   19      1110     27      1111110
  4       0011011   12      0010     20      001110   28      0011111
  5       0111011   13      0110     21      011110   29      0111111
  6       1011011   14      100      22      101110   30      1011111
  7       1111011   15      110      23      111110   31      1111111
  ------- --------- ------- -------- ------- -------- ------- ---------

When the bit-packing mode is selected the adjusted differential rates
are packed directly with 5 bits.

##### 5.3.4.2.1.3 Bit allocation {#bit-allocation-3 .H6}

##### 5.3.4.2.1.3.1 Envelope adjustment before bit allocation {#envelope-adjustment-before-bit-allocation .H6}

In order to account for psycho-acoustical weighting and masking effects,
the quantized norms are adjusted prior to bit allocation. The algorithm
consists of mapping the quantized norms by using spectral weighting
functions. This algorithm is only used at FB.

First, the quantized norms are mapped to the spectral domain. This is
equivalent to copying the quantized norms in case of stationary signals
and averaging the time-dependent quantized norms of the four spectra in
case of transients. This is performed according to:

![](media/image1589.wmf){width="3.467361111111111in"
height="0.7555555555555555in"} (1169)

The obtained spectrum is afterwards mapped to a function which is
similar to the ear\'s output of auditory filters; this gives a
representation of the psycho-acoustical importance of the input signal.
This operation is performed according to the following linear operation:

![](media/image1590.wmf){width="4.103472222222222in"
height="0.49444444444444446in"} (1170)

where the constants![](media/image1591.wmf){width="0.5729166666666666in"
height="0.23333333333333334in"},
![](media/image1592.wmf){width="0.5215277777777778in"
height="0.23333333333333334in"}and the summation
interval![](media/image1593.wmf){width="0.5395833333333333in"
height="0.23333333333333334in"} are given in table 133.
![](media/image1594.wmf){width="0.6597222222222222in"
height="0.23333333333333334in"}when the bit-rate is 24.4 kb/s,
![](media/image1595.wmf){width="0.6506944444444445in"
height="0.23333333333333334in"} at 32 kb/s, and
![](media/image1596.wmf){width="0.6777777777777778in"
height="0.23333333333333334in"}at 64 kb/s.

Table 133: Spectrum mapping variables

  --------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- ---------------------------------------------------------------------------------------
  ![](media/image1597.wmf){width="0.1375in" height="0.16458333333333333in"}   ![](media/image1598.wmf){width="0.5486111111111112in" height="0.23333333333333334in"}   ![](media/image1599.wmf){width="0.5729166666666666in" height="0.23333333333333334in"}   ![](media/image1600.wmf){width="0.5215277777777778in" height="0.23333333333333334in"}   ![](media/image1601.wmf){width="0.5486111111111112in" height="0.23333333333333334in"}
  0                                                                           0                                                                                       1                                                                                       3                                                                                       8
  1                                                                           1                                                                                       1                                                                                       3                                                                                       6
  2                                                                           2                                                                                       1                                                                                       3                                                                                       3
  3                                                                           3                                                                                       1                                                                                       3                                                                                       3
  4                                                                           4                                                                                       1                                                                                       3                                                                                       3
  5                                                                           5                                                                                       1                                                                                       3                                                                                       3
  6                                                                           6                                                                                       1                                                                                       3                                                                                       3
  7                                                                           7                                                                                       1                                                                                       3                                                                                       3
  8                                                                           8                                                                                       1                                                                                       3                                                                                       3
  9                                                                           9                                                                                       1                                                                                       3                                                                                       3
  10                                                                          10, 11                                                                                  2                                                                                       4                                                                                       3
  11                                                                          12, 13                                                                                  2                                                                                       4                                                                                       3
  12                                                                          14, 15                                                                                  2                                                                                       4                                                                                       3
  13                                                                          16, 17                                                                                  2                                                                                       5                                                                                       3
  14                                                                          18, 19                                                                                  2                                                                                       5                                                                                       3
  15                                                                          20, 21, 22, 23                                                                          4                                                                                       6                                                                                       3
  16                                                                          24, 25, 26                                                                              3                                                                                       6                                                                                       4
  17                                                                          27, 28, 29                                                                              3                                                                                       6                                                                                       5
  18                                                                          30, 31, 32, 33, 34                                                                      5                                                                                       7                                                                                       7
  19                                                                          35, 36, 37, 38, 39, 40, 41, 42, 43                                                      9                                                                                       8                                                                                       11
  --------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- ---------------------------------------------------------------------------------------

The mapped spectrum is forward-smoothed according to the following:

![](media/image1602.wmf){width="3.338888888888889in"
height="0.23333333333333334in"} (1171)

and the resulting in-place function is backward-smoothed according to:

![](media/image1603.wmf){width="3.5819444444444444in"
height="0.23333333333333334in"} (1172)

After the smoothing operation, the resulting function is thresholded in
order to take into account an average level of absolute threshold of
hearing. Thresholding and renormalization are performed according to:

![](media/image1604.wmf){width="3.563888888888889in"
height="0.2423611111111111in"} (1173)

where ![](media/image1605.wmf){width="0.5486111111111112in"
height="0.23333333333333334in"}is given by table 133 and represents a
pseudo-threshold of hearing.

The resulting function is further adaptively mapped, companded or
expanded depending on the dynamic range of the spectrum, to the range of
\[--0,...,3\] according to the following linear mapping:

![](media/image1606.wmf){width="3.8875in" height="0.4618055555555556in"}
(1174)

The resulting spectrum is mapped back to bands according to:

![](media/image1607.wmf){width="3.5729166666666665in"
height="0.2423611111111111in"} (1175)

If the variable *IsTransient* is set to *TRUE*, i.e., transient mode,
the resulting spectrum is further smoothed according to:

![](media/image1608.wmf){width="3.4166666666666665in"
height="0.7826388888888889in"} (1176)

Finally, the norms used for bit allocation are computed as:

![](media/image1609.wmf){width="1.4159722222222222in"
height="0.2604166666666667in"} (1177)

##### 5.3.4.2.1.3.2 Envelope based bit allocation {#envelope-based-bit-allocation .H6}

##### 5.3.4.2.1.3.2.1 Wideband bit allocation of non-transient mode at 24.4/32kbps {#wideband-bit-allocation-of-non-transient-mode-at-24.432kbps .H6}

A group based bit allocation scheme has been introduced for wideband
signal coding at 24.4kbps and 32kbps to avoid zero bit allocations to
some of the sub-bands when they may be perceptually important.

##### 5.3.4.2.1.3.2.1.1 Group based bit allocation {#group-based-bit-allocation .H6}

The sub-bands are divided into three groups. Firstly, the initial number
of allocated bits to each group is determined according to the sum or
the average of the norms in each group. Based on the initial number of
allocated bits to each group, the second stage group based bit
allocation is performed according to the characteristics and the energy
information of the signal.

To achieve the group based bit allocation, firstly the average of the
quantized norms in the index
range![](media/image1610.wmf){width="0.6263888888888889in"
height="0.19166666666666668in"} is calculated,

![](media/image1611.wmf){width="1.1125in" height="0.5125in"} (1178)

For the first 4 sub-bands, if the norm
![](media/image1612.wmf){width="0.38958333333333334in"
height="0.2604166666666667in"}for bit allocation is less
than![](media/image1613.wmf){width="0.225in"
height="0.20972222222222223in"}, then the
norm![](media/image1612.wmf){width="0.38958333333333334in"
height="0.2604166666666667in"} is set to
![](media/image1613.wmf){width="0.225in"
height="0.20972222222222223in"}.

As a first step in the bit allocation, 1 bit is allocated to code each
sub-band, and then the sub-bands are divided into 3 groups, i.e.
\[0,..., 15\], \[16,..., 23\], \[24,..., 25\].

Then calculate the following parameters which indicate the
characteristics and the energy information of the signal for group based
bit allocation.

The factors ![](media/image1614.wmf){width="2.120833333333333in"
height="0.23333333333333334in"}are initialized. These factors are then
employed to adjust the norms, and then the average of the norms in each
group is calculated along with the sum of the averages.

![](media/image1615.wmf){width="2.6875in" height="0.5729166666666666in"}
(1179)

![](media/image1616.wmf){width="1.8173611111111112in"
height="0.5486111111111112in"} (1180)

Table 134: Spectrum mapping group structure

  --------------------------------------------------------------------------- --------------------------------------------------------------------------------------- ---------------------------------------------------------------- ---------------------------------------------------------------------------------------
  ![](media/image1617.wmf){width="0.12291666666666666in" height="0.1375in"}   ![](media/image1618.wmf){width="0.4618055555555556in" height="0.20972222222222223in"}   ![](media/image1619.wmf){width="0.44375in" height="0.19375in"}   ![](media/image1620.wmf){width="0.4618055555555556in" height="0.20972222222222223in"}
  0                                                                           0                                                                                       15                                                               16
  1                                                                           16                                                                                      23                                                               8
  2                                                                           24                                                                                      25                                                               2
  --------------------------------------------------------------------------- --------------------------------------------------------------------------------------- ---------------------------------------------------------------- ---------------------------------------------------------------------------------------

The differences of the consecutive averages and calculated:

![](media/image1621.wmf){width="2.6875in"
height="0.27847222222222223in"} (1181)

If ![](media/image1622.wmf){width="0.6777777777777778in"
height="0.27847222222222223in"} is greater than or equal to 6, or
![](media/image1623.wmf){width="0.6506944444444445in"
height="0.27847222222222223in"} is greater than or equal to 3.75, then
the number of bits allocated to each group is described as follows,

![](media/image1624.wmf){width="2.198611111111111in"
height="0.8784722222222222in"} (1182)

where ![](media/image1625.wmf){width="0.2604166666666667in"
height="0.20972222222222223in"}is the total available bit budget.
Otherwise, the bit allocation for each group is detailed as follows:

Initialize the number of bits allocated to each group using the
following equation,

![](media/image1626.wmf){width="2.834722222222222in"
height="0.27847222222222223in"} (1183)

If the average envelope of the third
group![](media/image1627.wmf){width="0.39861111111111114in"
height="0.2513888888888889in"}is more than 12, then adjust the number of
bits of each group further:

![](media/image1628.wmf){width="2.267361111111111in"
height="2.5555555555555554in"} (1184)

where ![](media/image1629.wmf){width="0.2965277777777778in"
height="0.20972222222222223in"}is the number of the saved bits and
initialized to zero. If![](media/image1630.wmf){width="0.5125in"
height="0.20972222222222223in"}, the saved bits are re-allocated to each
group according to:

![](media/image1631.wmf){width="4.781944444444444in"
height="0.9027777777777778in"} (1185)

and reset the
factors![](media/image1632.wmf){width="2.651388888888889in"
height="0.23333333333333334in"}.

If the number of bits allocated to the third group
![](media/image1633.wmf){width="0.39861111111111114in"
height="0.20972222222222223in"}is less than 3, then the number of
allocated bits in the third group are moved to the second group
![](media/image1634.wmf){width="1.3736111111111111in"
height="0.20972222222222223in"}, and the number of bits allocated to the
third group is set to zero,
![](media/image1635.wmf){width="0.6263888888888889in"
height="0.20972222222222223in"}.

##### 5.3.4.2.1.3.2.1.2 Bit allocation in each group {#bit-allocation-in-each-group .H6}

For the 3 sub-band groups, the smallest
thresholds![](media/image1636.wmf){width="0.5395833333333333in"
height="0.2513888888888889in"} for the number of allocated bits are 5, 6
and 7, respectively, and the largest number of the
sub-bands![](media/image1637.wmf){width="0.4618055555555556in"
height="0.2513888888888889in"}which are bit-allocated is calculated
according to:

![](media/image1638.wmf){width="1.9736111111111112in"
height="0.44375in"} (1186)

The norms in each group are re-ordered and the re-ordered norms are
![](media/image1639.wmf){width="1.9048611111111111in"
height="0.27847222222222223in"}, where
![](media/image1640.wmf){width="0.4618055555555556in"
height="0.2513888888888889in"} is the number of the sub-bands in each
group.

The step length ![](media/image1641.wmf){width="0.7916666666666666in"
height="0.2513888888888889in"} is initialized, and the re-ordered norms
are adjusted according to the step length,
![](media/image1642.wmf){width="0.8784722222222222in"
height="0.23333333333333334in"} and
![](media/image1643.wmf){width="0.8423611111111111in"
height="0.23333333333333334in"}:

![](media/image1644.wmf){width="4.973611111111111in"
height="0.5729166666666666in"} (1187)

The bits allocated to each sub-band are set according to the adjusted
norms in each group as follows:

If![](media/image1645.wmf){width="1.9736111111111112in"
height="0.2513888888888889in"}, initialize the allocated bit of each
sub-band to 1. If the adjusted norm is less than 0, reset it to 0. Then
the following 4 steps are performed :

1.  Initialize the
    counter![](media/image1646.wmf){width="0.9298611111111111in"
    height="0.2513888888888889in"}.

2.  Calculate the sum of the first
    ![](media/image1647.wmf){width="0.20972222222222223in"
    height="0.2513888888888889in"}norms in the group,
    ![](media/image1648.wmf){width="0.30277777777777776in"
    height="0.2513888888888889in"}, and allocate the bits of each
    sub-band in the index range
    ![](media/image1649.wmf){width="0.6263888888888889in"
    height="0.2513888888888889in"}:

![](media/image1650.wmf){width="3.173611111111111in"
height="0.27847222222222223in"} (1188)

3.  If the number of bits allocated to the last sub-band is fewer than
    thresholds![](media/image1651.wmf){width="0.5395833333333333in"
    height="0.2513888888888889in"},
    ![](media/image1652.wmf){width="1.6256944444444446in"
    height="0.27847222222222223in"}, then the number of allocated bits
    in the ![](media/image1653.wmf){width="0.32083333333333336in"
    height="0.2513888888888889in"} sub-band is set to zero and the
    counter ![](media/image1654.wmf){width="0.20972222222222223in"
    height="0.2513888888888889in"} is decremented by one. Processing now
    returns to step 2.

4.  If the number of bits allocated to the
    ![](media/image1655.wmf){width="0.32083333333333336in"
    height="0.2513888888888889in"} sub-band is not fewer than
    thresholds![](media/image1656.wmf){width="0.5395833333333333in"
    height="0.2513888888888889in"}, then the bit-allocation of the
    sub-bands in each group has been completed.

Otherwise, if ![](media/image1657.wmf){width="1.3319444444444444in"
height="0.2513888888888889in"}, initialize the number of allocated bits
of the first ![](media/image1658.wmf){width="0.4618055555555556in"
height="0.2513888888888889in"} sub-bands to 1, and initialize the bit of
the last ![](media/image1659.wmf){width="0.9833333333333333in"
height="0.2513888888888889in"} sub-bands to 0. If the adjusted norms of
the first ![](media/image1637.wmf){width="0.4618055555555556in"
height="0.2513888888888889in"} sub-bands are less than 0, set them to 0.
Then the following 4 steps are performed:

1.  Initialize the
    counter![](media/image1660.wmf){width="0.7645833333333333in"
    height="0.2513888888888889in"}.

2.  Calculate the sum of the first
    ![](media/image1647.wmf){width="0.20972222222222223in"
    height="0.2513888888888889in"}norms in the group,
    ![](media/image1648.wmf){width="0.30277777777777776in"
    height="0.2513888888888889in"}, and allocate the bits of each
    sub-band in the index range
    ![](media/image1661.wmf){width="0.7465277777777778in"
    height="0.2513888888888889in"}:

![](media/image1662.wmf){width="3.296527777777778in"
height="0.27847222222222223in"} (1189)

3.  If the number of the bits allocated to
    sub-band![](media/image1663.wmf){width="0.12291666666666666in"
    height="0.16458333333333333in"} is fewer than
    thresholds![](media/image1664.wmf){width="0.5395833333333333in"
    height="0.2513888888888889in"},
    ![](media/image1665.wmf){width="2.015972222222222in"
    height="0.39861111111111114in"}, then the number of allocated bits
    in the last ![](media/image1666.wmf){width="0.43472222222222223in"
    height="0.2513888888888889in"} sub-bands is set to zero and the
    counter ![](media/image1654.wmf){width="0.20972222222222223in"
    height="0.2513888888888889in"} is set to to
    ![](media/image1663.wmf){width="0.12291666666666666in"
    height="0.16458333333333333in"}. Processing now returns to step 2.

4.  If the number of bits allocated to all
    ![](media/image1654.wmf){width="0.20972222222222223in"
    height="0.2513888888888889in"} sub-bands is not fewer than
    thresholds![](media/image1667.wmf){width="0.5395833333333333in"
    height="0.2513888888888889in"}, then the bit-allocation of the
    sub-bands in each group has been completed.

##### 5.3.4.2.1.3.2.2 General envelope based bit allocation {#general-envelope-based-bit-allocation .H6}

The adaptive bit-allocation scheme uses the adjusted quantized norms
![](media/image1668.wmf){width="1.5118055555555556in"
height="0.23333333333333334in"}, to allocate the available bits in a
frame among the bands.

The maximum number of bits assigned to each normalized transform
coefficient is by default set
to![](media/image1669.wmf){width="0.5548611111111111in"
height="0.20972222222222223in"}bits/coefficient.

First, the bit-allocation vector entries, i.e., bit allocation of each
band in bits per sample, are set to zero. This is done according to:

![](media/image1670.wmf){width="0.5819444444444445in"
height="0.20972222222222223in"} for
![](media/image1671.wmf){width="1.1125in"
height="0.20972222222222223in"} (1190)

The number of remainder bits, denoted
![](media/image1672.wmf){width="0.32083333333333336in"
height="0.20972222222222223in"}, is set to the total available bit
budget![](media/image1673.wmf){width="0.2604166666666667in"
height="0.20972222222222223in"}. The latter is calculated after
subtraction of the number of signalling bits, the bits used by the
envelope coding and possibly the noise level bits (see subclause
5.3.4.2.1.4) from the total available bits for the frame.

The vector of
bit-allocations,![](media/image1674.wmf){width="1.4333333333333333in"
height="0.20972222222222223in"},
remainder![](media/image1675.wmf){width="0.32083333333333336in"
height="0.20972222222222223in"} and
![](media/image1676.wmf){width="0.2604166666666667in"
height="0.20972222222222223in"}fulfil:

![](media/image1677.wmf){width="1.8506944444444444in"
height="0.5395833333333333in"} (1191)

At each iteration, the
index![](media/image1678.wmf){width="0.30277777777777776in"
height="0.20972222222222223in"} of the band which has the largest norm
among number of bands used is found:

![](media/image1679.wmf){width="1.667361111111111in"
height="0.38333333333333336in"} (1192)

For this band, the algorithm allocates 1 bit for each spectral
coefficient, i.e.,![](media/image1680.wmf){width="0.5125in"
height="0.20972222222222223in"}is incremented by 1. The norm will, on
the other hand, be decremented by 6 dB, i.e., the norm index is
decreased by two. These two operations are performed according to:

![](media/image1681.wmf){width="1.5118055555555556in"
height="0.4618055555555556in"} (1193)

The remainder![](media/image1682.wmf){width="0.15555555555555556in"
height="0.15555555555555556in"} is updated as well to take into account
the updated bit-allocation vector:

![](media/image1683.wmf){width="1.4604166666666667in"
height="0.20972222222222223in"} (1194)

Whenever the
bit-allocation![](media/image1684.wmf){width="0.5819444444444445in"
height="0.20972222222222223in"}reaches the maximum allowable
bit-rate![](media/image1685.wmf){width="0.3298611111111111in"
height="0.20972222222222223in"}*,* its norm is set to minus infinity (in
reality, to ![](media/image1686.wmf){width="0.3388888888888889in"
height="0.20972222222222223in"}) such that this vector is not taken into
account in the next iterations. This procedure is repeated
until![](media/image1675.wmf){width="0.32083333333333336in"
height="0.20972222222222223in"} is less
than![](media/image1687.wmf){width="0.6354166666666666in"
height="0.20972222222222223in"}.

When the iterative procedure stops and, depending on the value of the
remainder bits, the remaining bits are allocated to bands of a lower
dimension than ![](media/image1688.wmf){width="0.6354166666666666in"
height="0.20972222222222223in"}which caused the stop of the
bit‑allocation loop.

The last step is to convert the bit allocation from bits per
coefficients to total bits per band:

![](media/image1689.wmf){width="1.2083333333333333in"
height="0.20972222222222223in"} (1195)

##### 5.3.4.2.1.3a Fine structure quantization {#a-fine-structure-quantization .H6}

The normalized MDCT spectrum
![](media/image1690.wmf){width="0.4673611111111111in"
height="0.23333333333333334in"}is encoded in bands using the bit
allocation ![](media/image1691.wmf){width="0.30277777777777776in"
height="0.20972222222222223in"}.

##### 5.3.4.2.1.3.a1 Fine gain bit allocation {#a1-fine-gain-bit-allocation .H6}

The spectral envelope coefficients
![](media/image1692.wmf){width="0.44375in"
height="0.2423611111111111in"}have been quantized in 3 dB steps. For
higher rates, this resolution becomes too coarse and additional fine
gain adjustments are made. The bits assigned for the band
![](media/image1693.wmf){width="0.30277777777777776in"
height="0.19166666666666668in"}is split into a number of bits for the
PVQ shape quantizer
![](media/image1694.wmf){width="0.5395833333333333in"
height="0.23333333333333334in"}and bits for the fine gain quantizer
![](media/image1695.wmf){width="0.48541666666666666in"
height="0.20972222222222223in"}. The assignment is done using a
pre-trained look-up table based on the assigned band
bits![](media/image1696.wmf){width="0.30277777777777776in"
height="0.19166666666666668in"}and the bandwidth
![](media/image1697.wmf){width="0.43472222222222223in"
height="0.20972222222222223in"}according t

![](media/image1698.wmf){width="1.9736111111111112in"
height="0.23333333333333334in"} (1196)

where ![](media/image1699.wmf){width="1.4159722222222222in"
height="0.23333333333333334in"}is a lookup-table for fine gain bits (see
table 135) and ![](media/image1700.wmf){width="1.7638888888888888in"
height="0.23333333333333334in"} is the number of bits per sample rounded
down. The bits for the PVQ shape quantization are obtained by
subtracting the fine gain bits,
![](media/image1701.wmf){width="1.4875in"
height="0.23333333333333334in"}.

Table 135: Fine gain bits table

  ---------------------------------------------------------------------------------------- ----------------------------------------------------------------------------------------
  ![](media/image1702.wmf){width="0.38958333333333334in" height="0.23333333333333334in"}   ![](media/image1703.wmf){width="0.30277777777777776in" height="0.20972222222222223in"}
  0                                                                                        0
  1                                                                                        0
  2                                                                                        0
  3                                                                                        1
  4                                                                                        2
  5                                                                                        2
  6                                                                                        4
  7                                                                                        5
  ---------------------------------------------------------------------------------------- ----------------------------------------------------------------------------------------

##### 5.3.4.2.1.3a.2 Fine structure quantization using PVQ {#a.2-fine-structure-quantization-using-pvq .H6}

The quantization of the PVQ shape vector is performed as described in
subclause 5.3.4.2.7. A decoded version of the PVQ shape vector is also
obtained.

##### 5.3.4.2.1.3a.3 Fine gain prediction, quantization and application {#a.3-fine-gain-prediction-quantization-and-application .H6}

The fine gain adjustment is based on a predicted value,
![](media/image1704.wmf){width="0.5395833333333333in"
height="0.23333333333333334in"}. It is formed using an accuracy measure
![](media/image1705.wmf){width="0.2916666666666667in"
height="0.20833333333333334in"} which combines the band bitrate
![](media/image1706.wmf){width="0.30277777777777776in"
height="0.20972222222222223in"}, band size
![](media/image1707.wmf){width="0.43472222222222223in"
height="0.20972222222222223in"}and the largest absolute integer pulse
value![](media/image1708.wmf){width="1.163888888888889in"
height="0.30277777777777776in"}of the synthesized
band![](media/image1709.wmf){width="0.30277777777777776in"
height="0.20972222222222223in"}.

> ![](media/image1710.wmf){width="1.9736111111111112in"
> height="0.23333333333333334in"} (1197)

where ![](media/image1711.wmf){width="0.6527777777777778in"
height="0.2361111111111111in"}is the actual number of pulses used for
encoding ![](media/image1712.wmf){width="0.3055555555555556in"
height="0.20833333333333334in"}and depends on the bitrate
![](media/image1713.wmf){width="0.3055555555555556in"
height="0.20833333333333334in"}and the PVQ encoding process.The accuracy
measure ![](media/image1714.wmf){width="0.2875in"
height="0.20972222222222223in"} is then translated into a gain
prediction ![](media/image1715.wmf){width="0.5395833333333333in"
height="0.23333333333333334in"} following this relation:

![](media/image1716.wmf){width="1.4333333333333333in"
height="0.23333333333333334in"} (1198)

where ![](media/image1717.wmf){width="0.5555555555555556in"
height="0.2361111111111111in"}approximates the optimal MMSE gain. In
case there are bits allocated, further refinement of the fine gain may
be done by encoding the gain prediction error
![](media/image1718.wmf){width="0.27847222222222223in"
height="0.20972222222222223in"}, defined as

![](media/image1719.wmf){width="1.5833333333333333in"
height="0.4618055555555556in"} (1199)

where the optimal MMSE gain
![](media/image1720.wmf){width="0.4673611111111111in"
height="0.23333333333333334in"}is defined as

![](media/image1721.wmf){width="2.5555555555555554in" height="0.7375in"}
(1200)

and the normalization factor
![](media/image1722.wmf){width="0.5305555555555556in"
height="0.20972222222222223in"}to RMS=1.0 is

![](media/image1723.wmf){width="2.4868055555555557in"
height="0.6083333333333333in"} (1201)

The gain prediction error
![](media/image1724.wmf){width="0.4618055555555556in"
height="0.20972222222222223in"}is encoded with a non-uniform scalar
quantizer in log domain using
![](media/image1725.wmf){width="0.4673611111111111in"
height="0.20972222222222223in"}bits.

##### 5.3.4.2.1.4 Noise level adjustment {#noise-level-adjustment .H6}

The spectral coefficients which belong to bands which are assigned zero
bits from the bit‑allocation procedure are not encoded. This means that
not all transform coefficients are transmitted to the decoder.

The level of these non-coded spectral coefficients is estimated and
quantized in the encoder. This is not done in WB at rates 24.4 kb/s and
32 kb/s.

The estimation of the non-quantized signal level is done directly in the
normalized spectrum domain. Prior to estimating the noise level, a
transition frequency between the noise fill region and high frequency
noise fill region is estimated. This transition frequency is identically
estimated in the encoder and decoder and marks the start of high
frequency noise fill and the end of noise fill.

The transition frequency is estimated according to the criterion of the
last quantized band. The general method consists in looping through all
the bands, starting at
![](media/image1726.wmf){width="0.6263888888888889in"
height="0.20972222222222223in"}down to 0. If there are no quantized
coefficients in the current band, it will be flagged as filled by high
frequency noise fill. If there are quantized coefficients in the band,
the holes of this band as well as the following bands are filled using
noise fill. Figure 80 illustrates such a procedure, where the transient
frequency separates between noise-fill and high frequency noise-fill.

![](media/image1727.png){width="4.39375in"
height="1.4868055555555555in"}

Figure 80: Estimation of transition frequency

![](media/image1728.wmf){width="3.654166666666667in" height="2.0875in"}

Figure 81: Noise level estimation done below the transition frequency

The noise level is in turn estimated by measuring the average level of
the normalized non-coded signal below the transition
frequency![](media/image1729.wmf){width="0.16458333333333333in"
height="0.20972222222222223in"}, see figure 81. Formally this is
obtained by:

![](media/image1730.wmf){width="3.5034722222222223in"
height="0.5395833333333333in"} (1202)

where ![](media/image1731.wmf){width="0.16458333333333333in"
height="0.15555555555555556in"}is the set of indices of coefficients
allocated zero bits below the transition frequency *f~t~*.

The above equation always returns a value which is below zero because of
the convexity of the logarithm. The noise level is quantized using a
two-bit scalar quantizer according to table 136.

Table 136: Codebook entries for the uniform noise level quantizer

  ------- ----------------------------------
  Index   Output quantized NoiseLevel (dB)
  0       0
  1       --6
  2       --12
  3       --18
  ------- ----------------------------------

##### 5.3.4.2.2 Transient Mode

##### 5.3.4.2.2.1 Envelope calculation and quantization {#envelope-calculation-and-quantization-1 .H6}

The bands are sorted according to equation (**1203**), where
![](media/image1732.wmf){width="0.48541666666666666in"
height="0.20972222222222223in"} is defined in tables **137**, **138**,
and **139**. Then the envelope calculation is done as in subclause
5.3.4.2.1.1 but using
![](media/image1733.wmf){width="0.5034722222222222in"
height="0.2513888888888889in"} instead of
![](media/image1734.wmf){width="0.4166666666666667in"
height="0.23333333333333334in"}. After the quantization then the sorting
is inverted by doing the inverse step of equation (**1203**).

> ![](media/image1735.wmf){width="1.2958333333333334in"
> height="0.2513888888888889in"} (1203)

Table 137: Envelope sorting table in transient mode for WB

  ---------------------------------------------------------------------------------------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
  ![](media/image1736.wmf){width="0.12291666666666666in" height="0.18263888888888888in"}   0    1    2    3    4    5    6    7    8    9    10
  ![](media/image1737.wmf){width="0.30277777777777776in" height="0.20972222222222223in"}   0    1    8    9    16   20   24   21   17   11   10
  ![](media/image1738.wmf){width="0.12291666666666666in" height="0.18263888888888888in"}   11   12   13   14   15   16   17   18   19   20   21
  ![](media/image1739.wmf){width="0.30277777777777776in" height="0.20972222222222223in"}   3    2    4    5    12   13   18   22   25   23   19
  ![](media/image1738.wmf){width="0.12291666666666666in" height="0.18263888888888888in"}   22   23   24   25                                 
  ![](media/image1739.wmf){width="0.30277777777777776in" height="0.20972222222222223in"}   15   14   7    6                                  
  ---------------------------------------------------------------------------------------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----

Table 138: Envelope sorting table in transient mode for SWB

  ---------------------------------------------------------------------------------------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
  ![](media/image1736.wmf){width="0.12291666666666666in" height="0.18263888888888888in"}   0    1    2    3    4    5    6    7    8    9    10
  ![](media/image1737.wmf){width="0.30277777777777776in" height="0.20972222222222223in"}   0    1    8    9    16   20   24   28   32   36   37
  ![](media/image1738.wmf){width="0.12291666666666666in" height="0.18263888888888888in"}   11   12   13   14   15   16   17   18   19   20   21
  ![](media/image1739.wmf){width="0.30277777777777776in" height="0.20972222222222223in"}   33   29   25   21   17   11   10   3    2    4    5
  ![](media/image1738.wmf){width="0.12291666666666666in" height="0.18263888888888888in"}   22   23   24   25   26   27   28   29   30   31   32
  ![](media/image1739.wmf){width="0.30277777777777776in" height="0.20972222222222223in"}   12   13   18   22   26   30   34   38   35   31   27
  ![](media/image1738.wmf){width="0.12291666666666666in" height="0.18263888888888888in"}   33   34   35   36   37   38                       
  ![](media/image1739.wmf){width="0.30277777777777776in" height="0.20972222222222223in"}   23   19   15   14   7    6                        
  ---------------------------------------------------------------------------------------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----

Table 139: Envelope sorting table in transient mode for FB

  ---------------------------------------------------------------------------------------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
  ![](media/image1736.wmf){width="0.12291666666666666in" height="0.18263888888888888in"}   0    1    2    3    4    5    6    7    8    9    10
  ![](media/image1737.wmf){width="0.30277777777777776in" height="0.20972222222222223in"}   0    1    8    9    16   20   24   28   32   36   40
  ![](media/image1738.wmf){width="0.12291666666666666in" height="0.18263888888888888in"}   11   12   13   14   15   16   17   18   19   20   21
  ![](media/image1739.wmf){width="0.30277777777777776in" height="0.20972222222222223in"}   41   37   33   29   25   21   17   11   10   3    2
  ![](media/image1738.wmf){width="0.12291666666666666in" height="0.18263888888888888in"}   22   23   24   25   26   27   28   29   30   31   32
  ![](media/image1739.wmf){width="0.30277777777777776in" height="0.20972222222222223in"}   4    5    12   13   18   22   26   30   34   38   42
  ![](media/image1738.wmf){width="0.12291666666666666in" height="0.18263888888888888in"}   33   34   35   36   37   38   39   40   41   42   43
  ![](media/image1739.wmf){width="0.30277777777777776in" height="0.20972222222222223in"}   43   39   35   31   27   23   19   15   14   7    6
  ---------------------------------------------------------------------------------------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----

##### 5.3.4.2.2.2 Bit allocation {#bit-allocation-4 .H6}

For most bit rates bit allocation is done as is described in subclause
5.3.4.2.1.2.1 and 5.3.4.2.1.2.2. For SWB at 24.4 and 32 kbps the Generic
mode bit allocation is used, as described in subclause 5.3.4.2.5.6.

##### 5.3.4.2.2.3 Fine structure quantization using PVQ {#fine-structure-quantization-using-pvq .H6}

The spectral coefficient quantization is done as is described in
subclause 5.3.4.2.1.4.

##### 5.3.4.2.3 Generic, Harmonic and HVQ mode detector

Non-transient signals are further classified as Generic mode, Harmonic
mode or HVQ at 24.4 kb/s and 32 kb/s for SWB inputs. The detailed
classification is described in subclause 5.3.4.1.1, with slight
differences in the final decision logic as follows.

At 24.4 kb/s the current frame mode is classified as harmonic if
![](media/image1740.wmf){width="0.9659722222222222in"
height="0.20972222222222223in"},
![](media/image1741.wmf){width="1.2506944444444446in"
height="0.23333333333333334in"} and
![](media/image1742.wmf){width="0.7229166666666667in"
height="0.23333333333333334in"}.

At 32 kb/s the current frame mode is classified as harmonic if
![](media/image1043.wmf){width="0.9659722222222222in"
height="0.20972222222222223in"},
![](media/image1044.wmf){width="1.3319444444444444in"
height="0.23333333333333334in"} and
![](media/image1045.wmf){width="0.7229166666666667in"
height="0.23333333333333334in"}; or if
![](media/image1046.wmf){width="0.9298611111111111in"
height="0.20972222222222223in"}.

##### 5.3.4.2.3.1 HVQ classifier {#hvq-classifier .H6}

Instantaneous noise-level![](media/image1743.wmf){width="0.44375in"
height="0.20972222222222223in"} and peak-level
![](media/image1744.wmf){width="0.4618055555555556in"
height="0.23333333333333334in"}are estimated from the absolute values of
transform
coefficients![](media/image1745.wmf){width="0.5034722222222222in"
height="0.23333333333333334in"}, where
![](media/image1746.wmf){width="0.48541666666666666in"
height="0.15555555555555556in"}at 24.4 kb/s and
![](media/image1747.wmf){width="0.48541666666666666in"
height="0.16458333333333333in"}at 32 kb/s. The noise-level is calculated
as:

![](media/image1748.wmf){width="2.9819444444444443in"
height="0.23333333333333334in"} (1204)

where

![](media/image1749.wmf){width="2.2527777777777778in"
height="0.4618055555555556in"} (1205)

The peak-level is calculated as

![](media/image1750.wmf){width="3.017361111111111in"
height="0.2513888888888889in"} (1206)

where

![](media/image1751.wmf){width="2.2618055555555556in"
height="0.4618055555555556in"} (1207)

and both ![](media/image1752.wmf){width="0.5034722222222222in"
height="0.20972222222222223in"}and
![](media/image1753.wmf){width="0.5125in"
height="0.23333333333333334in"}are initialized to 800.

The per-band averages of noise-level
![](media/image1754.wmf){width="0.43472222222222223in" height="0.225in"}
and peak-level ![](media/image1755.wmf){width="0.44375in"
height="0.2513888888888889in"} are calculated by averaging instantaneous
level in a band (every 32 bins). The number of bands is
![](media/image1756.wmf){width="0.375in"
height="0.16458333333333333in"}at 24.4 kb/s and
![](media/image1757.wmf){width="0.43472222222222223in"
height="0.16458333333333333in"}at 32 kb/s.

The average of the elements of the first half of
![](media/image1758.wmf){width="0.2513888888888889in"
height="0.225in"}gives the noise-floor
gain![](media/image1759.wmf){width="0.44375in"
height="0.20972222222222223in"}, while the second half of coefficients
forms![](media/image1760.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"}. In a similar way the per-band
peak-levels ![](media/image1761.wmf){width="0.2604166666666667in"
height="0.2513888888888889in"} produce two peak energy gains
![](media/image1762.wmf){width="0.44375in"
height="0.23333333333333334in"}and![](media/image1763.wmf){width="0.43472222222222223in"
height="0.23333333333333334in"}.

The decision to switch to HVQ mode is based on the threshold in table
**140**, and three variables,
![](media/image1764.wmf){width="0.43472222222222223in"
height="0.23333333333333334in"},
![](media/image1765.wmf){width="0.43472222222222223in"
height="0.23333333333333334in"}, and
![](media/image1766.wmf){width="0.4166666666666667in"
height="0.23333333333333334in"}, defined below.

The threshold for selecting peak candidates is calculated as:

![](media/image1767.wmf){width="1.6111111111111112in"
height="0.5395833333333333in"} (1208)

Absolute values of transform
coefficients![](media/image1768.wmf){width="0.3298611111111111in"
height="0.23333333333333334in"} are compared to the
threshold![](media/image1769.wmf){width="0.32083333333333336in"
height="0.19166666666666668in"}, and the ones with amplitude above it,
form a vector of peak candidates. Elements from the peaks candidate
vector are extracted in decreasing order, and when a peak is extracted
the threshold over the neighboring peaks is adjusted with {0.7071068,
0.5000000, 0.2500000, 0.5000000, 0.7071068}. This procedure produces a
set of spectral peaks, with
number![](media/image1770.wmf){width="0.43472222222222223in"
height="0.23333333333333334in"}.

A measure of frequency sharpness per-band
![](media/image1771.wmf){width="0.6777777777777778in"
height="0.20972222222222223in"}, similar to the one in 5.3.4.1.1, is
defined as peak to noise-floor ratio in each band:

![](media/image1772.wmf){width="1.3319444444444444in"
height="0.4166666666666667in"} (1209)

Variable ![](media/image1773.wmf){width="0.43472222222222223in"
height="0.23333333333333334in"}is calculated as the number of bands for
each ![](media/image1774.wmf){width="0.8784722222222222in"
height="0.20972222222222223in"}

Variable ![](media/image1775.wmf){width="0.4166666666666667in"
height="0.23333333333333334in"}is calculated as

![](media/image1776.wmf){width="1.6527777777777777in"
height="0.39861111111111114in"} (1210)

Table 140: Thresholds for HVQ mode decision

  ----------- ---------------------------------------------------------------------------------------- ---------------------------------------------------------------------------------------- ----------------------------------------------------------------------------------------
  rate        ![](media/image1777.wmf){width="0.18263888888888888in" height="0.20972222222222223in"}   ![](media/image1778.wmf){width="0.19166666666666668in" height="0.23333333333333334in"}   ![](media/image1779.wmf){width="0.19166666666666668in" height="0.20972222222222223in"}
  24.4 kb/s   4                                                                                        20                                                                                       22
  32 kb/s     7                                                                                        23                                                                                       22
  ----------- ---------------------------------------------------------------------------------------- ---------------------------------------------------------------------------------------- ----------------------------------------------------------------------------------------

The current frame is encoded in HVQ mode
if:![](media/image1780.wmf){width="0.6958333333333333in"
height="0.23333333333333334in"},
![](media/image1781.wmf){width="0.7229166666666667in"
height="0.23333333333333334in"}, and
![](media/image1782.wmf){width="0.7048611111111112in"
height="0.23333333333333334in"}

##### 5.3.4.2.4 Harmonic Mode

The harmonic mode is used to code the harmonic-like signal. For harmonic
signals, usually less noise filling is performed. It is also important
to mitigate any discontinuity in the higher sub-band due to changes in
core coding and for the most part it is preferable at 24.4 kb/s and
32kb/s, when there are insufficient bits to encode the full signal, to
stop short of coding right up to the Nyquist frequency.

##### 5.3.4.2.4.1 Envelope calculation and quantization {#envelope-calculation-and-quantization-2 .H6}

Envelope calculation and quantization is performed as described in
subclause 5.3.4.2.1.1.

In order to reconstruct harmonic characteristics of the higher frequency
band signal, the widths of the bands are larger than the ones for
non-harmonic mode.

##### 5.3.4.2.4.2 Bit allocation {#bit-allocation-5 .H6}

The band-energy limitation factor
![](media/image1783.wmf){width="0.5486111111111112in"
height="0.20972222222222223in"} is introduced before bit allocation to
mitigate discontinuous core coding in the higher sub-band.

Initialize the band-energy limitation
factor![](media/image1784.wmf){width="0.5486111111111112in"
height="0.20972222222222223in"}

![](media/image1785.wmf){width="1.8777777777777778in"
height="0.43472222222222223in"} (1211)

Calculate the energy of the first 10 sub-bands
![](media/image1786.wmf){width="0.3388888888888889in"
height="0.23333333333333334in"} and the energy of the first 28 sub-bands
![](media/image1787.wmf){width="0.3388888888888889in"
height="0.23333333333333334in"}, and add the norms
![](media/image1788.wmf){width="1.0527777777777778in"
height="0.2604166666666667in"} to
![](media/image1789.wmf){width="0.3388888888888889in"
height="0.23333333333333334in"}when
![](media/image1790.wmf){width="1.4027777777777777in"
height="0.2361111111111111in"}. When
![](media/image1791.wmf){width="1.3888888888888888in"
height="0.2638888888888889in"},
![](media/image1792.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"} is the index of the highest encoded
sub-band.

Reorder the quantized norms with the index
range![](media/image1793.wmf){width="0.8097222222222222in"
height="0.20972222222222223in"} to obtain the reordered norms, and
adjust the quantized norms as follows:

![](media/image1794.wmf){width="4.041666666666667in"
height="0.3055555555555556in"} (1212)

Then, the bit allocation is performed based on the adjusted norms to the
sub-bands with the index
range![](media/image1793.wmf){width="0.8097222222222222in"
height="0.20972222222222223in"} as described in subclause 5.3.4.2.1.2.2.

##### 5.3.4.2.4.3 PVQ {#pvq .H6}

The spectral coefficient quantization and coding is done according to
the number of bits allocated to each sub-band as is described in
subclause 5.3.4.2.1.3.

##### 5.3.4.2.5 HVQ

The HVQ mode is used only for SWB signals at 24.4 kb/s and 32 kb/s. At
24.4 kb/s it initially codes the first 224 MDCT coefficients (this
corresponds to frequency range up to 5.6 kHz), while at 32 kb/s it
initially codes the first 320 coefficients (this corresponds to
frequency range up to 8 kHz). The major algorithmic steps at the encoder
are: detect and code spectral peaks regions, code low-frequency spectral
coefficients (the size of coded region depends on the remaining bits
after peaks coding), code noise-floor gains for spectral coefficients
outside the peaks regions, code high-frequency spectrum envelope to be
used with the high-frequency noise-fill.

The input to the HVQ mode is the set of MDCT
coefficients![](media/image1795.wmf){width="0.4673611111111111in"
height="0.20972222222222223in"}, the noise-floor
gains![](media/image1796.wmf){width="0.2604166666666667in"
height="0.20972222222222223in"}, and the spectral peaks (both
noise-floor gains and spectral peaks are calculated in the
classification module, described in subclause 5.3.4.2.3.1). Each peak is
normalized to unit energy and the surrounding 4 neighbours are
normalized to with the peak gain. The peaks position, gain and sign are
quantized. A VQ is applied to the four MDCT bins surrounding each peak.
The coded number of peaks, peaks position, gain and sign, as well as the
surrounding shape vectors are quantized and quantization indices
transmitted to the decoder.

First sorted by energy peaks are arranged by position. Then peaks
amplitudes ![](media/image1797.wmf){width="0.4166666666666667in"
height="0.23333333333333334in"} are differentially coded by 5 bits SQ on
a log domain, and the indices Huffman coded to form a quantized peak
gains![](media/image1798.wmf){width="0.4166666666666667in"
height="0.27847222222222223in"}. Prior to quantization the peak gains
are multiplied by 0.25 and after the quantization multiplied by 4.

The spectral peak positions
![](media/image1799.wmf){width="0.18263888888888888in"
height="0.20972222222222223in"} are coded by choosing between two
alternative lossless coding schemes, where the coding scheme that
requires the least number of bits is selected, and explicitly indicated
to the decoder.

The first lossless spectral peak position coding scheme is delta Huffman
coding, suitable for periodic or semi-periodic spectral peak position
distributions. The second lossless spectral peak position coding scheme
is or-ing, suitable for sparse spectral peak position distributions.

The first scheme consists of the following steps: deltas (differences)
![](media/image1800.wmf){width="0.20972222222222223in"
height="0.20972222222222223in"} between consecutive elements (positions)
![](media/image1799.wmf){width="0.18263888888888888in"
height="0.20972222222222223in"} are created. Then these deltas are
Huffman coded. Since the peaks are selected in a way that they cannot be
positioned closer than 3 positions apart,
![](media/image1801.wmf){width="0.9986111111111111in"
height="0.19166666666666668in"}is subtracted from the peak differences.

![](media/image1802.wmf){width="1.7729166666666667in"
height="0.20972222222222223in"} (1213)

This eliminates the need of keeping codewords in the Huffman table,
corresponding to unused deltas.

The second scheme consists of the following steps: the vector
representing the spectral peak positions (absence of peak is indicated
with 0) is divided into consecutive equal size (5 elements) bit groups,
and the bits in each group are OR-ed forming a group bit vector (second
layer), which is 5 time shorter. Each bit in this second layer indicates
presence or absence or peak in the 5-dim group from layer below. In this
way the only 5-dim groups from the first layer, which are not indicated
as all-zero by the second layer have to be transmitted. The second
(control) layer is always transmitted. The non-zero bit groups from the
first layer also are mapped to exploit the constraints the fact that
peaks cannot be closer than 3 positions (not all possible 5-dim vectors
are allowed).

The selected coding scheme is explicitly signaled to the decoder with
one bit: ![](media/image1803.wmf){width="0.39861111111111114in"
height="0.16458333333333333in"}indicates sparse coding scheme, while
![](media/image1804.wmf){width="0.43472222222222223in"
height="0.16458333333333333in"}indicates usage of delta coding scheme.
Here ![](media/image1805.wmf){width="0.34791666666666665in"
height="0.20972222222222223in"}is the largest distance between two
consecutive peaks, which is compared to the largest difference possible
to code with the pre-stored Huffman tables,
![](media/image1806.wmf){width="0.20972222222222223in"
height="0.20972222222222223in"} is the total number of bits consumed by
the delta coding scheme, and
![](media/image1807.wmf){width="0.19166666666666668in"
height="0.20972222222222223in"} is the total number of bits consumed by
the sparse coding scheme

![](media/image1808.wmf){width="1.8173611111111112in"
height="0.8159722222222222in"} (1214)

Sign of the spectral peaks is coded separately with 1 bit per-peak, with
0 indicating negative sign and 1 indicating positive sign.

The peak regions to be coded are 5-dim MDCT vectors; a bin corresponding
to the spectral peak and 2 MDCT bins on each side of the peak. The peak
amplitude ![](media/image1809.wmf){width="0.4166666666666667in"
height="0.27847222222222223in"} of the central bin is used to normalize
the entire peak region. In this way the central bin is scaled to unit
energy, while surrounding 4 bins are normalized relative to the central
one. The shape vector
![](media/image1810.wmf){width="0.32083333333333336in"
height="0.23333333333333334in"}of the peak region, centered at bin
![](media/image1811.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"} is defined as:

![](media/image1812.wmf){width="3.7465277777777777in"
height="0.27847222222222223in"} (1215)

Each shape vector is quantized with 9 bits; 8 bits for the VQ index and
1 bit for classification. The numbers of peak regions vary over frames;
this means different number bits will be required for coding the shape
vectors, which will result in variable number bits used in the PVQ
coding of low-frequency MDCT bands (except for the first low-frequency
band, which has reserved bits).

Variations in the number of peaks per-frame results in different number
of VQs, which leads to large variation in complexity. To keep the
complexity nearly constant, while achieving low quantization error, the
following approach is used: the search for each
![](media/image1810.wmf){width="0.32083333333333336in"
height="0.23333333333333334in"}is performed in a structured CB, with
dynamically selected offset and size of the search region. The starting
point for the search is determined by initial classification of the
input shape vector, while the length of the search region depends on the
number of received shape vectors.

The codewords in the CB used for quantization of the shape vectors are
order based on their distance to two pre-demined classes, with centroids
![](media/image1813.wmf){width="0.19166666666666668in"
height="0.20972222222222223in"}and![](media/image1814.wmf){width="0.18263888888888888in"
height="0.20972222222222223in"}. The CB is structured in a way that the
codewords closest to
![](media/image1813.wmf){width="0.19166666666666668in"
height="0.20972222222222223in"}and most distanced to
![](media/image1814.wmf){width="0.18263888888888888in"
height="0.20972222222222223in"}are in one side of the CB, while
codewords closest to
![](media/image1814.wmf){width="0.18263888888888888in"
height="0.20972222222222223in"} and most distanced to
![](media/image1813.wmf){width="0.19166666666666668in"
height="0.20972222222222223in"} are clustered in the other side of the
CB. The distance between the input vectors
![](media/image1810.wmf){width="0.32083333333333336in"
height="0.23333333333333334in"}to each of the classes determines the
starting point for the search. Since the codevectors in the codebook are
sorted according to a distortion measure reflecting the distance between
each codevectors and the centroids, the search procedure goes first over
set of vectors that is likely to contain the best match.

The search space is dynamically adjusted to the number of input vectors.
The maximum search space is used with 8 peaks or less at 24.4 kb/s, and
12 peaks or less at 32 kb/s. When larger numbers of peaks are to be
quantized in the current frame, the search space is reduced to limit the
peak complexity.

Table 141: Adaptive search space in HVQ at 24.4 kb/s

  --------------------------------------------------------------------------------------- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----------------------------------------------------------------------------------------- -----
  ![](media/image1815.wmf){width="0.9298611111111111in" height="0.19166666666666668in"}   17    16    15    14    13    12    11    10    9     8     ![](media/image1816.wmf){width="0.16458333333333333in" height="8.680555555555555e-2in"}   1
  ![](media/image1817.wmf){width="0.5125in" height="0.19166666666666668in"}               128   136   145   155   167   181   197   217   241   256   ![](media/image1818.wmf){width="0.16458333333333333in" height="8.680555555555555e-2in"}   256
  --------------------------------------------------------------------------------------- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----------------------------------------------------------------------------------------- -----

Table 142: Adaptive search space in HVQ at 32 kb/s

  --------------------------------------------------------------------------------------- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----------------------------------------------------------------------------------------- -----
  ![](media/image1815.wmf){width="0.9298611111111111in" height="0.19166666666666668in"}   23    22    21    20    19    18    17    16    15    14    13    12    ![](media/image1819.wmf){width="0.16458333333333333in" height="8.680555555555555e-2in"}   1
  ![](media/image1817.wmf){width="0.5125in" height="0.19166666666666668in"}               128   134   141   149   158   168   179   192   206   224   244   256   ![](media/image1818.wmf){width="0.16458333333333333in" height="8.680555555555555e-2in"}   256
  --------------------------------------------------------------------------------------- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----------------------------------------------------------------------------------------- -----

The target shape vector exhibits certain symmetries (the MDCT
coefficients on the both sides of the spectral peak have similar
statistics) that can be used to optimize centroids for the class
selection and the CB. A "flipped" version of the centroids used in the
initial classification, "flipped" version of the CB (not pre-stored, but
through modified search) can capture this symmetry in the shape vectors.

First the input shape vector is compared to 4 centroids (each centroid
representing a respective class of codevectors in a codebook), which
determines a starting point to the search. If
![](media/image1820.wmf){width="0.23333333333333334in"
height="0.2604166666666667in"}or
![](media/image1821.wmf){width="0.23333333333333334in"
height="0.2604166666666667in"}are selected, the same logic is used, but
the search is performed in a "flipped" CB.

Table 143: Centroids for the class selection in HVQ search

  ---------------------------------------------------------------------------------------- ------------ ------------ ------------ ------------
  Class                                                                                                                           
  ![](media/image1813.wmf){width="0.19166666666666668in" height="0.20972222222222223in"}   -0.2324457   -0.4390556   0.0651793    0.2109977
  ![](media/image1814.wmf){width="0.18263888888888888in" height="0.20972222222222223in"}   0.1471332    -0.1351437   0.4312476    -0.1384814
                                                                                                                                  
  ![](media/image1820.wmf){width="0.23333333333333334in" height="0.2604166666666667in"}    0.2109977    0.0651793    -0.4390556   -0.2324457
  ![](media/image1821.wmf){width="0.23333333333333334in" height="0.2604166666666667in"}    -0.1384814   0.4312476    -0.1351437   0.1471332
  ---------------------------------------------------------------------------------------- ------------ ------------ ------------ ------------

In case of close peaks with overlapping shape vectors, a weighted
minimum-mean-squared error is used in the VQ search. Zero weights are
assigned to the overlapping shape elements that belong to the peak with
lowest amplitude. In this way the CB entries are matched against the
meaningful coefficients only.

After the peak regions are extracted and quantized, all remaining bits
that are not reserved for signalling are used to quantize the low
frequency MDCT coefficients. This is done by grouping the remaining
un-quantized MDCT coefficients into 24-dimensional bands (not including
already coded peak regions). A bit budget for coding the first band
always exists, but the total number of coded bands depends on the bits
left after peak coding. The number of bands to be coded
![](media/image1822.wmf){width="0.4618055555555556in"
height="0.16458333333333333in"} with remaining bits is determined by
dividing the number of available bits
![](media/image1823.wmf){width="0.375in"
height="0.20972222222222223in"}by the maximum number allowed per-band,
which is set to ![](media/image1824.wmf){width="0.6263888888888889in"
height="0.20972222222222223in"}at 24.4 kb/s and
![](media/image1825.wmf){width="0.6263888888888889in"
height="0.20972222222222223in"}at 32 kb/s.

![](media/image1826.wmf){width="3.113888888888889in"
height="0.4618055555555556in"} (1216)

Then the selected bands are gain-shape quantized. Gains are SQ on log
domain with 5 bits, and shape are PVQ quantized as described in
subclause 5.3.4.2.7.

A coded band is introduced above 5.6 kHz for 24.4 kb/s and 8 kHz for 32
kb/s if energy in the high band is relatively high compared to the peak
coded region in the lower band, the band has high energy compared to the
neighbouring high-frequency bands, and there is sufficient number of
bits for encoding band of that size.

To encode the high-frequency band
![](media/image1827.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"}*with* band log
energy![](media/image1828.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"}*and bandwidth*
![](media/image1829.wmf){width="0.20972222222222223in"
height="0.20972222222222223in"} following conditions have to be
simultaneously met:

![](media/image1830.wmf){width="1.9027777777777777in"
height="0.6388888888888888in"} (1217)

where an estimate of the low band energy
![](media/image1831.wmf){width="0.3888888888888889in"
height="0.2361111111111111in"} *is obtained through* summation over all
peak amplitudes, coded at low-frequencies:

![](media/image1832.wmf){width="1.9166666666666667in"
height="0.5694444444444444in"} (1218)

and ![](media/image1833.wmf){width="1.1388888888888888in"
height="0.20833333333333334in"} denotes the number of bits required to
encode one pulse in a band of width
![](media/image1834.wmf){width="0.20833333333333334in"
height="0.20833333333333334in"}. The average band log energy at
high-frequencies is denoted by
![](media/image1835.wmf){width="0.4166666666666667in"
height="0.225in"}*and the amount available bits by*
![](media/image1836.wmf){width="0.375in"
height="0.20972222222222223in"}*.*

void (1219)

The two noise floor gains use in the low-frequency noise-fill
![](media/image1837.wmf){width="0.44375in"
height="0.20972222222222223in"}and
![](media/image1838.wmf){width="0.4166666666666667in"
height="0.20972222222222223in"}are scalar quantized with 5 bits on a log
domain. The high-frequency gains
![](media/image1839.wmf){width="0.38958333333333334in"
height="0.2513888888888889in"}and
![](media/image1840.wmf){width="0.3659722222222222in"
height="0.2513888888888889in"}are transmitted to the decoder for the
high-frequency noise-fill. First two variables: the noise-floor and
peak-energy gains ![](media/image1841.wmf){width="0.44375in"
height="0.20972222222222223in"} and
![](media/image1842.wmf){width="0.44375in"
height="0.23333333333333334in"} are calculated, in similar way as
described in subclause 5.3.4.2.3.1, but over high-frequency MDCT
coefficients (coefficients above 224 at 24.4 kb/s and above 320 at 32
kb/s). That is the summation is done over
![](media/image1843.wmf){width="0.8875in"
height="0.18263888888888888in"}for 24.4 kb/s and
![](media/image1844.wmf){width="0.8875in"
height="0.18263888888888888in"}for 32 kb/s. Then the two gains are
calculated as:

![](media/image1845.wmf){width="1.9555555555555555in"
height="0.5548611111111111in"} (1220)

These gains are quantized with 2 bit uniform SQ to form quantized
high-frequency gains ![](media/image1846.wmf){width="0.44375in"
height="0.2513888888888889in"}and
![](media/image1847.wmf){width="0.4166666666666667in"
height="0.2513888888888889in"}transmitted and used in the high-frequency
noise-fill.

##### 5.3.4.2.6 Generic Mode

The first stage in this mode is the selection of one of three types of
high frequency excitation class which is followed by the separate
encoding of the low and high frequency envelopes. The low frequency
envelope is quantized and coded in the same manner as the normal high
rate mode of the HQ coder. The high frequency envelope is first
quantised in the generic mode domain before being mapped onto the HQ
normal mode domain, re-quantized and then combined with the low
frequency envelope. An initial bit allocation is determined, and then
delta's are calculated and coded. The coded values are used to update
the combined envelope, before the final bit allocation is determined.

![](media/image1848.wmf){width="6.700694444444444in"
height="5.472222222222222in"}

Figure 82: Generic mode Encoder Block Diagram

##### 5.3.4.2.6.1 Band allocation for the Generic Mode {#band-allocation-for-the-generic-mode .H6}

The band allocation for the low frequency envelope at 24.4 and 32kbps is
the same as default mode band allocation defined in table 127. The band
allocation for the high frequency envelope at 24.4 and 32kbps is shown
in table 144.

Table 144: Band Allocation for the high frequency envelope

  ------------ --------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- ------------------------------------------------------------------------ --------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- ------------------------------------------------------------------------
  Band index   SWB, FB @ 24.4kbps                                                                      SWB, FB @ 32kbps                                                                                                                                                                                                                                                                                                                                 
               ![](media/image1849.wmf){width="0.6958333333333333in" height="0.23333333333333334in"}   ![](media/image1850.wmf){width="0.6354166666666666in" height="0.23333333333333334in"}   ![](media/image1851.wmf){width="0.6in" height="0.23333333333333334in"}   ![](media/image1852.wmf){width="0.6958333333333333in" height="0.23333333333333334in"}   ![](media/image1853.wmf){width="0.6354166666666666in" height="0.23333333333333334in"}   ![](media/image1854.wmf){width="0.6in" height="0.23333333333333334in"}
  0            320                                                                                     335                                                                                     16                                                                       384                                                                                     399                                                                                     16
  1            336                                                                                     359                                                                                     24                                                                       400                                                                                     423                                                                                     24
  2            360                                                                                     375                                                                                     16                                                                       424                                                                                     439                                                                                     16
  3            376                                                                                     399                                                                                     24                                                                       440                                                                                     463                                                                                     24
  4            400                                                                                     415                                                                                     16                                                                       464                                                                                     479                                                                                     16
  5            416                                                                                     439                                                                                     24                                                                       480                                                                                     503                                                                                     24
  6            440                                                                                     455                                                                                     16                                                                       504                                                                                     519                                                                                     16
  7            456                                                                                     479                                                                                     24                                                                       520                                                                                     543                                                                                     24
  8            480                                                                                     503                                                                                     24                                                                       544                                                                                     567                                                                                     24
  9            504                                                                                     527                                                                                     24                                                                       568                                                                                     591                                                                                     24
  10           528                                                                                     551                                                                                     24                                                                       592                                                                                     615                                                                                     24
  11           552                                                                                     575                                                                                     24                                                                       616                                                                                     639                                                                                     24
  12           576                                                                                     607                                                                                     32                                                                       640 (FB)                                                                                679 (FB)                                                                                40 (FB)
  13           608                                                                                     639                                                                                     32                                                                       680 (FB)                                                                                719 (FB)                                                                                40 (FB)
  14           640 (FB)                                                                                679 (FB)                                                                                40 (FB)                                                                  720 (FB)                                                                                799 (FB)                                                                                80 (FB)
  15           680 (FB)                                                                                719 (FB)                                                                                40 (FB)                                                                  \-                                                                                      \-                                                                                      \-
  16           720 (FB)                                                                                799 (FB)                                                                                80 (FB)                                                                  \-                                                                                      \-                                                                                      \-
  ------------ --------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- ------------------------------------------------------------------------ --------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- ------------------------------------------------------------------------

##### 5.3.4.2.6.2 High frequency Excitation Class {#high-frequency-excitation-class .H6}

There are three different high frequency excitation classes, one each
for speech, tonal music and non-tonal music. The
*HF\_Speech\_excitation\_class* is determined by the instantaneous
result of the speech/music classifier, i.e. by applying the output of
the first speech/music classifier without adding any hang-over in
subclause 5.1.13.6.3.

![](media/image1855.wmf){width="5.5375in" height="0.4618055555555556in"}
(1221)

If the output of the classifier indicates music then a tonality
measurement is calculated.

![](media/image1856.wmf){width="5.7659722222222225in"
height="1.2354166666666666in"} (1222)

where ![](media/image1857.wmf){width="0.5548611111111111in"
height="0.23333333333333334in"} is the number of bands for calculating
tonality, 10 at 24.4kbps and 8 at 32kbps.

This tonality value is then thresholded to further subdivide the
excitation into *HF\_excitation\_class0* for noisy signals or
*HF\_excitation\_class1* for tonal signals. The bit allocations are
shown in table 145.

Table 145: Bit Allocation for the HF Excitation Classes

  ----------------------------------- ------ -------------
  High Frequency Excitation Classes   Code   Num of bits
  HF\_excitation\_class0              00     2
  HF\_Speech\_excitation\_class       1      1
  HF\_excitation\_class1              01     2
  ----------------------------------- ------ -------------

##### 5.3.4.2.6.3 Low Frequency Envelope Quantization and Coding {#low-frequency-envelope-quantization-and-coding .H6}

The low frequency envelope is quantized and coded in the same manner as
described for the normal high rate mode of the HQ coder, subclause
5.3.4.2.1.1

For both SWB and FB the transmitted low frequency envelope is
approximately 8 kHz at 24.4 kbps and increases to approximately 9.6 kHz
at 32kbps. The number of bands transmitted by the low frequency envelope
quantization and coding
![](media/image1858.wmf){width="0.6777777777777778in"
height="0.2423611111111111in"}is defined as 27 at 24.4kbps and 30 at
32kbps.

##### 5.3.4.2.6.4 High Frequency Envelope Quantization {#high-frequency-envelope-quantization .H6}

The high frequency envelope is quantized in a similar manner as
described in subclause 5.2.6.2.1.5, but with different starting
frequencies. For SWB at 24.4kbps the frequency range is 8 to16 kHz with
14 dimensions, while at 32kbps the range is 9.6 to 16 kHz with 12
dimensions. For FB at 24.4kbps the frequency range is 8 to 20 kHz, while
at 32kbps the range is 9.6 to 20 kHz with 3 additional bands.

First the high frequency envelope is calculated, and then the energy
control tool is applied as described in subclause 5.2.6.2.1.5 at SWB
bands (14 bands at 24.4kbps, 12 bands at 32kbps) for both SWB and FB.
When performing energy control, the variable
![](media/image1859.wmf){width="0.6263888888888889in"
height="0.23333333333333334in"}from equation (715) in subclause
5.2.6.2.1.5, is set to 0.55. However, the copied spectrum used to
generate the simulated spectrum is generated by using the frequency
mapping as defined in the following table, rather than the mapping used
in subclause 5.2.6.2.1.5 and defined in table 60.

Table 146: Frequency mapping to generate base excitation spectrum

  -------------------- ----- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- ---------------------------------------------------------------------------------------
  BW, Bit-rate         *l*   ![](media/image1860.wmf){width="0.6354166666666666in" height="0.23333333333333334in"}   ![](media/image1861.wmf){width="0.7645833333333333in" height="0.23333333333333334in"}   ![](media/image1862.wmf){width="0.6354166666666666in" height="0.23333333333333334in"}   ![](media/image1863.wmf){width="0.7465277777777778in" height="0.23333333333333334in"}
  SWB, FB @ 24.4kbps   0     2                                                                                       239                                                                                     320                                                                                     447
                       1     2                                                                                       239                                                                                     448                                                                                     575
                       2     80                                                                                      143                                                                                     576                                                                                     639
  SWB, FB@ 32kbps      0     2                                                                                       239                                                                                     384                                                                                     511
                       1     2                                                                                       239                                                                                     512                                                                                     639
  -------------------- ----- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- --------------------------------------------------------------------------------------- ---------------------------------------------------------------------------------------

VQ is then applied as described in subclause 5.2.6.2.1.5. At 24.4kbps
the VQ is identical to that used at Non-TRANSIENT mode, but at the
32kbps, the VQ is modified as shown in figure 83:

![](media/image1864.wmf){width="5.50625in"
height="3.8604166666666666in"}

Figure 83: VQ for HQ generic mode at 32kbps

In the first stage, three candidate indices are chosen using the
weighted mean squared error minimization criterion. The 6 values in even
positions, as well as the last (11^th^) position are selected and
quantized using a 7 dimensional VQ with 5 bits.

![](media/image1865.wmf){width="3.225in" height="0.5395833333333333in"}
(1223)

The quantization error is calculated:

![](media/image1866.wmf){width="3.5819444444444444in"
height="0.5395833333333333in"} (1224)

where ![](media/image1867.wmf){width="0.4673611111111111in"
height="0.20972222222222223in"}is the de-quantized value.

Then the errors are split into
![](media/image1868.wmf){width="0.5034722222222222in"
height="0.20972222222222223in"} and
![](media/image1869.wmf){width="0.5034722222222222in"
height="0.20972222222222223in"}and quantized:

![](media/image1870.wmf){width="3.3986111111111112in" height="0.5125in"}
(1225)

The two quantized and de-quantized values
![](media/image1871.wmf){width="0.5034722222222222in"
height="0.20972222222222223in"} and
![](media/image1872.wmf){width="0.5034722222222222in"
height="0.20972222222222223in"} are then combined:

![](media/image1873.wmf){width="2.372916666666667in"
height="0.4618055555555556in"} (1226)

At odd positions (excluding position 11), an interpolation using
boundary values is applied for intra-frame prediction and the predicted
error is calculated and quantized:

![](media/image1874.wmf){width="5.025in" height="0.6506944444444445in"}
(1227)

![](media/image1875.wmf){width="0.5034722222222222in"
height="0.20972222222222223in"}is then split into
![](media/image1876.wmf){width="0.5395833333333333in"
height="0.20972222222222223in"}and
![](media/image1877.wmf){width="0.5548611111111111in"
height="0.20972222222222223in"} and each is then quantised to 5 bits
with a 3 dimensional VQ.

For FB, the energies for three additional bands are calculated. These
are then quantised using 5 bits, after subtracting the mean vector
(shown in table 147)

Table 147: Mean vector in FB

  --------- -------
  ***j***   FB
  0         13.75
  1         6.29
  2         3.70
  --------- -------

The final selected set of indices
![](media/image1878.wmf){width="2.390972222222222in"
height="0.23333333333333334in"} for SWB, or
![](media/image1879.wmf){width="2.84375in"
height="0.23333333333333334in"} for FB are then transmitted.

##### 5.3.4.2.6.5 High Frequency Envelope Refinement and Fine structure quantization {#high-frequency-envelope-refinement-and-fine-structure-quantization .H6}

After de-quantisation the value in each band of the de-quantized high
frequency envelope ![](media/image1880.wmf){width="0.4673611111111111in"
height="0.23333333333333334in"} is mapped to one of the HQ high rate
normal mode bands ![](media/image1881.wmf){width="0.43472222222222223in"
height="0.20972222222222223in"}in order to match the frequencies. The
following energy displacement factors are used:

![](media/image1882.wmf){width="4.511805555555555in"
height="0.20972222222222223in"}

The mapping for SWB at 24.4kbps is:

![](media/image1883.wmf){width="2.426388888888889in"
height="2.939583333333333in"} (1228)

The mapping for SWB at 32kbps is:

![](media/image1884.wmf){width="2.408333333333333in"
height="2.2256944444444446in"} (1229)

The mapping for FB is:

![](media/image1885.wmf){width="2.435416666666667in"
height="1.226388888888889in"} (1230)

The resulting mapped envelope is then re-quantized using the same method
as is used for the HQ high rate normal mode, as described in subclause
5.3.4.2.1.1.

The quantized high and low frequency envelopes are then combined, and an
initial fractional bit allocation is carried out. The initial bit
allocation for the SWB generic mode is described in 5.3.4.2.6.6.
However, in the first step, equation (1235) is replaced with the
following equation:

![](media/image1886.wmf){width="5.84375in" height="1.04375in"} (1231)

The initial bit allocation used for FB generic mode is the same as the
bit allocation used for the Normal mode as is described in 5.3.4.2.1.3.

The information obtained from the bit allocation indicates whether or
not the envelope refinement is required for the current frame. If there
are any high bands which have allocated bits, delta coding needs to be
done to refine the high frequency envelope. In other words, if there are
any important spectral components in the higher bands, the refinement is
performed to provide a finer spectral envelope. If there are no bits
allocated to the higher bands during the initial bit allocation, the
envelope refinement is not required and the initial bit allocation is
used. In this case the envelope requires no further modification so the
following steps are not required and the fine structure quantization is
applied to spectrum to quantize the coefficients as is described in
subclause 5.3.4.2.1.3.

The quantized and de-quantized norms are calculated with the scalar
quantizer as shown in subclause 5.3.4.2.1.1 by using the original
spectrum, which it is defined
to![](media/image1887.wmf){width="0.39861111111111114in"
height="0.2423611111111111in"}. The scalar quantized and de-quantized
norms are also calculated using the mapped norms with the vector
quantization, which is defined
to![](media/image1888.wmf){width="0.6444444444444445in"
height="0.26944444444444443in"}.

Deltas are calculated at every band with allocated bits:

![](media/image1889.wmf){width="3.8006944444444444in"
height="0.7465277777777778in"} (1232)

A possible bit ![](media/image1890.wmf){width="0.32083333333333336in"
height="0.20972222222222223in"}for representing
all![](media/image1891.wmf){width="0.66875in"
height="0.2423611111111111in"}spans 2,3,4 and 5 bits, and they are
encoded as ![](media/image1892.wmf){width="0.5305555555555556in"
height="0.20972222222222223in"} using 2 bits. So, the possible bit is
calculated with ![](media/image1893.wmf){width="0.66875in"
height="0.2423611111111111in"} and it then is adjusted to fit within the
maximum number of bits (5). Any
![](media/image1894.wmf){width="0.7645833333333333in"
height="0.2423611111111111in"} which exceeds the maximum value is
corrected to 31 or -32 depending on a sign of
![](media/image1894.wmf){width="0.7645833333333333in"
height="0.2423611111111111in"}.

![](media/image1895.wmf){width="3.8006944444444444in"
height="0.9986111111111111in"} (1233)

The corrected ![](media/image1896.wmf){width="0.6506944444444445in"
height="0.26944444444444443in"} is transmitted with
![](media/image1897.wmf){width="0.32083333333333336in"
height="0.20972222222222223in"}.

The value of ![](media/image1898.wmf){width="0.6506944444444445in"
height="0.26944444444444443in"}is then used to compute a final update to
the envelope.

![](media/image1899.wmf){width="4.094444444444444in"
height="0.26944444444444443in"} (1234)

where ![](media/image1900.wmf){width="0.6083333333333333in"
height="0.26944444444444443in"}is the updated norm.

The fine structure quantization is then applied to the resulting
spectrum to quantize the coefficients as is described in subclause
5.3.4.2.1.3.

Finally the initial bit allocation information is updated, based on the
number of bits used for representing the deltas. This is done by
reducing the bits allocated to some sub bands, to provide enough bits to
code the deltas. If during the initial bit allocation a sub band was
allocated more than 3 bits, its allocation is reduced by one bit until
all the bits required for the deltas have been accounted for. This is
shown in more detail in the pseudo code below.

while (Bits\_needed\_for\_deltas \> 0)

{

Current\_band = number\_of\_bands-1

while(bits\_needed\_for\_deltas \>0 and Current\_band \>= 0)

{

if (Bits\_allocated\_to\_current\_band \> 3)

{

Bits\_allocated\_to\_current\_band \--

Bits\_needed\_for\_deltas \--

}

Current\_band \--

}

}

This procedure provides the final bit allocation.

##### 5.3.4.2.6.6 Bit Allocation {#bit-allocation-6 .H6}

In the Generic mode, a fractional bit allocation is used for the
spectral quantizer bit allocation. This permits the allocation of bits
with three bits fractional parts. Initially bits for each band are
estimated by:

![](media/image1901.wmf){width="5.6097222222222225in"
height="0.9833333333333333in"} (1235)

where ![](media/image1902.wmf){width="0.20972222222222223in"
height="0.15555555555555556in"}is a total bit budget.

The fully allocated bits are calculated as a starting point and the
first-stage iterations are done to re-distribute the allocated bits to
the bands with non-zero bits until the number of fully allocated bits is
equal to the total bit budget.

![](media/image1903.wmf){width="3.6777777777777776in"
height="1.0673611111111112in"} (1236)

where ![](media/image1904.wmf){width="0.7048611111111112in"
height="0.20972222222222223in"}is the number of spectral lines in all
bands with allocated bits after *k* iterations.

If too few bits are allocated, this can cause a quality degradation due
to the reduced SNR. To avoid this problem a minimum bit limitation is
applied to the allocated bits. The first minimums for the bits consist
of constant values depending on the band index and bit-rate.

![](media/image1905.wmf){width="2.765972222222222in"
height="0.6506944444444445in"} (1237)

In the second-stage iterations, the re-distribution of bits is done
again to allocate bits to the bands with more than
![](media/image1906.wmf){width="0.44375in"
height="0.20972222222222223in"} bits. The value
![](media/image1907.wmf){width="0.44375in"
height="0.20972222222222223in"} bits indicates the number of bits that
corresponds to 1 bit/sample in band
![](media/image1908.wmf){width="0.1375in"
height="0.16458333333333333in"} and is the second minimum required bits
for each band. Initially, the allocated bits are calculated based on the
result of the first-stage iteration and the first and second mininum
required bits for each band.

![](media/image1909.wmf){width="3.06875in"
height="0.6506944444444445in"} (1238)

where ![](media/image1910.wmf){width="0.3298611111111111in"
height="0.20972222222222223in"}is the allocated bits after the
first-stage iterations
and![](media/image1911.wmf){width="0.18263888888888888in"
height="0.16458333333333333in"}is 2 at 24.4kbps and 3 at 32kbps.

The ![](media/image1912.wmf){width="0.20972222222222223in"
height="0.15555555555555556in"} is updated by subtracting the number of
bits in bands with ![](media/image1906.wmf){width="0.44375in"
height="0.20972222222222223in"} bits , and the band index
![](media/image1913.wmf){width="0.1375in"
height="0.16458333333333333in"} is updated to
![](media/image1914.wmf){width="0.18263888888888888in"
height="0.20972222222222223in"} which indicates the band indices with
higher bits than ![](media/image1906.wmf){width="0.44375in"
height="0.20972222222222223in"} bits.
![](media/image1915.wmf){width="0.43472222222222223in"
height="0.20972222222222223in"}is updated to
![](media/image1916.wmf){width="0.43472222222222223in"
height="0.20972222222222223in"} which is the number of bands for
![](media/image1914.wmf){width="0.18263888888888888in"
height="0.20972222222222223in"}. The second-stage iterations are then
done until the updated
![](media/image1917.wmf){width="0.20972222222222223in"
height="0.15555555555555556in"}(![](media/image1918.wmf){width="0.23333333333333334in"
height="0.16458333333333333in"}) is equal to the number of bits in bands
with more than ![](media/image1919.wmf){width="0.4673611111111111in"
height="0.20972222222222223in"} bits.

![](media/image1920.wmf){width="4.1819444444444445in"
height="1.0673611111111112in"} (1239)

where ![](media/image1921.wmf){width="0.6958333333333333in"
height="0.20972222222222223in"}is the number of spectral lines in all
bands with more than
![](media/image1922.wmf){width="0.4673611111111111in"
height="0.20972222222222223in"} bits after *k* iterations.

During the second-stage iterations, if there are no bands with more than
![](media/image1922.wmf){width="0.4673611111111111in"
height="0.20972222222222223in"} bits, the bits in bands with non-zero
allocated bits from the highest bands are set to zero until
![](media/image1918.wmf){width="0.23333333333333334in"
height="0.16458333333333333in"} is equal to zero. Then the iterations
are terminated.

Then, a final re-distribution of over-allocated and under-allocated bits
is performed and finally, the fractional parts of bit allocation are
adjusted to have three bits.

![](media/image1923.wmf){width="3.2333333333333334in"
height="0.20972222222222223in"} (1240)

##### 5.3.4.2.7 Pyramid Vector Quantization (PVQ) and indexing

The PVQ is a lattice quantizer, with complexity growing linearly with
the vector dimension. The PVQ quantizes a
![](media/image1924.wmf){width="0.16458333333333333in"
height="0.16458333333333333in"}dimensional vector by allocating
![](media/image1925.wmf){width="0.16458333333333333in"
height="0.15555555555555556in"}signed pulses to match the shape of that
vector. In this way the PVQ codebook is defined as a combination of
![](media/image1925.wmf){width="0.16458333333333333in"
height="0.15555555555555556in"}signed pulses in
a![](media/image1926.wmf){width="0.16458333333333333in"
height="0.16458333333333333in"}dimensional space (with pulses at the
same position having the same sign). The maximum size of PVQ codebooks
is set to 32 bits, and if allocated bits are more than 32, the vector is
split into sub-vectors, bits re-distributed, and a gain parameter is
quantized to represent relative energy between these sub-vectors.
Largest allowed target vector is of dimension 64.

##### 5.3.4.2.7.2 PVQ split methodology {#pvq-split-methodology .H6}

When the bits ![](media/image1693.wmf){width="0.3055555555555556in"
height="0.19375in"}assigned for the band
![](media/image1927.wmf){width="0.125in"
height="0.18055555555555555in"}are above a pre-determined threshold, as
described in subclause 5.3.4.2.7.2.1, an algorithm for band splitting is
activated. First the input vector is split into uniform (or close to
uniform) segments in a non-recursive way. Then
angles![](media/image1928.wmf){width="0.15555555555555556in"
height="0.1375in"}, which represent the ratio between energies
![](media/image1929.wmf){width="0.20833333333333334in"
height="0.20833333333333334in"}and![](media/image1930.wmf){width="0.2222222222222222in"
height="0.20833333333333334in"}of a left and a right level segment, are
calculated recursively. At each iteration, the level segments consist of
one or several of the pre-determined segments from the initial split of
the input vector. The angles are calculated from the top level (full
size of the band to be quantized), and continuing towards the levels of
shorter sub-vectors, i.e. shorter level segments.

The angle is determined from the energy ratio between one left and one
right level segment. In case of an even number of splits, the left and
right level segments will consist of an equal number of segments. In
case of odd number of splits, the angle calculated during the first
iteration of the recursion will be with the right segment having a
larger number of segments than the left level segment, and the recursion
will require more steps for the right level segment.

For example if the bit budget
![](media/image1693.wmf){width="0.30277777777777776in"
height="0.19166666666666668in"} for the band size
![](media/image1707.wmf){width="0.43472222222222223in"
height="0.20972222222222223in"}require split in 3 segments (here
assuming that a split into equal sized segments is possible), the angle
calculation and the bit distribution is done in the following way:

Step 0: the angle and the shape bits
are![](media/image1931.wmf){width="0.625in" height="0.25in"}, the left
level segment is of
length![](media/image1932.wmf){width="0.5305555555555556in"
height="0.3659722222222222in"}, while the right level segment is of
length![](media/image1933.wmf){width="0.5395833333333333in"
height="0.3659722222222222in"}, and bits for the two level segments are
![](media/image1934.wmf){width="0.20833333333333334in"
height="0.25in"}and![](media/image1935.wmf){width="0.2222222222222222in"
height="0.25in"}.

Step 1: the right level segment from the previous step is split in a
left and a right level segment, both with the
length![](media/image1932.wmf){width="0.5305555555555556in"
height="0.3659722222222222in"}, the angle and the shape bits to be
distributed are ![](media/image1936.wmf){width="0.6111111111111112in"
height="0.25in"}, the two level segments (here equal to the second and
third segment of the initial split of the input vector) are allocated
the bits ![](media/image1937.wmf){width="0.2777777777777778in"
height="0.25in"}
and![](media/image1938.wmf){width="0.2916666666666667in"
height="0.25in"}.

The angles are used to distribute bits recursively to the already
determined segments. At each iteration, the number of bits
![](media/image1939.wmf){width="0.20833333333333334in"
height="0.20833333333333334in"} and
![](media/image1940.wmf){width="0.2222222222222222in"
height="0.20833333333333334in"} for a left and a right level segment are
derived from the available number of bits for shape coding of these
segments ![](media/image1941.wmf){width="0.1527777777777778in"
height="0.1527777777777778in"}, lengths of the level segments
![](media/image1942.wmf){width="0.19166666666666668in"
height="0.20972222222222223in"}and
![](media/image1943.wmf){width="0.20972222222222223in"
height="0.20972222222222223in"}, and the angle
![](media/image1928.wmf){width="0.15555555555555556in"
height="0.1375in"}:

![](media/image1944.wmf){width="5.096527777777778in"
height="0.4722222222222222in"} (1241)

![](media/image1945.wmf){width="0.7465277777777778in"
height="0.20972222222222223in"} (1242)

where ![](media/image1946.wmf){width="0.19375in"
height="0.20833333333333334in"} and
![](media/image1947.wmf){width="0.20833333333333334in"
height="0.20833333333333334in"} are compensation factors for differences
in segment lengths within the level segments, defined as

![](media/image1948.wmf){width="3.0416666666666665in"
height="0.5694444444444444in"},![](media/image1949.wmf){width="0.7916666666666666in"
height="0.4305555555555556in"} (1242a)

![](media/image1950.wmf){width="3.0694444444444446in"
height="0.5694444444444444in"},
![](media/image1951.wmf){width="0.8055555555555556in"
height="0.4305555555555556in"} (1242b)

where the function ![](media/image1952.wmf){width="0.3194444444444444in"
height="0.20833333333333334in"} gives the number of unit pulses that
giving the segment lengths
![](media/image1953.wmf){width="0.20833333333333334in"
height="0.2638888888888889in"} and
![](media/image1954.wmf){width="0.20833333333333334in"
height="0.2638888888888889in"} of the segments
![](media/image1955.wmf){width="0.125in" height="0.19375in"} within the
left and the right level segment respectively, can be represented using
![](media/image1956.wmf){width="0.4027777777777778in"
height="0.2361111111111111in"} bits.
![](media/image1957.wmf){width="0.2361111111111111in"
height="0.2361111111111111in"} is the total number of pre-determined
segments/splits within the left and right level segments. The function
![](media/image1958.wmf){width="0.3333333333333333in"
height="0.20833333333333334in"} gives the number of bits used to
represent the by the function
![](media/image1952.wmf){width="0.3194444444444444in"
height="0.20833333333333334in"} determined number of unit pulses for the
minimum dimension among the pre-determined segments.

The angle, which captures the relation between the energies of the left
and right segment at certain split level, is defined as:

![](media/image1959.wmf){width="0.9027777777777778in"
height="0.4722222222222222in"} (1243)

These angles are calculated recursively, starting with the top level,
and continuing towards the levels of shorter sub-vectors. The angles are
quantized by a range coder with asymmetric triangular PDF.

##### 5.3.4.2.7.2.1 Band splitting analysis {#band-splitting-analysis .H6}

The number of segments (parts) in the split PVQ vector
![](media/image1960.wmf){width="0.23333333333333334in"
height="0.23333333333333334in"}is determined in two steps. First, an
initial number of segments
![](media/image1961.wmf){width="0.48541666666666666in"
height="0.23333333333333334in"} is computed as

![](media/image1962.wmf){width="2.9305555555555554in"
height="0.2777777777777778in"} (1244)

where ![](media/image1963.wmf){width="1.1395833333333334in"
height="0.23333333333333334in"}is the maximum bitrate for each PVQ
vector segment. If ![](media/image1964.wmf){width="0.7645833333333333in"
height="0.23333333333333334in"} and the band bit rate is high, an
additional split is considered. Using
![](media/image1965.wmf){width="0.48541666666666666in"
height="0.23333333333333334in"}segments, the
![](media/image1966.wmf){width="0.2965277777777778in"
height="0.20972222222222223in"}energies of each PVQ target vector
segment is computed.

![](media/image1967.wmf){width="3.191666666666667in" height="0.6in"}
(1245)

If the maximum absolute deviation from the mean
![](media/image1968.wmf){width="0.2965277777777778in"
height="0.20972222222222223in"}energy
![](media/image1969.wmf){width="0.9298611111111111in"
height="0.23333333333333334in"},

![](media/image1970.wmf){width="3.626388888888889in" height="0.6in"}
(1246)

is larger than the difference between the maximum number of bits for
each segment ![](media/image1971.wmf){width="0.8333333333333334in"
height="0.23333333333333334in"}and the average bit rate for each
segment, an additional split will be added. That is,

![](media/image1972.wmf){width="4.373611111111111in"
height="0.4618055555555556in"} (1247)

Depending on if the conditions for the additional split are met, the
split increment flag
![](media/image1973.wmf){width="1.0944444444444446in"
height="0.19166666666666668in"} or
![](media/image1974.wmf){width="1.1215277777777777in"
height="0.19166666666666668in"}is signalled in the bitstream using 1
bit.

##### 5.3.4.2.7.3 PVQ sub-vector shape search and shape normalization {#pvq-sub-vector-shape-search-and-shape-normalization .H6}

##### 5.3.4.2.7.3.1 PVQ-search introduction {#pvq-search-introduction .H6}

The goal of the ![](media/image1975.wmf){width="0.7048611111111112in"
height="0.19166666666666668in"}search procedure is to find the vector
![](media/image1976.wmf){width="0.19166666666666668in"
height="0.23333333333333334in"}, which is defined as:

![](media/image1977.wmf){width="0.9986111111111111in"
height="0.4673611111111111in"} (1248)

where ![](media/image1978.wmf){width="0.5819444444444445in"
height="0.225in"}is a point on the surface of an -dimensional
hyper-pyramid and the L1 norm of
![](media/image1979.wmf){width="0.34791666666666665in"
height="0.225in"}is
![](media/image1925.wmf){width="0.16458333333333333in"
height="0.15555555555555556in"}. I.e.
![](media/image1980.wmf){width="0.34791666666666665in"
height="0.225in"}is the selected integer shape code vector of size
***N*** according to:

![](media/image1981.wmf){width="1.4006944444444445in"
height="0.5395833333333333in"} (1249)

i.e. ![](media/image1982.wmf){width="0.19166666666666668in"
height="0.23333333333333334in"} is the unit energy normalized integer
sub vector ![](media/image1983.wmf){width="0.34791666666666665in"
height="0.23333333333333334in"} scaled with a sub vector splitting gain
![](media/image1984.wmf){width="0.2965277777777778in"
height="0.20972222222222223in"}, (if the band is not split in sub
vectors the gain ![](media/image1984.wmf){width="0.2965277777777778in"
height="0.20972222222222223in"} is
![](media/image1985.wmf){width="9.583333333333334e-2in"
height="0.15555555555555556in"}*)*.

The best ![](media/image1986.wmf){width="0.18263888888888888in"
height="0.2513888888888889in"}vector is the one minimizing the mean
squared shape error between the target vector
![](media/image1987.wmf){width="0.12291666666666666in"
height="0.12291666666666666in"}and the scaled normalised quantized
output vector![](media/image1982.wmf){width="0.19166666666666668in"
height="0.23333333333333334in"}*.* The target vector
![](media/image1988.wmf){width="0.12291666666666666in"
height="0.12291666666666666in"} can be the time domain or in the
frequency domain. Finding the best
![](media/image1989.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"}is achieved by minimizing the following
search distortion:

![](media/image1990.wmf){width="1.7909722222222222in"
height="0.5548611111111111in"} (1250)

By squaring the numerator and denominator and eliminating the
predetermined constant gain scale
factor![](media/image1984.wmf){width="0.2965277777777778in"
height="0.20972222222222223in"}, we may maximize the
quotient![](media/image1991.wmf){width="0.375in"
height="0.23333333333333334in"}:

![](media/image1992.wmf){width="1.5833333333333333in"
height="0.5305555555555556in"} (1251)

The L1-norm structured PVQ-quantizer,
![](media/image1975.wmf){width="0.7048611111111112in"
height="0.19166666666666668in"}allows for several search optimisations,
where the primary optimization is to move the target to the all positive
"quadrant" in ![](media/image1993.wmf){width="0.16458333333333333in"
height="0.16458333333333333in"}-dimensional space and the second
optimization is to use an L1-norm projection as a starting approximation
for![](media/image1989.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"}. A third optimization is to iteratively
update the ![](media/image1991.wmf){width="0.375in"
height="0.23333333333333334in"} quotient, instead of re-computing
equation (1251) over the whole vector space
![](media/image1993.wmf){width="0.16458333333333333in"
height="0.16458333333333333in"}for every candidate change to the vector
![](media/image1994.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"} in pursuit of reaching the L1-norm
![](media/image1925.wmf){width="0.16458333333333333in"
height="0.15555555555555556in"}, which is required for the subsequent
PVQ-indexing step .

In the search of the optimal PVQ vector shape
![](media/image1989.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"}with L1-norm
![](media/image1925.wmf){width="0.16458333333333333in"
height="0.15555555555555556in"}, iterative updates of the
![](media/image1991.wmf){width="0.375in"
height="0.23333333333333334in"}variables are made in the all positive
"quadrant" in ![](media/image1995.wmf){width="0.16458333333333333in"
height="0.16458333333333333in"}-dimensional space according to:

![](media/image1996.wmf){width="2.051388888888889in"
height="0.23333333333333334in"} (1252)

![](media/image1997.wmf){width="2.9819444444444443in"
height="0.27847222222222223in"} (1253)

where ![](media/image1998.wmf){width="0.7465277777777778in"
height="0.23333333333333334in"}signifies the correlation achieved so far
by placing the previous
![](media/image1999.wmf){width="0.2965277777777778in"
height="0.16458333333333333in"}unit pulses, and
![](media/image2000.wmf){width="0.6777777777777778in"
height="0.23333333333333334in"} signifies the accumulated energy
achieved so far by placing the previous
![](media/image2001.wmf){width="0.2965277777777778in"
height="0.16458333333333333in"}unit pulses, and
![](media/image2002.wmf){width="0.6in" height="0.19166666666666668in"}
signifies the amplitude of
![](media/image2003.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"}at position
![](media/image2004.wmf){width="0.12291666666666666in"
height="0.1375in"} from the previous placement of
![](media/image2005.wmf){width="0.2965277777777778in"
height="0.16458333333333333in"}unit pulses. To further speed up the
in-loop iterative processing the energy term
![](media/image2000.wmf){width="0.6777777777777778in"
height="0.23333333333333334in"}is scaled down by 2, thus saving one
multiplication in the inner-loop.

![](media/image2006.wmf){width="2.775in" height="0.43472222222222223in"}
(1254)

![](media/image2007.wmf){width="1.6256944444444446in"
height="0.48541666666666666in"} (1255)

The best position ![](media/image2008.wmf){width="0.30277777777777776in"
height="0.20972222222222223in"}for the
![](media/image2009.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"}'th unit pulse, is iteratively updated by
iterating ![](media/image2010.wmf){width="0.12291666666666666in"
height="0.1375in"} over
![](media/image2011.wmf){width="0.34791666666666665in"
height="0.16458333333333333in"}.

![](media/image2012.wmf){width="2.5375in"
height="0.23333333333333334in"} (1256)

To avoid divisions the ![](media/image1991.wmf){width="0.375in"
height="0.23333333333333334in"} maximization update decision is
performed using a cross-multiplication of the saved best squared
correlation numerator
![](media/image2013.wmf){width="0.6777777777777778in"
height="0.19166666666666668in"} and the saved best energy denominator
![](media/image2014.wmf){width="0.43472222222222223in"
height="0.16458333333333333in"} so far.

![](media/image2015.wmf){width="4.676388888888889in"
height="0.7048611111111112in"} (1257)

The iterative maximization of
![](media/image2016.wmf){width="0.6777777777777778in"
height="0.23333333333333334in"}may start from a zero number of placed
unit pulses or from an adaptive lower cost pre-placement number of unit
pulses, based on an integer projection to a point below the
![](media/image2017.wmf){width="0.16458333333333333in"
height="0.15555555555555556in"}'th-pyramid's surface, with a guaranteed
undershoot of unit pulses in the target L1 norm
![](media/image2018.wmf){width="0.16458333333333333in"
height="0.15555555555555556in"}.

Due to the structured nature of the
![](media/image1980.wmf){width="0.34791666666666665in"
height="0.225in"}PVQ integer sub vector, where all possible sign
combinations are allowed and it is possible to encode all sign
combinations, as long as the resulting vector adheres to the L1 norm of
![](media/image1925.wmf){width="0.16458333333333333in"
height="0.15555555555555556in"} unit pulses, the search is performed in
the all positive first *"quadrant"*. Further to achieve as a high
accuracy as possible for a limited precision implementation the maximum
absolute value ![](media/image2019.wmf){width="0.5125in"
height="0.20972222222222223in"}of the input
signal![](media/image2020.wmf){width="0.12291666666666666in"
height="0.12291666666666666in"}is pre-analysed for future use in the
setup of the inner search loop precision.

![](media/image2021.wmf){width="2.0965277777777778in"
height="0.2604166666666667in"} (1258)

![](media/image2022.wmf){width="1.9736111111111112in"
height="0.20972222222222223in"} (1259)

In case the input vector is an all zero vector or the sub-vector gain is
very low, the PVQ-search is bypassed, and a valid PVQ-vector
![](media/image2023.wmf){width="0.34791666666666665in" height="0.225in"}
is deterministically created by assigning half of the
![](media/image2024.wmf){width="0.16458333333333333in"
height="0.15555555555555556in"}unit pulses to the first position
(![](media/image2025.wmf){width="0.6777777777777778in"
height="0.39861111111111114in"} ), and the remaining unit pulses to the
last position ( ![](media/image2026.wmf){width="1.7638888888888888in"
height="0.20972222222222223in"} ). (With this approach PVQ-search
complexity is reduced and the indexing complexity is spread between
encoder indexing and decoder de-indexing.)

##### 5.3.4.2.7.3.4 PVQ pre-search projection {#pvq-pre-search-projection .H6}

If the pulse density ratio
![](media/image2027.wmf){width="0.3659722222222222in"
height="0.16458333333333333in"}is larger than 0.5 unit pulses per
coefficient and ![](media/image2024.wmf){width="0.16458333333333333in"
height="0.15555555555555556in"}is larger than *1*, a projection to the
![](media/image2028.wmf){width="0.3298611111111111in"
height="0.15555555555555556in"}sub pyramid is made and used as a
starting point for ***y***, on the other hand if the pulse density is
less than 0.5 or ![](media/image2024.wmf){width="0.16458333333333333in"
height="0.15555555555555556in"}is *1*, the iterative PVQ-search will
start off from *zero* pre-placed unit pulses. The projection is
performed as:

![](media/image2029.wmf){width="1.3736111111111111in"
height="0.6958333333333333in"} (1260)

![](media/image2030.wmf){width="3.251388888888889in"
height="0.23333333333333334in"} (1261)

If no projection is made the starting point is an all zeroed
![](media/image2031.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"}vector. In preparation for the fine
search to reach
the![](media/image2024.wmf){width="0.16458333333333333in"
height="0.15555555555555556in"}'th-pyramid's surface the accumulated
number of unit
pulses![](media/image2032.wmf){width="0.48541666666666666in"
height="0.20972222222222223in"}, the accumulated correlation
![](media/image2033.wmf){width="0.9479166666666666in"
height="0.23333333333333334in"}and the accumulated energy
![](media/image2034.wmf){width="1.0527777777777778in"
height="0.23333333333333334in"} for the starting point
![](media/image2035.wmf){width="0.5819444444444445in"
height="0.20972222222222223in"} is computed as:

![](media/image2036.wmf){width="1.1909722222222223in" height="0.5125in"}
(1262)

![](media/image2037.wmf){width="2.120833333333333in" height="0.5125in"}
(1263)

![](media/image2038.wmf){width="2.4868055555555557in" height="0.5125in"}
(1264)

![](media/image2039.wmf){width="2.4in" height="0.23333333333333334in"}
(1265)

##### 5.3.4.2.7.3.5 PVQ fine search {#pvq-fine-search .H6}

The final integer shape vector
![](media/image2040.wmf){width="0.34791666666666665in" height="0.225in"}
must adhere to the L1 norm of
![](media/image2018.wmf){width="0.16458333333333333in"
height="0.15555555555555556in"}pulses. The fine search starts from a
lower point in the pyramid and iteratively finds its way to the surface
of the ***N***-dimensional
![](media/image2018.wmf){width="0.16458333333333333in"
height="0.15555555555555556in"}'th-hyperpyramid. The
![](media/image2018.wmf){width="0.16458333333333333in"
height="0.15555555555555556in"}-value in the fine search ranges from 1
pulse to 512 unit pulses, to keep the complexity of the search at a
reasonable level, the search is split into two main branches, one branch
is used when the in-loop energy representation of
![](media/image2041.wmf){width="0.18263888888888888in"
height="0.23333333333333334in"}will stay within a signed 16 bit word,
and another branch is used if the in-loop energy may or may not exceed
the dynamic range of a 16 bit word.

When the final ![](media/image2018.wmf){width="0.16458333333333333in"
height="0.15555555555555556in"}is lower than or equal to 127 unit
pulses, the dynamics of the 1 bit upshifted
![](media/image2042.wmf){width="0.7229166666666667in"
height="0.23333333333333334in"}will always stay within 15 bits, allowing
efficient use of a signed 16 bit word for representing every
![](media/image2043.wmf){width="0.6777777777777778in"
height="0.23333333333333334in"}within all the fine pulse search inner
loop iterations up to
![](media/image2044.wmf){width="0.38958333333333334in"
height="0.16458333333333333in"}.

In preparation for the next unit pulse addition, the near optimal
maximum possible upshift of the next loop's accumulated in-loop
correlation value in a signed 32 bit word is pre-analysed using the
previously calculated maximum absolute input value as:

![](media/image2045.wmf){width="3.263888888888889in"
height="0.2777777777777778in"} (1266)

To make the critical equation (1257) update as efficient as possible,
the ![](media/image2046.wmf){width="0.7465277777777778in"
height="0.27847222222222223in"}numerator is represented by a 16 bit
signed word, by the following approach:

![](media/image2047.wmf){width="4.259722222222222in"
height="0.43472222222222223in"} (1267)

![](media/image2048.wmf){width="5.042361111111111in"
height="0.6868055555555556in"} (1268)

where the function "Round~16~" extracts the top 16 bits of a signed 32
bit variable with rounding, this near optimal upshift and the use of 16
bit representation of the squared correlation ***bestCorrSq~16~***
enables a very fast inner-loop search for performing the equation (1268)
test and variable updates.

The location of the next unit pulse is now determined by iterating over
the ![](media/image2049.wmf){width="0.8423611111111111in"
height="0.18263888888888888in"}possible positions, while employing
equations (1267), (1253) and (1268).

When the best position
![](media/image2050.wmf){width="0.30277777777777776in"
height="0.20972222222222223in"} of the unit pulse has been determined ,
the accumulated correlation
![](media/image2051.wmf){width="0.5638888888888889in"
height="0.23333333333333334in"}the accumulated inloop energy
![](media/image2043.wmf){width="0.6777777777777778in"
height="0.23333333333333334in"}and the number of accumulated unit pulses
![](media/image2032.wmf){width="0.48541666666666666in"
height="0.20972222222222223in"}are updated. If there are further unit
pulses to add ![](media/image2052.wmf){width="0.8423611111111111in"
height="0.20972222222222223in"}, a new inner-loop is started with a new
near optimal ![](media/image2053.wmf){width="0.5819444444444445in"
height="0.23333333333333334in"} analysis (equation (1266)) for the next
unit pulse.

When the final ![](media/image2054.wmf){width="0.16458333333333333in"
height="0.15555555555555556in"} is higher than 127 unit pulses, the
dynamics of the 1 bit upshifted
![](media/image2055.wmf){width="0.7229166666666667in"
height="0.23333333333333334in"}may exceed 15 bits, the fine search will
adaptively choose between 16 bit representation and 32 bit
representation of the pair
![](media/image2056.wmf){width="1.6256944444444446in"
height="0.27847222222222223in"} . The fine search will keep track of the
maximum pulse amplitude ![](media/image2057.wmf){width="0.6in"
height="0.23333333333333334in"}in
![](media/image2058.wmf){width="0.18263888888888888in"
height="0.23333333333333334in"}achieved so far, this information is used
in a pre-analysis step before entering the optimized inner dimension
loop, to determine the precision to use for the inner unit pulse
addition loop. If the pre-analysis indicates that more than a signed 16
bit word is needed to represent the in-loop energy without losing any
energy information, a high precision unit pulse addition loop is
employed, where both the saved best squared correlation term and the
saved best accumulated energy term are represented by 32 bit words.

![](media/image2059.wmf){width="3.44375in"
height="0.2777777777777778in"} (1269)

![](media/image2060.wmf){width="2.765972222222222in"
height="0.43472222222222223in"} (1270)

If ![](media/image2061.wmf){width="1.0854166666666667in"
height="0.20972222222222223in"} is *FALSE* the lower precision inner
search loop in equations (1267), (1253) and (1268) is employed, on the
other hand if ![](media/image2062.wmf){width="1.0854166666666667in"
height="0.20972222222222223in"} is *TRUE*, the location of the next unit
pulse is determined by iterating over the
![](media/image2049.wmf){width="0.8423611111111111in"
height="0.18263888888888888in"}possible positions, using equations
(1271), (1253) and (1272).

![](media/image2063.wmf){width="3.5034722222222223in"
height="0.39861111111111114in"} (1271)

![](media/image2064.wmf){width="5.0784722222222225in"
height="0.6868055555555556in"} (1272)

When the best position
![](media/image2065.wmf){width="0.30277777777777776in"
height="0.20972222222222223in"} of the unit pulse has been determined,
the accumulated correlation
![](media/image2066.wmf){width="0.6958333333333333in"
height="0.23333333333333334in"}, the accumulated inloop energy
![](media/image2067.wmf){width="0.6777777777777778in"
height="0.23333333333333334in"}and the number of accumulated unit pulses
![](media/image2032.wmf){width="0.48541666666666666in"
height="0.20972222222222223in"}are updated. Further the maximum
amplitude ![](media/image2068.wmf){width="0.6in"
height="0.23333333333333334in"} in the best integer vector so far, is
kept up to date for the next unit pulse addition loop.

![](media/image2069.wmf){width="2.0875in"
height="0.23333333333333334in"} (1273)

If there are further unit pulses to add
![](media/image2070.wmf){width="0.8423611111111111in"
height="0.20972222222222223in"}, a new inner-loop is started with a new
near optimal ![](media/image2053.wmf){width="0.5819444444444445in"
height="0.23333333333333334in"} analysis equation (1266) and a new
energy precision analysis equations (1269) and (1270) and then
commencing the next unit pulse loop equations (1271), (1253) and
(1272)).

The effect of the in-loop accumulated energy based inner loop precision
selection is that target sub vectors that have a high peakiness, or have
very fine shape granularity (final
![](media/image2071.wmf){width="0.16458333333333333in"
height="0.15555555555555556in"}is high) will be using the higher
precision loop, while non-peaky or lower shape granularity sub vectors
will more often use the lower precision loop.

##### 5.3.4.2.7.3.6 PVQ sub-vector finalization and normalization {#pvq-sub-vector-finalization-and-normalization .H6}

After shape search each non-zero PVQ-sub-vector element is assigned its
proper sign and the vector is L2-normalized to unit energy. Additionally
if the band was split, it is further scaled with the previously
determined sub-vector
gain![](media/image1984.wmf){width="0.2965277777777778in"
height="0.20972222222222223in"}.

![](media/image2072.wmf){width="3.5034722222222223in"
height="0.20972222222222223in"} (1274)

![](media/image2073.wmf){width="1.0944444444444446in"
height="0.5305555555555556in"} (1275)

![](media/image2074.wmf){width="2.5375in"
height="0.23333333333333334in"} (1276)

##### 5.3.4.2.7.4 PVQ short codeword indexing {#pvq-short-codeword-indexing .H6}

The PVQ short codeword indexing assigns a unique index to any possible
vector in![](media/image2075.wmf){width="0.7048611111111112in"
height="0.19166666666666668in"}. The incoming
![](media/image2076.wmf){width="0.7048611111111112in"
height="0.19166666666666668in"}vector![](media/image2077.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"}, which represents a point on the *K*'th
hyper-pyramid in *N*-dimensional space is indexed into two short
codeword(s) using a leading sign sections Modular PVQ recursive indexing
method denoted![](media/image2078.wmf){width="0.8166666666666667in"
height="0.1909722222222222in"}. After the MPVQ indexing procedure, the
integer codewords and the size of each codeword are sent to a Range
encoder, an arithmetic encoder, which in turn provides a stream of
arithmetically encoded bits to the to the bit stream.

##### 5.3.4.2.7.4.1 MPVQ modular leading sign recursion definition {#mpvq-modular-leading-sign-recursion-definition .H6}

The first codeword represents a leading sign, which is the sign of the
first non-zero position
in![](media/image2079.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"}, the second codeword is a recursive
representation of the amplitudes (including zeroes) and leading signs of
the remaining vector
![](media/image2080.wmf){width="0.12291666666666666in"
height="0.12291666666666666in"} after the first occurring non-zero
position sign in ![](media/image2081.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"} has been extracted. The modular leading
sign extraction is performed recursively until all amplitudes (including
zeroes) and signs have been consumed.

The number of possible combinations
of![](media/image2081.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"}is
denoted![](media/image2082.wmf){width="0.7736111111111111in"
height="0.23333333333333334in"}. The number of possible combinations
of![](media/image2083.wmf){width="0.12291666666666666in"
height="0.12291666666666666in"},
an![](media/image2084.wmf){width="0.8159722222222222in"
height="0.19166666666666668in"}vector with
![](media/image2085.wmf){width="0.16458333333333333in"
height="0.15555555555555556in"} unit pulses in
dimension![](media/image2086.wmf){width="0.16458333333333333in"
height="0.16458333333333333in"}with an L1-norm of
![](media/image2087.wmf){width="0.16458333333333333in"
height="0.15555555555555556in"} and an initial positive sign is
denoted![](media/image2088.wmf){width="0.8784722222222222in"
height="0.23333333333333334in"}. The elimination of the initial leading
sign from ![](media/image2081.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"}yields the number of possible entries in
![](media/image2089.wmf){width="0.12291666666666666in"
height="0.12291666666666666in"}as:

![](media/image2090.wmf){width="1.7638888888888888in"
height="0.38958333333333334in"} (1277)

The MPVQ-index for vector
![](media/image2080.wmf){width="0.12291666666666666in"
height="0.12291666666666666in"} is based on the recursive
![](media/image2078.wmf){width="0.825in"
height="0.20069444444444445in"}scheme where we:

Define ![](media/image2091.wmf){width="0.44375in"
height="0.20069444444444445in"}as the number of integer vectors of
dimension ![](media/image2092.wmf){width="0.12291666666666666in"
height="0.1375in"}and L1-norm
of![](media/image2093.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"}, that does not have a leading zero, and
does not have the leading value *k***,** has a leading positive value,
and has a positive leading sign, (where the leading sign is the first
sign encountered after the current value in the direction of the
recursion.

Define ![](media/image2094.wmf){width="0.42569444444444443in"
height="0.20069444444444445in"}as the number of integer vectors of
dimension ![](media/image2095.wmf){width="0.12291666666666666in"
height="0.1375in"} and L1-norm of
![](media/image2096.wmf){width="0.12291666666666666in"
height="0.16458333333333333in"}, that has a positive leading value and
that does not have a leading zero.

See table 148 for a structured view of
![](media/image2097.wmf){width="0.39861111111111114in"
height="0.19166666666666668in"} and its relation to the total number of
vectors in the![](media/image2098.wmf){width="0.7375in"
height="0.19166666666666668in"} structure with
![](media/image2099.wmf){width="0.7916666666666666in"
height="0.23333333333333334in"}vectors.

**Table** **148**: MPVQ recursion overview: the three subsections for
the![](media/image2099.wmf){width="0.7916666666666666in"
height="0.23333333333333334in"}leading sign based recursion

+----------------------------------+----------------------------------+
| Subsection\                      | Number of entries for each       |
| ( initial                        | subsection                       |
| ![](media/image2100.w            |                                  |
| mf){width="0.2513888888888889in" |                                  |
| heig                             |                                  |
| ht="0.19166666666666668in"}value |                                  |
| for the subsection )             |                                  |
+----------------------------------+----------------------------------+
| ![](media/image2101.wm           | 1                                |
| f){width="0.12291666666666666in" |                                  |
| height="0.16458333333333333in"}  |                                  |
+----------------------------------+----------------------------------+
|                                  | All unit pulses consumed.\       |
|                                  | Remaining![](media/image2102.w   |
|                                  | mf){width="0.6958333333333333in" |
|                                  | heigh                            |
|                                  | t="0.19166666666666668in"}values |
|                                  | all zeroes, recursion may stop   |
+----------------------------------+----------------------------------+
| ![](media/image2103.w            | ![](media/image2104.w            |
| mf){width="0.5548611111111111in" | mf){width="0.6263888888888889in" |
| height="0.19166666666666668in"}  | height="0.19166666666666668in"}  |
|                                  |                                  |
| (non-zero with a positive or     |                                  |
| negative next leading sign)      |                                  |
+----------------------------------+----------------------------------+
|                                  | First encountered non-zero       |
|                                  | position requires 1 bit of next  |
|                                  | leading sign information,\       |
|                                  | stored as the LSB in this even   |
|                                  | sized                            |
|                                  | ![](media/image2105.w            |
|                                  | mf){width="0.6263888888888889in" |
|                                  | height="0.1                      |
|                                  | 9166666666666668in"}sub-section. |
|                                  |                                  |
|                                  | The recursion consumes the       |
|                                  | ![](media/image2106.w            |
|                                  | mf){width="0.2513888888888889in" |
|                                  | height="0.19166666666666668in"}  |
|                                  | amplitude value and moves on to  |
|                                  | ![](media/image2107.wm           |
|                                  | f){width="0.23333333333333334in" |
|                                  | height="0.19166666666666668in"}  |
+----------------------------------+----------------------------------+
| ![](media/image2108.wm           | ![](media/image2109.w            |
| f){width="0.12291666666666666in" | mf){width="0.9479166666666666in" |
| height="0.16458333333333333in"}  | height="0.23333333333333334in"}  |
+----------------------------------+----------------------------------+
|                                  | Recursion moves on to            |
|                                  | ![](media/image2110.wm           |
|                                  | f){width="0.23333333333333334in" |
|                                  | height="0.19166666666666668in"}  |
|                                  | without any additional next      |
|                                  | leading sign information         |
+----------------------------------+----------------------------------+

The recursive definition of the total number of entries in
![](media/image2080.wmf){width="0.12291666666666666in"
height="0.12291666666666666in"}becomes:

![](media/image2111.wmf){width="2.6694444444444443in"
height="0.23333333333333334in"} (1278)

By applying
Fischer's![](media/image2112.wmf){width="0.6263888888888889in"
height="0.19166666666666668in"}original recursion
for![](media/image2113.wmf){width="0.7916666666666666in"
height="0.23333333333333334in"}together with equation (1277) and (1278)
, we establish that:

![](media/image2114.wmf){width="2.189583333333333in"
height="0.23333333333333334in"} (1279)

, from the ![](media/image2115.wmf){width="0.44375in"
height="0.1909722222222222in"}definition (and table 148) one can find
that the relation between![](media/image2116.wmf){width="0.44375in"
height="0.19166666666666668in"}and![](media/image2117.wmf){width="0.44375in"
height="0.19166666666666668in"}is:

![](media/image2118.wmf){width="1.2958333333333334in"
height="0.19166666666666668in"} (1280)

where ( the "1" comes from the single initial-"*k*" valued vector, and
the factor "2" is due to positive and negative sign possibilities of the
coming next leading sign.

On the encoder side recursive relations are used for the forward update
of the MPVQ indexing offsets![](media/image2115.wmf){width="0.44375in"
height="0.1909722222222222in"} and
![](media/image2119.wmf){width="0.44375in"
height="0.19166666666666668in"}as the dimension increases up to the size
of the vector to be indexed:

![](media/image2120.wmf){width="2.9034722222222222in"
height="0.19166666666666668in"} (1281)

![](media/image2121.wmf){width="3.1666666666666665in"
height="0.43472222222222223in"} (1282)

where the low dynamic range calculation equation (1282) is used for the
last column ![](media/image2122.wmf){width="0.33055555555555555in"
height="0.15625in"} forward update of the MPVQ offset matrix, a column
which is needed for the calculation of the
exact![](media/image2078.wmf){width="0.8166666666666667in"
height="0.1909722222222222in"} size.
An![](media/image2115.wmf){width="0.44375in"
height="0.1909722222222222in"}based recursion is used for the offset
matrix columns![](media/image2123.wmf){width="0.33055555555555555in"
height="0.16527777777777777in"}, as these columns are known in advance
to have a low dynamic range. To keep the dynamic range within a signed
32 bit word, the
final![](media/image2078.wmf){width="0.8166666666666667in"
height="0.1909722222222222in"}size calculation is performed as:

![](media/image2124.wmf){width="2.563888888888889in"
height="0.43472222222222223in"} (1283)

##### 5.3.4.2.7.4.2 Detailed MPVQ indexing approach {#detailed-mpvq-indexing-approach .H6}

The maximum index range of the found PVQ-vector
![](media/image2125.wmf){width="0.12083333333333333in"
height="0.16527777777777777in"}'s is \[0.. 2^32^-1 \] and the total
resulting index would require an unsigned 32 bit word, however with the
introduction of the modular leading sign approach the maximum index
range is reduced to \[0.. 2^31^-1 \], which enables fast implementation
using signed 32 bit word arithmetic.

The MPVQ-indexing scheme on the encoder side is run in the order of
position ![](media/image2126.wmf){width="0.3472222222222222in"
height="0.16527777777777777in"} to position 0, (on the decoder side the
de-indexing will start from position 0 and end at
position![](media/image2127.wmf){width="0.3472222222222222in"
height="0.16527777777777777in"}). The MPVQ indexing loop is carried out
according to figure 84, where
![](media/image2128.wmf){width="0.12083333333333333in"
height="0.1388888888888889in"} is the row number of the MPVQ offset
matrix,![](media/image2129.wmf){width="0.2604166666666667in"
height="0.16527777777777777in"}is the pointer into the
samples/coefficients of the PVQ-vector , "\>\>1" denotes a 1 bit right
shift and further the function "UpdateOffsetsFwd" iteratively updates
the required MPVQ-offsets for the next larger dimension using
combinations of equations (1281), (1280) and (1282).

![](media/image2130.wmf){width="6.5in" height="7.432638888888889in"}

Figure 84: Detailed MPVQ-indexing, leading sign index extraction and
size calculation

To speed up the indexing when the number of unit pulses
![](media/image2131.wmf){width="0.16527777777777777in"
height="0.15625in"}is high (and the
dimension![](media/image2132.wmf){width="0.16527777777777777in"
height="0.16527777777777777in"} is low), direct functions are used to
calculate both the MPVQ-offsets and the MPVQ-size.

##### 5.3.4.2.7.5 High Dynamic Range Arithmetic Encoding {#high-dynamic-range-arithmetic-encoding .H6}

The Split PVQ scheme relies on a Range encoder to encode symbols with
higher granularity than bits. A high dynamic range implementation, where
of up to 24 bits resolution may be used for the CDF is used to encode
short codewords in three distinct ways:

-   Direct bit encoding

-   1/8 bit resolution uniform PDF encoding

-   Asymmetric triangular PDF encoding of band split energy angles,
    using tailor made CDFs.

Further special range encoder functions are used to determine the
remaining bit budget in the frame and band quantization loops, and used
to correct the bit budget for coming frames or coming bands.
